=== Verification script ===
#!/bin/sh
set -ex
# Manually deploy on Azure using Azure CLI client.
# Validate upgrade to proposed version of cloud-init
# Check Tracebacks or error conditions on clean boot

SRU_VARS=./sru-scripts/sru-vars.template

if [ ! -f $SRU_VARS ]; then
   echo "Missing config environment file $SRU_VARS."
   exit 1
fi

. $SRU_VARS

parse_args $0 $@
assert_expected_vars PROPOSED_SCRIPT AZURE_REGION AZURE_VNET_NAME \
  AZURE_NETWORK_SECURITY_GROUP AZURE_NIC_NAME AZURE_RESOURCE_GROUP \
  AZURE_BOOT_DIAG SSH_KEY SAMPLE_CLOUDCONFIG AZURE_ADVANCED_NIC_TESTS
create_samplecloudconfig
create_setup_proposed_script

AZURE_VNET_NAME=$AZURE_VNET_NAME-$UBUNTU_RELEASE


IPV6_NET_REGISTERED=$(az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network | jq -r '.properties.state')
IPV6_CA_LB_REGISTERED=$(az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network | jq -r '.properties.state')

if [ "$IPV6_NET_REGISTERED" != "Registered" -o "$IPV6_CA_LB_REGISTERED" != "Registered" ]; then
    echo "Account is not yet registered for AllowIPv6VirtualNetwork or AllowIPv6CAOnStandardLB. Can take 30 mins. Activate feature now (y/n)?"
    read RESP
    if [ "$RESP" = "y" ]; then
        az feature register --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
        az feature register --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
    else
        echo "Skipping any advanced network tests because you opted to avoid registering IPv6 feature"
        echo -n "Proceed without any advanced networking tests (y/n)? "
        read OK
        if [ "$OK" = "y" ]; then
            AZURE_ADVANCED_NIC_TESTS=false
        else
            echo "quit the test run"
            exit 1
        fi
    fi
    echo "Waiting for AllowIPv6VirtualNetwork feature registration"
    while [ "$IPV6_NET_REGISTERED" != "Registered" -o "$IPV6_CA_LB_REGISTERED" != "Registered" ]; do
        echo -n "."
        sleep 5
        IPV6_NET_REGISTERED=$(az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network | jq -r '.properties.state')
        IPV6_CA_LB_REGISTERED=$(az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network | jq -r '.properties.state')
    done
fi

IPV6_REGISTRATION_COMPLETE=$(az provider show -n Microsoft.Network | jq -r ".registrationState")
echo "Waiting for Microsoft.Network IPv6 feature registration"
while [ "$IPV6_REGISTRATION_COMPLETE"  != "Registered" ]; do
    echo -n "."
    sleep 5
    IPV6_REGISTRATION_COMPLETE=$(az provider show -n Microsoft.Network | jq -r ".registrationState")
done


echo "### BEGIN $UBUNTU_RELEASE"

az group show -g $AZURE_RESOURCE_GROUP > /dev/null 2>&1 || az group create --name $AZURE_RESOURCE_GROUP --location $AZURE_REGION

if [ -n "${AZURE_BOOT_DIAG}" ]; then
     az storage account show --name $AZURE_BOOT_DIAG > /dev/null 2>&1 ||
         az storage account create \
             --name $AZURE_BOOT_DIAG \
             --resource-group $AZURE_RESOURCE_GROUP \
             --location $AZURE_REGION \
             --sku Standard_RAGRS \
             --kind StorageV2
    AZURE_BOOT_DIAG_ARG="--boot-diagnostics-storage ${AZURE_BOOT_DIAG}"
else
    AZURE_BOOT_DIAG_ARG=""
fi

az network nsg show --name $AZURE_NETWORK_SECURITY_GROUP -g $AZURE_RESOURCE_GROUP > /dev/null 2>&1 || az network nsg create \
    --resource-group $AZURE_RESOURCE_GROUP \
    --location $AZURE_REGION \
    --name $AZURE_NETWORK_SECURITY_GROUP

az network nsg rule show --name allowSSHIn --nsg-name $AZURE_NETWORK_SECURITY_GROUP -g $AZURE_RESOURCE_GROUP > /dev/null 2>&1 || az network nsg rule create \
    --name allowSSHIn  \
    --nsg-name $AZURE_NETWORK_SECURITY_GROUP  \
    --resource-group $AZURE_RESOURCE_GROUP  \
    --priority 100  \
    --description "Allow SSH In"  \
    --access Allow  \
    --protocol "*"  \
    --direction Inbound  \
    --source-address-prefixes "*"  \
    --source-port-ranges "*"  \
    --destination-address-prefixes "*"  \
    --destination-port-ranges 22

az network nsg rule show --name allowAllOut --nsg-name $AZURE_NETWORK_SECURITY_GROUP -g $AZURE_RESOURCE_GROUP > /dev/null 2>&1 || az network nsg rule create \
    --name allowAllOut  \
    --resource-group $AZURE_RESOURCE_GROUP \
    --nsg-name $AZURE_NETWORK_SECURITY_GROUP \
    --priority 200  \
    --description "Allow All Out"  \
    --access Allow  \
    --protocol "*"  \
    --direction Outbound  \
    --source-address-prefixes "*"  \
    --source-port-ranges "*"  \
    --destination-address-prefixes "*"  \
    --destination-port-ranges "*"

az network vnet show --name $AZURE_VNET_NAME -g $AZURE_RESOURCE_GROUP > /dev/null 2>&1 || az network vnet create \
    --resource-group $AZURE_RESOURCE_GROUP \
    --location $AZURE_REGION \
    --name $AZURE_VNET_NAME \
    --address-prefixes "10.0.0.0/16" "ace:cab:deca::/48"

az network vnet subnet show --name sruSubnet --vnet-name $AZURE_VNET_NAME -g $AZURE_RESOURCE_GROUP > /dev/null 2>&1 || az network vnet subnet create \
    --name sruSubnet \
    --resource-group $AZURE_RESOURCE_GROUP \
    --vnet-name $AZURE_VNET_NAME \
    --address-prefixes "10.0.0.0/24" "ace:cab:deca:deed::/64" \
    --network-security-group $AZURE_NETWORK_SECURITY_GROUP


sshopts="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"

netcfg="/etc/netplan/50-cloud-init.yaml"
case $UBUNTU_RELEASE in
    xenial) image_version=Canonical:UbuntuServer:16.04-DAILY-LTS
            netcfg="/etc/network/interfaces.d/50-cloud-init.cfg";;
    bionic) image_version=Canonical:UbuntuServer:18.04-DAILY-LTS;;
    eoan) image_version=Canonical:UbuntuServer:19.10-DAILY;;
    focal) image_version=Canonical:0001-com-ubuntu-server-focal-daily:20_04-daily-lts;;
    *) echo "!! UPDATE FAMILY CASE STATEMENT !!"; exit 1;;
esac
# Note: accelerated network requires bigger size than our default DS1
for nics in "" "--nics $AZURE_NIC_NAME-$UBUNTU_RELEASE ${NIC_NAME}2-$UBUNTU_RELEASE --size Standard_DS2_v2"; do
    if [ "" = "$nics" ]; then
        echo "Creating standard network vm"
        name=test-sru-$UBUNTU_RELEASE
    else
        if [ $AZURE_ADVANCED_NIC_TESTS = false ]; then
            echo "Skipping advanced nic tests because ipv6 feature is disabled"
            continue
        fi
        echo "Creating advanced network vm"
        name=test-sru-$UBUNTU_RELEASE-advanced
        # Dual stack load balancer setup with only 1 dualstack/dual nic vm
        # Create VM IP address
        az network public-ip create \
            --name vmPublicIP-IPv4-$UBUNTU_RELEASE \
            --resource-group $AZURE_RESOURCE_GROUP \
            --location $AZURE_REGION \
            --sku BASIC \
            --allocation-method dynamic \
            --version IPv4
        # Create an IPV4 IP address for LB
        az network public-ip create \
            --name lbPublicIP_v4_$UBUNTU_RELEASE  \
            --resource-group $AZURE_RESOURCE_GROUP  \
            --location $AZURE_REGION  \
            --sku BASIC  \
            --allocation-method dynamic  \
            --version IPv4

        # Create an IPV6 IP address for LB
        az network public-ip create \
            --name lbPublicIP_v6_$UBUNTU_RELEASE  \
            --resource-group $AZURE_RESOURCE_GROUP  \
            --location $AZURE_REGION \
            --sku BASIC  \
            --allocation-method dynamic  \
            --version IPv6

        # Create LB
        az network lb create \
            --name dsLB_$UBUNTU_RELEASE  \
            --resource-group $AZURE_RESOURCE_GROUP \
            --sku Basic \
            --location $AZURE_REGION \
            --frontend-ip-name dsLbFrontEnd_v4_$UBUNTU_RELEASE  \
            --public-ip-address lbPublicIP_v4_$UBUNTU_RELEASE  \
            --backend-pool-name dsLbBackEndPool_v4_$UBUNTU_RELEASE

        # Create LB ipv6 frontend
        az network lb frontend-ip create \
            --lb-name dsLB_$UBUNTU_RELEASE  \
            --name dsLbFrontEnd_v6_$UBUNTU_RELEASE  \
            --resource-group $AZURE_RESOURCE_GROUP  \
            --public-ip-address lbPublicIP_v6_$UBUNTU_RELEASE

        # Create LB ipv6 backend
        az network lb address-pool create \
            --lb-name dsLB_$UBUNTU_RELEASE  \
            --name dsLbBackEndPool_v6_$UBUNTU_RELEASE  \
            --resource-group $AZURE_RESOURCE_GROUP

        # Create LB health probe for ssh port
        az network lb probe create -g $AZURE_RESOURCE_GROUP  \
            --lb-name dsLB_$UBUNTU_RELEASE -n dsProbe_$UBUNTU_RELEASE --protocol tcp \
            --port 22

        az network lb rule create \
            --lb-name dsLB_$UBUNTU_RELEASE  \
            --name dsLBrule_v4_$UBUNTU_RELEASE  \
            --resource-group $AZURE_RESOURCE_GROUP  \
            --frontend-ip-name dsLbFrontEnd_v4_$UBUNTU_RELEASE  \
            --protocol Tcp  \
            --frontend-port 22  \
            --backend-port 22  \
            --probe-name dsProbe_$UBUNTU_RELEASE \
            --backend-pool-name dsLbBackEndPool_v4_$UBUNTU_RELEASE

        az network lb rule create \
            --lb-name dsLB_$UBUNTU_RELEASE  \
            --name dsLBrule_v6_$UBUNTU_RELEASE  \
            --resource-group $AZURE_RESOURCE_GROUP  \
            --frontend-ip-name dsLbFrontEnd_v6_$UBUNTU_RELEASE  \
            --protocol Tcp  \
            --frontend-port 22  \
            --backend-port 22  \
            --probe-name dsProbe_$UBUNTU_RELEASE \
            --backend-pool-name dsLbBackEndPool_v6_$UBUNTU_RELEASE

        az vm availability-set create \
            --name dsAVset_$UBUNTU_RELEASE  \
            --resource-group $AZURE_RESOURCE_GROUP \
            --location $AZURE_REGION \
            --platform-fault-domain-count 2  \
            --platform-update-domain-count 2

        az network nic create \
            --name $AZURE_NIC_NAME-$UBUNTU_RELEASE \
            --resource-group $AZURE_RESOURCE_GROUP \
            --network-security-group $AZURE_NETWORK_SECURITY_GROUP \
            --vnet-name $AZURE_VNET_NAME \
             --accelerated-networking true \
            --subnet sruSubnet \
            --private-ip-address-version IPv4 \
            --lb-address-pools dsLbBackEndPool_v4_$UBUNTU_RELEASE  \
            --lb-name dsLB_$UBUNTU_RELEASE  \
            --public-ip-address vmPublicIP-IPv4-$UBUNTU_RELEASE

        az network nic create \
            --name ${AZURE_NIC_NAME}2-$UBUNTU_RELEASE \
            --resource-group $AZURE_RESOURCE_GROUP \
            --network-security-group $AZURE_NETWORK_SECURITY_GROUP \
            --vnet-name $AZURE_VNET_NAME \
            --accelerated-networking true \
            --subnet sruSubnet \
            --private-ip-address-version IPv4

        # Add IPv6 on primary nic
        az network nic ip-config create \
            --name $AZURE_NIC_NAME-$UBUNTU_RELEASE-v6 \
            --nic-name $AZURE_NIC_NAME-$UBUNTU_RELEASE \
            --resource-group $AZURE_RESOURCE_GROUP \
            --vnet-name $AZURE_VNET_NAME \
            --subnet sruSubnet \
            --lb-address-pools dsLbBackEndPool_v6_$UBUNTU_RELEASE  \
            --lb-name dsLB_$UBUNTU_RELEASE \
            --private-ip-address-version IPv6

    fi
    az vm show --name $name -g $AZURE_RESOURCE_GROUP > /dev/null 2>&1 ||
        az vm create --name=$name \
            --image=$image_version:latest \
            --admin-username=root --admin-username=ubuntu \
            -g $AZURE_RESOURCE_GROUP --ssh-key-value $SSH_KEY \
            $AZURE_BOOT_DIAG_ARG \
            --custom-data $SAMPLE_CLOUDCONFIG $nics
    IP=$(az vm list-ip-addresses --name $name | jq -r '.[] | .virtualMachine.network.publicIpAddresses[].ipAddress'| awk '{printf "ubuntu@%s", $1}')

    echo "Created $name: ubuntu@$IP"

    ssh $sshopts $IP -- cloud-init status --wait --long
    ssh $sshopts $IP -- dpkg-query --show cloud-init
    ssh $sshopts $IP -- sudo cat /run/cloud-init/result.json
    ssh $sshopts $IP -- ! grep Trace /var/log/cloud-init.log
    ssh $sshopts $IP -- systemd-analyze
    ssh $sshopts $IP -- systemd-analyze blame
    ssh $sshopts $IP -- cloud-init analyze show
    ssh $sshopts $IP -- cloud-init analyze blame
    echo 'Writing networking config: previous-network.out'
    ssh $sshopts $IP -- cat $netcfg > previous-network.out
    ssh $sshopts $IP -- ip -4 route >> previous-network.out
    ssh $sshopts $IP -- ip -4 addr >> previous-network.out
    ssh $sshopts $IP -- ip -6 route >> previous-network.out
    ssh $sshopts $IP -- ip -6 addr >> previous-network.out
    ssh $sshopts $IP -- grep DHCP /var/log/syslog >> previous-network.out

    scp $sshopts PROPOSED_SCRIPT $IP:.
    ssh $sshopts $IP -- sudo bash PROPOSED_SCRIPT 2>&1 | egrep 'cloud-init'
    ssh $sshopts $IP -- dpkg-query --show cloud-init
    ssh $sshopts $IP -- sudo hostname SRU-didnt-work
    ssh $sshopts $IP -- sudo rm -f $netcfg
    ssh $sshopts $IP -- sudo cloud-init clean --logs --reboot || true
    sleep 60

    ssh $sshopts $IP -- cloud-init status --wait --long
    ssh $sshopts $IP -- ! grep Trace /var/log/cloud-init.log
    ssh $sshopts $IP -- sudo cat /run/cloud-init/result.json
    ssh $sshopts $IP -- sudo systemd-analyze blame
    ssh $sshopts $IP -- cloud-init analyze show
    ssh $sshopts $IP -- cloud-init analyze blame
    echo 'After upgrade write network config: upgrade-network.out'
    ssh $sshopts $IP -- cat $netcfg > upgrade-network.out
    ssh $sshopts $IP -- ip -4 route >> upgrade-network.out
    ssh $sshopts $IP -- ip -4 addr >> upgrade-network.out
    ssh $sshopts $IP -- ip -6 route >> upgrade-network.out
    ssh $sshopts $IP -- ip -6 addr >> upgrade-network.out
    ssh $sshopts $IP -- grep DHCP /var/log/syslog >> upgrade-network.out
    echo '------- Diff previous-network to post-upgrade-network ------'
    diff -urN previous-network.out upgrade-network.out
    echo '------- Diff previous-network to post-upgrade-network ------'
    ssh $sshopts $IP -- cloud-init query --format "'cloud-region: {{cloud_name}}-{{region}}'"
    echo 'Get cloud-id'
    ssh $sshopts $IP -- cloud-id
    ssh $sshopts $IP -- cloud-init query --format "'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'"
    echo 'Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot'
    ssh $sshopts $IP -- sudo reboot || true
    sleep 30
    ssh $sshopts $IP -- cloud-init status --wait --long
    echo 'After reboot'
    ssh $sshopts $IP -- "grep 'Update datasource' /var/log/cloud-init.log"
done
echo "### END $UBUNTU_RELEASE"


=== BEGIN verification output ===
+ SRU_VARS=./sru-scripts/sru-vars.template
+ [ ! -f ./sru-scripts/sru-vars.template ]
+ . ./sru-scripts/sru-vars.template
+ PRESERVE_INSTANCE=false
+ UBUNTU_RELEASE=
+ LP_USER=UNSET
+ PROPOSED_SCRIPT=setup_proposed.sh
+ USE_DEV_PPA=0
+ SAMPLE_CLOUDCONFIG=sethostname.yaml
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ AZURE_REGION=UNSET
+ AZURE_VNET_NAME=UNSET
+ AZURE_NETWORK_SECURITY_GROUP=UNSET
+ AZURE_NIC_NAME=UNSET
+ AZURE_RESOURCE_GROUP=UNSET
+ AZURE_BOOT_DIAG=UNSET
+ AZURE_ADVANCED_NIC_TESTS=true
+ GCE_ZONE=UNSET
+ OPENSTACK_ADMIN_NET_ID=UNSET
+ OPENSTACK_SSH_KEY_NAME=UNSET
+ VMWARE_PASSWORD=UNSET
+ SRU_VARS_RC=.sru-vars.rc
+ [ -f .sru-vars.rc ]
+ [ -f /root/.sru-vars.rc ]
+ . /root/.sru-vars.rc
+ PRESERVE_INSTANCE=false
+ UBUNTU_RELEASE=
+ LP_USER=chad.smith
+ USE_DEV_PPA=0
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ AZURE_REGION=eastus2
+ AZURE_VNET_NAME=sruVnet
+ AZURE_NETWORK_SECURITY_GROUP=sruNetSecGroup
+ AZURE_NIC_NAME=sruNic
+ AZURE_RESOURCE_GROUP=srugroupIPV6
+ AZURE_BOOT_DIAG=storeitsru
+ AZURE_ADVANCED_NIC_TESTS=true
+ GCE_ZONE=UNSET
+ OPENSTACK_ADMIN_NET_ID=UNSET
+ OPENSTACK_SSH_KEY_NAME=UNSET
+ VMWARE_PASSWORD=UNSET
+ parse_args ./sru-scripts/manual/azure-sru xenial
+ script=./sru-scripts/manual/azure-sru
+ shift
+ [ 1 = 0 ]
+ [ 1 -ne 0 ]
+ UBUNTU_RELEASE=xenial
+ shift
+ [ 0 -ne 0 ]
+ [ -z xenial ]
+ assert_expected_vars PROPOSED_SCRIPT AZURE_REGION AZURE_VNET_NAME AZURE_NETWORK_SECURITY_GROUP AZURE_NIC_NAME AZURE_RESOURCE_GROUP AZURE_BOOT_DIAG SSH_KEY SAMPLE_CLOUDCONFIG AZURE_ADVANCED_NIC_TESTS
+ local value=
+ eval value=$PROPOSED_SCRIPT > /dev/null
+ value=setup_proposed.sh
+ [ -z setup_proposed.sh -o setup_proposed.sh = UNSET ]
+ eval value=$AZURE_REGION > /dev/null
+ value=eastus2
+ [ -z eastus2 -o eastus2 = UNSET ]
+ eval value=$AZURE_VNET_NAME > /dev/null
+ value=sruVnet
+ [ -z sruVnet -o sruVnet = UNSET ]
+ eval value=$AZURE_NETWORK_SECURITY_GROUP > /dev/null
+ value=sruNetSecGroup
+ [ -z sruNetSecGroup -o sruNetSecGroup = UNSET ]
+ eval value=$AZURE_NIC_NAME > /dev/null
+ value=sruNic
+ [ -z sruNic -o sruNic = UNSET ]
+ eval value=$AZURE_RESOURCE_GROUP > /dev/null
+ value=srugroupIPV6
+ [ -z srugroupIPV6 -o srugroupIPV6 = UNSET ]
+ eval value=$AZURE_BOOT_DIAG > /dev/null
+ value=storeitsru
+ [ -z storeitsru -o storeitsru = UNSET ]
+ eval value=$SSH_KEY > /dev/null
+ value=/root/.ssh/id_rsa.pub
+ [ -z /root/.ssh/id_rsa.pub -o /root/.ssh/id_rsa.pub = UNSET ]
+ eval value=$SAMPLE_CLOUDCONFIG > /dev/null
+ value=sethostname.yaml
+ [ -z sethostname.yaml -o sethostname.yaml = UNSET ]
+ eval value=$AZURE_ADVANCED_NIC_TESTS > /dev/null
+ value=true
+ [ -z true -o true = UNSET ]
+ create_samplecloudconfig
+ filename=sethostname.yaml
+ cat
+ create_setup_proposed_script
+ [ 0 -eq 0 ]
+ cat
+ AZURE_VNET_NAME=sruVnet-xenial
+ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
+ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ [ Registered != Registered -o Registered != Registered ]
+ + az provider showjq -n -r Microsoft.Network .registrationState

+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo Waiting for Microsoft.Network IPv6 feature registration
Waiting for Microsoft.Network IPv6 feature registration
+ [ Registered != Registered ]
+ echo ### BEGIN xenial
### BEGIN xenial
+ az group show -g srugroupIPV6
+ [ -n storeitsru ]
+ az storage account show --name storeitsru
+ az storage account create --name storeitsru --resource-group srugroupIPV6 --location eastus2 --sku Standard_RAGRS --kind StorageV2
The default kind for created storage account will change to 'StorageV2' from 'Storage' in future
{
  "accessTier": "Hot",
  "azureFilesIdentityBasedAuthentication": null,
  "creationTime": "2020-06-18T18:32:15.827025+00:00",
  "customDomain": null,
  "enableHttpsTrafficOnly": true,
  "encryption": {
    "keySource": "Microsoft.Storage",
    "keyVaultProperties": null,
    "services": {
      "blob": {
        "enabled": true,
        "lastEnabledTime": "2020-06-18T18:32:15.920777+00:00"
      },
      "file": {
        "enabled": true,
        "lastEnabledTime": "2020-06-18T18:32:15.920777+00:00"
      },
      "queue": null,
      "table": null
    }
  },
  "failoverInProgress": null,
  "geoReplicationStats": null,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Storage/storageAccounts/storeitsru",
  "identity": null,
  "isHnsEnabled": null,
  "kind": "StorageV2",
  "largeFileSharesState": null,
  "lastGeoFailoverTime": null,
  "location": "eastus2",
  "name": "storeitsru",
  "networkRuleSet": {
    "bypass": "AzureServices",
    "defaultAction": "Allow",
    "ipRules": [],
    "virtualNetworkRules": []
  },
  "primaryEndpoints": {
    "blob": "https://storeitsru.blob.core.windows.net/",
    "dfs": "https://storeitsru.dfs.core.windows.net/",
    "file": "https://storeitsru.file.core.windows.net/",
    "queue": "https://storeitsru.queue.core.windows.net/",
    "table": "https://storeitsru.table.core.windows.net/",
    "web": "https://storeitsru.z20.web.core.windows.net/"
  },
  "primaryLocation": "eastus2",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "secondaryEndpoints": {
    "blob": "https://storeitsru-secondary.blob.core.windows.net/",
    "dfs": "https://storeitsru-secondary.dfs.core.windows.net/",
    "file": null,
    "queue": "https://storeitsru-secondary.queue.core.windows.net/",
    "table": "https://storeitsru-secondary.table.core.windows.net/",
    "web": "https://storeitsru-secondary.z20.web.core.windows.net/"
  },
  "secondaryLocation": "centralus",
  "sku": {
    "capabilities": null,
    "kind": null,
    "locations": null,
    "name": "Standard_RAGRS",
    "resourceType": null,
    "restrictions": null,
    "tier": "Standard"
  },
  "statusOfPrimary": "available",
  "statusOfSecondary": "available",
  "tags": {},
  "type": "Microsoft.Storage/storageAccounts"
}
+ AZURE_BOOT_DIAG_ARG=--boot-diagnostics-storage storeitsru
+ az network nsg show --name sruNetSecGroup -g srugroupIPV6
+ az network nsg create --resource-group srugroupIPV6 --location eastus2 --name sruNetSecGroup
{
  "NewNSG": {
    "defaultSecurityRules": [
      {
        "access": "Allow",
        "description": "Allow inbound traffic from all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"bce16190-7342-4072-8a30-f501c5d32ea5\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetInBound",
        "name": "AllowVnetInBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow inbound traffic from azure load balancer",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"bce16190-7342-4072-8a30-f501c5d32ea5\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowAzureLoadBalancerInBound",
        "name": "AllowAzureLoadBalancerInBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "AzureLoadBalancer",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all inbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"bce16190-7342-4072-8a30-f501c5d32ea5\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllInBound",
        "name": "DenyAllInBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"bce16190-7342-4072-8a30-f501c5d32ea5\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetOutBound",
        "name": "AllowVnetOutBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to Internet",
        "destinationAddressPrefix": "Internet",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"bce16190-7342-4072-8a30-f501c5d32ea5\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowInternetOutBound",
        "name": "AllowInternetOutBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all outbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"bce16190-7342-4072-8a30-f501c5d32ea5\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllOutBound",
        "name": "DenyAllOutBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      }
    ],
    "etag": "W/\"bce16190-7342-4072-8a30-f501c5d32ea5\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": "eastus2",
    "name": "sruNetSecGroup",
    "networkInterfaces": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "05112927-8422-43ab-802d-aa64aca51b4b",
    "securityRules": [],
    "subnets": null,
    "tags": null,
    "type": "Microsoft.Network/networkSecurityGroups"
  }
}
+ az network nsg rule show --name allowSSHIn --nsg-name sruNetSecGroup -g srugroupIPV6
+ az network nsg rule create --name allowSSHIn --nsg-name sruNetSecGroup --resource-group srugroupIPV6 --priority 100 --description Allow SSH In --access Allow --protocol * --direction Inbound --source-address-prefixes * --source-port-ranges * --destination-address-prefixes * --destination-port-ranges 22
{
  "access": "Allow",
  "description": "Allow SSH In",
  "destinationAddressPrefix": "*",
  "destinationAddressPrefixes": [],
  "destinationApplicationSecurityGroups": null,
  "destinationPortRange": "22",
  "destinationPortRanges": [],
  "direction": "Inbound",
  "etag": "W/\"90ed4ab5-74f9-41a6-bbe2-2fa99a366f32\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/securityRules/allowSSHIn",
  "name": "allowSSHIn",
  "priority": 100,
  "protocol": "*",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "sourceAddressPrefix": "*",
  "sourceAddressPrefixes": [],
  "sourceApplicationSecurityGroups": null,
  "sourcePortRange": "*",
  "sourcePortRanges": [],
  "type": "Microsoft.Network/networkSecurityGroups/securityRules"
}
+ az network nsg rule show --name allowAllOut --nsg-name sruNetSecGroup -g srugroupIPV6
+ az network nsg rule create --name allowAllOut --resource-group srugroupIPV6 --nsg-name sruNetSecGroup --priority 200 --description Allow All Out --access Allow --protocol * --direction Outbound --source-address-prefixes * --source-port-ranges * --destination-address-prefixes * --destination-port-ranges *
{
  "access": "Allow",
  "description": "Allow All Out",
  "destinationAddressPrefix": "*",
  "destinationAddressPrefixes": [],
  "destinationApplicationSecurityGroups": null,
  "destinationPortRange": "*",
  "destinationPortRanges": [],
  "direction": "Outbound",
  "etag": "W/\"851362de-277d-4855-b8d3-67456650aa34\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/securityRules/allowAllOut",
  "name": "allowAllOut",
  "priority": 200,
  "protocol": "*",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "sourceAddressPrefix": "*",
  "sourceAddressPrefixes": [],
  "sourceApplicationSecurityGroups": null,
  "sourcePortRange": "*",
  "sourcePortRanges": [],
  "type": "Microsoft.Network/networkSecurityGroups/securityRules"
}
+ az network vnet show --name sruVnet-xenial -g srugroupIPV6
+ az network vnet create --resource-group srugroupIPV6 --location eastus2 --name sruVnet-xenial --address-prefixes 10.0.0.0/16 ace:cab:deca::/48
{
  "newVNet": {
    "addressSpace": {
      "addressPrefixes": [
        "10.0.0.0/16",
        "ace:cab:deca::/48"
      ]
    },
    "ddosProtectionPlan": null,
    "dhcpOptions": {
      "dnsServers": []
    },
    "enableDdosProtection": false,
    "enableVmProtection": false,
    "etag": "W/\"3355d29f-09a9-47b6-a32c-0d3371f124da\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet-xenial",
    "location": "eastus2",
    "name": "sruVnet-xenial",
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "5b48766f-4c15-4579-aebb-7dd9da916ffa",
    "subnets": [],
    "tags": {},
    "type": "Microsoft.Network/virtualNetworks",
    "virtualNetworkPeerings": []
  }
}
+ az network vnet subnet show --name sruSubnet --vnet-name sruVnet-xenial -g srugroupIPV6
+ az network vnet subnet create --name sruSubnet --resource-group srugroupIPV6 --vnet-name sruVnet-xenial --address-prefixes 10.0.0.0/24 ace:cab:deca:deed::/64 --network-security-group sruNetSecGroup
{
  "addressPrefix": null,
  "addressPrefixes": [
    "10.0.0.0/24",
    "ace:cab:deca:deed::/64"
  ],
  "delegations": [],
  "etag": "W/\"7f7f041b-698d-4db5-b783-a0bcc046d2fb\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet-xenial/subnets/sruSubnet",
  "ipConfigurationProfiles": null,
  "ipConfigurations": null,
  "name": "sruSubnet",
  "natGateway": null,
  "networkSecurityGroup": {
    "defaultSecurityRules": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": null,
    "name": null,
    "networkInterfaces": null,
    "provisioningState": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": null,
    "securityRules": null,
    "subnets": null,
    "tags": null,
    "type": null
  },
  "privateEndpointNetworkPolicies": "Enabled",
  "privateEndpoints": null,
  "privateLinkServiceNetworkPolicies": "Enabled",
  "provisioningState": "Succeeded",
  "purpose": null,
  "resourceGroup": "srugroupIPV6",
  "resourceNavigationLinks": null,
  "routeTable": null,
  "serviceAssociationLinks": null,
  "serviceEndpointPolicies": null,
  "serviceEndpoints": null,
  "type": "Microsoft.Network/virtualNetworks/subnets"
}
+ sshopts=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=Canonical:UbuntuServer:16.04-DAILY-LTS
+ netcfg=/etc/network/interfaces.d/50-cloud-init.cfg
+ [  =  ]
+ echo Creating standard network vm
Creating standard network vm
+ name=test-sru-xenial
+ az vm show --name test-sru-xenial -g srugroupIPV6
+ az vm create --name=test-sru-xenial --image=Canonical:UbuntuServer:16.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-xenial",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7E-7A-14",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.4",
  "publicIpAddress": "20.36.167.25",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-xenial
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@20.36.167.25
+ echo Created test-sru-xenial: ubuntu@ubuntu@20.36.167.25
Created test-sru-xenial: ubuntu@ubuntu@20.36.167.25
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- cloud-init status --wait --long

status: done
time: Thu, 18 Jun 2020 18:35:23 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- ! grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- systemd-analyze
Startup finished in 5.646s (kernel) + 24.900s (userspace) = 30.546s
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- systemd-analyze blame
          8.012s cloud-init.service
          4.461s cloud-config.service
          3.763s cloud-init-local.service
          2.510s snapd.service
          2.162s pollinate.service
          2.093s lxd-containers.service
          1.849s dev-sda1.device
          1.659s snapd.seeded.service
          1.427s apparmor.service
           923ms accounts-daemon.service
           739ms networking.service
           654ms cloud-final.service
           594ms iscsid.service
           526ms systemd-logind.service
           522ms rsyslog.service
           472ms grub-common.service
           453ms mdadm.service
           450ms lvm2-monitor.service
           412ms open-iscsi.service
           388ms systemd-timesyncd.service
           281ms ssh.service
           258ms systemd-modules-load.service
           256ms resolvconf.service
           250ms apport.service
           216ms kmod-static-nodes.service
           210ms keyboard-setup.service
           209ms console-setup.service
           209ms systemd-update-utmp.service
           208ms ufw.service
           208ms dev-mqueue.mount
           208ms systemd-remount-fs.service
           193ms lxd.socket
           189ms irqbalance.service
           175ms sys-kernel-debug.mount
           162ms systemd-udev-trigger.service
           160ms systemd-tmpfiles-setup-dev.service
           157ms dev-hugepages.mount
           133ms systemd-journald.service
           102ms snapd.socket
            99ms systemd-journal-flush.service
            98ms systemd-udevd.service
            87ms polkitd.service
            74ms systemd-user-sessions.service
            70ms systemd-machine-id-commit.service
            62ms ondemand.service
            56ms systemd-sysctl.service
            55ms plymouth-read-write.service
            53ms systemd-tmpfiles-setup.service
            49ms setvtrgb.service
            48ms rc-local.service
            37ms systemd-random-seed.service
            30ms ephemeral-disk-warning.service
            30ms boot-efi.mount
            29ms plymouth-quit-wait.service
            29ms sys-fs-fuse-connections.mount
            26ms plymouth-quit.service
            25ms sys-kernel-config.mount
            20ms user@1000.service
             9ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.10300s +00.00600s
|`->get_boot_telemetry @00.10900s +00.00900s
|`->get_system_info @00.11800s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.11900s +00.05700s
|`->load_azure_ds_dir @00.17600s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.29700s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.29700s +00.00100s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00800 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.33200s +00.27400s
|`->_get_metadata_from_imds @00.60600s +00.10200s
Finished stage: (azure-ds/get_metadata_from_imds) 00.40100 seconds

|`->_get_random_seed @00.73300s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.62100 seconds

|`->write_files @00.74100s +00.00200s
Finished stage: (azure-ds/_get_data) 00.64000 seconds

Finished stage: (init-local/search-Azure) 00.64300 seconds

|`->network config from fallback @00.80800s +00.02000s
Finished stage: (init-local) 00.84100 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @01.98000s +00.02200s
|`->network config from fallback @02.05600s +00.02000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @02.08400s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

|`->invoke_agent @02.08700s +00.17700s
|`->wait for agents to retrieve SSH keys @02.26400s +01.00200s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @03.26700s +00.03100s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.03200 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 01.21500 seconds

Finished stage: (azure-ds/_negotiate) 01.21600 seconds

Finished stage: (azure-ds/setup) 01.21600 seconds

Finished stage: (init-network/setup-datasource) 01.21600 seconds

|`->reading and applying user-data @03.30500s +00.00800s
|`->reading and applying vendor-data @03.31300s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.34300s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.34300s +00.05200s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @03.45300s +00.00200s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.06700 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.11900 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.11900 seconds

Finished stage: (azure-ds/activate) 00.12000 seconds

Finished stage: (init-network/activate-datasource) 00.12200 seconds

|`->config-migrator ran successfully @03.51000s +00.00100s
|`->config-seed_random ran successfully @03.51100s +00.00100s
|`->config-bootcmd ran successfully @03.51300s +00.00000s
|`->config-write-files ran successfully @03.51400s +00.00000s
|`->config-growpart ran successfully @03.51500s +00.37900s
|`->config-resizefs ran successfully @03.89400s +00.24700s
|`->config-disk_setup ran successfully @04.14100s +04.38700s
|`->config-mounts ran successfully @08.52800s +00.12200s
|`->config-set_hostname ran successfully @08.65000s +00.00600s
|`->config-update_hostname ran successfully @08.65600s +00.00200s
|`->config-update_etc_hosts ran successfully @08.65800s +00.00000s
|`->config-ca-certs ran successfully @08.65900s +00.00100s
|`->config-rsyslog ran successfully @08.66000s +00.00100s
|`->config-users-groups ran successfully @08.66100s +00.72900s
|`->config-ssh ran successfully @09.39100s +00.19500s
Finished stage: (init-network) 07.62000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @15.00800s +00.00200s
|`->config-snap ran successfully @15.01300s +00.00400s
|`->config-ssh-import-id ran successfully @15.02400s +00.94800s
|`->config-locale ran successfully @15.97300s +01.27600s
|`->config-set-passwords ran successfully @17.25000s +00.00100s
|`->config-grub-dpkg ran successfully @17.25200s +01.08300s
|`->config-apt-pipelining ran successfully @18.33600s +00.00100s
|`->config-apt-configure ran successfully @18.33700s +00.29800s
|`->config-ubuntu-advantage ran successfully @18.63500s +00.00200s
|`->config-ntp ran successfully @18.63700s +00.00100s
|`->config-timezone ran successfully @18.63800s +00.00100s
|`->config-disable-ec2-metadata ran successfully @18.64000s +00.00000s
|`->config-runcmd ran successfully @18.64000s +00.00100s
|`->config-byobu ran successfully @18.64100s +00.00100s
Finished stage: (modules-config) 03.68400 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @19.10700s +00.00100s
|`->config-fan ran successfully @19.10900s +00.00100s
|`->config-landscape ran successfully @19.11000s +00.00100s
|`->config-lxd ran successfully @19.11100s +00.00100s
|`->config-ubuntu-drivers ran successfully @19.11200s +00.00100s
|`->config-puppet ran successfully @19.11300s +00.00100s
|`->config-chef ran successfully @19.11400s +00.00100s
|`->config-mcollective ran successfully @19.11500s +00.00100s
|`->config-salt-minion ran successfully @19.11700s +00.00000s
|`->config-rightscale_userdata ran successfully @19.11800s +00.00000s
|`->config-scripts-vendor ran successfully @19.11900s +00.00100s
|`->config-scripts-per-once ran successfully @19.12000s +00.00100s
|`->config-scripts-per-boot ran successfully @19.12100s +00.00100s
|`->config-scripts-per-instance ran successfully @19.12200s +00.00100s
|`->config-scripts-user ran successfully @19.12300s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @19.12400s +00.06000s
|`->config-keys-to-console ran successfully @19.18400s +00.10500s
|`->config-phone-home ran successfully @19.29000s +00.00100s
|`->config-final-message ran successfully @19.29200s +00.00400s
|`->config-power-state-change ran successfully @19.29700s +00.00000s
Finished stage: (modules-final) 00.21400 seconds

Total Time: 20.12200 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- cloud-init analyze blame
-- Boot Record 01 --
     04.38700s (init-network/config-disk_setup)
     01.27600s (modules-config/config-locale)
     01.08300s (modules-config/config-grub-dpkg)
     01.00200s (azure-ds/waiting-for-ssh-public-key)
     00.94800s (modules-config/config-ssh-import-id)
     00.72900s (init-network/config-users-groups)
     00.37900s (init-network/config-growpart)
     00.29800s (modules-config/config-apt-configure)
     00.27400s (azure-ds/obtain-dhcp-lease)
     00.24700s (init-network/config-resizefs)
     00.19500s (init-network/config-ssh)
     00.17700s (azure-ds/invoke_agent)
     00.12200s (init-network/config-mounts)
     00.10500s (modules-final/config-keys-to-console)
     00.10200s (azure-ds/_get_metadata_from_imds)
     00.06000s (modules-final/config-ssh-authkey-fingerprints)
     00.05700s (azure-ds/list_possible_azure_ds_devs)
     00.05200s (azure-ds/_has_ntfs_filesystem)
     00.03100s (azure-ds/crtfile_to_pubkey)
     00.02200s (init-network/check-cache)
     00.02000s (azure-ds/parse_network_config)
     00.02000s (azure-ds/parse_network_config)
     00.00900s (azure-ds/get_boot_telemetry)
     00.00800s (init-network/consume-user-data)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/check-platform-viability)
     00.00400s (modules-final/config-final-message)
     00.00400s (modules-config/config-snap)
     00.00200s (modules-config/config-ubuntu-advantage)
     00.00200s (modules-config/config-emit_upstart)
     00.00200s (init-network/config-update_hostname)
     00.00200s (azure-ds/write_files)
     00.00200s (azure-ds/count_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/_get_random_seed)
     00.00100s (azure-ds/_extract_preprovisioned_vm_setting)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-power-state-change)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-write-files)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)

1 boot records analyzed
+ echo Writing networking config: previous-network.out
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR PROPOSED_SCRIPT ubuntu@20.36.167.25:.
PROPOSED_SCRIPT                               100%  196     3.3KB/s   00:00    
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- sudo bash PROPOSED_SCRIPT
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu xenial-proposed/main amd64 cloud-init all 20.2-45-g5f7825e2-0ubuntu1~16.04.1 [425 kB]
Preparing to unpack .../cloud-init_20.2-45-g5f7825e2-0ubuntu1~16.04.1_all.deb ...
Unpacking cloud-init (20.2-45-g5f7825e2-0ubuntu1~16.04.1) over (19.4-33-gbb4131a2-0ubuntu1~16.04.1) ...
Setting up cloud-init (20.2-45-g5f7825e2-0ubuntu1~16.04.1) ...
Leaving 'diversion of /etc/init/ureadahead.conf to /etc/init/ureadahead.conf.disabled by cloud-init'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- dpkg-query --show cloud-init
cloud-init	20.2-45-g5f7825e2-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- sudo hostname SRU-didnt-work
sudo: unable to resolve host SRU-worked-azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- sudo rm -f /etc/network/interfaces.d/50-cloud-init.cfg
sudo: unable to resolve host SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- sudo cloud-init clean --logs --reboot
sudo: unable to resolve host SRU-didnt-work
Connection to 20.36.167.25 closed by remote host.
+ true
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- cloud-init status --wait --long

status: done
time: Thu, 18 Jun 2020 18:36:58 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- ! grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- sudo systemd-analyze blame
sudo: unable to resolve host SRU-worked-azure
          2.580s cloud-config.service
          1.700s cloud-init-local.service
          1.622s cloud-init.service
          1.414s snapd.service
          1.356s dev-sda1.device
           907ms iscsid.service
           829ms accounts-daemon.service
           778ms grub-common.service
           733ms systemd-logind.service
           723ms mdadm.service
           690ms cloud-final.service
           589ms apparmor.service
           549ms ssh.service
           546ms networking.service
           538ms rsyslog.service
           535ms lxd-containers.service
           496ms rc-local.service
           453ms lvm2-monitor.service
           410ms systemd-timesyncd.service
           296ms apport.service
           223ms polkitd.service
           218ms ondemand.service
           210ms systemd-modules-load.service
           202ms console-setup.service
           193ms open-iscsi.service
           145ms lxd.socket
           145ms keyboard-setup.service
           144ms dev-mqueue.mount
           142ms resolvconf.service
           134ms systemd-update-utmp.service
           128ms irqbalance.service
           126ms ufw.service
           124ms systemd-udev-trigger.service
           120ms systemd-journald.service
           119ms sys-kernel-debug.mount
           100ms kmod-static-nodes.service
            99ms systemd-remount-fs.service
            88ms dev-hugepages.mount
            77ms systemd-journal-flush.service
            76ms sys-kernel-config.mount
            75ms systemd-tmpfiles-setup.service
            63ms systemd-sysctl.service
            63ms systemd-tmpfiles-setup-dev.service
            60ms systemd-random-seed.service
            59ms setvtrgb.service
            56ms sys-fs-fuse-connections.mount
            53ms snapd.socket
            49ms snapd.seeded.service
            43ms systemd-udevd.service
            36ms systemd-user-sessions.service
            35ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            28ms plymouth-quit-wait.service
            27ms plymouth-quit.service
            24ms plymouth-read-write.service
            20ms user@1000.service
            16ms systemd-update-utmp-runlevel.service
            15ms boot-efi.mount
            15ms ephemeral-disk-warning.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03600s +00.00600s
|`->get_boot_telemetry @00.04200s +00.00900s
|`->get_system_info @00.05100s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.05100s +00.17500s
|`->load_azure_ds_dir @00.22600s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.23100s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.23100s +00.00100s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00500 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.25200s +00.18400s
|`->_get_metadata_from_imds @00.43600s +00.01100s
Finished stage: (azure-ds/get_metadata_from_imds) 00.21400 seconds

|`->_get_random_seed @00.46500s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.42100 seconds

|`->write_files @00.47300s +00.00200s
Finished stage: (azure-ds/_get_data) 00.44100 seconds

Finished stage: (init-local/search-Azure) 00.44400 seconds

|`->network config from fallback @00.53700s +00.01800s
Finished stage: (init-local) 00.56900 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @01.52200s +00.01900s
|`->network config from fallback @01.59300s +00.01800s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @01.62000s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @01.62400s +00.03000s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @01.65400s +00.00000s
|`->_load_dhclient_json @01.65400s +00.02400s
|`->_get_value_from_dhcpoptions @01.67800s +00.00000s
|`->_get_value_from_leases_file @01.67900s +00.00000s
Finished stage: (azure-ds/find_endpoint) 00.02500 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @01.70000s +00.01700s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @01.71700s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01100 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @01.72800s +00.00500s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.03500 seconds

|`->_report_ready @01.73400s +00.00600s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.11600 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.11700 seconds

Finished stage: (azure-ds/_negotiate) 00.12100 seconds

Finished stage: (azure-ds/setup) 00.12100 seconds

Finished stage: (init-network/setup-datasource) 00.12100 seconds

|`->reading and applying user-data @01.74800s +00.00600s
|`->reading and applying vendor-data @01.75500s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @01.78200s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @01.78200s +00.08800s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.08800 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.08900 seconds

Finished stage: (azure-ds/activate) 00.08900 seconds

Finished stage: (init-network/activate-datasource) 00.09100 seconds

|`->config-migrator ran successfully @01.89100s +00.00100s
|`->config-seed_random ran successfully @01.89200s +00.00100s
|`->config-bootcmd ran successfully @01.89400s +00.00000s
|`->config-write-files ran successfully @01.89500s +00.00000s
|`->config-growpart ran successfully @01.89600s +00.04200s
|`->config-resizefs ran successfully @01.93800s +00.01500s
|`->config-disk_setup ran successfully @01.95300s +00.18600s
|`->config-mounts ran successfully @02.14000s +00.12400s
|`->config-set_hostname ran successfully @02.26400s +00.00600s
|`->config-update_hostname ran successfully @02.27000s +00.00200s
|`->config-update_etc_hosts ran successfully @02.27200s +00.00100s
|`->config-ca-certs ran successfully @02.27300s +00.00100s
|`->config-rsyslog ran successfully @02.27400s +00.00100s
|`->config-users-groups ran successfully @02.27500s +00.06500s
|`->config-ssh ran successfully @02.34100s +00.38300s
Finished stage: (init-network) 01.22000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @05.50400s +00.00000s
|`->config-snap ran successfully @05.50600s +00.00100s
|`->config-ssh-import-id ran successfully @05.50700s +00.90000s
|`->config-locale ran successfully @06.41100s +00.00100s
|`->config-set-passwords ran successfully @06.41200s +00.00200s
|`->config-grub-dpkg ran successfully @06.42000s +00.49500s
|`->config-apt-pipelining ran successfully @06.91600s +00.00100s
|`->config-apt-configure ran successfully @06.91700s +00.22400s
|`->config-ubuntu-advantage ran successfully @07.14200s +00.00100s
|`->config-ntp ran successfully @07.14300s +00.00100s
|`->config-timezone ran successfully @07.14500s +00.00000s
|`->config-disable-ec2-metadata ran successfully @07.14600s +00.00000s
|`->config-runcmd ran successfully @07.14700s +00.00000s
|`->config-byobu ran successfully @07.14800s +00.00000s
Finished stage: (modules-config) 01.67500 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @07.65500s +00.00100s
|`->config-fan ran successfully @07.65700s +00.00000s
|`->config-landscape ran successfully @07.65800s +00.00100s
|`->config-lxd ran successfully @07.65900s +00.00100s
|`->config-ubuntu-drivers ran successfully @07.66000s +00.00100s
|`->config-puppet ran successfully @07.66200s +00.00000s
|`->config-chef ran successfully @07.66300s +00.00100s
|`->config-mcollective ran successfully @07.66400s +00.00100s
|`->config-salt-minion ran successfully @07.66500s +00.00100s
|`->config-rightscale_userdata ran successfully @07.66600s +00.00100s
|`->config-scripts-vendor ran successfully @07.66800s +00.00000s
|`->config-scripts-per-once ran successfully @07.66900s +00.00100s
|`->config-scripts-per-boot ran successfully @07.67000s +00.00000s
|`->config-scripts-per-instance ran successfully @07.67100s +00.00100s
|`->config-scripts-user ran successfully @07.67200s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @07.67300s +00.08900s
|`->config-keys-to-console ran successfully @07.76300s +00.10200s
|`->config-phone-home ran successfully @07.86600s +00.00100s
|`->config-final-message ran successfully @07.86800s +00.00400s
|`->config-power-state-change ran successfully @07.87300s +00.00100s
Finished stage: (modules-final) 00.23800 seconds

Total Time: 6.26400 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- cloud-init analyze blame
-- Boot Record 01 --
     00.90000s (modules-config/config-ssh-import-id)
     00.49500s (modules-config/config-grub-dpkg)
     00.38300s (init-network/config-ssh)
     00.22400s (modules-config/config-apt-configure)
     00.18600s (init-network/config-disk_setup)
     00.18400s (azure-ds/obtain-dhcp-lease)
     00.17500s (azure-ds/list_possible_azure_ds_devs)
     00.12400s (init-network/config-mounts)
     00.10200s (modules-final/config-keys-to-console)
     00.08900s (modules-final/config-ssh-authkey-fingerprints)
     00.08800s (azure-ds/_has_ntfs_filesystem)
     00.06500s (init-network/config-users-groups)
     00.04200s (init-network/config-growpart)
     00.03000s (azure-ds/generate_certificate)
     00.02400s (azure-ds/_load_dhclient_json)
     00.01900s (init-network/check-cache)
     00.01800s (azure-ds/parse_network_config)
     00.01800s (azure-ds/parse_network_config)
     00.01700s (azure-ds/_decrypt_certs_from_xml)
     00.01500s (init-network/config-resizefs)
     00.01100s (azure-ds/_get_metadata_from_imds)
     00.00900s (azure-ds/get_boot_telemetry)
     00.00600s (init-network/consume-user-data)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/check-platform-viability)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_report_ready)
     00.00500s (azure-ds/_run_x509_action)
     00.00400s (modules-final/config-final-message)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (init-network/config-update_hostname)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-locale)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_get_random_seed)
     00.00100s (azure-ds/_extract_preprovisioned_vm_setting)
     00.00000s (modules-final/config-scripts-vendor)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-puppet)
     00.00000s (modules-final/config-fan)
     00.00000s (modules-config/config-timezone)
     00.00000s (modules-config/config-runcmd)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (modules-config/config-byobu)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-write-files)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (azure-ds/_get_value_from_leases_file)
     00.00000s (azure-ds/_get_value_from_dhcpoptions)

1 boot records analyzed
+ echo After upgrade write network config: upgrade-network.out
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.36.167.25 -- grep DHCP /var/log/syslog
+ echo ------- Diff previous-network to post-upgrade-network ------
------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
--- previous-network.out	2020-06-18 18:36:01.824734350 +0000
+++ upgrade-network.out	2020-06-18 18:37:40.862284064 +0000
@@ -40,3 +40,14 @@
 Jun 18 18:35:15 SRU-worked-azure ifup[910]: DHCPOFFER of 10.0.0.4 from 168.63.129.16
 Jun 18 18:35:15 SRU-worked-azure dhclient[1006]: DHCPACK of 10.0.0.4 from 168.63.129.16
 Jun 18 18:35:15 SRU-worked-azure ifup[910]: DHCPACK of 10.0.0.4 from 168.63.129.16
+Jun 18 18:36:54 SRU-worked-azure dhclient[895]: Internet Systems Consortium DHCP Client 4.3.3
+Jun 18 18:36:54 SRU-worked-azure dhclient[895]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0x38ad7c27)
+Jun 18 18:36:54 SRU-worked-azure dhclient[895]: DHCPREQUEST of 10.0.0.4 on eth0 to 255.255.255.255 port 67 (xid=0x277cad38)
+Jun 18 18:36:54 SRU-worked-azure dhclient[895]: DHCPOFFER of 10.0.0.4 from 168.63.129.16
+Jun 18 18:36:54 SRU-worked-azure dhclient[895]: DHCPACK of 10.0.0.4 from 168.63.129.16
+Jun 18 18:36:54 SRU-worked-azure dhclient[1037]: Internet Systems Consortium DHCP Client 4.3.3
+Jun 18 18:36:54 SRU-worked-azure ifup[942]: Internet Systems Consortium DHCP Client 4.3.3
+Jun 18 18:36:54 SRU-worked-azure dhclient[1037]: DHCPREQUEST of 10.0.0.4 on eth0 to 255.255.255.255 port 67 (xid=0x701d9f8)
+Jun 18 18:36:54 SRU-worked-azure ifup[942]: DHCPREQUEST of 10.0.0.4 on eth0 to 255.255.255.255 port 67 (xid=0x701d9f8)
+Jun 18 18:36:54 SRU-worked-azure dhclient[1037]: DHCPACK of 10.0.0.4 from 168.63.129.16
+Jun 18 18:36:54 SRU-worked-azure ifup[942]: DHCPACK of 10.0.0.4 from 168.63.129.16
+ SRU_VARS=./sru-scripts/sru-vars.template
+ [ ! -f ./sru-scripts/sru-vars.template ]
+ . ./sru-scripts/sru-vars.template
+ PRESERVE_INSTANCE=false
+ UBUNTU_RELEASE=
+ LP_USER=UNSET
+ PROPOSED_SCRIPT=setup_proposed.sh
+ USE_DEV_PPA=0
+ SAMPLE_CLOUDCONFIG=sethostname.yaml
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ AZURE_REGION=UNSET
+ AZURE_VNET_NAME=UNSET
+ AZURE_NETWORK_SECURITY_GROUP=UNSET
+ AZURE_NIC_NAME=UNSET
+ AZURE_RESOURCE_GROUP=UNSET
+ AZURE_BOOT_DIAG=UNSET
+ AZURE_ADVANCED_NIC_TESTS=true
+ GCE_ZONE=UNSET
+ OPENSTACK_ADMIN_NET_ID=UNSET
+ OPENSTACK_SSH_KEY_NAME=UNSET
+ VMWARE_PASSWORD=UNSET
+ SRU_VARS_RC=.sru-vars.rc
+ [ -f .sru-vars.rc ]
+ [ -f /root/.sru-vars.rc ]
+ . /root/.sru-vars.rc
+ PRESERVE_INSTANCE=false
+ UBUNTU_RELEASE=
+ LP_USER=chad.smith
+ USE_DEV_PPA=0
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ AZURE_REGION=eastus2
+ AZURE_VNET_NAME=sruVnet
+ AZURE_NETWORK_SECURITY_GROUP=sruNetSecGroup
+ AZURE_NIC_NAME=sruNic
+ AZURE_RESOURCE_GROUP=srugroupIPV6
+ AZURE_BOOT_DIAG=storeitsru
+ AZURE_ADVANCED_NIC_TESTS=true
+ GCE_ZONE=UNSET
+ OPENSTACK_ADMIN_NET_ID=UNSET
+ OPENSTACK_SSH_KEY_NAME=UNSET
+ VMWARE_PASSWORD=UNSET
+ parse_args ./sru-scripts/manual/azure-sru bionic
+ script=./sru-scripts/manual/azure-sru
+ shift
+ [ 1 = 0 ]
+ [ 1 -ne 0 ]
+ UBUNTU_RELEASE=bionic
+ shift
+ [ 0 -ne 0 ]
+ [ -z bionic ]
+ assert_expected_vars PROPOSED_SCRIPT AZURE_REGION AZURE_VNET_NAME AZURE_NETWORK_SECURITY_GROUP AZURE_NIC_NAME AZURE_RESOURCE_GROUP AZURE_BOOT_DIAG SSH_KEY SAMPLE_CLOUDCONFIG AZURE_ADVANCED_NIC_TESTS
+ local value=
+ eval value=$PROPOSED_SCRIPT > /dev/null
+ value=setup_proposed.sh
+ [ -z setup_proposed.sh -o setup_proposed.sh = UNSET ]
+ eval value=$AZURE_REGION > /dev/null
+ value=eastus2
+ [ -z eastus2 -o eastus2 = UNSET ]
+ eval value=$AZURE_VNET_NAME > /dev/null
+ value=sruVnet
+ [ -z sruVnet -o sruVnet = UNSET ]
+ eval value=$AZURE_NETWORK_SECURITY_GROUP > /dev/null
+ value=sruNetSecGroup
+ [ -z sruNetSecGroup -o sruNetSecGroup = UNSET ]
+ eval value=$AZURE_NIC_NAME > /dev/null
+ value=sruNic
+ [ -z sruNic -o sruNic = UNSET ]
+ eval value=$AZURE_RESOURCE_GROUP > /dev/null
+ value=srugroupIPV6
+ [ -z srugroupIPV6 -o srugroupIPV6 = UNSET ]
+ eval value=$AZURE_BOOT_DIAG > /dev/null
+ value=storeitsru
+ [ -z storeitsru -o storeitsru = UNSET ]
+ eval value=$SSH_KEY > /dev/null
+ value=/root/.ssh/id_rsa.pub
+ [ -z /root/.ssh/id_rsa.pub -o /root/.ssh/id_rsa.pub = UNSET ]
+ eval value=$SAMPLE_CLOUDCONFIG > /dev/null
+ value=sethostname.yaml
+ [ -z sethostname.yaml -o sethostname.yaml = UNSET ]
+ eval value=$AZURE_ADVANCED_NIC_TESTS > /dev/null
+ value=true
+ [ -z true -o true = UNSET ]
+ create_samplecloudconfig
+ filename=sethostname.yaml
+ cat
+ create_setup_proposed_script
+ [ 0 -eq 0 ]
+ cat
+ AZURE_VNET_NAME=sruVnet-bionic
+ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
+ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ [ Registered != Registered -o Registered != Registered ]
+ az provider show -n Microsoft.Network
+ jq -r .registrationState
+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo Waiting for Microsoft.Network IPv6 feature registration
Waiting for Microsoft.Network IPv6 feature registration
+ [ Registered != Registered ]
+ echo ### BEGIN bionic
### BEGIN bionic
+ az group show -g srugroupIPV6
+ [ -n storeitsru ]
+ az storage account show --name storeitsru
+ AZURE_BOOT_DIAG_ARG=--boot-diagnostics-storage storeitsru
+ az network nsg show --name sruNetSecGroup -g srugroupIPV6
+ az network nsg rule show --name allowSSHIn --nsg-name sruNetSecGroup -g srugroupIPV6
+ az network nsg rule show --name allowAllOut --nsg-name sruNetSecGroup -g srugroupIPV6
+ az network vnet show --name sruVnet-bionic -g srugroupIPV6
+ az network vnet create --resource-group srugroupIPV6 --location eastus2 --name sruVnet-bionic --address-prefixes 10.0.0.0/16 ace:cab:deca::/48
{
  "newVNet": {
    "addressSpace": {
      "addressPrefixes": [
        "10.0.0.0/16",
        "ace:cab:deca::/48"
      ]
    },
    "ddosProtectionPlan": null,
    "dhcpOptions": {
      "dnsServers": []
    },
    "enableDdosProtection": false,
    "enableVmProtection": false,
    "etag": "W/\"d22a4b86-116c-46f8-8c55-3d80b205b2bd\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet-bionic",
    "location": "eastus2",
    "name": "sruVnet-bionic",
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "ed2059fb-2027-4c24-9fe6-4cd46c86e9db",
    "subnets": [],
    "tags": {},
    "type": "Microsoft.Network/virtualNetworks",
    "virtualNetworkPeerings": []
  }
}
+ az network vnet subnet show --name sruSubnet --vnet-name sruVnet-bionic -g srugroupIPV6
+ az network vnet subnet create --name sruSubnet --resource-group srugroupIPV6 --vnet-name sruVnet-bionic --address-prefixes 10.0.0.0/24 ace:cab:deca:deed::/64 --network-security-group sruNetSecGroup
{
  "addressPrefix": null,
  "addressPrefixes": [
    "10.0.0.0/24",
    "ace:cab:deca:deed::/64"
  ],
  "delegations": [],
  "etag": "W/\"9d3479ad-eef6-4e82-b793-7e2a39aa4667\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet-bionic/subnets/sruSubnet",
  "ipConfigurationProfiles": null,
  "ipConfigurations": null,
  "name": "sruSubnet",
  "natGateway": null,
  "networkSecurityGroup": {
    "defaultSecurityRules": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": null,
    "name": null,
    "networkInterfaces": null,
    "provisioningState": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": null,
    "securityRules": null,
    "subnets": null,
    "tags": null,
    "type": null
  },
  "privateEndpointNetworkPolicies": "Enabled",
  "privateEndpoints": null,
  "privateLinkServiceNetworkPolicies": "Enabled",
  "provisioningState": "Succeeded",
  "purpose": null,
  "resourceGroup": "srugroupIPV6",
  "resourceNavigationLinks": null,
  "routeTable": null,
  "serviceAssociationLinks": null,
  "serviceEndpointPolicies": null,
  "serviceEndpoints": null,
  "type": "Microsoft.Network/virtualNetworks/subnets"
}
+ sshopts=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=Canonical:UbuntuServer:18.04-DAILY-LTS
+ [  =  ]
+ echo Creating standard network vm
Creating standard network vm
+ name=test-sru-bionic
+ az vm show --name test-sru-bionic -g srugroupIPV6
+ az vm create --name=test-sru-bionic --image=Canonical:UbuntuServer:18.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-bionic",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7A-71-1B",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.4",
  "publicIpAddress": "20.186.104.66",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-bionic
+ jq -r+  .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@20.186.104.66
+ echo Created test-sru-bionic: ubuntu@ubuntu@20.186.104.66
Created test-sru-bionic: ubuntu@ubuntu@20.186.104.66
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- cloud-init status --wait --long

status: done
time: Thu, 18 Jun 2020 18:40:11 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- ! grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- systemd-analyze
Startup finished in 7.664s (kernel) + 32.061s (userspace) = 39.726s
graphical.target reached after 31.144s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- systemd-analyze blame
          9.773s cloud-init.service
          5.598s cloud-init-local.service
          4.236s cloud-config.service
          2.135s dev-sda1.device
          1.957s pollinate.service
          1.821s lxd-containers.service
          1.792s systemd-networkd-wait-online.service
          1.776s snapd.seeded.service
          1.689s snapd.service
          1.444s apparmor.service
           918ms cloud-final.service
           824ms networkd-dispatcher.service
           822ms accounts-daemon.service
           722ms grub-common.service
           671ms apport.service
           458ms systemd-timesyncd.service
           440ms systemd-modules-load.service
           366ms keyboard-setup.service
           361ms lvm2-monitor.service
           348ms systemd-udev-trigger.service
           317ms polkit.service
           302ms rsyslog.service
           282ms systemd-logind.service
           260ms dev-mqueue.mount
           254ms kmod-static-nodes.service
           249ms ufw.service
           230ms ebtables.service
           228ms dev-hugepages.mount
           228ms systemd-remount-fs.service
           226ms systemd-journald.service
           193ms systemd-journal-flush.service
           182ms systemd-tmpfiles-setup-dev.service
           180ms sys-kernel-debug.mount
           173ms systemd-networkd.service
           149ms systemd-sysctl.service
           137ms snapd.socket
           128ms setvtrgb.service
           124ms systemd-udevd.service
           123ms lxd.socket
           113ms systemd-machine-id-commit.service
           111ms console-setup.service
           102ms systemd-tmpfiles-setup.service
           101ms ssh.service
           101ms systemd-user-sessions.service
            90ms systemd-resolved.service
            83ms plymouth-read-write.service
            72ms blk-availability.service
            46ms plymouth-quit.service
            43ms user@1000.service
            38ms sys-fs-fuse-connections.mount
            37ms systemd-random-seed.service
            37ms ephemeral-disk-warning.service
            36ms sys-kernel-config.mount
            33ms systemd-update-utmp.service
            29ms boot-efi.mount
            21ms systemd-update-utmp-runlevel.service
            16ms plymouth-quit-wait.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.15000s +00.01000s
|`->get_boot_telemetry @00.16000s +00.01500s
|`->get_system_info @00.17500s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.17600s +00.04500s
|`->load_azure_ds_dir @00.22200s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.34800s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.34900s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00800 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01300 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.39100s +00.42100s
|`->_get_metadata_from_imds @00.81200s +00.02000s
Finished stage: (azure-ds/get_metadata_from_imds) 00.46500 seconds

|`->_get_random_seed @00.85600s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.69000 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.86700s +00.00000s
|`->write_files @00.86800s +00.01000s
Finished stage: (azure-ds/_get_data) 00.72800 seconds

Finished stage: (init-local/search-Azure) 00.73100 seconds

|`->network config from imds @00.94200s +00.00100s
Finished stage: (init-local) 01.16900 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.71700s +00.03400s
|`->network config from imds @03.79800s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.80800s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.81300s +00.15700s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.97100s +00.00000s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @04.00300s +00.01400s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @04.01800s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.13200 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @04.15100s +00.00700s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00900 seconds

Finished stage: (azure-ds/parse_certificates) 00.15600 seconds

|`->_report_ready @04.15900s +02.75500s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.10200 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.10200 seconds

Finished stage: (azure-ds/_negotiate) 03.10700 seconds

Finished stage: (azure-ds/setup) 03.10700 seconds

Finished stage: (init-network/setup-datasource) 03.10800 seconds

|`->reading and applying user-data @06.93100s +00.00800s
|`->reading and applying vendor-data @06.93900s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @06.97800s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @06.97900s +00.16200s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.25400s +00.00500s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.13200 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.29400 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.29600 seconds

Finished stage: (azure-ds/activate) 00.29600 seconds

Finished stage: (init-network/activate-datasource) 00.30200 seconds

|`->config-migrator ran successfully @07.32800s +00.00100s
|`->config-seed_random ran successfully @07.33000s +00.00100s
|`->config-bootcmd ran successfully @07.33100s +00.00100s
|`->config-write-files ran successfully @07.33200s +00.00100s
|`->config-growpart ran successfully @07.33300s +00.59900s
|`->config-resizefs ran successfully @07.93300s +01.69600s
|`->config-disk_setup ran successfully @09.63000s +02.49900s
|`->config-mounts ran successfully @12.13000s +00.19700s
|`->config-set_hostname ran successfully @12.32800s +00.00800s
|`->config-update_hostname ran successfully @12.33700s +00.00100s
|`->config-update_etc_hosts ran successfully @12.33800s +00.00100s
|`->config-ca-certs ran successfully @12.33900s +00.00100s
|`->config-rsyslog ran successfully @12.34000s +00.00100s
|`->config-users-groups ran successfully @12.34200s +00.29000s
|`->config-ssh ran successfully @12.63200s +00.25300s
Finished stage: (init-network) 09.18700 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @18.16800s +00.00000s
|`->config-snap ran successfully @18.16900s +00.00100s
|`->config-ssh-import-id ran successfully @18.17000s +01.12000s
|`->config-locale ran successfully @19.29700s +00.00200s
|`->config-set-passwords ran successfully @19.30000s +00.00100s
|`->config-grub-dpkg ran successfully @19.30100s +01.95100s
|`->config-apt-pipelining ran successfully @21.25300s +00.00100s
|`->config-apt-configure ran successfully @21.25500s +00.25100s
|`->config-ubuntu-advantage ran successfully @21.50700s +00.00100s
|`->config-ntp ran successfully @21.50900s +00.00000s
|`->config-timezone ran successfully @21.51000s +00.00100s
|`->config-disable-ec2-metadata ran successfully @21.51100s +00.00100s
|`->config-runcmd ran successfully @21.51200s +00.00100s
|`->config-byobu ran successfully @21.51400s +00.00100s
Finished stage: (modules-config) 03.40300 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @22.26600s +00.00100s
|`->config-fan ran successfully @22.26700s +00.00100s
|`->config-landscape ran successfully @22.26900s +00.00000s
|`->config-lxd ran successfully @22.27000s +00.00100s
|`->config-ubuntu-drivers ran successfully @22.27100s +00.00100s
|`->config-puppet ran successfully @22.27200s +00.00100s
|`->config-chef ran successfully @22.27300s +00.00100s
|`->config-mcollective ran successfully @22.27400s +00.00100s
|`->config-salt-minion ran successfully @22.27500s +00.00100s
|`->config-rightscale_userdata ran successfully @22.27700s +00.00000s
|`->config-scripts-vendor ran successfully @22.27800s +00.00000s
|`->config-scripts-per-once ran successfully @22.27900s +00.00100s
|`->config-scripts-per-boot ran successfully @22.28000s +00.00000s
|`->config-scripts-per-instance ran successfully @22.28100s +00.00100s
|`->config-scripts-user ran successfully @22.28200s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @22.28300s +00.02700s
|`->config-keys-to-console ran successfully @22.31500s +00.11400s
|`->config-phone-home ran successfully @22.43100s +00.00500s
|`->config-final-message ran successfully @22.47500s +00.00500s
|`->config-power-state-change ran successfully @22.48000s +00.00100s
Finished stage: (modules-final) 00.23500 seconds

Total Time: 33.77700 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- cloud-init analyze blame
-- Boot Record 01 --
     02.75500s (azure-ds/_report_ready)
     02.49900s (init-network/config-disk_setup)
     01.95100s (modules-config/config-grub-dpkg)
     01.69600s (init-network/config-resizefs)
     01.12000s (modules-config/config-ssh-import-id)
     00.59900s (init-network/config-growpart)
     00.42100s (azure-ds/obtain-dhcp-lease)
     00.29000s (init-network/config-users-groups)
     00.25300s (init-network/config-ssh)
     00.25100s (modules-config/config-apt-configure)
     00.19700s (init-network/config-mounts)
     00.16200s (azure-ds/_has_ntfs_filesystem)
     00.15700s (azure-ds/generate_certificate)
     00.11400s (modules-final/config-keys-to-console)
     00.04500s (azure-ds/list_possible_azure_ds_devs)
     00.03400s (init-network/check-cache)
     00.02700s (modules-final/config-ssh-authkey-fingerprints)
     00.02000s (azure-ds/_get_metadata_from_imds)
     00.01500s (azure-ds/get_boot_telemetry)
     00.01400s (azure-ds/_decrypt_certs_from_xml)
     00.01000s (azure-ds/write_files)
     00.01000s (azure-ds/check-platform-viability)
     00.00800s (init-network/consume-user-data)
     00.00800s (init-network/config-set_hostname)
     00.00700s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-phone-home)
     00.00500s (modules-final/config-final-message)
     00.00500s (azure-ds/count_files)
     00.00200s (modules-config/config-locale)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-network/config-bootcmd)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/get_system_info)
     00.00000s (modules-final/config-scripts-vendor)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-landscape)
     00.00000s (modules-config/config-ntp)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Writing networking config: previous-network.out
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR PROPOSED_SCRIPT ubuntu@20.186.104.66:.
PROPOSED_SCRIPT                               100%  196     3.5KB/s   00:00    
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- sudo bash PROPOSED_SCRIPT
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu bionic-proposed/main amd64 cloud-init all 20.2-45-g5f7825e2-0ubuntu1~18.04.1 [422 kB]
Preparing to unpack .../cloud-init_20.2-45-g5f7825e2-0ubuntu1~18.04.1_all.deb ...
Unpacking cloud-init (20.2-45-g5f7825e2-0ubuntu1~18.04.1) over (19.4-33-gbb4131a2-0ubuntu1~18.04.1) ...
Setting up cloud-init (20.2-45-g5f7825e2-0ubuntu1~18.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- dpkg-query --show cloud-init
cloud-init	20.2-45-g5f7825e2-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- sudo cloud-init clean --logs --reboot
Connection to 20.186.104.66 closed by remote host.
+ true
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- cloud-init status --wait --long

status: done
time: Thu, 18 Jun 2020 18:41:53 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- ! grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- sudo systemd-analyze blame
          2.888s cloud-config.service
          2.303s cloud-init.service
          1.803s dev-sda1.device
          1.737s cloud-init-local.service
          1.539s systemd-networkd-wait-online.service
          1.182s snapd.service
          1.051s networkd-dispatcher.service
          1.000s lxd-containers.service
           876ms cloud-final.service
           632ms apparmor.service
           600ms systemd-udev-trigger.service
           510ms accounts-daemon.service
           461ms systemd-timesyncd.service
           426ms systemd-modules-load.service
           424ms keyboard-setup.service
           424ms grub-common.service
           418ms apport.service
           385ms systemd-journald.service
           342ms systemd-logind.service
           297ms ssh.service
           276ms rsyslog.service
           275ms lxd.socket
           274ms snapd.socket
           265ms polkit.service
           254ms lvm2-monitor.service
           157ms systemd-journal-flush.service
           153ms systemd-remount-fs.service
           153ms kmod-static-nodes.service
           152ms dev-mqueue.mount
           147ms ufw.service
           143ms sys-kernel-debug.mount
           123ms ebtables.service
           113ms dev-hugepages.mount
            99ms systemd-udevd.service
            97ms systemd-sysctl.service
            94ms systemd-tmpfiles-setup.service
            82ms ephemeral-disk-warning.service
            76ms systemd-resolved.service
            73ms blk-availability.service
            68ms sys-fs-fuse-connections.mount
            68ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            66ms snapd.seeded.service
            56ms systemd-user-sessions.service
            52ms systemd-tmpfiles-setup-dev.service
            46ms setvtrgb.service
            46ms systemd-networkd.service
            45ms systemd-update-utmp.service
            44ms user@1000.service
            40ms sys-kernel-config.mount
            39ms plymouth-quit.service
            34ms systemd-update-utmp-runlevel.service
            34ms plymouth-quit-wait.service
            28ms systemd-random-seed.service
            24ms plymouth-read-write.service
            19ms boot-efi.mount
            18ms console-setup.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03300s +00.00900s
|`->get_boot_telemetry @00.04200s +00.01600s
|`->get_system_info @00.05800s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.05800s +00.18200s
|`->load_azure_ds_dir @00.24100s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.24500s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.24600s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00500 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00500 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.26600s +00.29000s
|`->_get_metadata_from_imds @00.55700s +00.01100s
Finished stage: (azure-ds/get_metadata_from_imds) 00.32600 seconds

|`->_get_random_seed @00.59200s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.54300 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.60200s +00.00000s
|`->write_files @00.60200s +00.00300s
Finished stage: (azure-ds/_get_data) 00.57200 seconds

Finished stage: (init-local/search-Azure) 00.57500 seconds

|`->network config from imds @00.66200s +00.00000s
Finished stage: (init-local) 00.87800 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.10200s +00.01800s
|`->network config from imds @03.16800s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.17900s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.18300s +00.08100s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.26500s +00.00000s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.28900s +00.01400s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.30400s +00.00700s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.04100 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.34500s +00.00800s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00800 seconds

Finished stage: (azure-ds/parse_certificates) 00.06500 seconds

|`->_report_ready @03.35400s +00.01900s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.19000 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.19100 seconds

Finished stage: (azure-ds/_negotiate) 00.19500 seconds

Finished stage: (azure-ds/setup) 00.19600 seconds

Finished stage: (init-network/setup-datasource) 00.19700 seconds

|`->reading and applying user-data @03.38300s +00.01000s
|`->reading and applying vendor-data @03.39300s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.44500s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.44600s +00.16600s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.16700 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.16800 seconds

Finished stage: (azure-ds/activate) 00.16900 seconds

Finished stage: (init-network/activate-datasource) 00.17100 seconds

|`->config-migrator ran successfully @03.66900s +00.00100s
|`->config-seed_random ran successfully @03.67100s +00.02900s
|`->config-bootcmd ran successfully @03.70100s +00.00400s
|`->config-write-files ran successfully @03.70500s +00.00100s
|`->config-growpart ran successfully @03.70600s +00.24700s
|`->config-resizefs ran successfully @03.95400s +00.02900s
|`->config-disk_setup ran successfully @03.98300s +00.19000s
|`->config-mounts ran successfully @04.17400s +00.19600s
|`->config-set_hostname ran successfully @04.37100s +00.00800s
|`->config-update_hostname ran successfully @04.37900s +00.00200s
|`->config-update_etc_hosts ran successfully @04.38100s +00.00000s
|`->config-ca-certs ran successfully @04.38200s +00.00100s
|`->config-rsyslog ran successfully @04.38300s +00.00100s
|`->config-users-groups ran successfully @04.38400s +00.19600s
|`->config-ssh ran successfully @04.58100s +00.18400s
Finished stage: (init-network) 01.68000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @08.05400s +00.00400s
|`->config-snap ran successfully @08.05900s +00.00100s
|`->config-ssh-import-id ran successfully @08.06000s +00.98900s
|`->config-locale ran successfully @09.05000s +00.01900s
|`->config-set-passwords ran successfully @09.06900s +00.00100s
|`->config-grub-dpkg ran successfully @09.08500s +00.45300s
|`->config-apt-pipelining ran successfully @09.53900s +00.00200s
|`->config-apt-configure ran successfully @09.54100s +00.13900s
|`->config-ubuntu-advantage ran successfully @09.68100s +00.00100s
|`->config-ntp ran successfully @09.68200s +00.00100s
|`->config-timezone ran successfully @09.68300s +00.00100s
|`->config-disable-ec2-metadata ran successfully @09.68400s +00.00100s
|`->config-runcmd ran successfully @09.68500s +00.00100s
|`->config-byobu ran successfully @09.68600s +00.00100s
Finished stage: (modules-config) 01.66500 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @10.46100s +00.00100s
|`->config-fan ran successfully @10.46200s +00.00100s
|`->config-landscape ran successfully @10.46300s +00.00100s
|`->config-lxd ran successfully @10.46500s +00.00000s
|`->config-ubuntu-drivers ran successfully @10.46600s +00.00100s
|`->config-puppet ran successfully @10.46700s +00.00100s
|`->config-chef ran successfully @10.46800s +00.00100s
|`->config-mcollective ran successfully @10.46900s +00.00100s
|`->config-salt-minion ran successfully @10.47000s +00.00100s
|`->config-rightscale_userdata ran successfully @10.47200s +00.00000s
|`->config-scripts-vendor ran successfully @10.47300s +00.00100s
|`->config-scripts-per-once ran successfully @10.47400s +00.00100s
|`->config-scripts-per-boot ran successfully @10.47500s +00.00100s
|`->config-scripts-per-instance ran successfully @10.47600s +00.00100s
|`->config-scripts-user ran successfully @10.47800s +00.00000s
|`->config-ssh-authkey-fingerprints ran successfully @10.47900s +00.08800s
|`->config-keys-to-console ran successfully @10.56700s +00.10900s
|`->config-phone-home ran successfully @10.67700s +00.00100s
|`->config-final-message ran successfully @10.67900s +00.00500s
|`->config-power-state-change ran successfully @10.68400s +00.00200s
Finished stage: (modules-final) 00.24900 seconds

Total Time: 8.26000 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- cloud-init analyze blame
-- Boot Record 01 --
     00.98900s (modules-config/config-ssh-import-id)
     00.45300s (modules-config/config-grub-dpkg)
     00.29000s (azure-ds/obtain-dhcp-lease)
     00.24700s (init-network/config-growpart)
     00.19600s (init-network/config-users-groups)
     00.19600s (init-network/config-mounts)
     00.19000s (init-network/config-disk_setup)
     00.18400s (init-network/config-ssh)
     00.18200s (azure-ds/list_possible_azure_ds_devs)
     00.16600s (azure-ds/_has_ntfs_filesystem)
     00.13900s (modules-config/config-apt-configure)
     00.10900s (modules-final/config-keys-to-console)
     00.08800s (modules-final/config-ssh-authkey-fingerprints)
     00.08100s (azure-ds/generate_certificate)
     00.02900s (init-network/config-seed_random)
     00.02900s (init-network/config-resizefs)
     00.01900s (modules-config/config-locale)
     00.01900s (azure-ds/_report_ready)
     00.01800s (init-network/check-cache)
     00.01600s (azure-ds/get_boot_telemetry)
     00.01400s (azure-ds/_decrypt_certs_from_xml)
     00.01100s (azure-ds/_get_metadata_from_imds)
     00.01000s (init-network/consume-user-data)
     00.00900s (azure-ds/check-platform-viability)
     00.00800s (init-network/config-set_hostname)
     00.00800s (azure-ds/_run_x509_action)
     00.00700s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00400s (modules-config/config-emit_upstart)
     00.00400s (init-network/config-bootcmd)
     00.00300s (azure-ds/write_files)
     00.00200s (modules-final/config-power-state-change)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-update_hostname)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (modules-final/config-scripts-user)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-lxd)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade write network config: upgrade-network.out
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@20.186.104.66 -- grep DHCP /var/log/syslog
+ echo ------- Diff previous-network to post-upgrade-network ------
------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
--- previous-network.out	2020-06-18 18:40:47.485188739 +0000
+++ upgrade-network.out	2020-06-18 18:42:33.870829153 +0000
@@ -38,3 +38,9 @@
 Jun 18 18:40:03 SRU-worked-azure dhclient[810]: DHCPOFFER of 10.0.0.4 from 168.63.129.16
 Jun 18 18:40:03 SRU-worked-azure dhclient[810]: DHCPACK of 10.0.0.4 from 168.63.129.16
 Jun 18 18:40:03 SRU-worked-azure systemd-networkd[846]: eth0: DHCPv4 address 10.0.0.4/24 via 10.0.0.1
+Jun 18 18:41:48 SRU-worked-azure dhclient[821]: Internet Systems Consortium DHCP Client 4.3.5
+Jun 18 18:41:48 SRU-worked-azure dhclient[821]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0x8f23af27)
+Jun 18 18:41:48 SRU-worked-azure dhclient[821]: DHCPREQUEST of 10.0.0.4 on eth0 to 255.255.255.255 port 67 (xid=0x27af238f)
+Jun 18 18:41:48 SRU-worked-azure dhclient[821]: DHCPOFFER of 10.0.0.4 from 168.63.129.16
+Jun 18 18:41:48 SRU-worked-azure dhclient[821]: DHCPACK of 10.0.0.4 from 168.63.129.16
+Jun 18 18:41:48 SRU-worked-azure systemd-networkd[856]: eth0: DHCPv4 address 10.0.0.4/24 via 10.0.0.1
+ SRU_VARS=./sru-scripts/sru-vars.template
+ [ ! -f ./sru-scripts/sru-vars.template ]
+ . ./sru-scripts/sru-vars.template
+ PRESERVE_INSTANCE=false
+ UBUNTU_RELEASE=
+ LP_USER=UNSET
+ PROPOSED_SCRIPT=setup_proposed.sh
+ USE_DEV_PPA=0
+ SAMPLE_CLOUDCONFIG=sethostname.yaml
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ AZURE_REGION=UNSET
+ AZURE_VNET_NAME=UNSET
+ AZURE_NETWORK_SECURITY_GROUP=UNSET
+ AZURE_NIC_NAME=UNSET
+ AZURE_RESOURCE_GROUP=UNSET
+ AZURE_BOOT_DIAG=UNSET
+ AZURE_ADVANCED_NIC_TESTS=true
+ GCE_ZONE=UNSET
+ OPENSTACK_ADMIN_NET_ID=UNSET
+ OPENSTACK_SSH_KEY_NAME=UNSET
+ VMWARE_PASSWORD=UNSET
+ SRU_VARS_RC=.sru-vars.rc
+ [ -f .sru-vars.rc ]
+ [ -f /root/.sru-vars.rc ]
+ . /root/.sru-vars.rc
+ PRESERVE_INSTANCE=false
+ UBUNTU_RELEASE=
+ LP_USER=chad.smith
+ USE_DEV_PPA=0
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ AZURE_REGION=eastus2
+ AZURE_VNET_NAME=sruVnet
+ AZURE_NETWORK_SECURITY_GROUP=sruNetSecGroup
+ AZURE_NIC_NAME=sruNic
+ AZURE_RESOURCE_GROUP=srugroupIPV6
+ AZURE_BOOT_DIAG=storeitsru
+ AZURE_ADVANCED_NIC_TESTS=true
+ GCE_ZONE=UNSET
+ OPENSTACK_ADMIN_NET_ID=UNSET
+ OPENSTACK_SSH_KEY_NAME=UNSET
+ VMWARE_PASSWORD=UNSET
+ parse_args ./sru-scripts/manual/azure-sru eoan
+ script=./sru-scripts/manual/azure-sru
+ shift
+ [ 1 = 0 ]
+ [ 1 -ne 0 ]
+ UBUNTU_RELEASE=eoan
+ shift
+ [ 0 -ne 0 ]
+ [ -z eoan ]
+ assert_expected_vars PROPOSED_SCRIPT AZURE_REGION AZURE_VNET_NAME AZURE_NETWORK_SECURITY_GROUP AZURE_NIC_NAME AZURE_RESOURCE_GROUP AZURE_BOOT_DIAG SSH_KEY SAMPLE_CLOUDCONFIG AZURE_ADVANCED_NIC_TESTS
+ local value=
+ eval value=$PROPOSED_SCRIPT > /dev/null
+ value=setup_proposed.sh
+ [ -z setup_proposed.sh -o setup_proposed.sh = UNSET ]
+ eval value=$AZURE_REGION > /dev/null
+ value=eastus2
+ [ -z eastus2 -o eastus2 = UNSET ]
+ eval value=$AZURE_VNET_NAME > /dev/null
+ value=sruVnet
+ [ -z sruVnet -o sruVnet = UNSET ]
+ eval value=$AZURE_NETWORK_SECURITY_GROUP > /dev/null
+ value=sruNetSecGroup
+ [ -z sruNetSecGroup -o sruNetSecGroup = UNSET ]
+ eval value=$AZURE_NIC_NAME > /dev/null
+ value=sruNic
+ [ -z sruNic -o sruNic = UNSET ]
+ eval value=$AZURE_RESOURCE_GROUP > /dev/null
+ value=srugroupIPV6
+ [ -z srugroupIPV6 -o srugroupIPV6 = UNSET ]
+ eval value=$AZURE_BOOT_DIAG > /dev/null
+ value=storeitsru
+ [ -z storeitsru -o storeitsru = UNSET ]
+ eval value=$SSH_KEY > /dev/null
+ value=/root/.ssh/id_rsa.pub
+ [ -z /root/.ssh/id_rsa.pub -o /root/.ssh/id_rsa.pub = UNSET ]
+ eval value=$SAMPLE_CLOUDCONFIG > /dev/null
+ value=sethostname.yaml
+ [ -z sethostname.yaml -o sethostname.yaml = UNSET ]
+ eval value=$AZURE_ADVANCED_NIC_TESTS > /dev/null
+ value=true
+ [ -z true -o true = UNSET ]
+ create_samplecloudconfig
+ filename=sethostname.yaml
+ cat
+ create_setup_proposed_script
+ [ 0 -eq 0 ]
+ cat
+ AZURE_VNET_NAME=sruVnet-eoan
+ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
+ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ [ Registered != Registered -o Registered != Registered ]
+ az provider show -n Microsoft.Network
+ jq -r .registrationState
+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo Waiting for Microsoft.Network IPv6 feature registration
Waiting for Microsoft.Network IPv6 feature registration
+ [ Registered != Registered ]
+ echo ### BEGIN eoan
### BEGIN eoan
+ az group show -g srugroupIPV6
+ [ -n storeitsru ]
+ az storage account show --name storeitsru
+ AZURE_BOOT_DIAG_ARG=--boot-diagnostics-storage storeitsru
+ az network nsg show --name sruNetSecGroup -g srugroupIPV6
+ az network nsg rule show --name allowSSHIn --nsg-name sruNetSecGroup -g srugroupIPV6
+ az network nsg rule show --name allowAllOut --nsg-name sruNetSecGroup -g srugroupIPV6
+ az network vnet show --name sruVnet-eoan -g srugroupIPV6
+ az network vnet create --resource-group srugroupIPV6 --location eastus2 --name sruVnet-eoan --address-prefixes 10.0.0.0/16 ace:cab:deca::/48
{
  "newVNet": {
    "addressSpace": {
      "addressPrefixes": [
        "10.0.0.0/16",
        "ace:cab:deca::/48"
      ]
    },
    "ddosProtectionPlan": null,
    "dhcpOptions": {
      "dnsServers": []
    },
    "enableDdosProtection": false,
    "enableVmProtection": false,
    "etag": "W/\"be5cca5e-5e74-4a28-9cce-8123226baa7b\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet-eoan",
    "location": "eastus2",
    "name": "sruVnet-eoan",
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "a34e9b15-469c-49aa-805a-4334611ae2fa",
    "subnets": [],
    "tags": {},
    "type": "Microsoft.Network/virtualNetworks",
    "virtualNetworkPeerings": []
  }
}
+ az network vnet subnet show --name sruSubnet --vnet-name sruVnet-eoan -g srugroupIPV6
+ az network vnet subnet create --name sruSubnet --resource-group srugroupIPV6 --vnet-name sruVnet-eoan --address-prefixes 10.0.0.0/24 ace:cab:deca:deed::/64 --network-security-group sruNetSecGroup
{
  "addressPrefix": null,
  "addressPrefixes": [
    "10.0.0.0/24",
    "ace:cab:deca:deed::/64"
  ],
  "delegations": [],
  "etag": "W/\"2fca82f3-c951-4958-80fd-867bf44132c7\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet-eoan/subnets/sruSubnet",
  "ipConfigurationProfiles": null,
  "ipConfigurations": null,
  "name": "sruSubnet",
  "natGateway": null,
  "networkSecurityGroup": {
    "defaultSecurityRules": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": null,
    "name": null,
    "networkInterfaces": null,
    "provisioningState": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": null,
    "securityRules": null,
    "subnets": null,
    "tags": null,
    "type": null
  },
  "privateEndpointNetworkPolicies": "Enabled",
  "privateEndpoints": null,
  "privateLinkServiceNetworkPolicies": "Enabled",
  "provisioningState": "Succeeded",
  "purpose": null,
  "resourceGroup": "srugroupIPV6",
  "resourceNavigationLinks": null,
  "routeTable": null,
  "serviceAssociationLinks": null,
  "serviceEndpointPolicies": null,
  "serviceEndpoints": null,
  "type": "Microsoft.Network/virtualNetworks/subnets"
}
+ sshopts=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=Canonical:UbuntuServer:19.10-DAILY
+ [  =  ]
+ echo Creating standard network vm
Creating standard network vm
+ name=test-sru-eoan
+ az vm show --name test-sru-eoan -g srugroupIPV6
+ az vm create --name=test-sru-eoan --image=Canonical:UbuntuServer:19.10-DAILY:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-eoan",
  "location": "eastus2",
  "macAddress": "00-0D-3A-00-25-59",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.5",
  "publicIpAddress": "52.254.87.225",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-eoan
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.254.87.225
+ echo Created test-sru-eoan: ubuntu@ubuntu@52.254.87.225
Created test-sru-eoan: ubuntu@ubuntu@52.254.87.225
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- cloud-init status --wait --long
..........................................................................
status: done
time: Thu, 18 Jun 2020 18:44:38 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~19.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- ! grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- systemd-analyze
Startup finished in 3.543s (kernel) + 57.231s (userspace) = 1min 775ms 
graphical.target reached after 56.462s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- systemd-analyze blame
         26.851s snapd.seeded.service
         11.450s cloud-init.service
          4.846s cloud-init-local.service
          2.897s lvm2-monitor.service
          2.639s dev-sda1.device
          2.490s cloud-config.service
          2.414s systemd-udev-settle.service
          2.374s pollinate.service
          1.543s systemd-networkd-wait-online.service
          1.214s snapd.service
          1.189s systemd-logind.service
          1.091s accounts-daemon.service
           872ms rsyslog.service
           781ms networkd-dispatcher.service
           775ms apparmor.service
           772ms cloud-final.service
           709ms apport.service
           704ms grub-common.service
           516ms systemd-journald.service
           515ms systemd-networkd.service
           503ms systemd-resolved.service
           434ms user@1000.service
           430ms snap.lxd.activate.service
           411ms systemd-udev-trigger.service
           356ms systemd-udevd.service
           342ms chrony.service
           337ms atd.service
           274ms keyboard-setup.service
           238ms sys-kernel-debug.mount
           238ms systemd-modules-load.service
           235ms blk-availability.service
           230ms systemd-remount-fs.service
           223ms dev-hugepages.mount
           221ms ufw.service
           209ms grub-initrd-fallback.service
           204ms multipathd.service
           195ms systemd-user-sessions.service
           176ms kmod-static-nodes.service
           174ms systemd-sysusers.service
           169ms dev-mqueue.mount
           166ms plymouth-quit-wait.service
           161ms systemd-journal-flush.service
           153ms polkit.service
           147ms plymouth-quit.service
           116ms sys-fs-fuse-connections.mount
           112ms plymouth-read-write.service
           110ms sys-kernel-config.mount
           110ms systemd-tmpfiles-setup.service
           108ms finalrd.service
           102ms systemd-machine-id-commit.service
           102ms ssh.service
            99ms systemd-sysctl.service
            97ms console-setup.service
            93ms setvtrgb.service
            81ms snapd.socket
            71ms systemd-random-seed.service
            52ms systemd-tmpfiles-setup-dev.service
            47ms snap-snapd-7777.mount
            42ms snap-core18-1754.mount
            40ms user-runtime-dir@1000.service
            37ms snap-lxd-15457.mount
            37ms systemd-update-utmp-runlevel.service
            35ms dev-loop2.device
            31ms dev-loop0.device
            30ms ephemeral-disk-warning.service
            30ms systemd-update-utmp.service
            30ms boot-efi.mount
            23ms dev-loop1.device
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00300s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.14100s +00.00900s
|`->get_boot_telemetry @00.15000s +00.06800s
|`->get_system_info @00.21800s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.21800s +00.05600s
|`->load_azure_ds_dir @00.27400s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.38700s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.38800s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01100 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.42200s +00.38900s
|`->_get_metadata_from_imds @00.81100s +00.08800s
Finished stage: (azure-ds/get_metadata_from_imds) 00.50200 seconds

|`->_get_random_seed @00.92300s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.71400 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.93200s +00.00100s
|`->write_files @00.93300s +00.01000s
Finished stage: (azure-ds/_get_data) 00.80200 seconds

Finished stage: (init-local/search-Azure) 00.80400 seconds

|`->network config from imds @01.00700s +00.00000s
Finished stage: (init-local) 01.26100 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.84200s +00.02100s
|`->network config from imds @03.91900s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.92800s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.93200s +00.28500s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @04.21700s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @04.24000s +00.01300s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @04.25300s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.04700 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @04.30000s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.06700 seconds

|`->_report_ready @04.30700s +02.55600s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 02.93300 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 02.93300 seconds

Finished stage: (azure-ds/_negotiate) 02.93700 seconds

Finished stage: (azure-ds/setup) 02.93800 seconds

Finished stage: (init-network/setup-datasource) 02.93800 seconds

|`->reading and applying user-data @06.87700s +00.00700s
|`->reading and applying vendor-data @06.88400s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @06.91900s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @06.92000s +00.13700s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.14000s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.09600 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.23300 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.23500 seconds

Finished stage: (azure-ds/activate) 00.23500 seconds

Finished stage: (init-network/activate-datasource) 00.23600 seconds

|`->config-migrator ran successfully @07.23500s +00.00100s
|`->config-seed_random ran successfully @07.23600s +00.00100s
|`->config-bootcmd ran successfully @07.23800s +00.00000s
|`->config-write-files ran successfully @07.23800s +00.00100s
|`->config-growpart ran successfully @07.23900s +00.72300s
|`->config-resizefs ran successfully @07.96200s +02.69800s
|`->config-disk_setup ran successfully @10.66000s +02.51800s
|`->config-mounts ran successfully @13.18100s +00.26300s
|`->config-set_hostname ran successfully @13.44400s +00.00700s
|`->config-update_hostname ran successfully @13.45100s +00.00100s
|`->config-update_etc_hosts ran successfully @13.45300s +00.00000s
|`->config-ca-certs ran successfully @13.45400s +00.00000s
|`->config-rsyslog ran successfully @13.45500s +00.00000s
|`->config-users-groups ran successfully @13.45600s +00.84800s
|`->config-ssh ran successfully @14.30500s +00.49000s
Finished stage: (init-network) 10.96700 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @44.99700s +00.00000s
|`->config-snap ran successfully @44.99800s +00.00000s
|`->config-ssh-import-id ran successfully @44.99900s +00.83700s
|`->config-locale ran successfully @45.83600s +00.00200s
|`->config-set-passwords ran successfully @45.83800s +00.00100s
|`->config-grub-dpkg ran successfully @45.83900s +00.97200s
|`->config-apt-pipelining ran successfully @46.81200s +00.00100s
|`->config-apt-configure ran successfully @46.81300s +00.12700s
|`->config-ubuntu-advantage ran successfully @46.94100s +00.00100s
|`->config-ntp ran successfully @46.94200s +00.00100s
|`->config-timezone ran successfully @46.94300s +00.00100s
|`->config-disable-ec2-metadata ran successfully @46.94400s +00.00100s
|`->config-runcmd ran successfully @46.94500s +00.00100s
|`->config-byobu ran successfully @46.94600s +00.00100s
Finished stage: (modules-config) 01.99800 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @47.59600s +00.00100s
|`->config-fan ran successfully @47.59700s +00.00100s
|`->config-landscape ran successfully @47.59800s +00.00100s
|`->config-lxd ran successfully @47.59900s +00.00100s
|`->config-ubuntu-drivers ran successfully @47.60100s +00.00000s
|`->config-puppet ran successfully @47.60200s +00.00000s
|`->config-chef ran successfully @47.60300s +00.00000s
|`->config-mcollective ran successfully @47.60400s +00.00000s
|`->config-salt-minion ran successfully @47.60500s +00.00000s
|`->config-rightscale_userdata ran successfully @47.60600s +00.00100s
|`->config-scripts-vendor ran successfully @47.60700s +00.00100s
|`->config-scripts-per-once ran successfully @47.60800s +00.00100s
|`->config-scripts-per-boot ran successfully @47.60900s +00.00000s
|`->config-scripts-per-instance ran successfully @47.61000s +00.00000s
|`->config-scripts-user ran successfully @47.61100s +00.00000s
|`->config-ssh-authkey-fingerprints ran successfully @47.61200s +00.05500s
|`->config-keys-to-console ran successfully @47.66700s +00.11000s
|`->config-phone-home ran successfully @47.77700s +00.00100s
|`->config-final-message ran successfully @47.77900s +00.00400s
|`->config-power-state-change ran successfully @47.78300s +00.00100s
Finished stage: (modules-final) 00.21600 seconds

Total Time: 33.11700 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- cloud-init analyze blame
-- Boot Record 01 --
     02.69800s (init-network/config-resizefs)
     02.55600s (azure-ds/_report_ready)
     02.51800s (init-network/config-disk_setup)
     00.97200s (modules-config/config-grub-dpkg)
     00.84800s (init-network/config-users-groups)
     00.83700s (modules-config/config-ssh-import-id)
     00.72300s (init-network/config-growpart)
     00.49000s (init-network/config-ssh)
     00.38900s (azure-ds/obtain-dhcp-lease)
     00.28500s (azure-ds/generate_certificate)
     00.26300s (init-network/config-mounts)
     00.13700s (azure-ds/_has_ntfs_filesystem)
     00.12700s (modules-config/config-apt-configure)
     00.11000s (modules-final/config-keys-to-console)
     00.08800s (azure-ds/_get_metadata_from_imds)
     00.06800s (azure-ds/get_boot_telemetry)
     00.05600s (azure-ds/list_possible_azure_ds_devs)
     00.05500s (modules-final/config-ssh-authkey-fingerprints)
     00.02100s (init-network/check-cache)
     00.01300s (azure-ds/_decrypt_certs_from_xml)
     00.01000s (azure-ds/write_files)
     00.00900s (azure-ds/check-platform-viability)
     00.00700s (init-network/consume-user-data)
     00.00700s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00400s (modules-final/config-final-message)
     00.00200s (modules-config/config-locale)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-migrator)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-ubuntu-drivers)
     00.00000s (modules-final/config-scripts-user)
     00.00000s (modules-final/config-scripts-per-instance)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-final/config-puppet)
     00.00000s (modules-final/config-mcollective)
     00.00000s (modules-final/config-chef)
     00.00000s (modules-config/config-snap)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-rsyslog)
     00.00000s (init-network/config-ca-certs)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Writing networking config: previous-network.out
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR PROPOSED_SCRIPT ubuntu@52.254.87.225:.
PROPOSED_SCRIPT                               100%  196     2.9KB/s   00:00    
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- sudo bash PROPOSED_SCRIPT
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu eoan-proposed/main amd64 cloud-init all 20.2-45-g5f7825e2-0ubuntu1~19.10.1 [420 kB]
Preparing to unpack .../cloud-init_20.2-45-g5f7825e2-0ubuntu1~19.10.1_all.deb ...
Unpacking cloud-init (20.2-45-g5f7825e2-0ubuntu1~19.10.1) over (19.4-33-gbb4131a2-0ubuntu1~19.10.1) ...
Setting up cloud-init (20.2-45-g5f7825e2-0ubuntu1~19.10.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- dpkg-query --show cloud-init
cloud-init	20.2-45-g5f7825e2-0ubuntu1~19.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- sudo cloud-init clean --logs --reboot
Connection to 52.254.87.225 closed by remote host.
+ true
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- cloud-init status --wait --long

status: done
time: Thu, 18 Jun 2020 18:45:55 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- ! grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- sudo systemd-analyze blame
          3.178s snapd.service
          2.743s snap.lxd.activate.service
          2.625s cloud-init.service
          2.171s lvm2-monitor.service
          2.049s dev-sda1.device
          1.943s systemd-logind.service
          1.870s systemd-networkd-wait-online.service
          1.754s cloud-config.service
          1.677s systemd-udev-settle.service
          1.640s accounts-daemon.service
          1.553s cloud-init-local.service
          1.439s rsyslog.service
          1.416s grub-common.service
          1.300s apport.service
          1.020s systemd-user-sessions.service
           971ms grub-initrd-fallback.service
           838ms networkd-dispatcher.service
           815ms cloud-final.service
           768ms atd.service
           649ms systemd-journald.service
           377ms systemd-networkd.service
           365ms ssh.service
           359ms systemd-resolved.service
           349ms chrony.service
           335ms systemd-udev-trigger.service
           334ms systemd-remount-fs.service
           329ms dev-mqueue.mount
           329ms ufw.service
           325ms keyboard-setup.service
           322ms kmod-static-nodes.service
           316ms sys-kernel-debug.mount
           304ms dev-hugepages.mount
           300ms systemd-modules-load.service
           217ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
           216ms polkit.service
           199ms apparmor.service
           194ms systemd-journal-flush.service
           161ms snapd.socket
           132ms systemd-tmpfiles-setup.service
           121ms console-setup.service
           120ms sys-kernel-config.mount
           120ms systemd-sysctl.service
           119ms sys-fs-fuse-connections.mount
           118ms plymouth-read-write.service
           116ms finalrd.service
           106ms systemd-random-seed.service
           103ms boot-efi.mount
           102ms snap-core18-1754.mount
           101ms user@1000.service
            98ms systemd-sysusers.service
            94ms snap-lxd-15457.mount
            88ms plymouth-quit-wait.service
            87ms ephemeral-disk-warning.service
            84ms setvtrgb.service
            81ms snap-snapd-7777.mount
            78ms snapd.seeded.service
            69ms plymouth-quit.service
            67ms multipathd.service
            55ms dev-loop0.device
            54ms systemd-udevd.service
            54ms dev-loop1.device
            52ms dev-loop2.device
            47ms systemd-update-utmp.service
            34ms blk-availability.service
            34ms systemd-tmpfiles-setup-dev.service
            19ms user-runtime-dir@1000.service
            16ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.04600s +00.00800s
|`->get_boot_telemetry @00.05400s +00.01600s
|`->get_system_info @00.07100s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.07100s +00.20000s
|`->load_azure_ds_dir @00.27100s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.27500s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.27600s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.29600s +00.34500s
|`->_get_metadata_from_imds @00.64100s +00.00900s
Finished stage: (azure-ds/get_metadata_from_imds) 00.37300 seconds

|`->_get_random_seed @00.67000s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.60800 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.67900s +00.00100s
|`->write_files @00.68000s +00.00200s
Finished stage: (azure-ds/_get_data) 00.63700 seconds

Finished stage: (init-local/search-Azure) 00.64000 seconds

|`->network config from imds @00.73300s +00.00100s
Finished stage: (init-local) 00.84100 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.61200s +00.03200s
|`->network config from imds @03.68500s +00.00100s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.69500s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.69900s +00.13800s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.83700s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.86000s +00.01200s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.87300s +00.00500s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01200 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.88500s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.03100 seconds

|`->_report_ready @03.89100s +00.00600s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.19800 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.19900 seconds

Finished stage: (azure-ds/_negotiate) 00.20300 seconds

Finished stage: (azure-ds/setup) 00.20400 seconds

Finished stage: (init-network/setup-datasource) 00.20400 seconds

|`->reading and applying user-data @03.90400s +00.00700s
|`->reading and applying vendor-data @03.91100s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.94600s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.94700s +00.15100s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.15300 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.15300 seconds

Finished stage: (azure-ds/activate) 00.15300 seconds

Finished stage: (init-network/activate-datasource) 00.15500 seconds

|`->config-migrator ran successfully @04.13900s +00.00100s
|`->config-seed_random ran successfully @04.14000s +00.00400s
|`->config-bootcmd ran successfully @04.14400s +00.00100s
|`->config-write-files ran successfully @04.14500s +00.00700s
|`->config-growpart ran successfully @04.15200s +00.11200s
|`->config-resizefs ran successfully @04.26500s +00.15100s
|`->config-disk_setup ran successfully @04.41700s +00.71000s
|`->config-mounts ran successfully @05.12800s +00.25000s
|`->config-set_hostname ran successfully @05.37800s +00.00700s
|`->config-update_hostname ran successfully @05.38500s +00.00200s
|`->config-update_etc_hosts ran successfully @05.38700s +00.00000s
|`->config-ca-certs ran successfully @05.38800s +00.00000s
|`->config-rsyslog ran successfully @05.38900s +00.00000s
|`->config-users-groups ran successfully @05.39000s +00.06600s
|`->config-ssh ran successfully @05.45700s +00.26400s
Finished stage: (init-network) 02.12800 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @11.11300s +00.00000s
|`->config-snap ran successfully @11.11400s +00.00000s
|`->config-ssh-import-id ran successfully @11.11500s +00.75500s
|`->config-locale ran successfully @11.87100s +00.00600s
|`->config-set-passwords ran successfully @11.87700s +00.00100s
|`->config-grub-dpkg ran successfully @11.87900s +00.30800s
|`->config-apt-pipelining ran successfully @12.18800s +00.00100s
|`->config-apt-configure ran successfully @12.18900s +00.12000s
|`->config-ubuntu-advantage ran successfully @12.31000s +00.00100s
|`->config-ntp ran successfully @12.31100s +00.00100s
|`->config-timezone ran successfully @12.31200s +00.00100s
|`->config-disable-ec2-metadata ran successfully @12.31300s +00.00100s
|`->config-runcmd ran successfully @12.31400s +00.00100s
|`->config-byobu ran successfully @12.31500s +00.00100s
Finished stage: (modules-config) 01.21900 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @12.98100s +00.00100s
|`->config-fan ran successfully @12.98200s +00.00100s
|`->config-landscape ran successfully @12.98300s +00.00100s
|`->config-lxd ran successfully @12.98400s +00.00100s
|`->config-ubuntu-drivers ran successfully @12.98500s +00.00100s
|`->config-puppet ran successfully @12.98600s +00.00100s
|`->config-chef ran successfully @12.98700s +00.00100s
|`->config-mcollective ran successfully @12.98800s +00.00100s
|`->config-salt-minion ran successfully @12.98900s +00.00100s
|`->config-rightscale_userdata ran successfully @12.99000s +00.00100s
|`->config-scripts-vendor ran successfully @12.99100s +00.00100s
|`->config-scripts-per-once ran successfully @12.99200s +00.00100s
|`->config-scripts-per-boot ran successfully @12.99300s +00.00100s
|`->config-scripts-per-instance ran successfully @12.99400s +00.00100s
|`->config-scripts-user ran successfully @12.99500s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @12.99600s +00.08600s
|`->config-keys-to-console ran successfully @13.08200s +00.11400s
|`->config-phone-home ran successfully @13.19700s +00.00100s
|`->config-final-message ran successfully @13.19900s +00.00400s
|`->config-power-state-change ran successfully @13.20300s +00.00100s
Finished stage: (modules-final) 00.23900 seconds

Total Time: 8.36800 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- cloud-init analyze blame
-- Boot Record 01 --
     00.75500s (modules-config/config-ssh-import-id)
     00.71000s (init-network/config-disk_setup)
     00.34500s (azure-ds/obtain-dhcp-lease)
     00.30800s (modules-config/config-grub-dpkg)
     00.26400s (init-network/config-ssh)
     00.25000s (init-network/config-mounts)
     00.20000s (azure-ds/list_possible_azure_ds_devs)
     00.15100s (init-network/config-resizefs)
     00.15100s (azure-ds/_has_ntfs_filesystem)
     00.13800s (azure-ds/generate_certificate)
     00.12000s (modules-config/config-apt-configure)
     00.11400s (modules-final/config-keys-to-console)
     00.11200s (init-network/config-growpart)
     00.08600s (modules-final/config-ssh-authkey-fingerprints)
     00.06600s (init-network/config-users-groups)
     00.03200s (init-network/check-cache)
     00.01600s (azure-ds/get_boot_telemetry)
     00.01200s (azure-ds/_decrypt_certs_from_xml)
     00.00900s (azure-ds/_get_metadata_from_imds)
     00.00800s (azure-ds/check-platform-viability)
     00.00700s (init-network/consume-user-data)
     00.00700s (init-network/config-write-files)
     00.00700s (init-network/config-set_hostname)
     00.00600s (modules-config/config-locale)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_report_ready)
     00.00500s (azure-ds/_run_x509_action)
     00.00400s (modules-final/config-final-message)
     00.00400s (init-network/config-seed_random)
     00.00200s (init-network/config-update_hostname)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (modules-config/config-snap)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-rsyslog)
     00.00000s (init-network/config-ca-certs)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade write network config: upgrade-network.out
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.254.87.225 -- grep DHCP /var/log/syslog
+ echo ------- Diff previous-network to post-upgrade-network ------
------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
--- previous-network.out	2020-06-18 18:44:52.444953133 +0000
+++ upgrade-network.out	2020-06-18 18:46:32.902485798 +0000
@@ -38,3 +38,9 @@
 Jun 18 18:44:07 SRU-worked-azure dhclient[496]: DHCPREQUEST for 10.0.0.5 on eth0 to 255.255.255.255 port 67 (xid=0x5d57032b)
 Jun 18 18:44:07 SRU-worked-azure dhclient[496]: DHCPACK of 10.0.0.5 from 168.63.129.16 (xid=0x2b03575d)
 Jun 18 18:44:07 SRU-worked-azure systemd-networkd[521]: eth0: DHCPv4 address 10.0.0.5/24 via 10.0.0.1
+Jun 18 18:45:50 SRU-worked-azure dhclient[518]: Internet Systems Consortium DHCP Client 4.4.1
+Jun 18 18:45:50 SRU-worked-azure dhclient[518]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0xe60a9272)
+Jun 18 18:45:50 SRU-worked-azure dhclient[518]: DHCPOFFER of 10.0.0.5 from 168.63.129.16
+Jun 18 18:45:50 SRU-worked-azure dhclient[518]: DHCPREQUEST for 10.0.0.5 on eth0 to 255.255.255.255 port 67 (xid=0x72920ae6)
+Jun 18 18:45:50 SRU-worked-azure dhclient[518]: DHCPACK of 10.0.0.5 from 168.63.129.16 (xid=0xe60a9272)
+Jun 18 18:45:50 SRU-worked-azure systemd-networkd[543]: eth0: DHCPv4 address 10.0.0.5/24 via 10.0.0.1
+ SRU_VARS=./sru-scripts/sru-vars.template
+ [ ! -f ./sru-scripts/sru-vars.template ]
+ . ./sru-scripts/sru-vars.template
+ PRESERVE_INSTANCE=false
+ UBUNTU_RELEASE=
+ LP_USER=UNSET
+ PROPOSED_SCRIPT=setup_proposed.sh
+ USE_DEV_PPA=0
+ SAMPLE_CLOUDCONFIG=sethostname.yaml
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ AZURE_REGION=UNSET
+ AZURE_VNET_NAME=UNSET
+ AZURE_NETWORK_SECURITY_GROUP=UNSET
+ AZURE_NIC_NAME=UNSET
+ AZURE_RESOURCE_GROUP=UNSET
+ AZURE_BOOT_DIAG=UNSET
+ AZURE_ADVANCED_NIC_TESTS=true
+ GCE_ZONE=UNSET
+ OPENSTACK_ADMIN_NET_ID=UNSET
+ OPENSTACK_SSH_KEY_NAME=UNSET
+ VMWARE_PASSWORD=UNSET
+ SRU_VARS_RC=.sru-vars.rc
+ [ -f .sru-vars.rc ]
+ [ -f /root/.sru-vars.rc ]
+ . /root/.sru-vars.rc
+ PRESERVE_INSTANCE=false
+ UBUNTU_RELEASE=
+ LP_USER=chad.smith
+ USE_DEV_PPA=0
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ AZURE_REGION=eastus2
+ AZURE_VNET_NAME=sruVnet
+ AZURE_NETWORK_SECURITY_GROUP=sruNetSecGroup
+ AZURE_NIC_NAME=sruNic
+ AZURE_RESOURCE_GROUP=srugroupIPV6
+ AZURE_BOOT_DIAG=storeitsru
+ AZURE_ADVANCED_NIC_TESTS=true
+ GCE_ZONE=UNSET
+ OPENSTACK_ADMIN_NET_ID=UNSET
+ OPENSTACK_SSH_KEY_NAME=UNSET
+ VMWARE_PASSWORD=UNSET
+ parse_args ./sru-scripts/manual/azure-sru focal
+ script=./sru-scripts/manual/azure-sru
+ shift
+ [ 1 = 0 ]
+ [ 1 -ne 0 ]
+ UBUNTU_RELEASE=focal
+ shift
+ [ 0 -ne 0 ]
+ [ -z focal ]
+ assert_expected_vars PROPOSED_SCRIPT AZURE_REGION AZURE_VNET_NAME AZURE_NETWORK_SECURITY_GROUP AZURE_NIC_NAME AZURE_RESOURCE_GROUP AZURE_BOOT_DIAG SSH_KEY SAMPLE_CLOUDCONFIG AZURE_ADVANCED_NIC_TESTS
+ local value=
+ eval value=$PROPOSED_SCRIPT > /dev/null
+ value=setup_proposed.sh
+ [ -z setup_proposed.sh -o setup_proposed.sh = UNSET ]
+ eval value=$AZURE_REGION > /dev/null
+ value=eastus2
+ [ -z eastus2 -o eastus2 = UNSET ]
+ eval value=$AZURE_VNET_NAME > /dev/null
+ value=sruVnet
+ [ -z sruVnet -o sruVnet = UNSET ]
+ eval value=$AZURE_NETWORK_SECURITY_GROUP > /dev/null
+ value=sruNetSecGroup
+ [ -z sruNetSecGroup -o sruNetSecGroup = UNSET ]
+ eval value=$AZURE_NIC_NAME > /dev/null
+ value=sruNic
+ [ -z sruNic -o sruNic = UNSET ]
+ eval value=$AZURE_RESOURCE_GROUP > /dev/null
+ value=srugroupIPV6
+ [ -z srugroupIPV6 -o srugroupIPV6 = UNSET ]
+ eval value=$AZURE_BOOT_DIAG > /dev/null
+ value=storeitsru
+ [ -z storeitsru -o storeitsru = UNSET ]
+ eval value=$SSH_KEY > /dev/null
+ value=/root/.ssh/id_rsa.pub
+ [ -z /root/.ssh/id_rsa.pub -o /root/.ssh/id_rsa.pub = UNSET ]
+ eval value=$SAMPLE_CLOUDCONFIG > /dev/null
+ value=sethostname.yaml
+ [ -z sethostname.yaml -o sethostname.yaml = UNSET ]
+ eval value=$AZURE_ADVANCED_NIC_TESTS > /dev/null
+ value=true
+ [ -z true -o true = UNSET ]
+ create_samplecloudconfig
+ filename=sethostname.yaml
+ cat
+ create_setup_proposed_script
+ [ 0 -eq 0 ]
+ cat
+ AZURE_VNET_NAME=sruVnet-focal
+ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
+ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ [ Registered != Registered -o Registered != Registered ]
+ az provider show -n Microsoft.Network
+ jq -r .registrationState
+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo Waiting for Microsoft.Network IPv6 feature registration
Waiting for Microsoft.Network IPv6 feature registration
+ [ Registered != Registered ]
+ echo ### BEGIN focal
### BEGIN focal
+ az group show -g srugroupIPV6
+ [ -n storeitsru ]
+ az storage account show --name storeitsru
+ AZURE_BOOT_DIAG_ARG=--boot-diagnostics-storage storeitsru
+ az network nsg show --name sruNetSecGroup -g srugroupIPV6
+ az network nsg rule show --name allowSSHIn --nsg-name sruNetSecGroup -g srugroupIPV6
+ az network nsg rule show --name allowAllOut --nsg-name sruNetSecGroup -g srugroupIPV6
+ az network vnet show --name sruVnet-focal -g srugroupIPV6
+ az network vnet create --resource-group srugroupIPV6 --location eastus2 --name sruVnet-focal --address-prefixes 10.0.0.0/16 ace:cab:deca::/48
{
  "newVNet": {
    "addressSpace": {
      "addressPrefixes": [
        "10.0.0.0/16",
        "ace:cab:deca::/48"
      ]
    },
    "ddosProtectionPlan": null,
    "dhcpOptions": {
      "dnsServers": []
    },
    "enableDdosProtection": false,
    "enableVmProtection": false,
    "etag": "W/\"ac7ca4c7-c905-4d56-9081-751583dc13e5\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet-focal",
    "location": "eastus2",
    "name": "sruVnet-focal",
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "f5a27459-e965-40c7-b86d-9c2575c21fd6",
    "subnets": [],
    "tags": {},
    "type": "Microsoft.Network/virtualNetworks",
    "virtualNetworkPeerings": []
  }
}
+ az network vnet subnet show --name sruSubnet --vnet-name sruVnet-focal -g srugroupIPV6
+ az network vnet subnet create --name sruSubnet --resource-group srugroupIPV6 --vnet-name sruVnet-focal --address-prefixes 10.0.0.0/24 ace:cab:deca:deed::/64 --network-security-group sruNetSecGroup
{
  "addressPrefix": null,
  "addressPrefixes": [
    "10.0.0.0/24",
    "ace:cab:deca:deed::/64"
  ],
  "delegations": [],
  "etag": "W/\"a2439f1e-f303-4b45-aae8-19d9ae0ce1c0\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet-focal/subnets/sruSubnet",
  "ipConfigurationProfiles": null,
  "ipConfigurations": null,
  "name": "sruSubnet",
  "natGateway": null,
  "networkSecurityGroup": {
    "defaultSecurityRules": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": null,
    "name": null,
    "networkInterfaces": null,
    "provisioningState": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": null,
    "securityRules": null,
    "subnets": null,
    "tags": null,
    "type": null
  },
  "privateEndpointNetworkPolicies": "Enabled",
  "privateEndpoints": null,
  "privateLinkServiceNetworkPolicies": "Enabled",
  "provisioningState": "Succeeded",
  "purpose": null,
  "resourceGroup": "srugroupIPV6",
  "resourceNavigationLinks": null,
  "routeTable": null,
  "serviceAssociationLinks": null,
  "serviceEndpointPolicies": null,
  "serviceEndpoints": null,
  "type": "Microsoft.Network/virtualNetworks/subnets"
}
+ sshopts=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=Canonical:0001-com-ubuntu-server-focal-daily:20_04-daily-lts
+ [  =  ]
+ echo Creating standard network vm
Creating standard network vm
+ name=test-sru-focal
+ az vm show --name test-sru-focal -g srugroupIPV6
+ az vm create --name=test-sru-focal --image=Canonical:0001-com-ubuntu-server-focal-daily:20_04-daily-lts:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-focal",
  "location": "eastus2",
  "macAddress": "00-0D-3A-00-2A-A9",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.6",
  "publicIpAddress": "52.252.115.168",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-focal
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.252.115.168
+ echo Created test-sru-focal: ubuntu@ubuntu@52.252.115.168
Created test-sru-focal: ubuntu@ubuntu@52.252.115.168
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- cloud-init status --wait --long
..........................................................................................
status: done
time: Thu, 18 Jun 2020 18:48:44 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- dpkg-query --show cloud-init
cloud-init	20.1-10-g71af48df-0ubuntu5
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- ! grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- systemd-analyze
Startup finished in 4.490s (kernel) + 59.785s (userspace) = 1min 4.275s 
graphical.target reached after 58.788s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- systemd-analyze blame
24.803s snapd.seeded.service                
10.534s cloud-init.service                  
 7.675s cloud-init-local.service            
 3.785s lvm2-monitor.service                
 3.263s dev-sda1.device                     
 2.788s systemd-udev-settle.service         
 2.732s cloud-config.service                
 2.197s accounts-daemon.service             
 1.836s pollinate.service                   
 1.268s systemd-logind.service              
 1.160s networkd-dispatcher.service         
 1.128s grub-common.service                 
 1.105s apparmor.service                    
 1.063s systemd-networkd-wait-online.service
 1.001s apport.service                      
  938ms systemd-journald.service            
  936ms snapd.service                       
  872ms cloud-final.service                 
  801ms chrony.service                      
  772ms sys-kernel-tracing.mount            
  766ms sys-kernel-debug.mount              
  753ms dev-mqueue.mount                    
  748ms dev-hugepages.mount                 
  681ms atd.service                         
  645ms systemd-resolved.service            
  642ms kmod-static-nodes.service           
  639ms keyboard-setup.service              
  622ms grub-initrd-fallback.service        
  615ms systemd-udev-trigger.service        
  568ms systemd-udevd.service               
  539ms modprobe@drm.service                
  517ms snap.lxd.activate.service           
  513ms e2scrub_reap.service                
  484ms systemd-modules-load.service        
  484ms user@1000.service                   
  464ms systemd-remount-fs.service          
  456ms rsyslog.service                     
  455ms systemd-networkd.service            
  390ms ufw.service                         
  257ms console-setup.service               
  253ms plymouth-read-write.service         
  249ms finalrd.service                     
  243ms systemd-sysusers.service            
  240ms multipathd.service                  
  238ms systemd-machine-id-commit.service   
  222ms polkit.service                      
  212ms systemd-user-sessions.service       
  201ms sys-kernel-config.mount             
  191ms systemd-journal-flush.service       
  189ms systemd-random-seed.service         
  159ms systemd-sysctl.service              
  158ms ssh.service                         
  130ms systemd-tmpfiles-setup.service      
  121ms sys-fs-fuse-connections.mount       
   99ms snapd.socket                        
   96ms plymouth-quit-wait.service          
   92ms plymouth-quit.service               
   58ms snapd.apparmor.service              
   58ms dev-loop2.device                    
   58ms systemd-tmpfiles-setup-dev.service  
   50ms dev-loop0.device                    
   47ms systemd-update-utmp-runlevel.service
   43ms snap-snapd-7777.mount               
   42ms ephemeral-disk-warning.service      
   37ms blk-availability.service            
   32ms snap-lxd-15457.mount                
   31ms systemd-update-utmp.service         
   31ms snap-core18-1754.mount              
   30ms user-runtime-dir@1000.service       
   29ms boot-efi.mount                      
   25ms setvtrgb.service                    
   22ms dev-loop1.device                    
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.29100s +00.01200s
|`->get_boot_telemetry @00.30300s +00.12600s
|`->get_system_info @00.42900s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.43000s +00.08700s
|`->load_azure_ds_dir @00.51800s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.68700s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.68800s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.01300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01800 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.72100s +00.47100s
|`->_get_metadata_from_imds @01.19200s +00.01600s
Finished stage: (azure-ds/get_metadata_from_imds) 00.51600 seconds

|`->_get_random_seed @01.23800s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.82200 seconds

|`->maybe_remove_ubuntu_network_config_scripts @01.25200s +00.00100s
|`->write_files @01.25400s +00.00800s
Finished stage: (azure-ds/_get_data) 00.97100 seconds

Finished stage: (init-local/search-Azure) 00.97500 seconds

|`->network config from imds @01.32600s +00.00000s
Finished stage: (init-local) 01.87400 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.91900s +00.03600s
|`->network config from imds @04.01000s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @04.01900s +00.00100s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @04.02400s +00.14600s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @04.17000s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @04.20200s +00.01400s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @04.21700s +00.00700s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.08200 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @04.30000s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.10400 seconds

|`->_report_ready @04.30700s +02.96700s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.25000 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.25100 seconds

Finished stage: (azure-ds/_negotiate) 03.25600 seconds

Finished stage: (azure-ds/setup) 03.25600 seconds

Finished stage: (init-network/setup-datasource) 03.25700 seconds

|`->reading and applying user-data @07.28800s +00.00700s
|`->reading and applying vendor-data @07.29500s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @07.33000s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @07.33000s +00.15800s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.60400s +00.00000s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.13300 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.29200 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.29200 seconds

Finished stage: (azure-ds/activate) 00.29200 seconds

Finished stage: (init-network/activate-datasource) 00.29400 seconds

|`->config-migrator ran successfully @07.73000s +00.00000s
|`->config-seed_random ran successfully @07.73100s +00.00100s
|`->config-bootcmd ran successfully @07.73200s +00.00100s
|`->config-write-files ran successfully @07.73300s +00.00100s
|`->config-growpart ran successfully @07.73400s +00.78700s
|`->config-resizefs ran successfully @08.52200s +01.39100s
|`->config-disk_setup ran successfully @09.91300s +02.59400s
|`->config-mounts ran successfully @12.51000s +00.33200s
|`->config-set_hostname ran successfully @12.84200s +00.00900s
|`->config-update_hostname ran successfully @12.85100s +00.00200s
|`->config-update_etc_hosts ran successfully @12.85300s +00.00100s
|`->config-ca-certs ran successfully @12.85400s +00.00100s
|`->config-rsyslog ran successfully @12.85500s +00.00100s
|`->config-users-groups ran successfully @12.85600s +00.24900s
|`->config-ssh ran successfully @13.10600s +00.78900s
Finished stage: (init-network) 09.99300 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @42.29700s +00.00100s
|`->config-snap ran successfully @42.29900s +00.00100s
|`->config-ssh-import-id ran successfully @42.30100s +01.05100s
|`->config-locale ran successfully @43.35300s +00.00100s
|`->config-set-passwords ran successfully @43.35400s +00.00200s
|`->config-grub-dpkg ran successfully @43.35600s +00.86000s
|`->config-apt-pipelining ran successfully @44.21700s +00.00100s
|`->config-apt-configure ran successfully @44.21800s +00.17900s
|`->config-ubuntu-advantage ran successfully @44.39800s +00.00100s
|`->config-ntp ran successfully @44.39900s +00.00200s
|`->config-timezone ran successfully @44.40100s +00.00100s
|`->config-disable-ec2-metadata ran successfully @44.40200s +00.00000s
|`->config-runcmd ran successfully @44.40300s +00.00000s
|`->config-byobu ran successfully @44.40400s +00.00000s
Finished stage: (modules-config) 02.17600 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @45.13100s +00.00100s
|`->config-fan ran successfully @45.13300s +00.00100s
|`->config-landscape ran successfully @45.13400s +00.00100s
|`->config-lxd ran successfully @45.13500s +00.00100s
|`->config-ubuntu-drivers ran successfully @45.13600s +00.00100s
|`->config-puppet ran successfully @45.13700s +00.00100s
|`->config-chef ran successfully @45.13800s +00.00100s
|`->config-mcollective ran successfully @45.13900s +00.00100s
|`->config-salt-minion ran successfully @45.14000s +00.00100s
|`->config-rightscale_userdata ran successfully @45.14100s +00.00100s
|`->config-scripts-vendor ran successfully @45.14200s +00.00100s
|`->config-scripts-per-once ran successfully @45.14300s +00.00100s
|`->config-scripts-per-boot ran successfully @45.14400s +00.00000s
|`->config-scripts-per-instance ran successfully @45.14500s +00.00000s
|`->config-scripts-user ran successfully @45.14600s +00.00000s
|`->config-ssh-authkey-fingerprints ran successfully @45.14700s +00.00900s
|`->config-keys-to-console ran successfully @45.15700s +00.15000s
|`->config-phone-home ran successfully @45.36000s +00.00100s
|`->config-final-message ran successfully @45.36200s +00.00400s
|`->config-power-state-change ran successfully @45.36600s +00.00100s
Finished stage: (modules-final) 00.27600 seconds

Total Time: 35.40500 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- cloud-init analyze blame
-- Boot Record 01 --
     02.96700s (azure-ds/_report_ready)
     02.59400s (init-network/config-disk_setup)
     01.39100s (init-network/config-resizefs)
     01.05100s (modules-config/config-ssh-import-id)
     00.86000s (modules-config/config-grub-dpkg)
     00.78900s (init-network/config-ssh)
     00.78700s (init-network/config-growpart)
     00.47100s (azure-ds/obtain-dhcp-lease)
     00.33200s (init-network/config-mounts)
     00.24900s (init-network/config-users-groups)
     00.17900s (modules-config/config-apt-configure)
     00.15800s (azure-ds/_has_ntfs_filesystem)
     00.15000s (modules-final/config-keys-to-console)
     00.14600s (azure-ds/generate_certificate)
     00.12600s (azure-ds/get_boot_telemetry)
     00.08700s (azure-ds/list_possible_azure_ds_devs)
     00.03600s (init-network/check-cache)
     00.01600s (azure-ds/_get_metadata_from_imds)
     00.01400s (azure-ds/_decrypt_certs_from_xml)
     00.01200s (azure-ds/check-platform-viability)
     00.00900s (modules-final/config-ssh-authkey-fingerprints)
     00.00900s (init-network/config-set_hostname)
     00.00800s (azure-ds/write_files)
     00.00700s (init-network/consume-user-data)
     00.00700s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00400s (modules-final/config-final-message)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-ntp)
     00.00200s (init-network/config-update_hostname)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-locale)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/temporary_hostname)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (modules-final/config-scripts-user)
     00.00000s (modules-final/config-scripts-per-instance)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-runcmd)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (modules-config/config-byobu)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-migrator)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/count_files)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Writing networking config: previous-network.out
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR PROPOSED_SCRIPT ubuntu@52.252.115.168:.
PROPOSED_SCRIPT                               100%  196     3.3KB/s   00:00    
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- sudo bash PROPOSED_SCRIPT
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu focal-proposed/main amd64 cloud-init all 20.2-45-g5f7825e2-0ubuntu1~20.04.1 [416 kB]
Preparing to unpack .../cloud-init_20.2-45-g5f7825e2-0ubuntu1~20.04.1_all.deb ...
Unpacking cloud-init (20.2-45-g5f7825e2-0ubuntu1~20.04.1) over (20.1-10-g71af48df-0ubuntu5) ...
Setting up cloud-init (20.2-45-g5f7825e2-0ubuntu1~20.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- dpkg-query --show cloud-init
cloud-init	20.2-45-g5f7825e2-0ubuntu1~20.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- sudo cloud-init clean --logs --reboot
Connection to 52.252.115.168 closed by remote host.
+ true
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- cloud-init status --wait --long

status: done
time: Thu, 18 Jun 2020 18:50:11 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- ! grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- sudo systemd-analyze blame
3.710s cloud-config.service                                       
3.464s snapd.service                                              
3.114s snap.lxd.activate.service                                  
2.963s accounts-daemon.service                                    
2.857s cloud-init.service                                         
2.726s lvm2-monitor.service                                       
2.358s dev-sdb1.device                                            
2.031s cloud-init-local.service                                   
1.900s networkd-dispatcher.service                                
1.889s apport.service                                             
1.810s systemd-logind.service                                     
1.753s systemd-networkd-wait-online.service                       
1.738s grub-common.service                                        
1.713s systemd-udev-settle.service                                
1.096s systemd-journald.service                                   
1.030s chrony.service                                             
 942ms grub-initrd-fallback.service                               
 848ms cloud-final.service                                        
 748ms systemd-udev-trigger.service                               
 666ms atd.service                                                
 657ms sys-kernel-debug.mount                                     
 657ms sys-kernel-tracing.mount                                   
 637ms keyboard-setup.service                                     
 623ms kmod-static-nodes.service                                  
 610ms dev-mqueue.mount                                           
 567ms systemd-resolved.service                                   
 563ms ssh.service                                                
 563ms e2scrub_reap.service                                       
 552ms dev-hugepages.mount                                        
 542ms rsyslog.service                                            
 535ms modprobe@drm.service                                       
 478ms systemd-modules-load.service                               
 467ms systemd-remount-fs.service                                 
 396ms ufw.service                                                
 356ms systemd-networkd.service                                   
 314ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
 253ms sys-fs-fuse-connections.mount                              
 243ms plymouth-quit-wait.service                                 
 235ms apparmor.service                                           
 231ms console-setup.service                                      
 227ms snapd.apparmor.service                                     
 221ms plymouth-quit.service                                      
 211ms sys-kernel-config.mount                                    
 184ms systemd-user-sessions.service                              
 158ms systemd-random-seed.service                                
 145ms systemd-sysctl.service                                     
 141ms user@1000.service                                          
 138ms finalrd.service                                            
 137ms setvtrgb.service                                           
 135ms systemd-sysusers.service                                   
 133ms plymouth-read-write.service                                
 131ms snap-core18-1754.mount                                     
 126ms snapd.seeded.service                                       
 121ms snap-lxd-15457.mount                                       
 118ms systemd-tmpfiles-setup.service                             
 118ms polkit.service                                             
 117ms boot-efi.mount                                             
 112ms snap-snapd-7777.mount                                      
  86ms systemd-journal-flush.service                              
  85ms multipathd.service                                         
  67ms dev-loop0.device                                           
  67ms dev-loop1.device                                           
  67ms dev-loop2.device                                           
  66ms systemd-update-utmp.service                                
  62ms snapd.socket                                               
  61ms systemd-tmpfiles-setup-dev.service                         
  51ms systemd-update-utmp-runlevel.service                       
  45ms systemd-udevd.service                                      
  32ms blk-availability.service                                   
  20ms user-runtime-dir@1000.service                              
  18ms ephemeral-disk-warning.service                             
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.10700s +00.01200s
|`->get_boot_telemetry @00.11900s +00.01800s
|`->get_system_info @00.13700s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.13700s +00.21100s
|`->load_azure_ds_dir @00.34800s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.35300s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.35400s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00500 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.37600s +00.37900s
|`->_get_metadata_from_imds @00.75600s +00.00800s
Finished stage: (azure-ds/get_metadata_from_imds) 00.41100 seconds

|`->_get_random_seed @00.78800s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.66400 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.80100s +00.00000s
|`->write_files @00.80200s +00.00200s
Finished stage: (azure-ds/_get_data) 00.69700 seconds

Finished stage: (init-local/search-Azure) 00.70000 seconds

|`->network config from imds @00.85900s +00.00100s
Finished stage: (init-local) 01.06800 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.78500s +00.02000s
|`->network config from imds @03.84800s +00.00100s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.85800s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.86200s +00.02600s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.88800s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.90500s +00.01300s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.91900s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.03800 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.95600s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.05700 seconds

|`->_report_ready @03.96200s +00.00600s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.10800 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.10800 seconds

Finished stage: (azure-ds/_negotiate) 00.11300 seconds

Finished stage: (azure-ds/setup) 00.11300 seconds

Finished stage: (init-network/setup-datasource) 00.11300 seconds

|`->reading and applying user-data @03.97700s +00.00700s
|`->reading and applying vendor-data @03.98400s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @04.01900s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @04.02000s +00.13500s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.13600 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.13600 seconds

Finished stage: (azure-ds/activate) 00.13700 seconds

Finished stage: (init-network/activate-datasource) 00.13900 seconds

|`->config-migrator ran successfully @04.20200s +00.00000s
|`->config-seed_random ran successfully @04.20300s +00.00100s
|`->config-bootcmd ran successfully @04.20400s +00.00300s
|`->config-write-files ran successfully @04.20700s +00.00100s
|`->config-growpart ran successfully @04.20800s +00.12200s
|`->config-resizefs ran successfully @04.33100s +00.37400s
|`->config-disk_setup ran successfully @04.70500s +00.75700s
|`->config-mounts ran successfully @05.46300s +00.31900s
|`->config-set_hostname ran successfully @05.78300s +00.00700s
|`->config-update_hostname ran successfully @05.79000s +00.00100s
|`->config-update_etc_hosts ran successfully @05.79200s +00.00000s
|`->config-ca-certs ran successfully @05.79300s +00.00000s
|`->config-rsyslog ran successfully @05.79400s +00.00100s
|`->config-users-groups ran successfully @05.79500s +00.05800s
|`->config-ssh ran successfully @05.85400s +00.20800s
Finished stage: (init-network) 02.30300 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @11.92700s +00.01000s
|`->config-snap ran successfully @11.93800s +00.00500s
|`->config-ssh-import-id ran successfully @11.94300s +01.62000s
|`->config-locale ran successfully @13.56300s +00.02700s
|`->config-set-passwords ran successfully @13.59000s +00.00100s
|`->config-grub-dpkg ran successfully @13.59200s +00.70600s
|`->config-apt-pipelining ran successfully @14.29900s +00.00100s
|`->config-apt-configure ran successfully @14.30000s +00.15100s
|`->config-ubuntu-advantage ran successfully @14.45200s +00.00000s
|`->config-ntp ran successfully @14.45500s +00.00100s
|`->config-timezone ran successfully @14.45600s +00.00100s
|`->config-disable-ec2-metadata ran successfully @14.45700s +00.00100s
|`->config-runcmd ran successfully @14.45800s +00.00100s
|`->config-byobu ran successfully @14.45900s +00.00100s
Finished stage: (modules-config) 02.64800 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @15.16600s +00.00000s
|`->config-fan ran successfully @15.16700s +00.00100s
|`->config-landscape ran successfully @15.16800s +00.00100s
|`->config-lxd ran successfully @15.16900s +00.00100s
|`->config-ubuntu-drivers ran successfully @15.17000s +00.00100s
|`->config-puppet ran successfully @15.17100s +00.00100s
|`->config-chef ran successfully @15.17200s +00.00100s
|`->config-mcollective ran successfully @15.17400s +00.00000s
|`->config-salt-minion ran successfully @15.17500s +00.00000s
|`->config-rightscale_userdata ran successfully @15.17600s +00.00100s
|`->config-scripts-vendor ran successfully @15.17700s +00.00000s
|`->config-scripts-per-once ran successfully @15.17800s +00.00100s
|`->config-scripts-per-boot ran successfully @15.17900s +00.00000s
|`->config-scripts-per-instance ran successfully @15.18000s +00.00100s
|`->config-scripts-user ran successfully @15.18100s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @15.18200s +00.10200s
|`->config-keys-to-console ran successfully @15.28500s +00.05600s
|`->config-phone-home ran successfully @15.34200s +00.00100s
|`->config-final-message ran successfully @15.34300s +00.00400s
|`->config-power-state-change ran successfully @15.34800s +00.00100s
Finished stage: (modules-final) 00.20000 seconds

Total Time: 9.90800 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- cloud-init analyze blame
-- Boot Record 01 --
     01.62000s (modules-config/config-ssh-import-id)
     00.75700s (init-network/config-disk_setup)
     00.70600s (modules-config/config-grub-dpkg)
     00.37900s (azure-ds/obtain-dhcp-lease)
     00.37400s (init-network/config-resizefs)
     00.31900s (init-network/config-mounts)
     00.21100s (azure-ds/list_possible_azure_ds_devs)
     00.20800s (init-network/config-ssh)
     00.15100s (modules-config/config-apt-configure)
     00.13500s (azure-ds/_has_ntfs_filesystem)
     00.12200s (init-network/config-growpart)
     00.10200s (modules-final/config-ssh-authkey-fingerprints)
     00.05800s (init-network/config-users-groups)
     00.05600s (modules-final/config-keys-to-console)
     00.02700s (modules-config/config-locale)
     00.02600s (azure-ds/generate_certificate)
     00.02000s (init-network/check-cache)
     00.01800s (azure-ds/get_boot_telemetry)
     00.01300s (azure-ds/_decrypt_certs_from_xml)
     00.01200s (azure-ds/check-platform-viability)
     00.01000s (modules-config/config-emit_upstart)
     00.00800s (azure-ds/_get_metadata_from_imds)
     00.00700s (init-network/consume-user-data)
     00.00700s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_report_ready)
     00.00500s (modules-config/config-snap)
     00.00400s (modules-final/config-final-message)
     00.00300s (init-network/config-bootcmd)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (modules-final/config-scripts-vendor)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-final/config-package-update-upgrade-install)
     00.00000s (modules-final/config-mcollective)
     00.00000s (modules-config/config-ubuntu-advantage)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-migrator)
     00.00000s (init-network/config-ca-certs)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade write network config: upgrade-network.out
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.252.115.168 -- grep DHCP /var/log/syslog
+ echo ------- Diff previous-network to post-upgrade-network ------
------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
--- previous-network.out	2020-06-18 18:48:58.904705001 +0000
+++ upgrade-network.out	2020-06-18 18:50:49.518381051 +0000
@@ -38,3 +38,9 @@
 Jun 18 18:48:14 SRU-worked-azure dhclient[503]: DHCPREQUEST for 10.0.0.6 on eth0 to 255.255.255.255 port 67 (xid=0x282147ed)
 Jun 18 18:48:14 SRU-worked-azure dhclient[503]: DHCPACK of 10.0.0.6 from 168.63.129.16 (xid=0xed472128)
 Jun 18 18:48:14 SRU-worked-azure systemd-networkd[531]: eth0: DHCPv4 address 10.0.0.6/24 via 10.0.0.1
+Jun 18 18:50:03 SRU-worked-azure dhclient[528]: Internet Systems Consortium DHCP Client 4.4.1
+Jun 18 18:50:03 SRU-worked-azure dhclient[528]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0xc711112b)
+Jun 18 18:50:03 SRU-worked-azure dhclient[528]: DHCPOFFER of 10.0.0.6 from 168.63.129.16
+Jun 18 18:50:03 SRU-worked-azure dhclient[528]: DHCPREQUEST for 10.0.0.6 on eth0 to 255.255.255.255 port 67 (xid=0x2b1111c7)
+Jun 18 18:50:03 SRU-worked-azure dhclient[528]: DHCPACK of 10.0.0.6 from 168.63.129.16 (xid=0xc711112b)
+Jun 18 18:50:03 SRU-worked-azure systemd-networkd[556]: eth0: DHCPv4 address 10.0.0.6/24 via 10.0.0.1
=== END verification output ===

