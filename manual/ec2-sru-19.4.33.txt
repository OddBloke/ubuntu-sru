#!/bin/sh

set -e

SRU_SERIES="xenial bionic disco eoan"

# local values
LP_USER=${LP_USER:-"daniel-thewatkins"}

# Provide USE_DEV_PPA=1 if we are SRU queue is still unapproved
# This will use our ppa:cloud-init-dev/proposed
if [ "${USE_DEV_PPA:-0}" -eq "0" ]; then
    PROPOSED_SCRIPT=setup_proposed.sh
else
    PROPOSED_SCRIPT=setup_dev_proposed.sh
fi


# Manual EC2 upgrade and clean install validation
cat > sethostname.yaml <<EOF
## template: jinja
#cloud-config
ssh_import_id: [$LP_USER]
hostname: SRU-worked-{{v1.cloud_name}}
EOF

cat > setup_proposed.sh <<EOF
#/bin/bash
mirror=http://archive.ubuntu.com/ubuntu
echo deb \$mirror \$(lsb_release -sc)-proposed main | tee /etc/apt/sources.list.d/proposed.list
apt-get update -q;
apt-get install -qy cloud-init;
EOF

cat > setup_dev_proposed.sh <<EOF
#/bin/bash
add-apt-repository ppa:cloud-init-dev/proposed -y
apt-get update -q;
apt-get install -qy cloud-init;
EOF

# set -x outputs each commant to standard error, so an easy way to keen an eye
# what's going on while saving a clean log file (stdout only) is using tee(1).
set -x

sshopts="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"

for series in $SRU_SERIES; do
    echo "### BEGIN $series"
    EC2_INST=`launch-ec2 --series $series -u sethostname.yaml | awk '/Found/{print $5}'`
    sleep 60
    ssh $sshopts $EC2_INST -- cloud-init status --wait --long
    ssh $sshopts $EC2_INST -- cat /run/cloud-init/result.json
    ssh $sshopts $EC2_INST -- ! grep Trace "/var/log/cloud-init.*"
    echo "Expect IMDSv2 token headers are being used on all metadata gets. Expect 0 line count"
    ssh $sshopts $EC2_INST --  '[[ 0 = `grep headers /var/log/cloud-init.log  | grep -c -v X-aws` ]] || exit 1'
    ssh $sshopts $EC2_INST -- sudo systemd-analyze
    ssh $sshopts $EC2_INST -- sudo systemd-analyze blame
    ssh $sshopts $EC2_INST -- sudo cloud-init analyze show
    ssh $sshopts $EC2_INST -- ! sudo grep Trace "/var/log/cloud-init*"
    scp $sshopts $PROPOSED_SCRIPT $EC2_INST:
    ssh $sshopts $EC2_INST sudo bash $PROPOSED_SCRIPT 2>&1 | egrep 'cloud-init'
    ssh $sshopts $EC2_INST sudo hostname something-else
    ssh $sshopts $EC2_INST -- sudo cloud-init init
    ssh $sshopts $EC2_INST -- ! grep Trace "/var/log/cloud-init*"
    ssh $sshopts $EC2_INST -- sudo cloud-init clean --logs --reboot || true
    sleep 60
    date --utc +%s.%N
    ssh $sshopts $EC2_INST -- cloud-init status --wait --long; date --utc +%s.%N
    ssh $sshopts $EC2_INST -- hostname
    ssh $sshopts $EC2_INST -- ! grep Trace "/var/log/cloud-init*"
    ssh $sshopts $EC2_INST -- sudo systemd-analyze
    ssh $sshopts $EC2_INST -- sudo cloud-init analyze show
    if [ "$series" = "xenial" ]; then
       echo "--- Expect warning on xenial for jinja because deb DOES NOT have jinja dep."
    else
       echo "--- Expect success on bionic for jinja because deb DOES have jinja dep."
    fi
    ssh $sshopts $EC2_INST "cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'"
    
    echo 'Per LP:1794399 expect we do not see a lot of killing dhclient logs'
    ssh $sshopts $EC2_INST "grep dhclient /var/log/cloud-init.log"

    echo 'Get cloud-id'
    ssh $sshopts $EC2_INST cloud-id

    echo 'Validating whether metadata is being updated per boot LP:1819913'
    ssh $sshopts $EC2_INST "grep 'Update datasource' /var/log/cloud-init.log"
    ssh $sshopts $EC2_INST sudo reboot || true
    sleep 60
    echo 'After reboot'
    ssh $sshopts $EC2_INST "grep 'Update datasource' /var/log/cloud-init.log"
    echo "### END $series"
done

# Verification Log

+ sshopts='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR'
+ for series in $SRU_SERIES
+ echo '### BEGIN xenial'
### BEGIN xenial
++ launch-ec2 --series xenial -u sethostname.yaml
++ awk '/Found/{print $5}'
ubuntu-distro-info: Header `version,codename,series,created,release,eol,eol-server,eol-esm' in file `/usr/share/distro-info/ubuntu.csv' does not match excatly `version,codename,series,created,release,eol,eol-server'.
ubuntu-distro-info: Header `version,codename,series,created,release,eol,eol-server,eol-esm' in file `/usr/share/distro-info/ubuntu.csv' does not match excatly `version,codename,series,created,release,eol,eol-server'.
+ EC2_INST=ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- cloud-init status --wait --long

status: done
time: Tue, 21 Jan 2020 21:06:52 +0000
detail:
DataSourceEc2Local
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceEc2Local",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- '!' grep Trace '/var/log/cloud-init.*'
+ echo 'Expect IMDSv2 token headers are being used on all metadata gets. Expect 0 line count'
Expect IMDSv2 token headers are being used on all metadata gets. Expect 0 line count
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- '[[ 0 = `grep headers /var/log/cloud-init.log  | grep -c -v X-aws` ]] || exit 1'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- sudo systemd-analyze
sudo: unable to resolve host SRU-worked-aws
Startup finished in 4.441s (kernel) + 37.293s (userspace) = 41.735s
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- sudo systemd-analyze blame
sudo: unable to resolve host SRU-worked-aws
         23.789s snapd.seeded.service
          4.568s cloud-init-local.service
          4.014s console-setup.service
          2.979s cloud-config.service
          2.800s apparmor.service
          2.396s dev-xvda1.device
          2.122s lxd-containers.service
          1.921s pollinate.service
          1.155s cloud-init.service
           965ms accounts-daemon.service
           960ms snapd.service
           648ms systemd-journald.service
           633ms grub-common.service
           614ms lvm2-monitor.service
           612ms iscsid.service
           564ms cloud-final.service
           549ms rsyslog.service
           536ms mdadm.service
           365ms systemd-logind.service
           333ms kmod-static-nodes.service
           311ms systemd-modules-load.service
           250ms irqbalance.service
           249ms ufw.service
           245ms apport.service
           245ms dev-hugepages.mount
           220ms sys-kernel-debug.mount
           203ms resolvconf.service
           199ms ssh.service
           176ms systemd-random-seed.service
           170ms keyboard-setup.service
           159ms systemd-tmpfiles-setup-dev.service
           154ms polkitd.service
           153ms dev-mqueue.mount
           152ms networking.service
           120ms snapd.socket
           112ms systemd-remount-fs.service
            95ms systemd-udev-trigger.service
            76ms ondemand.service
            72ms open-iscsi.service
            65ms systemd-machine-id-commit.service
            64ms setvtrgb.service
            58ms plymouth-quit-wait.service
            55ms systemd-udevd.service
            53ms plymouth-quit.service
            48ms plymouth-read-write.service
            43ms lxd.socket
            37ms systemd-user-sessions.service
            33ms systemd-timesyncd.service
            32ms systemd-sysctl.service
            31ms rc-local.service
            27ms snap-core-8268.mount
            25ms systemd-update-utmp.service
            21ms snap-amazon\x2dssm\x2dagent-1480.mount
            20ms user@1000.service
            17ms systemd-tmpfiles-setup.service
            14ms systemd-journal-flush.service
            13ms systemd-update-utmp-runlevel.service
            13ms sys-fs-fuse-connections.mount
             2ms dev-loop1.device
           721us dev-loop0.device
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- sudo cloud-init analyze show
sudo: unable to resolve host SRU-worked-aws
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.02200s +00.00000s
|`->no local data found from DataSourceNoCloud @00.17200s +00.21400s
|`->no local data found from DataSourceConfigDrive @00.38600s +00.21700s
|`->no local data found from DataSourceOpenNebula @00.60300s +00.14700s
|`->no local data found from DataSourceDigitalOcean @00.75000s +00.02400s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->Non-Azure DMI asset tag '' discovered. @00.77500s +00.02300s
Finished stage: (azure-ds/_get_data) 00.02300 seconds

Finished stage: (init-local/search-Azure) 00.02400 seconds

|`->no local data found from DataSourceOVF @00.79800s +00.07600s
|`->no local data found from DataSourceOpenStackLocal @00.87400s +00.05400s
|`->no local data found from DataSourceCloudSigma @00.92800s +00.02200s
|`->no local data found from DataSourceSmartOS @00.95000s +00.02000s
|`->no local data found from DataSourceScaleway @00.97000s +00.02000s
|`->found local data from DataSourceEc2Local @00.99000s +01.43300s
Finished stage: (init-local) 02.69200 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceEc2Local @03.25400s +00.00400s
|`->setting up datasource @03.32500s +00.00000s
|`->reading and applying user-data @03.33300s +00.00900s
|`->reading and applying vendor-data @03.34200s +00.00000s
|`->activating datasource @03.37300s +00.00100s
|`->config-migrator ran successfully @03.39200s +00.00100s
|`->config-seed_random ran successfully @03.39300s +00.00100s
|`->config-bootcmd ran successfully @03.39400s +00.00000s
|`->config-write-files ran successfully @03.39500s +00.00000s
|`->config-growpart ran successfully @03.39600s +00.04400s
|`->config-resizefs ran successfully @03.44100s +00.01500s
|`->config-disk_setup ran successfully @03.45700s +00.00100s
|`->config-mounts ran successfully @03.45800s +00.00200s
|`->config-set_hostname ran successfully @03.46000s +00.00500s
|`->config-update_hostname ran successfully @03.46500s +00.00200s
|`->config-update_etc_hosts ran successfully @03.46700s +00.00000s
|`->config-ca-certs ran successfully @03.46700s +00.00100s
|`->config-rsyslog ran successfully @03.46900s +00.00000s
|`->config-users-groups ran successfully @03.47000s +00.21200s
|`->config-ssh ran successfully @03.68200s +00.31200s
Finished stage: (init-network) 00.75300 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @31.87800s +00.00000s
|`->config-snap ran successfully @31.87800s +00.00100s
|`->config-snap_config ran successfully @31.87900s +00.00100s
|`->config-ssh-import-id ran successfully @31.88000s +01.06800s
|`->config-locale ran successfully @32.95500s +00.78900s
|`->config-set-passwords ran successfully @33.74500s +00.00100s
|`->config-grub-dpkg ran successfully @33.74600s +00.14400s
|`->config-apt-pipelining ran successfully @33.89100s +00.00100s
|`->config-apt-configure ran successfully @33.89200s +00.11300s
|`->config-ubuntu-advantage ran successfully @34.00600s +00.00000s
|`->config-ntp ran successfully @34.00700s +00.00000s
|`->config-timezone ran successfully @34.00800s +00.00000s
|`->config-disable-ec2-metadata ran successfully @34.00900s +00.00000s
|`->config-runcmd ran successfully @34.00900s +00.00100s
|`->config-byobu ran successfully @34.01000s +00.00100s
Finished stage: (modules-config) 02.19800 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @34.41300s +00.00200s
|`->config-package-update-upgrade-install ran successfully @34.41500s +00.00100s
|`->config-fan ran successfully @34.41600s +00.00100s
|`->config-landscape ran successfully @34.41700s +00.00100s
|`->config-lxd ran successfully @34.41800s +00.00100s
|`->config-ubuntu-drivers ran successfully @34.41900s +00.00100s
|`->config-puppet ran successfully @34.42000s +00.00100s
|`->config-chef ran successfully @34.42100s +00.00100s
|`->config-mcollective ran successfully @34.42200s +00.00100s
|`->config-salt-minion ran successfully @34.42300s +00.00100s
|`->config-rightscale_userdata ran successfully @34.42400s +00.00100s
|`->config-scripts-vendor ran successfully @34.42500s +00.00100s
|`->config-scripts-per-once ran successfully @34.42600s +00.00100s
|`->config-scripts-per-boot ran successfully @34.42700s +00.00000s
|`->config-scripts-per-instance ran successfully @34.42700s +00.00100s
|`->config-scripts-user ran successfully @34.42800s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @34.42900s +00.06000s
|`->config-keys-to-console ran successfully @34.49000s +00.06800s
|`->config-phone-home ran successfully @34.55900s +00.00100s
|`->config-final-message ran successfully @34.56000s +00.00600s
|`->config-power-state-change ran successfully @34.56600s +00.00100s
Finished stage: (modules-final) 00.17200 seconds

Total Time: 5.86200 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- '!' sudo grep Trace '/var/log/cloud-init*'
sudo: unable to resolve host SRU-worked-aws
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com:
setup_proposed.sh                                                                                                                            100%  196     4.3KB/s   00:00    
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com sudo bash setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu xenial-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~16.04.1 [413 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~16.04.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~16.04.1) over (19.3-41-gc4735dd3-0ubuntu1~16.04.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~16.04.1) ...
Leaving 'diversion of /etc/init/ureadahead.conf to /etc/init/ureadahead.conf.disabled by cloud-init'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com sudo hostname something-else
sudo: unable to resolve host SRU-worked-aws
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- sudo cloud-init init
sudo: unable to resolve host something-else
Cloud-init v. 19.4-33-gbb4131a2-0ubuntu1~16.04.1 running 'init' at Tue, 21 Jan 2020 21:07:40 +0000. Up 89.26 seconds.
ci-info: ++++++++++++++++++++++++++++++++++++++Net device info+++++++++++++++++++++++++++++++++++++++
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: | Device |  Up  |           Address           |      Mask     | Scope  |     Hw-Address    |
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: |  eth0  | True |         10.41.41.97         | 255.255.255.0 | global | 06:62:3b:45:ca:e2 |
ci-info: |  eth0  | True | fe80::462:3bff:fe45:cae2/64 |       .       |  link  | 06:62:3b:45:ca:e2 |
ci-info: |   lo   | True |          127.0.0.1          |   255.0.0.0   |  host  |         .         |
ci-info: |   lo   | True |           ::1/128           |       .       |  host  |         .         |
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: ++++++++++++++++++++++++++++Route IPv4 info+++++++++++++++++++++++++++++
ci-info: +-------+-------------+------------+---------------+-----------+-------+
ci-info: | Route | Destination |  Gateway   |    Genmask    | Interface | Flags |
ci-info: +-------+-------------+------------+---------------+-----------+-------+
ci-info: |   0   |   0.0.0.0   | 10.41.41.1 |    0.0.0.0    |    eth0   |   UG  |
ci-info: |   1   |  10.41.41.0 |  0.0.0.0   | 255.255.255.0 |    eth0   |   U   |
ci-info: +-------+-------------+------------+---------------+-----------+-------+
ci-info: +++++++++++++++++++Route IPv6 info+++++++++++++++++++
ci-info: +-------+-------------+---------+-----------+-------+
ci-info: | Route | Destination | Gateway | Interface | Flags |
ci-info: +-------+-------------+---------+-----------+-------+
ci-info: |   0   |  fe80::/64  |    ::   |    eth0   |   U   |
ci-info: |   4   |   ff00::/8  |    ::   |    eth0   |   U   |
ci-info: +-------+-------------+---------+-----------+-------+
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- '!' grep Trace '/var/log/cloud-init*'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- sudo cloud-init clean --logs --reboot
sudo: unable to resolve host something-else
Connection to ec2-18-216-155-114.us-east-2.compute.amazonaws.com closed by remote host.
+ true
+ sleep 60
+ date --utc +%s.%N
1579640922.813021327
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- cloud-init status --wait --long

status: done
time: Tue, 21 Jan 2020 21:08:24 +0000
detail:
DataSourceEc2Local
+ date --utc +%s.%N
1579640923.960328607
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- hostname
SRU-worked-aws
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- '!' grep Trace '/var/log/cloud-init*'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- sudo systemd-analyze
sudo: unable to resolve host SRU-worked-aws
Startup finished in 4.070s (kernel) + 10.078s (userspace) = 14.148s
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com -- sudo cloud-init analyze show
sudo: unable to resolve host SRU-worked-aws
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00800s +00.00100s
|`->no local data found from DataSourceNoCloud @00.15800s +00.20600s
|`->no local data found from DataSourceConfigDrive @00.36400s +00.22400s
|`->no local data found from DataSourceOpenNebula @00.58800s +00.14000s
|`->no local data found from DataSourceDigitalOcean @00.72900s +00.02400s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->Non-Azure DMI asset tag '' discovered. @00.75300s +00.01900s
Finished stage: (azure-ds/_get_data) 00.02000 seconds

Finished stage: (init-local/search-Azure) 00.02000 seconds

|`->no local data found from DataSourceOVF @00.77300s +00.06100s
|`->no local data found from DataSourceOpenStackLocal @00.83400s +00.04800s
|`->no local data found from DataSourceCloudSigma @00.88200s +00.01300s
|`->no local data found from DataSourceSmartOS @00.89700s +00.01300s
|`->no local data found from DataSourceScaleway @00.91000s +00.01400s
|`->found local data from DataSourceEc2Local @00.92400s +01.14000s
Finished stage: (init-local) 02.14500 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceEc2Local @02.68900s +00.00400s
|`->setting up datasource @02.76200s +00.00000s
|`->reading and applying user-data @02.77000s +00.00800s
|`->reading and applying vendor-data @02.77800s +00.00000s
|`->activating datasource @02.80800s +00.00100s
|`->config-migrator ran successfully @02.82500s +00.00000s
|`->config-seed_random ran successfully @02.82600s +00.00000s
|`->config-bootcmd ran successfully @02.82700s +00.00000s
|`->config-write-files ran successfully @02.82700s +00.00100s
|`->config-growpart ran successfully @02.82800s +00.05500s
|`->config-resizefs ran successfully @02.88400s +00.01900s
|`->config-disk_setup ran successfully @02.90300s +00.00100s
|`->config-mounts ran successfully @02.90400s +00.00200s
|`->config-set_hostname ran successfully @02.90600s +00.00500s
|`->config-update_hostname ran successfully @02.91100s +00.00100s
|`->config-update_etc_hosts ran successfully @02.91200s +00.00100s
|`->config-ca-certs ran successfully @02.91300s +00.00100s
|`->config-rsyslog ran successfully @02.91400s +00.00100s
|`->config-users-groups ran successfully @02.91500s +00.01500s
|`->config-ssh ran successfully @02.93000s +00.21400s
Finished stage: (init-network) 00.46800 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @06.03200s +00.00100s
|`->config-snap ran successfully @06.03300s +00.00100s
|`->config-ssh-import-id ran successfully @06.03400s +00.68900s
|`->config-locale ran successfully @06.72300s +00.00200s
|`->config-set-passwords ran successfully @06.72500s +00.00100s
|`->config-grub-dpkg ran successfully @06.72600s +00.24900s
|`->config-apt-pipelining ran successfully @06.97600s +00.00100s
|`->config-apt-configure ran successfully @06.97700s +00.15200s
|`->config-ubuntu-advantage ran successfully @07.12900s +00.00100s
|`->config-ntp ran successfully @07.13000s +00.00100s
|`->config-timezone ran successfully @07.13100s +00.00100s
|`->config-disable-ec2-metadata ran successfully @07.13200s +00.00100s
|`->config-runcmd ran successfully @07.13300s +00.00100s
|`->config-byobu ran successfully @07.13400s +00.00100s
Finished stage: (modules-config) 01.11900 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @07.55600s +00.00100s
|`->config-fan ran successfully @07.55700s +00.00100s
|`->config-landscape ran successfully @07.55900s +00.00000s
|`->config-lxd ran successfully @07.56000s +00.00000s
|`->config-ubuntu-drivers ran successfully @07.56100s +00.00000s
|`->config-puppet ran successfully @07.56100s +00.00100s
|`->config-chef ran successfully @07.56200s +00.00100s
|`->config-mcollective ran successfully @07.56300s +00.00100s
|`->config-salt-minion ran successfully @07.56500s +00.00000s
|`->config-rightscale_userdata ran successfully @07.56500s +00.00100s
|`->config-scripts-vendor ran successfully @07.56700s +00.00000s
|`->config-scripts-per-once ran successfully @07.56800s +00.00000s
|`->config-scripts-per-boot ran successfully @07.56900s +00.00000s
|`->config-scripts-per-instance ran successfully @07.56900s +00.00100s
|`->config-scripts-user ran successfully @07.57000s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @07.57100s +00.07500s
|`->config-keys-to-console ran successfully @07.64600s +00.08500s
|`->config-phone-home ran successfully @07.73200s +00.00100s
|`->config-final-message ran successfully @07.73300s +00.00600s
|`->config-power-state-change ran successfully @07.73900s +00.00100s
Finished stage: (modules-final) 00.20200 seconds

Total Time: 3.97400 seconds

1 boot records analyzed
+ '[' xenial = xenial ']'
+ echo '--- Expect warning on xenial for jinja because deb DOES NOT have jinja dep.'
--- Expect warning on xenial for jinja because deb DOES NOT have jinja dep.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com 'cloud-init query --format '\''cloud-region: {{cloud_name}}-{{region}}'\'''
cloud-region: aws-us-east-2
+ echo 'Per LP:1794399 expect we do not see a lot of killing dhclient logs'
Per LP:1794399 expect we do not see a lot of killing dhclient logs
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com 'grep dhclient /var/log/cloud-init.log'
2020-01-21 21:08:18,245 - util.py[DEBUG]: Copying /sbin/dhclient to /var/tmp/cloud-init/cloud-init-dhcp-6n4jnc7r/dhclient
2020-01-21 21:08:18,256 - util.py[DEBUG]: Running command ['/var/tmp/cloud-init/cloud-init-dhcp-6n4jnc7r/dhclient', '-1', '-v', '-lf', '/var/tmp/cloud-init/cloud-init-dhcp-6n4jnc7r/dhcp.leases', '-pf', '/var/tmp/cloud-init/cloud-init-dhcp-6n4jnc7r/dhclient.pid', 'eth0', '-sf', '/bin/true'] with allowed return codes [0] (shell=False, capture=True)
2020-01-21 21:08:18,282 - util.py[DEBUG]: Waiting up to 5 seconds for the following files: ['/var/tmp/cloud-init/cloud-init-dhcp-6n4jnc7r/dhclient.pid', '/var/tmp/cloud-init/cloud-init-dhcp-6n4jnc7r/dhcp.leases']
2020-01-21 21:08:18,292 - util.py[DEBUG]: All files appeared after 0.01 seconds: ['/var/tmp/cloud-init/cloud-init-dhcp-6n4jnc7r/dhclient.pid', '/var/tmp/cloud-init/cloud-init-dhcp-6n4jnc7r/dhcp.leases']
2020-01-21 21:08:18,293 - util.py[DEBUG]: Reading from /var/tmp/cloud-init/cloud-init-dhcp-6n4jnc7r/dhclient.pid (quiet=False)
2020-01-21 21:08:18,293 - util.py[DEBUG]: Read 4 bytes from /var/tmp/cloud-init/cloud-init-dhcp-6n4jnc7r/dhclient.pid
2020-01-21 21:08:18,293 - dhcp.py[DEBUG]: killing dhclient with pid=846
+ echo 'Get cloud-id'
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com cloud-id
aws
+ echo 'Validating whether metadata is being updated per boot LP:1819913'
Validating whether metadata is being updated per boot LP:1819913
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2020-01-21 21:08:16,616 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:16,822 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,046 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,187 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,211 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,231 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,292 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,341 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,367 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,368 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,382 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com sudo reboot
sudo: unable to resolve host SRU-worked-aws
Connection to ec2-18-216-155-114.us-east-2.compute.amazonaws.com closed by remote host.
+ true
+ sleep 60
+ echo 'After reboot'
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-155-114.us-east-2.compute.amazonaws.com 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2020-01-21 21:08:16,616 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:16,822 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,046 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,187 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,211 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,231 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,292 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,341 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,367 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,368 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:08:17,382 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:09:26,844 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:09:26,986 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:09:27,123 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:09:27,217 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:09:27,226 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:09:27,243 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:09:27,290 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:09:27,326 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:09:27,354 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:09:27,355 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:09:27,370 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:09:28,694 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo '### END xenial'
### END xenial
+ for series in $SRU_SERIES
+ echo '### BEGIN bionic'
### BEGIN bionic
++ launch-ec2 --series bionic -u sethostname.yaml
++ awk '/Found/{print $5}'
ubuntu-distro-info: Header `version,codename,series,created,release,eol,eol-server,eol-esm' in file `/usr/share/distro-info/ubuntu.csv' does not match excatly `version,codename,series,created,release,eol,eol-server'.
ubuntu-distro-info: Header `version,codename,series,created,release,eol,eol-server,eol-esm' in file `/usr/share/distro-info/ubuntu.csv' does not match excatly `version,codename,series,created,release,eol,eol-server'.
+ EC2_INST=ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- cloud-init status --wait --long

status: done
time: Tue, 21 Jan 2020 21:11:05 +0000
detail:
DataSourceEc2Local
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceEc2Local",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- '!' grep Trace '/var/log/cloud-init.*'
+ echo 'Expect IMDSv2 token headers are being used on all metadata gets. Expect 0 line count'
Expect IMDSv2 token headers are being used on all metadata gets. Expect 0 line count
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- '[[ 0 = `grep headers /var/log/cloud-init.log  | grep -c -v X-aws` ]] || exit 1'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- sudo systemd-analyze
Startup finished in 7.018s (kernel) + 32.633s (userspace) = 39.651s
graphical.target reached after 31.839s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- sudo systemd-analyze blame
          9.015s snapd.seeded.service
          6.067s cloud-init-local.service
          4.769s dev-xvda1.device
          2.997s pollinate.service
          2.804s networkd-dispatcher.service
          2.570s apparmor.service
          2.546s lxd-containers.service
          2.233s cloud-config.service
          2.047s lvm2-monitor.service
          1.766s systemd-networkd-wait-online.service
          1.753s cloud-init.service
          1.417s keyboard-setup.service
          1.150s systemd-modules-load.service
          1.144s accounts-daemon.service
          1.053s snapd.service
           917ms grub-common.service
           797ms systemd-journal-flush.service
           767ms cloud-final.service
           660ms systemd-remount-fs.service
           659ms systemd-sysctl.service
           653ms ebtables.service
           623ms systemd-udevd.service
           616ms systemd-udev-trigger.service
           563ms kmod-static-nodes.service
           556ms systemd-machine-id-commit.service
           542ms systemd-logind.service
           526ms apport.service
           520ms systemd-tmpfiles-setup-dev.service
           505ms systemd-journald.service
           362ms systemd-tmpfiles-setup.service
           357ms plymouth-read-write.service
           323ms ufw.service
           300ms rsyslog.service
           294ms systemd-timesyncd.service
           275ms setvtrgb.service
           234ms polkit.service
           197ms console-setup.service
           136ms systemd-networkd.service
           132ms blk-availability.service
           130ms hibinit-agent.service
           118ms systemd-random-seed.service
           109ms lxd.socket
           100ms systemd-user-sessions.service
            96ms dev-mqueue.mount
            90ms systemd-update-utmp.service
            74ms sys-kernel-debug.mount
            72ms systemd-resolved.service
            62ms systemd-update-utmp-runlevel.service
            55ms snapd.socket
            47ms dev-hugepages.mount
            36ms ssh.service
            33ms plymouth-quit.service
            32ms user@1000.service
            24ms snap-amazon\x2dssm\x2dagent-1480.mount
            21ms snap-core-8268.mount
            20ms dev-loop1.device
            17ms dev-loop0.device
            12ms plymouth-quit-wait.service
            12ms sys-fs-fuse-connections.mount
            12ms sys-kernel-config.mount
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- sudo cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00000s
|`->found local data from DataSourceEc2Local @00.02400s +00.66200s
Finished stage: (init-local) 00.97500 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceEc2Local @03.42200s +00.01500s
|`->setting up datasource @03.49700s +00.00000s
|`->reading and applying user-data @03.50400s +00.00800s
|`->reading and applying vendor-data @03.51200s +00.00100s
|`->activating datasource @03.54700s +00.00200s
|`->config-migrator ran successfully @03.59000s +00.00000s
|`->config-seed_random ran successfully @03.59100s +00.00000s
|`->config-bootcmd ran successfully @03.59200s +00.00000s
|`->config-write-files ran successfully @03.59200s +00.00100s
|`->config-growpart ran successfully @03.59300s +00.42000s
|`->config-resizefs ran successfully @04.01300s +00.10500s
|`->config-disk_setup ran successfully @04.11800s +00.00100s
|`->config-mounts ran successfully @04.11900s +00.00200s
|`->config-set_hostname ran successfully @04.12100s +00.00500s
|`->config-update_hostname ran successfully @04.12600s +00.00100s
|`->config-update_etc_hosts ran successfully @04.12800s +00.00000s
|`->config-ca-certs ran successfully @04.12800s +00.00100s
|`->config-rsyslog ran successfully @04.12900s +00.00100s
|`->config-users-groups ran successfully @04.13000s +00.29300s
|`->config-ssh ran successfully @04.42300s +00.18700s
Finished stage: (init-network) 01.20200 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @18.01300s +00.00000s
|`->config-snap ran successfully @18.01300s +00.00100s
|`->config-snap_config ran successfully @18.01400s +00.00100s
|`->config-ssh-import-id ran successfully @18.01500s +00.80700s
|`->config-locale ran successfully @18.82300s +00.00100s
|`->config-set-passwords ran successfully @18.82500s +00.00800s
|`->config-grub-dpkg ran successfully @18.83300s +00.20900s
|`->config-apt-pipelining ran successfully @19.04200s +00.00100s
|`->config-apt-configure ran successfully @19.04400s +00.10800s
|`->config-ubuntu-advantage ran successfully @19.15200s +00.00100s
|`->config-ntp ran successfully @19.15300s +00.00100s
|`->config-timezone ran successfully @19.15400s +00.00100s
|`->config-disable-ec2-metadata ran successfully @19.15500s +00.00000s
|`->config-runcmd ran successfully @19.15500s +00.00100s
|`->config-byobu ran successfully @19.15600s +00.00100s
Finished stage: (modules-config) 01.19900 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @19.90400s +00.00100s
|`->config-package-update-upgrade-install ran successfully @19.90600s +00.00000s
|`->config-fan ran successfully @19.90600s +00.00100s
|`->config-landscape ran successfully @19.90700s +00.00100s
|`->config-lxd ran successfully @19.90800s +00.00100s
|`->config-ubuntu-drivers ran successfully @19.90900s +00.00100s
|`->config-puppet ran successfully @19.91000s +00.00100s
|`->config-chef ran successfully @19.91100s +00.00000s
|`->config-mcollective ran successfully @19.91200s +00.00000s
|`->config-salt-minion ran successfully @19.91300s +00.00000s
|`->config-rightscale_userdata ran successfully @19.91300s +00.00100s
|`->config-scripts-vendor ran successfully @19.91400s +00.00100s
|`->config-scripts-per-once ran successfully @19.91500s +00.00100s
|`->config-scripts-per-boot ran successfully @19.91600s +00.00000s
|`->config-scripts-per-instance ran successfully @19.91600s +00.00100s
|`->config-scripts-user ran successfully @19.91700s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @19.91800s +00.07000s
|`->config-keys-to-console ran successfully @19.98900s +00.08000s
|`->config-phone-home ran successfully @20.06900s +00.00100s
|`->config-final-message ran successfully @20.07000s +00.00500s
|`->config-power-state-change ran successfully @20.07600s +00.00000s
Finished stage: (modules-final) 00.19700 seconds

Total Time: 3.57300 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- '!' sudo grep Trace '/var/log/cloud-init*'
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com:
setup_proposed.sh                                                                                                                            100%  196     4.6KB/s   00:00    
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com sudo bash setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu bionic-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~18.04.1 [409 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~18.04.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~18.04.1) over (19.3-41-gc4735dd3-0ubuntu1~18.04.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~18.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com sudo hostname something-else
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- sudo cloud-init init
Cloud-init v. 19.4-33-gbb4131a2-0ubuntu1~18.04.1 running 'init' at Tue, 21 Jan 2020 21:11:54 +0000. Up 87.87 seconds.
ci-info: ++++++++++++++++++++++++++++++++++++++Net device info+++++++++++++++++++++++++++++++++++++++
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: | Device |  Up  |           Address           |      Mask     | Scope  |     Hw-Address    |
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: |  eth0  | True |         10.41.41.245        | 255.255.255.0 | global | 06:99:5a:6a:95:b6 |
ci-info: |  eth0  | True | fe80::499:5aff:fe6a:95b6/64 |       .       |  link  | 06:99:5a:6a:95:b6 |
ci-info: |   lo   | True |          127.0.0.1          |   255.0.0.0   |  host  |         .         |
ci-info: |   lo   | True |           ::1/128           |       .       |  host  |         .         |
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: +++++++++++++++++++++++++++++Route IPv4 info++++++++++++++++++++++++++++++
ci-info: +-------+-------------+------------+-----------------+-----------+-------+
ci-info: | Route | Destination |  Gateway   |     Genmask     | Interface | Flags |
ci-info: +-------+-------------+------------+-----------------+-----------+-------+
ci-info: |   0   |   0.0.0.0   | 10.41.41.1 |     0.0.0.0     |    eth0   |   UG  |
ci-info: |   1   |  10.41.41.0 |  0.0.0.0   |  255.255.255.0  |    eth0   |   U   |
ci-info: |   2   |  10.41.41.1 |  0.0.0.0   | 255.255.255.255 |    eth0   |   UH  |
ci-info: +-------+-------------+------------+-----------------+-----------+-------+
ci-info: +++++++++++++++++++Route IPv6 info+++++++++++++++++++
ci-info: +-------+-------------+---------+-----------+-------+
ci-info: | Route | Destination | Gateway | Interface | Flags |
ci-info: +-------+-------------+---------+-----------+-------+
ci-info: |   1   |  fe80::/64  |    ::   |    eth0   |   U   |
ci-info: |   3   |    local    |    ::   |    eth0   |   U   |
ci-info: |   4   |   ff00::/8  |    ::   |    eth0   |   U   |
ci-info: +-------+-------------+---------+-----------+-------+
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- '!' grep Trace '/var/log/cloud-init*'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- sudo cloud-init clean --logs --reboot
Connection to ec2-3-17-146-226.us-east-2.compute.amazonaws.com closed by remote host.
+ true
+ sleep 60
+ date --utc +%s.%N
1579641178.025640938
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- cloud-init status --wait --long

status: done
time: Tue, 21 Jan 2020 21:12:45 +0000
detail:
DataSourceEc2Local
+ date --utc +%s.%N
1579641180.026204282
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- hostname
SRU-worked-aws
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- '!' grep Trace '/var/log/cloud-init*'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- sudo systemd-analyze
Startup finished in 4.300s (kernel) + 15.383s (userspace) = 19.684s
graphical.target reached after 14.508s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com -- sudo cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
|`->found local data from DataSourceEc2Local @00.03000s +00.31400s
Finished stage: (init-local) 00.63300 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceEc2Local @04.29300s +00.01600s
|`->setting up datasource @04.36900s +00.00000s
|`->reading and applying user-data @04.37600s +00.00800s
|`->reading and applying vendor-data @04.38400s +00.00000s
|`->activating datasource @04.42500s +00.00200s
|`->config-migrator ran successfully @04.48300s +00.00000s
|`->config-seed_random ran successfully @04.48400s +00.00000s
|`->config-bootcmd ran successfully @04.48500s +00.00000s
|`->config-write-files ran successfully @04.48500s +00.00100s
|`->config-growpart ran successfully @04.48600s +00.21000s
|`->config-resizefs ran successfully @04.69600s +00.11900s
|`->config-disk_setup ran successfully @04.81900s +00.00100s
|`->config-mounts ran successfully @04.82000s +00.00100s
|`->config-set_hostname ran successfully @04.82200s +00.00500s
|`->config-update_hostname ran successfully @04.82700s +00.00100s
|`->config-update_etc_hosts ran successfully @04.82900s +00.00000s
|`->config-ca-certs ran successfully @04.82900s +00.00100s
|`->config-rsyslog ran successfully @04.83000s +00.00100s
|`->config-users-groups ran successfully @04.83100s +00.06200s
|`->config-ssh ran successfully @04.89300s +00.56900s
Finished stage: (init-network) 01.18400 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @09.69700s +00.00000s
|`->config-snap ran successfully @09.69700s +00.00100s
|`->config-ssh-import-id ran successfully @09.69800s +01.22700s
|`->config-locale ran successfully @10.92500s +00.00200s
|`->config-set-passwords ran successfully @10.92700s +00.00000s
|`->config-grub-dpkg ran successfully @10.92800s +00.24300s
|`->config-apt-pipelining ran successfully @11.17200s +00.00000s
|`->config-apt-configure ran successfully @11.17300s +00.10500s
|`->config-ubuntu-advantage ran successfully @11.27900s +00.00100s
|`->config-ntp ran successfully @11.28000s +00.00000s
|`->config-timezone ran successfully @11.28100s +00.00000s
|`->config-disable-ec2-metadata ran successfully @11.28100s +00.00100s
|`->config-runcmd ran successfully @11.28200s +00.00100s
|`->config-byobu ran successfully @11.28300s +00.00000s
Finished stage: (modules-config) 01.60600 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @12.07600s +00.00000s
|`->config-fan ran successfully @12.07700s +00.00000s
|`->config-landscape ran successfully @12.07800s +00.00000s
|`->config-lxd ran successfully @12.07800s +00.00100s
|`->config-ubuntu-drivers ran successfully @12.07900s +00.00100s
|`->config-puppet ran successfully @12.08000s +00.00100s
|`->config-chef ran successfully @12.08100s +00.00100s
|`->config-mcollective ran successfully @12.08200s +00.00000s
|`->config-salt-minion ran successfully @12.08300s +00.00000s
|`->config-rightscale_userdata ran successfully @12.08400s +00.00000s
|`->config-scripts-vendor ran successfully @12.08400s +00.00100s
|`->config-scripts-per-once ran successfully @12.08500s +00.00100s
|`->config-scripts-per-boot ran successfully @12.08600s +00.00000s
|`->config-scripts-per-instance ran successfully @12.08600s +00.00100s
|`->config-scripts-user ran successfully @12.08700s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @12.08800s +00.12000s
|`->config-keys-to-console ran successfully @12.20800s +00.11200s
|`->config-phone-home ran successfully @12.32000s +00.00100s
|`->config-final-message ran successfully @12.32100s +00.00500s
|`->config-power-state-change ran successfully @12.32700s +00.00000s
Finished stage: (modules-final) 00.27300 seconds

Total Time: 3.69600 seconds

1 boot records analyzed
+ '[' bionic = xenial ']'
+ echo '--- Expect success on bionic for jinja because deb DOES have jinja dep.'
--- Expect success on bionic for jinja because deb DOES have jinja dep.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com 'cloud-init query --format '\''cloud-region: {{cloud_name}}-{{region}}'\'''
cloud-region: aws-us-east-2
+ echo 'Per LP:1794399 expect we do not see a lot of killing dhclient logs'
Per LP:1794399 expect we do not see a lot of killing dhclient logs
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com 'grep dhclient /var/log/cloud-init.log'
2020-01-21 21:12:33,427 - util.py[DEBUG]: Copying /sbin/dhclient to /var/tmp/cloud-init/cloud-init-dhcp-fk6mawm0/dhclient
2020-01-21 21:12:33,442 - util.py[DEBUG]: Running command ['/var/tmp/cloud-init/cloud-init-dhcp-fk6mawm0/dhclient', '-1', '-v', '-lf', '/var/tmp/cloud-init/cloud-init-dhcp-fk6mawm0/dhcp.leases', '-pf', '/var/tmp/cloud-init/cloud-init-dhcp-fk6mawm0/dhclient.pid', 'eth0', '-sf', '/bin/true'] with allowed return codes [0] (shell=False, capture=True)
2020-01-21 21:12:33,476 - util.py[DEBUG]: All files appeared after 0 seconds: ['/var/tmp/cloud-init/cloud-init-dhcp-fk6mawm0/dhclient.pid', '/var/tmp/cloud-init/cloud-init-dhcp-fk6mawm0/dhcp.leases']
2020-01-21 21:12:33,476 - util.py[DEBUG]: Reading from /var/tmp/cloud-init/cloud-init-dhcp-fk6mawm0/dhclient.pid (quiet=False)
2020-01-21 21:12:33,476 - util.py[DEBUG]: Read 4 bytes from /var/tmp/cloud-init/cloud-init-dhcp-fk6mawm0/dhclient.pid
2020-01-21 21:12:33,477 - dhcp.py[DEBUG]: killing dhclient with pid=613
+ echo 'Get cloud-id'
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com cloud-id
aws
+ echo 'Validating whether metadata is being updated per boot LP:1819913'
Validating whether metadata is being updated per boot LP:1819913
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2020-01-21 21:12:33,379 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com sudo reboot
Connection to ec2-3-17-146-226.us-east-2.compute.amazonaws.com closed by remote host.
+ true
+ sleep 60
+ echo 'After reboot'
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-3-17-146-226.us-east-2.compute.amazonaws.com 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2020-01-21 21:12:33,379 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:13:48,432 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
+ echo '### END bionic'
### END bionic
+ for series in $SRU_SERIES
+ echo '### BEGIN disco'
### BEGIN disco
++ launch-ec2 --series disco -u sethostname.yaml
++ awk '/Found/{print $5}'
ubuntu-distro-info: Header `version,codename,series,created,release,eol,eol-server,eol-esm' in file `/usr/share/distro-info/ubuntu.csv' does not match excatly `version,codename,series,created,release,eol,eol-server'.
ubuntu-distro-info: Header `version,codename,series,created,release,eol,eol-server,eol-esm' in file `/usr/share/distro-info/ubuntu.csv' does not match excatly `version,codename,series,created,release,eol,eol-server'.
+ EC2_INST=ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- cloud-init status --wait --long

status: done
time: Tue, 21 Jan 2020 21:15:49 +0000
detail:
DataSourceEc2Local
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceEc2Local",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- '!' grep Trace '/var/log/cloud-init.*'
+ echo 'Expect IMDSv2 token headers are being used on all metadata gets. Expect 0 line count'
Expect IMDSv2 token headers are being used on all metadata gets. Expect 0 line count
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- '[[ 0 = `grep headers /var/log/cloud-init.log  | grep -c -v X-aws` ]] || exit 1'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- sudo systemd-analyze
Startup finished in 4.917s (kernel) + 1min 7.435s (userspace) = 1min 12.353s 
graphical.target reached after 1min 2.381s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- sudo systemd-analyze blame
         35.723s snapd.seeded.service
          8.289s cloud-init-local.service
          5.396s lvm2-monitor.service
          4.863s dev-xvda1.device
          4.484s systemd-udev-settle.service
          3.838s cloud-config.service
          2.536s cloud-init.service
          2.512s pollinate.service
          1.253s systemd-networkd-wait-online.service
          1.236s cloud-final.service
          1.019s snapd.service
           962ms apparmor.service
           943ms systemd-logind.service
           923ms accounts-daemon.service
           827ms systemd-resolved.service
           711ms networkd-dispatcher.service
           604ms systemd-modules-load.service
           563ms rsyslog.service
           548ms systemd-networkd.service
           535ms systemd-timesyncd.service
           469ms multipathd.service
           462ms systemd-journald.service
           448ms grub-common.service
           383ms ssh.service
           376ms atd.service
           366ms snap.lxd.activate.service
           346ms apport.service
           336ms keyboard-setup.service
           304ms user@1000.service
           296ms systemd-udev-trigger.service
           289ms blk-availability.service
           229ms systemd-tmpfiles-setup-dev.service
           220ms kmod-static-nodes.service
           212ms systemd-user-sessions.service
           199ms plymouth-quit-wait.service
           168ms systemd-sysusers.service
           165ms grub-initrd-fallback.service
           154ms systemd-udevd.service
           141ms ufw.service
           141ms dev-hugepages.mount
           120ms systemd-journal-flush.service
           106ms systemd-machine-id-commit.service
           105ms finalrd.service
           101ms systemd-remount-fs.service
            97ms sys-kernel-debug.mount
            93ms systemd-sysctl.service
            85ms plymouth-read-write.service
            76ms dev-mqueue.mount
            69ms systemd-tmpfiles-setup.service
            65ms snapd.socket
            63ms plymouth-quit.service
            63ms systemd-update-utmp.service
            63ms setvtrgb.service
            58ms console-setup.service
            35ms systemd-random-seed.service
            34ms systemd-update-utmp-runlevel.service
            32ms snap-core-8268.mount
            32ms sys-fs-fuse-connections.mount
            32ms user-runtime-dir@1000.service
            31ms snap-lxd-12631.mount
            31ms snap-amazon\x2dssm\x2dagent-1480.mount
            27ms dev-loop2.device
            26ms sys-kernel-config.mount
            24ms dev-loop1.device
            21ms dev-loop0.device
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- sudo cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00000s
|`->found local data from DataSourceEc2Local @00.01100s +00.81900s
Finished stage: (init-local) 01.11900 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceEc2Local @03.40400s +00.00300s
|`->setting up datasource @03.46200s +00.00000s
|`->reading and applying user-data @03.46800s +00.00700s
|`->reading and applying vendor-data @03.47500s +00.00000s
|`->activating datasource @03.50300s +00.01000s
|`->config-migrator ran successfully @03.55900s +00.00100s
|`->config-seed_random ran successfully @03.56000s +00.00000s
|`->config-bootcmd ran successfully @03.56100s +00.00000s
|`->config-write-files ran successfully @03.56100s +00.00100s
|`->config-growpart ran successfully @03.56200s +00.82100s
|`->config-resizefs ran successfully @04.38300s +00.11900s
|`->config-disk_setup ran successfully @04.50200s +00.00100s
|`->config-mounts ran successfully @04.50400s +00.00100s
|`->config-set_hostname ran successfully @04.50500s +00.00500s
|`->config-update_hostname ran successfully @04.51000s +00.00200s
|`->config-update_etc_hosts ran successfully @04.51200s +00.00000s
|`->config-ca-certs ran successfully @04.51200s +00.00100s
|`->config-rsyslog ran successfully @04.51300s +00.00100s
|`->config-users-groups ran successfully @04.51400s +00.48700s
|`->config-ssh ran successfully @05.00200s +00.46500s
Finished stage: (init-network) 02.07600 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @45.87500s +00.00000s
|`->config-snap ran successfully @45.87500s +00.00100s
|`->config-snap_config ran successfully @45.87600s +00.00100s
|`->config-ssh-import-id ran successfully @45.87700s +00.90500s
|`->config-locale ran successfully @46.78300s +00.00100s
|`->config-set-passwords ran successfully @46.78400s +00.00100s
|`->config-grub-dpkg ran successfully @46.78500s +02.00500s
|`->config-apt-pipelining ran successfully @48.79100s +00.00100s
|`->config-apt-configure ran successfully @48.79200s +00.27900s
|`->config-ubuntu-advantage ran successfully @49.07700s +00.00100s
|`->config-ntp ran successfully @49.07800s +00.00100s
|`->config-timezone ran successfully @49.07900s +00.00400s
|`->config-disable-ec2-metadata ran successfully @49.08800s +00.00000s
|`->config-runcmd ran successfully @49.08900s +00.00000s
|`->config-byobu ran successfully @49.08900s +00.00100s
Finished stage: (modules-config) 03.24400 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @49.84500s +00.00200s
|`->config-package-update-upgrade-install ran successfully @49.85100s +00.00100s
|`->config-fan ran successfully @49.85200s +00.00100s
|`->config-landscape ran successfully @49.85300s +00.00100s
|`->config-lxd ran successfully @49.85400s +00.00100s
|`->config-ubuntu-drivers ran successfully @49.85500s +00.00200s
|`->config-puppet ran successfully @49.85700s +00.00100s
|`->config-chef ran successfully @49.85800s +00.00100s
|`->config-mcollective ran successfully @49.85900s +00.00500s
|`->config-salt-minion ran successfully @49.86400s +00.00100s
|`->config-rightscale_userdata ran successfully @49.86500s +00.00100s
|`->config-scripts-vendor ran successfully @49.86600s +00.00000s
|`->config-scripts-per-once ran successfully @49.86700s +00.00400s
|`->config-scripts-per-boot ran successfully @49.87100s +00.00000s
|`->config-scripts-per-instance ran successfully @49.87100s +00.00100s
|`->config-scripts-user ran successfully @49.87200s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @49.87300s +00.25900s
|`->config-keys-to-console ran successfully @50.13500s +00.21900s
|`->config-phone-home ran successfully @50.35700s +00.00100s
|`->config-final-message ran successfully @50.35900s +00.00700s
|`->config-power-state-change ran successfully @50.36600s +00.00100s
Finished stage: (modules-final) 00.55200 seconds

Total Time: 6.99100 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- '!' sudo grep Trace '/var/log/cloud-init*'
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com:
setup_proposed.sh                                                                                                                            100%  196     4.4KB/s   00:00    
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com sudo bash setup_proposed.sh
+ egrep cloud-init
cloud-init is already the newest version (19.3-41-gc4735dd3-0ubuntu1~19.04.1).
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com sudo hostname something-else
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- sudo cloud-init init
Cloud-init v. 19.3-41-gc4735dd3-0ubuntu1~19.04.1 running 'init' at Tue, 21 Jan 2020 21:16:11 +0000. Up 94.86 seconds.
ci-info: ++++++++++++++++++++++++++++++++++++++Net device info+++++++++++++++++++++++++++++++++++++++
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: | Device |  Up  |           Address           |      Mask     | Scope  |     Hw-Address    |
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: |  eth0  | True |         10.41.41.95         | 255.255.255.0 | global | 06:d0:89:5c:37:14 |
ci-info: |  eth0  | True | fe80::4d0:89ff:fe5c:3714/64 |       .       |  link  | 06:d0:89:5c:37:14 |
ci-info: |   lo   | True |          127.0.0.1          |   255.0.0.0   |  host  |         .         |
ci-info: |   lo   | True |           ::1/128           |       .       |  host  |         .         |
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: +++++++++++++++++++++++++++++Route IPv4 info++++++++++++++++++++++++++++++
ci-info: +-------+-------------+------------+-----------------+-----------+-------+
ci-info: | Route | Destination |  Gateway   |     Genmask     | Interface | Flags |
ci-info: +-------+-------------+------------+-----------------+-----------+-------+
ci-info: |   0   |   0.0.0.0   | 10.41.41.1 |     0.0.0.0     |    eth0   |   UG  |
ci-info: |   1   |  10.41.41.0 |  0.0.0.0   |  255.255.255.0  |    eth0   |   U   |
ci-info: |   2   |  10.41.41.1 |  0.0.0.0   | 255.255.255.255 |    eth0   |   UH  |
ci-info: +-------+-------------+------------+-----------------+-----------+-------+
ci-info: +++++++++++++++++++Route IPv6 info+++++++++++++++++++
ci-info: +-------+-------------+---------+-----------+-------+
ci-info: | Route | Destination | Gateway | Interface | Flags |
ci-info: +-------+-------------+---------+-----------+-------+
ci-info: |   1   |  fe80::/64  |    ::   |    eth0   |   U   |
ci-info: |   3   |    local    |    ::   |    eth0   |   U   |
ci-info: |   4   |   ff00::/8  |    ::   |    eth0   |   U   |
ci-info: +-------+-------------+---------+-----------+-------+
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- '!' grep Trace '/var/log/cloud-init*'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- sudo cloud-init clean --logs --reboot
Connection to ec2-18-216-40-176.us-east-2.compute.amazonaws.com closed by remote host.
+ true
+ sleep 60
+ date --utc +%s.%N
1579641434.808348202
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- cloud-init status --wait --long

status: done
time: Tue, 21 Jan 2020 21:16:58 +0000
detail:
DataSourceEc2Local
+ date --utc +%s.%N
1579641436.796253947
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- hostname
SRU-worked-aws
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- '!' grep Trace '/var/log/cloud-init*'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- sudo systemd-analyze
Startup finished in 1.853s (kernel) + 13.293s (userspace) = 15.147s 
graphical.target reached after 10.648s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com -- sudo cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
|`->found local data from DataSourceEc2Local @00.01200s +00.26200s
Finished stage: (init-local) 00.52800 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceEc2Local @02.91900s +00.00300s
|`->setting up datasource @02.97600s +00.00000s
|`->reading and applying user-data @02.98200s +00.00800s
|`->reading and applying vendor-data @02.99000s +00.00000s
|`->activating datasource @03.02000s +00.00100s
|`->config-migrator ran successfully @03.05500s +00.00100s
|`->config-seed_random ran successfully @03.05600s +00.00100s
|`->config-bootcmd ran successfully @03.05700s +00.00000s
|`->config-write-files ran successfully @03.05700s +00.00100s
|`->config-growpart ran successfully @03.05800s +00.13400s
|`->config-resizefs ran successfully @03.19200s +00.03600s
|`->config-disk_setup ran successfully @03.22800s +00.00100s
|`->config-mounts ran successfully @03.22900s +00.00200s
|`->config-set_hostname ran successfully @03.23100s +00.00500s
|`->config-update_hostname ran successfully @03.23600s +00.00100s
|`->config-update_etc_hosts ran successfully @03.23700s +00.00100s
|`->config-ca-certs ran successfully @03.23800s +00.00100s
|`->config-rsyslog ran successfully @03.23900s +00.00100s
|`->config-users-groups ran successfully @03.24000s +00.01600s
|`->config-ssh ran successfully @03.25600s +00.38100s
Finished stage: (init-network) 00.73400 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @07.79500s +00.00000s
|`->config-snap ran successfully @07.79500s +00.00100s
|`->config-snap_config ran successfully @07.79600s +00.00100s
|`->config-ssh-import-id ran successfully @07.79700s +00.81200s
|`->config-locale ran successfully @08.61700s +00.00100s
|`->config-set-passwords ran successfully @08.61800s +00.00100s
|`->config-grub-dpkg ran successfully @08.61900s +00.20300s
|`->config-apt-pipelining ran successfully @08.82300s +00.00100s
|`->config-apt-configure ran successfully @08.82400s +00.10900s
|`->config-ubuntu-advantage ran successfully @08.93300s +00.00100s
|`->config-ntp ran successfully @08.93400s +00.00100s
|`->config-timezone ran successfully @08.93500s +00.00100s
|`->config-disable-ec2-metadata ran successfully @08.93600s +00.00000s
|`->config-runcmd ran successfully @08.93700s +00.00000s
|`->config-byobu ran successfully @08.93700s +00.00100s
Finished stage: (modules-config) 01.16700 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @09.53900s +00.00200s
|`->config-package-update-upgrade-install ran successfully @09.54100s +00.00100s
|`->config-fan ran successfully @09.54200s +00.00100s
|`->config-landscape ran successfully @09.54300s +00.00100s
|`->config-lxd ran successfully @09.54400s +00.00000s
|`->config-ubuntu-drivers ran successfully @09.54500s +00.00000s
|`->config-puppet ran successfully @09.54500s +00.00100s
|`->config-chef ran successfully @09.54600s +00.00100s
|`->config-mcollective ran successfully @09.54700s +00.00100s
|`->config-salt-minion ran successfully @09.54800s +00.00100s
|`->config-rightscale_userdata ran successfully @09.54900s +00.00100s
|`->config-scripts-vendor ran successfully @09.55000s +00.00000s
|`->config-scripts-per-once ran successfully @09.55100s +00.00000s
|`->config-scripts-per-boot ran successfully @09.55200s +00.00000s
|`->config-scripts-per-instance ran successfully @09.55200s +00.00100s
|`->config-scripts-user ran successfully @09.55300s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @09.55400s +00.09100s
|`->config-keys-to-console ran successfully @09.64500s +00.07900s
|`->config-phone-home ran successfully @09.72500s +00.00100s
|`->config-final-message ran successfully @09.72600s +00.00400s
|`->config-power-state-change ran successfully @09.73000s +00.00100s
Finished stage: (modules-final) 00.21400 seconds

Total Time: 2.64300 seconds

1 boot records analyzed
+ '[' disco = xenial ']'
+ echo '--- Expect success on bionic for jinja because deb DOES have jinja dep.'
--- Expect success on bionic for jinja because deb DOES have jinja dep.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com 'cloud-init query --format '\''cloud-region: {{cloud_name}}-{{region}}'\'''
cloud-region: aws-us-east-2
+ echo 'Per LP:1794399 expect we do not see a lot of killing dhclient logs'
Per LP:1794399 expect we do not see a lot of killing dhclient logs
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com 'grep dhclient /var/log/cloud-init.log'
2020-01-21 21:16:48,334 - util.py[DEBUG]: Copying /usr/sbin/dhclient to /var/tmp/cloud-init/cloud-init-dhcp-14ln4xpj/dhclient
2020-01-21 21:16:48,349 - util.py[DEBUG]: Running command ['/var/tmp/cloud-init/cloud-init-dhcp-14ln4xpj/dhclient', '-1', '-v', '-lf', '/var/tmp/cloud-init/cloud-init-dhcp-14ln4xpj/dhcp.leases', '-pf', '/var/tmp/cloud-init/cloud-init-dhcp-14ln4xpj/dhclient.pid', 'eth0', '-sf', '/bin/true'] with allowed return codes [0] (shell=False, capture=True)
2020-01-21 21:16:48,374 - util.py[DEBUG]: All files appeared after 0 seconds: ['/var/tmp/cloud-init/cloud-init-dhcp-14ln4xpj/dhclient.pid', '/var/tmp/cloud-init/cloud-init-dhcp-14ln4xpj/dhcp.leases']
2020-01-21 21:16:48,374 - util.py[DEBUG]: Reading from /var/tmp/cloud-init/cloud-init-dhcp-14ln4xpj/dhclient.pid (quiet=False)
2020-01-21 21:16:48,374 - util.py[DEBUG]: Read 4 bytes from /var/tmp/cloud-init/cloud-init-dhcp-14ln4xpj/dhclient.pid
2020-01-21 21:16:48,375 - dhcp.py[DEBUG]: killing dhclient with pid=411
+ echo 'Get cloud-id'
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com cloud-id
aws
+ echo 'Validating whether metadata is being updated per boot LP:1819913'
Validating whether metadata is being updated per boot LP:1819913
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2020-01-21 21:16:48,289 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com sudo reboot
+ sleep 60
+ echo 'After reboot'
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-216-40-176.us-east-2.compute.amazonaws.com 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2020-01-21 21:16:48,289 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:18:01,490 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
+ echo '### END disco'
### END disco
+ echo '### BEGIN eoan'
### BEGIN eoan
++ launch-ec2 --series eoan -u sethostname.yaml
++ awk '/Found/{print $5}'
ubuntu-distro-info: Header `version,codename,series,created,release,eol,eol-server,eol-esm' in file `/usr/share/distro-info/ubuntu.csv' does not match excatly `version,codename,series,created,release,eol,eol-server'.
ubuntu-distro-info: Header `version,codename,series,created,release,eol,eol-server,eol-esm' in file `/usr/share/distro-info/ubuntu.csv' does not match excatly `version,codename,series,created,release,eol,eol-server'.
+ EC2_INST=ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- cloud-init status --wait --long

status: done
time: Tue, 21 Jan 2020 21:21:43 +0000
detail:
DataSourceEc2Local
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceEc2Local",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- '!' grep Trace '/var/log/cloud-init.*'
+ echo 'Expect IMDSv2 token headers are being used on all metadata gets. Expect 0 line count'
Expect IMDSv2 token headers are being used on all metadata gets. Expect 0 line count
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- '[[ 0 = `grep headers /var/log/cloud-init.log  | grep -c -v X-aws` ]] || exit 1'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- sudo systemd-analyze
Startup finished in 1.957s (kernel) + 35.211s (userspace) = 37.168s 
graphical.target reached after 32.221s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- sudo systemd-analyze blame
         23.321s snapd.seeded.service
          2.275s cloud-config.service
          1.625s systemd-networkd-wait-online.service
          1.370s pollinate.service
          1.322s cloud-init.service
          1.242s cloud-init-local.service
          1.230s dev-xvda1.device
          1.153s lvm2-monitor.service
          1.129s systemd-logind.service
          1.123s accounts-daemon.service
           999ms apparmor.service
           963ms systemd-udev-settle.service
           959ms snapd.service
           658ms cloud-final.service
           648ms systemd-journald.service
           567ms rsyslog.service
           554ms grub-common.service
           515ms systemd-timesyncd.service
           464ms networkd-dispatcher.service
           457ms apport.service
           408ms atd.service
           377ms snap.lxd.activate.service
           348ms systemd-user-sessions.service
           338ms sys-kernel-debug.mount
           337ms keyboard-setup.service
           334ms ufw.service
           325ms dev-hugepages.mount
           325ms systemd-modules-load.service
           324ms dev-mqueue.mount
           317ms kmod-static-nodes.service
           289ms systemd-remount-fs.service
           278ms systemd-resolved.service
           274ms systemd-networkd.service
           268ms systemd-udev-trigger.service
           259ms polkit.service
           211ms grub-initrd-fallback.service
           153ms systemd-machine-id-commit.service
           148ms console-setup.service
           148ms finalrd.service
           134ms systemd-tmpfiles-setup.service
           120ms plymouth-read-write.service
           106ms systemd-sysusers.service
           106ms snapd.socket
           101ms systemd-random-seed.service
           100ms plymouth-quit-wait.service
            96ms systemd-sysctl.service
            94ms sys-fs-fuse-connections.mount
            92ms user@1000.service
            84ms sys-kernel-config.mount
            83ms plymouth-quit.service
            82ms multipathd.service
            68ms systemd-update-utmp.service
            64ms systemd-update-utmp-runlevel.service
            54ms systemd-udevd.service
            50ms setvtrgb.service
            49ms ssh.service
            42ms systemd-journal-flush.service
            40ms blk-availability.service
            36ms snap-core-8268.mount
            34ms snap-lxd-12631.mount
            28ms snap-amazon\x2dssm\x2dagent-1480.mount
            24ms dev-loop1.device
            21ms systemd-tmpfiles-setup-dev.service
            19ms dev-loop0.device
            19ms user-runtime-dir@1000.service
            19ms dev-loop2.device
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- sudo cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00100s
|`->found local data from DataSourceEc2Local @00.01100s +00.26100s
Finished stage: (init-local) 00.52500 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceEc2Local @02.90600s +00.00300s
|`->setting up datasource @02.96700s +00.00000s
|`->reading and applying user-data @02.97300s +00.00700s
|`->reading and applying vendor-data @02.98100s +00.00000s
|`->activating datasource @03.01300s +00.00100s
|`->config-migrator ran successfully @03.07700s +00.00100s
|`->config-seed_random ran successfully @03.07800s +00.00000s
|`->config-bootcmd ran successfully @03.07900s +00.00000s
|`->config-write-files ran successfully @03.07900s +00.00100s
|`->config-growpart ran successfully @03.08000s +00.12400s
|`->config-resizefs ran successfully @03.20400s +00.05500s
|`->config-disk_setup ran successfully @03.25900s +00.00100s
|`->config-mounts ran successfully @03.26100s +00.00100s
|`->config-set_hostname ran successfully @03.26200s +00.00500s
|`->config-update_hostname ran successfully @03.26800s +00.00100s
|`->config-update_etc_hosts ran successfully @03.26900s +00.00000s
|`->config-ca-certs ran successfully @03.27000s +00.00000s
|`->config-rsyslog ran successfully @03.27100s +00.00000s
|`->config-users-groups ran successfully @03.27100s +00.07500s
|`->config-ssh ran successfully @03.34600s +00.37200s
Finished stage: (init-network) 00.82700 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @28.80400s +00.00000s
|`->config-snap ran successfully @28.80400s +00.00100s
|`->config-snap_config ran successfully @28.80500s +00.00100s
|`->config-ssh-import-id ran successfully @28.80600s +00.90800s
|`->config-locale ran successfully @29.71500s +00.00100s
|`->config-set-passwords ran successfully @29.71600s +00.00100s
|`->config-grub-dpkg ran successfully @29.71700s +00.73000s
|`->config-apt-pipelining ran successfully @30.44800s +00.00100s
|`->config-apt-configure ran successfully @30.44900s +00.10200s
|`->config-ubuntu-advantage ran successfully @30.55100s +00.00100s
|`->config-ntp ran successfully @30.55200s +00.00100s
|`->config-timezone ran successfully @30.55300s +00.00100s
|`->config-disable-ec2-metadata ran successfully @30.55400s +00.00000s
|`->config-runcmd ran successfully @30.55400s +00.00100s
|`->config-byobu ran successfully @30.55500s +00.00100s
Finished stage: (modules-config) 01.77000 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @31.06800s +00.00200s
|`->config-package-update-upgrade-install ran successfully @31.07000s +00.00100s
|`->config-fan ran successfully @31.07100s +00.00100s
|`->config-landscape ran successfully @31.07200s +00.00100s
|`->config-lxd ran successfully @31.07300s +00.00000s
|`->config-ubuntu-drivers ran successfully @31.07400s +00.00000s
|`->config-puppet ran successfully @31.07500s +00.00000s
|`->config-chef ran successfully @31.07500s +00.00100s
|`->config-mcollective ran successfully @31.07600s +00.00100s
|`->config-salt-minion ran successfully @31.07700s +00.00100s
|`->config-rightscale_userdata ran successfully @31.07800s +00.00000s
|`->config-scripts-vendor ran successfully @31.07900s +00.00000s
|`->config-scripts-per-once ran successfully @31.08000s +00.00000s
|`->config-scripts-per-boot ran successfully @31.08000s +00.00000s
|`->config-scripts-per-instance ran successfully @31.08100s +00.00000s
|`->config-scripts-user ran successfully @31.08200s +00.00000s
|`->config-ssh-authkey-fingerprints ran successfully @31.08200s +00.05500s
|`->config-keys-to-console ran successfully @31.13800s +00.07200s
|`->config-phone-home ran successfully @31.21000s +00.00100s
|`->config-final-message ran successfully @31.21200s +00.00400s
|`->config-power-state-change ran successfully @31.21600s +00.00100s
Finished stage: (modules-final) 00.16800 seconds

Total Time: 3.29000 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- '!' sudo grep Trace '/var/log/cloud-init*'
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com:
setup_proposed.sh                                                                                                                            100%  196     4.8KB/s   00:00    
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com sudo bash setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu eoan-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~19.10.1 [405 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~19.10.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~19.10.1) over (19.3-41-gc4735dd3-0ubuntu1~19.10.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~19.10.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com sudo hostname something-else
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- sudo cloud-init init
Cloud-init v. 19.4-33-gbb4131a2-0ubuntu1~19.10.1 running 'init' at Tue, 21 Jan 2020 21:22:42 +0000. Up 95.30 seconds.
ci-info: ++++++++++++++++++++++++++++++++++++++Net device info+++++++++++++++++++++++++++++++++++++++
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: | Device |  Up  |           Address           |      Mask     | Scope  |     Hw-Address    |
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: |  eth0  | True |         10.41.41.92         | 255.255.255.0 | global | 06:46:a0:66:30:a2 |
ci-info: |  eth0  | True | fe80::446:a0ff:fe66:30a2/64 |       .       |  link  | 06:46:a0:66:30:a2 |
ci-info: |   lo   | True |          127.0.0.1          |   255.0.0.0   |  host  |         .         |
ci-info: |   lo   | True |           ::1/128           |       .       |  host  |         .         |
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: +++++++++++++++++++++++++++++Route IPv4 info++++++++++++++++++++++++++++++
ci-info: +-------+-------------+------------+-----------------+-----------+-------+
ci-info: | Route | Destination |  Gateway   |     Genmask     | Interface | Flags |
ci-info: +-------+-------------+------------+-----------------+-----------+-------+
ci-info: |   0   |   0.0.0.0   | 10.41.41.1 |     0.0.0.0     |    eth0   |   UG  |
ci-info: |   1   |  10.41.41.0 |  0.0.0.0   |  255.255.255.0  |    eth0   |   U   |
ci-info: |   2   |  10.41.41.1 |  0.0.0.0   | 255.255.255.255 |    eth0   |   UH  |
ci-info: +-------+-------------+------------+-----------------+-----------+-------+
ci-info: +++++++++++++++++++Route IPv6 info+++++++++++++++++++
ci-info: +-------+-------------+---------+-----------+-------+
ci-info: | Route | Destination | Gateway | Interface | Flags |
ci-info: +-------+-------------+---------+-----------+-------+
ci-info: |   1   |  fe80::/64  |    ::   |    eth0   |   U   |
ci-info: |   3   |    local    |    ::   |    eth0   |   U   |
ci-info: |   4   |   ff00::/8  |    ::   |    eth0   |   U   |
ci-info: +-------+-------------+---------+-----------+-------+
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- '!' grep Trace '/var/log/cloud-init*'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- sudo cloud-init clean --logs --reboot
Connection to ec2-18-218-249-209.us-east-2.compute.amazonaws.com closed by remote host.
+ true
+ sleep 60
+ date --utc +%s.%N
1579641824.957936170
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- cloud-init status --wait --long

status: done
time: Tue, 21 Jan 2020 21:23:27 +0000
detail:
DataSourceEc2Local
+ date --utc +%s.%N
1579641826.817402264
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- hostname
SRU-worked-aws
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- '!' grep Trace '/var/log/cloud-init*'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- sudo systemd-analyze
Startup finished in 1.502s (kernel) + 13.270s (userspace) = 14.772s 
graphical.target reached after 10.418s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com -- sudo cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
|`->found local data from DataSourceEc2Local @00.01100s +00.29900s
Finished stage: (init-local) 00.56400 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceEc2Local @02.58500s +00.00300s
|`->setting up datasource @02.64700s +00.00000s
|`->reading and applying user-data @02.65400s +00.00700s
|`->reading and applying vendor-data @02.66100s +00.00000s
|`->activating datasource @02.69300s +00.00200s
|`->config-migrator ran successfully @02.76200s +00.00000s
|`->config-seed_random ran successfully @02.76200s +00.00100s
|`->config-bootcmd ran successfully @02.76300s +00.00100s
|`->config-write-files ran successfully @02.76400s +00.00000s
|`->config-growpart ran successfully @02.76500s +00.15500s
|`->config-resizefs ran successfully @02.92000s +00.03200s
|`->config-disk_setup ran successfully @02.95300s +00.00100s
|`->config-mounts ran successfully @02.95400s +00.00100s
|`->config-set_hostname ran successfully @02.95500s +00.00500s
|`->config-update_hostname ran successfully @02.96000s +00.00100s
|`->config-update_etc_hosts ran successfully @02.96200s +00.00000s
|`->config-ca-certs ran successfully @02.96200s +00.00100s
|`->config-rsyslog ran successfully @02.96300s +00.00100s
|`->config-users-groups ran successfully @02.96400s +00.01500s
|`->config-ssh ran successfully @02.97900s +00.24900s
Finished stage: (init-network) 00.65800 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @07.60900s +00.00000s
|`->config-snap ran successfully @07.60900s +00.00100s
|`->config-ssh-import-id ran successfully @07.61000s +00.94100s
|`->config-locale ran successfully @08.55200s +00.00100s
|`->config-set-passwords ran successfully @08.55300s +00.00200s
|`->config-grub-dpkg ran successfully @08.55500s +00.27800s
|`->config-apt-pipelining ran successfully @08.83500s +00.00100s
|`->config-apt-configure ran successfully @08.83600s +00.18100s
|`->config-ubuntu-advantage ran successfully @09.01700s +00.00100s
|`->config-ntp ran successfully @09.01800s +00.00100s
|`->config-timezone ran successfully @09.01900s +00.00000s
|`->config-disable-ec2-metadata ran successfully @09.02000s +00.00000s
|`->config-runcmd ran successfully @09.02000s +00.00100s
|`->config-byobu ran successfully @09.02100s +00.00100s
Finished stage: (modules-config) 01.43200 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @09.53600s +00.00100s
|`->config-fan ran successfully @09.53700s +00.00100s
|`->config-landscape ran successfully @09.53800s +00.00100s
|`->config-lxd ran successfully @09.53900s +00.00100s
|`->config-ubuntu-drivers ran successfully @09.54000s +00.00000s
|`->config-puppet ran successfully @09.54100s +00.00000s
|`->config-chef ran successfully @09.54200s +00.00000s
|`->config-mcollective ran successfully @09.54200s +00.00100s
|`->config-salt-minion ran successfully @09.54300s +00.00100s
|`->config-rightscale_userdata ran successfully @09.54400s +00.00100s
|`->config-scripts-vendor ran successfully @09.54500s +00.00100s
|`->config-scripts-per-once ran successfully @09.54600s +00.00000s
|`->config-scripts-per-boot ran successfully @09.54700s +00.00000s
|`->config-scripts-per-instance ran successfully @09.54700s +00.00100s
|`->config-scripts-user ran successfully @09.54800s +00.00000s
|`->config-ssh-authkey-fingerprints ran successfully @09.54900s +00.06600s
|`->config-keys-to-console ran successfully @09.61500s +00.08700s
|`->config-phone-home ran successfully @09.70300s +00.00100s
|`->config-final-message ran successfully @09.70400s +00.00400s
|`->config-power-state-change ran successfully @09.70800s +00.00100s
Finished stage: (modules-final) 00.19700 seconds

Total Time: 2.85100 seconds

1 boot records analyzed
+ '[' eoan = xenial ']'
+ echo '--- Expect success on bionic for jinja because deb DOES have jinja dep.'
--- Expect success on bionic for jinja because deb DOES have jinja dep.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com 'cloud-init query --format '\''cloud-region: {{cloud_name}}-{{region}}'\'''
cloud-region: aws-us-east-2
+ echo 'Per LP:1794399 expect we do not see a lot of killing dhclient logs'
Per LP:1794399 expect we do not see a lot of killing dhclient logs
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com 'grep dhclient /var/log/cloud-init.log'
2020-01-21 21:23:18,280 - util.py[DEBUG]: Copying /usr/sbin/dhclient to /var/tmp/cloud-init/cloud-init-dhcp-_b4l9krw/dhclient
2020-01-21 21:23:18,306 - util.py[DEBUG]: Running command ['/var/tmp/cloud-init/cloud-init-dhcp-_b4l9krw/dhclient', '-1', '-v', '-lf', '/var/tmp/cloud-init/cloud-init-dhcp-_b4l9krw/dhcp.leases', '-pf', '/var/tmp/cloud-init/cloud-init-dhcp-_b4l9krw/dhclient.pid', 'eth0', '-sf', '/bin/true'] with allowed return codes [0] (shell=False, capture=True)
2020-01-21 21:23:18,335 - util.py[DEBUG]: All files appeared after 0 seconds: ['/var/tmp/cloud-init/cloud-init-dhcp-_b4l9krw/dhclient.pid', '/var/tmp/cloud-init/cloud-init-dhcp-_b4l9krw/dhcp.leases']
2020-01-21 21:23:18,336 - util.py[DEBUG]: Reading from /var/tmp/cloud-init/cloud-init-dhcp-_b4l9krw/dhclient.pid (quiet=False)
2020-01-21 21:23:18,336 - util.py[DEBUG]: Read 4 bytes from /var/tmp/cloud-init/cloud-init-dhcp-_b4l9krw/dhclient.pid
2020-01-21 21:23:18,336 - dhcp.py[DEBUG]: killing dhclient with pid=408
+ echo 'Get cloud-id'
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com cloud-id
aws
+ echo 'Validating whether metadata is being updated per boot LP:1819913'
Validating whether metadata is being updated per boot LP:1819913
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2020-01-21 21:23:18,231 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com sudo reboot
+ sleep 60
+ echo 'After reboot'
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@ec2-18-218-249-209.us-east-2.compute.amazonaws.com 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2020-01-21 21:23:18,231 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-21 21:24:30,502 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
+ echo '### END eoan'
### END eoan
