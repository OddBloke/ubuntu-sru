#!/bin/sh
set -x
# Manually deploy on Azure using Azure CLI client.
# Validate upgrade to proposed version of cloud-init
# Check Tracebacks or error conditions on clean boot
 
# To be adapted to the SRU to test
SRU_SERIES="xenial bionic disco eoan"

# local values
# find region with az account list-locations -o table
REGION="eastus2"
VNET_NAME="sruVnet"
NETWORK_SECURITY_GROUP="sruNetSecGroup"
NIC_NAME="sruNic"
RESOURCE_GROUP="srugroupIPV6"
BOOT_DIAG="storeitsru"
SSH_KEY="$HOME/.ssh/id_rsa.pub"


IPV6_NET_REGISTERED=$(az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network | jq -r '.properties.state')
IPV6_CA_LB_REGISTERED=$(az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network | jq -r '.properties.state')

if [ "$IPV6_NET_REGISTERED" != "Registered" -o "$IPV6_CA_LB_REGISTERED" != "Registered" ]; then
    echo "Account is not yet registered for AllowIPv6VirtualNetwork or AllowIPv6CAOnStandardLB. Can take 30 mins. Activate feature now (y/n)?"
    read RESP
    if [ "$RESP" = "y" ]; then
        az feature register --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
        az feature register --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
    fi
    echo "Waiting for AllowIPv6VirtualNetwork freature registration"
    while [ "$IPV6_NET_REGISTERED" != "Registered" -o "$IPV6_CA_LB_REGISTERED" != "Registered" ]; do
        echo -n "."
        sleep 5
    IPV6_NET_REGISTERED=$(az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network | jq -r '.properties.state')
    IPV6_CA_LB_REGISTERED=$(az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network | jq -r '.properties.state')
    done
fi

IPV6_REGISTRATION_COMPLETE=$(az provider show -n Microsoft.Network | jq -r ".registrationState")
echo "Waiting for Microsoft.Network IPv6 feature registration"
while [ "$IPV6_REGISTRATION_COMPLETE"  != "Registered" ]; do
    echo -n "."
    sleep 5;
    IPV6_REGISTRATION_COMPLETE=$(az provider show -n Microsoft.Network | jq -r ".registrationState")
done


cat > sethostname.yaml <<EOF
## template: jinja
#cloud-config
ssh_import_id : [chad.smith]
hostname: SRU-worked-{{v1.cloud_name}}
EOF

cat > setup_proposed.sh <<EOF
#/bin/bash
mirror=http://archive.ubuntu.com/ubuntu
echo deb \$mirror \$(lsb_release -sc)-proposed main | tee /etc/apt/sources.list.d/proposed.list
apt-get update -q
apt-get install -qy cloud-init
EOF

az group create --name $RESOURCE_GROUP --location $REGION

if [ -n "${BOOT_DIAG}" ]; then
    az storage account create \
        --name $BOOT_DIAG \
        --resource-group $RESOURCE_GROUP \
        --location $REGION \
        --sku Standard_RAGRS \
        --kind StorageV2
    BOOT_DIAG_ARG="--boot-diagnostics-storage ${BOOT_DIAG}"
else
    BOOT_DIAG_ARG=""
fi

az network vnet create \
    --resource-group $RESOURCE_GROUP \
    --name $VNET_NAME \
    --address-prefixes "192.168.0.0/16" "ace:cab:deca::/48"

az network nsg create \
    --resource-group $RESOURCE_GROUP \
    --name $NETWORK_SECURITY_GROUP

az network vnet subnet create \
    --name sruSubnet \
    --resource-group $RESOURCE_GROUP \
    --vnet-name $VNET_NAME \
    --address-prefixes "192.168.0.0/24" "ace:cab:deca:deed::/64" \
    --network-security-group $NETWORK_SECURITY_GROUP

az network nsg rule create \
    --resource-group $RESOURCE_GROUP \
    --nsg-name $NETWORK_SECURITY_GROUP \
    --name Allow-SSH-Internet \
    --access Allow \
    --protocol Tcp \
    --direction Inbound \
    --priority 100 \
    --source-address-prefix "*" \
    --source-port-range "*" \
    --destination-address-prefix "*" \
    --destination-port-range 22


sshopts="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"
for series in $SRU_SERIES; do
    echo "### BEGIN $series"
    netcfg="/etc/netplan/50-cloud-init.yaml"
    case $series in
        xenial) image_version=16.04-DAILY-LTS
                netcfg="/etc/network/interfaces.d/50-cloud-init.cfg";;
        bionic) image_version=18.04-DAILY-LTS;;
        disco) image_version=19.04-DAILY;;
        eoan) image_version=19.10-DAILY;;
        *) echo "!! UPDATE FAMILY CASE STATEMENT !!"; exit 1;;
    esac
    # Note: accelerated network requires bigger size than our default DS1
    for nics in "" "--nics $NIC_NAME-$series --size Standard_DS2_v2"; do
        if [ "" = "$nics" ]; then
            echo "Creating standard network vm"
            name=test-sru-$series
        else
            echo "Creating advanced network vm"
            name=test-sru-$series-advanced
            az network public-ip create \
                --name sruPublicIP-IPv4-$series \
                --resource-group $RESOURCE_GROUP \
                --version IPv4
            az network public-ip create \
                --name sruPublicIP-IPv6-$series \
                --resource-group $RESOURCE_GROUP \
                --version IPv6
            az network nic create \
                --resource-group $RESOURCE_GROUP \
                --name $NIC_NAME-$series \
                --vnet-name $VNET_NAME \
                --subnet sruSubnet \
                --accelerated-networking true \
                --private-ip-address-version IPv4 \
                --public-ip-address sruPublicIP-IPv4-$series \
                --network-security-group $NETWORK_SECURITY_GROUP
        fi
        az vm create --name=$name \
            --image=Canonical:UbuntuServer:$image_version:latest \
            --admin-username=root --admin-username=ubuntu \
            -g $RESOURCE_GROUP --ssh-key-value $SSH_KEY \
            $BOOT_DIAG_ARG \
            --custom-data sethostname.yaml $nics
        IP=$(az vm list-ip-addresses --name $name | jq -r '.[] | .virtualMachine.network.publicIpAddresses[].ipAddress'| awk '{printf "ubuntu@%s", $1}')

    echo "Created $name: ubuntu@$IP"

        ssh $sshopts $IP -- cloud-init status --wait --long
        ssh $sshopts $IP -- dpkg-query --show cloud-init
        ssh $sshopts $IP -- sudo cat /run/cloud-init/result.json
        ssh $sshopts $IP -- grep Trace /var/log/cloud-init.log
        ssh $sshopts $IP -- systemd-analyze
        ssh $sshopts $IP -- systemd-analyze blame
        ssh $sshopts $IP -- cloud-init analyze show
        ssh $sshopts $IP -- cloud-init analyze blame
        echo 'Networking config'
        ssh $sshopts $IP -- cat $netcfg

        scp $sshopts setup_proposed.sh $IP:.
        ssh $sshopts $IP -- sudo bash ./setup_proposed.sh 2>&1 | egrep 'cloud-init'
        ssh $sshopts $IP -- dpkg-query --show cloud-init
        ssh $sshopts $IP -- sudo hostname SRU-didnt-work
        ssh $sshopts $IP -- sudo rm -f $netcfg
        if [ "" = "$nics" ]; then
            ssh $sshopts $IP -- sudo cloud-init clean --logs --reboot
        else
        echo "Shutting down instance and adding IPv6 config to nic"
        az vm stop --name=$name -g $RESOURCE_GROUP 
            az network nic ip-config create \
        --name $NIC_NAME-$series-IPv6Config \
        --nic-name $NIC_NAME-$series \
                --resource-group $RESOURCE_GROUP \
                --vnet-name $VNET_NAME \
                --subnet sruSubnet \
        --private-ip-address-version IPv6
        az vm start --name=$name -g $RESOURCE_GROUP 
    fi
        sleep 60

        ssh $sshopts $IP -- cloud-init status --wait --long
        ssh $sshopts $IP -- grep Trace /var/log/cloud-init\*
        ssh $sshopts $IP -- sudo cat /run/cloud-init/result.json
        ssh $sshopts $IP -- sudo systemd-analyze blame
        ssh $sshopts $IP -- cloud-init analyze show
        ssh $sshopts $IP -- cloud-init analyze blame
        echo 'After upgrade Networking config'
        ssh $sshopts $IP -- cat $netcfg
        ssh $sshopts $IP -- cloud-init query --format "'cloud-region: {{cloud_name}}-{{region}}'"
        echo 'Get cloud-id'
        ssh $sshopts $IP -- cloud-id
        ssh $sshopts $IP -- cloud-init query --format "'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'"
        echo 'Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot'
        ssh $sshopts $IP -- sudo reboot || true
        sleep 30
        ssh $sshopts $IP -- cloud-init status --wait --long
        echo 'After reboot'
        ssh $sshopts $IP -- "grep 'Update datasource' /var/log/cloud-init.log"
    done
    echo "### END $series"
done

==== BEGIN SRU Validation Output ====

# I ran this in two stages:
# First round was advanced networking with ipv6 addresses
# Second round was stock vms no ipv6

### First round. with ipv6 and advanced networking
+ SRU_SERIES=xenial bionic disco eoan
+ REGION=eastus2
+ VNET_NAME=sruVnet
+ NETWORK_SECURITY_GROUP=sruNetSecGroup
+ NIC_NAME=sruNic
+ RESOURCE_GROUP=srugroupIPV6
+ BOOT_DIAG=storeitsru
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
+ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ [ Registered != Registered -o Registered != Registered ]
+ az provider show -n Microsoft.Network
+ jq -r .registrationState
+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo Waiting for Microsoft.Network IPv6 feature registration
Waiting for Microsoft.Network IPv6 feature registration
+ [ Registered != Registered ]
+ cat
+ cat
+ az group create --name srugroupIPV6 --location eastus2
{
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6",
  "location": "eastus2",
  "managedBy": null,
  "name": "srugroupIPV6",
  "properties": {
    "provisioningState": "Succeeded"
  },
  "tags": null,
  "type": "Microsoft.Resources/resourceGroups"
}
+ [ -n storeitsru ]
+ az storage account create --name storeitsru --resource-group srugroupIPV6 --location eastus2 --sku Standard_RAGRS --kind StorageV2
WARNING: The default kind for created storage account will change to 'StorageV2' from 'Storage' in future
{
  "accessTier": "Hot",
  "azureFilesIdentityBasedAuthentication": null,
  "creationTime": "2019-12-05T23:39:49.203908+00:00",
  "customDomain": null,
  "enableHttpsTrafficOnly": true,
  "encryption": {
    "keySource": "Microsoft.Storage",
    "keyVaultProperties": null,
    "services": {
      "blob": {
        "enabled": true,
        "lastEnabledTime": "2019-12-05T23:39:49.282028+00:00"
      },
      "file": {
        "enabled": true,
        "lastEnabledTime": "2019-12-05T23:39:49.282028+00:00"
      },
      "queue": null,
      "table": null
    }
  },
  "failoverInProgress": null,
  "geoReplicationStats": null,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Storage/storageAccounts/storeitsru",
  "identity": null,
  "isHnsEnabled": null,
  "kind": "StorageV2",
  "largeFileSharesState": null,
  "lastGeoFailoverTime": null,
  "location": "eastus2",
  "name": "storeitsru",
  "networkRuleSet": {
    "bypass": "AzureServices",
    "defaultAction": "Allow",
    "ipRules": [],
    "virtualNetworkRules": []
  },
  "primaryEndpoints": {
    "blob": "https://storeitsru.blob.core.windows.net/",
    "dfs": "https://storeitsru.dfs.core.windows.net/",
    "file": "https://storeitsru.file.core.windows.net/",
    "queue": "https://storeitsru.queue.core.windows.net/",
    "table": "https://storeitsru.table.core.windows.net/",
    "web": "https://storeitsru.z20.web.core.windows.net/"
  },
  "primaryLocation": "eastus2",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "secondaryEndpoints": {
    "blob": "https://storeitsru-secondary.blob.core.windows.net/",
    "dfs": "https://storeitsru-secondary.dfs.core.windows.net/",
    "file": null,
    "queue": "https://storeitsru-secondary.queue.core.windows.net/",
    "table": "https://storeitsru-secondary.table.core.windows.net/",
    "web": "https://storeitsru-secondary.z20.web.core.windows.net/"
  },
  "secondaryLocation": "centralus",
  "sku": {
    "capabilities": null,
    "kind": null,
    "locations": null,
    "name": "Standard_RAGRS",
    "resourceType": null,
    "restrictions": null,
    "tier": "Standard"
  },
  "statusOfPrimary": "available",
  "statusOfSecondary": "available",
  "tags": {},
  "type": "Microsoft.Storage/storageAccounts"
}
+ BOOT_DIAG_ARG=--boot-diagnostics-storage storeitsru
+ az network vnet create --resource-group srugroupIPV6 --name sruVnet --address-prefixes 192.168.0.0/16 ace:cab:deca::/48
{
  "newVNet": {
    "addressSpace": {
      "addressPrefixes": [
        "192.168.0.0/16",
        "ace:cab:deca::/48"
      ]
    },
    "ddosProtectionPlan": null,
    "dhcpOptions": {
      "dnsServers": []
    },
    "enableDdosProtection": false,
    "enableVmProtection": false,
    "etag": "W/\"8873c0e1-eac4-464d-b246-324428f44d34\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet",
    "location": "eastus2",
    "name": "sruVnet",
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "0a476a33-a0ae-4d90-ad3e-e04789616c14",
    "subnets": [],
    "tags": {},
    "type": "Microsoft.Network/virtualNetworks",
    "virtualNetworkPeerings": []
  }
}
+ az network nsg create --resource-group srugroupIPV6 --name sruNetSecGroup
{
  "NewNSG": {
    "defaultSecurityRules": [
      {
        "access": "Allow",
        "description": "Allow inbound traffic from all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"e79849c4-75e6-439b-9470-c66114acb0c0\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetInBound",
        "name": "AllowVnetInBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow inbound traffic from azure load balancer",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"e79849c4-75e6-439b-9470-c66114acb0c0\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowAzureLoadBalancerInBound",
        "name": "AllowAzureLoadBalancerInBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "AzureLoadBalancer",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all inbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"e79849c4-75e6-439b-9470-c66114acb0c0\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllInBound",
        "name": "DenyAllInBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"e79849c4-75e6-439b-9470-c66114acb0c0\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetOutBound",
        "name": "AllowVnetOutBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to Internet",
        "destinationAddressPrefix": "Internet",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"e79849c4-75e6-439b-9470-c66114acb0c0\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowInternetOutBound",
        "name": "AllowInternetOutBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all outbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"e79849c4-75e6-439b-9470-c66114acb0c0\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllOutBound",
        "name": "DenyAllOutBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      }
    ],
    "etag": "W/\"e79849c4-75e6-439b-9470-c66114acb0c0\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": "eastus2",
    "name": "sruNetSecGroup",
    "networkInterfaces": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "1cbe10a3-b34d-4f03-b20e-d03d03f29e70",
    "securityRules": [],
    "subnets": null,
    "tags": null,
    "type": "Microsoft.Network/networkSecurityGroups"
  }
}
+ az network vnet subnet create --name sruSubnet --resource-group srugroupIPV6 --vnet-name sruVnet --address-prefixes 192.168.0.0/24 ace:cab:deca:deed::/64 --network-security-group sruNetSecGroup
{
  "addressPrefix": null,
  "addressPrefixes": [
    "192.168.0.0/24",
    "ace:cab:deca:deed::/64"
  ],
  "delegations": [],
  "etag": "W/\"d6217db1-9535-44e0-918b-e0f2fffdf9b6\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
  "ipConfigurationProfiles": null,
  "ipConfigurations": null,
  "name": "sruSubnet",
  "natGateway": null,
  "networkSecurityGroup": {
    "defaultSecurityRules": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": null,
    "name": null,
    "networkInterfaces": null,
    "provisioningState": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": null,
    "securityRules": null,
    "subnets": null,
    "tags": null,
    "type": null
  },
  "privateEndpointNetworkPolicies": "Enabled",
  "privateEndpoints": null,
  "privateLinkServiceNetworkPolicies": "Enabled",
  "provisioningState": "Succeeded",
  "purpose": null,
  "resourceGroup": "srugroupIPV6",
  "resourceNavigationLinks": null,
  "routeTable": null,
  "serviceAssociationLinks": null,
  "serviceEndpointPolicies": null,
  "serviceEndpoints": null,
  "type": "Microsoft.Network/virtualNetworks/subnets"
}
+ az network nsg rule create --resource-group srugroupIPV6 --nsg-name sruNetSecGroup --name Allow-SSH-Internet --access Allow --protocol Tcp --direction Inbound --priority 100 --source-address-prefix * --source-port-range * --destination-address-prefix * --destination-port-range 22
{
  "access": "Allow",
  "description": null,
  "destinationAddressPrefix": "*",
  "destinationAddressPrefixes": [],
  "destinationApplicationSecurityGroups": null,
  "destinationPortRange": "22",
  "destinationPortRanges": [],
  "direction": "Inbound",
  "etag": "W/\"03bc60b7-e988-454d-87f2-66cf7f222606\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/securityRules/Allow-SSH-Internet",
  "name": "Allow-SSH-Internet",
  "priority": 100,
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "sourceAddressPrefix": "*",
  "sourceAddressPrefixes": [],
  "sourceApplicationSecurityGroups": null,
  "sourcePortRange": "*",
  "sourcePortRanges": [],
  "type": "Microsoft.Network/networkSecurityGroups/securityRules"
}
+ sshopts=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR
+ echo ### BEGIN xenial
### BEGIN xenial
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=16.04-DAILY-LTS
+ netcfg=/etc/network/interfaces.d/50-cloud-init.cfg
+ [  = --nics sruNic-xenial --size Standard_DS2_v2 ]
+ echo Creating advanced network vm
Creating advanced network vm
+ name=test-sru-xenial-advanced
+ az network public-ip create --name sruPublicIP-IPv4-xenial --resource-group srugroupIPV6 --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"6258862d-32e6-4bc8-b605-03b53b3999d7\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-xenial",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv4-xenial",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "eee92547-433d-45fa-980e-81f68a641228",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name sruPublicIP-IPv6-xenial --resource-group srugroupIPV6 --version IPv6
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"a686b0a4-8582-452c-abb8-5eef1c72fb1d\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv6-xenial",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv6-xenial",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv6",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "282518f2-7c81-4d69-8ca9-f25d6e1943d1",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network nic create --resource-group srugroupIPV6 --name sruNic-xenial --vnet-name sruVnet --subnet sruSubnet --accelerated-networking true --private-ip-address-version IPv4 --public-ip-address sruPublicIP-IPv4-xenial --network-security-group sruNetSecGroup
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "gnveocvoucie1lj42bdysylmce.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"fcfbdcd0-07c7-4556-af46-236f1517e227\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-xenial",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"fcfbdcd0-07c7-4556-af46-236f1517e227\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-xenial/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "192.168.0.4",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": {
          "ddosSettings": null,
          "dnsSettings": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-xenial",
          "idleTimeoutInMinutes": null,
          "ipAddress": null,
          "ipConfiguration": null,
          "ipTags": null,
          "location": null,
          "name": null,
          "provisioningState": null,
          "publicIpAddressVersion": null,
          "publicIpAllocationMethod": null,
          "publicIpPrefix": null,
          "resourceGroup": "srugroupIPV6",
          "resourceGuid": null,
          "sku": null,
          "tags": null,
          "type": null,
          "zones": null
        },
        "resourceGroup": "srugroupIPV6",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroupIPV6",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic-xenial",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroupIPV6",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "323d3c17-e01e-4bae-81ee-a824a6d970ee",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az vm create --name=test-sru-xenial-advanced --image=Canonical:UbuntuServer:16.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml --nics sruNic-xenial --size Standard_DS2_v2
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-xenial-advanced",
  "location": "eastus2",
  "macAddress": "00-0D-3A-04-ED-A4",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.4",
  "publicIpAddress": "104.208.141.135",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-xenial-advanced
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@104.208.141.135
+ echo Created test-sru-xenial-advanced: ubuntu@ubuntu@104.208.141.135
Created test-sru-xenial-advanced: ubuntu@ubuntu@104.208.141.135
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- cloud-init status --wait --long

status: done
time: Thu, 05 Dec 2019 23:44:13 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- dpkg-query --show cloud-init
cloud-init    19.2-36-g059d049c-0ubuntu2~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- systemd-analyze
Startup finished in 4.714s (kernel) + 1min 1.698s (userspace) = 1min 6.412s
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- systemd-analyze blame
         43.555s cloud-init-local.service
          5.963s cloud-init.service
          3.417s cloud-config.service
          2.656s snapd.service
          2.322s pollinate.service
          2.300s lxd-containers.service
          2.033s snapd.seeded.service
          1.821s dev-sda1.device
          1.365s accounts-daemon.service
           929ms apparmor.service
           806ms mdadm.service
           681ms networking.service
           617ms cloud-final.service
           512ms lvm2-monitor.service
           477ms open-iscsi.service
           438ms grub-common.service
           428ms iscsid.service
           339ms systemd-modules-load.service
           339ms systemd-logind.service
           334ms rsyslog.service
           310ms rc-local.service
           279ms systemd-tmpfiles-setup-dev.service
           215ms console-setup.service
           214ms systemd-journald.service
           206ms systemd-timesyncd.service
           143ms systemd-udevd.service
           136ms systemd-random-seed.service
           133ms systemd-udev-trigger.service
           132ms irqbalance.service
           120ms systemd-journal-flush.service
           115ms ssh.service
           101ms systemd-update-utmp.service
            99ms polkitd.service
            94ms apport.service
            92ms ondemand.service
            86ms keyboard-setup.service
            77ms resolvconf.service
            56ms dev-hugepages.mount
            54ms ufw.service
            54ms systemd-sysctl.service
            51ms systemd-machine-id-commit.service
            50ms plymouth-read-write.service
            50ms systemd-tmpfiles-setup.service
            49ms setvtrgb.service
            49ms systemd-remount-fs.service
            49ms kmod-static-nodes.service
            43ms snapd.socket
            38ms lxd.socket
            33ms systemd-user-sessions.service
            30ms dev-mqueue.mount
            27ms boot-efi.mount
            24ms plymouth-quit.service
            21ms user@1000.service
            17ms sys-fs-fuse-connections.mount
            14ms ephemeral-disk-warning.service
            12ms plymouth-quit-wait.service
             9ms sys-kernel-config.mount
             9ms sys-kernel-debug.mount
             7ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.01900s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.15300s +00.00600s
|`->get_boot_telemetry @00.15900s +00.01000s
|`->get_system_info @00.16900s +00.00200s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.17100s +00.04200s
|`->load_azure_ds_dir @00.21300s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.32700s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.32800s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.01100 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.35600s +40.13500s
|`->_get_metadata_from_imds @40.49100s +00.03500s
Finished stage: (azure-ds/get_metadata_from_imds) 40.22800 seconds

|`->_get_random_seed @40.58400s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 40.42100 seconds

|`->write_files @40.59300s +00.00200s
Finished stage: (azure-ds/_get_data) 40.44300 seconds

Finished stage: (init-local/search-Azure) 40.44600 seconds

|`->network config from fallback @40.65800s +00.02500s
Finished stage: (init-local) 40.69800 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @41.76000s +00.02300s
|`->network config from fallback @41.83900s +00.01200s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @41.86100s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

|`->invoke_agent @41.86400s +00.16100s
|`->wait for agents to retrieve ssh keys @42.02600s +01.00200s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @43.02900s +00.03600s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.03600 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 01.20400 seconds

Finished stage: (azure-ds/_negotiate) 01.20600 seconds

Finished stage: (azure-ds/setup) 01.20600 seconds

Finished stage: (init-network/setup-datasource) 01.20600 seconds

|`->reading and applying user-data @43.07500s +00.00800s
|`->reading and applying vendor-data @43.08300s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @43.11600s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @43.11700s +00.03700s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @43.22800s +00.00200s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.09300 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.13100 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.13200 seconds

Finished stage: (azure-ds/activate) 00.13300 seconds

Finished stage: (init-network/activate-datasource) 00.13500 seconds

|`->config-migrator ran successfully @43.32300s +00.00100s
|`->config-seed_random ran successfully @43.32400s +00.00200s
|`->config-bootcmd ran successfully @43.32600s +00.00000s
|`->config-write-files ran successfully @43.32700s +00.00100s
|`->config-growpart ran successfully @43.32900s +00.40700s
|`->config-resizefs ran successfully @43.73600s +00.24000s
|`->config-disk_setup ran successfully @43.97700s +02.40900s
|`->config-mounts ran successfully @46.38700s +00.09400s
|`->config-set_hostname ran successfully @46.48200s +00.00600s
|`->config-update_hostname ran successfully @46.48800s +00.00200s
|`->config-update_etc_hosts ran successfully @46.49100s +00.00000s
|`->config-ca-certs ran successfully @46.49100s +00.00200s
|`->config-rsyslog ran successfully @46.49300s +00.00100s
|`->config-users-groups ran successfully @46.49500s +00.31600s
|`->config-ssh ran successfully @46.81200s +00.28000s
Finished stage: (init-network) 05.34400 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @52.63600s +00.00000s
|`->config-snap ran successfully @52.63700s +00.00100s
|`->config-snap_config ran successfully @52.63800s +00.00100s
|`->config-ssh-import-id ran successfully @52.64000s +00.69000s
|`->config-locale ran successfully @53.33100s +01.22500s
|`->config-set-passwords ran successfully @54.55700s +00.00200s
|`->config-grub-dpkg ran successfully @54.55900s +00.86700s
|`->config-apt-pipelining ran successfully @55.42700s +00.00100s
|`->config-apt-configure ran successfully @55.42900s +00.18500s
|`->config-ubuntu-advantage ran successfully @55.61400s +00.00200s
|`->config-ntp ran successfully @55.61600s +00.00200s
|`->config-timezone ran successfully @55.61800s +00.00100s
|`->config-disable-ec2-metadata ran successfully @55.62000s +00.00000s
|`->config-runcmd ran successfully @55.62000s +00.00300s
|`->config-byobu ran successfully @55.62300s +00.00100s
Finished stage: (modules-config) 03.01900 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @56.09500s +00.00300s
|`->config-package-update-upgrade-install ran successfully @56.09800s +00.00100s
|`->config-fan ran successfully @56.10000s +00.00100s
|`->config-landscape ran successfully @56.10100s +00.00100s
|`->config-lxd ran successfully @56.10300s +00.00100s
|`->config-ubuntu-drivers ran successfully @56.10400s +00.00100s
|`->config-puppet ran successfully @56.10600s +00.00100s
|`->config-chef ran successfully @56.10700s +00.00100s
|`->config-mcollective ran successfully @56.10800s +00.00100s
|`->config-salt-minion ran successfully @56.11000s +00.00100s
|`->config-rightscale_userdata ran successfully @56.11100s +00.00100s
|`->config-scripts-vendor ran successfully @56.11300s +00.00100s
|`->config-scripts-per-once ran successfully @56.11400s +00.00100s
|`->config-scripts-per-boot ran successfully @56.11600s +00.00000s
|`->config-scripts-per-instance ran successfully @56.11700s +00.00100s
|`->config-scripts-user ran successfully @56.11800s +00.02000s
|`->config-ssh-authkey-fingerprints ran successfully @56.13900s +00.03800s
|`->config-keys-to-console ran successfully @56.17700s +00.07100s
|`->config-phone-home ran successfully @56.24800s +00.00200s
|`->config-final-message ran successfully @56.25000s +00.00400s
|`->config-power-state-change ran successfully @56.25500s +00.00100s
Finished stage: (modules-final) 00.20900 seconds

Total Time: 216.31800 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- cloud-init analyze blame
-- Boot Record 01 --
     40.13500s (azure-ds/obtain-dhcp-lease)
     02.40900s (init-network/config-disk_setup)
     01.22500s (modules-config/config-locale)
     01.00200s (azure-ds/waiting-for-ssh-public-key)
     00.86700s (modules-config/config-grub-dpkg)
     00.69000s (modules-config/config-ssh-import-id)
     00.40700s (init-network/config-growpart)
     00.31600s (init-network/config-users-groups)
     00.28000s (init-network/config-ssh)
     00.24000s (init-network/config-resizefs)
     00.18500s (modules-config/config-apt-configure)
     00.16100s (azure-ds/invoke_agent)
     00.09400s (init-network/config-mounts)
     00.07100s (modules-final/config-keys-to-console)
     00.04200s (azure-ds/list_possible_azure_ds_devs)
     00.03800s (modules-final/config-ssh-authkey-fingerprints)
     00.03700s (azure-ds/_has_ntfs_filesystem)
     00.03600s (azure-ds/crtfile_to_pubkey)
     00.03500s (azure-ds/_get_metadata_from_imds)
     00.02500s (azure-ds/parse_network_config)
     00.02300s (init-network/check-cache)
     00.02000s (modules-final/config-scripts-user)
     00.01200s (azure-ds/parse_network_config)
     00.01000s (azure-ds/get_boot_telemetry)
     00.00800s (init-network/consume-user-data)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/check-platform-viability)
     00.00400s (modules-final/config-final-message)
     00.00300s (modules-final/config-snappy)
     00.00300s (modules-config/config-runcmd)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-config/config-ubuntu-advantage)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-ntp)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (init-network/config-ca-certs)
     00.00200s (azure-ds/write_files)
     00.00200s (azure-ds/get_system_info)
     00.00200s (azure-ds/count_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Networking config
Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
# This file is generated from information provided by
# the datasource.  Changes to it will not persist across an instance.
# To disable cloud-init's network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@104.208.141.135:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- sudo bash ./setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu xenial-proposed/main amd64 cloud-init all 19.3-41-gc4735dd3-0ubuntu1~16.04.1 [414 kB]
Preparing to unpack .../cloud-init_19.3-41-gc4735dd3-0ubuntu1~16.04.1_all.deb ...
Unpacking cloud-init (19.3-41-gc4735dd3-0ubuntu1~16.04.1) over (19.2-36-g059d049c-0ubuntu2~16.04.1) ...
Setting up cloud-init (19.3-41-gc4735dd3-0ubuntu1~16.04.1) ...
Leaving 'diversion of /etc/init/ureadahead.conf to /etc/init/ureadahead.conf.disabled by cloud-init'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- dpkg-query --show cloud-init
cloud-init    19.3-41-gc4735dd3-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- sudo hostname SRU-didnt-work
sudo: unable to resolve host SRU-worked-azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- sudo rm -f /etc/network/interfaces.d/50-cloud-init.cfg
sudo: unable to resolve host SRU-didnt-work
+ [  = --nics sruNic-xenial --size Standard_DS2_v2 ]
+ echo Shutting down instance and adding IPv6 config to nic
Shutting down instance and adding IPv6 config to nic
+ az vm stop --name=test-sru-xenial-advanced -g srugroupIPV6
WARNING: About to power off the specified VM...
It will continue to be billed. To deallocate a VM, run: az vm deallocate.
+ az network nic ip-config create --name sruNic-xenial-IPv6Config --nic-name sruNic-xenial --resource-group srugroupIPV6 --vnet-name sruVnet --subnet sruSubnet --private-ip-address-version IPv6
{
  "applicationGatewayBackendAddressPools": null,
  "applicationSecurityGroups": null,
  "etag": "W/\"f525fabd-2217-4333-bb23-857a5a7395a8\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-xenial/ipConfigurations/sruNic-xenial-IPv6Config",
  "loadBalancerBackendAddressPools": null,
  "loadBalancerInboundNatRules": null,
  "name": "sruNic-xenial-IPv6Config",
  "primary": null,
  "privateIpAddress": "ace:cab:deca:deed::4",
  "privateIpAddressVersion": "IPv6",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": null,
  "resourceGroup": "srugroupIPV6",
  "subnet": {
    "addressPrefix": null,
    "addressPrefixes": null,
    "delegations": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
    "ipConfigurationProfiles": null,
    "ipConfigurations": null,
    "name": null,
    "natGateway": null,
    "networkSecurityGroup": null,
    "privateEndpointNetworkPolicies": null,
    "privateEndpoints": null,
    "privateLinkServiceNetworkPolicies": null,
    "provisioningState": null,
    "purpose": null,
    "resourceGroup": "srugroupIPV6",
    "resourceNavigationLinks": null,
    "routeTable": null,
    "serviceAssociationLinks": null,
    "serviceEndpointPolicies": null,
    "serviceEndpoints": null
  },
  "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
  "virtualNetworkTaps": null
}
+ az vm start --name=test-sru-xenial-advanced -g srugroupIPV6
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- cloud-init status --wait --long

status: done
time: Thu, 05 Dec 2019 23:47:24 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- sudo systemd-analyze blame
sudo: unable to resolve host SRU-worked-azure
          3.252s cloud-init.service
          1.892s cloud-init-local.service
           820ms dev-sda1.device
           742ms snapd.service
           593ms networking.service
           541ms lxd-containers.service
           541ms cloud-config.service
           511ms accounts-daemon.service
           441ms cloud-final.service
           389ms ssh.service
           381ms grub-common.service
           324ms apparmor.service
           259ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
           241ms mdadm.service
           236ms irqbalance.service
           218ms systemd-timesyncd.service
           182ms lvm2-monitor.service
           181ms apport.service
           176ms iscsid.service
           151ms mnt.mount
           147ms open-iscsi.service
           147ms console-setup.service
           102ms ufw.service
           100ms systemd-remount-fs.service
            99ms systemd-udev-trigger.service
            99ms rsyslog.service
            98ms resolvconf.service
            98ms kmod-static-nodes.service
            96ms systemd-modules-load.service
            95ms keyboard-setup.service
            92ms systemd-journald.service
            92ms sys-kernel-debug.mount
            91ms dev-mqueue.mount
            88ms rc-local.service
            85ms systemd-logind.service
            77ms systemd-journal-flush.service
            75ms setvtrgb.service
            74ms dev-hugepages.mount
            71ms polkitd.service
            70ms ondemand.service
            58ms systemd-update-utmp.service
            55ms snapd.seeded.service
            46ms snapd.socket
            45ms systemd-user-sessions.service
            44ms lxd.socket
            43ms systemd-sysctl.service
            43ms systemd-random-seed.service
            41ms sys-fs-fuse-connections.mount
            38ms systemd-tmpfiles-setup-dev.service
            37ms sys-kernel-config.mount
            34ms systemd-udevd.service
            33ms systemd-tmpfiles-setup.service
            23ms plymouth-read-write.service
            21ms systemd-update-utmp-runlevel.service
            19ms user@1000.service
            17ms plymouth-quit.service
            14ms plymouth-quit-wait.service
            12ms boot-efi.mount
            10ms ephemeral-disk-warning.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.01900s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.15300s +00.00600s
|`->get_boot_telemetry @00.15900s +00.01000s
|`->get_system_info @00.16900s +00.00200s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.17100s +00.04200s
|`->load_azure_ds_dir @00.21300s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.32700s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.32800s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.01100 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.35600s +40.13500s
|`->_get_metadata_from_imds @40.49100s +00.03500s
Finished stage: (azure-ds/get_metadata_from_imds) 40.22800 seconds

|`->_get_random_seed @40.58400s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 40.42100 seconds

|`->write_files @40.59300s +00.00200s
Finished stage: (azure-ds/_get_data) 40.44300 seconds

Finished stage: (init-local/search-Azure) 40.44600 seconds

|`->network config from fallback @40.65800s +00.02500s
Finished stage: (init-local) 40.69800 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @41.76000s +00.02300s
|`->network config from fallback @41.83900s +00.01200s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @41.86100s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

|`->invoke_agent @41.86400s +00.16100s
|`->wait for agents to retrieve ssh keys @42.02600s +01.00200s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @43.02900s +00.03600s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.03600 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 01.20400 seconds

Finished stage: (azure-ds/_negotiate) 01.20600 seconds

Finished stage: (azure-ds/setup) 01.20600 seconds

Finished stage: (init-network/setup-datasource) 01.20600 seconds

|`->reading and applying user-data @43.07500s +00.00800s
|`->reading and applying vendor-data @43.08300s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @43.11600s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @43.11700s +00.03700s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @43.22800s +00.00200s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.09300 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.13100 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.13200 seconds

Finished stage: (azure-ds/activate) 00.13300 seconds

Finished stage: (init-network/activate-datasource) 00.13500 seconds

|`->config-migrator ran successfully @43.32300s +00.00100s
|`->config-seed_random ran successfully @43.32400s +00.00200s
|`->config-bootcmd ran successfully @43.32600s +00.00000s
|`->config-write-files ran successfully @43.32700s +00.00100s
|`->config-growpart ran successfully @43.32900s +00.40700s
|`->config-resizefs ran successfully @43.73600s +00.24000s
|`->config-disk_setup ran successfully @43.97700s +02.40900s
|`->config-mounts ran successfully @46.38700s +00.09400s
|`->config-set_hostname ran successfully @46.48200s +00.00600s
|`->config-update_hostname ran successfully @46.48800s +00.00200s
|`->config-update_etc_hosts ran successfully @46.49100s +00.00000s
|`->config-ca-certs ran successfully @46.49100s +00.00200s
|`->config-rsyslog ran successfully @46.49300s +00.00100s
|`->config-users-groups ran successfully @46.49500s +00.31600s
|`->config-ssh ran successfully @46.81200s +00.28000s
Finished stage: (init-network) 05.34400 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @52.63600s +00.00000s
|`->config-snap ran successfully @52.63700s +00.00100s
|`->config-snap_config ran successfully @52.63800s +00.00100s
|`->config-ssh-import-id ran successfully @52.64000s +00.69000s
|`->config-locale ran successfully @53.33100s +01.22500s
|`->config-set-passwords ran successfully @54.55700s +00.00200s
|`->config-grub-dpkg ran successfully @54.55900s +00.86700s
|`->config-apt-pipelining ran successfully @55.42700s +00.00100s
|`->config-apt-configure ran successfully @55.42900s +00.18500s
|`->config-ubuntu-advantage ran successfully @55.61400s +00.00200s
|`->config-ntp ran successfully @55.61600s +00.00200s
|`->config-timezone ran successfully @55.61800s +00.00100s
|`->config-disable-ec2-metadata ran successfully @55.62000s +00.00000s
|`->config-runcmd ran successfully @55.62000s +00.00300s
|`->config-byobu ran successfully @55.62300s +00.00100s
Finished stage: (modules-config) 03.01900 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @56.09500s +00.00300s
|`->config-package-update-upgrade-install ran successfully @56.09800s +00.00100s
|`->config-fan ran successfully @56.10000s +00.00100s
|`->config-landscape ran successfully @56.10100s +00.00100s
|`->config-lxd ran successfully @56.10300s +00.00100s
|`->config-ubuntu-drivers ran successfully @56.10400s +00.00100s
|`->config-puppet ran successfully @56.10600s +00.00100s
|`->config-chef ran successfully @56.10700s +00.00100s
|`->config-mcollective ran successfully @56.10800s +00.00100s
|`->config-salt-minion ran successfully @56.11000s +00.00100s
|`->config-rightscale_userdata ran successfully @56.11100s +00.00100s
|`->config-scripts-vendor ran successfully @56.11300s +00.00100s
|`->config-scripts-per-once ran successfully @56.11400s +00.00100s
|`->config-scripts-per-boot ran successfully @56.11600s +00.00000s
|`->config-scripts-per-instance ran successfully @56.11700s +00.00100s
|`->config-scripts-user ran successfully @56.11800s +00.02000s
|`->config-ssh-authkey-fingerprints ran successfully @56.13900s +00.03800s
|`->config-keys-to-console ran successfully @56.17700s +00.07100s
|`->config-phone-home ran successfully @56.24800s +00.00200s
|`->config-final-message ran successfully @56.25000s +00.00400s
|`->config-power-state-change ran successfully @56.25500s +00.00100s
Finished stage: (modules-final) 00.20900 seconds

Total Time: 216.31800 seconds

-- Boot Record 02 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03200s +00.00700s
|`->get_boot_telemetry @00.03900s +00.01000s
|`->get_system_info @00.04900s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.05000s +00.20700s
|`->load_azure_ds_dir @00.25700s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.26100s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.26200s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.27700s +00.16200s
|`->_get_metadata_from_imds @00.43900s +00.01600s
Finished stage: (azure-ds/get_metadata_from_imds) 00.24800 seconds

|`->_get_random_seed @00.52500s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.48500 seconds

|`->write_files @00.53500s +00.00300s
Finished stage: (azure-ds/_get_data) 00.50600 seconds

Finished stage: (init-local/search-Azure) 00.50900 seconds

|`->network config from fallback @00.60100s +00.01100s
Total Time: 1.75500 seconds

-- Boot Record 03 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.00100s +00.00800s
|`->get_boot_telemetry @00.00900s +00.01000s
|`->get_system_info @00.01900s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.02000s +00.19300s
|`->load_azure_ds_dir @00.21300s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.21500s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.21600s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00200 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00200 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.21700s +00.25900s
|`->_get_metadata_from_imds @00.47700s +00.00600s
Finished stage: (azure-ds/get_metadata_from_imds) 00.31900 seconds

|`->_get_random_seed @00.53600s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.52500 seconds

|`->write_files @00.54500s +00.00300s
Finished stage: (azure-ds/_get_data) 00.54800 seconds

|`->network config from fallback @00.55200s +00.02400s
Finished stage: (init-local) 01.20500 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @01.56500s +00.02300s
|`->network config from fallback @01.64500s +00.01900s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @01.67600s +00.00000s
|`->perform_hostname_bounce @01.69300s +02.28400s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 02.30400 seconds

|`->invoke_agent @03.98000s +00.15500s
|`->wait for agents to retrieve ssh keys @04.13600s +00.00000s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @04.13600s +00.01200s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.01200 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 02.47300 seconds

Finished stage: (azure-ds/_negotiate) 02.47400 seconds

Finished stage: (azure-ds/setup) 02.47400 seconds

Finished stage: (init-network/setup-datasource) 02.47400 seconds

|`->reading and applying user-data @04.15500s +00.01100s
|`->reading and applying vendor-data @04.16600s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @04.19700s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @04.19800s +00.10700s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.10700 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.10800 seconds

Finished stage: (azure-ds/activate) 00.10800 seconds

Finished stage: (init-network/activate-datasource) 00.11700 seconds

|`->config-migrator ran successfully @04.34800s +00.00100s
|`->config-seed_random previously ran @04.35000s +00.00000s
|`->config-bootcmd ran successfully @04.35000s +00.00100s
|`->config-write-files previously ran @04.35100s +00.00100s
|`->config-growpart ran successfully @04.35200s +00.03600s
|`->config-resizefs ran successfully @04.38900s +00.01700s
|`->config-disk_setup previously ran @04.40600s +00.00100s
|`->config-mounts previously ran @04.40700s +00.00000s
|`->config-set_hostname previously ran @04.40700s +00.00100s
|`->config-update_hostname ran successfully @04.40800s +00.00100s
|`->config-update_etc_hosts ran successfully @04.41000s +00.00000s
|`->config-ca-certs previously ran @04.41100s +00.00000s
|`->config-rsyslog previously ran @04.41200s +00.00000s
|`->config-users-groups previously ran @04.41300s +00.00000s
|`->config-ssh previously ran @04.41300s +00.00100s
Finished stage: (init-network) 02.86100 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @05.94000s +00.00000s
|`->config-snap previously ran @05.94100s +00.00000s
|`->config-snap_config previously ran @05.94200s +00.00000s
|`->config-ssh-import-id previously ran @05.94200s +00.00100s
|`->config-locale previously ran @05.94300s +00.00000s
|`->config-set-passwords previously ran @05.94400s +00.00000s
|`->config-grub-dpkg previously ran @05.94500s +00.00000s
|`->config-apt-pipelining previously ran @05.94500s +00.00000s
|`->config-apt-configure previously ran @05.94600s +00.00000s
|`->config-ubuntu-advantage previously ran @05.94700s +00.00000s
|`->config-ntp previously ran @05.94800s +00.00000s
|`->config-timezone previously ran @05.94800s +00.00100s
|`->config-disable-ec2-metadata ran successfully @05.94900s +00.00000s
|`->config-runcmd previously ran @05.95000s +00.00000s
|`->config-byobu previously ran @05.95000s +00.00100s
Finished stage: (modules-config) 00.02700 seconds

Starting stage: modules-final
|`->config-snappy previously ran @06.39900s +00.00100s
|`->config-package-update-upgrade-install previously ran @06.40000s +00.00000s
|`->config-fan previously ran @06.40100s +00.00000s
|`->config-landscape previously ran @06.40200s +00.00000s
|`->config-lxd previously ran @06.40300s +00.00000s
|`->config-ubuntu-drivers previously ran @06.40300s +00.00100s
|`->config-puppet previously ran @06.40400s +00.00000s
|`->config-chef previously ran @06.40500s +00.00000s
|`->config-mcollective previously ran @06.40600s +00.00000s
|`->config-salt-minion previously ran @06.40600s +00.00100s
|`->config-rightscale_userdata previously ran @06.40700s +00.00000s
|`->config-scripts-vendor previously ran @06.40800s +00.00000s
|`->config-scripts-per-once previously ran @06.40900s +00.00000s
|`->config-scripts-per-boot ran successfully @06.41000s +00.00000s
|`->config-scripts-per-instance previously ran @06.41100s +00.00000s
|`->config-scripts-user previously ran @06.41200s +00.00000s
|`->config-ssh-authkey-fingerprints previously ran @06.41200s +00.00100s
|`->config-keys-to-console previously ran @06.41300s +00.00000s
|`->config-phone-home previously ran @06.41400s +00.00000s
|`->config-final-message ran successfully @06.41400s +00.00500s
|`->config-power-state-change previously ran @06.41900s +00.00000s
Finished stage: (modules-final) 00.03800 seconds

Total Time: 18.17800 seconds

3 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- cloud-init analyze blame
-- Boot Record 01 --
     40.13500s (azure-ds/obtain-dhcp-lease)
     02.40900s (init-network/config-disk_setup)
     01.22500s (modules-config/config-locale)
     01.00200s (azure-ds/waiting-for-ssh-public-key)
     00.86700s (modules-config/config-grub-dpkg)
     00.69000s (modules-config/config-ssh-import-id)
     00.40700s (init-network/config-growpart)
     00.31600s (init-network/config-users-groups)
     00.28000s (init-network/config-ssh)
     00.24000s (init-network/config-resizefs)
     00.18500s (modules-config/config-apt-configure)
     00.16100s (azure-ds/invoke_agent)
     00.09400s (init-network/config-mounts)
     00.07100s (modules-final/config-keys-to-console)
     00.04200s (azure-ds/list_possible_azure_ds_devs)
     00.03800s (modules-final/config-ssh-authkey-fingerprints)
     00.03700s (azure-ds/_has_ntfs_filesystem)
     00.03600s (azure-ds/crtfile_to_pubkey)
     00.03500s (azure-ds/_get_metadata_from_imds)
     00.02500s (azure-ds/parse_network_config)
     00.02300s (init-network/check-cache)
     00.02000s (modules-final/config-scripts-user)
     00.01200s (azure-ds/parse_network_config)
     00.01000s (azure-ds/get_boot_telemetry)
     00.00800s (init-network/consume-user-data)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/check-platform-viability)
     00.00400s (modules-final/config-final-message)
     00.00300s (modules-final/config-snappy)
     00.00300s (modules-config/config-runcmd)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-config/config-ubuntu-advantage)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-ntp)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (init-network/config-ca-certs)
     00.00200s (azure-ds/write_files)
     00.00200s (azure-ds/get_system_info)
     00.00200s (azure-ds/count_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

-- Boot Record 02 --
     00.20700s (azure-ds/list_possible_azure_ds_devs)
     00.16200s (azure-ds/obtain-dhcp-lease)
     00.01600s (azure-ds/_get_metadata_from_imds)
     00.01100s (azure-ds/parse_network_config)
     00.01000s (azure-ds/get_boot_telemetry)
     00.00700s (azure-ds/check-platform-viability)
     00.00300s (azure-ds/write_files)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

-- Boot Record 03 --
     02.28400s (azure-ds/perform_hostname_bounce)
     00.25900s (azure-ds/obtain-dhcp-lease)
     00.19300s (azure-ds/list_possible_azure_ds_devs)
     00.15500s (azure-ds/invoke_agent)
     00.10700s (azure-ds/_has_ntfs_filesystem)
     00.03600s (init-network/config-growpart)
     00.02400s (azure-ds/parse_network_config)
     00.02300s (init-network/check-cache)
     00.01900s (azure-ds/parse_network_config)
     00.01700s (init-network/config-resizefs)
     00.01200s (azure-ds/crtfile_to_pubkey)
     00.01100s (init-network/consume-user-data)
     00.01000s (azure-ds/get_boot_telemetry)
     00.00800s (azure-ds/check-platform-viability)
     00.00600s (azure-ds/_get_metadata_from_imds)
     00.00500s (modules-final/config-final-message)
     00.00300s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-ssh-authkey-fingerprints)
     00.00100s (modules-final/config-snappy)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-ssh-import-id)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-ssh)
     00.00100s (init-network/config-set_hostname)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-disk_setup)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-vendor)
     00.00000s (modules-final/config-scripts-user)
     00.00000s (modules-final/config-scripts-per-once)
     00.00000s (modules-final/config-scripts-per-instance)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-puppet)
     00.00000s (modules-final/config-power-state-change)
     00.00000s (modules-final/config-phone-home)
     00.00000s (modules-final/config-package-update-upgrade-install)
     00.00000s (modules-final/config-mcollective)
     00.00000s (modules-final/config-lxd)
     00.00000s (modules-final/config-landscape)
     00.00000s (modules-final/config-keys-to-console)
     00.00000s (modules-final/config-fan)
     00.00000s (modules-final/config-chef)
     00.00000s (modules-config/config-ubuntu-advantage)
     00.00000s (modules-config/config-snap_config)
     00.00000s (modules-config/config-snap)
     00.00000s (modules-config/config-set-passwords)
     00.00000s (modules-config/config-runcmd)
     00.00000s (modules-config/config-ntp)
     00.00000s (modules-config/config-locale)
     00.00000s (modules-config/config-grub-dpkg)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (modules-config/config-apt-pipelining)
     00.00000s (modules-config/config-apt-configure)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-users-groups)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-seed_random)
     00.00000s (init-network/config-rsyslog)
     00.00000s (init-network/config-mounts)
     00.00000s (init-network/config-ca-certs)
     00.00000s (azure-ds/waiting-for-ssh-public-key)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

3 boot records analyzed
+ echo After upgrade Networking config
After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- sudo reboot
sudo: unable to resolve host SRU-worked-azure
Connection to 104.208.141.135 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- cloud-init status --wait --long

status: done
time: Thu, 05 Dec 2019 23:48:50 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.141.135 -- grep 'Update datasource' /var/log/cloud-init.log
2019-12-05 23:43:17,532 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-05 23:47:17,479 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-05 23:47:18,059 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
2019-12-05 23:48:40,746 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-05 23:48:41,315 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END xenial
### END xenial
+ echo ### BEGIN bionic
### BEGIN bionic
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=18.04-DAILY-LTS
+ [  = --nics sruNic-bionic --size Standard_DS2_v2 ]
+ echo Creating advanced network vm
Creating advanced network vm
+ name=test-sru-bionic-advanced
+ az network public-ip create --name sruPublicIP-IPv4-bionic --resource-group srugroupIPV6 --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"2a483869-db42-4184-8f5a-49333d9e69cc\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-bionic",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv4-bionic",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "1957935a-56f7-43e9-b9ea-295893529015",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name sruPublicIP-IPv6-bionic --resource-group srugroupIPV6 --version IPv6
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"c5b3a233-dfe2-482f-897e-1f5db5338f4c\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv6-bionic",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv6-bionic",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv6",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "d5958998-de6d-4af3-9406-05e79024f1b8",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network nic create --resource-group srugroupIPV6 --name sruNic-bionic --vnet-name sruVnet --subnet sruSubnet --accelerated-networking true --private-ip-address-version IPv4 --public-ip-address sruPublicIP-IPv4-bionic --network-security-group sruNetSecGroup
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "gnveocvoucie1lj42bdysylmce.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"d27e319f-7f2b-4d0c-ac63-47fdb8c0db8e\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-bionic",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"d27e319f-7f2b-4d0c-ac63-47fdb8c0db8e\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-bionic/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "192.168.0.5",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": {
          "ddosSettings": null,
          "dnsSettings": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-bionic",
          "idleTimeoutInMinutes": null,
          "ipAddress": null,
          "ipConfiguration": null,
          "ipTags": null,
          "location": null,
          "name": null,
          "provisioningState": null,
          "publicIpAddressVersion": null,
          "publicIpAllocationMethod": null,
          "publicIpPrefix": null,
          "resourceGroup": "srugroupIPV6",
          "resourceGuid": null,
          "sku": null,
          "tags": null,
          "type": null,
          "zones": null
        },
        "resourceGroup": "srugroupIPV6",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroupIPV6",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic-bionic",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroupIPV6",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "bb554363-e240-4d47-a066-b8461b749e76",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az vm create --name=test-sru-bionic-advanced --image=Canonical:UbuntuServer:18.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml --nics sruNic-bionic --size Standard_DS2_v2
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-bionic-advanced",
  "location": "eastus2",
  "macAddress": "00-0D-3A-0D-B1-EB",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.5",
  "publicIpAddress": "104.208.163.204",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-bionic-advanced
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@104.208.163.204
+ echo Created test-sru-bionic-advanced: ubuntu@ubuntu@104.208.163.204
Created test-sru-bionic-advanced: ubuntu@ubuntu@104.208.163.204
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- cloud-init status --wait --long

status: done
time: Thu, 05 Dec 2019 23:51:21 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- dpkg-query --show cloud-init
cloud-init    19.2-36-g059d049c-0ubuntu2~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- systemd-analyze
Startup finished in 6.385s (kernel) + 31.281s (userspace) = 37.666s
graphical.target reached after 30.468s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- systemd-analyze blame
          9.682s cloud-init.service
          4.915s cloud-init-local.service
          3.038s cloud-config.service
          2.997s lxd-containers.service
          2.863s snapd.service
          2.588s snapd.seeded.service
          2.562s systemd-networkd-wait-online.service
          2.275s pollinate.service
          2.118s dev-sda1.device
          1.482s keyboard-setup.service
           832ms apparmor.service
           795ms networkd-dispatcher.service
           794ms accounts-daemon.service
           785ms cloud-final.service
           579ms rsyslog.service
           562ms grub-common.service
           470ms polkit.service
           408ms lvm2-monitor.service
           358ms systemd-modules-load.service
           272ms systemd-logind.service
           232ms systemd-tmpfiles-setup-dev.service
           227ms systemd-timesyncd.service
           220ms ufw.service
           201ms systemd-journal-flush.service
           182ms kmod-static-nodes.service
           167ms systemd-udev-trigger.service
           152ms ebtables.service
           149ms systemd-journald.service
           144ms systemd-networkd.service
           133ms apport.service
           130ms ssh.service
           127ms systemd-udevd.service
           116ms systemd-user-sessions.service
           101ms dev-hugepages.mount
            78ms blk-availability.service
            78ms systemd-resolved.service
            74ms dev-mqueue.mount
            74ms systemd-random-seed.service
            73ms systemd-remount-fs.service
            73ms systemd-machine-id-commit.service
            60ms lxd.socket
            56ms console-setup.service
            51ms plymouth-read-write.service
            50ms snapd.socket
            49ms sys-kernel-debug.mount
            45ms systemd-sysctl.service
            34ms user@1000.service
            34ms systemd-update-utmp.service
            31ms systemd-tmpfiles-setup.service
            27ms boot-efi.mount
            23ms ephemeral-disk-warning.service
            21ms plymouth-quit.service
            19ms setvtrgb.service
            19ms sys-fs-fuse-connections.mount
            17ms sys-kernel-config.mount
            13ms plymouth-quit-wait.service
             7ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.13700s +00.01100s
|`->get_boot_telemetry @00.14800s +00.01500s
|`->get_system_info @00.16300s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.16400s +00.04700s
|`->load_azure_ds_dir @00.21200s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.35000s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.35000s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.01000 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.02200 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.37900s +00.31500s
|`->_get_metadata_from_imds @00.69500s +00.01800s
Finished stage: (azure-ds/get_metadata_from_imds) 00.39100 seconds

|`->_get_random_seed @00.77000s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.62000 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.78400s +00.00100s
|`->write_files @00.78600s +00.00400s
Finished stage: (azure-ds/_get_data) 00.65300 seconds

Finished stage: (init-local/search-Azure) 00.65500 seconds

|`->network config from imds @00.86600s +00.00100s
Finished stage: (init-local) 01.07200 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @04.34000s +00.03600s
|`->network config from imds @04.43000s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @04.44200s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @04.44700s +00.26200s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @04.70900s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @04.73000s +00.00900s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @04.74000s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.17600 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @04.91700s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00800 seconds

Finished stage: (azure-ds/parse_certificates) 00.19500 seconds

|`->_report_ready @04.92500s +04.04000s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 04.51900 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 04.52000 seconds

Finished stage: (azure-ds/_negotiate) 04.52400 seconds

Finished stage: (azure-ds/setup) 04.52400 seconds

Finished stage: (init-network/setup-datasource) 04.52500 seconds

|`->reading and applying user-data @08.98400s +00.01000s
|`->reading and applying vendor-data @08.99400s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @09.02600s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @09.02600s +00.16800s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @09.28000s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.09500 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.26300 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.26300 seconds

Finished stage: (azure-ds/activate) 00.26300 seconds

Finished stage: (init-network/activate-datasource) 00.26600 seconds

|`->config-migrator ran successfully @09.37500s +00.00100s
|`->config-seed_random ran successfully @09.37700s +00.00800s
|`->config-bootcmd ran successfully @09.38600s +00.00000s
|`->config-write-files ran successfully @09.38600s +00.00200s
|`->config-growpart ran successfully @09.38800s +00.63100s
|`->config-resizefs ran successfully @10.01900s +01.23100s
|`->config-disk_setup ran successfully @11.25000s +01.35400s
|`->config-mounts ran successfully @12.60500s +00.17700s
|`->config-set_hostname ran successfully @12.78300s +00.00700s
|`->config-update_hostname ran successfully @12.79000s +00.00200s
|`->config-update_etc_hosts ran successfully @12.79200s +00.00100s
|`->config-ca-certs ran successfully @12.79300s +00.00100s
|`->config-rsyslog ran successfully @12.79400s +00.00100s
|`->config-users-groups ran successfully @12.79600s +00.31900s
|`->config-ssh ran successfully @13.11600s +00.15900s
Finished stage: (init-network) 08.95100 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @19.93100s +00.00000s
|`->config-snap ran successfully @19.93100s +00.00200s
|`->config-snap_config ran successfully @19.93300s +00.00100s
|`->config-ssh-import-id ran successfully @19.93400s +00.93600s
|`->config-locale ran successfully @20.87100s +00.00200s
|`->config-set-passwords ran successfully @20.87300s +00.00200s
|`->config-grub-dpkg ran successfully @20.87600s +01.27600s
|`->config-apt-pipelining ran successfully @22.15200s +00.00200s
|`->config-apt-configure ran successfully @22.15400s +00.14400s
|`->config-ubuntu-advantage ran successfully @22.30000s +00.00400s
|`->config-ntp ran successfully @22.30400s +00.00500s
|`->config-timezone ran successfully @22.31000s +00.00100s
|`->config-disable-ec2-metadata ran successfully @22.31100s +00.00100s
|`->config-runcmd ran successfully @22.31200s +00.00700s
|`->config-byobu ran successfully @22.31900s +00.00100s
Finished stage: (modules-config) 02.41400 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @22.97100s +00.00200s
|`->config-package-update-upgrade-install ran successfully @22.97300s +00.00100s
|`->config-fan ran successfully @22.97500s +00.00100s
|`->config-landscape ran successfully @22.97600s +00.00100s
|`->config-lxd ran successfully @22.97700s +00.00100s
|`->config-ubuntu-drivers ran successfully @22.97900s +00.00100s
|`->config-puppet ran successfully @22.98000s +00.00100s
|`->config-chef ran successfully @22.98200s +00.00100s
|`->config-mcollective ran successfully @22.98300s +00.00100s
|`->config-salt-minion ran successfully @22.98500s +00.00000s
|`->config-rightscale_userdata ran successfully @22.98600s +00.00100s
|`->config-scripts-vendor ran successfully @22.98700s +00.00200s
|`->config-scripts-per-once ran successfully @22.98900s +00.00100s
|`->config-scripts-per-boot ran successfully @22.99100s +00.00000s
|`->config-scripts-per-instance ran successfully @22.99100s +00.00100s
|`->config-scripts-user ran successfully @22.99300s +00.02800s
|`->config-ssh-authkey-fingerprints ran successfully @23.02200s +00.05800s
|`->config-keys-to-console ran successfully @23.08000s +00.03700s
|`->config-phone-home ran successfully @23.11800s +00.00100s
|`->config-final-message ran successfully @23.12000s +00.00900s
|`->config-power-state-change ran successfully @23.12900s +00.00100s
Finished stage: (modules-final) 00.22700 seconds

Total Time: 39.16100 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- cloud-init analyze blame
-- Boot Record 01 --
     04.04000s (azure-ds/_report_ready)
     01.35400s (init-network/config-disk_setup)
     01.27600s (modules-config/config-grub-dpkg)
     01.23100s (init-network/config-resizefs)
     00.93600s (modules-config/config-ssh-import-id)
     00.63100s (init-network/config-growpart)
     00.31900s (init-network/config-users-groups)
     00.31500s (azure-ds/obtain-dhcp-lease)
     00.26200s (azure-ds/generate_certificate)
     00.17700s (init-network/config-mounts)
     00.16800s (azure-ds/_has_ntfs_filesystem)
     00.15900s (init-network/config-ssh)
     00.14400s (modules-config/config-apt-configure)
     00.05800s (modules-final/config-ssh-authkey-fingerprints)
     00.04700s (azure-ds/list_possible_azure_ds_devs)
     00.03700s (modules-final/config-keys-to-console)
     00.03600s (init-network/check-cache)
     00.02800s (modules-final/config-scripts-user)
     00.01800s (azure-ds/_get_metadata_from_imds)
     00.01500s (azure-ds/get_boot_telemetry)
     00.01100s (azure-ds/check-platform-viability)
     00.01000s (init-network/consume-user-data)
     00.00900s (modules-final/config-final-message)
     00.00900s (azure-ds/_decrypt_certs_from_xml)
     00.00800s (init-network/config-seed_random)
     00.00700s (modules-config/config-runcmd)
     00.00700s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-config/config-ntp)
     00.00400s (modules-config/config-ubuntu-advantage)
     00.00400s (azure-ds/write_files)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-final/config-scripts-vendor)
     00.00200s (modules-config/config-snap)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-write-files)
     00.00200s (init-network/config-update_hostname)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Networking config
Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by
# the datasource.  Changes to it will not persist across an instance.
# To disable cloud-init's network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            match:
                macaddress: 00:0d:3a:0d:b1:eb
            set-name: eth0
    version: 2
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@104.208.163.204:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- sudo bash ./setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu bionic-proposed/main amd64 cloud-init all 19.3-41-gc4735dd3-0ubuntu1~18.04.1 [411 kB]
Preparing to unpack .../cloud-init_19.3-41-gc4735dd3-0ubuntu1~18.04.1_all.deb ...
Unpacking cloud-init (19.3-41-gc4735dd3-0ubuntu1~18.04.1) over (19.2-36-g059d049c-0ubuntu2~18.04.1) ...
Setting up cloud-init (19.3-41-gc4735dd3-0ubuntu1~18.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- dpkg-query --show cloud-init
cloud-init    19.3-41-gc4735dd3-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ [  = --nics sruNic-bionic --size Standard_DS2_v2 ]
+ echo Shutting down instance and adding IPv6 config to nic
Shutting down instance and adding IPv6 config to nic
+ az vm stop --name=test-sru-bionic-advanced -g srugroupIPV6
WARNING: About to power off the specified VM...
It will continue to be billed. To deallocate a VM, run: az vm deallocate.
+ az network nic ip-config create --name sruNic-bionic-IPv6Config --nic-name sruNic-bionic --resource-group srugroupIPV6 --vnet-name sruVnet --subnet sruSubnet --private-ip-address-version IPv6
{
  "applicationGatewayBackendAddressPools": null,
  "applicationSecurityGroups": null,
  "etag": "W/\"8fb83808-f40a-485a-a9a4-e0b6c2c8d892\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-bionic/ipConfigurations/sruNic-bionic-IPv6Config",
  "loadBalancerBackendAddressPools": null,
  "loadBalancerInboundNatRules": null,
  "name": "sruNic-bionic-IPv6Config",
  "primary": null,
  "privateIpAddress": "ace:cab:deca:deed::5",
  "privateIpAddressVersion": "IPv6",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": null,
  "resourceGroup": "srugroupIPV6",
  "subnet": {
    "addressPrefix": null,
    "addressPrefixes": null,
    "delegations": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
    "ipConfigurationProfiles": null,
    "ipConfigurations": null,
    "name": null,
    "natGateway": null,
    "networkSecurityGroup": null,
    "privateEndpointNetworkPolicies": null,
    "privateEndpoints": null,
    "privateLinkServiceNetworkPolicies": null,
    "provisioningState": null,
    "purpose": null,
    "resourceGroup": "srugroupIPV6",
    "resourceNavigationLinks": null,
    "routeTable": null,
    "serviceAssociationLinks": null,
    "serviceEndpointPolicies": null,
    "serviceEndpoints": null
  },
  "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
  "virtualNetworkTaps": null
}
+ az vm start --name=test-sru-bionic-advanced -g srugroupIPV6
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- cloud-init status --wait --long

status: done
time: Thu, 05 Dec 2019 23:54:49 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- sudo systemd-analyze blame
          1.956s cloud-init-local.service
          1.329s systemd-networkd-wait-online.service
          1.159s dev-sda1.device
          1.069s cloud-init.service
           805ms cloud-config.service
           784ms keyboard-setup.service
           684ms lxd-containers.service
           671ms grub-common.service
           629ms snapd.service
           624ms cloud-final.service
           503ms networkd-dispatcher.service
           327ms accounts-daemon.service
           305ms apparmor.service
           291ms systemd-udev-trigger.service
           279ms systemd-modules-load.service
           241ms systemd-timesyncd.service
           202ms systemd-logind.service
           195ms rsyslog.service
           192ms ssh.service
           177ms apport.service
           152ms systemd-journald.service
           131ms systemd-user-sessions.service
           119ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
           115ms lvm2-monitor.service
           110ms ufw.service
           110ms mnt.mount
           101ms blk-availability.service
           100ms systemd-remount-fs.service
            98ms polkit.service
            94ms dev-hugepages.mount
            78ms sys-kernel-debug.mount
            76ms snapd.socket
            75ms lxd.socket
            73ms dev-mqueue.mount
            64ms ebtables.service
            57ms systemd-tmpfiles-setup.service
            54ms kmod-static-nodes.service
            51ms systemd-journal-flush.service
            48ms systemd-udevd.service
            45ms systemd-resolved.service
            35ms user@1000.service
            34ms setvtrgb.service
            33ms systemd-networkd.service
            32ms systemd-tmpfiles-setup-dev.service
            31ms snapd.seeded.service
            30ms systemd-sysctl.service
            27ms systemd-update-utmp.service
            24ms sys-kernel-config.mount
            22ms sys-fs-fuse-connections.mount
            19ms plymouth-quit.service
            19ms console-setup.service
            19ms plymouth-quit-wait.service
            18ms plymouth-read-write.service
            17ms boot-efi.mount
            13ms ephemeral-disk-warning.service
             9ms systemd-update-utmp-runlevel.service
             9ms systemd-random-seed.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.13700s +00.01100s
|`->get_boot_telemetry @00.14800s +00.01500s
|`->get_system_info @00.16300s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.16400s +00.04700s
|`->load_azure_ds_dir @00.21200s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.35000s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.35000s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.01000 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.02200 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.37900s +00.31500s
|`->_get_metadata_from_imds @00.69500s +00.01800s
Finished stage: (azure-ds/get_metadata_from_imds) 00.39100 seconds

|`->_get_random_seed @00.77000s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.62000 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.78400s +00.00100s
|`->write_files @00.78600s +00.00400s
Finished stage: (azure-ds/_get_data) 00.65300 seconds

Finished stage: (init-local/search-Azure) 00.65500 seconds

|`->network config from imds @00.86600s +00.00100s
Finished stage: (init-local) 01.07200 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @04.34000s +00.03600s
|`->network config from imds @04.43000s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @04.44200s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @04.44700s +00.26200s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @04.70900s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @04.73000s +00.00900s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @04.74000s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.17600 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @04.91700s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00800 seconds

Finished stage: (azure-ds/parse_certificates) 00.19500 seconds

|`->_report_ready @04.92500s +04.04000s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 04.51900 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 04.52000 seconds

Finished stage: (azure-ds/_negotiate) 04.52400 seconds

Finished stage: (azure-ds/setup) 04.52400 seconds

Finished stage: (init-network/setup-datasource) 04.52500 seconds

|`->reading and applying user-data @08.98400s +00.01000s
|`->reading and applying vendor-data @08.99400s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @09.02600s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @09.02600s +00.16800s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @09.28000s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.09500 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.26300 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.26300 seconds

Finished stage: (azure-ds/activate) 00.26300 seconds

Finished stage: (init-network/activate-datasource) 00.26600 seconds

|`->config-migrator ran successfully @09.37500s +00.00100s
|`->config-seed_random ran successfully @09.37700s +00.00800s
|`->config-bootcmd ran successfully @09.38600s +00.00000s
|`->config-write-files ran successfully @09.38600s +00.00200s
|`->config-growpart ran successfully @09.38800s +00.63100s
|`->config-resizefs ran successfully @10.01900s +01.23100s
|`->config-disk_setup ran successfully @11.25000s +01.35400s
|`->config-mounts ran successfully @12.60500s +00.17700s
|`->config-set_hostname ran successfully @12.78300s +00.00700s
|`->config-update_hostname ran successfully @12.79000s +00.00200s
|`->config-update_etc_hosts ran successfully @12.79200s +00.00100s
|`->config-ca-certs ran successfully @12.79300s +00.00100s
|`->config-rsyslog ran successfully @12.79400s +00.00100s
|`->config-users-groups ran successfully @12.79600s +00.31900s
|`->config-ssh ran successfully @13.11600s +00.15900s
Finished stage: (init-network) 08.95100 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @19.93100s +00.00000s
|`->config-snap ran successfully @19.93100s +00.00200s
|`->config-snap_config ran successfully @19.93300s +00.00100s
|`->config-ssh-import-id ran successfully @19.93400s +00.93600s
|`->config-locale ran successfully @20.87100s +00.00200s
|`->config-set-passwords ran successfully @20.87300s +00.00200s
|`->config-grub-dpkg ran successfully @20.87600s +01.27600s
|`->config-apt-pipelining ran successfully @22.15200s +00.00200s
|`->config-apt-configure ran successfully @22.15400s +00.14400s
|`->config-ubuntu-advantage ran successfully @22.30000s +00.00400s
|`->config-ntp ran successfully @22.30400s +00.00500s
|`->config-timezone ran successfully @22.31000s +00.00100s
|`->config-disable-ec2-metadata ran successfully @22.31100s +00.00100s
|`->config-runcmd ran successfully @22.31200s +00.00700s
|`->config-byobu ran successfully @22.31900s +00.00100s
Finished stage: (modules-config) 02.41400 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @22.97100s +00.00200s
|`->config-package-update-upgrade-install ran successfully @22.97300s +00.00100s
|`->config-fan ran successfully @22.97500s +00.00100s
|`->config-landscape ran successfully @22.97600s +00.00100s
|`->config-lxd ran successfully @22.97700s +00.00100s
|`->config-ubuntu-drivers ran successfully @22.97900s +00.00100s
|`->config-puppet ran successfully @22.98000s +00.00100s
|`->config-chef ran successfully @22.98200s +00.00100s
|`->config-mcollective ran successfully @22.98300s +00.00100s
|`->config-salt-minion ran successfully @22.98500s +00.00000s
|`->config-rightscale_userdata ran successfully @22.98600s +00.00100s
|`->config-scripts-vendor ran successfully @22.98700s +00.00200s
|`->config-scripts-per-once ran successfully @22.98900s +00.00100s
|`->config-scripts-per-boot ran successfully @22.99100s +00.00000s
|`->config-scripts-per-instance ran successfully @22.99100s +00.00100s
|`->config-scripts-user ran successfully @22.99300s +00.02800s
|`->config-ssh-authkey-fingerprints ran successfully @23.02200s +00.05800s
|`->config-keys-to-console ran successfully @23.08000s +00.03700s
|`->config-phone-home ran successfully @23.11800s +00.00100s
|`->config-final-message ran successfully @23.12000s +00.00900s
|`->config-power-state-change ran successfully @23.12900s +00.00100s
Finished stage: (modules-final) 00.22700 seconds

Total Time: 39.16100 seconds

-- Boot Record 02 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00300s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.04300s +00.00900s
|`->get_boot_telemetry @00.05200s +00.01500s
|`->get_system_info @00.06700s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.06800s +00.23500s
|`->load_azure_ds_dir @00.30300s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.30700s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.30800s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.32200s +00.20600s
|`->_get_metadata_from_imds @00.52900s +00.01600s
Finished stage: (azure-ds/get_metadata_from_imds) 00.28800 seconds

|`->_get_random_seed @00.61100s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.55500 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.62300s +00.00000s
|`->write_files @00.62400s +00.00200s
Finished stage: (azure-ds/_get_data) 00.58300 seconds

Finished stage: (init-local/search-Azure) 00.58600 seconds

|`->network config from imds @00.68100s +00.00100s
Total Time: 2.01900 seconds

-- Boot Record 03 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.00000s +00.01000s
|`->get_boot_telemetry @00.01000s +00.01300s
|`->get_system_info @00.02300s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.02300s +00.19700s
|`->load_azure_ds_dir @00.22100s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.22300s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.22300s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00100 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00200 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.22400s +00.13400s
|`->_get_metadata_from_imds @00.35900s +00.00700s
Finished stage: (azure-ds/get_metadata_from_imds) 00.19300 seconds

|`->_get_random_seed @00.41800s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.40800 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.43100s +00.00000s
|`->write_files @00.43200s +00.00200s
Finished stage: (azure-ds/_get_data) 00.43400 seconds

|`->network config from imds @00.43800s +00.00000s
Finished stage: (init-local) 01.25700 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @02.45500s +00.03100s
|`->network config from imds @02.53700s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @02.54900s +00.00000s
|`->perform_hostname_bounce @02.55500s +00.00100s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.01100 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @02.56100s +00.02700s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @02.58900s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @02.60900s +00.00800s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @02.61800s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01800 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @02.63600s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.03400 seconds

|`->_report_ready @02.64300s +00.01000s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.09400 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.09400 seconds

Finished stage: (azure-ds/_negotiate) 00.10700 seconds

Finished stage: (azure-ds/setup) 00.10700 seconds

Finished stage: (init-network/setup-datasource) 00.10700 seconds

|`->reading and applying user-data @02.66200s +00.00900s
|`->reading and applying vendor-data @02.67100s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @02.70000s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @02.70100s +00.15700s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.15800 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.15800 seconds

Finished stage: (azure-ds/activate) 00.15800 seconds

Finished stage: (init-network/activate-datasource) 00.16100 seconds

|`->config-migrator ran successfully @02.95800s +00.00200s
|`->config-seed_random previously ran @02.96000s +00.00000s
|`->config-bootcmd ran successfully @02.96100s +00.00000s
|`->config-write-files previously ran @02.96100s +00.00000s
|`->config-growpart ran successfully @02.96200s +00.05100s
|`->config-resizefs ran successfully @03.01400s +00.02300s
|`->config-disk_setup previously ran @03.03800s +00.00000s
|`->config-mounts previously ran @03.03800s +00.00200s
|`->config-set_hostname previously ran @03.04000s +00.00100s
|`->config-update_hostname ran successfully @03.04100s +00.00100s
|`->config-update_etc_hosts ran successfully @03.04300s +00.00000s
|`->config-ca-certs previously ran @03.04300s +00.00100s
|`->config-rsyslog previously ran @03.04400s +00.00000s
|`->config-users-groups previously ran @03.04500s +00.00000s
|`->config-ssh previously ran @03.04500s +00.00000s
Finished stage: (init-network) 00.60600 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @04.68500s +00.00100s
|`->config-snap previously ran @04.69300s +00.00000s
|`->config-snap_config previously ran @04.69300s +00.00100s
|`->config-ssh-import-id previously ran @04.69400s +00.00000s
|`->config-locale previously ran @04.69400s +00.00100s
|`->config-set-passwords previously ran @04.69600s +00.00000s
|`->config-grub-dpkg previously ran @04.69600s +00.00000s
|`->config-apt-pipelining previously ran @04.69700s +00.00000s
|`->config-apt-configure previously ran @04.69700s +00.00000s
|`->config-ubuntu-advantage previously ran @04.69800s +00.00000s
|`->config-ntp previously ran @04.70000s +00.00000s
|`->config-timezone previously ran @04.70100s +00.00000s
|`->config-disable-ec2-metadata ran successfully @04.70200s +00.01500s
|`->config-runcmd previously ran @04.71800s +00.00000s
|`->config-byobu previously ran @04.71900s +00.00000s
Finished stage: (modules-config) 00.06300 seconds

Starting stage: modules-final
|`->config-snappy previously ran @05.52200s +00.00100s
|`->config-package-update-upgrade-install previously ran @05.52300s +00.00100s
|`->config-fan previously ran @05.52400s +00.00000s
|`->config-landscape previously ran @05.52500s +00.00000s
|`->config-lxd previously ran @05.52600s +00.00000s
|`->config-ubuntu-drivers previously ran @05.52600s +00.00000s
|`->config-puppet previously ran @05.52700s +00.00000s
|`->config-chef previously ran @05.52700s +00.00000s
|`->config-mcollective previously ran @05.52800s +00.00000s
|`->config-salt-minion previously ran @05.53000s +00.00000s
|`->config-rightscale_userdata previously ran @05.53000s +00.00000s
|`->config-scripts-vendor previously ran @05.53100s +00.00000s
|`->config-scripts-per-once previously ran @05.53100s +00.00100s
|`->config-scripts-per-boot ran successfully @05.53200s +00.00100s
|`->config-scripts-per-instance previously ran @05.53300s +00.00000s
|`->config-scripts-user previously ran @05.53400s +00.00000s
|`->config-ssh-authkey-fingerprints previously ran @05.53400s +00.00000s
|`->config-keys-to-console previously ran @05.53500s +00.00000s
|`->config-phone-home previously ran @05.53600s +00.00000s
|`->config-final-message ran successfully @05.53600s +00.00600s
|`->config-power-state-change previously ran @05.54200s +00.00000s
Finished stage: (modules-final) 00.04400 seconds

Total Time: 4.22200 seconds

3 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- cloud-init analyze blame
-- Boot Record 01 --
     04.04000s (azure-ds/_report_ready)
     01.35400s (init-network/config-disk_setup)
     01.27600s (modules-config/config-grub-dpkg)
     01.23100s (init-network/config-resizefs)
     00.93600s (modules-config/config-ssh-import-id)
     00.63100s (init-network/config-growpart)
     00.31900s (init-network/config-users-groups)
     00.31500s (azure-ds/obtain-dhcp-lease)
     00.26200s (azure-ds/generate_certificate)
     00.17700s (init-network/config-mounts)
     00.16800s (azure-ds/_has_ntfs_filesystem)
     00.15900s (init-network/config-ssh)
     00.14400s (modules-config/config-apt-configure)
     00.05800s (modules-final/config-ssh-authkey-fingerprints)
     00.04700s (azure-ds/list_possible_azure_ds_devs)
     00.03700s (modules-final/config-keys-to-console)
     00.03600s (init-network/check-cache)
     00.02800s (modules-final/config-scripts-user)
     00.01800s (azure-ds/_get_metadata_from_imds)
     00.01500s (azure-ds/get_boot_telemetry)
     00.01100s (azure-ds/check-platform-viability)
     00.01000s (init-network/consume-user-data)
     00.00900s (modules-final/config-final-message)
     00.00900s (azure-ds/_decrypt_certs_from_xml)
     00.00800s (init-network/config-seed_random)
     00.00700s (modules-config/config-runcmd)
     00.00700s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-config/config-ntp)
     00.00400s (modules-config/config-ubuntu-advantage)
     00.00400s (azure-ds/write_files)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-final/config-scripts-vendor)
     00.00200s (modules-config/config-snap)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-write-files)
     00.00200s (init-network/config-update_hostname)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

-- Boot Record 02 --
     00.23500s (azure-ds/list_possible_azure_ds_devs)
     00.20600s (azure-ds/obtain-dhcp-lease)
     00.01600s (azure-ds/_get_metadata_from_imds)
     00.01500s (azure-ds/get_boot_telemetry)
     00.00900s (azure-ds/check-platform-viability)
     00.00200s (azure-ds/write_files)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

-- Boot Record 03 --
     00.19700s (azure-ds/list_possible_azure_ds_devs)
     00.15700s (azure-ds/_has_ntfs_filesystem)
     00.13400s (azure-ds/obtain-dhcp-lease)
     00.05100s (init-network/config-growpart)
     00.03100s (init-network/check-cache)
     00.02700s (azure-ds/generate_certificate)
     00.02300s (init-network/config-resizefs)
     00.01500s (modules-config/config-disable-ec2-metadata)
     00.01300s (azure-ds/get_boot_telemetry)
     00.01000s (azure-ds/check-platform-viability)
     00.01000s (azure-ds/_report_ready)
     00.00900s (init-network/consume-user-data)
     00.00800s (azure-ds/_decrypt_certs_from_xml)
     00.00700s (azure-ds/_get_metadata_from_imds)
     00.00600s (modules-final/config-final-message)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00200s (init-network/config-mounts)
     00.00200s (init-network/config-migrator)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-snappy)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-locale)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-set_hostname)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/perform_hostname_bounce)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-ubuntu-drivers)
     00.00000s (modules-final/config-ssh-authkey-fingerprints)
     00.00000s (modules-final/config-scripts-vendor)
     00.00000s (modules-final/config-scripts-user)
     00.00000s (modules-final/config-scripts-per-instance)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-puppet)
     00.00000s (modules-final/config-power-state-change)
     00.00000s (modules-final/config-phone-home)
     00.00000s (modules-final/config-mcollective)
     00.00000s (modules-final/config-lxd)
     00.00000s (modules-final/config-landscape)
     00.00000s (modules-final/config-keys-to-console)
     00.00000s (modules-final/config-fan)
     00.00000s (modules-final/config-chef)
     00.00000s (modules-config/config-ubuntu-advantage)
     00.00000s (modules-config/config-timezone)
     00.00000s (modules-config/config-ssh-import-id)
     00.00000s (modules-config/config-snap)
     00.00000s (modules-config/config-set-passwords)
     00.00000s (modules-config/config-runcmd)
     00.00000s (modules-config/config-ntp)
     00.00000s (modules-config/config-grub-dpkg)
     00.00000s (modules-config/config-byobu)
     00.00000s (modules-config/config-apt-pipelining)
     00.00000s (modules-config/config-apt-configure)
     00.00000s (init-network/config-write-files)
     00.00000s (init-network/config-users-groups)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-ssh)
     00.00000s (init-network/config-seed_random)
     00.00000s (init-network/config-rsyslog)
     00.00000s (init-network/config-disk_setup)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

3 boot records analyzed
+ echo After upgrade Networking config
After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides: &id001
                route-metric: 100
            dhcp6: true
            dhcp6-overrides: *id001
            match:
                macaddress: 00:0d:3a:0d:b1:eb
            set-name: eth0
    version: 2
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- sudo reboot
Connection to 104.208.163.204 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- cloud-init status --wait --long
ssh: connect to host 104.208.163.204 port 22: Connection timed out
+ echo After reboot
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.163.204 -- grep 'Update datasource' /var/log/cloud-init.log
2019-12-05 23:50:58,236 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-05 23:54:43,174 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-05 23:54:43,813 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
2019-12-05 23:56:32,470 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-05 23:58:04,347 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END bionic
### END bionic
+ echo ### BEGIN disco
### BEGIN disco
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=19.04-DAILY
+ [  = --nics sruNic-disco --size Standard_DS2_v2 ]
+ echo Creating advanced network vm
Creating advanced network vm
+ name=test-sru-disco-advanced
+ az network public-ip create --name sruPublicIP-IPv4-disco --resource-group srugroupIPV6 --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"242026bd-9def-4786-a316-614629ebac34\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-disco",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv4-disco",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "7c55cd32-5be5-4294-9f51-3d4622d57874",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name sruPublicIP-IPv6-disco --resource-group srugroupIPV6 --version IPv6
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"66978525-756f-433e-b95c-2a4e82b3e435\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv6-disco",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv6-disco",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv6",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "8daad903-d905-4fcd-837c-630c14023fcf",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network nic create --resource-group srugroupIPV6 --name sruNic-disco --vnet-name sruVnet --subnet sruSubnet --accelerated-networking true --private-ip-address-version IPv4 --public-ip-address sruPublicIP-IPv4-disco --network-security-group sruNetSecGroup
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "gnveocvoucie1lj42bdysylmce.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"c2272190-416f-4a62-8171-c22dd8f3f316\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-disco",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"c2272190-416f-4a62-8171-c22dd8f3f316\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-disco/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "192.168.0.6",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": {
          "ddosSettings": null,
          "dnsSettings": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-disco",
          "idleTimeoutInMinutes": null,
          "ipAddress": null,
          "ipConfiguration": null,
          "ipTags": null,
          "location": null,
          "name": null,
          "provisioningState": null,
          "publicIpAddressVersion": null,
          "publicIpAllocationMethod": null,
          "publicIpPrefix": null,
          "resourceGroup": "srugroupIPV6",
          "resourceGuid": null,
          "sku": null,
          "tags": null,
          "type": null,
          "zones": null
        },
        "resourceGroup": "srugroupIPV6",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroupIPV6",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic-disco",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroupIPV6",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "5c85543c-92e9-462f-94af-afc10610c808",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az vm create --name=test-sru-disco-advanced --image=Canonical:UbuntuServer:19.04-DAILY:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml --nics sruNic-disco --size Standard_DS2_v2
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-disco-advanced",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7A-BA-BC",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.6",
  "publicIpAddress": "52.167.5.125",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-disco-advanced
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.167.5.125
+ echo Created test-sru-disco-advanced: ubuntu@ubuntu@52.167.5.125
Created test-sru-disco-advanced: ubuntu@ubuntu@52.167.5.125
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- cloud-init status --wait --long
.........................................
status: done
time: Fri, 06 Dec 2019 00:01:46 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- dpkg-query --show cloud-init
cloud-init    19.2-36-g059d049c-0ubuntu2~19.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- systemd-analyze
Startup finished in 3.442s (kernel) + 1min 4.887s (userspace) = 1min 8.329s
graphical.target reached after 1min 4.094s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- systemd-analyze blame
         22.322s snapd.seeded.service
         21.406s cloud-init-local.service
          8.408s cloud-init.service
          2.606s lvm2-monitor.service
          2.512s cloud-config.service
          2.478s dev-sda1.device
          2.374s pollinate.service
          2.148s systemd-udev-settle.service
          1.207s accounts-daemon.service
          1.158s systemd-networkd-wait-online.service
           786ms cloud-final.service
           674ms apparmor.service
           640ms systemd-logind.service
           579ms systemd-resolved.service
           523ms snap.lxd.activate.service
           520ms systemd-timesyncd.service
           452ms apport.service
           407ms systemd-journald.service
           406ms grub-common.service
           394ms networkd-dispatcher.service
           385ms systemd-networkd.service
           375ms systemd-user-sessions.service
           348ms rsyslog.service
           306ms systemd-modules-load.service
           282ms ssh.service
           275ms systemd-udevd.service
           253ms systemd-sysusers.service
           238ms snapd.service
           237ms keyboard-setup.service
           214ms multipathd.service
           214ms systemd-udev-trigger.service
           213ms grub-initrd-fallback.service
           186ms setvtrgb.service
           149ms user@1000.service
           132ms systemd-remount-fs.service
            97ms systemd-journal-flush.service
            86ms systemd-tmpfiles-setup-dev.service
            73ms systemd-machine-id-commit.service
            72ms kmod-static-nodes.service
            71ms atd.service
            71ms dev-hugepages.mount
            66ms ufw.service
            63ms dev-mqueue.mount
            60ms console-setup.service
            60ms sys-kernel-debug.mount
            56ms finalrd.service
            55ms plymouth-read-write.service
            52ms systemd-sysctl.service
            40ms plymouth-quit-wait.service
            40ms systemd-update-utmp.service
            39ms systemd-tmpfiles-setup.service
            39ms plymouth-quit.service
            27ms snap-lxd-12631.mount
            27ms sys-kernel-config.mount
            26ms blk-availability.service
            26ms systemd-random-seed.service
            24ms boot-efi.mount
            23ms snap-core-8039.mount
            22ms dev-loop0.device
            20ms sys-fs-fuse-connections.mount
            18ms ephemeral-disk-warning.service
            16ms systemd-update-utmp-runlevel.service
            15ms user-runtime-dir@1000.service
            11ms dev-loop1.device
             6ms snapd.socket
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.10200s +00.01100s
|`->get_boot_telemetry @00.11300s +00.08800s
|`->get_system_info @00.20100s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.20200s +00.05400s
|`->load_azure_ds_dir @00.25600s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.39800s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.39800s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.01200 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01700 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.42600s +17.19600s
|`->_get_metadata_from_imds @17.62300s +00.03600s
Finished stage: (azure-ds/get_metadata_from_imds) 17.25300 seconds

|`->_get_random_seed @17.67900s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 17.48800 seconds

|`->maybe_remove_ubuntu_network_config_scripts @17.69000s +00.00000s
|`->write_files @17.69100s +00.00200s
Finished stage: (azure-ds/_get_data) 17.59200 seconds

Finished stage: (init-local/search-Azure) 17.59400 seconds

|`->network config from imds @17.77700s +00.00000s
Finished stage: (init-local) 17.95700 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @19.97600s +00.02100s
|`->network config from imds @20.04500s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @20.05500s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @20.05900s +00.16500s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @20.22500s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @20.25800s +00.01000s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @20.26900s +00.00500s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.04300 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @20.31200s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.06100 seconds

|`->_report_ready @20.31900s +02.88100s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.14100 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.14300 seconds

Finished stage: (azure-ds/_negotiate) 03.14600 seconds

Finished stage: (azure-ds/setup) 03.14700 seconds

Finished stage: (init-network/setup-datasource) 03.14700 seconds

|`->reading and applying user-data @23.20800s +00.00900s
|`->reading and applying vendor-data @23.21700s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @23.25400s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @23.25500s +00.14300s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @23.49500s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.10400 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.24800 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.24900 seconds

Finished stage: (azure-ds/activate) 00.24900 seconds

Finished stage: (init-network/activate-datasource) 00.25200 seconds

|`->config-migrator ran successfully @23.54600s +00.00100s
|`->config-seed_random ran successfully @23.54700s +00.00200s
|`->config-bootcmd ran successfully @23.54900s +00.00000s
|`->config-write-files ran successfully @23.55000s +00.00100s
|`->config-growpart ran successfully @23.55100s +00.88100s
|`->config-resizefs ran successfully @24.43200s +01.08300s
|`->config-disk_setup ran successfully @25.51500s +01.40300s
|`->config-mounts ran successfully @26.91900s +00.22000s
|`->config-set_hostname ran successfully @27.14000s +00.00600s
|`->config-update_hostname ran successfully @27.14600s +00.00200s
|`->config-update_etc_hosts ran successfully @27.14800s +00.00100s
|`->config-ca-certs ran successfully @27.14900s +00.00100s
|`->config-rsyslog ran successfully @27.15000s +00.00100s
|`->config-users-groups ran successfully @27.15200s +00.39400s
|`->config-ssh ran successfully @27.54600s +00.36100s
Finished stage: (init-network) 07.94600 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @53.35600s +00.00100s
|`->config-snap ran successfully @53.35700s +00.00100s
|`->config-snap_config ran successfully @53.35900s +00.00100s
|`->config-ssh-import-id ran successfully @53.36000s +00.84500s
|`->config-locale ran successfully @54.20500s +00.00200s
|`->config-set-passwords ran successfully @54.20700s +00.00300s
|`->config-grub-dpkg ran successfully @54.21100s +01.06200s
|`->config-apt-pipelining ran successfully @55.27400s +00.00100s
|`->config-apt-configure ran successfully @55.27600s +00.08300s
|`->config-ubuntu-advantage ran successfully @55.36000s +00.00100s
|`->config-ntp ran successfully @55.36200s +00.00100s
|`->config-timezone ran successfully @55.36300s +00.00100s
|`->config-disable-ec2-metadata ran successfully @55.36500s +00.00000s
|`->config-runcmd ran successfully @55.36500s +00.01700s
|`->config-byobu ran successfully @55.38200s +00.00200s
Finished stage: (modules-config) 02.05000 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @55.91900s +00.00200s
|`->config-package-update-upgrade-install ran successfully @55.92100s +00.00100s
|`->config-fan ran successfully @55.92200s +00.00100s
|`->config-landscape ran successfully @55.92400s +00.00100s
|`->config-lxd ran successfully @55.92500s +00.00100s
|`->config-ubuntu-drivers ran successfully @55.92600s +00.00100s
|`->config-puppet ran successfully @55.92800s +00.00100s
|`->config-chef ran successfully @55.92900s +00.00100s
|`->config-mcollective ran successfully @55.93000s +00.00100s
|`->config-salt-minion ran successfully @55.93200s +00.00100s
|`->config-rightscale_userdata ran successfully @55.93300s +00.00100s
|`->config-scripts-vendor ran successfully @55.93400s +00.00100s
|`->config-scripts-per-once ran successfully @55.93600s +00.00100s
|`->config-scripts-per-boot ran successfully @55.93700s +00.00000s
|`->config-scripts-per-instance ran successfully @55.93800s +00.00100s
|`->config-scripts-user ran successfully @55.93900s +00.05900s
|`->config-ssh-authkey-fingerprints ran successfully @55.99900s +00.06200s
|`->config-keys-to-console ran successfully @56.06200s +00.11800s
|`->config-phone-home ran successfully @56.18100s +00.00200s
|`->config-final-message ran successfully @56.18300s +00.00500s
|`->config-power-state-change ran successfully @56.18900s +00.00100s
Finished stage: (modules-final) 00.28700 seconds

Total Time: 115.13700 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- cloud-init analyze blame
-- Boot Record 01 --
     17.19600s (azure-ds/obtain-dhcp-lease)
     02.88100s (azure-ds/_report_ready)
     01.40300s (init-network/config-disk_setup)
     01.08300s (init-network/config-resizefs)
     01.06200s (modules-config/config-grub-dpkg)
     00.88100s (init-network/config-growpart)
     00.84500s (modules-config/config-ssh-import-id)
     00.39400s (init-network/config-users-groups)
     00.36100s (init-network/config-ssh)
     00.22000s (init-network/config-mounts)
     00.16500s (azure-ds/generate_certificate)
     00.14300s (azure-ds/_has_ntfs_filesystem)
     00.11800s (modules-final/config-keys-to-console)
     00.08800s (azure-ds/get_boot_telemetry)
     00.08300s (modules-config/config-apt-configure)
     00.06200s (modules-final/config-ssh-authkey-fingerprints)
     00.05900s (modules-final/config-scripts-user)
     00.05400s (azure-ds/list_possible_azure_ds_devs)
     00.03600s (azure-ds/_get_metadata_from_imds)
     00.02100s (init-network/check-cache)
     00.01700s (modules-config/config-runcmd)
     00.01100s (azure-ds/check-platform-viability)
     00.01000s (azure-ds/_decrypt_certs_from_xml)
     00.00900s (init-network/consume-user-data)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00500s (azure-ds/_run_x509_action)
     00.00300s (modules-config/config-set-passwords)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-byobu)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Networking config
Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by
# the datasource.  Changes to it will not persist across an instance.
# To disable cloud-init's network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            match:
                macaddress: 00:0d:3a:7a:ba:bc
            set-name: eth0
    version: 2
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@52.167.5.125:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- sudo bash+  ./setup_proposed.sh
egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu disco-proposed/main amd64 cloud-init all 19.3-41-gc4735dd3-0ubuntu1~19.04.1 [407 kB]
Preparing to unpack .../cloud-init_19.3-41-gc4735dd3-0ubuntu1~19.04.1_all.deb ...
Unpacking cloud-init (19.3-41-gc4735dd3-0ubuntu1~19.04.1) over (19.2-36-g059d049c-0ubuntu2~19.04.1) ...
Setting up cloud-init (19.3-41-gc4735dd3-0ubuntu1~19.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- dpkg-query --show cloud-init
cloud-init    19.3-41-gc4735dd3-0ubuntu1~19.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ [  = --nics sruNic-disco --size Standard_DS2_v2 ]
+ echo Shutting down instance and adding IPv6 config to nic
Shutting down instance and adding IPv6 config to nic
+ az vm stop --name=test-sru-disco-advanced -g srugroupIPV6
WARNING: About to power off the specified VM...
It will continue to be billed. To deallocate a VM, run: az vm deallocate.
+ az network nic ip-config create --name sruNic-disco-IPv6Config --nic-name sruNic-disco --resource-group srugroupIPV6 --vnet-name sruVnet --subnet sruSubnet --private-ip-address-version IPv6
{
  "applicationGatewayBackendAddressPools": null,
  "applicationSecurityGroups": null,
  "etag": "W/\"2bb8256c-6f69-4704-9ac3-673a3e50bec5\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-disco/ipConfigurations/sruNic-disco-IPv6Config",
  "loadBalancerBackendAddressPools": null,
  "loadBalancerInboundNatRules": null,
  "name": "sruNic-disco-IPv6Config",
  "primary": null,
  "privateIpAddress": "ace:cab:deca:deed::6",
  "privateIpAddressVersion": "IPv6",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": null,
  "resourceGroup": "srugroupIPV6",
  "subnet": {
    "addressPrefix": null,
    "addressPrefixes": null,
    "delegations": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
    "ipConfigurationProfiles": null,
    "ipConfigurations": null,
    "name": null,
    "natGateway": null,
    "networkSecurityGroup": null,
    "privateEndpointNetworkPolicies": null,
    "privateEndpoints": null,
    "privateLinkServiceNetworkPolicies": null,
    "provisioningState": null,
    "purpose": null,
    "resourceGroup": "srugroupIPV6",
    "resourceNavigationLinks": null,
    "routeTable": null,
    "serviceAssociationLinks": null,
    "serviceEndpointPolicies": null,
    "serviceEndpoints": null
  },
  "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
  "virtualNetworkTaps": null
}
+ az vm start --name=test-sru-disco-advanced -g srugroupIPV6
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 00:04:41 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- sudo systemd-analyze blame
          3.305s systemd-networkd-wait-online.service
          2.276s cloud-init-local.service
          1.586s cloud-init.service
          1.475s dev-sda1.device
          1.325s lvm2-monitor.service
          1.024s snap.lxd.activate.service
           962ms systemd-udev-settle.service
           668ms cloud-config.service
           550ms cloud-final.service
           544ms grub-common.service
           509ms snapd.service
           508ms systemd-logind.service
           471ms networkd-dispatcher.service
           434ms systemd-timesyncd.service
           349ms accounts-daemon.service
           316ms systemd-journald.service
           299ms systemd-udev-trigger.service
           297ms systemd-resolved.service
           277ms systemd-networkd.service
           277ms systemd-user-sessions.service
           201ms atd.service
           175ms ssh.service
           170ms dev-hugepages.mount
           169ms sys-kernel-debug.mount
           168ms systemd-remount-fs.service
           143ms dev-mqueue.mount
           140ms apport.service
           140ms keyboard-setup.service
           139ms ufw.service
           138ms kmod-static-nodes.service
           137ms systemd-modules-load.service
           120ms apparmor.service
           117ms blk-availability.service
           111ms mnt.mount
           102ms grub-initrd-fallback.service
            97ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            93ms systemd-update-utmp-runlevel.service
            83ms snap-lxd-12631.mount
            67ms rsyslog.service
            65ms user@1000.service
            62ms snapd.socket
            60ms systemd-update-utmp.service
            55ms systemd-tmpfiles-setup.service
            54ms snap-core-8039.mount
            53ms systemd-sysctl.service
            51ms systemd-journal-flush.service
            50ms sys-fs-fuse-connections.mount
            50ms console-setup.service
            49ms sys-kernel-config.mount
            49ms systemd-random-seed.service
            47ms finalrd.service
            45ms systemd-sysusers.service
            45ms snapd.seeded.service
            45ms boot-efi.mount
            43ms plymouth-read-write.service
            40ms multipathd.service
            36ms plymouth-quit-wait.service
            36ms dev-loop0.device
            33ms systemd-udevd.service
            32ms setvtrgb.service
            25ms plymouth-quit.service
            23ms systemd-tmpfiles-setup-dev.service
            18ms dev-loop1.device
            16ms ephemeral-disk-warning.service
            13ms user-runtime-dir@1000.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.10200s +00.01100s
|`->get_boot_telemetry @00.11300s +00.08800s
|`->get_system_info @00.20100s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.20200s +00.05400s
|`->load_azure_ds_dir @00.25600s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.39800s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.39800s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.01200 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01700 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.42600s +17.19600s
|`->_get_metadata_from_imds @17.62300s +00.03600s
Finished stage: (azure-ds/get_metadata_from_imds) 17.25300 seconds

|`->_get_random_seed @17.67900s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 17.48800 seconds

|`->maybe_remove_ubuntu_network_config_scripts @17.69000s +00.00000s
|`->write_files @17.69100s +00.00200s
Finished stage: (azure-ds/_get_data) 17.59200 seconds

Finished stage: (init-local/search-Azure) 17.59400 seconds

|`->network config from imds @17.77700s +00.00000s
Finished stage: (init-local) 17.95700 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @19.97600s +00.02100s
|`->network config from imds @20.04500s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @20.05500s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @20.05900s +00.16500s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @20.22500s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @20.25800s +00.01000s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @20.26900s +00.00500s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.04300 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @20.31200s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.06100 seconds

|`->_report_ready @20.31900s +02.88100s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.14100 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.14300 seconds

Finished stage: (azure-ds/_negotiate) 03.14600 seconds

Finished stage: (azure-ds/setup) 03.14700 seconds

Finished stage: (init-network/setup-datasource) 03.14700 seconds

|`->reading and applying user-data @23.20800s +00.00900s
|`->reading and applying vendor-data @23.21700s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @23.25400s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @23.25500s +00.14300s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @23.49500s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.10400 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.24800 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.24900 seconds

Finished stage: (azure-ds/activate) 00.24900 seconds

Finished stage: (init-network/activate-datasource) 00.25200 seconds

|`->config-migrator ran successfully @23.54600s +00.00100s
|`->config-seed_random ran successfully @23.54700s +00.00200s
|`->config-bootcmd ran successfully @23.54900s +00.00000s
|`->config-write-files ran successfully @23.55000s +00.00100s
|`->config-growpart ran successfully @23.55100s +00.88100s
|`->config-resizefs ran successfully @24.43200s +01.08300s
|`->config-disk_setup ran successfully @25.51500s +01.40300s
|`->config-mounts ran successfully @26.91900s +00.22000s
|`->config-set_hostname ran successfully @27.14000s +00.00600s
|`->config-update_hostname ran successfully @27.14600s +00.00200s
|`->config-update_etc_hosts ran successfully @27.14800s +00.00100s
|`->config-ca-certs ran successfully @27.14900s +00.00100s
|`->config-rsyslog ran successfully @27.15000s +00.00100s
|`->config-users-groups ran successfully @27.15200s +00.39400s
|`->config-ssh ran successfully @27.54600s +00.36100s
Finished stage: (init-network) 07.94600 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @53.35600s +00.00100s
|`->config-snap ran successfully @53.35700s +00.00100s
|`->config-snap_config ran successfully @53.35900s +00.00100s
|`->config-ssh-import-id ran successfully @53.36000s +00.84500s
|`->config-locale ran successfully @54.20500s +00.00200s
|`->config-set-passwords ran successfully @54.20700s +00.00300s
|`->config-grub-dpkg ran successfully @54.21100s +01.06200s
|`->config-apt-pipelining ran successfully @55.27400s +00.00100s
|`->config-apt-configure ran successfully @55.27600s +00.08300s
|`->config-ubuntu-advantage ran successfully @55.36000s +00.00100s
|`->config-ntp ran successfully @55.36200s +00.00100s
|`->config-timezone ran successfully @55.36300s +00.00100s
|`->config-disable-ec2-metadata ran successfully @55.36500s +00.00000s
|`->config-runcmd ran successfully @55.36500s +00.01700s
|`->config-byobu ran successfully @55.38200s +00.00200s
Finished stage: (modules-config) 02.05000 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @55.91900s +00.00200s
|`->config-package-update-upgrade-install ran successfully @55.92100s +00.00100s
|`->config-fan ran successfully @55.92200s +00.00100s
|`->config-landscape ran successfully @55.92400s +00.00100s
|`->config-lxd ran successfully @55.92500s +00.00100s
|`->config-ubuntu-drivers ran successfully @55.92600s +00.00100s
|`->config-puppet ran successfully @55.92800s +00.00100s
|`->config-chef ran successfully @55.92900s +00.00100s
|`->config-mcollective ran successfully @55.93000s +00.00100s
|`->config-salt-minion ran successfully @55.93200s +00.00100s
|`->config-rightscale_userdata ran successfully @55.93300s +00.00100s
|`->config-scripts-vendor ran successfully @55.93400s +00.00100s
|`->config-scripts-per-once ran successfully @55.93600s +00.00100s
|`->config-scripts-per-boot ran successfully @55.93700s +00.00000s
|`->config-scripts-per-instance ran successfully @55.93800s +00.00100s
|`->config-scripts-user ran successfully @55.93900s +00.05900s
|`->config-ssh-authkey-fingerprints ran successfully @55.99900s +00.06200s
|`->config-keys-to-console ran successfully @56.06200s +00.11800s
|`->config-phone-home ran successfully @56.18100s +00.00200s
|`->config-final-message ran successfully @56.18300s +00.00500s
|`->config-power-state-change ran successfully @56.18900s +00.00100s
Finished stage: (modules-final) 00.28700 seconds

Total Time: 115.13700 seconds

-- Boot Record 02 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00300s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03500s +00.01100s
|`->get_boot_telemetry @00.04600s +00.01800s
|`->get_system_info @00.06400s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.06400s +00.22300s
|`->load_azure_ds_dir @00.28700s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.29100s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.29100s +00.00100s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.31400s +00.27000s
|`->_get_metadata_from_imds @00.58500s +00.01500s
Finished stage: (azure-ds/get_metadata_from_imds) 00.33600 seconds

|`->_get_random_seed @00.64900s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.59500 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.65900s +00.00100s
|`->write_files @00.66000s +00.00300s
Finished stage: (azure-ds/_get_data) 00.62800 seconds

Finished stage: (init-local/search-Azure) 00.63100 seconds

|`->network config from imds @00.72400s +00.00000s
Total Time: 2.19700 seconds

-- Boot Record 03 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.00000s +00.01000s
|`->get_boot_telemetry @00.01000s +00.01100s
|`->get_system_info @00.02100s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.02200s +00.20500s
|`->load_azure_ds_dir @00.22700s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.22900s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.22900s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00200 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00200 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.23000s +00.25900s
|`->_get_metadata_from_imds @00.49000s +00.00700s
Finished stage: (azure-ds/get_metadata_from_imds) 00.32100 seconds

|`->_get_random_seed @00.55200s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.54000 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.56200s +00.00000s
|`->write_files @00.56300s +00.00100s
Finished stage: (azure-ds/_get_data) 00.56500 seconds

|`->network config from imds @00.56800s +00.00000s
Finished stage: (init-local) 01.42200 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @04.76900s +00.02200s
|`->network config from imds @04.84500s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @04.85600s +00.00000s
|`->perform_hostname_bounce @04.86400s +00.00100s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.01400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @04.87100s +00.04500s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @04.91700s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @04.94700s +00.00900s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @04.95600s +00.00500s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01200 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @04.96800s +00.00500s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00500 seconds

Finished stage: (azure-ds/parse_certificates) 00.02700 seconds

|`->_report_ready @04.97400s +00.00600s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.11000 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.11000 seconds

Finished stage: (azure-ds/_negotiate) 00.12600 seconds

Finished stage: (azure-ds/setup) 00.12600 seconds

Finished stage: (init-network/setup-datasource) 00.12600 seconds

|`->reading and applying user-data @04.98700s +00.00800s
|`->reading and applying vendor-data @04.99500s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @05.02100s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @05.02200s +00.31600s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.31600 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.31700 seconds

Finished stage: (azure-ds/activate) 00.31700 seconds

Finished stage: (init-network/activate-datasource) 00.31900 seconds

|`->config-migrator ran successfully @05.35500s +00.00100s
|`->config-seed_random previously ran @05.35700s +00.00000s
|`->config-bootcmd ran successfully @05.35700s +00.00000s
|`->config-write-files previously ran @05.35800s +00.00000s
|`->config-growpart ran successfully @05.35800s +00.05100s
|`->config-resizefs ran successfully @05.41000s +00.50000s
|`->config-disk_setup previously ran @05.91000s +00.00100s
|`->config-mounts previously ran @05.91100s +00.00100s
|`->config-set_hostname previously ran @05.91200s +00.00000s
|`->config-update_hostname ran successfully @05.91300s +00.00100s
|`->config-update_etc_hosts ran successfully @05.91400s +00.00100s
|`->config-ca-certs previously ran @05.91500s +00.00000s
|`->config-rsyslog previously ran @05.91500s +00.00100s
|`->config-users-groups previously ran @05.91600s +00.00100s
|`->config-ssh previously ran @05.91700s +00.00000s
Finished stage: (init-network) 01.16900 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @07.63600s +00.00000s
|`->config-snap previously ran @07.63700s +00.00000s
|`->config-snap_config previously ran @07.63700s +00.00100s
|`->config-ssh-import-id previously ran @07.63800s +00.00000s
|`->config-locale previously ran @07.63900s +00.00000s
|`->config-set-passwords previously ran @07.64000s +00.00000s
|`->config-grub-dpkg previously ran @07.64000s +00.00100s
|`->config-apt-pipelining previously ran @07.64100s +00.00000s
|`->config-apt-configure previously ran @07.64200s +00.00000s
|`->config-ubuntu-advantage previously ran @07.64300s +00.00000s
|`->config-ntp previously ran @07.64400s +00.00000s
|`->config-timezone previously ran @07.64400s +00.00100s
|`->config-disable-ec2-metadata ran successfully @07.64500s +00.00000s
|`->config-runcmd previously ran @07.64600s +00.00000s
|`->config-byobu previously ran @07.64700s +00.00000s
Finished stage: (modules-config) 00.02700 seconds

Starting stage: modules-final
|`->config-snappy previously ran @08.33900s +00.00000s
|`->config-package-update-upgrade-install previously ran @08.33900s +00.00100s
|`->config-fan previously ran @08.34000s +00.00000s
|`->config-landscape previously ran @08.34000s +00.00100s
|`->config-lxd previously ran @08.34100s +00.00000s
|`->config-ubuntu-drivers previously ran @08.34100s +00.00100s
|`->config-puppet previously ran @08.34200s +00.00100s
|`->config-chef previously ran @08.34300s +00.00000s
|`->config-mcollective previously ran @08.34400s +00.00000s
|`->config-salt-minion previously ran @08.34400s +00.00000s
|`->config-rightscale_userdata previously ran @08.34500s +00.00000s
|`->config-scripts-vendor previously ran @08.34500s +00.00000s
|`->config-scripts-per-once previously ran @08.34500s +00.00100s
|`->config-scripts-per-boot ran successfully @08.34600s +00.00100s
|`->config-scripts-per-instance previously ran @08.34700s +00.00000s
|`->config-scripts-user previously ran @08.34700s +00.00100s
|`->config-ssh-authkey-fingerprints previously ran @08.34800s +00.00000s
|`->config-keys-to-console previously ran @08.34900s +00.00000s
|`->config-phone-home previously ran @08.34900s +00.00100s
|`->config-final-message ran successfully @08.35000s +00.01500s
|`->config-power-state-change previously ran @08.36500s +00.00000s
Finished stage: (modules-final) 00.04500 seconds

Total Time: 6.01900 seconds

3 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- cloud-init analyze blame
-- Boot Record 01 --
     17.19600s (azure-ds/obtain-dhcp-lease)
     02.88100s (azure-ds/_report_ready)
     01.40300s (init-network/config-disk_setup)
     01.08300s (init-network/config-resizefs)
     01.06200s (modules-config/config-grub-dpkg)
     00.88100s (init-network/config-growpart)
     00.84500s (modules-config/config-ssh-import-id)
     00.39400s (init-network/config-users-groups)
     00.36100s (init-network/config-ssh)
     00.22000s (init-network/config-mounts)
     00.16500s (azure-ds/generate_certificate)
     00.14300s (azure-ds/_has_ntfs_filesystem)
     00.11800s (modules-final/config-keys-to-console)
     00.08800s (azure-ds/get_boot_telemetry)
     00.08300s (modules-config/config-apt-configure)
     00.06200s (modules-final/config-ssh-authkey-fingerprints)
     00.05900s (modules-final/config-scripts-user)
     00.05400s (azure-ds/list_possible_azure_ds_devs)
     00.03600s (azure-ds/_get_metadata_from_imds)
     00.02100s (init-network/check-cache)
     00.01700s (modules-config/config-runcmd)
     00.01100s (azure-ds/check-platform-viability)
     00.01000s (azure-ds/_decrypt_certs_from_xml)
     00.00900s (init-network/consume-user-data)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00500s (azure-ds/_run_x509_action)
     00.00300s (modules-config/config-set-passwords)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-byobu)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

-- Boot Record 02 --
     00.27000s (azure-ds/obtain-dhcp-lease)
     00.22300s (azure-ds/list_possible_azure_ds_devs)
     00.01800s (azure-ds/get_boot_telemetry)
     00.01500s (azure-ds/_get_metadata_from_imds)
     00.01100s (azure-ds/check-platform-viability)
     00.00300s (azure-ds/write_files)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_get_random_seed)
     00.00100s (azure-ds/_extract_preprovisioned_vm_setting)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)

-- Boot Record 03 --
     00.50000s (init-network/config-resizefs)
     00.31600s (azure-ds/_has_ntfs_filesystem)
     00.25900s (azure-ds/obtain-dhcp-lease)
     00.20500s (azure-ds/list_possible_azure_ds_devs)
     00.05100s (init-network/config-growpart)
     00.04500s (azure-ds/generate_certificate)
     00.02200s (init-network/check-cache)
     00.01500s (modules-final/config-final-message)
     00.01100s (azure-ds/get_boot_telemetry)
     00.01000s (azure-ds/check-platform-viability)
     00.00900s (azure-ds/_decrypt_certs_from_xml)
     00.00800s (init-network/consume-user-data)
     00.00700s (azure-ds/_get_metadata_from_imds)
     00.00600s (azure-ds/_report_ready)
     00.00500s (azure-ds/_run_x509_action)
     00.00500s (azure-ds/_run_x509_action)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-grub-dpkg)
     00.00100s (init-network/config-users-groups)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-mounts)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-disk_setup)
     00.00100s (azure-ds/write_files)
     00.00100s (azure-ds/perform_hostname_bounce)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (modules-final/config-ssh-authkey-fingerprints)
     00.00000s (modules-final/config-snappy)
     00.00000s (modules-final/config-scripts-vendor)
     00.00000s (modules-final/config-scripts-per-instance)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-power-state-change)
     00.00000s (modules-final/config-mcollective)
     00.00000s (modules-final/config-lxd)
     00.00000s (modules-final/config-keys-to-console)
     00.00000s (modules-final/config-fan)
     00.00000s (modules-final/config-chef)
     00.00000s (modules-config/config-ubuntu-advantage)
     00.00000s (modules-config/config-ssh-import-id)
     00.00000s (modules-config/config-snap)
     00.00000s (modules-config/config-set-passwords)
     00.00000s (modules-config/config-runcmd)
     00.00000s (modules-config/config-ntp)
     00.00000s (modules-config/config-locale)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (modules-config/config-byobu)
     00.00000s (modules-config/config-apt-pipelining)
     00.00000s (modules-config/config-apt-configure)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-write-files)
     00.00000s (init-network/config-ssh)
     00.00000s (init-network/config-set_hostname)
     00.00000s (init-network/config-seed_random)
     00.00000s (init-network/config-ca-certs)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

3 boot records analyzed
+ echo After upgrade Networking config
After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides: &id001
                route-metric: 100
            dhcp6: true
            dhcp6-overrides: *id001
            match:
                macaddress: 00:0d:3a:7a:ba:bc
            set-name: eth0
    version: 2
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- sudo reboot
Connection to 52.167.5.125 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- cloud-init status --wait --long
ssh: connect to host 52.167.5.125 port 22: Connection timed out
+ echo After reboot
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.5.125 -- grep 'Update datasource' /var/log/cloud-init.log
2019-12-06 00:00:50,028 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 00:04:32,886 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 00:04:33,575 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
2019-12-06 00:07:37,832 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 00:07:38,423 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END disco
### END disco
+ echo ### BEGIN eoan
### BEGIN eoan
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=19.10-DAILY
+ [  = --nics sruNic-eoan --size Standard_DS2_v2 ]
+ echo Creating advanced network vm
Creating advanced network vm
+ name=test-sru-eoan-advanced
+ az network public-ip create --name sruPublicIP-IPv4-eoan --resource-group srugroupIPV6 --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"fad28956-890a-48b3-abf2-9bf095ff8be9\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-eoan",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv4-eoan",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "37f52843-882b-4b74-a8de-f3be70c23123",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name sruPublicIP-IPv6-eoan --resource-group srugroupIPV6 --version IPv6
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"d7594935-1320-4cbe-91cb-66bf46362eaa\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv6-eoan",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv6-eoan",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv6",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "e199cf6b-df7a-4789-988f-6296d387b260",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network nic create --resource-group srugroupIPV6 --name sruNic-eoan --vnet-name sruVnet --subnet sruSubnet --accelerated-networking true --private-ip-address-version IPv4 --public-ip-address sruPublicIP-IPv4-eoan --network-security-group sruNetSecGroup
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "gnveocvoucie1lj42bdysylmce.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"e85e399d-f09f-4ff0-a9f4-f96674a9ef49\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-eoan",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"e85e399d-f09f-4ff0-a9f4-f96674a9ef49\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-eoan/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "192.168.0.7",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": {
          "ddosSettings": null,
          "dnsSettings": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-eoan",
          "idleTimeoutInMinutes": null,
          "ipAddress": null,
          "ipConfiguration": null,
          "ipTags": null,
          "location": null,
          "name": null,
          "provisioningState": null,
          "publicIpAddressVersion": null,
          "publicIpAllocationMethod": null,
          "publicIpPrefix": null,
          "resourceGroup": "srugroupIPV6",
          "resourceGuid": null,
          "sku": null,
          "tags": null,
          "type": null,
          "zones": null
        },
        "resourceGroup": "srugroupIPV6",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroupIPV6",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic-eoan",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroupIPV6",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "a52ee179-9dc9-46dd-8551-bbb054187259",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az vm create --name=test-sru-eoan-advanced --image=Canonical:UbuntuServer:19.10-DAILY:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml --nics sruNic-eoan --size Standard_DS2_v2
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-eoan-advanced",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7D-B6-F1",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.7",
  "publicIpAddress": "52.232.200.231",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-eoan-advanced
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.232.200.231
+ echo Created test-sru-eoan-advanced: ubuntu@ubuntu@52.232.200.231
Created test-sru-eoan-advanced: ubuntu@ubuntu@52.232.200.231
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- cloud-init status --wait --long
...........................
status: done
time: Fri, 06 Dec 2019 00:11:48 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- dpkg-query --show cloud-init
cloud-init    19.2-36-g059d049c-0ubuntu3
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- systemd-analyze
Startup finished in 3.576s (kernel) + 1min 36.551s (userspace) = 1min 40.127s
graphical.target reached after 1min 35.770s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- systemd-analyze blame
         46.693s cloud-init-local.service
         24.698s snapd.seeded.service
         10.165s cloud-init.service
          2.614s cloud-config.service
          2.593s lvm2-monitor.service
          2.465s dev-sda1.device
          2.349s pollinate.service
          2.310s systemd-udev-settle.service
          1.658s accounts-daemon.service
          1.549s systemd-networkd-wait-online.service
          1.371s snapd.service
           867ms networkd-dispatcher.service
           751ms cloud-final.service
           725ms apparmor.service
           524ms systemd-resolved.service
           524ms systemd-logind.service
           485ms systemd-timesyncd.service
           459ms rsyslog.service
           455ms snap.lxd.activate.service
           436ms systemd-journald.service
           429ms grub-initrd-fallback.service
           419ms systemd-udevd.service
           391ms grub-common.service
           386ms systemd-networkd.service
           285ms atd.service
           265ms keyboard-setup.service
           257ms multipathd.service
           244ms systemd-udev-trigger.service
           221ms user@1000.service
           202ms apport.service
           176ms blk-availability.service
           162ms snapd.socket
           145ms systemd-sysusers.service
           140ms systemd-remount-fs.service
           117ms systemd-user-sessions.service
           107ms ssh.service
           101ms systemd-journal-flush.service
           100ms ufw.service
            99ms dev-mqueue.mount
            97ms dev-hugepages.mount
            90ms systemd-sysctl.service
            73ms systemd-machine-id-commit.service
            68ms sys-kernel-debug.mount
            65ms systemd-modules-load.service
            62ms plymouth-read-write.service
            57ms systemd-tmpfiles-setup.service
            55ms console-setup.service
            51ms finalrd.service
            50ms kmod-static-nodes.service
            47ms plymouth-quit-wait.service
            45ms systemd-tmpfiles-setup-dev.service
            45ms systemd-random-seed.service
            44ms polkit.service
            44ms plymouth-quit.service
            44ms systemd-update-utmp.service
            42ms setvtrgb.service
            42ms sys-kernel-config.mount
            37ms snap-core-8039.mount
            36ms sys-fs-fuse-connections.mount
            33ms systemd-update-utmp-runlevel.service
            32ms ephemeral-disk-warning.service
            27ms snap-lxd-12317.mount
            21ms boot-efi.mount
            18ms user-runtime-dir@1000.service
            12ms dev-loop1.device
            10ms dev-loop0.device
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.12600s +00.01100s
|`->get_boot_telemetry @00.13700s +00.08600s
|`->get_system_info @00.22300s +00.00200s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.22500s +00.05500s
|`->load_azure_ds_dir @00.28100s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.42100s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.42200s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00800 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.46100s +41.84100s
|`->_get_metadata_from_imds @42.30300s +00.02700s
Finished stage: (azure-ds/get_metadata_from_imds) 41.89600 seconds

|`->_get_random_seed @42.35600s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 42.14200 seconds

|`->maybe_remove_ubuntu_network_config_scripts @42.36700s +00.00100s
|`->write_files @42.36800s +00.01200s
Finished stage: (azure-ds/_get_data) 42.25500 seconds

Finished stage: (init-local/search-Azure) 42.25800 seconds

|`->network config from imds @42.44600s +00.00000s
Finished stage: (init-local) 42.66200 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @45.11400s +00.02500s
|`->network config from imds @45.20600s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @45.21700s +00.00100s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @45.22200s +00.20100s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @45.42300s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @45.44800s +00.00900s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @45.45800s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.04700 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @45.50500s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.06400 seconds

|`->_report_ready @45.51200s +03.92500s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 04.21500 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 04.21600 seconds

Finished stage: (azure-ds/_negotiate) 04.22200 seconds

Finished stage: (azure-ds/setup) 04.22200 seconds

Finished stage: (init-network/setup-datasource) 04.22200 seconds

|`->reading and applying user-data @49.44600s +00.00900s
|`->reading and applying vendor-data @49.45500s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @49.49100s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @49.49300s +00.19100s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @49.75000s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.07300 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.26500 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.26600 seconds

Finished stage: (azure-ds/activate) 00.26700 seconds

Finished stage: (init-network/activate-datasource) 00.27000 seconds

|`->config-migrator ran successfully @49.82800s +00.00100s
|`->config-seed_random ran successfully @49.82900s +00.00200s
|`->config-bootcmd ran successfully @49.83100s +00.00100s
|`->config-write-files ran successfully @49.83200s +00.00100s
|`->config-growpart ran successfully @49.83300s +00.85400s
|`->config-resizefs ran successfully @50.68800s +01.18200s
|`->config-disk_setup ran successfully @51.87000s +01.49200s
|`->config-mounts ran successfully @53.36300s +00.26000s
|`->config-set_hostname ran successfully @53.62400s +00.00600s
|`->config-update_hostname ran successfully @53.63100s +00.00200s
|`->config-update_etc_hosts ran successfully @53.63300s +00.00100s
|`->config-ca-certs ran successfully @53.63400s +00.00100s
|`->config-rsyslog ran successfully @53.63500s +00.00100s
|`->config-users-groups ran successfully @53.63700s +00.50500s
|`->config-ssh ran successfully @54.14300s +00.66100s
Finished stage: (init-network) 09.71000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @83.28100s +00.00100s
|`->config-snap ran successfully @83.28200s +00.00100s
|`->config-snap_config ran successfully @83.28400s +00.00100s
|`->config-ssh-import-id ran successfully @83.28500s +00.83800s
|`->config-locale ran successfully @84.12300s +00.00300s
|`->config-set-passwords ran successfully @84.12600s +00.00200s
|`->config-grub-dpkg ran successfully @84.12800s +01.10000s
|`->config-apt-pipelining ran successfully @85.22800s +00.00200s
|`->config-apt-configure ran successfully @85.23000s +00.09900s
|`->config-ubuntu-advantage ran successfully @85.33000s +00.00100s
|`->config-ntp ran successfully @85.33100s +00.00200s
|`->config-timezone ran successfully @85.33400s +00.00100s
|`->config-disable-ec2-metadata ran successfully @85.33500s +00.00100s
|`->config-runcmd ran successfully @85.33600s +00.00700s
|`->config-byobu ran successfully @85.34400s +00.00100s
Finished stage: (modules-config) 02.08800 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @85.97300s +00.00200s
|`->config-package-update-upgrade-install ran successfully @85.97500s +00.00100s
|`->config-fan ran successfully @85.97700s +00.00100s
|`->config-landscape ran successfully @85.97800s +00.00100s
|`->config-lxd ran successfully @85.98000s +00.00100s
|`->config-ubuntu-drivers ran successfully @85.98100s +00.00100s
|`->config-puppet ran successfully @85.98300s +00.00100s
|`->config-chef ran successfully @85.98400s +00.00100s
|`->config-mcollective ran successfully @85.98600s +00.00100s
|`->config-salt-minion ran successfully @85.98700s +00.00100s
|`->config-rightscale_userdata ran successfully @85.98900s +00.00100s
|`->config-scripts-vendor ran successfully @85.99000s +00.00100s
|`->config-scripts-per-once ran successfully @85.99200s +00.00100s
|`->config-scripts-per-boot ran successfully @85.99300s +00.00100s
|`->config-scripts-per-instance ran successfully @85.99400s +00.00100s
|`->config-scripts-user ran successfully @85.99600s +00.02000s
|`->config-ssh-authkey-fingerprints ran successfully @86.01600s +00.01100s
|`->config-keys-to-console ran successfully @86.02700s +00.14600s
|`->config-phone-home ran successfully @86.17300s +00.00100s
|`->config-final-message ran successfully @86.17500s +00.00500s
|`->config-power-state-change ran successfully @86.18000s +00.00100s
Finished stage: (modules-final) 00.22600 seconds

Total Time: 245.61000 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- cloud-init analyze blame
-- Boot Record 01 --
     41.84100s (azure-ds/obtain-dhcp-lease)
     03.92500s (azure-ds/_report_ready)
     01.49200s (init-network/config-disk_setup)
     01.18200s (init-network/config-resizefs)
     01.10000s (modules-config/config-grub-dpkg)
     00.85400s (init-network/config-growpart)
     00.83800s (modules-config/config-ssh-import-id)
     00.66100s (init-network/config-ssh)
     00.50500s (init-network/config-users-groups)
     00.26000s (init-network/config-mounts)
     00.20100s (azure-ds/generate_certificate)
     00.19100s (azure-ds/_has_ntfs_filesystem)
     00.14600s (modules-final/config-keys-to-console)
     00.09900s (modules-config/config-apt-configure)
     00.08600s (azure-ds/get_boot_telemetry)
     00.05500s (azure-ds/list_possible_azure_ds_devs)
     00.02700s (azure-ds/_get_metadata_from_imds)
     00.02500s (init-network/check-cache)
     00.02000s (modules-final/config-scripts-user)
     00.01200s (azure-ds/write_files)
     00.01100s (modules-final/config-ssh-authkey-fingerprints)
     00.01100s (azure-ds/check-platform-viability)
     00.00900s (init-network/consume-user-data)
     00.00900s (azure-ds/_decrypt_certs_from_xml)
     00.00700s (modules-config/config-runcmd)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00300s (modules-config/config-locale)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-ntp)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (azure-ds/get_system_info)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/temporary_hostname)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Networking config
Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by
# the datasource.  Changes to it will not persist across an instance.
# To disable cloud-init's network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            match:
                macaddress: 00:0d:3a:7d:b6:f1
            set-name: eth0
    version: 2
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@52.232.200.231:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null+  -o LogLevel=ERROR ubuntu@52.232.200.231 -- sudo bash ./setup_proposed.sh
egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu eoan-proposed/main amd64 cloud-init all 19.3-41-gc4735dd3-0ubuntu1~19.10.1 [406 kB]
Preparing to unpack .../cloud-init_19.3-41-gc4735dd3-0ubuntu1~19.10.1_all.deb ...
Unpacking cloud-init (19.3-41-gc4735dd3-0ubuntu1~19.10.1) over (19.2-36-g059d049c-0ubuntu3) ...
Setting up cloud-init (19.3-41-gc4735dd3-0ubuntu1~19.10.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- dpkg-query --show cloud-init
cloud-init    19.3-41-gc4735dd3-0ubuntu1~19.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ [  = --nics sruNic-eoan --size Standard_DS2_v2 ]
+ echo Shutting down instance and adding IPv6 config to nic
Shutting down instance and adding IPv6 config to nic
+ az vm stop --name=test-sru-eoan-advanced -g srugroupIPV6
WARNING: About to power off the specified VM...
It will continue to be billed. To deallocate a VM, run: az vm deallocate.
+ az network nic ip-config create --name sruNic-eoan-IPv6Config --nic-name sruNic-eoan --resource-group srugroupIPV6 --vnet-name sruVnet --subnet sruSubnet --private-ip-address-version IPv6
{
  "applicationGatewayBackendAddressPools": null,
  "applicationSecurityGroups": null,
  "etag": "W/\"41bf9da5-e559-4af3-8b9f-31dd86110108\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-eoan/ipConfigurations/sruNic-eoan-IPv6Config",
  "loadBalancerBackendAddressPools": null,
  "loadBalancerInboundNatRules": null,
  "name": "sruNic-eoan-IPv6Config",
  "primary": null,
  "privateIpAddress": "ace:cab:deca:deed::7",
  "privateIpAddressVersion": "IPv6",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": null,
  "resourceGroup": "srugroupIPV6",
  "subnet": {
    "addressPrefix": null,
    "addressPrefixes": null,
    "delegations": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
    "ipConfigurationProfiles": null,
    "ipConfigurations": null,
    "name": null,
    "natGateway": null,
    "networkSecurityGroup": null,
    "privateEndpointNetworkPolicies": null,
    "privateEndpoints": null,
    "privateLinkServiceNetworkPolicies": null,
    "provisioningState": null,
    "purpose": null,
    "resourceGroup": "srugroupIPV6",
    "resourceNavigationLinks": null,
    "routeTable": null,
    "serviceAssociationLinks": null,
    "serviceEndpointPolicies": null,
    "serviceEndpoints": null
  },
  "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
  "virtualNetworkTaps": null
}
+ az vm start --name=test-sru-eoan-advanced -g srugroupIPV6
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 00:18:23 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- sudo systemd-analyze blame
          2.163s snap.lxd.activate.service
          2.154s e2scrub_reap.service
          2.068s cloud-init-local.service
          1.959s snapd.service
          1.779s systemd-networkd-wait-online.service
          1.460s lvm2-monitor.service
          1.316s dev-sda1.device
          1.188s cloud-init.service
          1.186s systemd-udev-settle.service
           823ms systemd-logind.service
           670ms cloud-config.service
           580ms cloud-final.service
           553ms apport.service
           550ms grub-common.service
           543ms accounts-daemon.service
           496ms systemd-timesyncd.service
           438ms rsyslog.service
           422ms systemd-journald.service
           382ms networkd-dispatcher.service
           370ms grub-initrd-fallback.service
           354ms systemd-resolved.service
           336ms systemd-user-sessions.service
           299ms apparmor.service
           269ms systemd-networkd.service
           254ms ssh.service
           232ms atd.service
           199ms keyboard-setup.service
           188ms systemd-remount-fs.service
           176ms systemd-udev-trigger.service
           123ms dev-loop0.device
           115ms dev-mqueue.mount
           108ms sys-kernel-debug.mount
           107ms systemd-sysctl.service
           104ms blk-availability.service
           101ms ufw.service
           101ms systemd-modules-load.service
            99ms mnt.mount
            96ms polkit.service
            93ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            89ms dev-hugepages.mount
            78ms kmod-static-nodes.service
            73ms user@1000.service
            54ms snap-core-8039.mount
            50ms multipathd.service
            49ms systemd-random-seed.service
            48ms snap-lxd-12317.mount
            44ms snapd.seeded.service
            44ms plymouth-read-write.service
            43ms systemd-tmpfiles-setup.service
            43ms systemd-udevd.service
            42ms systemd-sysusers.service
            42ms boot-efi.mount
            41ms systemd-journal-flush.service
            40ms plymouth-quit.service
            39ms finalrd.service
            36ms setvtrgb.service
            33ms sys-fs-fuse-connections.mount
            32ms snapd.socket
            29ms console-setup.service
            28ms plymouth-quit-wait.service
            26ms systemd-update-utmp.service
            20ms sys-kernel-config.mount
            20ms dev-loop1.device
            20ms systemd-tmpfiles-setup-dev.service
            20ms systemd-update-utmp-runlevel.service
            18ms user-runtime-dir@1000.service
            15ms ephemeral-disk-warning.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.12600s +00.01100s
|`->get_boot_telemetry @00.13700s +00.08600s
|`->get_system_info @00.22300s +00.00200s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.22500s +00.05500s
|`->load_azure_ds_dir @00.28100s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.42100s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.42200s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00800 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.46100s +41.84100s
|`->_get_metadata_from_imds @42.30300s +00.02700s
Finished stage: (azure-ds/get_metadata_from_imds) 41.89600 seconds

|`->_get_random_seed @42.35600s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 42.14200 seconds

|`->maybe_remove_ubuntu_network_config_scripts @42.36700s +00.00100s
|`->write_files @42.36800s +00.01200s
Finished stage: (azure-ds/_get_data) 42.25500 seconds

Finished stage: (init-local/search-Azure) 42.25800 seconds

|`->network config from imds @42.44600s +00.00000s
Finished stage: (init-local) 42.66200 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @45.11400s +00.02500s
|`->network config from imds @45.20600s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @45.21700s +00.00100s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @45.22200s +00.20100s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @45.42300s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @45.44800s +00.00900s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @45.45800s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.04700 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @45.50500s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.06400 seconds

|`->_report_ready @45.51200s +03.92500s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 04.21500 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 04.21600 seconds

Finished stage: (azure-ds/_negotiate) 04.22200 seconds

Finished stage: (azure-ds/setup) 04.22200 seconds

Finished stage: (init-network/setup-datasource) 04.22200 seconds

|`->reading and applying user-data @49.44600s +00.00900s
|`->reading and applying vendor-data @49.45500s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @49.49100s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @49.49300s +00.19100s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @49.75000s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.07300 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.26500 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.26600 seconds

Finished stage: (azure-ds/activate) 00.26700 seconds

Finished stage: (init-network/activate-datasource) 00.27000 seconds

|`->config-migrator ran successfully @49.82800s +00.00100s
|`->config-seed_random ran successfully @49.82900s +00.00200s
|`->config-bootcmd ran successfully @49.83100s +00.00100s
|`->config-write-files ran successfully @49.83200s +00.00100s
|`->config-growpart ran successfully @49.83300s +00.85400s
|`->config-resizefs ran successfully @50.68800s +01.18200s
|`->config-disk_setup ran successfully @51.87000s +01.49200s
|`->config-mounts ran successfully @53.36300s +00.26000s
|`->config-set_hostname ran successfully @53.62400s +00.00600s
|`->config-update_hostname ran successfully @53.63100s +00.00200s
|`->config-update_etc_hosts ran successfully @53.63300s +00.00100s
|`->config-ca-certs ran successfully @53.63400s +00.00100s
|`->config-rsyslog ran successfully @53.63500s +00.00100s
|`->config-users-groups ran successfully @53.63700s +00.50500s
|`->config-ssh ran successfully @54.14300s +00.66100s
Finished stage: (init-network) 09.71000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @83.28100s +00.00100s
|`->config-snap ran successfully @83.28200s +00.00100s
|`->config-snap_config ran successfully @83.28400s +00.00100s
|`->config-ssh-import-id ran successfully @83.28500s +00.83800s
|`->config-locale ran successfully @84.12300s +00.00300s
|`->config-set-passwords ran successfully @84.12600s +00.00200s
|`->config-grub-dpkg ran successfully @84.12800s +01.10000s
|`->config-apt-pipelining ran successfully @85.22800s +00.00200s
|`->config-apt-configure ran successfully @85.23000s +00.09900s
|`->config-ubuntu-advantage ran successfully @85.33000s +00.00100s
|`->config-ntp ran successfully @85.33100s +00.00200s
|`->config-timezone ran successfully @85.33400s +00.00100s
|`->config-disable-ec2-metadata ran successfully @85.33500s +00.00100s
|`->config-runcmd ran successfully @85.33600s +00.00700s
|`->config-byobu ran successfully @85.34400s +00.00100s
Finished stage: (modules-config) 02.08800 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @85.97300s +00.00200s
|`->config-package-update-upgrade-install ran successfully @85.97500s +00.00100s
|`->config-fan ran successfully @85.97700s +00.00100s
|`->config-landscape ran successfully @85.97800s +00.00100s
|`->config-lxd ran successfully @85.98000s +00.00100s
|`->config-ubuntu-drivers ran successfully @85.98100s +00.00100s
|`->config-puppet ran successfully @85.98300s +00.00100s
|`->config-chef ran successfully @85.98400s +00.00100s
|`->config-mcollective ran successfully @85.98600s +00.00100s
|`->config-salt-minion ran successfully @85.98700s +00.00100s
|`->config-rightscale_userdata ran successfully @85.98900s +00.00100s
|`->config-scripts-vendor ran successfully @85.99000s +00.00100s
|`->config-scripts-per-once ran successfully @85.99200s +00.00100s
|`->config-scripts-per-boot ran successfully @85.99300s +00.00100s
|`->config-scripts-per-instance ran successfully @85.99400s +00.00100s
|`->config-scripts-user ran successfully @85.99600s +00.02000s
|`->config-ssh-authkey-fingerprints ran successfully @86.01600s +00.01100s
|`->config-keys-to-console ran successfully @86.02700s +00.14600s
|`->config-phone-home ran successfully @86.17300s +00.00100s
|`->config-final-message ran successfully @86.17500s +00.00500s
|`->config-power-state-change ran successfully @86.18000s +00.00100s
Finished stage: (modules-final) 00.22600 seconds

Total Time: 245.61000 seconds

-- Boot Record 02 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.05100s +00.01300s
|`->get_boot_telemetry @00.06400s +00.02000s
|`->get_system_info @00.08500s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.08500s +00.20700s
|`->load_azure_ds_dir @00.29200s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.29700s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.29700s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.32300s +00.22400s
|`->_get_metadata_from_imds @00.54800s +00.01600s
Finished stage: (azure-ds/get_metadata_from_imds) 00.29900 seconds

|`->_get_random_seed @00.62100s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.54700 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.63300s +00.00000s
|`->write_files @00.63400s +00.00300s
Finished stage: (azure-ds/_get_data) 00.58600 seconds

Finished stage: (init-local/search-Azure) 00.58900 seconds

|`->network config from imds @00.69300s +00.00100s
Total Time: 2.02900 seconds

-- Boot Record 03 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.00000s +00.01200s
|`->get_boot_telemetry @00.01200s +00.01300s
|`->get_system_info @00.02500s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.02500s +00.20900s
|`->load_azure_ds_dir @00.23400s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.23600s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.23700s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00200 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00200 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.23800s +00.15400s
|`->_get_metadata_from_imds @00.39200s +00.00700s
Finished stage: (azure-ds/get_metadata_from_imds) 00.21900 seconds

|`->_get_random_seed @00.45700s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.44300 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.46800s +00.00100s
|`->write_files @00.46900s +00.00200s
Finished stage: (azure-ds/_get_data) 00.47100 seconds

|`->network config from imds @00.47500s +00.00000s
Finished stage: (init-local) 01.30000 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.18100s +00.02400s
|`->network config from imds @03.27000s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.28200s +00.00100s
|`->perform_hostname_bounce @03.29000s +00.00100s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.01300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.29600s +00.06300s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.35900s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.38000s +00.00900s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.39000s +00.00700s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01300 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.40400s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.03000 seconds

|`->_report_ready @03.41000s +00.00600s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.12100 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.12200 seconds

Finished stage: (azure-ds/_negotiate) 00.13500 seconds

Finished stage: (azure-ds/setup) 00.13500 seconds

Finished stage: (init-network/setup-datasource) 00.13600 seconds

|`->reading and applying user-data @03.42500s +00.00900s
|`->reading and applying vendor-data @03.43400s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.46900s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.47000s +00.14500s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.14500 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.14600 seconds

Finished stage: (azure-ds/activate) 00.14700 seconds

Finished stage: (init-network/activate-datasource) 00.14900 seconds

|`->config-migrator ran successfully @03.63200s +00.00100s
|`->config-seed_random previously ran @03.63400s +00.00000s
|`->config-bootcmd ran successfully @03.63500s +00.00000s
|`->config-write-files previously ran @03.63500s +00.00100s
|`->config-growpart ran successfully @03.63700s +00.06900s
|`->config-resizefs ran successfully @03.70700s +00.18000s
|`->config-disk_setup previously ran @03.88800s +00.00100s
|`->config-mounts previously ran @03.88900s +00.00000s
|`->config-set_hostname previously ran @03.89000s +00.00000s
|`->config-update_hostname ran successfully @03.89100s +00.00100s
|`->config-update_etc_hosts ran successfully @03.89200s +00.00100s
|`->config-ca-certs previously ran @03.89300s +00.00000s
|`->config-rsyslog previously ran @03.89400s +00.00000s
|`->config-users-groups previously ran @03.89400s +00.00100s
|`->config-ssh previously ran @03.89500s +00.00000s
Finished stage: (init-network) 00.73000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @06.87500s +00.00100s
|`->config-snap previously ran @06.87600s +00.00100s
|`->config-snap_config previously ran @06.87700s +00.00000s
|`->config-ssh-import-id previously ran @06.87700s +00.00100s
|`->config-locale previously ran @06.87800s +00.00000s
|`->config-set-passwords previously ran @06.87900s +00.00000s
|`->config-grub-dpkg previously ran @06.88000s +00.00000s
|`->config-apt-pipelining previously ran @06.88000s +00.00100s
|`->config-apt-configure previously ran @06.88100s +00.00000s
|`->config-ubuntu-advantage previously ran @06.88200s +00.00000s
|`->config-ntp previously ran @06.88200s +00.00100s
|`->config-timezone previously ran @06.88300s +00.00000s
|`->config-disable-ec2-metadata ran successfully @06.88300s +00.00100s
|`->config-runcmd previously ran @06.88400s +00.00000s
|`->config-byobu previously ran @06.88400s +00.00100s
Finished stage: (modules-config) 00.02600 seconds

Starting stage: modules-final
|`->config-snappy previously ran @07.47800s +00.00100s
|`->config-package-update-upgrade-install previously ran @07.47900s +00.00000s
|`->config-fan previously ran @07.48000s +00.00000s
|`->config-landscape previously ran @07.48000s +00.00000s
|`->config-lxd previously ran @07.48100s +00.00000s
|`->config-ubuntu-drivers previously ran @07.48200s +00.00000s
|`->config-puppet previously ran @07.48200s +00.00000s
|`->config-chef previously ran @07.48300s +00.00000s
|`->config-mcollective previously ran @07.48300s +00.00100s
|`->config-salt-minion previously ran @07.48400s +00.00000s
|`->config-rightscale_userdata previously ran @07.48500s +00.00000s
|`->config-scripts-vendor previously ran @07.48600s +00.00000s
|`->config-scripts-per-once previously ran @07.48600s +00.00000s
|`->config-scripts-per-boot ran successfully @07.48700s +00.00000s
|`->config-scripts-per-instance previously ran @07.48800s +00.00000s
|`->config-scripts-user previously ran @07.48800s +00.00000s
|`->config-ssh-authkey-fingerprints previously ran @07.48900s +00.00000s
|`->config-keys-to-console previously ran @07.48900s +00.00100s
|`->config-phone-home previously ran @07.49000s +00.00000s
|`->config-final-message ran successfully @07.49100s +00.00400s
|`->config-power-state-change previously ran @07.49600s +00.00000s
Finished stage: (modules-final) 00.03500 seconds

Total Time: 4.52800 seconds

3 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- cloud-init analyze blame
-- Boot Record 01 --
     41.84100s (azure-ds/obtain-dhcp-lease)
     03.92500s (azure-ds/_report_ready)
     01.49200s (init-network/config-disk_setup)
     01.18200s (init-network/config-resizefs)
     01.10000s (modules-config/config-grub-dpkg)
     00.85400s (init-network/config-growpart)
     00.83800s (modules-config/config-ssh-import-id)
     00.66100s (init-network/config-ssh)
     00.50500s (init-network/config-users-groups)
     00.26000s (init-network/config-mounts)
     00.20100s (azure-ds/generate_certificate)
     00.19100s (azure-ds/_has_ntfs_filesystem)
     00.14600s (modules-final/config-keys-to-console)
     00.09900s (modules-config/config-apt-configure)
     00.08600s (azure-ds/get_boot_telemetry)
     00.05500s (azure-ds/list_possible_azure_ds_devs)
     00.02700s (azure-ds/_get_metadata_from_imds)
     00.02500s (init-network/check-cache)
     00.02000s (modules-final/config-scripts-user)
     00.01200s (azure-ds/write_files)
     00.01100s (modules-final/config-ssh-authkey-fingerprints)
     00.01100s (azure-ds/check-platform-viability)
     00.00900s (init-network/consume-user-data)
     00.00900s (azure-ds/_decrypt_certs_from_xml)
     00.00700s (modules-config/config-runcmd)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00300s (modules-config/config-locale)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-ntp)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (azure-ds/get_system_info)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/temporary_hostname)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

-- Boot Record 02 --
     00.22400s (azure-ds/obtain-dhcp-lease)
     00.20700s (azure-ds/list_possible_azure_ds_devs)
     00.02000s (azure-ds/get_boot_telemetry)
     00.01600s (azure-ds/_get_metadata_from_imds)
     00.01300s (azure-ds/check-platform-viability)
     00.00300s (azure-ds/write_files)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

-- Boot Record 03 --
     00.20900s (azure-ds/list_possible_azure_ds_devs)
     00.18000s (init-network/config-resizefs)
     00.15400s (azure-ds/obtain-dhcp-lease)
     00.14500s (azure-ds/_has_ntfs_filesystem)
     00.06900s (init-network/config-growpart)
     00.06300s (azure-ds/generate_certificate)
     00.02400s (init-network/check-cache)
     00.01300s (azure-ds/get_boot_telemetry)
     00.01200s (azure-ds/check-platform-viability)
     00.00900s (init-network/consume-user-data)
     00.00900s (azure-ds/_decrypt_certs_from_xml)
     00.00700s (azure-ds/_run_x509_action)
     00.00700s (azure-ds/_get_metadata_from_imds)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_report_ready)
     00.00400s (modules-final/config-final-message)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-snappy)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-keys-to-console)
     00.00100s (modules-config/config-ssh-import-id)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-users-groups)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-disk_setup)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/temporary_hostname)
     00.00100s (azure-ds/perform_hostname_bounce)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (modules-final/config-ubuntu-drivers)
     00.00000s (modules-final/config-ssh-authkey-fingerprints)
     00.00000s (modules-final/config-scripts-vendor)
     00.00000s (modules-final/config-scripts-user)
     00.00000s (modules-final/config-scripts-per-once)
     00.00000s (modules-final/config-scripts-per-instance)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-puppet)
     00.00000s (modules-final/config-power-state-change)
     00.00000s (modules-final/config-phone-home)
     00.00000s (modules-final/config-package-update-upgrade-install)
     00.00000s (modules-final/config-lxd)
     00.00000s (modules-final/config-landscape)
     00.00000s (modules-final/config-fan)
     00.00000s (modules-final/config-chef)
     00.00000s (modules-config/config-ubuntu-advantage)
     00.00000s (modules-config/config-timezone)
     00.00000s (modules-config/config-snap_config)
     00.00000s (modules-config/config-set-passwords)
     00.00000s (modules-config/config-runcmd)
     00.00000s (modules-config/config-locale)
     00.00000s (modules-config/config-grub-dpkg)
     00.00000s (modules-config/config-apt-configure)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-ssh)
     00.00000s (init-network/config-set_hostname)
     00.00000s (init-network/config-seed_random)
     00.00000s (init-network/config-rsyslog)
     00.00000s (init-network/config-mounts)
     00.00000s (init-network/config-ca-certs)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

3 boot records analyzed
+ echo After upgrade Networking config
After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides: &id001
                route-metric: 100
            dhcp6: true
            dhcp6-overrides: *id001
            match:
                macaddress: 00:0d:3a:7d:b6:f1
            set-name: eth0
    version: 2
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- sudo reboot
Connection to 52.232.200.231 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 00:19:56 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.232.200.231 -- grep 'Update datasource' /var/log/cloud-init.log
2019-12-06 00:10:22,034 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 00:18:15,492 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 00:18:16,135 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
2019-12-06 00:19:45,966 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 00:19:46,590 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END eoan
### END eoan


### Second round. no ipv6/advanced networking
+ SRU_SERIES=xenial bionic disco eoan
+ REGION=eastus2
+ VNET_NAME=sruVnet
+ NETWORK_SECURITY_GROUP=sruNetSecGroup
+ NIC_NAME=sruNic
+ RESOURCE_GROUP=srugroupIPV6
+ BOOT_DIAG=storeitsru
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
+ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ [ Registered != Registered -o Registered != Registered ]
+ az provider show -n Microsoft.Network
+ jq -r .registrationState
+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo Waiting for Microsoft.Network IPv6 feature registration
Waiting for Microsoft.Network IPv6 feature registration
+ [ Registered != Registered ]
+ cat
+ cat
+ az group create --name srugroupIPV6 --location eastus2
{
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6",
  "location": "eastus2",
  "managedBy": null,
  "name": "srugroupIPV6",
  "properties": {
    "provisioningState": "Succeeded"
  },
  "tags": null,
  "type": "Microsoft.Resources/resourceGroups"
}
+ [ -n storeitsru ]
+ az storage account create --name storeitsru --resource-group srugroupIPV6 --location eastus2 --sku Standard_RAGRS --kind StorageV2
WARNING: The default kind for created storage account will change to 'StorageV2' from 'Storage' in future
{
  "accessTier": "Hot",
  "azureFilesIdentityBasedAuthentication": null,
  "creationTime": "2019-12-06T03:30:07.433903+00:00",
  "customDomain": null,
  "enableHttpsTrafficOnly": true,
  "encryption": {
    "keySource": "Microsoft.Storage",
    "keyVaultProperties": null,
    "services": {
      "blob": {
        "enabled": true,
        "lastEnabledTime": "2019-12-06T03:30:07.512545+00:00"
      },
      "file": {
        "enabled": true,
        "lastEnabledTime": "2019-12-06T03:30:07.512545+00:00"
      },
      "queue": null,
      "table": null
    }
  },
  "failoverInProgress": null,
  "geoReplicationStats": null,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Storage/storageAccounts/storeitsru",
  "identity": null,
  "isHnsEnabled": null,
  "kind": "StorageV2",
  "largeFileSharesState": null,
  "lastGeoFailoverTime": null,
  "location": "eastus2",
  "name": "storeitsru",
  "networkRuleSet": {
    "bypass": "AzureServices",
    "defaultAction": "Allow",
    "ipRules": [],
    "virtualNetworkRules": []
  },
  "primaryEndpoints": {
    "blob": "https://storeitsru.blob.core.windows.net/",
    "dfs": "https://storeitsru.dfs.core.windows.net/",
    "file": "https://storeitsru.file.core.windows.net/",
    "queue": "https://storeitsru.queue.core.windows.net/",
    "table": "https://storeitsru.table.core.windows.net/",
    "web": "https://storeitsru.z20.web.core.windows.net/"
  },
  "primaryLocation": "eastus2",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "secondaryEndpoints": {
    "blob": "https://storeitsru-secondary.blob.core.windows.net/",
    "dfs": "https://storeitsru-secondary.dfs.core.windows.net/",
    "file": null,
    "queue": "https://storeitsru-secondary.queue.core.windows.net/",
    "table": "https://storeitsru-secondary.table.core.windows.net/",
    "web": "https://storeitsru-secondary.z20.web.core.windows.net/"
  },
  "secondaryLocation": "centralus",
  "sku": {
    "capabilities": null,
    "kind": null,
    "locations": null,
    "name": "Standard_RAGRS",
    "resourceType": null,
    "restrictions": null,
    "tier": "Standard"
  },
  "statusOfPrimary": "available",
  "statusOfSecondary": "available",
  "tags": {},
  "type": "Microsoft.Storage/storageAccounts"
}
+ BOOT_DIAG_ARG=--boot-diagnostics-storage storeitsru
+ az network vnet create --resource-group srugroupIPV6 --name sruVnet --address-prefixes 192.168.0.0/16 ace:cab:deca::/48
{
  "newVNet": {
    "addressSpace": {
      "addressPrefixes": [
        "192.168.0.0/16",
        "ace:cab:deca::/48"
      ]
    },
    "ddosProtectionPlan": null,
    "dhcpOptions": {
      "dnsServers": []
    },
    "enableDdosProtection": false,
    "enableVmProtection": false,
    "etag": "W/\"406a2f29-9584-46e3-b865-8f30b78a9ccf\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet",
    "location": "eastus2",
    "name": "sruVnet",
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "f1f8c460-1d3a-4f80-8378-5f84305a81b3",
    "subnets": [],
    "tags": {},
    "type": "Microsoft.Network/virtualNetworks",
    "virtualNetworkPeerings": []
  }
}
+ az network nsg create --resource-group srugroupIPV6 --name sruNetSecGroup
{
  "NewNSG": {
    "defaultSecurityRules": [
      {
        "access": "Allow",
        "description": "Allow inbound traffic from all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"c5152caf-f777-4798-a0d5-87f7be44526b\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetInBound",
        "name": "AllowVnetInBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow inbound traffic from azure load balancer",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"c5152caf-f777-4798-a0d5-87f7be44526b\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowAzureLoadBalancerInBound",
        "name": "AllowAzureLoadBalancerInBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "AzureLoadBalancer",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all inbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"c5152caf-f777-4798-a0d5-87f7be44526b\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllInBound",
        "name": "DenyAllInBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"c5152caf-f777-4798-a0d5-87f7be44526b\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetOutBound",
        "name": "AllowVnetOutBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to Internet",
        "destinationAddressPrefix": "Internet",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"c5152caf-f777-4798-a0d5-87f7be44526b\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowInternetOutBound",
        "name": "AllowInternetOutBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all outbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"c5152caf-f777-4798-a0d5-87f7be44526b\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllOutBound",
        "name": "DenyAllOutBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      }
    ],
    "etag": "W/\"c5152caf-f777-4798-a0d5-87f7be44526b\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": "eastus2",
    "name": "sruNetSecGroup",
    "networkInterfaces": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "bf1638a5-66a3-491d-b16a-8c1b00a96d48",
    "securityRules": [],
    "subnets": null,
    "tags": null,
    "type": "Microsoft.Network/networkSecurityGroups"
  }
}
+ az network vnet subnet create --name sruSubnet --resource-group srugroupIPV6 --vnet-name sruVnet --address-prefixes 192.168.0.0/24 ace:cab:deca:deed::/64 --network-security-group sruNetSecGroup
{
  "addressPrefix": null,
  "addressPrefixes": [
    "192.168.0.0/24",
    "ace:cab:deca:deed::/64"
  ],
  "delegations": [],
  "etag": "W/\"84351429-86a0-400c-87c7-43423bc0f013\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
  "ipConfigurationProfiles": null,
  "ipConfigurations": null,
  "name": "sruSubnet",
  "natGateway": null,
  "networkSecurityGroup": {
    "defaultSecurityRules": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": null,
    "name": null,
    "networkInterfaces": null,
    "provisioningState": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": null,
    "securityRules": null,
    "subnets": null,
    "tags": null,
    "type": null
  },
  "privateEndpointNetworkPolicies": "Enabled",
  "privateEndpoints": null,
  "privateLinkServiceNetworkPolicies": "Enabled",
  "provisioningState": "Succeeded",
  "purpose": null,
  "resourceGroup": "srugroupIPV6",
  "resourceNavigationLinks": null,
  "routeTable": null,
  "serviceAssociationLinks": null,
  "serviceEndpointPolicies": null,
  "serviceEndpoints": null,
  "type": "Microsoft.Network/virtualNetworks/subnets"
}
+ az network nsg rule create --resource-group srugroupIPV6 --nsg-name sruNetSecGroup --name Allow-SSH-Internet --access Allow --protocol Tcp --direction Inbound --priority 100 --source-address-prefix * --source-port-range * --destination-address-prefix * --destination-port-range 22
{
  "access": "Allow",
  "description": null,
  "destinationAddressPrefix": "*",
  "destinationAddressPrefixes": [],
  "destinationApplicationSecurityGroups": null,
  "destinationPortRange": "22",
  "destinationPortRanges": [],
  "direction": "Inbound",
  "etag": "W/\"bacfbc48-89e4-43a0-b487-69d7278bed22\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/securityRules/Allow-SSH-Internet",
  "name": "Allow-SSH-Internet",
  "priority": 100,
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "sourceAddressPrefix": "*",
  "sourceAddressPrefixes": [],
  "sourceApplicationSecurityGroups": null,
  "sourcePortRange": "*",
  "sourcePortRanges": [],
  "type": "Microsoft.Network/networkSecurityGroups/securityRules"
}
+ sshopts=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR
+ echo ### BEGIN xenial
### BEGIN xenial
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=16.04-DAILY-LTS
+ netcfg=/etc/network/interfaces.d/50-cloud-init.cfg
+ [  =  ]
+ echo Creating standard network vm
Creating standard network vm
+ name=test-sru-xenial
+ az vm create --name=test-sru-xenial --image=Canonical:UbuntuServer:16.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-xenial",
  "location": "eastus2",
  "macAddress": "00-0D-3A-0E-7E-18",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.4",
  "publicIpAddress": "52.167.216.56",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-xenial
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.167.216.56
+ echo Created test-sru-xenial: ubuntu@ubuntu@52.167.216.56
Created test-sru-xenial: ubuntu@ubuntu@52.167.216.56
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.216.56 -- cloud-init status --wait --long
Enter passphrase for key '/root/.ssh/id_rsa':


real    22m5.009s
user    0m8.963s
sys    0m1.010s
root@publishing:~# azure_delete_all
[
  null,
  null,
  null,
  null,
  null,
  null,
  null,
  null,
  null
]
root@publishing:~# rm azure-sru2.log
root@publishing:~# time ./azure-sru-19.3.41.txt 2>&1 | tee azure-sru2.log
+ SRU_SERIES=xenial bionic disco eoan
+ REGION=eastus2
+ VNET_NAME=sruVnet
+ NETWORK_SECURITY_GROUP=sruNetSecGroup
+ NIC_NAME=sruNic
+ RESOURCE_GROUP=srugroupIPV6
+ BOOT_DIAG=storeitsru
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
+ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ [ Registered != Registered -o Registered != Registered ]
+ az provider show -n Microsoft.Network
+ jq -r .registrationState
+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo Waiting for Microsoft.Network IPv6 feature registration
Waiting for Microsoft.Network IPv6 feature registration
+ [ Registered != Registered ]
+ cat
+ cat
+ az group create --name srugroupIPV6 --location eastus2
{
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6",
  "location": "eastus2",
  "managedBy": null,
  "name": "srugroupIPV6",
  "properties": {
    "provisioningState": "Succeeded"
  },
  "tags": null,
  "type": "Microsoft.Resources/resourceGroups"
}
+ [ -n storeitsru ]
+ az storage account create --name storeitsru --resource-group srugroupIPV6 --location eastus2 --sku Standard_RAGRS --kind StorageV2
WARNING: The default kind for created storage account will change to 'StorageV2' from 'Storage' in future
{
  "accessTier": "Hot",
  "azureFilesIdentityBasedAuthentication": null,
  "creationTime": "2019-12-06T03:54:21.637039+00:00",
  "customDomain": null,
  "enableHttpsTrafficOnly": true,
  "encryption": {
    "keySource": "Microsoft.Storage",
    "keyVaultProperties": null,
    "services": {
      "blob": {
        "enabled": true,
        "lastEnabledTime": "2019-12-06T03:54:21.715160+00:00"
      },
      "file": {
        "enabled": true,
        "lastEnabledTime": "2019-12-06T03:54:21.715160+00:00"
      },
      "queue": null,
      "table": null
    }
  },
  "failoverInProgress": null,
  "geoReplicationStats": null,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Storage/storageAccounts/storeitsru",
  "identity": null,
  "isHnsEnabled": null,
  "kind": "StorageV2",
  "largeFileSharesState": null,
  "lastGeoFailoverTime": null,
  "location": "eastus2",
  "name": "storeitsru",
  "networkRuleSet": {
    "bypass": "AzureServices",
    "defaultAction": "Allow",
    "ipRules": [],
    "virtualNetworkRules": []
  },
  "primaryEndpoints": {
    "blob": "https://storeitsru.blob.core.windows.net/",
    "dfs": "https://storeitsru.dfs.core.windows.net/",
    "file": "https://storeitsru.file.core.windows.net/",
    "queue": "https://storeitsru.queue.core.windows.net/",
    "table": "https://storeitsru.table.core.windows.net/",
    "web": "https://storeitsru.z20.web.core.windows.net/"
  },
  "primaryLocation": "eastus2",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "secondaryEndpoints": {
    "blob": "https://storeitsru-secondary.blob.core.windows.net/",
    "dfs": "https://storeitsru-secondary.dfs.core.windows.net/",
    "file": null,
    "queue": "https://storeitsru-secondary.queue.core.windows.net/",
    "table": "https://storeitsru-secondary.table.core.windows.net/",
    "web": "https://storeitsru-secondary.z20.web.core.windows.net/"
  },
  "secondaryLocation": "centralus",
  "sku": {
    "capabilities": null,
    "kind": null,
    "locations": null,
    "name": "Standard_RAGRS",
    "resourceType": null,
    "restrictions": null,
    "tier": "Standard"
  },
  "statusOfPrimary": "available",
  "statusOfSecondary": "available",
  "tags": {},
  "type": "Microsoft.Storage/storageAccounts"
}
+ BOOT_DIAG_ARG=--boot-diagnostics-storage storeitsru
+ az network vnet create --resource-group srugroupIPV6 --name sruVnet --address-prefixes 192.168.0.0/16 ace:cab:deca::/48
{
  "newVNet": {
    "addressSpace": {
      "addressPrefixes": [
        "192.168.0.0/16",
        "ace:cab:deca::/48"
      ]
    },
    "ddosProtectionPlan": null,
    "dhcpOptions": {
      "dnsServers": []
    },
    "enableDdosProtection": false,
    "enableVmProtection": false,
    "etag": "W/\"44a86b8b-a37e-4a6e-b5cd-24b4f458328b\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet",
    "location": "eastus2",
    "name": "sruVnet",
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "73f8eed9-014c-4937-8825-5009b12d2b0c",
    "subnets": [],
    "tags": {},
    "type": "Microsoft.Network/virtualNetworks",
    "virtualNetworkPeerings": []
  }
}
+ az network nsg create --resource-group srugroupIPV6 --name sruNetSecGroup
{
  "NewNSG": {
    "defaultSecurityRules": [
      {
        "access": "Allow",
        "description": "Allow inbound traffic from all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"0c5eb6c1-bb4a-4152-a151-d3fee1535568\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetInBound",
        "name": "AllowVnetInBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow inbound traffic from azure load balancer",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"0c5eb6c1-bb4a-4152-a151-d3fee1535568\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowAzureLoadBalancerInBound",
        "name": "AllowAzureLoadBalancerInBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "AzureLoadBalancer",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all inbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"0c5eb6c1-bb4a-4152-a151-d3fee1535568\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllInBound",
        "name": "DenyAllInBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"0c5eb6c1-bb4a-4152-a151-d3fee1535568\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetOutBound",
        "name": "AllowVnetOutBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to Internet",
        "destinationAddressPrefix": "Internet",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"0c5eb6c1-bb4a-4152-a151-d3fee1535568\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowInternetOutBound",
        "name": "AllowInternetOutBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all outbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"0c5eb6c1-bb4a-4152-a151-d3fee1535568\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllOutBound",
        "name": "DenyAllOutBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      }
    ],
    "etag": "W/\"0c5eb6c1-bb4a-4152-a151-d3fee1535568\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": "eastus2",
    "name": "sruNetSecGroup",
    "networkInterfaces": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "fbc1d0c5-0e22-438c-9784-f951a747bf2a",
    "securityRules": [],
    "subnets": null,
    "tags": null,
    "type": "Microsoft.Network/networkSecurityGroups"
  }
}
+ az network vnet subnet create --name sruSubnet --resource-group srugroupIPV6 --vnet-name sruVnet --address-prefixes 192.168.0.0/24 ace:cab:deca:deed::/64 --network-security-group sruNetSecGroup
{
  "addressPrefix": null,
  "addressPrefixes": [
    "192.168.0.0/24",
    "ace:cab:deca:deed::/64"
  ],
  "delegations": [],
  "etag": "W/\"8a03ebf9-e61a-4b67-b187-a76208582a7a\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
  "ipConfigurationProfiles": null,
  "ipConfigurations": null,
  "name": "sruSubnet",
  "natGateway": null,
  "networkSecurityGroup": {
    "defaultSecurityRules": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": null,
    "name": null,
    "networkInterfaces": null,
    "provisioningState": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": null,
    "securityRules": null,
    "subnets": null,
    "tags": null,
    "type": null
  },
  "privateEndpointNetworkPolicies": "Enabled",
  "privateEndpoints": null,
  "privateLinkServiceNetworkPolicies": "Enabled",
  "provisioningState": "Succeeded",
  "purpose": null,
  "resourceGroup": "srugroupIPV6",
  "resourceNavigationLinks": null,
  "routeTable": null,
  "serviceAssociationLinks": null,
  "serviceEndpointPolicies": null,
  "serviceEndpoints": null,
  "type": "Microsoft.Network/virtualNetworks/subnets"
}
+ az network nsg rule create --resource-group srugroupIPV6 --nsg-name sruNetSecGroup --name Allow-SSH-Internet --access Allow --protocol Tcp --direction Inbound --priority 100 --source-address-prefix * --source-port-range * --destination-address-prefix * --destination-port-range 22
{
  "access": "Allow",
  "description": null,
  "destinationAddressPrefix": "*",
  "destinationAddressPrefixes": [],
  "destinationApplicationSecurityGroups": null,
  "destinationPortRange": "22",
  "destinationPortRanges": [],
  "direction": "Inbound",
  "etag": "W/\"a6cbb5ba-728d-410c-b3ee-92e007857255\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/securityRules/Allow-SSH-Internet",
  "name": "Allow-SSH-Internet",
  "priority": 100,
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "sourceAddressPrefix": "*",
  "sourceAddressPrefixes": [],
  "sourceApplicationSecurityGroups": null,
  "sourcePortRange": "*",
  "sourcePortRanges": [],
  "type": "Microsoft.Network/networkSecurityGroups/securityRules"
}
+ sshopts=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR
+ echo ### BEGIN xenial
### BEGIN xenial
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=16.04-DAILY-LTS
+ netcfg=/etc/network/interfaces.d/50-cloud-init.cfg
+ [  =  ]
+ echo Creating standard network vm
Creating standard network vm
+ name=test-sru-xenial
+ az vm create --name=test-sru-xenial --image=Canonical:UbuntuServer:16.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-xenial",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7D-68-0E",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.4",
  "publicIpAddress": "52.177.63.138",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-xenial
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.177.63.138
+ echo Created test-sru-xenial: ubuntu@ubuntu@52.177.63.138
Created test-sru-xenial: ubuntu@ubuntu@52.177.63.138
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.63.138 -- cloud-init status --wait --long
Enter passphrase for key '/root/.ssh/id_rsa':


real    8m42.249s
user    0m8.923s
sys    0m1.128s
root@publishing:~# azure_delete_all
[
  null,
  null,
  null,
  null,
  null,
  null,
  null,
  null,
  null
]
root@publishing:~# rm azure-sru2.log
root@publishing:~# sshkey
Agent pid 12801
Enter passphrase for /root/.ssh/id_rsa:
Identity added: /root/.ssh/id_rsa (/root/.ssh/id_rsa)
root@publishing:~# time ./azure-sru-19.3.41.txt 2>&1 | tee azure-sru2.log
+ SRU_SERIES=xenial bionic disco eoan
+ REGION=eastus2
+ VNET_NAME=sruVnet
+ NETWORK_SECURITY_GROUP=sruNetSecGroup
+ NIC_NAME=sruNic
+ RESOURCE_GROUP=srugroupIPV6
+ BOOT_DIAG=storeitsru
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
+ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ [ Registered != Registered -o Registered != Registered ]
+ az provider show -n Microsoft.Network
+ jq -r .registrationState
+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo Waiting for Microsoft.Network IPv6 feature registration
Waiting for Microsoft.Network IPv6 feature registration
+ [ Registered != Registered ]
+ cat
+ cat
+ az group create --name srugroupIPV6 --location eastus2
{
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6",
  "location": "eastus2",
  "managedBy": null,
  "name": "srugroupIPV6",
  "properties": {
    "provisioningState": "Succeeded"
  },
  "tags": null,
  "type": "Microsoft.Resources/resourceGroups"
}
+ [ -n storeitsru ]
+ az storage account create --name storeitsru --resource-group srugroupIPV6 --location eastus2 --sku Standard_RAGRS --kind StorageV2
WARNING: The default kind for created storage account will change to 'StorageV2' from 'Storage' in future
{
  "accessTier": "Hot",
  "azureFilesIdentityBasedAuthentication": null,
  "creationTime": "2019-12-06T04:39:42.134392+00:00",
  "customDomain": null,
  "enableHttpsTrafficOnly": true,
  "encryption": {
    "keySource": "Microsoft.Storage",
    "keyVaultProperties": null,
    "services": {
      "blob": {
        "enabled": true,
        "lastEnabledTime": "2019-12-06T04:39:42.181256+00:00"
      },
      "file": {
        "enabled": true,
        "lastEnabledTime": "2019-12-06T04:39:42.181256+00:00"
      },
      "queue": null,
      "table": null
    }
  },
  "failoverInProgress": null,
  "geoReplicationStats": null,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Storage/storageAccounts/storeitsru",
  "identity": null,
  "isHnsEnabled": null,
  "kind": "StorageV2",
  "largeFileSharesState": null,
  "lastGeoFailoverTime": null,
  "location": "eastus2",
  "name": "storeitsru",
  "networkRuleSet": {
    "bypass": "AzureServices",
    "defaultAction": "Allow",
    "ipRules": [],
    "virtualNetworkRules": []
  },
  "primaryEndpoints": {
    "blob": "https://storeitsru.blob.core.windows.net/",
    "dfs": "https://storeitsru.dfs.core.windows.net/",
    "file": "https://storeitsru.file.core.windows.net/",
    "queue": "https://storeitsru.queue.core.windows.net/",
    "table": "https://storeitsru.table.core.windows.net/",
    "web": "https://storeitsru.z20.web.core.windows.net/"
  },
  "primaryLocation": "eastus2",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "secondaryEndpoints": {
    "blob": "https://storeitsru-secondary.blob.core.windows.net/",
    "dfs": "https://storeitsru-secondary.dfs.core.windows.net/",
    "file": null,
    "queue": "https://storeitsru-secondary.queue.core.windows.net/",
    "table": "https://storeitsru-secondary.table.core.windows.net/",
    "web": "https://storeitsru-secondary.z20.web.core.windows.net/"
  },
  "secondaryLocation": "centralus",
  "sku": {
    "capabilities": null,
    "kind": null,
    "locations": null,
    "name": "Standard_RAGRS",
    "resourceType": null,
    "restrictions": null,
    "tier": "Standard"
  },
  "statusOfPrimary": "available",
  "statusOfSecondary": "available",
  "tags": {},
  "type": "Microsoft.Storage/storageAccounts"
}
+ BOOT_DIAG_ARG=--boot-diagnostics-storage storeitsru
+ az network vnet create --resource-group srugroupIPV6 --name sruVnet --address-prefixes 192.168.0.0/16 ace:cab:deca::/48
{
  "newVNet": {
    "addressSpace": {
      "addressPrefixes": [
        "192.168.0.0/16",
        "ace:cab:deca::/48"
      ]
    },
    "ddosProtectionPlan": null,
    "dhcpOptions": {
      "dnsServers": []
    },
    "enableDdosProtection": false,
    "enableVmProtection": false,
    "etag": "W/\"17f51b18-5193-4c16-9365-e95ae822c986\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet",
    "location": "eastus2",
    "name": "sruVnet",
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "af471e76-9ee3-4253-9975-d2c671f86d29",
    "subnets": [],
    "tags": {},
    "type": "Microsoft.Network/virtualNetworks",
    "virtualNetworkPeerings": []
  }
}
+ az network nsg create --resource-group srugroupIPV6 --name sruNetSecGroup
{
  "NewNSG": {
    "defaultSecurityRules": [
      {
        "access": "Allow",
        "description": "Allow inbound traffic from all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"9051e53c-3ae0-4adf-bcee-2ab6b781ec99\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetInBound",
        "name": "AllowVnetInBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow inbound traffic from azure load balancer",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"9051e53c-3ae0-4adf-bcee-2ab6b781ec99\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowAzureLoadBalancerInBound",
        "name": "AllowAzureLoadBalancerInBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "AzureLoadBalancer",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all inbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"9051e53c-3ae0-4adf-bcee-2ab6b781ec99\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllInBound",
        "name": "DenyAllInBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"9051e53c-3ae0-4adf-bcee-2ab6b781ec99\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetOutBound",
        "name": "AllowVnetOutBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to Internet",
        "destinationAddressPrefix": "Internet",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"9051e53c-3ae0-4adf-bcee-2ab6b781ec99\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowInternetOutBound",
        "name": "AllowInternetOutBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all outbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"9051e53c-3ae0-4adf-bcee-2ab6b781ec99\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllOutBound",
        "name": "DenyAllOutBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      }
    ],
    "etag": "W/\"9051e53c-3ae0-4adf-bcee-2ab6b781ec99\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": "eastus2",
    "name": "sruNetSecGroup",
    "networkInterfaces": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "70afdb46-8a2d-47ff-b994-646aeb1b86e0",
    "securityRules": [],
    "subnets": null,
    "tags": null,
    "type": "Microsoft.Network/networkSecurityGroups"
  }
}
+ az network vnet subnet create --name sruSubnet --resource-group srugroupIPV6 --vnet-name sruVnet --address-prefixes 192.168.0.0/24 ace:cab:deca:deed::/64 --network-security-group sruNetSecGroup
{
  "addressPrefix": null,
  "addressPrefixes": [
    "192.168.0.0/24",
    "ace:cab:deca:deed::/64"
  ],
  "delegations": [],
  "etag": "W/\"d1558583-a0ad-4c02-ade8-572716a287fb\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
  "ipConfigurationProfiles": null,
  "ipConfigurations": null,
  "name": "sruSubnet",
  "natGateway": null,
  "networkSecurityGroup": {
    "defaultSecurityRules": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": null,
    "name": null,
    "networkInterfaces": null,
    "provisioningState": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": null,
    "securityRules": null,
    "subnets": null,
    "tags": null,
    "type": null
  },
  "privateEndpointNetworkPolicies": "Enabled",
  "privateEndpoints": null,
  "privateLinkServiceNetworkPolicies": "Enabled",
  "provisioningState": "Succeeded",
  "purpose": null,
  "resourceGroup": "srugroupIPV6",
  "resourceNavigationLinks": null,
  "routeTable": null,
  "serviceAssociationLinks": null,
  "serviceEndpointPolicies": null,
  "serviceEndpoints": null,
  "type": "Microsoft.Network/virtualNetworks/subnets"
}
+ az network nsg rule create --resource-group srugroupIPV6 --nsg-name sruNetSecGroup --name Allow-SSH-Internet --access Allow --protocol Tcp --direction Inbound --priority 100 --source-address-prefix * --source-port-range * --destination-address-prefix * --destination-port-range 22
{
  "access": "Allow",
  "description": null,
  "destinationAddressPrefix": "*",
  "destinationAddressPrefixes": [],
  "destinationApplicationSecurityGroups": null,
  "destinationPortRange": "22",
  "destinationPortRanges": [],
  "direction": "Inbound",
  "etag": "W/\"a352c054-2c8b-4879-a98b-dd1b0d3e4148\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/securityRules/Allow-SSH-Internet",
  "name": "Allow-SSH-Internet",
  "priority": 100,
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "sourceAddressPrefix": "*",
  "sourceAddressPrefixes": [],
  "sourceApplicationSecurityGroups": null,
  "sourcePortRange": "*",
  "sourcePortRanges": [],
  "type": "Microsoft.Network/networkSecurityGroups/securityRules"
}
+ sshopts=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR
+ echo ### BEGIN xenial
### BEGIN xenial
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=16.04-DAILY-LTS
+ netcfg=/etc/network/interfaces.d/50-cloud-init.cfg
+ [  =  ]
+ echo Creating standard network vm
Creating standard network vm
+ name=test-sru-xenial
+ az vm create --name=test-sru-xenial --image=Canonical:UbuntuServer:16.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-xenial",
  "location": "eastus2",
  "macAddress": "00-0D-3A-0E-07-98",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.4",
  "publicIpAddress": "104.209.247.64",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-xenial
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@104.209.247.64
+ echo Created test-sru-xenial: ubuntu@ubuntu@104.209.247.64
Created test-sru-xenial: ubuntu@ubuntu@104.209.247.64
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 04:46:01 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- dpkg-query --show cloud-init
cloud-init    19.2-36-g059d049c-0ubuntu2~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- systemd-analyze
Startup finished in 5.653s (kernel) + 57.976s (userspace) = 1min 3.630s
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- systemd-analyze blame
         34.660s cloud-init-local.service
          8.466s cloud-init.service
          4.263s cloud-config.service
          2.661s snapd.seeded.service
          2.416s snapd.service
          2.398s pollinate.service
          2.271s lxd-containers.service
          2.149s dev-sda1.device
          1.519s apparmor.service
          1.129s accounts-daemon.service
           834ms cloud-final.service
           783ms mdadm.service
           727ms grub-common.service
           707ms networking.service
           686ms iscsid.service
           593ms lvm2-monitor.service
           536ms open-iscsi.service
           530ms polkitd.service
           422ms systemd-logind.service
           404ms systemd-timesyncd.service
           374ms console-setup.service
           340ms rsyslog.service
           309ms rc-local.service
           295ms systemd-modules-load.service
           277ms irqbalance.service
           225ms resolvconf.service
           208ms ondemand.service
           203ms systemd-tmpfiles-setup-dev.service
           201ms systemd-udev-trigger.service
           200ms systemd-journald.service
           175ms keyboard-setup.service
           172ms systemd-update-utmp.service
           163ms systemd-udevd.service
           162ms systemd-remount-fs.service
           160ms apport.service
           153ms snapd.socket
           145ms kmod-static-nodes.service
           143ms ufw.service
           136ms dev-mqueue.mount
           128ms dev-hugepages.mount
           127ms ssh.service
           121ms systemd-journal-flush.service
           106ms setvtrgb.service
            91ms systemd-random-seed.service
            86ms sys-kernel-debug.mount
            76ms systemd-sysctl.service
            74ms plymouth-read-write.service
            66ms lxd.socket
            55ms systemd-tmpfiles-setup.service
            46ms plymouth-quit.service
            43ms systemd-machine-id-commit.service
            31ms systemd-user-sessions.service
            30ms boot-efi.mount
            27ms plymouth-quit-wait.service
            26ms user@1000.service
            25ms sys-fs-fuse-connections.mount
            25ms sys-kernel-config.mount
            21ms ephemeral-disk-warning.service
            13ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.02100s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.17100s +00.00600s
|`->get_boot_telemetry @00.17800s +00.01000s
|`->get_system_info @00.18800s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.18900s +00.06100s
|`->load_azure_ds_dir @00.25000s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.39400s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.39500s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.01200 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01800 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.42100s +30.76100s
|`->_get_metadata_from_imds @31.18200s +00.04100s
Finished stage: (azure-ds/get_metadata_from_imds) 30.82600 seconds

|`->_get_random_seed @31.24700s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 31.06700 seconds

|`->write_files @31.25600s +00.00200s
Finished stage: (azure-ds/_get_data) 31.08800 seconds

Finished stage: (init-local/search-Azure) 31.09000 seconds

|`->network config from fallback @31.32500s +00.02000s
Finished stage: (init-local) 31.36000 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @32.50800s +00.02300s
|`->network config from fallback @32.58900s +00.02000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @32.61900s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

|`->invoke_agent @32.62200s +00.18900s
|`->wait for agents to retrieve ssh keys @32.81100s +01.00300s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @33.81500s +00.04300s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.04400 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 01.24000 seconds

Finished stage: (azure-ds/_negotiate) 01.24000 seconds

Finished stage: (azure-ds/setup) 01.24000 seconds

Finished stage: (init-network/setup-datasource) 01.24100 seconds

|`->reading and applying user-data @33.86600s +00.00900s
|`->reading and applying vendor-data @33.87600s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @33.90800s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @33.90800s +00.05500s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @34.04300s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.08600 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.14100 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.14200 seconds

Finished stage: (azure-ds/activate) 00.14200 seconds

Finished stage: (init-network/activate-datasource) 00.14400 seconds

|`->config-migrator ran successfully @34.13200s +00.00100s
|`->config-seed_random ran successfully @34.13400s +00.00100s
|`->config-bootcmd ran successfully @34.13600s +00.00000s
|`->config-write-files ran successfully @34.13600s +00.00100s
|`->config-growpart ran successfully @34.13800s +00.45200s
|`->config-resizefs ran successfully @34.59100s +00.29500s
|`->config-disk_setup ran successfully @34.88600s +04.63200s
|`->config-mounts ran successfully @39.51900s +00.16300s
|`->config-set_hostname ran successfully @39.68300s +00.00800s
|`->config-update_hostname ran successfully @39.69100s +00.00200s
|`->config-update_etc_hosts ran successfully @39.69300s +00.00100s
|`->config-ca-certs ran successfully @39.69400s +00.00100s
|`->config-rsyslog ran successfully @39.69600s +00.00100s
|`->config-users-groups ran successfully @39.69700s +00.64100s
|`->config-ssh ran successfully @40.33900s +00.20700s
Finished stage: (init-network) 08.05200 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @47.01700s +00.00100s
|`->config-snap ran successfully @47.01800s +00.00100s
|`->config-snap_config ran successfully @47.02000s +00.00100s
|`->config-ssh-import-id ran successfully @47.02200s +00.80000s
|`->config-locale ran successfully @47.82300s +01.49800s
|`->config-set-passwords ran successfully @49.32200s +00.00200s
|`->config-grub-dpkg ran successfully @49.32400s +01.11400s
|`->config-apt-pipelining ran successfully @50.44000s +00.00100s
|`->config-apt-configure ran successfully @50.44100s +00.20500s
|`->config-ubuntu-advantage ran successfully @50.64700s +00.00100s
|`->config-ntp ran successfully @50.64800s +00.00100s
|`->config-timezone ran successfully @50.65000s +00.00100s
|`->config-disable-ec2-metadata ran successfully @50.65200s +00.00000s
|`->config-runcmd ran successfully @50.65300s +00.00200s
|`->config-byobu ran successfully @50.65500s +00.00100s
Finished stage: (modules-config) 03.67500 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @51.25800s +00.00200s
|`->config-package-update-upgrade-install ran successfully @51.26000s +00.00100s
|`->config-fan ran successfully @51.26200s +00.00100s
|`->config-landscape ran successfully @51.26300s +00.00100s
|`->config-lxd ran successfully @51.26500s +00.00100s
|`->config-ubuntu-drivers ran successfully @51.26700s +00.00100s
|`->config-puppet ran successfully @51.26900s +00.00000s
|`->config-chef ran successfully @51.27000s +00.00100s
|`->config-mcollective ran successfully @51.27200s +00.00100s
|`->config-salt-minion ran successfully @51.27300s +00.00100s
|`->config-rightscale_userdata ran successfully @51.27500s +00.00100s
|`->config-scripts-vendor ran successfully @51.27600s +00.00100s
|`->config-scripts-per-once ran successfully @51.27800s +00.00100s
|`->config-scripts-per-boot ran successfully @51.27900s +00.00100s
|`->config-scripts-per-instance ran successfully @51.28000s +00.00100s
|`->config-scripts-user ran successfully @51.28200s +00.02200s
|`->config-ssh-authkey-fingerprints ran successfully @51.30500s +00.02700s
|`->config-keys-to-console ran successfully @51.37400s +00.11600s
|`->config-phone-home ran successfully @51.49100s +00.00100s
|`->config-final-message ran successfully @51.49300s +00.00500s
|`->config-power-state-change ran successfully @51.49800s +00.00200s
Finished stage: (modules-final) 00.29800 seconds

Total Time: 173.15000 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- cloud-init analyze blame
-- Boot Record 01 --
     30.76100s (azure-ds/obtain-dhcp-lease)
     04.63200s (init-network/config-disk_setup)
     01.49800s (modules-config/config-locale)
     01.11400s (modules-config/config-grub-dpkg)
     01.00300s (azure-ds/waiting-for-ssh-public-key)
     00.80000s (modules-config/config-ssh-import-id)
     00.64100s (init-network/config-users-groups)
     00.45200s (init-network/config-growpart)
     00.29500s (init-network/config-resizefs)
     00.20700s (init-network/config-ssh)
     00.20500s (modules-config/config-apt-configure)
     00.18900s (azure-ds/invoke_agent)
     00.16300s (init-network/config-mounts)
     00.11600s (modules-final/config-keys-to-console)
     00.06100s (azure-ds/list_possible_azure_ds_devs)
     00.05500s (azure-ds/_has_ntfs_filesystem)
     00.04300s (azure-ds/crtfile_to_pubkey)
     00.04100s (azure-ds/_get_metadata_from_imds)
     00.02700s (modules-final/config-ssh-authkey-fingerprints)
     00.02300s (init-network/check-cache)
     00.02200s (modules-final/config-scripts-user)
     00.02000s (azure-ds/parse_network_config)
     00.02000s (azure-ds/parse_network_config)
     00.01000s (azure-ds/get_boot_telemetry)
     00.00900s (init-network/consume-user-data)
     00.00800s (init-network/config-set_hostname)
     00.00600s (azure-ds/check-platform-viability)
     00.00500s (modules-final/config-final-message)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-final/config-power-state-change)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-runcmd)
     00.00200s (init-network/config-update_hostname)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/count_files)
     00.00000s (modules-final/config-puppet)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Networking config
Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
# This file is generated from information provided by
# the datasource.  Changes to it will not persist across an instance.
# To disable cloud-init's network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@104.209.247.64:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- sudo bash ./setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu xenial-proposed/main amd64 cloud-init all 19.3-41-gc4735dd3-0ubuntu1~16.04.1 [414 kB]
Preparing to unpack .../cloud-init_19.3-41-gc4735dd3-0ubuntu1~16.04.1_all.deb ...
Unpacking cloud-init (19.3-41-gc4735dd3-0ubuntu1~16.04.1) over (19.2-36-g059d049c-0ubuntu2~16.04.1) ...
Setting up cloud-init (19.3-41-gc4735dd3-0ubuntu1~16.04.1) ...
Leaving 'diversion of /etc/init/ureadahead.conf to /etc/init/ureadahead.conf.disabled by cloud-init'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- dpkg-query --show cloud-init
cloud-init    19.3-41-gc4735dd3-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- sudo hostname SRU-didnt-work
sudo: unable to resolve host SRU-worked-azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- sudo rm -f /etc/network/interfaces.d/50-cloud-init.cfg
sudo: unable to resolve host SRU-didnt-work
+ [  =  ]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- sudo cloud-init clean --logs --reboot
sudo: unable to resolve host SRU-didnt-work
Connection to 104.209.247.64 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 04:47:17 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- sudo systemd-analyze blame
sudo: unable to resolve host SRU-worked-azure
          2.661s cloud-init.service
          1.743s cloud-init-local.service
          1.738s cloud-config.service
          1.495s dev-sda1.device
          1.314s snapd.service
          1.030s grub-common.service
           733ms iscsid.service
           722ms cloud-final.service
           697ms apparmor.service
           628ms accounts-daemon.service
           597ms lvm2-monitor.service
           564ms networking.service
           559ms lxd-containers.service
           423ms systemd-timesyncd.service
           369ms mdadm.service
           365ms ssh.service
           364ms console-setup.service
           276ms irqbalance.service
           273ms ondemand.service
           267ms apport.service
           265ms ufw.service
           248ms rsyslog.service
           242ms keyboard-setup.service
           242ms sys-kernel-debug.mount
           228ms resolvconf.service
           213ms systemd-logind.service
           213ms dev-mqueue.mount
           211ms systemd-tmpfiles-setup.service
           209ms kmod-static-nodes.service
           199ms systemd-udev-trigger.service
           198ms dev-hugepages.mount
           196ms polkitd.service
           190ms systemd-journald.service
           181ms open-iscsi.service
           140ms rc-local.service
           129ms systemd-remount-fs.service
           127ms systemd-modules-load.service
           125ms lxd.socket
           116ms setvtrgb.service
            93ms systemd-journal-flush.service
            89ms snapd.socket
            76ms systemd-random-seed.service
            56ms systemd-tmpfiles-setup-dev.service
            56ms sys-fs-fuse-connections.mount
            55ms snapd.seeded.service
            47ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            46ms systemd-sysctl.service
            46ms systemd-udevd.service
            42ms systemd-user-sessions.service
            42ms plymouth-quit.service
            41ms plymouth-quit-wait.service
            38ms systemd-update-utmp.service
            38ms sys-kernel-config.mount
            29ms plymouth-read-write.service
            24ms user@1000.service
            19ms systemd-update-utmp-runlevel.service
            16ms ephemeral-disk-warning.service
            14ms boot-efi.mount
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00600s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03900s +00.00600s
|`->get_boot_telemetry @00.04500s +00.01000s
|`->get_system_info @00.05500s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.05600s +00.17300s
|`->load_azure_ds_dir @00.23000s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.23300s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.23400s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.25600s +00.14800s
|`->_get_metadata_from_imds @00.40500s +00.01500s
Finished stage: (azure-ds/get_metadata_from_imds) 00.18600 seconds

|`->_get_random_seed @00.44100s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.39400 seconds

|`->write_files @00.45000s +00.00200s
Finished stage: (azure-ds/_get_data) 00.41300 seconds

Finished stage: (init-local/search-Azure) 00.41600 seconds

|`->network config from fallback @00.51100s +00.02000s
Finished stage: (init-local) 00.54500 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @01.54000s +00.02300s
|`->network config from fallback @01.62200s +00.02100s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @01.65500s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

|`->invoke_agent @01.65800s +00.16300s
|`->wait for agents to retrieve ssh keys @01.82100s +00.00200s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @01.82300s +00.02600s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.02600 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 00.19600 seconds

Finished stage: (azure-ds/_negotiate) 00.19600 seconds

Finished stage: (azure-ds/setup) 00.19700 seconds

Finished stage: (init-network/setup-datasource) 00.19700 seconds

|`->reading and applying user-data @01.86400s +00.01700s
|`->reading and applying vendor-data @01.88200s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @01.95600s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @01.95700s +00.08100s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.08200 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.08200 seconds

Finished stage: (azure-ds/activate) 00.08300 seconds

Finished stage: (init-network/activate-datasource) 00.08400 seconds

|`->config-migrator ran successfully @02.06800s +00.00200s
|`->config-seed_random ran successfully @02.07100s +00.00200s
|`->config-bootcmd ran successfully @02.07400s +00.00100s
|`->config-write-files ran successfully @02.07500s +00.00100s
|`->config-growpart ran successfully @02.07900s +00.10800s
|`->config-resizefs ran successfully @02.18700s +00.02900s
|`->config-disk_setup ran successfully @02.21600s +00.20800s
|`->config-mounts ran successfully @02.43000s +00.17000s
|`->config-set_hostname ran successfully @02.60000s +00.01500s
|`->config-update_hostname ran successfully @02.61600s +00.00100s
|`->config-update_etc_hosts ran successfully @02.61800s +00.00400s
|`->config-ca-certs ran successfully @02.62300s +00.00100s
|`->config-rsyslog ran successfully @02.62400s +00.00100s
|`->config-users-groups ran successfully @02.63000s +00.21300s
|`->config-ssh ran successfully @02.84400s +00.89800s
Finished stage: (init-network) 02.21600 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @05.99700s +00.00100s
|`->config-snap ran successfully @05.99800s +00.00100s
|`->config-snap_config ran successfully @06.00000s +00.00100s
|`->config-ssh-import-id ran successfully @06.00100s +00.58600s
|`->config-locale ran successfully @06.58700s +00.00200s
|`->config-set-passwords ran successfully @06.58900s +00.01200s
|`->config-grub-dpkg ran successfully @06.60200s +00.35800s
|`->config-apt-pipelining ran successfully @06.96100s +00.00100s
|`->config-apt-configure ran successfully @06.96300s +00.26600s
|`->config-ubuntu-advantage ran successfully @07.22900s +00.00100s
|`->config-ntp ran successfully @07.23100s +00.00100s
|`->config-timezone ran successfully @07.23200s +00.00100s
|`->config-disable-ec2-metadata ran successfully @07.23400s +00.00000s
|`->config-runcmd ran successfully @07.23500s +00.00200s
|`->config-byobu ran successfully @07.23700s +00.00200s
Finished stage: (modules-config) 01.25800 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @07.77600s +00.00100s
|`->config-package-update-upgrade-install ran successfully @07.77800s +00.00100s
|`->config-fan ran successfully @07.77900s +00.00100s
|`->config-landscape ran successfully @07.78100s +00.00100s
|`->config-lxd ran successfully @07.78200s +00.00100s
|`->config-ubuntu-drivers ran successfully @07.78400s +00.00100s
|`->config-puppet ran successfully @07.78500s +00.00100s
|`->config-chef ran successfully @07.78700s +00.00100s
|`->config-mcollective ran successfully @07.78800s +00.00100s
|`->config-salt-minion ran successfully @07.79000s +00.00000s
|`->config-rightscale_userdata ran successfully @07.79100s +00.00100s
|`->config-scripts-vendor ran successfully @07.79200s +00.00100s
|`->config-scripts-per-once ran successfully @07.79400s +00.00000s
|`->config-scripts-per-boot ran successfully @07.79500s +00.00000s
|`->config-scripts-per-instance ran successfully @07.79600s +00.00100s
|`->config-scripts-user ran successfully @07.79700s +00.00400s
|`->config-ssh-authkey-fingerprints ran successfully @07.80200s +00.07700s
|`->config-keys-to-console ran successfully @07.88000s +00.11400s
|`->config-phone-home ran successfully @07.99500s +00.00100s
|`->config-final-message ran successfully @07.99700s +00.00400s
|`->config-power-state-change ran successfully @08.00100s +00.00100s
Finished stage: (modules-final) 00.25400 seconds

Total Time: 6.83600 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- cloud-init analyze blame
-- Boot Record 01 --
     00.89800s (init-network/config-ssh)
     00.58600s (modules-config/config-ssh-import-id)
     00.35800s (modules-config/config-grub-dpkg)
     00.26600s (modules-config/config-apt-configure)
     00.21300s (init-network/config-users-groups)
     00.20800s (init-network/config-disk_setup)
     00.17300s (azure-ds/list_possible_azure_ds_devs)
     00.17000s (init-network/config-mounts)
     00.16300s (azure-ds/invoke_agent)
     00.14800s (azure-ds/obtain-dhcp-lease)
     00.11400s (modules-final/config-keys-to-console)
     00.10800s (init-network/config-growpart)
     00.08100s (azure-ds/_has_ntfs_filesystem)
     00.07700s (modules-final/config-ssh-authkey-fingerprints)
     00.02900s (init-network/config-resizefs)
     00.02600s (azure-ds/crtfile_to_pubkey)
     00.02300s (init-network/check-cache)
     00.02100s (azure-ds/parse_network_config)
     00.02000s (azure-ds/parse_network_config)
     00.01700s (init-network/consume-user-data)
     00.01500s (init-network/config-set_hostname)
     00.01500s (azure-ds/_get_metadata_from_imds)
     00.01200s (modules-config/config-set-passwords)
     00.01000s (azure-ds/get_boot_telemetry)
     00.00600s (azure-ds/check-platform-viability)
     00.00400s (modules-final/config-scripts-user)
     00.00400s (modules-final/config-final-message)
     00.00400s (init-network/config-update_etc_hosts)
     00.00200s (modules-config/config-runcmd)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-byobu)
     00.00200s (init-network/config-seed_random)
     00.00200s (init-network/config-migrator)
     00.00200s (azure-ds/write_files)
     00.00200s (azure-ds/waiting-for-ssh-public-key)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-snappy)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-network/config-bootcmd)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-per-once)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade Networking config
After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- sudo reboot
sudo: unable to resolve host SRU-worked-azure
Connection to 104.209.247.64 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 04:48:21 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.247.64 -- grep 'Update datasource' /var/log/cloud-init.log
2019-12-06 04:47:09,849 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 04:48:13,210 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 04:48:13,693 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END xenial
### END xenial
+ echo ### BEGIN bionic
### BEGIN bionic
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=18.04-DAILY-LTS
+ [  =  ]
+ echo Creating standard network vm
Creating standard network vm
+ name=test-sru-bionic
+ az vm create --name=test-sru-bionic --image=Canonical:UbuntuServer:18.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-bionic",
  "location": "eastus2",
  "macAddress": "00-0D-3A-04-38-26",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.5",
  "publicIpAddress": "52.177.9.43",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-bionic
+ + jq -rawk .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
 {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.177.9.43
+ echo Created test-sru-bionic: ubuntu@ubuntu@52.177.9.43
Created test-sru-bionic: ubuntu@ubuntu@52.177.9.43
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 04:52:11 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- dpkg-query --show cloud-init
cloud-init    19.2-36-g059d049c-0ubuntu2~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- systemd-analyze
Startup finished in 6.381s (kernel) + 32.939s (userspace) = 39.320s
graphical.target reached after 31.985s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- systemd-analyze blame
         10.200s cloud-init.service
          4.952s cloud-init-local.service
          3.082s snapd.seeded.service
          2.936s cloud-config.service
          2.769s lxd-containers.service
          2.717s snapd.service
          2.686s dev-sda1.device
          2.591s keyboard-setup.service
          2.267s pollinate.service
          1.670s systemd-networkd-wait-online.service
          1.478s apparmor.service
          1.268s networkd-dispatcher.service
           953ms cloud-final.service
           931ms accounts-daemon.service
           877ms grub-common.service
           870ms apport.service
           768ms systemd-logind.service
           730ms systemd-user-sessions.service
           577ms rsyslog.service
           415ms systemd-timesyncd.service
           390ms lvm2-monitor.service
           339ms systemd-modules-load.service
           290ms systemd-udev-trigger.service
           238ms systemd-remount-fs.service
           235ms ufw.service
           232ms kmod-static-nodes.service
           207ms blk-availability.service
           203ms polkit.service
           201ms systemd-journal-flush.service
           201ms ssh.service
           201ms dev-mqueue.mount
           200ms systemd-journald.service
           192ms ebtables.service
           171ms lxd.socket
           166ms systemd-networkd.service
           154ms sys-kernel-debug.mount
           144ms systemd-tmpfiles-setup-dev.service
           127ms systemd-udevd.service
           116ms dev-hugepages.mount
           114ms systemd-tmpfiles-setup.service
            99ms systemd-sysctl.service
            96ms systemd-resolved.service
            91ms sys-fs-fuse-connections.mount
            89ms systemd-machine-id-commit.service
            89ms systemd-random-seed.service
            89ms sys-kernel-config.mount
            80ms plymouth-read-write.service
            52ms snapd.socket
            46ms plymouth-quit.service
            39ms user@1000.service
            36ms setvtrgb.service
            32ms systemd-update-utmp.service
            27ms ephemeral-disk-warning.service
            27ms console-setup.service
            22ms boot-efi.mount
            19ms plymouth-quit-wait.service
            15ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.13000s +00.00900s
|`->get_boot_telemetry @00.14000s +00.01500s
|`->get_system_info @00.15500s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.15600s +00.05200s
|`->load_azure_ds_dir @00.20800s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.33400s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.33500s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00800 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.36300s +00.42900s
|`->_get_metadata_from_imds @00.79200s +00.01700s
Finished stage: (azure-ds/get_metadata_from_imds) 00.47100 seconds

|`->_get_random_seed @00.83500s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.68800 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.84500s +00.00000s
|`->write_files @00.84600s +00.00200s
Finished stage: (azure-ds/_get_data) 00.71900 seconds

Finished stage: (init-local/search-Azure) 00.72200 seconds

|`->network config from imds @00.92600s +00.00000s
Finished stage: (init-local) 01.14600 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.63800s +00.03400s
|`->network config from imds @03.72900s +00.00100s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.74100s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.74500s +00.14400s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.89000s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.91500s +00.01500s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.93100s +00.00700s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.23900 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @04.17000s +00.00700s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00800 seconds

Finished stage: (azure-ds/parse_certificates) 00.26300 seconds

|`->_report_ready @04.17800s +03.07200s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.50500 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.50600 seconds

Finished stage: (azure-ds/_negotiate) 03.51100 seconds

Finished stage: (azure-ds/setup) 03.51100 seconds

Finished stage: (init-network/setup-datasource) 03.51300 seconds

|`->reading and applying user-data @07.26800s +00.01000s
|`->reading and applying vendor-data @07.27900s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @07.31600s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @07.31700s +00.13500s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.53600s +00.00700s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.09700 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.23300 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.23400 seconds

Finished stage: (azure-ds/activate) 00.23400 seconds

Finished stage: (init-network/activate-datasource) 00.23600 seconds

|`->config-migrator ran successfully @07.60400s +00.00000s
|`->config-seed_random ran successfully @07.60500s +00.01400s
|`->config-bootcmd ran successfully @07.62000s +00.00000s
|`->config-write-files ran successfully @07.62100s +00.00100s
|`->config-growpart ran successfully @07.62200s +00.62300s
|`->config-resizefs ran successfully @08.24600s +01.28300s
|`->config-disk_setup ran successfully @09.53000s +02.44500s
|`->config-mounts ran successfully @11.98100s +00.21200s
|`->config-set_hostname ran successfully @12.19400s +00.00700s
|`->config-update_hostname ran successfully @12.20200s +00.00100s
|`->config-update_etc_hosts ran successfully @12.20400s +00.00000s
|`->config-ca-certs ran successfully @12.20500s +00.00100s
|`->config-rsyslog ran successfully @12.20600s +00.00100s
|`->config-users-groups ran successfully @12.20700s +00.53500s
|`->config-ssh ran successfully @12.74200s +00.42600s
Finished stage: (init-network) 09.54600 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @20.24000s +00.00100s
|`->config-snap ran successfully @20.24200s +00.00100s
|`->config-snap_config ran successfully @20.24300s +00.00100s
|`->config-ssh-import-id ran successfully @20.24400s +00.80200s
|`->config-locale ran successfully @21.05100s +00.00200s
|`->config-set-passwords ran successfully @21.05300s +00.00200s
|`->config-grub-dpkg ran successfully @21.05600s +01.28300s
|`->config-apt-pipelining ran successfully @22.34000s +00.00200s
|`->config-apt-configure ran successfully @22.34200s +00.14300s
|`->config-ubuntu-advantage ran successfully @22.48600s +00.00100s
|`->config-ntp ran successfully @22.48700s +00.00100s
|`->config-timezone ran successfully @22.48900s +00.00100s
|`->config-disable-ec2-metadata ran successfully @22.49000s +00.00000s
|`->config-runcmd ran successfully @22.49100s +00.00600s
|`->config-byobu ran successfully @22.49700s +00.00100s
Finished stage: (modules-config) 02.30300 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @23.23300s +00.00200s
|`->config-package-update-upgrade-install ran successfully @23.23500s +00.00100s
|`->config-fan ran successfully @23.23700s +00.00100s
|`->config-landscape ran successfully @23.23800s +00.00100s
|`->config-lxd ran successfully @23.24000s +00.00000s
|`->config-ubuntu-drivers ran successfully @23.24100s +00.00100s
|`->config-puppet ran successfully @23.24200s +00.00100s
|`->config-chef ran successfully @23.24400s +00.00000s
|`->config-mcollective ran successfully @23.24500s +00.00100s
|`->config-salt-minion ran successfully @23.24600s +00.00100s
|`->config-rightscale_userdata ran successfully @23.24800s +00.00100s
|`->config-scripts-vendor ran successfully @23.24900s +00.00100s
|`->config-scripts-per-once ran successfully @23.25000s +00.00100s
|`->config-scripts-per-boot ran successfully @23.25200s +00.00000s
|`->config-scripts-per-instance ran successfully @23.25300s +00.00100s
|`->config-scripts-user ran successfully @23.25400s +00.02600s
|`->config-ssh-authkey-fingerprints ran successfully @23.28100s +00.06100s
|`->config-keys-to-console ran successfully @23.34300s +00.07400s
|`->config-phone-home ran successfully @23.45400s +00.00100s
|`->config-final-message ran successfully @23.45600s +00.00600s
|`->config-power-state-change ran successfully @23.46200s +00.00100s
Finished stage: (modules-final) 00.27100 seconds

Total Time: 34.97400 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- cloud-init analyze blame
-- Boot Record 01 --
     03.07200s (azure-ds/_report_ready)
     02.44500s (init-network/config-disk_setup)
     01.28300s (modules-config/config-grub-dpkg)
     01.28300s (init-network/config-resizefs)
     00.80200s (modules-config/config-ssh-import-id)
     00.62300s (init-network/config-growpart)
     00.53500s (init-network/config-users-groups)
     00.42900s (azure-ds/obtain-dhcp-lease)
     00.42600s (init-network/config-ssh)
     00.21200s (init-network/config-mounts)
     00.14400s (azure-ds/generate_certificate)
     00.14300s (modules-config/config-apt-configure)
     00.13500s (azure-ds/_has_ntfs_filesystem)
     00.07400s (modules-final/config-keys-to-console)
     00.06100s (modules-final/config-ssh-authkey-fingerprints)
     00.05200s (azure-ds/list_possible_azure_ds_devs)
     00.03400s (init-network/check-cache)
     00.02600s (modules-final/config-scripts-user)
     00.01700s (azure-ds/_get_metadata_from_imds)
     00.01500s (azure-ds/get_boot_telemetry)
     00.01500s (azure-ds/_decrypt_certs_from_xml)
     00.01400s (init-network/config-seed_random)
     00.01000s (init-network/consume-user-data)
     00.00900s (azure-ds/check-platform-viability)
     00.00700s (init-network/config-set_hostname)
     00.00700s (azure-ds/count_files)
     00.00700s (azure-ds/_run_x509_action)
     00.00700s (azure-ds/_run_x509_action)
     00.00600s (modules-final/config-final-message)
     00.00600s (modules-config/config-runcmd)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-lxd)
     00.00000s (modules-final/config-chef)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-migrator)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Networking config
Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by
# the datasource.  Changes to it will not persist across an instance.
# To disable cloud-init's network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            match:
                macaddress: 00:0d:3a:04:38:26
            set-name: eth0
    version: 2
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@52.177.9.43:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- sudo bash ./setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu bionic-proposed/main amd64 cloud-init all 19.3-41-gc4735dd3-0ubuntu1~18.04.1 [411 kB]
Preparing to unpack .../cloud-init_19.3-41-gc4735dd3-0ubuntu1~18.04.1_all.deb ...
Unpacking cloud-init (19.3-41-gc4735dd3-0ubuntu1~18.04.1) over (19.2-36-g059d049c-0ubuntu2~18.04.1) ...
Setting up cloud-init (19.3-41-gc4735dd3-0ubuntu1~18.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- dpkg-query --show cloud-init
cloud-init    19.3-41-gc4735dd3-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ [  =  ]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- sudo cloud-init clean --logs --reboot
Connection to 52.177.9.43 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 04:54:01 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- sudo systemd-analyze blame
          3.246s cloud-config.service
          2.690s dev-sda1.device
          2.605s keyboard-setup.service
          2.371s cloud-init.service
          1.743s cloud-init-local.service
          1.420s systemd-networkd-wait-online.service
          1.028s lxd-containers.service
          1.022s snapd.service
           953ms cloud-final.service
           846ms networkd-dispatcher.service
           805ms accounts-daemon.service
           673ms apparmor.service
           600ms apport.service
           598ms grub-common.service
           572ms systemd-udev-trigger.service
           530ms systemd-timesyncd.service
           347ms lvm2-monitor.service
           307ms systemd-journald.service
           260ms polkit.service
           257ms ssh.service
           250ms systemd-logind.service
           244ms systemd-modules-load.service
           204ms blk-availability.service
           200ms ebtables.service
           179ms dev-hugepages.mount
           178ms dev-mqueue.mount
           176ms ufw.service
           174ms kmod-static-nodes.service
           166ms sys-kernel-debug.mount
           147ms systemd-remount-fs.service
           141ms rsyslog.service
           125ms systemd-journal-flush.service
           120ms snapd.socket
           111ms systemd-udevd.service
            97ms systemd-tmpfiles-setup-dev.service
            96ms systemd-tmpfiles-setup.service
            89ms systemd-sysctl.service
            88ms sys-kernel-config.mount
            80ms systemd-random-seed.service
            78ms sys-fs-fuse-connections.mount
            71ms lxd.socket
            70ms setvtrgb.service
            69ms systemd-resolved.service
            61ms plymouth-quit-wait.service
            59ms systemd-user-sessions.service
            59ms snapd.seeded.service
            58ms boot-efi.mount
            54ms systemd-networkd.service
            51ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            47ms systemd-update-utmp.service
            44ms user@1000.service
            44ms plymouth-quit.service
            42ms console-setup.service
            22ms ephemeral-disk-warning.service
            22ms systemd-update-utmp-runlevel.service
            16ms plymouth-read-write.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.04900s +00.01000s
|`->get_boot_telemetry @00.05900s +00.01600s
|`->get_system_info @00.07500s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.07600s +00.17900s
|`->load_azure_ds_dir @00.25500s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.26000s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.26000s +00.00100s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00500 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.28000s +00.25500s
|`->_get_metadata_from_imds @00.53500s +00.01100s
Finished stage: (azure-ds/get_metadata_from_imds) 00.28600 seconds

|`->_get_random_seed @00.56700s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.50200 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.57800s +00.00000s
|`->write_files @00.57900s +00.00200s
Finished stage: (azure-ds/_get_data) 00.53400 seconds

Finished stage: (init-local/search-Azure) 00.53600 seconds

|`->network config from imds @00.64500s +00.00000s
Finished stage: (init-local) 00.79000 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @02.93200s +00.03500s
|`->network config from imds @03.02600s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.03700s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.04200s +00.14600s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.18900s +00.00000s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.21100s +00.01300s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.22500s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.02000 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.24400s +00.00700s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.04000 seconds

|`->_report_ready @03.25100s +00.00700s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.21700 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.21800 seconds

Finished stage: (azure-ds/_negotiate) 00.22200 seconds

Finished stage: (azure-ds/setup) 00.22300 seconds

Finished stage: (init-network/setup-datasource) 00.22400 seconds

|`->reading and applying user-data @03.26800s +00.00900s
|`->reading and applying vendor-data @03.27700s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.31200s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.31300s +00.14300s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.14400 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.14400 seconds

Finished stage: (azure-ds/activate) 00.14400 seconds

Finished stage: (init-network/activate-datasource) 00.14700 seconds

|`->config-migrator ran successfully @03.50400s +00.00100s
|`->config-seed_random ran successfully @03.50600s +00.00700s
|`->config-bootcmd ran successfully @03.51400s +00.00000s
|`->config-write-files ran successfully @03.51500s +00.00100s
|`->config-growpart ran successfully @03.51700s +00.13100s
|`->config-resizefs ran successfully @03.64900s +00.03100s
|`->config-disk_setup ran successfully @03.68000s +00.17800s
|`->config-mounts ran successfully @03.86300s +00.20600s
|`->config-set_hostname ran successfully @04.07200s +00.00700s
|`->config-update_hostname ran successfully @04.07900s +00.00200s
|`->config-update_etc_hosts ran successfully @04.08100s +00.00100s
|`->config-ca-certs ran successfully @04.08200s +00.00100s
|`->config-rsyslog ran successfully @04.08400s +00.00100s
|`->config-users-groups ran successfully @04.08500s +00.37200s
|`->config-ssh ran successfully @04.45700s +00.19400s
Finished stage: (init-network) 01.73500 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @07.84900s +00.00100s
|`->config-snap ran successfully @07.85100s +00.00100s
|`->config-snap_config ran successfully @07.85200s +00.00100s
|`->config-ssh-import-id ran successfully @07.85700s +01.16200s
|`->config-locale ran successfully @09.02000s +00.00200s
|`->config-set-passwords ran successfully @09.02900s +00.00200s
|`->config-grub-dpkg ran successfully @09.03100s +00.72200s
|`->config-apt-pipelining ran successfully @09.75400s +00.00200s
|`->config-apt-configure ran successfully @09.75600s +00.11700s
|`->config-ubuntu-advantage ran successfully @09.87400s +00.00100s
|`->config-ntp ran successfully @09.87600s +00.00100s
|`->config-timezone ran successfully @09.87700s +00.00100s
|`->config-disable-ec2-metadata ran successfully @09.87800s +00.00100s
|`->config-runcmd ran successfully @09.88000s +00.00700s
|`->config-byobu ran successfully @09.88800s +00.00100s
Finished stage: (modules-config) 02.07500 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @10.66300s +00.00200s
|`->config-package-update-upgrade-install ran successfully @10.66600s +00.00100s
|`->config-fan ran successfully @10.66700s +00.00100s
|`->config-landscape ran successfully @10.66900s +00.00100s
|`->config-lxd ran successfully @10.67100s +00.00100s
|`->config-ubuntu-drivers ran successfully @10.67200s +00.00100s
|`->config-puppet ran successfully @10.67300s +00.00100s
|`->config-chef ran successfully @10.67500s +00.00100s
|`->config-mcollective ran successfully @10.67600s +00.00100s
|`->config-salt-minion ran successfully @10.67700s +00.00100s
|`->config-rightscale_userdata ran successfully @10.67900s +00.00100s
|`->config-scripts-vendor ran successfully @10.68000s +00.00100s
|`->config-scripts-per-once ran successfully @10.68200s +00.00000s
|`->config-scripts-per-boot ran successfully @10.68300s +00.00000s
|`->config-scripts-per-instance ran successfully @10.68400s +00.00100s
|`->config-scripts-user ran successfully @10.68600s +00.00500s
|`->config-ssh-authkey-fingerprints ran successfully @10.69200s +00.06600s
|`->config-keys-to-console ran successfully @10.75800s +00.10800s
|`->config-phone-home ran successfully @10.86700s +00.00100s
|`->config-final-message ran successfully @10.87100s +00.01000s
|`->config-power-state-change ran successfully @10.88300s +00.00100s
Finished stage: (modules-final) 00.24400 seconds

Total Time: 8.46700 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- cloud-init analyze blame
-- Boot Record 01 --
     01.16200s (modules-config/config-ssh-import-id)
     00.72200s (modules-config/config-grub-dpkg)
     00.37200s (init-network/config-users-groups)
     00.25500s (azure-ds/obtain-dhcp-lease)
     00.20600s (init-network/config-mounts)
     00.19400s (init-network/config-ssh)
     00.17900s (azure-ds/list_possible_azure_ds_devs)
     00.17800s (init-network/config-disk_setup)
     00.14600s (azure-ds/generate_certificate)
     00.14300s (azure-ds/_has_ntfs_filesystem)
     00.13100s (init-network/config-growpart)
     00.11700s (modules-config/config-apt-configure)
     00.10800s (modules-final/config-keys-to-console)
     00.06600s (modules-final/config-ssh-authkey-fingerprints)
     00.03500s (init-network/check-cache)
     00.03100s (init-network/config-resizefs)
     00.01600s (azure-ds/get_boot_telemetry)
     00.01300s (azure-ds/_decrypt_certs_from_xml)
     00.01100s (azure-ds/_get_metadata_from_imds)
     00.01000s (modules-final/config-final-message)
     00.01000s (azure-ds/check-platform-viability)
     00.00900s (init-network/consume-user-data)
     00.00700s (modules-config/config-runcmd)
     00.00700s (init-network/config-set_hostname)
     00.00700s (init-network/config-seed_random)
     00.00700s (azure-ds/_run_x509_action)
     00.00700s (azure-ds/_report_ready)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-scripts-user)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-update_hostname)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_get_random_seed)
     00.00100s (azure-ds/_extract_preprovisioned_vm_setting)
     00.00000s (modules-final/config-scripts-per-once)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_networkd_get_value_from_leases)

1 boot records analyzed
+ echo After upgrade Networking config
After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            dhcp6: false
            match:
                macaddress: 00:0d:3a:04:38:26
            set-name: eth0
    version: 2
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- sudo reboot
Connection to 52.177.9.43 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 04:55:06 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.9.43 -- grep 'Update datasource' /var/log/cloud-init.log
2019-12-06 04:53:50,316 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 04:54:57,492 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 04:54:58,003 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END bionic
### END bionic
+ echo ### BEGIN disco
### BEGIN disco
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=19.04-DAILY
+ [  =  ]
+ echo Creating standard network vm
Creating standard network vm
+ name=test-sru-disco
+ az vm create --name=test-sru-disco --image=Canonical:UbuntuServer:19.04-DAILY:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-disco",
  "location": "eastus2",
  "macAddress": "00-0D-3A-0D-93-F9",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.6",
  "publicIpAddress": "13.77.105.12",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-disco
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@13.77.105.12
+ echo Created test-sru-disco: ubuntu@ubuntu@13.77.105.12
Created test-sru-disco: ubuntu@ubuntu@13.77.105.12
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- cloud-init status --wait --long
.................................................................
status: done
time: Fri, 06 Dec 2019 04:57:48 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- dpkg-query --show cloud-init
cloud-init    19.2-36-g059d049c-0ubuntu2~19.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- systemd-analyze
Startup finished in 3.745s (kernel) + 54.328s (userspace) = 58.074s
graphical.target reached after 53.389s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- systemd-analyze blame
         24.643s snapd.seeded.service
          9.960s cloud-init.service
          4.662s cloud-init-local.service
          3.424s lvm2-monitor.service
          3.220s dev-sda1.device
          2.585s cloud-config.service
          2.434s systemd-udev-settle.service
          2.171s pollinate.service
          1.353s systemd-networkd-wait-online.service
          1.266s accounts-daemon.service
          1.244s apparmor.service
          1.203s systemd-logind.service
           949ms networkd-dispatcher.service
           944ms grub-common.service
           876ms cloud-final.service
           869ms systemd-timesyncd.service
           780ms rsyslog.service
           716ms systemd-user-sessions.service
           671ms snap.lxd.activate.service
           637ms systemd-journald.service
           569ms systemd-resolved.service
           530ms atd.service
           499ms systemd-udev-trigger.service
           404ms systemd-networkd.service
           360ms user@1000.service
           353ms snapd.service
           350ms systemd-modules-load.service
           342ms keyboard-setup.service
           308ms dev-mqueue.mount
           296ms sys-kernel-debug.mount
           296ms ufw.service
           291ms systemd-remount-fs.service
           286ms kmod-static-nodes.service
           274ms dev-hugepages.mount
           210ms multipathd.service
           203ms snapd.socket
           199ms grub-initrd-fallback.service
           186ms apport.service
           179ms systemd-sysusers.service
           166ms setvtrgb.service
           155ms systemd-udevd.service
           144ms systemd-tmpfiles-setup.service
           143ms finalrd.service
           140ms systemd-machine-id-commit.service
           134ms ssh.service
           133ms plymouth-read-write.service
           132ms systemd-sysctl.service
           132ms sys-kernel-config.mount
           127ms console-setup.service
           126ms sys-fs-fuse-connections.mount
           108ms systemd-random-seed.service
            90ms systemd-update-utmp.service
            90ms systemd-tmpfiles-setup-dev.service
            87ms systemd-journal-flush.service
            61ms systemd-update-utmp-runlevel.service
            56ms plymouth-quit.service
            53ms plymouth-quit-wait.service
            47ms ephemeral-disk-warning.service
            46ms blk-availability.service
            39ms boot-efi.mount
            39ms dev-loop1.device
            35ms snap-core-8039.mount
            33ms snap-lxd-12631.mount
            20ms dev-loop0.device
            18ms user-runtime-dir@1000.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.10800s +00.01000s
|`->get_boot_telemetry @00.11800s +00.08700s
|`->get_system_info @00.20500s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.20700s +00.05600s
|`->load_azure_ds_dir @00.26400s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.40300s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.40300s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.01000 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01500 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.43200s +00.40100s
|`->_get_metadata_from_imds @00.83300s +00.04100s
Finished stage: (azure-ds/get_metadata_from_imds) 00.46600 seconds

|`->_get_random_seed @00.89800s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.70100 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.90800s +00.00000s
|`->write_files @00.90900s +00.00200s
Finished stage: (azure-ds/_get_data) 00.80400 seconds

Finished stage: (init-local/search-Azure) 00.80700 seconds

|`->network config from imds @00.99400s +00.00000s
Finished stage: (init-local) 01.19300 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.50600s +00.02400s
|`->network config from imds @03.58100s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.59100s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.59500s +00.08300s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.67900s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.71500s +00.01200s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.72800s +00.00700s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.05700 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.78500s +00.00800s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00800 seconds

Finished stage: (azure-ds/parse_certificates) 00.07800 seconds

|`->_report_ready @03.79400s +03.21800s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.41800 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.41800 seconds

Finished stage: (azure-ds/_negotiate) 03.42300 seconds

Finished stage: (azure-ds/setup) 03.42400 seconds

Finished stage: (init-network/setup-datasource) 03.42400 seconds

|`->reading and applying user-data @07.02100s +00.00900s
|`->reading and applying vendor-data @07.03000s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @07.07200s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @07.07300s +00.15700s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.33900s +00.00400s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.12400 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.28300 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.28300 seconds

Finished stage: (azure-ds/activate) 00.28300 seconds

Finished stage: (init-network/activate-datasource) 00.28600 seconds

|`->config-migrator ran successfully @07.42400s +00.00100s
|`->config-seed_random ran successfully @07.42500s +00.00100s
|`->config-bootcmd ran successfully @07.42700s +00.00000s
|`->config-write-files ran successfully @07.42800s +00.00000s
|`->config-growpart ran successfully @07.42900s +00.85600s
|`->config-resizefs ran successfully @08.28600s +01.09200s
|`->config-disk_setup ran successfully @09.37900s +02.48800s
|`->config-mounts ran successfully @11.87400s +00.32500s
|`->config-set_hostname ran successfully @12.20000s +00.00800s
|`->config-update_hostname ran successfully @12.20800s +00.00200s
|`->config-update_etc_hosts ran successfully @12.21000s +00.00100s
|`->config-ca-certs ran successfully @12.21100s +00.00100s
|`->config-rsyslog ran successfully @12.21300s +00.00100s
|`->config-users-groups ran successfully @12.21400s +00.50700s
|`->config-ssh ran successfully @12.72200s +00.21100s
Finished stage: (init-network) 09.44300 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @41.43500s +00.00100s
|`->config-snap ran successfully @41.43600s +00.00100s
|`->config-snap_config ran successfully @41.43800s +00.00100s
|`->config-ssh-import-id ran successfully @41.43900s +00.79500s
|`->config-locale ran successfully @42.23400s +00.00200s
|`->config-set-passwords ran successfully @42.23600s +00.00300s
|`->config-grub-dpkg ran successfully @42.24000s +00.94200s
|`->config-apt-pipelining ran successfully @43.18300s +00.00100s
|`->config-apt-configure ran successfully @43.18400s +00.20100s
|`->config-ubuntu-advantage ran successfully @43.38500s +00.00100s
|`->config-ntp ran successfully @43.38700s +00.00100s
|`->config-timezone ran successfully @43.38800s +00.00100s
|`->config-disable-ec2-metadata ran successfully @43.38900s +00.00100s
|`->config-runcmd ran successfully @43.39000s +00.01900s
|`->config-byobu ran successfully @43.41000s +00.00100s
Finished stage: (modules-config) 02.03300 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @44.16300s +00.00100s
|`->config-package-update-upgrade-install ran successfully @44.16500s +00.00100s
|`->config-fan ran successfully @44.16600s +00.00100s
|`->config-landscape ran successfully @44.16800s +00.00000s
|`->config-lxd ran successfully @44.16900s +00.00100s
|`->config-ubuntu-drivers ran successfully @44.17000s +00.00100s
|`->config-puppet ran successfully @44.17100s +00.00100s
|`->config-chef ran successfully @44.17300s +00.00000s
|`->config-mcollective ran successfully @44.17400s +00.00100s
|`->config-salt-minion ran successfully @44.17500s +00.00100s
|`->config-rightscale_userdata ran successfully @44.17600s +00.00100s
|`->config-scripts-vendor ran successfully @44.17800s +00.00100s
|`->config-scripts-per-once ran successfully @44.17900s +00.00100s
|`->config-scripts-per-boot ran successfully @44.18000s +00.00100s
|`->config-scripts-per-instance ran successfully @44.18100s +00.00100s
|`->config-scripts-user ran successfully @44.18200s +00.03300s
|`->config-ssh-authkey-fingerprints ran successfully @44.21600s +00.07200s
|`->config-keys-to-console ran successfully @44.28900s +00.05700s
|`->config-phone-home ran successfully @44.39700s +00.00200s
|`->config-final-message ran successfully @44.40200s +00.00500s
|`->config-power-state-change ran successfully @44.40800s +00.00100s
Finished stage: (modules-final) 00.29400 seconds

Total Time: 34.28000 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- cloud-init analyze blame
-- Boot Record 01 --
     03.21800s (azure-ds/_report_ready)
     02.48800s (init-network/config-disk_setup)
     01.09200s (init-network/config-resizefs)
     00.94200s (modules-config/config-grub-dpkg)
     00.85600s (init-network/config-growpart)
     00.79500s (modules-config/config-ssh-import-id)
     00.50700s (init-network/config-users-groups)
     00.40100s (azure-ds/obtain-dhcp-lease)
     00.32500s (init-network/config-mounts)
     00.21100s (init-network/config-ssh)
     00.20100s (modules-config/config-apt-configure)
     00.15700s (azure-ds/_has_ntfs_filesystem)
     00.08700s (azure-ds/get_boot_telemetry)
     00.08300s (azure-ds/generate_certificate)
     00.07200s (modules-final/config-ssh-authkey-fingerprints)
     00.05700s (modules-final/config-keys-to-console)
     00.05600s (azure-ds/list_possible_azure_ds_devs)
     00.04100s (azure-ds/_get_metadata_from_imds)
     00.03300s (modules-final/config-scripts-user)
     00.02400s (init-network/check-cache)
     00.01900s (modules-config/config-runcmd)
     00.01200s (azure-ds/_decrypt_certs_from_xml)
     00.01000s (azure-ds/check-platform-viability)
     00.00900s (init-network/consume-user-data)
     00.00800s (init-network/config-set_hostname)
     00.00800s (azure-ds/_run_x509_action)
     00.00700s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00400s (azure-ds/count_files)
     00.00300s (modules-config/config-set-passwords)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-config/config-locale)
     00.00200s (init-network/config-update_hostname)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-snappy)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (modules-final/config-landscape)
     00.00000s (modules-final/config-chef)
     00.00000s (init-network/config-write-files)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Networking config
Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by
# the datasource.  Changes to it will not persist across an instance.
# To disable cloud-init's network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            match:
                macaddress: 00:0d:3a:0d:93:f9
            set-name: eth0
    version: 2
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@13.77.105.12:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- sudo bash ./setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu disco-proposed/main amd64 cloud-init all 19.3-41-gc4735dd3-0ubuntu1~19.04.1 [407 kB]
Preparing to unpack .../cloud-init_19.3-41-gc4735dd3-0ubuntu1~19.04.1_all.deb ...
Unpacking cloud-init (19.3-41-gc4735dd3-0ubuntu1~19.04.1) over (19.2-36-g059d049c-0ubuntu2~19.04.1) ...
Setting up cloud-init (19.3-41-gc4735dd3-0ubuntu1~19.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- dpkg-query --show cloud-init
cloud-init    19.3-41-gc4735dd3-0ubuntu1~19.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ [  =  ]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- sudo cloud-init clean --logs --reboot
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 04:59:12 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- sudo systemd-analyze blame
          3.450s cloud-config.service
          2.646s dev-sda1.device
          2.467s lvm2-monitor.service
          2.414s cloud-init.service
          2.020s cloud-init-local.service
          2.018s systemd-networkd-wait-online.service
          1.795s snap.lxd.activate.service
          1.793s systemd-udev-settle.service
          1.790s systemd-logind.service
          1.439s accounts-daemon.service
          1.041s apport.service
          1.019s grub-common.service
           986ms cloud-final.service
           978ms snapd.service
           874ms rsyslog.service
           860ms networkd-dispatcher.service
           827ms systemd-timesyncd.service
           679ms systemd-journald.service
           571ms ssh.service
           569ms systemd-user-sessions.service
           495ms atd.service
           386ms dev-hugepages.mount
           385ms systemd-modules-load.service
           384ms keyboard-setup.service
           382ms kmod-static-nodes.service
           370ms systemd-remount-fs.service
           360ms ufw.service
           353ms systemd-resolved.service
           350ms sys-kernel-debug.mount
           341ms grub-initrd-fallback.service
           341ms systemd-udev-trigger.service
           332ms dev-mqueue.mount
           307ms systemd-networkd.service
           295ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
           212ms apparmor.service
           147ms plymouth-quit-wait.service
           146ms sys-kernel-config.mount
           143ms console-setup.service
           141ms finalrd.service
           137ms snapd.seeded.service
           135ms setvtrgb.service
           134ms systemd-sysusers.service
           134ms systemd-random-seed.service
           134ms systemd-sysctl.service
           122ms snapd.socket
           115ms sys-fs-fuse-connections.mount
           112ms snap-lxd-12631.mount
           112ms systemd-tmpfiles-setup.service
           107ms systemd-update-utmp.service
            99ms user@1000.service
            99ms dev-loop0.device
            94ms systemd-journal-flush.service
            86ms snap-core-8039.mount
            79ms boot-efi.mount
            74ms plymouth-read-write.service
            65ms plymouth-quit.service
            57ms multipathd.service
            52ms systemd-update-utmp-runlevel.service
            49ms systemd-udevd.service
            46ms dev-loop1.device
            34ms blk-availability.service
            31ms ephemeral-disk-warning.service
            24ms systemd-tmpfiles-setup-dev.service
            24ms user-runtime-dir@1000.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.04100s +00.01000s
|`->get_boot_telemetry @00.05100s +00.02000s
|`->get_system_info @00.07100s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.07100s +00.18400s
|`->load_azure_ds_dir @00.25500s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.26100s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.26200s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00600 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.28500s +00.12800s
|`->_get_metadata_from_imds @00.41300s +00.01100s
Finished stage: (azure-ds/get_metadata_from_imds) 00.16600 seconds

|`->_get_random_seed @00.45100s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.39100 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.46200s +00.00100s
|`->write_files @00.46300s +00.00200s
Finished stage: (azure-ds/_get_data) 00.42600 seconds

Finished stage: (init-local/search-Azure) 00.42800 seconds

|`->network config from imds @00.53700s +00.00000s
Finished stage: (init-local) 00.67100 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.56600s +00.02400s
|`->network config from imds @03.63900s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.65100s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.65600s +00.13700s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.79300s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.82500s +00.01200s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.83900s +00.00500s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01300 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.85200s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.03300 seconds

|`->_report_ready @03.85900s +00.00800s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.21200 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.21300 seconds

Finished stage: (azure-ds/_negotiate) 00.21800 seconds

Finished stage: (azure-ds/setup) 00.21900 seconds

Finished stage: (init-network/setup-datasource) 00.21900 seconds

|`->reading and applying user-data @03.87700s +00.00800s
|`->reading and applying vendor-data @03.88500s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.92300s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.92400s +00.23000s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.23200 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.23200 seconds

Finished stage: (azure-ds/activate) 00.23200 seconds

Finished stage: (init-network/activate-datasource) 00.23400 seconds

|`->config-migrator ran successfully @04.18500s +00.00100s
|`->config-seed_random ran successfully @04.18600s +00.00100s
|`->config-bootcmd ran successfully @04.18800s +00.00000s
|`->config-write-files ran successfully @04.18900s +00.00100s
|`->config-growpart ran successfully @04.19000s +00.05500s
|`->config-resizefs ran successfully @04.24600s +00.29200s
|`->config-disk_setup ran successfully @04.53900s +00.20100s
|`->config-mounts ran successfully @04.74200s +00.31900s
|`->config-set_hostname ran successfully @05.06200s +00.02200s
|`->config-update_hostname ran successfully @05.08600s +00.00200s
|`->config-update_etc_hosts ran successfully @05.09100s +00.00100s
|`->config-ca-certs ran successfully @05.09200s +00.02100s
|`->config-rsyslog ran successfully @05.11300s +00.00100s
|`->config-users-groups ran successfully @05.11400s +00.03900s
|`->config-ssh ran successfully @05.15400s +00.28800s
Finished stage: (init-network) 01.89000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @09.34900s +00.00100s
|`->config-snap ran successfully @09.35300s +00.00100s
|`->config-snap_config ran successfully @09.35500s +00.00100s
|`->config-ssh-import-id ran successfully @09.35600s +01.13900s
|`->config-locale ran successfully @10.49600s +00.00200s
|`->config-set-passwords ran successfully @10.49900s +00.01600s
|`->config-grub-dpkg ran successfully @10.51600s +00.76900s
|`->config-apt-pipelining ran successfully @11.28700s +00.00100s
|`->config-apt-configure ran successfully @11.28900s +00.10100s
|`->config-ubuntu-advantage ran successfully @11.39000s +00.00100s
|`->config-ntp ran successfully @11.39200s +00.00100s
|`->config-timezone ran successfully @11.39300s +00.00100s
|`->config-disable-ec2-metadata ran successfully @11.39400s +00.00100s
|`->config-runcmd ran successfully @11.39500s +00.00600s
|`->config-byobu ran successfully @11.40200s +00.00100s
Finished stage: (modules-config) 02.08100 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @12.22000s +00.00200s
|`->config-package-update-upgrade-install ran successfully @12.22200s +00.00100s
|`->config-fan ran successfully @12.22400s +00.00100s
|`->config-landscape ran successfully @12.22500s +00.00100s
|`->config-lxd ran successfully @12.22700s +00.00000s
|`->config-ubuntu-drivers ran successfully @12.22800s +00.00100s
|`->config-puppet ran successfully @12.23000s +00.00100s
|`->config-chef ran successfully @12.23100s +00.00100s
|`->config-mcollective ran successfully @12.23200s +00.00100s
|`->config-salt-minion ran successfully @12.23400s +00.00100s
|`->config-rightscale_userdata ran successfully @12.23500s +00.00100s
|`->config-scripts-vendor ran successfully @12.23700s +00.00000s
|`->config-scripts-per-once ran successfully @12.23800s +00.00100s
|`->config-scripts-per-boot ran successfully @12.23900s +00.00100s
|`->config-scripts-per-instance ran successfully @12.24000s +00.00100s
|`->config-scripts-user ran successfully @12.24100s +00.00700s
|`->config-ssh-authkey-fingerprints ran successfully @12.24900s +00.10300s
|`->config-keys-to-console ran successfully @12.35300s +00.11300s
|`->config-phone-home ran successfully @12.46700s +00.00100s
|`->config-final-message ran successfully @12.46900s +00.00500s
|`->config-power-state-change ran successfully @12.47400s +00.00100s
Finished stage: (modules-final) 00.27800 seconds

Total Time: 8.40900 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- cloud-init analyze blame
-- Boot Record 01 --
     01.13900s (modules-config/config-ssh-import-id)
     00.76900s (modules-config/config-grub-dpkg)
     00.31900s (init-network/config-mounts)
     00.29200s (init-network/config-resizefs)
     00.28800s (init-network/config-ssh)
     00.23000s (azure-ds/_has_ntfs_filesystem)
     00.20100s (init-network/config-disk_setup)
     00.18400s (azure-ds/list_possible_azure_ds_devs)
     00.13700s (azure-ds/generate_certificate)
     00.12800s (azure-ds/obtain-dhcp-lease)
     00.11300s (modules-final/config-keys-to-console)
     00.10300s (modules-final/config-ssh-authkey-fingerprints)
     00.10100s (modules-config/config-apt-configure)
     00.05500s (init-network/config-growpart)
     00.03900s (init-network/config-users-groups)
     00.02400s (init-network/check-cache)
     00.02200s (init-network/config-set_hostname)
     00.02100s (init-network/config-ca-certs)
     00.02000s (azure-ds/get_boot_telemetry)
     00.01600s (modules-config/config-set-passwords)
     00.01200s (azure-ds/_decrypt_certs_from_xml)
     00.01100s (azure-ds/_get_metadata_from_imds)
     00.01000s (azure-ds/check-platform-viability)
     00.00800s (init-network/consume-user-data)
     00.00800s (azure-ds/_report_ready)
     00.00700s (modules-final/config-scripts-user)
     00.00600s (modules-config/config-runcmd)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00500s (azure-ds/_run_x509_action)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-config/config-locale)
     00.00200s (init-network/config-update_hostname)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (modules-final/config-scripts-vendor)
     00.00000s (modules-final/config-lxd)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade Networking config
After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            dhcp6: false
            match:
                macaddress: 00:0d:3a:0d:93:f9
            set-name: eth0
    version: 2
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- sudo reboot
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 05:00:16 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.77.105.12 -- grep 'Update datasource' /var/log/cloud-init.log
2019-12-06 04:59:00,125 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 05:00:07,419 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 05:00:08,082 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END disco
### END disco
+ echo ### BEGIN eoan
### BEGIN eoan
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=19.10-DAILY
+ [  =  ]
+ echo Creating standard network vm
Creating standard network vm
+ name=test-sru-eoan
+ az vm create --name=test-sru-eoan --image=Canonical:UbuntuServer:19.10-DAILY:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-eoan",
  "location": "eastus2",
  "macAddress": "00-0D-3A-0E-2C-E8",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.7",
  "publicIpAddress": "52.179.181.95",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-eoan
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.179.181.95
+ echo Created test-sru-eoan: ubuntu@ubuntu@52.179.181.95
Created test-sru-eoan: ubuntu@ubuntu@52.179.181.95
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- cloud-init status --wait --long
..................
status: done
time: Fri, 06 Dec 2019 05:02:15 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- dpkg-query --show cloud-init
cloud-init    19.2-36-g059d049c-0ubuntu3
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- systemd-analyze
Startup finished in 3.279s (kernel) + 1min 1.993s (userspace) = 1min 5.272s
graphical.target reached after 1min 1.111s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- systemd-analyze blame
         29.364s snapd.seeded.service
         10.901s cloud-init.service
          5.326s cloud-init-local.service
          3.411s lvm2-monitor.service
          3.212s dev-sda1.device
          2.877s systemd-udev-settle.service
          2.803s cloud-config.service
          2.668s pollinate.service
          1.743s systemd-logind.service
          1.596s systemd-networkd-wait-online.service
          1.505s snapd.service
          1.326s accounts-daemon.service
          1.294s apparmor.service
          1.206s snap.lxd.activate.service
          1.123s networkd-dispatcher.service
           908ms systemd-timesyncd.service
           906ms rsyslog.service
           888ms cloud-final.service
           862ms systemd-user-sessions.service
           665ms systemd-journald.service
           601ms systemd-resolved.service
           539ms systemd-udev-trigger.service
           462ms grub-initrd-fallback.service
           460ms systemd-networkd.service
           419ms systemd-udevd.service
           410ms apport.service
           317ms ufw.service
           309ms keyboard-setup.service
           308ms systemd-modules-load.service
           297ms sys-kernel-debug.mount
           296ms dev-hugepages.mount
           278ms grub-common.service
           261ms multipathd.service
           259ms kmod-static-nodes.service
           250ms user@1000.service
           243ms polkit.service
           237ms atd.service
           228ms dev-mqueue.mount
           222ms systemd-remount-fs.service
           171ms plymouth-quit-wait.service
           155ms systemd-sysusers.service
           138ms snapd.socket
           131ms sys-fs-fuse-connections.mount
           130ms ssh.service
           116ms systemd-journal-flush.service
           115ms sys-kernel-config.mount
           109ms systemd-machine-id-commit.service
           104ms systemd-sysctl.service
           101ms plymouth-quit.service
            99ms systemd-random-seed.service
            95ms systemd-tmpfiles-setup.service
            91ms console-setup.service
            90ms plymouth-read-write.service
            90ms finalrd.service
            60ms systemd-tmpfiles-setup-dev.service
            53ms systemd-update-utmp.service
            50ms setvtrgb.service
            48ms dev-loop1.device
            42ms blk-availability.service
            41ms snap-core-8039.mount
            41ms snap-lxd-12317.mount
            40ms user-runtime-dir@1000.service
            35ms ephemeral-disk-warning.service
            34ms systemd-update-utmp-runlevel.service
            27ms boot-efi.mount
            23ms dev-loop0.device
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.14500s +00.01000s
|`->get_boot_telemetry @00.15500s +00.08700s
|`->get_system_info @00.24200s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.24300s +00.06000s
|`->load_azure_ds_dir @00.30300s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.41700s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.41800s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01200 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.46300s +00.46100s
|`->_get_metadata_from_imds @00.92500s +00.04200s
Finished stage: (azure-ds/get_metadata_from_imds) 00.53100 seconds

|`->_get_random_seed @00.99400s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.76100 seconds

|`->maybe_remove_ubuntu_network_config_scripts @01.00500s +00.00000s
|`->write_files @01.00600s +00.01200s
Finished stage: (azure-ds/_get_data) 00.87300 seconds

Finished stage: (init-local/search-Azure) 00.87600 seconds

|`->network config from imds @01.08900s +00.00100s
Finished stage: (init-local) 01.35200 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @04.04800s +00.03300s
|`->network config from imds @04.17600s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @04.18900s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @04.19400s +00.14900s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @04.34300s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @04.36600s +00.01500s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @04.38200s +00.00700s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.04900 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @04.43200s +00.01000s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.01000 seconds

Finished stage: (azure-ds/parse_certificates) 00.07600 seconds

|`->_report_ready @04.44200s +03.08500s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.33300 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.33500 seconds

Finished stage: (azure-ds/_negotiate) 03.33900 seconds

Finished stage: (azure-ds/setup) 03.33900 seconds

Finished stage: (init-network/setup-datasource) 03.34000 seconds

|`->reading and applying user-data @07.53600s +00.00800s
|`->reading and applying vendor-data @07.54400s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @07.58500s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @07.58700s +00.79300s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @08.53500s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.16500 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.95900 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.96000 seconds

Finished stage: (azure-ds/activate) 00.96000 seconds

Finished stage: (init-network/activate-datasource) 00.96300 seconds

|`->config-migrator ran successfully @08.62300s +00.00100s
|`->config-seed_random ran successfully @08.62500s +00.00100s
|`->config-bootcmd ran successfully @08.62700s +00.00000s
|`->config-write-files ran successfully @08.62700s +00.00100s
|`->config-growpart ran successfully @08.62900s +00.84700s
|`->config-resizefs ran successfully @09.47600s +01.23000s
|`->config-disk_setup ran successfully @10.70700s +02.49400s
|`->config-mounts ran successfully @13.20700s +00.31000s
|`->config-set_hostname ran successfully @13.51700s +00.00600s
|`->config-update_hostname ran successfully @13.52400s +00.00100s
|`->config-update_etc_hosts ran successfully @13.52600s +00.00000s
|`->config-ca-certs ran successfully @13.52600s +00.00100s
|`->config-rsyslog ran successfully @13.52800s +00.00100s
|`->config-users-groups ran successfully @13.52900s +00.29000s
|`->config-ssh ran successfully @13.81900s +00.49500s
Finished stage: (init-network) 10.28900 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @47.87100s +00.00100s
|`->config-snap ran successfully @47.87300s +00.00000s
|`->config-snap_config ran successfully @47.87400s +00.00100s
|`->config-ssh-import-id ran successfully @47.87500s +00.88600s
|`->config-locale ran successfully @48.76200s +00.00200s
|`->config-set-passwords ran successfully @48.76500s +00.00100s
|`->config-grub-dpkg ran successfully @48.76700s +01.19800s
|`->config-apt-pipelining ran successfully @49.96600s +00.00100s
|`->config-apt-configure ran successfully @49.96800s +00.10700s
|`->config-ubuntu-advantage ran successfully @50.07700s +00.00100s
|`->config-ntp ran successfully @50.07900s +00.00100s
|`->config-timezone ran successfully @50.08000s +00.00100s
|`->config-disable-ec2-metadata ran successfully @50.08200s +00.00000s
|`->config-runcmd ran successfully @50.08200s +00.00600s
|`->config-byobu ran successfully @50.08900s +00.00100s
Finished stage: (modules-config) 02.24500 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @50.81200s +00.00200s
|`->config-package-update-upgrade-install ran successfully @50.81400s +00.00100s
|`->config-fan ran successfully @50.81500s +00.00300s
|`->config-landscape ran successfully @50.81800s +00.00100s
|`->config-lxd ran successfully @50.81900s +00.00100s
|`->config-ubuntu-drivers ran successfully @50.82100s +00.00000s
|`->config-puppet ran successfully @50.82200s +00.00000s
|`->config-chef ran successfully @50.82300s +00.00100s
|`->config-mcollective ran successfully @50.82400s +00.00100s
|`->config-salt-minion ran successfully @50.82500s +00.00100s
|`->config-rightscale_userdata ran successfully @50.82700s +00.00000s
|`->config-scripts-vendor ran successfully @50.82800s +00.00100s
|`->config-scripts-per-once ran successfully @50.82900s +00.00100s
|`->config-scripts-per-boot ran successfully @50.83000s +00.00100s
|`->config-scripts-per-instance ran successfully @50.83100s +00.00100s
|`->config-scripts-user ran successfully @50.83200s +00.02000s
|`->config-ssh-authkey-fingerprints ran successfully @50.85300s +00.01100s
|`->config-keys-to-console ran successfully @50.86400s +00.15700s
|`->config-phone-home ran successfully @51.02200s +00.00100s
|`->config-final-message ran successfully @51.02400s +00.00500s
|`->config-power-state-change ran successfully @51.03000s +00.00100s
Finished stage: (modules-final) 00.24700 seconds

Total Time: 38.02300 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- cloud-init analyze blame
-- Boot Record 01 --
     03.08500s (azure-ds/_report_ready)
     02.49400s (init-network/config-disk_setup)
     01.23000s (init-network/config-resizefs)
     01.19800s (modules-config/config-grub-dpkg)
     00.88600s (modules-config/config-ssh-import-id)
     00.84700s (init-network/config-growpart)
     00.79300s (azure-ds/_has_ntfs_filesystem)
     00.49500s (init-network/config-ssh)
     00.46100s (azure-ds/obtain-dhcp-lease)
     00.31000s (init-network/config-mounts)
     00.29000s (init-network/config-users-groups)
     00.15700s (modules-final/config-keys-to-console)
     00.14900s (azure-ds/generate_certificate)
     00.10700s (modules-config/config-apt-configure)
     00.08700s (azure-ds/get_boot_telemetry)
     00.06000s (azure-ds/list_possible_azure_ds_devs)
     00.04200s (azure-ds/_get_metadata_from_imds)
     00.03300s (init-network/check-cache)
     00.02000s (modules-final/config-scripts-user)
     00.01500s (azure-ds/_decrypt_certs_from_xml)
     00.01200s (azure-ds/write_files)
     00.01100s (modules-final/config-ssh-authkey-fingerprints)
     00.01000s (azure-ds/check-platform-viability)
     00.01000s (azure-ds/_run_x509_action)
     00.00800s (init-network/consume-user-data)
     00.00700s (azure-ds/_run_x509_action)
     00.00600s (modules-config/config-runcmd)
     00.00600s (init-network/config-set_hostname)
     00.00500s (modules-final/config-final-message)
     00.00300s (modules-final/config-fan)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-config/config-locale)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (modules-final/config-ubuntu-drivers)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-puppet)
     00.00000s (modules-config/config-snap)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Networking config
Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by
# the datasource.  Changes to it will not persist across an instance.
# To disable cloud-init's network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            match:
                macaddress: 00:0d:3a:0e:2c:e8
            set-name: eth0
    version: 2
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@52.179.181.95:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- sudo+  bash ./setup_proposed.sh
egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu eoan-proposed/main amd64 cloud-init all 19.3-41-gc4735dd3-0ubuntu1~19.10.1 [406 kB]
Preparing to unpack .../cloud-init_19.3-41-gc4735dd3-0ubuntu1~19.10.1_all.deb ...
Unpacking cloud-init (19.3-41-gc4735dd3-0ubuntu1~19.10.1) over (19.2-36-g059d049c-0ubuntu3) ...
Setting up cloud-init (19.3-41-gc4735dd3-0ubuntu1~19.10.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- dpkg-query --show cloud-init
cloud-init    19.3-41-gc4735dd3-0ubuntu1~19.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ [  =  ]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- sudo cloud-init clean --logs --reboot
Connection to 52.179.181.95 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 05:03:39 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- sudo systemd-analyze blame
          3.014s cloud-init.service
          2.888s snapd.service
          2.526s snap.lxd.activate.service
          2.499s cloud-config.service
          2.364s lvm2-monitor.service
          2.132s dev-sda1.device
          2.076s cloud-init-local.service
          1.895s systemd-udev-settle.service
          1.816s systemd-logind.service
          1.181s accounts-daemon.service
          1.078s grub-common.service
          1.068s systemd-networkd-wait-online.service
           954ms systemd-timesyncd.service
           848ms cloud-final.service
           772ms networkd-dispatcher.service
           758ms apport.service
           696ms systemd-user-sessions.service
           686ms systemd-journald.service
           662ms rsyslog.service
           628ms atd.service
           481ms ssh.service
           374ms systemd-remount-fs.service
           363ms systemd-resolved.service
           357ms keyboard-setup.service
           346ms systemd-udev-trigger.service
           330ms kmod-static-nodes.service
           329ms sys-kernel-debug.mount
           315ms polkit.service
           290ms grub-initrd-fallback.service
           289ms dev-mqueue.mount
           278ms apparmor.service
           266ms systemd-networkd.service
           230ms systemd-modules-load.service
           212ms snapd.socket
           210ms ufw.service
           159ms plymouth-quit-wait.service
           151ms plymouth-quit.service
           116ms user@1000.service
           107ms sys-kernel-config.mount
           105ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
           101ms dev-hugepages.mount
           101ms snap-core-8039.mount
           100ms sys-fs-fuse-connections.mount
            96ms systemd-sysctl.service
            93ms snapd.seeded.service
            92ms plymouth-read-write.service
            92ms boot-efi.mount
            87ms systemd-random-seed.service
            87ms systemd-udevd.service
            87ms systemd-sysusers.service
            86ms setvtrgb.service
            84ms finalrd.service
            82ms systemd-tmpfiles-setup.service
            75ms dev-loop0.device
            72ms snap-lxd-12317.mount
            69ms multipathd.service
            69ms console-setup.service
            63ms systemd-journal-flush.service
            62ms dev-loop1.device
            42ms blk-availability.service
            33ms systemd-update-utmp-runlevel.service
            31ms systemd-tmpfiles-setup-dev.service
            31ms systemd-update-utmp.service
            25ms user-runtime-dir@1000.service
            14ms ephemeral-disk-warning.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00200s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.05700s +00.01100s
|`->get_boot_telemetry @00.06800s +00.01800s
|`->get_system_info @00.08700s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.08700s +00.18800s
|`->load_azure_ds_dir @00.27500s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.28000s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.28100s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00500 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.30200s +00.12700s
|`->_get_metadata_from_imds @00.42900s +00.01100s
Finished stage: (azure-ds/get_metadata_from_imds) 00.16200 seconds

|`->_get_random_seed @00.46300s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.38700 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.47500s +00.00000s
|`->write_files @00.47600s +00.00300s
Finished stage: (azure-ds/_get_data) 00.42200 seconds

Finished stage: (init-local/search-Azure) 00.42500 seconds

|`->network config from imds @00.54400s +00.00000s
Finished stage: (init-local) 00.67400 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @02.62700s +00.03000s
|`->network config from imds @02.72400s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @02.73500s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @02.73900s +00.14100s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @02.88200s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @02.90400s +00.01400s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @02.91900s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01400 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @02.93300s +00.00700s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.03600 seconds

|`->_report_ready @02.94100s +00.00700s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.20900 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.21000 seconds

Finished stage: (azure-ds/_negotiate) 00.21400 seconds

Finished stage: (azure-ds/setup) 00.21600 seconds

Finished stage: (init-network/setup-datasource) 00.21600 seconds

|`->reading and applying user-data @02.95800s +00.00800s
|`->reading and applying vendor-data @02.96600s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.00700s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.00700s +00.13000s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.13000 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.13000 seconds

Finished stage: (azure-ds/activate) 00.13000 seconds

Finished stage: (init-network/activate-datasource) 00.13300 seconds

|`->config-migrator ran successfully @03.17300s +00.00100s
|`->config-seed_random ran successfully @03.17400s +00.00600s
|`->config-bootcmd ran successfully @03.18000s +00.00100s
|`->config-write-files ran successfully @03.18100s +00.00100s
|`->config-growpart ran successfully @03.18300s +00.10200s
|`->config-resizefs ran successfully @03.28600s +00.16400s
|`->config-disk_setup ran successfully @03.45000s +00.62300s
|`->config-mounts ran successfully @04.07300s +00.29200s
|`->config-set_hostname ran successfully @04.36500s +00.00700s
|`->config-update_hostname ran successfully @04.37300s +00.00200s
|`->config-update_etc_hosts ran successfully @04.37500s +00.00100s
|`->config-ca-certs ran successfully @04.37600s +00.00100s
|`->config-rsyslog ran successfully @04.37800s +00.00100s
|`->config-users-groups ran successfully @04.37900s +00.16400s
|`->config-ssh ran successfully @04.54400s +00.48600s
Finished stage: (init-network) 02.41900 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @10.02000s +00.00100s
|`->config-snap ran successfully @10.02100s +00.00100s
|`->config-snap_config ran successfully @10.02200s +00.00100s
|`->config-ssh-import-id ran successfully @10.02400s +01.03400s
|`->config-locale ran successfully @11.05900s +00.00200s
|`->config-set-passwords ran successfully @11.06200s +00.00100s
|`->config-grub-dpkg ran successfully @11.06400s +00.40000s
|`->config-apt-pipelining ran successfully @11.46800s +00.00200s
|`->config-apt-configure ran successfully @11.47000s +00.15300s
|`->config-ubuntu-advantage ran successfully @11.62300s +00.00200s
|`->config-ntp ran successfully @11.62500s +00.00100s
|`->config-timezone ran successfully @11.62700s +00.00100s
|`->config-disable-ec2-metadata ran successfully @11.62800s +00.00100s
|`->config-runcmd ran successfully @11.62900s +00.00600s
|`->config-byobu ran successfully @11.63600s +00.00100s
Finished stage: (modules-config) 01.63600 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @12.31700s +00.00200s
|`->config-package-update-upgrade-install ran successfully @12.31900s +00.00200s
|`->config-fan ran successfully @12.32200s +00.00100s
|`->config-landscape ran successfully @12.32300s +00.00100s
|`->config-lxd ran successfully @12.32400s +00.00100s
|`->config-ubuntu-drivers ran successfully @12.32600s +00.00000s
|`->config-puppet ran successfully @12.32700s +00.00100s
|`->config-chef ran successfully @12.32800s +00.00100s
|`->config-mcollective ran successfully @12.32900s +00.00100s
|`->config-salt-minion ran successfully @12.33100s +00.00000s
|`->config-rightscale_userdata ran successfully @12.33200s +00.00100s
|`->config-scripts-vendor ran successfully @12.33300s +00.00100s
|`->config-scripts-per-once ran successfully @12.33400s +00.00100s
|`->config-scripts-per-boot ran successfully @12.33600s +00.00000s
|`->config-scripts-per-instance ran successfully @12.33700s +00.00000s
|`->config-scripts-user ran successfully @12.33800s +00.00600s
|`->config-ssh-authkey-fingerprints ran successfully @12.34500s +00.05900s
|`->config-keys-to-console ran successfully @12.40500s +00.09500s
|`->config-phone-home ran successfully @12.50100s +00.00100s
|`->config-final-message ran successfully @12.50300s +00.00500s
|`->config-power-state-change ran successfully @12.50800s +00.00100s
Finished stage: (modules-final) 00.21400 seconds

Total Time: 7.99800 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- cloud-init analyze blame
-- Boot Record 01 --
     01.03400s (modules-config/config-ssh-import-id)
     00.62300s (init-network/config-disk_setup)
     00.48600s (init-network/config-ssh)
     00.40000s (modules-config/config-grub-dpkg)
     00.29200s (init-network/config-mounts)
     00.18800s (azure-ds/list_possible_azure_ds_devs)
     00.16400s (init-network/config-users-groups)
     00.16400s (init-network/config-resizefs)
     00.15300s (modules-config/config-apt-configure)
     00.14100s (azure-ds/generate_certificate)
     00.13000s (azure-ds/_has_ntfs_filesystem)
     00.12700s (azure-ds/obtain-dhcp-lease)
     00.10200s (init-network/config-growpart)
     00.09500s (modules-final/config-keys-to-console)
     00.05900s (modules-final/config-ssh-authkey-fingerprints)
     00.03000s (init-network/check-cache)
     00.01800s (azure-ds/get_boot_telemetry)
     00.01400s (azure-ds/_decrypt_certs_from_xml)
     00.01100s (azure-ds/check-platform-viability)
     00.01100s (azure-ds/_get_metadata_from_imds)
     00.00800s (init-network/consume-user-data)
     00.00700s (init-network/config-set_hostname)
     00.00700s (azure-ds/_run_x509_action)
     00.00700s (azure-ds/_report_ready)
     00.00600s (modules-final/config-scripts-user)
     00.00600s (modules-config/config-runcmd)
     00.00600s (init-network/config-seed_random)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00300s (azure-ds/write_files)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-final/config-package-update-upgrade-install)
     00.00200s (modules-config/config-ubuntu-advantage)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-local/check-cache)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-ubuntu-drivers)
     00.00000s (modules-final/config-scripts-per-instance)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade Networking config
After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            dhcp6: false
            match:
                macaddress: 00:0d:3a:0e:2c:e8
            set-name: eth0
    version: 2
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- sudo reboot
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- cloud-init status --wait --long

status: done
time: Fri, 06 Dec 2019 05:04:47 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.181.95 -- grep 'Update datasource' /var/log/cloud-init.log
2019-12-06 05:03:26,796 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 05:04:36,699 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2019-12-06 05:04:37,354 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END eoan
### END eoan




==== END SRU Validation Output ====
