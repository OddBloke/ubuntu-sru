#!/bin/bash
# Softlayer(IBM) manual sru testing



# launched performed with qa-scripts (launch-softlayer)
# repo https://github.com/cloud-init/qa-scripts.git
# launch-softlayer --image=os:bionic -u sethostname.yaml
# launch-softlayer --image=os:xenial -u sethostname.yaml
# then grab vm ips with `sl vs list`



#!/bin/bash
# Manually deploy on Softlayer using slcli client.
# Validate upgrade to proposed version of cloud-init
# Check Tracebacks or error conditions on clean boot
set -x
 
# local values defaults set by sru-create.py
SRU_SERIES=${SRU_SERIES:-"xenial bionic"}
LP_USER=${LP_USER:-"%LP_USER%"}

# Provide USE_DEV_PPA=1 if we are SRU queue is still unapproved
# This will use our ppa:cloud-init-dev/proposed
if [ "${USE_DEV_PPA:-0}" -eq "0" ]; then
    PROPOSED_SCRIPT=setup_proposed.sh
else
    PROPOSED_SCRIPT=setup_dev_proposed.sh
fi

cat > sethostname.yaml <<EOF
## template: jinja
#cloud-config
ssh_import_id : [$LP_USER]
hostname: SRU-worked-{{v1.cloud_name}}
EOF

cat > setup_proposed.sh <<EOF
#/bin/bash
mirror=http://archive.ubuntu.com/ubuntu
echo deb \$mirror \$(lsb_release -sc)-proposed main | tee /etc/apt/sources.list.d/proposed.list
apt-get update -q
apt-get install -qy cloud-init
EOF

cat > setup_dev_proposed.sh <<EOF
#/bin/bash
add-apt-repository ppa:cloud-init-dev/proposed -y
apt-get update -q;
apt-get install -qy cloud-init;
EOF



sshopts=( -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR )

for series in $SRU_SERIES; do
    echo "### BEGIN $series"
    VM_IP=`launch-softlayer --image=os:$series -u sethostname.yaml | awk '/primary ip/{printf "root@%s", $NF}'`
    sleep 180
    ssh "${sshopts[@]}" $VM_IP -- dpkg-query --show cloud-init
    ssh "${sshopts[@]}" $VM_IP -- cat /run/cloud-init/result.json
    ssh "${sshopts[@]}" $VM_IP -- grep Trace /var/log/cloud-init.log
    ssh "${sshopts[@]}" $VM_IP -- systemd-analyze
    ssh "${sshopts[@]}" $VM_IP -- systemd-analyze blame
    ssh "${sshopts[@]}" $VM_IP -- cloud-init analyze show
    ssh "${sshopts[@]}" $VM_IP -- cloud-init analyze blame

    scp "${sshopts[@]}" $PROPOSED_SCRIPT $VM_IP:.
    ssh "${sshopts[@]}" $VM_IP -- bash $PROPOSED_SCRIPT 2>&1 | egrep 'cloud-init'
    ssh "${sshopts[@]}" $VM_IP -- dpkg-query --show cloud-init
    ssh "${sshopts[@]}" $VM_IP -- hostname SRU-didnt-work
    ssh "${sshopts[@]}" $VM_IP -- cloud-init clean --logs --reboot

    sleep 180

    ssh "${sshopts[@]}" $VM_IP -- cloud-init status --wait --long
    ssh "${sshopts[@]}" $VM_IP -- grep Trace /var/log/cloud-init\*
    ssh "${sshopts[@]}" $VM_IP -- cat /run/cloud-init/result.json
    ssh "${sshopts[@]}" $VM_IP -- systemd-analyze blame
    ssh "${sshopts[@]}" $VM_IP -- cloud-init analyze show
    ssh "${sshopts[@]}" $VM_IP -- cloud-init analyze blame
    ssh "${sshopts[@]}" $VM_IP -- "cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'"
    echo 'Get cloud-id'
    ssh "${sshopts[@]}" $VM_IP -- cloud-id
    ssh "${sshopts[@]}" $VM_IP -- "cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'"

    echo 'Validating whether metadata is being updated per boot LP:1819913. Expect last log to contain System Boot'
    ssh "${sshopts[@]}" $VM_IP -- reboot || true
    sleep 180
    echo 'After reboot'
    ssh "${sshopts[@]}" $VM_IP -- cloud-init status --wait --long
    ssh "${sshopts[@]}" $VM_IP -- "grep 'Update datasource' /var/log/cloud-init.log"
    echo "Confirm no traceback after reboot LP: 1823084"
    ssh "${sshopts[@]}" $VM_IP -- "grep 'Trace' /var/log/cloud-init.log"

    echo "### END $series"
done


==== BEGIN SRU Verification OUTPUT ===
root@publishing:~# ./softlayer-sru-19.4.33.txt | tee  softlayer-sru.log 
+ SRU_SERIES='xenial bionic'
+ LP_USER=chad.smith
+ '[' 0 -eq 0 ']'
+ PROPOSED_SCRIPT=setup_proposed.sh
+ cat
+ cat
+ cat
+ sshopts=(-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR)
+ for series in $SRU_SERIES
+ echo '### BEGIN xenial'
### BEGIN xenial
++ launch-softlayer --image=os:xenial -u sethostname.yaml
++ awk '/primary ip/{printf "root@%s", $NF}'
 [is_ready=True status=PUBLISH_SERVER_DATA]
Destroy instance with:
  slcli virtual cancel 95850102
+ VM_IP=root@75.126.32.18
+ sleep 180
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- dpkg-query --show cloud-init
cloud-init	19.1-1-gbaa47854-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceIBMCloud [OS-Code/Live /dev/xvdh]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- systemd-analyze
Startup finished in 5.840s (kernel) + 3min 6.432s (userspace) = 3min 12.272s
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- systemd-analyze blame
          4.909s dev-xvda2.device
          4.330s cloud-config.service
          3.157s cloud-init-local.service
          2.728s snapd.seeded.service
          2.294s pollinate.service
          2.252s lxd-containers.service
          2.240s apparmor.service
          1.687s xe-daemon.service
          1.516s cloud-init.service
          1.462s snapd.service
          1.325s console-setup.service
           958ms accounts-daemon.service
           788ms cloud-final.service
           690ms resolvconf.service
           667ms systemd-modules-load.service
           664ms lvm2-monitor.service
           664ms mdadm.service
           621ms systemd-remount-fs.service
           612ms kmod-static-nodes.service
           599ms dev-hugepages.mount
           599ms iscsid.service
           526ms ufw.service
           514ms systemd-update-utmp.service
           502ms rc-local.service
           489ms grub-common.service
           453ms rsyslog.service
           439ms sys-kernel-debug.mount
           428ms dev-mqueue.mount
           352ms irqbalance.service
           327ms apport.service
           320ms keyboard-setup.service
           291ms proc-xen.mount
           255ms polkitd.service
           243ms networking.service
           236ms open-iscsi.service
           229ms systemd-logind.service
           217ms systemd-udev-trigger.service
           212ms systemd-timesyncd.service
           210ms systemd-journal-flush.service
           201ms systemd-journald.service
           177ms systemd-udevd.service
           167ms systemd-tmpfiles-setup-dev.service
           161ms ondemand.service
           129ms snapd.socket
           107ms plymouth-read-write.service
            92ms systemd-random-seed.service
            84ms plymouth-quit.service
            84ms ssh.service
            79ms setvtrgb.service
            76ms lxd.socket
            71ms systemd-tmpfiles-setup.service
            68ms plymouth-quit-wait.service
            67ms systemd-sysctl.service
            65ms systemd-user-sessions.service
            50ms systemd-update-utmp-runlevel.service
            47ms sys-fs-fuse-connections.mount
            37ms systemd-machine-id-commit.service
            36ms user@0.service
            32ms boot.mount
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00700s +00.00000s
|`->found local data from DataSourceIBMCloud @00.03000s +00.08400s
Finished stage: (init-local) 00.27900 seconds 

Starting stage: init-network
|`->restored from cache with run check: DataSourceIBMCloud [OS-Code/Live /dev/xvdh] @01.04100s +00.00500s
|`->setting up datasource @01.13300s +00.00000s
|`->reading and applying user-data @01.14100s +00.00900s
|`->reading and applying vendor-data @01.15000s +00.00500s
|`->activating datasource @01.19600s +00.00200s
|`->config-migrator ran successfully @01.25700s +00.00000s
|`->config-seed_random ran successfully @01.25800s +00.00100s
|`->config-bootcmd ran successfully @01.26000s +00.00000s
|`->config-write-files ran successfully @01.26000s +00.00100s
|`->config-growpart ran successfully @01.26100s +00.15800s
|`->config-resizefs ran successfully @01.41900s +00.08300s
|`->config-disk_setup ran successfully @01.50300s +00.00100s
|`->config-mounts ran successfully @01.50400s +00.13200s
|`->config-set_hostname ran successfully @01.63600s +00.00700s
|`->config-update_hostname ran successfully @01.64400s +00.00100s
|`->config-update_etc_hosts ran successfully @01.64600s +00.00100s
|`->config-ca-certs ran successfully @01.64700s +00.00100s
|`->config-rsyslog ran successfully @01.64900s +00.00100s
|`->config-users-groups ran successfully @01.65000s +00.07200s
|`->config-ssh ran successfully @01.72300s +00.31000s
Finished stage: (init-network) 01.00800 seconds 

Starting stage: modules-config
|`->config-emit_upstart ran successfully @07.65800s +00.00000s
|`->config-snap ran successfully @07.65900s +00.00100s
|`->config-snap_config ran successfully @07.66000s +00.00100s
|`->config-ssh-import-id ran successfully @07.66100s +00.98000s
|`->config-locale ran successfully @08.64200s +01.92500s
|`->config-set-passwords ran successfully @10.56800s +00.00200s
|`->config-grub-dpkg ran successfully @10.57000s +00.66000s
|`->config-apt-pipelining ran successfully @11.23100s +00.00100s
|`->config-apt-configure ran successfully @11.23300s +00.14900s
|`->config-ubuntu-advantage ran successfully @11.38300s +00.00100s
|`->config-ntp ran successfully @11.38400s +00.00100s
|`->config-timezone ran successfully @11.38500s +00.00100s
|`->config-disable-ec2-metadata ran successfully @11.38700s +00.00000s
|`->config-runcmd ran successfully @11.38700s +00.00100s
|`->config-byobu ran successfully @11.38900s +00.00100s
Finished stage: (modules-config) 03.79300 seconds 

Starting stage: modules-final
|`->config-snappy ran successfully @11.91300s +00.00200s
|`->config-package-update-upgrade-install ran successfully @11.91600s +00.00000s
|`->config-fan ran successfully @11.91700s +00.00100s
|`->config-landscape ran successfully @11.91800s +00.00100s
|`->config-lxd ran successfully @11.91900s +00.00100s
|`->config-ubuntu-drivers ran successfully @11.92000s +00.00100s
|`->config-puppet ran successfully @11.92200s +00.00100s
|`->config-chef ran successfully @11.92300s +00.00100s
|`->config-mcollective ran successfully @11.92400s +00.00100s
|`->config-salt-minion ran successfully @11.92500s +00.00100s
|`->config-rightscale_userdata ran successfully @11.92700s +00.00000s
|`->config-scripts-vendor ran successfully @11.92800s +00.02000s
|`->config-scripts-per-once ran successfully @11.94900s +00.00100s
|`->config-scripts-per-boot ran successfully @11.95100s +00.00000s
|`->config-scripts-per-instance ran successfully @11.95100s +00.00100s
|`->config-scripts-user ran successfully @11.95200s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @11.95400s +00.06400s
|`->config-keys-to-console ran successfully @12.01900s +00.12900s
|`->config-phone-home ran successfully @12.14800s +00.00200s
|`->config-final-message ran successfully @12.15000s +00.00600s
|`->config-power-state-change ran successfully @12.15600s +00.00100s
Finished stage: (modules-final) 00.27400 seconds 

Total Time: 5.35400 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- cloud-init analyze blame
-- Boot Record 01 --
     01.92500s (modules-config/config-locale)
     00.98000s (modules-config/config-ssh-import-id)
     00.66000s (modules-config/config-grub-dpkg)
     00.31000s (init-network/config-ssh)
     00.15800s (init-network/config-growpart)
     00.14900s (modules-config/config-apt-configure)
     00.13200s (init-network/config-mounts)
     00.12900s (modules-final/config-keys-to-console)
     00.08400s (init-local/search-IBMCloud)
     00.08300s (init-network/config-resizefs)
     00.07200s (init-network/config-users-groups)
     00.06400s (modules-final/config-ssh-authkey-fingerprints)
     00.02000s (modules-final/config-scripts-vendor)
     00.00900s (init-network/consume-user-data)
     00.00700s (init-network/config-set_hostname)
     00.00600s (modules-final/config-final-message)
     00.00500s (init-network/consume-vendor-data)
     00.00500s (init-network/check-cache)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (init-network/activate-datasource)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-disk_setup)
     00.00100s (init-network/config-ca-certs)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-package-update-upgrade-install)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/setup-datasource)
     00.00000s (init-network/config-migrator)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)

1 boot records analyzed
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh root@75.126.32.18:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- bash setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu xenial-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~16.04.1 [413 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~16.04.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~16.04.1) over (19.1-1-gbaa47854-0ubuntu1~16.04.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~16.04.1) ...
Leaving 'diversion of /etc/init/ureadahead.conf to /etc/init/ureadahead.conf.disabled by cloud-init'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- cloud-init clean --logs --reboot
Connection to 75.126.32.18 closed by remote host.
+ sleep 180
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- cloud-init status --wait --long

status: done
time: Thu, 23 Jan 2020 17:42:23 +0000
detail:
DataSourceIBMCloud [OS-Code/Live /dev/xvdh]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- grep Trace '/var/log/cloud-init*'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceIBMCloud [OS-Code/Live /dev/xvdh]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- systemd-analyze blame
Bootup is not yet finished. Please try again later.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00600s +00.00100s
|`->found local data from DataSourceIBMCloud @00.03400s +00.10100s
Finished stage: (init-local) 00.29700 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceIBMCloud [OS-Code/Live /dev/xvdh] @01.08900s +00.00400s
|`->setting up datasource @01.18400s +00.00000s
|`->reading and applying user-data @01.19300s +00.01000s
|`->reading and applying vendor-data @01.20300s +00.00600s
|`->activating datasource @01.24700s +00.00200s
|`->config-migrator ran successfully @01.29100s +00.00100s
|`->config-seed_random ran successfully @01.29200s +00.00200s
|`->config-bootcmd ran successfully @01.29400s +00.00000s
|`->config-write-files ran successfully @01.29500s +00.00100s
|`->config-growpart ran successfully @01.29600s +00.08800s
|`->config-resizefs ran successfully @01.38400s +00.05700s
|`->config-disk_setup ran successfully @01.44200s +00.00100s
|`->config-mounts ran successfully @01.44300s +00.00700s
|`->config-set_hostname ran successfully @01.45100s +00.00500s
|`->config-update_hostname ran successfully @01.45700s +00.00100s
|`->config-update_etc_hosts ran successfully @01.45800s +00.00100s
|`->config-ca-certs ran successfully @01.45900s +00.00100s
|`->config-rsyslog ran successfully @01.46100s +00.00100s
|`->config-users-groups ran successfully @01.46200s +00.05500s
|`->config-ssh ran successfully @01.51800s +00.56500s
Finished stage: (init-network) 01.02300 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @04.94300s +00.00100s
|`->config-snap ran successfully @04.94400s +00.00100s
|`->config-ssh-import-id ran successfully @04.94500s +01.15900s
|`->config-locale ran successfully @06.10400s +00.00200s
|`->config-set-passwords ran successfully @06.10700s +00.00100s
|`->config-grub-dpkg ran successfully @06.11900s +00.80300s
|`->config-apt-pipelining ran successfully @06.92300s +00.00100s
|`->config-apt-configure ran successfully @06.92500s +00.23500s
|`->config-ubuntu-advantage ran successfully @07.16000s +00.00100s
|`->config-ntp ran successfully @07.16200s +00.00100s
|`->config-timezone ran successfully @07.16300s +00.00100s
|`->config-disable-ec2-metadata ran successfully @07.16400s +00.00000s
|`->config-runcmd ran successfully @07.16500s +00.00100s
|`->config-byobu ran successfully @07.16600s +00.00100s
Finished stage: (modules-config) 02.27100 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @07.72200s +00.00100s
|`->config-fan ran successfully @07.72300s +00.00200s
|`->config-landscape ran successfully @07.72500s +00.00100s
|`->config-lxd ran successfully @07.72600s +00.00100s
|`->config-ubuntu-drivers ran successfully @07.72700s +00.00100s
|`->config-puppet ran successfully @07.72900s +00.00000s
|`->config-chef ran successfully @07.73000s +00.00100s
|`->config-mcollective ran successfully @07.73100s +00.00100s
|`->config-salt-minion ran successfully @07.73200s +00.00100s
|`->config-rightscale_userdata ran successfully @07.73400s +00.00000s
|`->config-scripts-vendor ran successfully @07.73500s +00.02200s
|`->config-scripts-per-once ran successfully @07.75800s +00.00100s
|`->config-scripts-per-boot ran successfully @07.76000s +00.00000s
|`->config-scripts-per-instance ran successfully @07.76000s +00.00100s
|`->config-scripts-user ran successfully @07.76200s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @07.76300s +00.10300s
|`->config-keys-to-console ran successfully @07.86700s +00.14300s
|`->config-phone-home ran successfully @08.01100s +00.00100s
|`->config-final-message ran successfully @08.01200s +00.00700s
|`->config-power-state-change ran successfully @08.02000s +00.00100s
Finished stage: (modules-final) 00.32700 seconds

Total Time: 3.91800 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- cloud-init analyze blame
-- Boot Record 01 --
     01.15900s (modules-config/config-ssh-import-id)
     00.80300s (modules-config/config-grub-dpkg)
     00.56500s (init-network/config-ssh)
     00.23500s (modules-config/config-apt-configure)
     00.14300s (modules-final/config-keys-to-console)
     00.10300s (modules-final/config-ssh-authkey-fingerprints)
     00.10100s (init-local/search-IBMCloud)
     00.08800s (init-network/config-growpart)
     00.05700s (init-network/config-resizefs)
     00.05500s (init-network/config-users-groups)
     00.02200s (modules-final/config-scripts-vendor)
     00.01000s (init-network/consume-user-data)
     00.00700s (modules-final/config-final-message)
     00.00700s (init-network/config-mounts)
     00.00600s (init-network/consume-vendor-data)
     00.00500s (init-network/config-set_hostname)
     00.00400s (init-network/check-cache)
     00.00200s (modules-final/config-fan)
     00.00200s (modules-config/config-locale)
     00.00200s (init-network/config-seed_random)
     00.00200s (init-network/activate-datasource)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-disk_setup)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-puppet)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/setup-datasource)
     00.00000s (init-network/config-bootcmd)

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- 'cloud-init query --format '\''cloud-region: {{cloud_name}}-{{region}}'\'''
cloud-region: ibmcloud-None
+ echo 'Get cloud-id'
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- cloud-id
ibmcloud
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- 'cloud-init query --format '\''cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'\'''
WARNING: Ignoring jinja template for query commandline: 'dict object' has no attribute 'imds'
+ echo 'Validating whether metadata is being updated per boot LP:1819913. Expect last log to contain System Boot'
Validating whether metadata is being updated per boot LP:1819913. Expect last log to contain System Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- reboot
Connection to 75.126.32.18 closed by remote host.
+ true
+ sleep 180
+ echo 'After reboot'
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- cloud-init status --wait --long

status: done
time: Thu, 23 Jan 2020 17:45:27 +0000
detail:
DataSourceIBMCloud [OS-Code/Live /dev/xvdh]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2020-01-23 17:42:15,147 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
+ echo 'Confirm no traceback after reboot LP: 1823084'
Confirm no traceback after reboot LP: 1823084
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.18 -- 'grep '\''Trace'\'' /var/log/cloud-init.log'
+ echo '### END xenial'
+ for series in $SRU_SERIES
### END xenial
+ echo '### BEGIN bionic'
### BEGIN bionic
++ launch-softlayer --image=os:bionic -u sethostname.yaml
++ awk '/primary ip/{printf "root@%s", $NF}'
 [is_ready=True status=PUBLISH_SERVER_DATA]
Destroy instance with:
  slcli virtual cancel 95850626
+ VM_IP=root@75.126.32.22
+ sleep 180
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- dpkg-query --show cloud-init
cloud-init	19.1-1-gbaa47854-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceIBMCloud [OS-Code/Live /dev/xvdh]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- systemd-analyze
Startup finished in 6.142s (kernel) + 21.461s (userspace) = 27.604s
graphical.target reached after 17.885s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- systemd-analyze blame
          4.789s dev-xvda2.device
          3.032s cloud-init-local.service
          2.644s cloud-config.service
          2.636s keyboard-setup.service
          2.126s cloud-init.service
          2.051s snapd.seeded.service
          1.855s pollinate.service
          1.568s apparmor.service
          1.423s systemd-networkd-wait-online.service
          1.336s lxd-containers.service
          1.000s xe-daemon.service
           958ms snapd.service
           952ms cloud-final.service
           829ms networkd-dispatcher.service
           546ms grub-common.service
           471ms accounts-daemon.service
           455ms systemd-udev-trigger.service
           436ms lvm2-monitor.service
           323ms systemd-journald.service
           322ms systemd-user-sessions.service
           320ms systemd-modules-load.service
           264ms proc-xen.mount
           261ms dev-mqueue.mount
           251ms systemd-logind.service
           224ms apport.service
           215ms blk-availability.service
           215ms systemd-remount-fs.service
           190ms sys-kernel-debug.mount
           187ms rsyslog.service
           181ms ebtables.service
           179ms systemd-tmpfiles-setup-dev.service
           178ms lxd.socket
           175ms systemd-udevd.service
           164ms ufw.service
           150ms systemd-timesyncd.service
           148ms kmod-static-nodes.service
           136ms dev-hugepages.mount
           136ms polkit.service
           128ms systemd-sysctl.service
           100ms systemd-networkd.service
            92ms systemd-journal-flush.service
            88ms systemd-tmpfiles-setup.service
            81ms plymouth-read-write.service
            80ms console-setup.service
            78ms snapd.socket
            78ms systemd-resolved.service
            69ms ssh.service
            67ms systemd-random-seed.service
            64ms sys-kernel-config.mount
            57ms sys-fs-fuse-connections.mount
            55ms systemd-machine-id-commit.service
            39ms user@0.service
            36ms setvtrgb.service
            30ms systemd-update-utmp.service
            28ms plymouth-quit-wait.service
            26ms plymouth-quit.service
            22ms systemd-update-utmp-runlevel.service
            19ms boot.mount
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.01100s +00.00000s
|`->found local data from DataSourceIBMCloud @00.06900s +00.10200s
Finished stage: (init-local) 00.57200 seconds 

Starting stage: init-network
|`->restored from cache with run check: DataSourceIBMCloud [OS-Code/Live /dev/xvdh] @02.77600s +00.01600s
|`->setting up datasource @02.87200s +00.00100s
|`->reading and applying user-data @02.88100s +00.01000s
|`->reading and applying vendor-data @02.89100s +00.00400s
|`->activating datasource @02.94200s +00.00100s
|`->config-migrator ran successfully @03.00800s +00.00100s
|`->config-seed_random ran successfully @03.00900s +00.00200s
|`->config-bootcmd ran successfully @03.01100s +00.00000s
|`->config-write-files ran successfully @03.01100s +00.00100s
|`->config-growpart ran successfully @03.01300s +00.18300s
|`->config-resizefs ran successfully @03.19600s +00.13400s
|`->config-disk_setup ran successfully @03.33000s +00.00100s
|`->config-mounts ran successfully @03.33200s +00.19300s
|`->config-set_hostname ran successfully @03.52500s +00.00900s
|`->config-update_hostname ran successfully @03.53500s +00.00200s
|`->config-update_etc_hosts ran successfully @03.53700s +00.00100s
|`->config-ca-certs ran successfully @03.53900s +00.00000s
|`->config-rsyslog ran successfully @03.54000s +00.00100s
|`->config-users-groups ran successfully @03.54100s +00.24200s
|`->config-ssh ran successfully @03.78300s +00.44300s
Finished stage: (init-network) 01.46800 seconds 

Starting stage: modules-config
|`->config-emit_upstart ran successfully @08.65200s +00.00000s
|`->config-snap ran successfully @08.65200s +00.00100s
|`->config-snap_config ran successfully @08.65300s +00.00100s
|`->config-ssh-import-id ran successfully @08.65500s +01.01300s
|`->config-locale ran successfully @09.66900s +00.00200s
|`->config-set-passwords ran successfully @09.67100s +00.00100s
|`->config-grub-dpkg ran successfully @09.67300s +00.74300s
|`->config-apt-pipelining ran successfully @10.41600s +00.00200s
|`->config-apt-configure ran successfully @10.41800s +00.14500s
|`->config-ubuntu-advantage ran successfully @10.56300s +00.00100s
|`->config-ntp ran successfully @10.56500s +00.00000s
|`->config-timezone ran successfully @10.56600s +00.00000s
|`->config-disable-ec2-metadata ran successfully @10.56700s +00.00000s
|`->config-runcmd ran successfully @10.56700s +00.00100s
|`->config-byobu ran successfully @10.56800s +00.00100s
Finished stage: (modules-config) 01.95200 seconds 

Starting stage: modules-final
|`->config-snappy ran successfully @11.27400s +00.00200s
|`->config-package-update-upgrade-install ran successfully @11.27700s +00.00000s
|`->config-fan ran successfully @11.27800s +00.00100s
|`->config-landscape ran successfully @11.27900s +00.00100s
|`->config-lxd ran successfully @11.28000s +00.00100s
|`->config-ubuntu-drivers ran successfully @11.28100s +00.00100s
|`->config-puppet ran successfully @11.28200s +00.00100s
|`->config-chef ran successfully @11.28300s +00.00100s
|`->config-mcollective ran successfully @11.28400s +00.00100s
|`->config-salt-minion ran successfully @11.28500s +00.00100s
|`->config-rightscale_userdata ran successfully @11.28600s +00.00100s
|`->config-scripts-vendor ran successfully @11.28700s +00.03500s
|`->config-scripts-per-once ran successfully @11.32300s +00.00100s
|`->config-scripts-per-boot ran successfully @11.32400s +00.00100s
|`->config-scripts-per-instance ran successfully @11.32500s +00.00100s
|`->config-scripts-user ran successfully @11.32600s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @11.32700s +00.05500s
|`->config-keys-to-console ran successfully @11.38200s +00.11500s
|`->config-phone-home ran successfully @11.49800s +00.00100s
|`->config-final-message ran successfully @11.49900s +00.00700s
|`->config-power-state-change ran successfully @11.50600s +00.00100s
Finished stage: (modules-final) 00.26900 seconds 

Total Time: 4.26100 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- cloud-init analyze blame
-- Boot Record 01 --
     01.01300s (modules-config/config-ssh-import-id)
     00.74300s (modules-config/config-grub-dpkg)
     00.44300s (init-network/config-ssh)
     00.24200s (init-network/config-users-groups)
     00.19300s (init-network/config-mounts)
     00.18300s (init-network/config-growpart)
     00.14500s (modules-config/config-apt-configure)
     00.13400s (init-network/config-resizefs)
     00.11500s (modules-final/config-keys-to-console)
     00.10200s (init-local/search-IBMCloud)
     00.05500s (modules-final/config-ssh-authkey-fingerprints)
     00.03500s (modules-final/config-scripts-vendor)
     00.01600s (init-network/check-cache)
     00.01000s (init-network/consume-user-data)
     00.00900s (init-network/config-set_hostname)
     00.00700s (modules-final/config-final-message)
     00.00400s (init-network/consume-vendor-data)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/setup-datasource)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-disk_setup)
     00.00100s (init-network/activate-datasource)
     00.00000s (modules-final/config-package-update-upgrade-install)
     00.00000s (modules-config/config-timezone)
     00.00000s (modules-config/config-ntp)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/config-ca-certs)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)

1 boot records analyzed
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh root@75.126.32.22:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- bash setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu bionic-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~18.04.1 [409 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~18.04.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~18.04.1) over (19.1-1-gbaa47854-0ubuntu1~18.04.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~18.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- cloud-init clean --logs --reboot
Connection to 75.126.32.22 closed by remote host.
+ sleep 180
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- cloud-init status --wait --long

status: done
time: Thu, 23 Jan 2020 17:52:58 +0000
detail:
DataSourceIBMCloud [OS-Code/Live /dev/xvdh]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- grep Trace '/var/log/cloud-init*'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceIBMCloud [OS-Code/Live /dev/xvdh]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- systemd-analyze blame
          4.808s dev-xvda2.device
          2.803s cloud-init-local.service
          2.726s cloud-config.service
          2.470s keyboard-setup.service
          1.677s systemd-networkd-wait-online.service
          1.576s cloud-init.service
           894ms cloud-final.service
           838ms networkd-dispatcher.service
           639ms lxd-containers.service
           636ms snapd.service
           621ms xe-daemon.service
           502ms systemd-udev-trigger.service
           485ms systemd-journal-flush.service
           408ms apparmor.service
           401ms systemd-modules-load.service
           370ms accounts-daemon.service
           339ms systemd-journald.service
           333ms grub-common.service
           312ms ssh.service
           299ms systemd-logind.service
           280ms apport.service
           249ms lvm2-monitor.service
           183ms blk-availability.service
           173ms polkit.service
           162ms systemd-udevd.service
           152ms dev-hugepages.mount
           146ms ebtables.service
           141ms rsyslog.service
           141ms systemd-timesyncd.service
           136ms systemd-remount-fs.service
           132ms lxd.socket
           125ms snapd.socket
           116ms proc-xen.mount
           113ms ufw.service
           113ms kmod-static-nodes.service
           113ms dev-mqueue.mount
           111ms sys-kernel-debug.mount
            96ms systemd-networkd.service
            95ms snapd.seeded.service
            77ms systemd-resolved.service
            72ms systemd-tmpfiles-setup-dev.service
            72ms systemd-tmpfiles-setup.service
            60ms systemd-sysctl.service
            52ms plymouth-read-write.service
            40ms user@0.service
            39ms systemd-random-seed.service
            37ms plymouth-quit-wait.service
            35ms plymouth-quit.service
            33ms sys-kernel-config.mount
            31ms sys-fs-fuse-connections.mount
            30ms systemd-update-utmp.service
            30ms systemd-user-sessions.service
            29ms setvtrgb.service
            28ms console-setup.service
            25ms systemd-update-utmp-runlevel.service
            23ms dev-disk-by\x2dlabel-SWAP\x2dxvdb1.swap
            16ms boot.mount
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00100s
|`->found local data from DataSourceIBMCloud @00.03300s +00.08100s
Finished stage: (init-local) 00.69100 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceIBMCloud [OS-Code/Live /dev/xvdh] @03.12100s +00.01700s
|`->setting up datasource @03.21700s +00.00000s
|`->reading and applying user-data @03.22600s +00.01000s
|`->reading and applying vendor-data @03.23600s +00.00400s
|`->activating datasource @03.28000s +00.00100s
|`->config-migrator ran successfully @03.36400s +00.00100s
|`->config-seed_random ran successfully @03.36500s +00.00800s
|`->config-bootcmd ran successfully @03.37400s +00.00000s
|`->config-write-files ran successfully @03.37400s +00.00100s
|`->config-growpart ran successfully @03.37500s +00.11900s
|`->config-resizefs ran successfully @03.49500s +00.10400s
|`->config-disk_setup ran successfully @03.60000s +00.00100s
|`->config-mounts ran successfully @03.60100s +00.01800s
|`->config-set_hostname ran successfully @03.62000s +00.01600s
|`->config-update_hostname ran successfully @03.63700s +00.00100s
|`->config-update_etc_hosts ran successfully @03.63900s +00.00000s
|`->config-ca-certs ran successfully @03.64000s +00.00000s
|`->config-rsyslog ran successfully @03.64100s +00.00100s
|`->config-users-groups ran successfully @03.64200s +00.06700s
|`->config-ssh ran successfully @03.70900s +00.33400s
Finished stage: (init-network) 00.93900 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @06.36600s +00.00000s
|`->config-snap ran successfully @06.36600s +00.00100s
|`->config-ssh-import-id ran successfully @06.36800s +00.97400s
|`->config-locale ran successfully @07.34300s +00.00200s
|`->config-set-passwords ran successfully @07.34500s +00.00200s
|`->config-grub-dpkg ran successfully @07.34800s +00.51700s
|`->config-apt-pipelining ran successfully @07.86500s +00.00100s
|`->config-apt-configure ran successfully @07.86700s +00.18700s
|`->config-ubuntu-advantage ran successfully @08.05400s +00.00100s
|`->config-ntp ran successfully @08.05600s +00.00000s
|`->config-timezone ran successfully @08.05700s +00.00100s
|`->config-disable-ec2-metadata ran successfully @08.05800s +00.00000s
|`->config-runcmd ran successfully @08.05800s +00.00100s
|`->config-byobu ran successfully @08.06000s +00.00000s
Finished stage: (modules-config) 01.73900 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @08.74000s +00.00000s
|`->config-fan ran successfully @08.74100s +00.00100s
|`->config-landscape ran successfully @08.74200s +00.00100s
|`->config-lxd ran successfully @08.74300s +00.00100s
|`->config-ubuntu-drivers ran successfully @08.74400s +00.00100s
|`->config-puppet ran successfully @08.74500s +00.00100s
|`->config-chef ran successfully @08.74600s +00.00100s
|`->config-mcollective ran successfully @08.74700s +00.00100s
|`->config-salt-minion ran successfully @08.74800s +00.00100s
|`->config-rightscale_userdata ran successfully @08.74900s +00.00100s
|`->config-scripts-vendor ran successfully @08.75000s +00.03000s
|`->config-scripts-per-once ran successfully @08.78100s +00.00100s
|`->config-scripts-per-boot ran successfully @08.78200s +00.00000s
|`->config-scripts-per-instance ran successfully @08.78300s +00.00100s
|`->config-scripts-user ran successfully @08.78400s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @08.78500s +00.05400s
|`->config-keys-to-console ran successfully @08.83900s +00.10600s
|`->config-phone-home ran successfully @08.94600s +00.00100s
|`->config-final-message ran successfully @08.94700s +00.00700s
|`->config-power-state-change ran successfully @08.95400s +00.00100s
Finished stage: (modules-final) 00.24800 seconds

Total Time: 3.61700 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- cloud-init analyze blame
-- Boot Record 01 --
     00.97400s (modules-config/config-ssh-import-id)
     00.51700s (modules-config/config-grub-dpkg)
     00.33400s (init-network/config-ssh)
     00.18700s (modules-config/config-apt-configure)
     00.11900s (init-network/config-growpart)
     00.10600s (modules-final/config-keys-to-console)
     00.10400s (init-network/config-resizefs)
     00.08100s (init-local/search-IBMCloud)
     00.06700s (init-network/config-users-groups)
     00.05400s (modules-final/config-ssh-authkey-fingerprints)
     00.03000s (modules-final/config-scripts-vendor)
     00.01800s (init-network/config-mounts)
     00.01700s (init-network/check-cache)
     00.01600s (init-network/config-set_hostname)
     00.01000s (init-network/consume-user-data)
     00.00800s (init-network/config-seed_random)
     00.00700s (modules-final/config-final-message)
     00.00400s (init-network/consume-vendor-data)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-locale)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-disk_setup)
     00.00100s (init-network/activate-datasource)
     00.00100s (init-local/check-cache)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-package-update-upgrade-install)
     00.00000s (modules-config/config-ntp)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (modules-config/config-byobu)
     00.00000s (init-network/setup-datasource)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-ca-certs)
     00.00000s (init-network/config-bootcmd)

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- 'cloud-init query --format '\''cloud-region: {{cloud_name}}-{{region}}'\'''
cloud-region: ibmcloud-None
+ echo 'Get cloud-id'
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- cloud-id
ibmcloud
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- 'cloud-init query --format '\''cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'\'''
WARNING: Ignoring jinja template for query commandline: 'dict object' has no attribute 'imds'
+ echo 'Validating whether metadata is being updated per boot LP:1819913. Expect last log to contain System Boot'
Validating whether metadata is being updated per boot LP:1819913. Expect last log to contain System Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- reboot
Connection to 75.126.32.22 closed by remote host.
+ true
+ sleep 180
+ echo 'After reboot'
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- cloud-init status --wait --long

status: done
time: Thu, 23 Jan 2020 17:56:07 +0000
detail:
DataSourceIBMCloud [OS-Code/Live /dev/xvdh]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2020-01-23 17:52:49,576 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
+ echo 'Confirm no traceback after reboot LP: 1823084'
Confirm no traceback after reboot LP: 1823084
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR root@75.126.32.22 -- 'grep '\''Trace'\'' /var/log/cloud-init.log'
+ echo '### END bionic'
### END bionic

==== END SRU Verification OUTPUT ===

