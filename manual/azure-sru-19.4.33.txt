#!/bin/sh
set -x
# Manually deploy on Azure using Azure CLI client.
# Validate upgrade to proposed version of cloud-init
# Check Tracebacks or error conditions on clean boot
 
# To be adapted to the SRU to test
SRU_SERIES="xenial bionic eoan"

# local values
# find region with az account list-locations -o table
REGION="eastus2"
VNET_NAME="sruVnet"
NETWORK_SECURITY_GROUP="sruNetSecGroup"
NIC_NAME="sruNic"
RESOURCE_GROUP="srugroupIPV6"
BOOT_DIAG="storeitsru"
SSH_KEY="$HOME/.ssh/id_rsa.pub"


ADVANCED_NIC_TESTS=true


IPV6_NET_REGISTERED=$(az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network | jq -r '.properties.state')
IPV6_CA_LB_REGISTERED=$(az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network | jq -r '.properties.state')

if [ "$IPV6_NET_REGISTERED" != "Registered" -o "$IPV6_CA_LB_REGISTERED" != "Registered" ]; then
    echo "Account is not yet registered for AllowIPv6VirtualNetwork or AllowIPv6CAOnStandardLB. Can take 30 mins. Activate feature now (y/n)?"
    read RESP
    if [ "$RESP" = "y" ]; then
        az feature register --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
        az feature register --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
    else
        echo "Skipping any advanced network tests because you opted to avoid registering IPv6 feature"
        echo -n "Proceed without any advanced networking tests (y/n)? "
        read OK
        if [ "$OK" = "y" ]; then
            ADVANCED_NIC_TESTS=false
        else
            echo "quit the test run"
            exit 1
        fi
    fi
    echo "Waiting for AllowIPv6VirtualNetwork feature registration"
    while [ "$IPV6_NET_REGISTERED" != "Registered" -o "$IPV6_CA_LB_REGISTERED" != "Registered" ]; do
        echo -n "."
        sleep 5
        IPV6_NET_REGISTERED=$(az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network | jq -r '.properties.state')
        IPV6_CA_LB_REGISTERED=$(az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network | jq -r '.properties.state')
    done
fi

IPV6_REGISTRATION_COMPLETE=$(az provider show -n Microsoft.Network | jq -r ".registrationState")
echo "Waiting for Microsoft.Network IPv6 feature registration"
while [ "$IPV6_REGISTRATION_COMPLETE"  != "Registered" ]; do
    echo -n "."
    sleep 5
    IPV6_REGISTRATION_COMPLETE=$(az provider show -n Microsoft.Network | jq -r ".registrationState")
done


cat > sethostname.yaml <<EOF
## template: jinja
#cloud-config
ssh_import_id : [chad.smith]
hostname: SRU-worked-{{v1.cloud_name}}
EOF

cat > setup_proposed.sh <<EOF
#/bin/bash
mirror=http://archive.ubuntu.com/ubuntu
echo deb \$mirror \$(lsb_release -sc)-proposed main | tee /etc/apt/sources.list.d/proposed.list
apt-get update -q
apt-get install -qy cloud-init
EOF

az group create --name $RESOURCE_GROUP --location $REGION

if [ -n "${BOOT_DIAG}" ]; then
    az storage account create \
        --name $BOOT_DIAG \
        --resource-group $RESOURCE_GROUP \
        --location $REGION \
        --sku Standard_RAGRS \
        --kind StorageV2
    BOOT_DIAG_ARG="--boot-diagnostics-storage ${BOOT_DIAG}"
else
    BOOT_DIAG_ARG=""
fi


az network nsg create \
    --resource-group $RESOURCE_GROUP \
    --location $REGION \
    --name $NETWORK_SECURITY_GROUP

az network nsg rule create \
    --name allowSSHIn  \
    --nsg-name $NETWORK_SECURITY_GROUP  \
    --resource-group $RESOURCE_GROUP  \
    --priority 100  \
    --description "Allow SSH In"  \
    --access Allow  \
    --protocol "*"  \
    --direction Inbound  \
    --source-address-prefixes "*"  \
    --source-port-ranges "*"  \
    --destination-address-prefixes "*"  \
    --destination-port-ranges 22

az network nsg rule create \
    --name allowAllOut  \
    --resource-group $RESOURCE_GROUP \
    --nsg-name $NETWORK_SECURITY_GROUP \
    --priority 200  \
    --description "Allow All Out"  \
    --access Allow  \
    --protocol "*"  \
    --direction Outbound  \
    --source-address-prefixes "*"  \
    --source-port-ranges "*"  \
    --destination-address-prefixes "*"  \
    --destination-port-ranges "*"

az network vnet create \
    --resource-group $RESOURCE_GROUP \
    --location $REGION \
    --name $VNET_NAME \
    --address-prefixes "10.0.0.0/16" "ace:cab:deca::/48"

az network vnet subnet create \
    --name sruSubnet \
    --resource-group $RESOURCE_GROUP \
    --vnet-name $VNET_NAME \
    --address-prefixes "10.0.0.0/24" "ace:cab:deca:deed::/64" \
    --network-security-group $NETWORK_SECURITY_GROUP


sshopts="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"
for series in $SRU_SERIES; do
    echo "### BEGIN $series"
    netcfg="/etc/netplan/50-cloud-init.yaml"
    case $series in
        xenial) image_version=16.04-DAILY-LTS
                netcfg="/etc/network/interfaces.d/50-cloud-init.cfg";;
        bionic) image_version=18.04-DAILY-LTS;;
        disco) image_version=19.04-DAILY;;
        eoan) image_version=19.10-DAILY;;
        *) echo "!! UPDATE FAMILY CASE STATEMENT !!"; exit 1;;
    esac
    # Note: accelerated network requires bigger size than our default DS1
    for nics in "" "--nics $NIC_NAME-$series ${NIC_NAME}2-$series --size Standard_DS2_v2"; do
        if [ "" = "$nics" ]; then
            echo "Creating standard network vm"
            name=test-sru-$series
        else
            if [ $ADVANCED_NIC_TESTS = false ]; then
                echo "Skipping advanced nic tests because ipv6 feature is disabled"
                continue
            fi
            echo "Creating advanced network vm"
            name=test-sru-$series-advanced
	    # Dual stack load balancer setup with only 1 dualstack/dual nic vm
            # Create VM IP address
            az network public-ip create \
                --name vmPublicIP-IPv4-$series \
                --resource-group $RESOURCE_GROUP \
                --location $REGION \
		--sku BASIC \
                --allocation-method dynamic \
                --version IPv4
	    # Create an IPV4 IP address for LB
            az network public-ip create \
            --name lbPublicIP_v4_$series  \
            --resource-group $RESOURCE_GROUP  \
            --location $REGION  \
            --sku BASIC  \
            --allocation-method dynamic  \
            --version IPv4

            # Create an IPV6 IP address for LB
            az network public-ip create \
            --name lbPublicIP_v6_$series  \
            --resource-group $RESOURCE_GROUP  \
            --location $REGION \
            --sku BASIC  \
            --allocation-method dynamic  \
            --version IPv6

	    # Create LB
	    az network lb create \
            --name dsLB_$series  \
            --resource-group $RESOURCE_GROUP \
            --sku Basic \
            --location $REGION \
            --frontend-ip-name dsLbFrontEnd_v4_$series  \
            --public-ip-address lbPublicIP_v4_$series  \
            --backend-pool-name dsLbBackEndPool_v4_$series

	    # Create LB ipv6 frontend
	    az network lb frontend-ip create \
            --lb-name dsLB_$series  \
            --name dsLbFrontEnd_v6_$series  \
            --resource-group $RESOURCE_GROUP  \
            --public-ip-address lbPublicIP_v6_$series

	    # Create LB ipv6 backend
	    az network lb address-pool create \
            --lb-name dsLB_$series  \
            --name dsLbBackEndPool_v6_$series  \
            --resource-group $RESOURCE_GROUP

	    # Create LB health probe for ssh port
	    az network lb probe create -g $RESOURCE_GROUP  \
	    --lb-name dsLB_$series -n dsProbe_$series --protocol tcp \
	    --port 22

	    az network lb rule create \
            --lb-name dsLB_$series  \
            --name dsLBrule_v4_$series  \
            --resource-group $RESOURCE_GROUP  \
            --frontend-ip-name dsLbFrontEnd_v4_$series  \
            --protocol Tcp  \
            --frontend-port 22  \
            --backend-port 22  \
            --probe-name dsProbe_$series \
            --backend-pool-name dsLbBackEndPool_v4_$series

	    az network lb rule create \
            --lb-name dsLB_$series  \
            --name dsLBrule_v6_$series  \
            --resource-group $RESOURCE_GROUP  \
            --frontend-ip-name dsLbFrontEnd_v6_$series  \
            --protocol Tcp  \
            --frontend-port 22  \
            --backend-port 22  \
            --probe-name dsProbe_$series \
            --backend-pool-name dsLbBackEndPool_v6_$series

	    az vm availability-set create \
            --name dsAVset_$series  \
            --resource-group $RESOURCE_GROUP \
            --location $REGION \
            --platform-fault-domain-count 2  \
            --platform-update-domain-count 2

            az network nic create \
                --name $NIC_NAME-$series \
                --resource-group $RESOURCE_GROUP \
                --network-security-group $NETWORK_SECURITY_GROUP \
                --vnet-name $VNET_NAME \
                 --accelerated-networking true \
                --subnet sruSubnet \
                --private-ip-address-version IPv4 \
	 	--lb-address-pools dsLbBackEndPool_v4_$series  \
                --lb-name dsLB_$series  \
                --public-ip-address vmPublicIP-IPv4-$series

            az network nic create \
                --name ${NIC_NAME}2-$series \
                --resource-group $RESOURCE_GROUP \
                --network-security-group $NETWORK_SECURITY_GROUP \
                --vnet-name $VNET_NAME \
                --accelerated-networking true \
                --subnet sruSubnet \
                --private-ip-address-version IPv4

	    # Add IPv6 on primary nic
            az network nic ip-config create \
                --name $NIC_NAME-$series-v6 \
                --nic-name $NIC_NAME-$series \
                --resource-group $RESOURCE_GROUP \
                --vnet-name $VNET_NAME \
                --subnet sruSubnet \
	        --lb-address-pools dsLbBackEndPool_v6_$series  \
                --lb-name dsLB_$series \
                --private-ip-address-version IPv6

        fi
        az vm create --name=$name \
            --image=Canonical:UbuntuServer:$image_version:latest \
            --admin-username=root --admin-username=ubuntu \
            -g $RESOURCE_GROUP --ssh-key-value $SSH_KEY \
            $BOOT_DIAG_ARG \
            --custom-data sethostname.yaml $nics
        IP=$(az vm list-ip-addresses --name $name | jq -r '.[] | .virtualMachine.network.publicIpAddresses[].ipAddress'| awk '{printf "ubuntu@%s", $1}')

        echo "Created $name: ubuntu@$IP"

        ssh $sshopts $IP -- cloud-init status --wait --long
        ssh $sshopts $IP -- dpkg-query --show cloud-init
        ssh $sshopts $IP -- sudo cat /run/cloud-init/result.json
        ssh $sshopts $IP -- grep Trace /var/log/cloud-init.log
        ssh $sshopts $IP -- systemd-analyze
        ssh $sshopts $IP -- systemd-analyze blame
        ssh $sshopts $IP -- cloud-init analyze show
        ssh $sshopts $IP -- cloud-init analyze blame
        echo 'Writing networking config: previous-network.out'
        ssh $sshopts $IP -- cat $netcfg > previous-network.out
        ssh $sshopts $IP -- ip -4 route >> previous-network.out
        ssh $sshopts $IP -- ip -4 addr >> previous-network.out
        ssh $sshopts $IP -- ip -6 route >> previous-network.out
        ssh $sshopts $IP -- ip -6 addr >> previous-network.out
        ssh $sshopts $IP -- grep DHCP /var/log/syslog >> previous-network.out

        scp $sshopts setup_proposed.sh $IP:.
        ssh $sshopts $IP -- sudo bash ./setup_proposed.sh 2>&1 | egrep 'cloud-init'
        ssh $sshopts $IP -- dpkg-query --show cloud-init
        ssh $sshopts $IP -- sudo hostname SRU-didnt-work
        ssh $sshopts $IP -- sudo rm -f $netcfg
        ssh $sshopts $IP -- sudo cloud-init clean --logs --reboot
        sleep 60

        ssh $sshopts $IP -- cloud-init status --wait --long
        ssh $sshopts $IP -- grep Trace /var/log/cloud-init\*
        ssh $sshopts $IP -- sudo cat /run/cloud-init/result.json
        ssh $sshopts $IP -- sudo systemd-analyze blame
        ssh $sshopts $IP -- cloud-init analyze show
        ssh $sshopts $IP -- cloud-init analyze blame
        echo 'After upgrade write network config: upgrade-network.out'
        ssh $sshopts $IP -- cat $netcfg > upgrade-network.out
        ssh $sshopts $IP -- ip -4 route >> upgrade-network.out
        ssh $sshopts $IP -- ip -4 addr >> upgrade-network.out
        ssh $sshopts $IP -- ip -6 route >> upgrade-network.out
        ssh $sshopts $IP -- ip -6 addr >> upgrade-network.out
        ssh $sshopts $IP -- grep DHCP /var/log/syslog >> upgrade-network.out
	echo '------- Diff previous-network to post-upgrade-network ------'
	diff -urN previous-network.out upgrade-network.out
	echo '------- Diff previous-network to post-upgrade-network ------'
        ssh $sshopts $IP -- cloud-init query --format "'cloud-region: {{cloud_name}}-{{region}}'"
        echo 'Get cloud-id'
        ssh $sshopts $IP -- cloud-id
        ssh $sshopts $IP -- cloud-init query --format "'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'"
        echo 'Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot'
        ssh $sshopts $IP -- sudo reboot || true
        sleep 30
        ssh $sshopts $IP -- cloud-init status --wait --long
        echo 'After reboot'
        ssh $sshopts $IP -- "grep 'Update datasource' /var/log/cloud-init.log"
    done
    echo "### END $series"
done

=== BEGIN SRU Verification output ====
root@publishing:~# ./azure-lp.txt | tee azure-sru.log
+ SRU_SERIES=xenial bionic eoan
+ REGION=eastus2
+ VNET_NAME=sruVnet
+ NETWORK_SECURITY_GROUP=sruNetSecGroup
+ NIC_NAME=sruNic
+ RESOURCE_GROUP=srugroup
+ BOOT_DIAG=storeitsru
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ ADVANCED_NIC_TESTS=true
+ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
+ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ [ Registered != Registered -o Registered != Registered ]
+ az provider show -n Microsoft.Network
+ jq -r .registrationState
+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo Waiting for Microsoft.Network IPv6 feature registration
Waiting for Microsoft.Network IPv6 feature registration
+ [ Registered != Registered ]
+ cat
+ cat
+ az group create --name srugroup --location eastus2
{
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup",
  "location": "eastus2",
  "managedBy": null,
  "name": "srugroup",
  "properties": {
    "provisioningState": "Succeeded"
  },
  "tags": null,
  "type": "Microsoft.Resources/resourceGroups"
}
+ [ -n storeitsru ]
+ az storage account create --name storeitsru --resource-group srugroup --location eastus2 --sku Standard_RAGRS --kind StorageV2
The default kind for created storage account will change to 'StorageV2' from 'Storage' in future
{
  "accessTier": "Hot",
  "azureFilesIdentityBasedAuthentication": null,
  "creationTime": "2020-01-23T22:58:06.292604+00:00",
  "customDomain": null,
  "enableHttpsTrafficOnly": true,
  "encryption": {
    "keySource": "Microsoft.Storage",
    "keyVaultProperties": null,
    "services": {
      "blob": {
        "enabled": true,
        "lastEnabledTime": "2020-01-23T22:58:06.370711+00:00"
      },
      "file": {
        "enabled": true,
        "lastEnabledTime": "2020-01-23T22:58:06.370711+00:00"
      },
      "queue": null,
      "table": null
    }
  },
  "failoverInProgress": null,
  "geoReplicationStats": null,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Storage/storageAccounts/storeitsru",
  "identity": null,
  "isHnsEnabled": null,
  "kind": "StorageV2",
  "largeFileSharesState": null,
  "lastGeoFailoverTime": null,
  "location": "eastus2",
  "name": "storeitsru",
  "networkRuleSet": {
    "bypass": "AzureServices",
    "defaultAction": "Allow",
    "ipRules": [],
    "virtualNetworkRules": []
  },
  "primaryEndpoints": {
    "blob": "https://storeitsru.blob.core.windows.net/",
    "dfs": "https://storeitsru.dfs.core.windows.net/",
    "file": "https://storeitsru.file.core.windows.net/",
    "queue": "https://storeitsru.queue.core.windows.net/",
    "table": "https://storeitsru.table.core.windows.net/",
    "web": "https://storeitsru.z20.web.core.windows.net/"
  },
  "primaryLocation": "eastus2",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroup",
  "secondaryEndpoints": {
    "blob": "https://storeitsru-secondary.blob.core.windows.net/",
    "dfs": "https://storeitsru-secondary.dfs.core.windows.net/",
    "file": null,
    "queue": "https://storeitsru-secondary.queue.core.windows.net/",
    "table": "https://storeitsru-secondary.table.core.windows.net/",
    "web": "https://storeitsru-secondary.z20.web.core.windows.net/"
  },
  "secondaryLocation": "centralus",
  "sku": {
    "capabilities": null,
    "kind": null,
    "locations": null,
    "name": "Standard_RAGRS",
    "resourceType": null,
    "restrictions": null,
    "tier": "Standard"
  },
  "statusOfPrimary": "available",
  "statusOfSecondary": "available",
  "tags": {},
  "type": "Microsoft.Storage/storageAccounts"
}
+ BOOT_DIAG_ARG=--boot-diagnostics-storage storeitsru
+ az network nsg create --resource-group srugroup --location eastus2 --name sruNetSecGroup
{
  "NewNSG": {
    "defaultSecurityRules": [
      {
        "access": "Allow",
        "description": "Allow inbound traffic from all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"47ebf2fb-d7c7-43dc-b65f-3e837042515a\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetInBound",
        "name": "AllowVnetInBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroup",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow inbound traffic from azure load balancer",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"47ebf2fb-d7c7-43dc-b65f-3e837042515a\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowAzureLoadBalancerInBound",
        "name": "AllowAzureLoadBalancerInBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroup",
        "sourceAddressPrefix": "AzureLoadBalancer",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all inbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"47ebf2fb-d7c7-43dc-b65f-3e837042515a\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllInBound",
        "name": "DenyAllInBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroup",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"47ebf2fb-d7c7-43dc-b65f-3e837042515a\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetOutBound",
        "name": "AllowVnetOutBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroup",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to Internet",
        "destinationAddressPrefix": "Internet",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"47ebf2fb-d7c7-43dc-b65f-3e837042515a\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowInternetOutBound",
        "name": "AllowInternetOutBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroup",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all outbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"47ebf2fb-d7c7-43dc-b65f-3e837042515a\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllOutBound",
        "name": "DenyAllOutBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroup",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      }
    ],
    "etag": "W/\"47ebf2fb-d7c7-43dc-b65f-3e837042515a\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": "eastus2",
    "name": "sruNetSecGroup",
    "networkInterfaces": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroup",
    "resourceGuid": "2989ab55-851a-4fec-b7c0-1b7f6606b203",
    "securityRules": [],
    "subnets": null,
    "tags": null,
    "type": "Microsoft.Network/networkSecurityGroups"
  }
}
+ az network nsg rule create --name allowSSHIn --nsg-name sruNetSecGroup --resource-group srugroup --priority 100 --description Allow SSH In --access Allow --protocol * --direction Inbound --source-address-prefixes * --source-port-ranges * --destination-address-prefixes * --destination-port-ranges 22
{
  "access": "Allow",
  "description": "Allow SSH In",
  "destinationAddressPrefix": "*",
  "destinationAddressPrefixes": [],
  "destinationApplicationSecurityGroups": null,
  "destinationPortRange": "22",
  "destinationPortRanges": [],
  "direction": "Inbound",
  "etag": "W/\"a995c9ab-6c80-4d1e-9acd-616ce67f126c\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/securityRules/allowSSHIn",
  "name": "allowSSHIn",
  "priority": 100,
  "protocol": "*",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroup",
  "sourceAddressPrefix": "*",
  "sourceAddressPrefixes": [],
  "sourceApplicationSecurityGroups": null,
  "sourcePortRange": "*",
  "sourcePortRanges": [],
  "type": "Microsoft.Network/networkSecurityGroups/securityRules"
}
+ az network nsg rule create --name allowAllOut --resource-group srugroup --nsg-name sruNetSecGroup --priority 200 --description Allow All Out --access Allow --protocol * --direction Outbound --source-address-prefixes * --source-port-ranges * --destination-address-prefixes * --destination-port-ranges *
{
  "access": "Allow",
  "description": "Allow All Out",
  "destinationAddressPrefix": "*",
  "destinationAddressPrefixes": [],
  "destinationApplicationSecurityGroups": null,
  "destinationPortRange": "*",
  "destinationPortRanges": [],
  "direction": "Outbound",
  "etag": "W/\"e25735f0-b25c-4b69-89d5-849092c4a766\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/securityRules/allowAllOut",
  "name": "allowAllOut",
  "priority": 200,
  "protocol": "*",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroup",
  "sourceAddressPrefix": "*",
  "sourceAddressPrefixes": [],
  "sourceApplicationSecurityGroups": null,
  "sourcePortRange": "*",
  "sourcePortRanges": [],
  "type": "Microsoft.Network/networkSecurityGroups/securityRules"
}
+ az network vnet create --resource-group srugroup --location eastus2 --name sruVnet --address-prefixes 10.0.0.0/16 ace:cab:deca::/48
{
  "newVNet": {
    "addressSpace": {
      "addressPrefixes": [
        "10.0.0.0/16",
        "ace:cab:deca::/48"
      ]
    },
    "ddosProtectionPlan": null,
    "dhcpOptions": {
      "dnsServers": []
    },
    "enableDdosProtection": false,
    "enableVmProtection": false,
    "etag": "W/\"26ca3bdc-db75-4bc8-a1df-2f711f1c8e7d\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/virtualNetworks/sruVnet",
    "location": "eastus2",
    "name": "sruVnet",
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroup",
    "resourceGuid": "0d577aa1-1819-4c10-91bd-8c2bdad43ebb",
    "subnets": [],
    "tags": {},
    "type": "Microsoft.Network/virtualNetworks",
    "virtualNetworkPeerings": []
  }
}
+ az network vnet subnet create --name sruSubnet --resource-group srugroup --vnet-name sruVnet --address-prefixes 10.0.0.0/24 ace:cab:deca:deed::/64 --network-security-group sruNetSecGroup
{
  "addressPrefix": null,
  "addressPrefixes": [
    "10.0.0.0/24",
    "ace:cab:deca:deed::/64"
  ],
  "delegations": [],
  "etag": "W/\"68569193-37c1-4060-aef3-eab48dc84e08\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
  "ipConfigurationProfiles": null,
  "ipConfigurations": null,
  "name": "sruSubnet",
  "natGateway": null,
  "networkSecurityGroup": {
    "defaultSecurityRules": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": null,
    "name": null,
    "networkInterfaces": null,
    "provisioningState": null,
    "resourceGroup": "srugroup",
    "resourceGuid": null,
    "securityRules": null,
    "subnets": null,
    "tags": null,
    "type": null
  },
  "privateEndpointNetworkPolicies": "Enabled",
  "privateEndpoints": null,
  "privateLinkServiceNetworkPolicies": "Enabled",
  "provisioningState": "Succeeded",
  "purpose": null,
  "resourceGroup": "srugroup",
  "resourceNavigationLinks": null,
  "routeTable": null,
  "serviceAssociationLinks": null,
  "serviceEndpointPolicies": null,
  "serviceEndpoints": null,
  "type": "Microsoft.Network/virtualNetworks/subnets"
}
+ sshopts=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR
+ echo ### BEGIN xenial
+ ### BEGIN xenial
netcfg=/etc/netplan/50-cloud-init.yaml
+ image_version=16.04-DAILY-LTS
+ netcfg=/etc/network/interfaces.d/50-cloud-init.cfg
+ [  =  ]
+ echo Creating standard network vm
+ name=test-sru-xenial
Creating standard network vm
+ az vm create --name=test-sru-xenial --image=Canonical:UbuntuServer:16.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroup --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Compute/virtualMachines/test-sru-xenial",
  "location": "eastus2",
  "macAddress": "00-0D-3A-03-0F-3C",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.4",
  "publicIpAddress": "40.79.42.61",
  "resourceGroup": "srugroup",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-xenial
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@40.79.42.61
+ echo Created test-sru-xenial: ubuntu@ubuntu@40.79.42.61
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- cloud-init status --wait --long
Created test-sru-xenial: ubuntu@ubuntu@40.79.42.61

status: done
time: Thu, 23 Jan 2020 23:01:41 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- dpkg-query --show cloud-init
cloud-init	19.3-41-gc4735dd3-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- systemd-analyze
Startup finished in 6.006s (kernel) + 27.237s (userspace) = 33.243s
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- systemd-analyze blame
          8.348s cloud-init.service
          4.910s cloud-config.service
          4.196s cloud-init-local.service
          2.668s snapd.service
          2.569s lxd-containers.service
          2.496s pollinate.service
          2.151s dev-sda1.device
          1.661s apparmor.service
          1.556s snapd.seeded.service
          1.235s accounts-daemon.service
           851ms cloud-final.service
           764ms networking.service
           720ms grub-common.service
           619ms iscsid.service
           583ms lvm2-monitor.service
           549ms mdadm.service
           514ms open-iscsi.service
           437ms systemd-timesyncd.service
           330ms systemd-logind.service
           301ms rsyslog.service
           278ms systemd-modules-load.service
           275ms ufw.service
           265ms keyboard-setup.service
           261ms dev-mqueue.mount
           254ms kmod-static-nodes.service
           240ms irqbalance.service
           226ms snapd.socket
           225ms lxd.socket
           222ms console-setup.service
           218ms resolvconf.service
           204ms apport.service
           203ms sys-kernel-debug.mount
           193ms systemd-udev-trigger.service
           187ms dev-hugepages.mount
           185ms systemd-journald.service
           162ms systemd-tmpfiles-setup-dev.service
           145ms ondemand.service
           125ms ssh.service
           112ms systemd-udevd.service
           109ms systemd-remount-fs.service
            98ms systemd-random-seed.service
            94ms polkitd.service
            91ms plymouth-read-write.service
            88ms systemd-journal-flush.service
            87ms ephemeral-disk-warning.service
            82ms systemd-sysctl.service
            78ms systemd-tmpfiles-setup.service
            73ms systemd-update-utmp.service
            62ms systemd-machine-id-commit.service
            62ms sys-kernel-config.mount
            52ms rc-local.service
            41ms systemd-user-sessions.service
            34ms plymouth-quit-wait.service
            32ms plymouth-quit.service
            31ms boot-efi.mount
            31ms setvtrgb.service
            22ms sys-fs-fuse-connections.mount
            22ms user@1000.service
            11ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.15100s +00.00700s
|`->get_boot_telemetry @00.15800s +00.01100s
|`->get_system_info @00.16900s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.17000s +00.06100s
|`->load_azure_ds_dir @00.23100s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.37400s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.37500s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00800 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.40100s +00.39700s
|`->_get_metadata_from_imds @00.79900s +00.03200s
Finished stage: (azure-ds/get_metadata_from_imds) 00.45400 seconds

|`->_get_random_seed @00.85500s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.69300 seconds

|`->write_files @00.86400s +00.00200s
Finished stage: (azure-ds/_get_data) 00.71500 seconds

Finished stage: (init-local/search-Azure) 00.71800 seconds

|`->network config from fallback @00.93200s +00.02000s
Finished stage: (init-local) 00.96800 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @02.18300s +00.02500s
|`->network config from fallback @02.27500s +00.02200s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @02.30700s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

|`->invoke_agent @02.31000s +00.19700s
|`->wait for agents to retrieve ssh keys @02.50800s +01.00200s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @03.51000s +00.04400s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.04400 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 01.24800 seconds

Finished stage: (azure-ds/_negotiate) 01.24900 seconds

Finished stage: (azure-ds/setup) 01.24900 seconds

Finished stage: (init-network/setup-datasource) 01.24900 seconds

|`->reading and applying user-data @03.56300s +00.00800s
|`->reading and applying vendor-data @03.57100s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.60400s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.60500s +00.05300s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @03.72600s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.07400 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.13000 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.13000 seconds

Finished stage: (azure-ds/activate) 00.13000 seconds

Finished stage: (init-network/activate-datasource) 00.13200 seconds

|`->config-migrator ran successfully @03.80300s +00.00100s
|`->config-seed_random ran successfully @03.80400s +00.00100s
|`->config-bootcmd ran successfully @03.80600s +00.00000s
|`->config-write-files ran successfully @03.80700s +00.00100s
|`->config-growpart ran successfully @03.80800s +00.49500s
|`->config-resizefs ran successfully @04.30400s +00.29400s
|`->config-disk_setup ran successfully @04.59800s +04.54300s
|`->config-mounts ran successfully @09.14200s +00.12700s
|`->config-set_hostname ran successfully @09.27000s +00.00600s
|`->config-update_hostname ran successfully @09.27700s +00.00100s
|`->config-update_etc_hosts ran successfully @09.27900s +00.00000s
|`->config-ca-certs ran successfully @09.28000s +00.00100s
|`->config-rsyslog ran successfully @09.28100s +00.00100s
|`->config-users-groups ran successfully @09.28300s +00.60900s
|`->config-ssh ran successfully @09.89200s +00.17700s
Finished stage: (init-network) 07.90000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @15.91000s +00.00100s
|`->config-snap ran successfully @15.91500s +00.00100s
|`->config-snap_config ran successfully @15.91700s +00.00100s
|`->config-ssh-import-id ran successfully @15.91800s +01.18900s
|`->config-locale ran successfully @17.10700s +01.51300s
|`->config-set-passwords ran successfully @18.62100s +00.00200s
|`->config-grub-dpkg ran successfully @18.62300s +01.17000s
|`->config-apt-pipelining ran successfully @19.79400s +00.00200s
|`->config-apt-configure ran successfully @19.79600s +00.17700s
|`->config-ubuntu-advantage ran successfully @19.97400s +00.00100s
|`->config-ntp ran successfully @19.97600s +00.00100s
|`->config-timezone ran successfully @19.97700s +00.00100s
|`->config-disable-ec2-metadata ran successfully @19.97900s +00.00000s
|`->config-runcmd ran successfully @19.98000s +00.00100s
|`->config-byobu ran successfully @19.98100s +00.00100s
Finished stage: (modules-config) 04.11400 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @20.61500s +00.00200s
|`->config-package-update-upgrade-install ran successfully @20.61700s +00.00100s
|`->config-fan ran successfully @20.61900s +00.00100s
|`->config-landscape ran successfully @20.62000s +00.00100s
|`->config-lxd ran successfully @20.62100s +00.00100s
|`->config-ubuntu-drivers ran successfully @20.62300s +00.00100s
|`->config-puppet ran successfully @20.62400s +00.00100s
|`->config-chef ran successfully @20.62500s +00.00100s
|`->config-mcollective ran successfully @20.62700s +00.00100s
|`->config-salt-minion ran successfully @20.62800s +00.00100s
|`->config-rightscale_userdata ran successfully @20.62900s +00.00100s
|`->config-scripts-vendor ran successfully @20.63100s +00.00100s
|`->config-scripts-per-once ran successfully @20.63200s +00.00100s
|`->config-scripts-per-boot ran successfully @20.63300s +00.00100s
|`->config-scripts-per-instance ran successfully @20.63400s +00.00100s
|`->config-scripts-user ran successfully @20.63500s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @20.63700s +00.06300s
|`->config-keys-to-console ran successfully @20.70000s +00.17600s
|`->config-phone-home ran successfully @20.87800s +00.00100s
|`->config-final-message ran successfully @20.88000s +00.00400s
|`->config-power-state-change ran successfully @20.88500s +00.00100s
Finished stage: (modules-final) 00.35000 seconds

Total Time: 21.56200 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- cloud-init analyze blame
-- Boot Record 01 --
     04.54300s (init-network/config-disk_setup)
     01.51300s (modules-config/config-locale)
     01.18900s (modules-config/config-ssh-import-id)
     01.17000s (modules-config/config-grub-dpkg)
     01.00200s (azure-ds/waiting-for-ssh-public-key)
     00.60900s (init-network/config-users-groups)
     00.49500s (init-network/config-growpart)
     00.39700s (azure-ds/obtain-dhcp-lease)
     00.29400s (init-network/config-resizefs)
     00.19700s (azure-ds/invoke_agent)
     00.17700s (modules-config/config-apt-configure)
     00.17700s (init-network/config-ssh)
     00.17600s (modules-final/config-keys-to-console)
     00.12700s (init-network/config-mounts)
     00.06300s (modules-final/config-ssh-authkey-fingerprints)
     00.06100s (azure-ds/list_possible_azure_ds_devs)
     00.05300s (azure-ds/_has_ntfs_filesystem)
     00.04400s (azure-ds/crtfile_to_pubkey)
     00.03200s (azure-ds/_get_metadata_from_imds)
     00.02500s (init-network/check-cache)
     00.02200s (azure-ds/parse_network_config)
     00.02000s (azure-ds/parse_network_config)
     00.01100s (azure-ds/get_boot_telemetry)
     00.00800s (init-network/consume-user-data)
     00.00700s (azure-ds/check-platform-viability)
     00.00600s (init-network/config-set_hostname)
     00.00400s (modules-final/config-final-message)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/count_files)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Writing networking config: previous-network.out
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@40.79.42.61:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- sudo bash ./setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu xenial-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~16.04.1 [413 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~16.04.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~16.04.1) over (19.3-41-gc4735dd3-0ubuntu1~16.04.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~16.04.1) ...
Leaving 'diversion of /etc/init/ureadahead.conf to /etc/init/ureadahead.conf.disabled by cloud-init'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- sudo hostname SRU-didnt-work
sudo: unable to resolve host SRU-worked-azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- sudo rm -f /etc/network/interfaces.d/50-cloud-init.cfg
sudo: unable to resolve host SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- sudo cloud-init clean --logs --reboot
sudo: unable to resolve host SRU-didnt-work
Connection to 40.79.42.61 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- cloud-init status --wait --long

status: done
time: Thu, 23 Jan 2020 23:03:29 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- sudo systemd-analyze blame
sudo: unable to resolve host SRU-worked-azure
          2.167s cloud-config.service
          2.079s cloud-init.service
          1.745s cloud-init-local.service
          1.393s dev-sda1.device
          1.261s snapd.service
           996ms lxd-containers.service
           681ms cloud-final.service
           678ms accounts-daemon.service
           647ms apparmor.service
           599ms networking.service
           564ms ssh.service
           538ms grub-common.service
           530ms mdadm.service
           496ms lvm2-monitor.service
           456ms systemd-timesyncd.service
           363ms iscsid.service
           304ms console-setup.service
           302ms irqbalance.service
           291ms apport.service
           272ms polkitd.service
           270ms systemd-modules-load.service
           250ms open-iscsi.service
           247ms rc-local.service
           239ms systemd-udev-trigger.service
           205ms resolvconf.service
           186ms ufw.service
           183ms kmod-static-nodes.service
           182ms systemd-remount-fs.service
           177ms snapd.socket
           162ms systemd-journal-flush.service
           143ms keyboard-setup.service
           141ms systemd-logind.service
           135ms sys-kernel-debug.mount
           134ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
           116ms dev-mqueue.mount
           116ms ondemand.service
           110ms systemd-journald.service
           105ms lxd.socket
           105ms systemd-sysctl.service
            99ms systemd-update-utmp.service
            98ms rsyslog.service
            84ms systemd-udevd.service
            69ms systemd-tmpfiles-setup.service
            58ms dev-hugepages.mount
            51ms snapd.seeded.service
            49ms systemd-tmpfiles-setup-dev.service
            44ms plymouth-quit.service
            41ms plymouth-quit-wait.service
            40ms boot-efi.mount
            40ms systemd-random-seed.service
            40ms systemd-user-sessions.service
            28ms systemd-update-utmp-runlevel.service
            27ms sys-kernel-config.mount
            26ms sys-fs-fuse-connections.mount
            25ms plymouth-read-write.service
            24ms user@1000.service
            16ms ephemeral-disk-warning.service
            13ms setvtrgb.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03800s +00.00600s
|`->get_boot_telemetry @00.04400s +00.01100s
|`->get_system_info @00.05500s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.05500s +00.17300s
|`->load_azure_ds_dir @00.22800s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.23200s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.23300s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.25100s +00.21100s
|`->_get_metadata_from_imds @00.46200s +00.01100s
Finished stage: (azure-ds/get_metadata_from_imds) 00.24200 seconds

|`->_get_random_seed @00.49300s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.44600 seconds

|`->write_files @00.50200s +00.00200s
Finished stage: (azure-ds/_get_data) 00.46600 seconds

Finished stage: (init-local/search-Azure) 00.46900 seconds

|`->network config from fallback @00.57000s +00.01700s
Finished stage: (init-local) 00.60100 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @01.66300s +00.02500s
|`->network config from fallback @01.74800s +00.01900s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @01.77600s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

|`->invoke_agent @01.78000s +00.17100s
|`->wait for agents to retrieve SSH keys @01.95100s +00.00200s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @01.95300s +00.01900s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.02000 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 00.19700 seconds

Finished stage: (azure-ds/_negotiate) 00.19700 seconds

Finished stage: (azure-ds/setup) 00.19700 seconds

Finished stage: (init-network/setup-datasource) 00.19800 seconds

|`->reading and applying user-data @01.98900s +00.01600s
|`->reading and applying vendor-data @02.00800s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @02.07500s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @02.07600s +00.07400s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.07400 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.07500 seconds

Finished stage: (azure-ds/activate) 00.07500 seconds

Finished stage: (init-network/activate-datasource) 00.07800 seconds

|`->config-migrator ran successfully @02.18200s +00.00100s
|`->config-seed_random ran successfully @02.18500s +00.00300s
|`->config-bootcmd ran successfully @02.19000s +00.00000s
|`->config-write-files ran successfully @02.19100s +00.00200s
|`->config-growpart ran successfully @02.19500s +00.11500s
|`->config-resizefs ran successfully @02.31000s +00.02800s
|`->config-disk_setup ran successfully @02.33900s +00.26600s
|`->config-mounts ran successfully @02.60600s +00.20100s
|`->config-set_hostname ran successfully @02.80700s +00.01500s
|`->config-update_hostname ran successfully @02.82300s +00.00200s
|`->config-update_etc_hosts ran successfully @02.82500s +00.00500s
|`->config-ca-certs ran successfully @02.83000s +00.00100s
|`->config-rsyslog ran successfully @02.83100s +00.00100s
|`->config-users-groups ran successfully @02.83300s +00.06800s
|`->config-ssh ran successfully @02.90200s +00.31200s
Finished stage: (init-network) 01.56500 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @06.25700s +00.00100s
|`->config-snap ran successfully @06.25800s +00.00100s
|`->config-ssh-import-id ran successfully @06.26000s +00.61800s
|`->config-locale ran successfully @06.87900s +00.00700s
|`->config-set-passwords ran successfully @06.88600s +00.00200s
|`->config-grub-dpkg ran successfully @06.90400s +00.36500s
|`->config-apt-pipelining ran successfully @07.27000s +00.00200s
|`->config-apt-configure ran successfully @07.27200s +00.10400s
|`->config-ubuntu-advantage ran successfully @07.37600s +00.00100s
|`->config-ntp ran successfully @07.37800s +00.00100s
|`->config-timezone ran successfully @07.37900s +00.00100s
|`->config-disable-ec2-metadata ran successfully @07.38000s +00.00100s
|`->config-runcmd ran successfully @07.38100s +00.00100s
|`->config-byobu ran successfully @07.38300s +00.00000s
Finished stage: (modules-config) 01.14300 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @07.94700s +00.00100s
|`->config-fan ran successfully @07.94900s +00.00100s
|`->config-landscape ran successfully @07.95000s +00.00100s
|`->config-lxd ran successfully @07.95100s +00.00100s
|`->config-ubuntu-drivers ran successfully @07.95300s +00.00000s
|`->config-puppet ran successfully @07.95400s +00.00100s
|`->config-chef ran successfully @07.95500s +00.00100s
|`->config-mcollective ran successfully @07.95600s +00.00100s
|`->config-salt-minion ran successfully @07.95800s +00.00100s
|`->config-rightscale_userdata ran successfully @07.95900s +00.00100s
|`->config-scripts-vendor ran successfully @07.96000s +00.00100s
|`->config-scripts-per-once ran successfully @07.96200s +00.00000s
|`->config-scripts-per-boot ran successfully @07.96300s +00.00000s
|`->config-scripts-per-instance ran successfully @07.96400s +00.00000s
|`->config-scripts-user ran successfully @07.96500s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @07.96600s +00.05900s
|`->config-keys-to-console ran successfully @08.02500s +00.08700s
|`->config-phone-home ran successfully @08.11300s +00.00100s
|`->config-final-message ran successfully @08.11500s +00.00500s
|`->config-power-state-change ran successfully @08.12000s +00.00100s
Finished stage: (modules-final) 00.19300 seconds

Total Time: 6.24800 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- cloud-init analyze blame
-- Boot Record 01 --
     00.61800s (modules-config/config-ssh-import-id)
     00.36500s (modules-config/config-grub-dpkg)
     00.31200s (init-network/config-ssh)
     00.26600s (init-network/config-disk_setup)
     00.21100s (azure-ds/obtain-dhcp-lease)
     00.20100s (init-network/config-mounts)
     00.17300s (azure-ds/list_possible_azure_ds_devs)
     00.17100s (azure-ds/invoke_agent)
     00.11500s (init-network/config-growpart)
     00.10400s (modules-config/config-apt-configure)
     00.08700s (modules-final/config-keys-to-console)
     00.07400s (azure-ds/_has_ntfs_filesystem)
     00.06800s (init-network/config-users-groups)
     00.05900s (modules-final/config-ssh-authkey-fingerprints)
     00.02800s (init-network/config-resizefs)
     00.02500s (init-network/check-cache)
     00.01900s (azure-ds/parse_network_config)
     00.01900s (azure-ds/crtfile_to_pubkey)
     00.01700s (azure-ds/parse_network_config)
     00.01600s (init-network/consume-user-data)
     00.01500s (init-network/config-set_hostname)
     00.01100s (azure-ds/get_boot_telemetry)
     00.01100s (azure-ds/_get_metadata_from_imds)
     00.00700s (modules-config/config-locale)
     00.00600s (azure-ds/check-platform-viability)
     00.00500s (modules-final/config-final-message)
     00.00500s (init-network/config-update_etc_hosts)
     00.00300s (init-network/config-seed_random)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-write-files)
     00.00200s (init-network/config-update_hostname)
     00.00200s (azure-ds/write_files)
     00.00200s (azure-ds/waiting-for-ssh-public-key)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-ubuntu-drivers)
     00.00000s (modules-final/config-scripts-per-once)
     00.00000s (modules-final/config-scripts-per-instance)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-byobu)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade write network config: upgrade-network.out
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- grep DHCP /var/log/syslog
+ echo ------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
------- Diff previous-network to post-upgrade-network ------
--- previous-network.out	2020-01-23 23:02:22.141614259 +0000
+++ upgrade-network.out	2020-01-23 23:04:04.095139241 +0000
@@ -40,3 +40,14 @@
 Jan 23 23:01:31 SRU-worked-azure ifup[918]: DHCPOFFER of 10.0.0.4 from 168.63.129.16
 Jan 23 23:01:31 SRU-worked-azure dhclient[1014]: DHCPACK of 10.0.0.4 from 168.63.129.16
 Jan 23 23:01:31 SRU-worked-azure ifup[918]: DHCPACK of 10.0.0.4 from 168.63.129.16
+Jan 23 23:03:24 SRU-worked-azure dhclient[870]: Internet Systems Consortium DHCP Client 4.3.3
+Jan 23 23:03:24 SRU-worked-azure dhclient[870]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0xc738066b)
+Jan 23 23:03:24 SRU-worked-azure dhclient[870]: DHCPREQUEST of 10.0.0.4 on eth0 to 255.255.255.255 port 67 (xid=0x6b0638c7)
+Jan 23 23:03:24 SRU-worked-azure dhclient[870]: DHCPOFFER of 10.0.0.4 from 168.63.129.16
+Jan 23 23:03:24 SRU-worked-azure dhclient[870]: DHCPACK of 10.0.0.4 from 168.63.129.16
+Jan 23 23:03:24 SRU-worked-azure dhclient[1012]: Internet Systems Consortium DHCP Client 4.3.3
+Jan 23 23:03:24 SRU-worked-azure ifup[917]: Internet Systems Consortium DHCP Client 4.3.3
+Jan 23 23:03:24 SRU-worked-azure dhclient[1012]: DHCPREQUEST of 10.0.0.4 on eth0 to 255.255.255.255 port 67 (xid=0x5c4f755b)
+Jan 23 23:03:24 SRU-worked-azure ifup[917]: DHCPREQUEST of 10.0.0.4 on eth0 to 255.255.255.255 port 67 (xid=0x5c4f755b)
+Jan 23 23:03:24 SRU-worked-azure dhclient[1012]: DHCPACK of 10.0.0.4 from 168.63.129.16
+Jan 23 23:03:24 SRU-worked-azure ifup[917]: DHCPACK of 10.0.0.4 from 168.63.129.16
+ echo ------- Diff previous-network to post-upgrade-network ------
------- Diff previous-network to post-upgrade-network ------
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/nullGet cloud-id
 -o LogLevel=ERROR ubuntu@40.79.42.61 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERRORValidating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
 ubuntu@40.79.42.61 -- sudo reboot
sudo: unable to resolve host SRU-worked-azure
Connection to 40.79.42.61 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- cloud-init status --wait --long

status: done
time: Thu, 23 Jan 2020 23:04:38 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.79.42.61 -- grep 'Update datasource' /var/log/cloud-init.logAfter reboot

2020-01-23 23:03:21,076 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-23 23:04:29,727 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-23 23:04:30,281 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ [  = --nics sruNic-xenial sruNic2-xenial --size Standard_DS2_v2 ]
+ [ true = false ]
+ echo Creating advanced network vm
+ name=test-sru-xenial-advanced
Creating advanced network vm
+ az network public-ip create --name vmPublicIP-IPv4-xenial --resource-group srugroup --location eastus2 --sku BASIC --allocation-method dynamic --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"a47decd6-3039-475f-8d27-d540910ac16c\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/vmPublicIP-IPv4-xenial",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "vmPublicIP-IPv4-xenial",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroup",
    "resourceGuid": "e92d0d8d-1767-4973-ad9f-493006d2cbad",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name lbPublicIP_v4_xenial --resource-group srugroup --location eastus2 --sku BASIC --allocation-method dynamic --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"ba25b0f6-4737-486b-b880-75c63ba46039\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v4_xenial",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "lbPublicIP_v4_xenial",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroup",
    "resourceGuid": "c59f30e0-4e87-41bb-a074-e215329f129f",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name lbPublicIP_v6_xenial --resource-group srugroup --location eastus2 --sku BASIC --allocation-method dynamic --version IPv6
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"b0ed9ca2-e01e-44f0-a739-1b0e5ce0afbb\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v6_xenial",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "lbPublicIP_v6_xenial",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv6",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroup",
    "resourceGuid": "b2ee7f01-7634-47c1-92d6-4775d547000b",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network lb create --name dsLB_xenial --resource-group srugroup --sku Basic --location eastus2 --frontend-ip-name dsLbFrontEnd_v4_xenial --public-ip-address lbPublicIP_v4_xenial --backend-pool-name dsLbBackEndPool_v4_xenial
{
  "loadBalancer": {
    "backendAddressPools": [
      {
        "etag": "W/\"37d6a8b5-ee56-4ced-b113-535f466b5f52\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/backendAddressPools/dsLbBackEndPool_v4_xenial",
        "name": "dsLbBackEndPool_v4_xenial",
        "properties": {
          "provisioningState": "Succeeded"
        },
        "resourceGroup": "srugroup",
        "type": "Microsoft.Network/loadBalancers/backendAddressPools"
      }
    ],
    "frontendIPConfigurations": [
      {
        "etag": "W/\"37d6a8b5-ee56-4ced-b113-535f466b5f52\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/frontendIPConfigurations/dsLbFrontEnd_v4_xenial",
        "name": "dsLbFrontEnd_v4_xenial",
        "properties": {
          "privateIPAddressVersion": "IPv4",
          "privateIPAllocationMethod": "Dynamic",
          "provisioningState": "Succeeded",
          "publicIPAddress": {
            "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v4_xenial",
            "resourceGroup": "srugroup"
          }
        },
        "resourceGroup": "srugroup",
        "type": "Microsoft.Network/loadBalancers/frontendIPConfigurations"
      }
    ],
    "inboundNatPools": [],
    "inboundNatRules": [],
    "loadBalancingRules": [],
    "probes": [],
    "provisioningState": "Succeeded",
    "resourceGuid": "13cefc64-b02e-4042-a257-afef3681a3b3"
  }
}
+ az network lb frontend-ip create --lb-name dsLB_xenial --name dsLbFrontEnd_v6_xenial --resource-group srugroup --public-ip-address lbPublicIP_v6_xenial
{
  "etag": "W/\"00d05273-967b-4556-ad35-9e21d90faea0\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/frontendIPConfigurations/dsLbFrontEnd_v6_xenial",
  "inboundNatPools": null,
  "inboundNatRules": null,
  "loadBalancingRules": null,
  "name": "dsLbFrontEnd_v6_xenial",
  "outboundRules": null,
  "privateIpAddress": null,
  "privateIpAddressVersion": "IPv4",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v6_xenial",
    "idleTimeoutInMinutes": null,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": null,
    "location": null,
    "name": null,
    "provisioningState": null,
    "publicIpAddressVersion": null,
    "publicIpAllocationMethod": null,
    "publicIpPrefix": null,
    "resourceGroup": "srugroup",
    "resourceGuid": null,
    "sku": null,
    "tags": null,
    "type": null,
    "zones": null
  },
  "publicIpPrefix": null,
  "resourceGroup": "srugroup",
  "subnet": null,
  "type": "Microsoft.Network/loadBalancers/frontendIPConfigurations",
  "zones": null
}
+ az network lb address-pool create --lb-name dsLB_xenial --name dsLbBackEndPool_v6_xenial --resource-group srugroup
{
  "backendIpConfigurations": null,
  "etag": "W/\"9a437826-351c-4896-8c73-f64c50375e21\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/backendAddressPools/dsLbBackEndPool_v6_xenial",
  "loadBalancingRules": null,
  "name": "dsLbBackEndPool_v6_xenial",
  "outboundRule": null,
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroup",
  "type": "Microsoft.Network/loadBalancers/backendAddressPools"
}
+ az network lb probe create -g srugroup --lb-name dsLB_xenial -n dsProbe_xenial --protocol tcp --port 22
{
  "etag": "W/\"6852b6f8-2f4a-412d-95fa-ca52502d6723\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/probes/dsProbe_xenial",
  "intervalInSeconds": 15,
  "loadBalancingRules": null,
  "name": "dsProbe_xenial",
  "numberOfProbes": 2,
  "port": 22,
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "requestPath": null,
  "resourceGroup": "srugroup",
  "type": "Microsoft.Network/loadBalancers/probes"
}
+ az network lb rule create --lb-name dsLB_xenial --name dsLBrule_v4_xenial --resource-group srugroup --frontend-ip-name dsLbFrontEnd_v4_xenial --protocol Tcp --frontend-port 22 --backend-port 22 --probe-name dsProbe_xenial --backend-pool-name dsLbBackEndPool_v4_xenial
{
  "backendAddressPool": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/backendAddressPools/dsLbBackEndPool_v4_xenial",
    "resourceGroup": "srugroup"
  },
  "backendPort": 22,
  "disableOutboundSnat": null,
  "enableFloatingIp": false,
  "enableTcpReset": false,
  "etag": "W/\"8ccc4b08-63c7-4980-ac84-e42a931212f8\"",
  "frontendIpConfiguration": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/frontendIPConfigurations/dsLbFrontEnd_v4_xenial",
    "resourceGroup": "srugroup"
  },
  "frontendPort": 22,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/loadBalancingRules/dsLBrule_v4_xenial",
  "idleTimeoutInMinutes": 4,
  "loadDistribution": "Default",
  "name": "dsLBrule_v4_xenial",
  "probe": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/probes/dsProbe_xenial",
    "resourceGroup": "srugroup"
  },
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroup",
  "type": "Microsoft.Network/loadBalancers/loadBalancingRules"
}
+ az network lb rule create --lb-name dsLB_xenial --name dsLBrule_v6_xenial --resource-group srugroup --frontend-ip-name dsLbFrontEnd_v6_xenial --protocol Tcp --frontend-port 22 --backend-port 22 --probe-name dsProbe_xenial --backend-pool-name dsLbBackEndPool_v6_xenial
{
  "backendAddressPool": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/backendAddressPools/dsLbBackEndPool_v6_xenial",
    "resourceGroup": "srugroup"
  },
  "backendPort": 22,
  "disableOutboundSnat": null,
  "enableFloatingIp": false,
  "enableTcpReset": false,
  "etag": "W/\"16c6d542-6539-4837-adee-f295c5381d57\"",
  "frontendIpConfiguration": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/frontendIPConfigurations/dsLbFrontEnd_v6_xenial",
    "resourceGroup": "srugroup"
  },
  "frontendPort": 22,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/loadBalancingRules/dsLBrule_v6_xenial",
  "idleTimeoutInMinutes": 4,
  "loadDistribution": "Default",
  "name": "dsLBrule_v6_xenial",
  "probe": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/probes/dsProbe_xenial",
    "resourceGroup": "srugroup"
  },
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroup",
  "type": "Microsoft.Network/loadBalancers/loadBalancingRules"
}
+ az vm availability-set create --name dsAVset_xenial --resource-group srugroup --location eastus2 --platform-fault-domain-count 2 --platform-update-domain-count 2
{
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Compute/availabilitySets/dsAVset_xenial",
  "location": "eastus2",
  "name": "dsAVset_xenial",
  "platformFaultDomainCount": 2,
  "platformUpdateDomainCount": 2,
  "proximityPlacementGroup": null,
  "resourceGroup": "srugroup",
  "sku": {
    "capacity": null,
    "name": "Aligned",
    "tier": null
  },
  "statuses": null,
  "tags": {},
  "type": "Microsoft.Compute/availabilitySets",
  "virtualMachines": []
}
+ az network nic create --name sruNic-xenial --resource-group srugroup --network-security-group sruNetSecGroup --vnet-name sruVnet --accelerated-networking true --subnet sruSubnet --private-ip-address-version IPv4 --lb-address-pools dsLbBackEndPool_v4_xenial --lb-name dsLB_xenial --public-ip-address vmPublicIP-IPv4-xenial
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "uf3fodizdaiezen3rqv3vvb4xd.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"038c3e03-82ac-4ef9-b1a8-e7bff5b21bb8\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic-xenial",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"038c3e03-82ac-4ef9-b1a8-e7bff5b21bb8\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic-xenial/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": [
          {
            "backendIpConfigurations": null,
            "etag": null,
            "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/backendAddressPools/dsLbBackEndPool_v4_xenial",
            "loadBalancingRules": null,
            "name": null,
            "outboundRule": null,
            "provisioningState": null,
            "resourceGroup": "srugroup"
          }
        ],
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "10.0.0.5",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": {
          "ddosSettings": null,
          "dnsSettings": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/vmPublicIP-IPv4-xenial",
          "idleTimeoutInMinutes": null,
          "ipAddress": null,
          "ipConfiguration": null,
          "ipTags": null,
          "location": null,
          "name": null,
          "provisioningState": null,
          "publicIpAddressVersion": null,
          "publicIpAllocationMethod": null,
          "publicIpPrefix": null,
          "resourceGroup": "srugroup",
          "resourceGuid": null,
          "sku": null,
          "tags": null,
          "type": null,
          "zones": null
        },
        "resourceGroup": "srugroup",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroup",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic-xenial",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroup",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroup",
    "resourceGuid": "75fdc60d-d9c3-4f18-b8c1-77d54d2d7b6e",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic create --name sruNic2-xenial --resource-group srugroup --network-security-group sruNetSecGroup --vnet-name sruVnet --accelerated-networking true --subnet sruSubnet --private-ip-address-version IPv4
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "uf3fodizdaiezen3rqv3vvb4xd.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"f60d39b7-f872-49b1-aa03-8e716e60b817\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic2-xenial",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"f60d39b7-f872-49b1-aa03-8e716e60b817\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic2-xenial/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "10.0.0.6",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": null,
        "resourceGroup": "srugroup",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroup",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic2-xenial",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroup",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroup",
    "resourceGuid": "eecd5a8c-e8d1-4dca-bc7b-c7a000e44e85",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic ip-config create --name sruNic-xenial-v6 --nic-name sruNic-xenial --resource-group srugroup --vnet-name sruVnet --subnet sruSubnet --lb-address-pools dsLbBackEndPool_v6_xenial --lb-name dsLB_xenial --private-ip-address-version IPv6
{
  "applicationGatewayBackendAddressPools": null,
  "applicationSecurityGroups": null,
  "etag": "W/\"b320d73f-439f-4f4e-ac34-93bc32c27c63\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic-xenial/ipConfigurations/sruNic-xenial-v6",
  "loadBalancerBackendAddressPools": [
    {
      "backendIpConfigurations": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_xenial/backendAddressPools/dsLbBackEndPool_v6_xenial",
      "loadBalancingRules": null,
      "name": null,
      "outboundRule": null,
      "provisioningState": null,
      "resourceGroup": "srugroup"
    }
  ],
  "loadBalancerInboundNatRules": null,
  "name": "sruNic-xenial-v6",
  "primary": null,
  "privateIpAddress": "ace:cab:deca:deed::4",
  "privateIpAddressVersion": "IPv6",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": null,
  "resourceGroup": "srugroup",
  "subnet": {
    "addressPrefix": null,
    "addressPrefixes": null,
    "delegations": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
    "ipConfigurationProfiles": null,
    "ipConfigurations": null,
    "name": null,
    "natGateway": null,
    "networkSecurityGroup": null,
    "privateEndpointNetworkPolicies": null,
    "privateEndpoints": null,
    "privateLinkServiceNetworkPolicies": null,
    "provisioningState": null,
    "purpose": null,
    "resourceGroup": "srugroup",
    "resourceNavigationLinks": null,
    "routeTable": null,
    "serviceAssociationLinks": null,
    "serviceEndpointPolicies": null,
    "serviceEndpoints": null
  },
  "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
  "virtualNetworkTaps": null
}
+ az vm create --name=test-sru-xenial-advanced --image=Canonical:UbuntuServer:16.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroup --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml --nics sruNic-xenial sruNic2-xenial --size Standard_DS2_v2
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Compute/virtualMachines/test-sru-xenial-advanced",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7C-55-EE,00-0D-3A-7C-5D-9F",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.5,ace:cab:deca:deed::4,10.0.0.6",
  "publicIpAddress": "52.167.153.97",
  "resourceGroup": "srugroup",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-xenial-advanced
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.167.153.97
+ echo Created test-sru-xenial-advanced: ubuntu@ubuntu@52.167.153.97
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- cloud-init statusCreated test-sru-xenial-advanced: ubuntu@ubuntu@52.167.153.97
 --wait --long

status: done
time: Thu, 23 Jan 2020 23:15:20 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- dpkg-query --show cloud-init
cloud-init	19.3-41-gc4735dd3-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- systemd-analyze
Startup finished in 7.276s (kernel) + 26.756s (userspace) = 34.033s
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- systemd-analyze blame
          5.802s cloud-init.service
          4.494s networking.service
          3.995s cloud-init-local.service
          3.895s cloud-config.service
          2.574s pollinate.service
          2.541s snapd.service
          2.083s lxd-containers.service
          2.049s snapd.seeded.service
          2.035s dev-sda1.device
          1.326s accounts-daemon.service
           934ms apparmor.service
           934ms mdadm.service
           704ms grub-common.service
           685ms lvm2-monitor.service
           648ms cloud-final.service
           557ms iscsid.service
           517ms open-iscsi.service
           451ms systemd-logind.service
           432ms rsyslog.service
           401ms systemd-modules-load.service
           383ms rc-local.service
           321ms systemd-tmpfiles-setup-dev.service
           317ms console-setup.service
           244ms systemd-timesyncd.service
           185ms systemd-journal-flush.service
           158ms irqbalance.service
           151ms systemd-journald.service
           149ms resolvconf.service
           145ms polkitd.service
           126ms keyboard-setup.service
           115ms apport.service
           111ms ssh.service
           107ms systemd-udev-trigger.service
           106ms systemd-udevd.service
           105ms systemd-random-seed.service
            80ms systemd-update-utmp.service
            68ms systemd-remount-fs.service
            67ms systemd-machine-id-commit.service
            64ms kmod-static-nodes.service
            63ms plymouth-read-write.service
            53ms systemd-sysctl.service
            50ms lxd.socket
            45ms ufw.service
            44ms dev-mqueue.mount
            34ms setvtrgb.service
            33ms ondemand.service
            27ms sys-kernel-config.mount
            25ms boot-efi.mount
            25ms dev-hugepages.mount
            23ms snapd.socket
            23ms systemd-tmpfiles-setup.service
            21ms plymouth-quit.service
            21ms sys-kernel-debug.mount
            18ms user@1000.service
            18ms systemd-user-sessions.service
            13ms ephemeral-disk-warning.service
             9ms sys-fs-fuse-connections.mount
             8ms plymouth-quit-wait.service
             5ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.14800s +00.00900s
|`->get_boot_telemetry @00.15700s +00.00900s
|`->get_system_info @00.16600s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.16700s +00.05400s
|`->load_azure_ds_dir @00.22100s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.36700s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.36800s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00800 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.43200s +00.40000s
|`->_get_metadata_from_imds @00.83200s +00.07700s
Finished stage: (azure-ds/get_metadata_from_imds) 00.51700 seconds

|`->_get_random_seed @00.94900s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.78900 seconds

|`->write_files @00.95700s +00.00300s
Finished stage: (azure-ds/_get_data) 00.81200 seconds

Finished stage: (init-local/search-Azure) 00.81600 seconds

|`->network config from fallback @01.02500s +00.01400s
Finished stage: (init-local) 01.05500 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @05.94100s +00.02500s
|`->network config from fallback @06.02300s +00.02000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @06.05400s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

|`->invoke_agent @06.05700s +00.16400s
|`->wait for agents to retrieve ssh keys @06.22100s +01.00400s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @07.22500s +00.05100s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.05100 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 01.22200 seconds

Finished stage: (azure-ds/_negotiate) 01.22300 seconds

Finished stage: (azure-ds/setup) 01.22400 seconds

Finished stage: (init-network/setup-datasource) 01.22500 seconds

|`->reading and applying user-data @07.28800s +00.00700s
|`->reading and applying vendor-data @07.29600s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @07.32700s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @07.32800s +00.05100s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.44700s +00.00200s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.09100 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.14300 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.14500 seconds

Finished stage: (azure-ds/activate) 00.14500 seconds

Finished stage: (init-network/activate-datasource) 00.14700 seconds

|`->config-migrator ran successfully @07.53800s +00.00100s
|`->config-seed_random ran successfully @07.53900s +00.00200s
|`->config-bootcmd ran successfully @07.54100s +00.00000s
|`->config-write-files ran successfully @07.54200s +00.00100s
|`->config-growpart ran successfully @07.54300s +00.43500s
|`->config-resizefs ran successfully @07.97900s +00.24600s
|`->config-disk_setup ran successfully @08.22600s +02.43800s
|`->config-mounts ran successfully @10.66500s +00.08300s
|`->config-set_hostname ran successfully @10.74900s +00.00600s
|`->config-update_hostname ran successfully @10.75600s +00.00100s
|`->config-update_etc_hosts ran successfully @10.75800s +00.00000s
|`->config-ca-certs ran successfully @10.75800s +00.00100s
|`->config-rsyslog ran successfully @10.76000s +00.00100s
|`->config-users-groups ran successfully @10.76100s +00.35500s
|`->config-ssh ran successfully @11.11700s +00.25400s
Finished stage: (init-network) 05.44400 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @16.96400s +00.00000s
|`->config-snap ran successfully @16.96500s +00.00100s
|`->config-snap_config ran successfully @16.96600s +00.00100s
|`->config-ssh-import-id ran successfully @16.96800s +00.83600s
|`->config-locale ran successfully @17.80500s +01.29100s
|`->config-set-passwords ran successfully @19.09800s +00.00200s
|`->config-grub-dpkg ran successfully @19.10000s +00.92800s
|`->config-apt-pipelining ran successfully @20.02900s +00.00200s
|`->config-apt-configure ran successfully @20.03200s +00.23500s
|`->config-ubuntu-advantage ran successfully @20.26700s +00.00100s
|`->config-ntp ran successfully @20.26900s +00.00100s
|`->config-timezone ran successfully @20.27000s +00.00100s
|`->config-disable-ec2-metadata ran successfully @20.27100s +00.00100s
|`->config-runcmd ran successfully @20.27200s +00.00100s
|`->config-byobu ran successfully @20.27300s +00.00100s
Finished stage: (modules-config) 03.34300 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @20.73100s +00.00200s
|`->config-package-update-upgrade-install ran successfully @20.73300s +00.00100s
|`->config-fan ran successfully @20.73500s +00.00100s
|`->config-landscape ran successfully @20.73600s +00.00100s
|`->config-lxd ran successfully @20.73700s +00.00100s
|`->config-ubuntu-drivers ran successfully @20.73900s +00.00000s
|`->config-puppet ran successfully @20.74000s +00.00100s
|`->config-chef ran successfully @20.74100s +00.00100s
|`->config-mcollective ran successfully @20.74200s +00.00100s
|`->config-salt-minion ran successfully @20.74400s +00.00100s
|`->config-rightscale_userdata ran successfully @20.74500s +00.00100s
|`->config-scripts-vendor ran successfully @20.74600s +00.00100s
|`->config-scripts-per-once ran successfully @20.74700s +00.00100s
|`->config-scripts-per-boot ran successfully @20.74900s +00.00000s
|`->config-scripts-per-instance ran successfully @20.74900s +00.00100s
|`->config-scripts-user ran successfully @20.75100s +00.00000s
|`->config-ssh-authkey-fingerprints ran successfully @20.75200s +00.02100s
|`->config-keys-to-console ran successfully @20.77300s +00.13400s
|`->config-phone-home ran successfully @20.90800s +00.00200s
|`->config-final-message ran successfully @20.91000s +00.00500s
|`->config-power-state-change ran successfully @20.91500s +00.00200s
Finished stage: (modules-final) 00.22300 seconds

Total Time: 18.63000 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- cloud-init analyze blame
-- Boot Record 01 --
     02.43800s (init-network/config-disk_setup)
     01.29100s (modules-config/config-locale)
     01.00400s (azure-ds/waiting-for-ssh-public-key)
     00.92800s (modules-config/config-grub-dpkg)
     00.83600s (modules-config/config-ssh-import-id)
     00.43500s (init-network/config-growpart)
     00.40000s (azure-ds/obtain-dhcp-lease)
     00.35500s (init-network/config-users-groups)
     00.25400s (init-network/config-ssh)
     00.24600s (init-network/config-resizefs)
     00.23500s (modules-config/config-apt-configure)
     00.16400s (azure-ds/invoke_agent)
     00.13400s (modules-final/config-keys-to-console)
     00.08300s (init-network/config-mounts)
     00.07700s (azure-ds/_get_metadata_from_imds)
     00.05400s (azure-ds/list_possible_azure_ds_devs)
     00.05100s (azure-ds/crtfile_to_pubkey)
     00.05100s (azure-ds/_has_ntfs_filesystem)
     00.02500s (init-network/check-cache)
     00.02100s (modules-final/config-ssh-authkey-fingerprints)
     00.02000s (azure-ds/parse_network_config)
     00.01400s (azure-ds/parse_network_config)
     00.00900s (azure-ds/get_boot_telemetry)
     00.00900s (azure-ds/check-platform-viability)
     00.00700s (init-network/consume-user-data)
     00.00600s (init-network/config-set_hostname)
     00.00500s (modules-final/config-final-message)
     00.00300s (azure-ds/write_files)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-final/config-power-state-change)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-seed_random)
     00.00200s (azure-ds/count_files)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/get_system_info)
     00.00000s (modules-final/config-ubuntu-drivers)
     00.00000s (modules-final/config-scripts-user)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Writing networking config: previous-network.out
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@52.167.153.97:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 --+  sudo bash ./setup_proposed.sh
egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu xenial-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~16.04.1 [413 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~16.04.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~16.04.1) over (19.3-41-gc4735dd3-0ubuntu1~16.04.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~16.04.1) ...
Leaving 'diversion of /etc/init/ureadahead.conf to /etc/init/ureadahead.conf.disabled by cloud-init'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- sudo hostname SRU-didnt-work
sudo: unable to resolve host SRU-worked-azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- sudo rm -f /etc/network/interfaces.d/50-cloud-init.cfg
sudo: unable to resolve host SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- sudo cloud-init clean --logs --reboot
sudo: unable to resolve host SRU-didnt-work
Connection to 52.167.153.97 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- cloud-init status --wait --long

status: done
time: Thu, 23 Jan 2020 23:17:15 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- sudo systemd-analyze blame
sudo: unable to resolve host SRU-worked-azure
          5.137s cloud-init-local.service
          3.518s networking.service
          1.758s cloud-init.service
          1.562s cloud-config.service
           978ms dev-sda1.device
           707ms grub-common.service
           650ms cloud-final.service
           520ms snapd.service
           487ms iscsid.service
           452ms accounts-daemon.service
           449ms lvm2-monitor.service
           404ms mdadm.service
           329ms rsyslog.service
           329ms lxd-containers.service
           308ms apparmor.service
           196ms systemd-timesyncd.service
           159ms systemd-logind.service
           157ms kmod-static-nodes.service
           154ms console-setup.service
           153ms ufw.service
           153ms ondemand.service
           153ms resolvconf.service
           150ms systemd-modules-load.service
           150ms keyboard-setup.service
           145ms systemd-remount-fs.service
           142ms snapd.socket
           140ms polkitd.service
           124ms dev-hugepages.mount
           122ms lxd.socket
           117ms sys-kernel-debug.mount
           109ms open-iscsi.service
            96ms ssh.service
            94ms systemd-udev-trigger.service
            82ms systemd-update-utmp.service
            79ms irqbalance.service
            75ms dev-mqueue.mount
            73ms rc-local.service
            65ms systemd-journald.service
            63ms systemd-tmpfiles-setup.service
            61ms apport.service
            52ms systemd-journal-flush.service
            40ms systemd-random-seed.service
            34ms systemd-sysctl.service
            34ms setvtrgb.service
            31ms systemd-tmpfiles-setup-dev.service
            28ms systemd-udevd.service
            27ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            26ms plymouth-quit.service
            22ms snapd.seeded.service
            20ms systemd-user-sessions.service
            20ms sys-fs-fuse-connections.mount
            19ms user@1000.service
            16ms sys-kernel-config.mount
            12ms plymouth-read-write.service
            12ms boot-efi.mount
            10ms ephemeral-disk-warning.service
             7ms systemd-update-utmp-runlevel.service
             5ms plymouth-quit-wait.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03700s +00.00900s
|`->get_boot_telemetry @00.04600s +00.01000s
|`->get_system_info @00.05600s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.05600s +00.23900s
|`->load_azure_ds_dir @00.29500s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.29900s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.29900s +00.00100s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.43800s +03.80000s
|`->_get_metadata_from_imds @04.23800s +00.01100s
Finished stage: (azure-ds/get_metadata_from_imds) 03.84900 seconds

|`->_get_random_seed @04.28600s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 04.23900 seconds

|`->write_files @04.29500s +00.00300s
Finished stage: (azure-ds/_get_data) 04.26100 seconds

Finished stage: (init-local/search-Azure) 04.26500 seconds

|`->network config from fallback @04.36300s +00.01800s
Finished stage: (init-local) 04.39700 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @08.31700s +00.02500s
|`->network config from fallback @08.39900s +00.02700s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @08.43700s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

|`->invoke_agent @08.44000s +00.20000s
|`->wait for agents to retrieve SSH keys @08.64100s +00.00500s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @08.64600s +00.01100s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.01100 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 00.22000 seconds

Finished stage: (azure-ds/_negotiate) 00.22100 seconds

Finished stage: (azure-ds/setup) 00.22100 seconds

Finished stage: (init-network/setup-datasource) 00.22100 seconds

|`->reading and applying user-data @08.66500s +00.01000s
|`->reading and applying vendor-data @08.67500s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @08.70500s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @08.70500s +00.10500s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.10500 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.10800 seconds

Finished stage: (azure-ds/activate) 00.10800 seconds

Finished stage: (init-network/activate-datasource) 00.12300 seconds

|`->config-migrator ran successfully @08.84800s +00.00100s
|`->config-seed_random ran successfully @08.84900s +00.00100s
|`->config-bootcmd ran successfully @08.85100s +00.00000s
|`->config-write-files ran successfully @08.85100s +00.00100s
|`->config-growpart ran successfully @08.85200s +00.03600s
|`->config-resizefs ran successfully @08.88800s +00.01600s
|`->config-disk_setup ran successfully @08.90400s +00.12300s
|`->config-mounts ran successfully @09.02700s +00.10100s
|`->config-set_hostname ran successfully @09.12800s +00.00800s
|`->config-update_hostname ran successfully @09.13700s +00.00100s
|`->config-update_etc_hosts ran successfully @09.13800s +00.00000s
|`->config-ca-certs ran successfully @09.13900s +00.00000s
|`->config-rsyslog ran successfully @09.14000s +00.00100s
|`->config-users-groups ran successfully @09.14100s +00.19100s
|`->config-ssh ran successfully @09.33300s +00.23100s
Finished stage: (init-network) 01.26000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @11.52500s +00.00100s
|`->config-snap ran successfully @11.52600s +00.00100s
|`->config-ssh-import-id ran successfully @11.52800s +00.67800s
|`->config-locale ran successfully @12.20700s +00.00200s
|`->config-set-passwords ran successfully @12.20900s +00.00200s
|`->config-grub-dpkg ran successfully @12.21100s +00.34300s
|`->config-apt-pipelining ran successfully @12.55500s +00.00200s
|`->config-apt-configure ran successfully @12.55700s +00.09600s
|`->config-ubuntu-advantage ran successfully @12.65400s +00.00100s
|`->config-ntp ran successfully @12.65600s +00.00100s
|`->config-timezone ran successfully @12.65700s +00.00100s
|`->config-disable-ec2-metadata ran successfully @12.65800s +00.00100s
|`->config-runcmd ran successfully @12.65900s +00.00100s
|`->config-byobu ran successfully @12.66000s +00.00100s
Finished stage: (modules-config) 01.15200 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @13.15300s +00.00200s
|`->config-fan ran successfully @13.15500s +00.00100s
|`->config-landscape ran successfully @13.15700s +00.00100s
|`->config-lxd ran successfully @13.15800s +00.00100s
|`->config-ubuntu-drivers ran successfully @13.15900s +00.00100s
|`->config-puppet ran successfully @13.16000s +00.00100s
|`->config-chef ran successfully @13.16200s +00.00100s
|`->config-mcollective ran successfully @13.16300s +00.00100s
|`->config-salt-minion ran successfully @13.16400s +00.00100s
|`->config-rightscale_userdata ran successfully @13.16600s +00.00100s
|`->config-scripts-vendor ran successfully @13.16700s +00.00100s
|`->config-scripts-per-once ran successfully @13.16800s +00.00100s
|`->config-scripts-per-boot ran successfully @13.16900s +00.00100s
|`->config-scripts-per-instance ran successfully @13.17000s +00.00100s
|`->config-scripts-user ran successfully @13.17100s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @13.17300s +00.06700s
|`->config-keys-to-console ran successfully @13.24000s +00.10500s
|`->config-phone-home ran successfully @13.34600s +00.00200s
|`->config-final-message ran successfully @13.34800s +00.00500s
|`->config-power-state-change ran successfully @13.35300s +00.00100s
Finished stage: (modules-final) 00.22800 seconds

Total Time: 25.00000 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- cloud-init analyze blame
-- Boot Record 01 --
     03.80000s (azure-ds/obtain-dhcp-lease)
     00.67800s (modules-config/config-ssh-import-id)
     00.34300s (modules-config/config-grub-dpkg)
     00.23900s (azure-ds/list_possible_azure_ds_devs)
     00.23100s (init-network/config-ssh)
     00.20000s (azure-ds/invoke_agent)
     00.19100s (init-network/config-users-groups)
     00.12300s (init-network/config-disk_setup)
     00.10500s (modules-final/config-keys-to-console)
     00.10500s (azure-ds/_has_ntfs_filesystem)
     00.10100s (init-network/config-mounts)
     00.09600s (modules-config/config-apt-configure)
     00.06700s (modules-final/config-ssh-authkey-fingerprints)
     00.03600s (init-network/config-growpart)
     00.02700s (azure-ds/parse_network_config)
     00.02500s (init-network/check-cache)
     00.01800s (azure-ds/parse_network_config)
     00.01600s (init-network/config-resizefs)
     00.01100s (azure-ds/crtfile_to_pubkey)
     00.01100s (azure-ds/_get_metadata_from_imds)
     00.01000s (init-network/consume-user-data)
     00.01000s (azure-ds/get_boot_telemetry)
     00.00900s (azure-ds/check-platform-viability)
     00.00800s (init-network/config-set_hostname)
     00.00500s (modules-final/config-final-message)
     00.00500s (azure-ds/waiting-for-ssh-public-key)
     00.00300s (azure-ds/write_files)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-final/config-package-update-upgrade-install)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-apt-pipelining)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_get_random_seed)
     00.00100s (azure-ds/_extract_preprovisioned_vm_setting)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-ca-certs)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)

1 boot records analyzed
+ echo After upgrade write network config: upgrade-network.out
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- grep DHCP /var/log/syslog
+ echo ------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
------- Diff previous-network to post-upgrade-network ------
--- previous-network.out	2020-01-23 23:15:58.345727137 +0000
+++ upgrade-network.out	2020-01-23 23:17:38.291201229 +0000
@@ -9,8 +9,8 @@
 auto eth0
 iface eth0 inet dhcp
 default via 10.0.0.1 dev eth0 
-10.0.0.0/24 dev eth1  proto kernel  scope link  src 10.0.0.6 
 10.0.0.0/24 dev eth0  proto kernel  scope link  src 10.0.0.5 
+10.0.0.0/24 dev eth1  proto kernel  scope link  src 10.0.0.6 
 168.63.129.16 via 10.0.0.1 dev eth0 
 169.254.169.254 via 10.0.0.1 dev eth0 
 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
@@ -64,3 +64,29 @@
 Jan 23 23:15:11 SRU-worked-azure dhclient[1062]: DHCPOFFER of 10.0.0.5 from 168.63.129.16
 Jan 23 23:15:11 SRU-worked-azure dhclient[1062]: DHCPACK of 10.0.0.5 from 168.63.129.16
 Jan 23 23:15:11 SRU-worked-azure ifup[946]: DHCPACK of 10.0.0.5 from 168.63.129.16
+Jan 23 23:17:12 SRU-worked-azure dhclient[895]: Internet Systems Consortium DHCP Client 4.3.3
+Jan 23 23:17:12 SRU-worked-azure dhclient[895]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0xac46d957)
+Jan 23 23:17:12 SRU-worked-azure dhclient[895]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 4 (xid=0xac46d957)
+Jan 23 23:17:12 SRU-worked-azure dhclient[895]: DHCPREQUEST of 10.0.0.5 on eth0 to 255.255.255.255 port 67 (xid=0x57d946ac)
+Jan 23 23:17:12 SRU-worked-azure dhclient[895]: DHCPOFFER of 10.0.0.5 from 168.63.129.16
+Jan 23 23:17:12 SRU-worked-azure dhclient[895]: DHCPACK of 10.0.0.5 from 168.63.129.16
+Jan 23 23:17:12 SRU-worked-azure dhclient[954]: Internet Systems Consortium DHCP Client 4.3.3
+Jan 23 23:17:12 SRU-worked-azure sh[933]: Internet Systems Consortium DHCP Client 4.3.3
+Jan 23 23:17:12 SRU-worked-azure sh[933]: DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 3 (xid=0x965eae26)
+Jan 23 23:17:12 SRU-worked-azure dhclient[954]: DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 3 (xid=0x965eae26)
+Jan 23 23:17:12 SRU-worked-azure dhclient[1066]: Internet Systems Consortium DHCP Client 4.3.3
+Jan 23 23:17:12 SRU-worked-azure ifup[961]: Internet Systems Consortium DHCP Client 4.3.3
+Jan 23 23:17:12 SRU-worked-azure ifup[961]: DHCPREQUEST of 10.0.0.5 on eth0 to 255.255.255.255 port 67 (xid=0x73609305)
+Jan 23 23:17:12 SRU-worked-azure dhclient[1066]: DHCPREQUEST of 10.0.0.5 on eth0 to 255.255.255.255 port 67 (xid=0x73609305)
+Jan 23 23:17:12 SRU-worked-azure dhclient[1066]: DHCPREQUEST of 10.0.0.5 on eth0 to 255.255.255.255 port 67 (xid=0x73609305)
+Jan 23 23:17:12 SRU-worked-azure ifup[961]: DHCPREQUEST of 10.0.0.5 on eth0 to 255.255.255.255 port 67 (xid=0x73609305)
+Jan 23 23:17:12 SRU-worked-azure dhclient[1066]: DHCPACK of 10.0.0.5 from 168.63.129.16
+Jan 23 23:17:12 SRU-worked-azure ifup[961]: DHCPACK of 10.0.0.5 from 168.63.129.16
+Jan 23 23:17:12 SRU-worked-azure dhclient[954]: DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 7 (xid=0x965eae26)
+Jan 23 23:17:12 SRU-worked-azure sh[933]: DHCPDISCOVER on eth1 to 255.255.255.255 port 67 interval 7 (xid=0x965eae26)
+Jan 23 23:17:12 SRU-worked-azure dhclient[954]: DHCPREQUEST of 10.0.0.6 on eth1 to 255.255.255.255 port 67 (xid=0x26ae5e96)
+Jan 23 23:17:12 SRU-worked-azure sh[933]: DHCPREQUEST of 10.0.0.6 on eth1 to 255.255.255.255 port 67 (xid=0x26ae5e96)
+Jan 23 23:17:12 SRU-worked-azure sh[933]: DHCPOFFER of 10.0.0.6 from 168.63.129.16
+Jan 23 23:17:12 SRU-worked-azure dhclient[954]: DHCPOFFER of 10.0.0.6 from 168.63.129.16
+Jan 23 23:17:12 SRU-worked-azure dhclient[954]: DHCPACK of 10.0.0.6 from 168.63.129.16
+Jan 23 23:17:12 SRU-worked-azure sh[933]: DHCPACK of 10.0.0.6 from 168.63.129.16
+ echo ------- Diff previous-network to post-upgrade-network ------
+ ------- Diff previous-network to post-upgrade-network ------
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
+ ssh -oGet cloud-id
 StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
 -- sudo reboot
sudo: unable to resolve host SRU-worked-azure
Connection to 52.167.153.97 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- cloud-init status --wait --long

status: done
time: Thu, 23 Jan 2020 23:18:28 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
+ After reboot
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.153.97 -- grep 'Update datasource' /var/log/cloud-init.log
2020-01-23 23:17:01,879 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-23 23:18:14,296 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-23 23:18:18,402 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END xenial
+ echo### END xenial
+ echo ### BEGIN bionic
+ netcfg=/etc/netplan/50-cloud-init.yaml
### BEGIN bionic
+ image_version=18.04-DAILY-LTS
+ [  =  ]
+ echo Creating standard network vm
Creating standard network vm
+ name=test-sru-bionic
+ az vm create --name=test-sru-bionic --image=Canonical:UbuntuServer:18.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroup --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Compute/virtualMachines/test-sru-bionic",
  "location": "eastus2",
  "macAddress": "00-0D-3A-0D-75-FD",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.4",
  "publicIpAddress": "52.184.149.194",
  "resourceGroup": "srugroup",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-bionic
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.184.149.194
+ echo Created test-sru-bionic: ubuntu@ubuntu@52.184.149.194
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- cloud-init status --wait --long
Created test-sru-bionic: ubuntu@ubuntu@52.184.149.194

status: done
time: Fri, 24 Jan 2020 00:05:26 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- dpkg-query --show cloud-init
cloud-init	19.3-41-gc4735dd3-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- systemd-analyze
Startup finished in 6.503s (kernel) + 30.946s (userspace) = 37.450s
graphical.target reached after 29.816s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- systemd-analyze blame
         10.008s cloud-init.service
          4.700s cloud-init-local.service
          3.500s snapd.service
          3.342s lxd-containers.service
          3.091s pollinate.service
          2.344s cloud-config.service
          2.251s dev-sda1.device
          2.222s keyboard-setup.service
          2.077s snapd.seeded.service
          1.437s apparmor.service
          1.124s systemd-networkd-wait-online.service
          1.122s cloud-final.service
          1.045s networkd-dispatcher.service
           961ms grub-common.service
           898ms accounts-daemon.service
           445ms systemd-timesyncd.service
           435ms apport.service
           431ms rsyslog.service
           419ms systemd-logind.service
           416ms systemd-udev-trigger.service
           373ms lvm2-monitor.service
           350ms polkit.service
           322ms systemd-user-sessions.service
           297ms systemd-modules-load.service
           215ms sys-kernel-debug.mount
           211ms snapd.socket
           205ms dev-hugepages.mount
           202ms kmod-static-nodes.service
           198ms systemd-journald.service
           184ms systemd-remount-fs.service
           182ms systemd-journal-flush.service
           179ms lxd.socket
           156ms ufw.service
           154ms systemd-networkd.service
           148ms systemd-tmpfiles-setup-dev.service
           146ms dev-mqueue.mount
           140ms ebtables.service
           137ms systemd-udevd.service
           133ms ssh.service
            94ms systemd-machine-id-commit.service
            89ms systemd-sysctl.service
            89ms systemd-resolved.service
            76ms systemd-random-seed.service
            76ms systemd-tmpfiles-setup.service
            60ms plymouth-quit.service
            58ms sys-kernel-config.mount
            57ms blk-availability.service
            51ms plymouth-read-write.service
            49ms sys-fs-fuse-connections.mount
            38ms console-setup.service
            36ms setvtrgb.service
            34ms boot-efi.mount
            33ms user@1000.service
            24ms ephemeral-disk-warning.service
            23ms plymouth-quit-wait.service
            22ms systemd-update-utmp.service
             8ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00300s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.11000s +00.00900s
|`->get_boot_telemetry @00.11900s +00.01400s
|`->get_system_info @00.13300s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.13300s +00.04100s
|`->load_azure_ds_dir @00.17400s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.35900s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.36000s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00900 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.39200s +00.60900s
|`->_get_metadata_from_imds @01.00100s +00.02100s
Finished stage: (azure-ds/get_metadata_from_imds) 00.64900 seconds

|`->_get_random_seed @01.04100s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.91700 seconds

|`->maybe_remove_ubuntu_network_config_scripts @01.05100s +00.00000s
|`->write_files @01.05100s +00.00300s
Finished stage: (azure-ds/_get_data) 00.94400 seconds

Finished stage: (init-local/search-Azure) 00.94600 seconds

|`->network config from imds @01.11800s +00.00000s
Finished stage: (init-local) 01.30400 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.16300s +00.03300s
|`->network config from imds @03.24700s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.25700s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.26100s +00.10400s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.36500s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.38700s +00.01100s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.39900s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.14000 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.54000s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.15900 seconds

|`->_report_ready @03.54600s +03.29900s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.58400 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.58600 seconds

Finished stage: (azure-ds/_negotiate) 03.58900 seconds

Finished stage: (azure-ds/setup) 03.59000 seconds

Finished stage: (init-network/setup-datasource) 03.59100 seconds

|`->reading and applying user-data @06.86700s +00.00800s
|`->reading and applying vendor-data @06.87500s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @06.91100s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @06.91100s +00.13300s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.13500s +00.00200s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.10500 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.23900 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.24000 seconds

Finished stage: (azure-ds/activate) 00.24000 seconds

Finished stage: (init-network/activate-datasource) 00.24200 seconds

|`->config-migrator ran successfully @07.22700s +00.00100s
|`->config-seed_random ran successfully @07.22800s +00.00100s
|`->config-bootcmd ran successfully @07.23000s +00.00000s
|`->config-write-files ran successfully @07.23000s +00.00100s
|`->config-growpart ran successfully @07.23200s +00.65500s
|`->config-resizefs ran successfully @07.88800s +01.65500s
|`->config-disk_setup ran successfully @09.54400s +02.44800s
|`->config-mounts ran successfully @11.99400s +00.17600s
|`->config-set_hostname ran successfully @12.17100s +00.00600s
|`->config-update_hostname ran successfully @12.17800s +00.00100s
|`->config-update_etc_hosts ran successfully @12.17900s +00.00100s
|`->config-ca-certs ran successfully @12.18000s +00.00100s
|`->config-rsyslog ran successfully @12.18100s +00.00100s
|`->config-users-groups ran successfully @12.18200s +00.26300s
|`->config-ssh ran successfully @12.44500s +00.16600s
Finished stage: (init-network) 09.46100 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @19.63300s +00.00000s
|`->config-snap ran successfully @19.63400s +00.00000s
|`->config-snap_config ran successfully @19.63500s +00.00800s
|`->config-ssh-import-id ran successfully @19.64300s +00.74300s
|`->config-locale ran successfully @20.38700s +00.00100s
|`->config-set-passwords ran successfully @20.38800s +00.00100s
|`->config-grub-dpkg ran successfully @20.39000s +00.90100s
|`->config-apt-pipelining ran successfully @21.29200s +00.00100s
|`->config-apt-configure ran successfully @21.29300s +00.11500s
|`->config-ubuntu-advantage ran successfully @21.40900s +00.00000s
|`->config-ntp ran successfully @21.41000s +00.00100s
|`->config-timezone ran successfully @21.41100s +00.00100s
|`->config-disable-ec2-metadata ran successfully @21.41200s +00.00000s
|`->config-runcmd ran successfully @21.41300s +00.00000s
|`->config-byobu ran successfully @21.41400s +00.00000s
Finished stage: (modules-config) 01.79700 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @22.25200s +00.00200s
|`->config-package-update-upgrade-install ran successfully @22.26000s +00.00100s
|`->config-fan ran successfully @22.26100s +00.00500s
|`->config-landscape ran successfully @22.26700s +00.00000s
|`->config-lxd ran successfully @22.26800s +00.00000s
|`->config-ubuntu-drivers ran successfully @22.26900s +00.00100s
|`->config-puppet ran successfully @22.27000s +00.00500s
|`->config-chef ran successfully @22.27500s +00.00100s
|`->config-mcollective ran successfully @22.27600s +00.00100s
|`->config-salt-minion ran successfully @22.27700s +00.00100s
|`->config-rightscale_userdata ran successfully @22.28100s +00.00100s
|`->config-scripts-vendor ran successfully @22.28200s +00.00100s
|`->config-scripts-per-once ran successfully @22.28400s +00.00000s
|`->config-scripts-per-boot ran successfully @22.28500s +00.00000s
|`->config-scripts-per-instance ran successfully @22.28500s +00.00100s
|`->config-scripts-user ran successfully @22.28700s +00.00000s
|`->config-ssh-authkey-fingerprints ran successfully @22.28800s +00.06700s
|`->config-keys-to-console ran successfully @22.35600s +00.16100s
|`->config-phone-home ran successfully @22.52300s +00.00100s
|`->config-final-message ran successfully @22.52400s +00.00900s
|`->config-power-state-change ran successfully @22.53600s +00.00000s
Finished stage: (modules-final) 00.41500 seconds

Total Time: 35.76000 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- cloud-init analyze blame
-- Boot Record 01 --
     03.29900s (azure-ds/_report_ready)
     02.44800s (init-network/config-disk_setup)
     01.65500s (init-network/config-resizefs)
     00.90100s (modules-config/config-grub-dpkg)
     00.74300s (modules-config/config-ssh-import-id)
     00.65500s (init-network/config-growpart)
     00.60900s (azure-ds/obtain-dhcp-lease)
     00.26300s (init-network/config-users-groups)
     00.17600s (init-network/config-mounts)
     00.16600s (init-network/config-ssh)
     00.16100s (modules-final/config-keys-to-console)
     00.13300s (azure-ds/_has_ntfs_filesystem)
     00.11500s (modules-config/config-apt-configure)
     00.10400s (azure-ds/generate_certificate)
     00.06700s (modules-final/config-ssh-authkey-fingerprints)
     00.04100s (azure-ds/list_possible_azure_ds_devs)
     00.03300s (init-network/check-cache)
     00.02100s (azure-ds/_get_metadata_from_imds)
     00.01400s (azure-ds/get_boot_telemetry)
     00.01100s (azure-ds/_decrypt_certs_from_xml)
     00.00900s (modules-final/config-final-message)
     00.00900s (azure-ds/check-platform-viability)
     00.00800s (modules-config/config-snap_config)
     00.00800s (init-network/consume-user-data)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-puppet)
     00.00500s (modules-final/config-fan)
     00.00300s (azure-ds/write_files)
     00.00200s (modules-final/config-snappy)
     00.00200s (azure-ds/count_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-locale)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-user)
     00.00000s (modules-final/config-scripts-per-once)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-power-state-change)
     00.00000s (modules-final/config-lxd)
     00.00000s (modules-final/config-landscape)
     00.00000s (modules-config/config-ubuntu-advantage)
     00.00000s (modules-config/config-snap)
     00.00000s (modules-config/config-runcmd)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (modules-config/config-byobu)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Writing networking config: previous-network.out
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- ip -4 route
 + ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@52.184.149.194:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- sudo bash ./setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu bionic-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~18.04.1 [409 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~18.04.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~18.04.1) over (19.3-41-gc4735dd3-0ubuntu1~18.04.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~18.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- sudo cloud-init clean --logs --reboot
Connection to 52.184.149.194 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- cloud-init status --wait --long

status: done
time: Fri, 24 Jan 2020 00:07:00 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- sudo systemd-analyze blame
          2.825s cloud-config.service
          2.164s keyboard-setup.service
          2.024s dev-sda1.device
          1.915s systemd-networkd-wait-online.service
          1.792s cloud-init.service
          1.530s cloud-init-local.service
          1.383s snapd.service
          1.236s lxd-containers.service
          1.060s networkd-dispatcher.service
           797ms cloud-final.service
           576ms accounts-daemon.service
           569ms apparmor.service
           507ms grub-common.service
           455ms apport.service
           416ms systemd-timesyncd.service
           380ms systemd-udev-trigger.service
           299ms lvm2-monitor.service
           292ms systemd-logind.service
           283ms rsyslog.service
           269ms ssh.service
           247ms polkit.service
           247ms dev-hugepages.mount
           244ms systemd-modules-load.service
           241ms kmod-static-nodes.service
           240ms dev-mqueue.mount
           236ms systemd-journald.service
           231ms systemd-remount-fs.service
           230ms ufw.service
           195ms blk-availability.service
           148ms ebtables.service
           142ms sys-kernel-debug.mount
           121ms systemd-user-sessions.service
           113ms systemd-journal-flush.service
           101ms snapd.socket
           101ms lxd.socket
            95ms systemd-resolved.service
            75ms systemd-udevd.service
            75ms systemd-tmpfiles-setup.service
            65ms console-setup.service
            64ms boot-efi.mount
            60ms sys-kernel-config.mount
            60ms sys-fs-fuse-connections.mount
            59ms systemd-sysctl.service
            58ms systemd-tmpfiles-setup-dev.service
            58ms setvtrgb.service
            57ms systemd-random-seed.service
            48ms snapd.seeded.service
            45ms systemd-networkd.service
            45ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            43ms plymouth-quit.service
            37ms user@1000.service
            36ms systemd-update-utmp-runlevel.service
            33ms systemd-update-utmp.service
            20ms plymouth-read-write.service
            16ms ephemeral-disk-warning.service
            12ms plymouth-quit-wait.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.04400s +00.00800s
|`->get_boot_telemetry @00.05200s +00.01300s
|`->get_system_info @00.06500s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.06600s +00.18200s
|`->load_azure_ds_dir @00.24800s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.25200s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.25200s +00.00100s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.27400s +00.15200s
|`->_get_metadata_from_imds @00.42700s +00.01200s
Finished stage: (azure-ds/get_metadata_from_imds) 00.18600 seconds

|`->_get_random_seed @00.45900s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.40200 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.46800s +00.00100s
|`->write_files @00.46900s +00.00200s
Finished stage: (azure-ds/_get_data) 00.42700 seconds

Finished stage: (init-local/search-Azure) 00.43000 seconds

|`->network config from imds @00.52500s +00.00000s
Finished stage: (init-local) 00.64600 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.16500s +00.03400s
|`->network config from imds @03.24600s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.25500s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.25800s +00.06100s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.31900s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.34100s +00.01100s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.35300s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.03800 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.39100s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.05600 seconds

|`->_report_ready @03.39700s +00.01000s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.14900 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.15000 seconds

Finished stage: (azure-ds/_negotiate) 00.15400 seconds

Finished stage: (azure-ds/setup) 00.15500 seconds

Finished stage: (init-network/setup-datasource) 00.15500 seconds

|`->reading and applying user-data @03.41500s +00.00700s
|`->reading and applying vendor-data @03.42200s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.45300s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.45400s +00.14900s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.15000 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.15000 seconds

Finished stage: (azure-ds/activate) 00.15000 seconds

Finished stage: (init-network/activate-datasource) 00.15200 seconds

|`->config-migrator ran successfully @03.64500s +00.00100s
|`->config-seed_random ran successfully @03.64600s +00.00200s
|`->config-bootcmd ran successfully @03.64900s +00.00700s
|`->config-write-files ran successfully @03.65600s +00.00100s
|`->config-growpart ran successfully @03.65800s +00.10400s
|`->config-resizefs ran successfully @03.76300s +00.02500s
|`->config-disk_setup ran successfully @03.79100s +00.14200s
|`->config-mounts ran successfully @03.94200s +00.17300s
|`->config-set_hostname ran successfully @04.11600s +00.00600s
|`->config-update_hostname ran successfully @04.12300s +00.00100s
|`->config-update_etc_hosts ran successfully @04.12500s +00.00000s
|`->config-ca-certs ran successfully @04.12500s +00.00100s
|`->config-rsyslog ran successfully @04.12600s +00.00100s
|`->config-users-groups ran successfully @04.12800s +00.20700s
|`->config-ssh ran successfully @04.33600s +00.07500s
Finished stage: (init-network) 01.25900 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @07.50200s +00.00100s
|`->config-snap ran successfully @07.50300s +00.00400s
|`->config-ssh-import-id ran successfully @07.50800s +01.10600s
|`->config-locale ran successfully @08.61500s +00.01300s
|`->config-set-passwords ran successfully @08.62800s +00.00200s
|`->config-grub-dpkg ran successfully @08.63000s +00.51400s
|`->config-apt-pipelining ran successfully @09.14500s +00.00100s
|`->config-apt-configure ran successfully @09.14600s +00.12500s
|`->config-ubuntu-advantage ran successfully @09.27200s +00.00100s
|`->config-ntp ran successfully @09.27300s +00.00100s
|`->config-timezone ran successfully @09.27400s +00.00100s
|`->config-disable-ec2-metadata ran successfully @09.27500s +00.00100s
|`->config-runcmd ran successfully @09.27600s +00.00100s
|`->config-byobu ran successfully @09.27700s +00.00100s
Finished stage: (modules-config) 01.79800 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @09.94100s +00.00000s
|`->config-fan ran successfully @09.94200s +00.00100s
|`->config-landscape ran successfully @09.94300s +00.00100s
|`->config-lxd ran successfully @09.94400s +00.00100s
|`->config-ubuntu-drivers ran successfully @09.94500s +00.00100s
|`->config-puppet ran successfully @09.94600s +00.00100s
|`->config-chef ran successfully @09.94700s +00.00100s
|`->config-mcollective ran successfully @09.94900s +00.00000s
|`->config-salt-minion ran successfully @09.95000s +00.00000s
|`->config-rightscale_userdata ran successfully @09.95100s +00.00000s
|`->config-scripts-vendor ran successfully @09.95200s +00.00100s
|`->config-scripts-per-once ran successfully @09.95300s +00.00100s
|`->config-scripts-per-boot ran successfully @09.95400s +00.00100s
|`->config-scripts-per-instance ran successfully @09.95500s +00.00100s
|`->config-scripts-user ran successfully @09.95600s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @09.95700s +00.06400s
|`->config-keys-to-console ran successfully @10.02200s +00.11000s
|`->config-phone-home ran successfully @10.13300s +00.00100s
|`->config-final-message ran successfully @10.13400s +00.00500s
|`->config-power-state-change ran successfully @10.14000s +00.00000s
Finished stage: (modules-final) 00.21700 seconds

Total Time: 6.84200 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- cloud-init analyze blame
-- Boot Record 01 --
     01.10600s (modules-config/config-ssh-import-id)
     00.51400s (modules-config/config-grub-dpkg)
     00.20700s (init-network/config-users-groups)
     00.18200s (azure-ds/list_possible_azure_ds_devs)
     00.17300s (init-network/config-mounts)
     00.15200s (azure-ds/obtain-dhcp-lease)
     00.14900s (azure-ds/_has_ntfs_filesystem)
     00.14200s (init-network/config-disk_setup)
     00.12500s (modules-config/config-apt-configure)
     00.11000s (modules-final/config-keys-to-console)
     00.10400s (init-network/config-growpart)
     00.07500s (init-network/config-ssh)
     00.06400s (modules-final/config-ssh-authkey-fingerprints)
     00.06100s (azure-ds/generate_certificate)
     00.03400s (init-network/check-cache)
     00.02500s (init-network/config-resizefs)
     00.01300s (modules-config/config-locale)
     00.01300s (azure-ds/get_boot_telemetry)
     00.01200s (azure-ds/_get_metadata_from_imds)
     00.01100s (azure-ds/_decrypt_certs_from_xml)
     00.01000s (azure-ds/_report_ready)
     00.00800s (azure-ds/check-platform-viability)
     00.00700s (init-network/consume-user-data)
     00.00700s (init-network/config-bootcmd)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00400s (modules-config/config-snap)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (init-network/config-seed_random)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00100s (azure-ds/_extract_preprovisioned_vm_setting)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-power-state-change)
     00.00000s (modules-final/config-package-update-upgrade-install)
     00.00000s (modules-final/config-mcollective)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)

1 boot records analyzed
+ echo After upgrade write network config: upgrade-network.out
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- grep DHCP /var/log/syslog
+ echo ------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
------- Diff previous-network to post-upgrade-network ------
--- previous-network.out	2020-01-24 00:05:46.445951919 +0000
+++ upgrade-network.out	2020-01-24 00:07:35.463488746 +0000
@@ -38,3 +38,9 @@
 Jan 24 00:05:17 SRU-worked-azure dhclient[835]: DHCPOFFER of 10.0.0.4 from 168.63.129.16
 Jan 24 00:05:17 SRU-worked-azure dhclient[835]: DHCPACK of 10.0.0.4 from 168.63.129.16
 Jan 24 00:05:17 SRU-worked-azure systemd-networkd[865]: eth0: DHCPv4 address 10.0.0.4/24 via 10.0.0.1
+Jan 24 00:06:55 SRU-worked-azure dhclient[881]: Internet Systems Consortium DHCP Client 4.3.5
+Jan 24 00:06:55 SRU-worked-azure dhclient[881]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0xea3b362c)
+Jan 24 00:06:55 SRU-worked-azure dhclient[881]: DHCPREQUEST of 10.0.0.4 on eth0 to 255.255.255.255 port 67 (xid=0x2c363bea)
+Jan 24 00:06:55 SRU-worked-azure dhclient[881]: DHCPOFFER of 10.0.0.4 from 168.63.129.16
+Jan 24 00:06:55 SRU-worked-azure dhclient[881]: DHCPACK of 10.0.0.4 from 168.63.129.16
+Jan 24 00:06:55 SRU-worked-azure systemd-networkd[917]: eth0: DHCPv4 address 10.0.0.4/24 via 10.0.0.1
+ echo ------- Diff previous-network to post-upgrade-network ------
+ ------- Diff previous-network to post-upgrade-network ------
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
+ ssh -oGet cloud-id
 StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
 -- sudo reboot
Connection to 52.184.149.194 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- cloud-init status --wait --long

status: done
time: Fri, 24 Jan 2020 00:08:10 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.184.149.194 -- grep 'Update datasource' /var/log/cloud-init.log
2020-01-24 00:06:50,833 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-24 00:08:02,687 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-24 00:08:03,153 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ [  = --nics sruNic-bionic sruNic2-bionic --size Standard_DS2_v2 ]
+ [ true = false ]
+ echo Creating advanced network vm
+ name=test-sru-bionic-advanced
Creating advanced network vm
+ az network public-ip create --name vmPublicIP-IPv4-bionic --resource-group srugroup --location eastus2 --sku BASIC --allocation-method dynamic --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"18360d7d-d6bd-4785-bed7-aab818d7caee\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/vmPublicIP-IPv4-bionic",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "vmPublicIP-IPv4-bionic",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroup",
    "resourceGuid": "e9c73924-c895-480d-888e-6f9592ee2561",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name lbPublicIP_v4_bionic --resource-group srugroup --location eastus2 --sku BASIC --allocation-method dynamic --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"fd1c9b71-9332-48c5-b726-863646070ec6\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v4_bionic",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "lbPublicIP_v4_bionic",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroup",
    "resourceGuid": "927da3e8-b772-4acf-afaa-5e895108d62c",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name lbPublicIP_v6_bionic --resource-group srugroup --location eastus2 --sku BASIC --allocation-method dynamic --version IPv6
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"f77d6295-eeb0-4cbd-8b5c-02c50991cc97\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v6_bionic",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "lbPublicIP_v6_bionic",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv6",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroup",
    "resourceGuid": "6c20ad71-22eb-4d7c-b67d-730e793b5a01",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network lb create --name dsLB_bionic --resource-group srugroup --sku Basic --location eastus2 --frontend-ip-name dsLbFrontEnd_v4_bionic --public-ip-address lbPublicIP_v4_bionic --backend-pool-name dsLbBackEndPool_v4_bionic
{
  "loadBalancer": {
    "backendAddressPools": [
      {
        "etag": "W/\"04e1a98b-e708-4474-88c2-fd59652115e2\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/backendAddressPools/dsLbBackEndPool_v4_bionic",
        "name": "dsLbBackEndPool_v4_bionic",
        "properties": {
          "provisioningState": "Succeeded"
        },
        "resourceGroup": "srugroup",
        "type": "Microsoft.Network/loadBalancers/backendAddressPools"
      }
    ],
    "frontendIPConfigurations": [
      {
        "etag": "W/\"04e1a98b-e708-4474-88c2-fd59652115e2\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/frontendIPConfigurations/dsLbFrontEnd_v4_bionic",
        "name": "dsLbFrontEnd_v4_bionic",
        "properties": {
          "privateIPAddressVersion": "IPv4",
          "privateIPAllocationMethod": "Dynamic",
          "provisioningState": "Succeeded",
          "publicIPAddress": {
            "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v4_bionic",
            "resourceGroup": "srugroup"
          }
        },
        "resourceGroup": "srugroup",
        "type": "Microsoft.Network/loadBalancers/frontendIPConfigurations"
      }
    ],
    "inboundNatPools": [],
    "inboundNatRules": [],
    "loadBalancingRules": [],
    "probes": [],
    "provisioningState": "Succeeded",
    "resourceGuid": "f426283b-aa61-442d-8767-2f72e3ac3c25"
  }
}
+ az network lb frontend-ip create --lb-name dsLB_bionic --name dsLbFrontEnd_v6_bionic --resource-group srugroup --public-ip-address lbPublicIP_v6_bionic
{
  "etag": "W/\"b371cb78-9827-42f2-8c9f-c615299e550f\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/frontendIPConfigurations/dsLbFrontEnd_v6_bionic",
  "inboundNatPools": null,
  "inboundNatRules": null,
  "loadBalancingRules": null,
  "name": "dsLbFrontEnd_v6_bionic",
  "outboundRules": null,
  "privateIpAddress": null,
  "privateIpAddressVersion": "IPv4",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v6_bionic",
    "idleTimeoutInMinutes": null,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": null,
    "location": null,
    "name": null,
    "provisioningState": null,
    "publicIpAddressVersion": null,
    "publicIpAllocationMethod": null,
    "publicIpPrefix": null,
    "resourceGroup": "srugroup",
    "resourceGuid": null,
    "sku": null,
    "tags": null,
    "type": null,
    "zones": null
  },
  "publicIpPrefix": null,
  "resourceGroup": "srugroup",
  "subnet": null,
  "type": "Microsoft.Network/loadBalancers/frontendIPConfigurations",
  "zones": null
}
+ az network lb address-pool create --lb-name dsLB_bionic --name dsLbBackEndPool_v6_bionic --resource-group srugroup
{
  "backendIpConfigurations": null,
  "etag": "W/\"2e78402b-cb6b-42f6-8078-5bb7c8f8ebd4\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/backendAddressPools/dsLbBackEndPool_v6_bionic",
  "loadBalancingRules": null,
  "name": "dsLbBackEndPool_v6_bionic",
  "outboundRule": null,
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroup",
  "type": "Microsoft.Network/loadBalancers/backendAddressPools"
}
+ az network lb probe create -g srugroup --lb-name dsLB_bionic -n dsProbe_bionic --protocol tcp --port 22
{
  "etag": "W/\"831d5bcb-f1c1-401a-906e-cb8dc9cff5b3\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/probes/dsProbe_bionic",
  "intervalInSeconds": 15,
  "loadBalancingRules": null,
  "name": "dsProbe_bionic",
  "numberOfProbes": 2,
  "port": 22,
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "requestPath": null,
  "resourceGroup": "srugroup",
  "type": "Microsoft.Network/loadBalancers/probes"
}
+ az network lb rule create --lb-name dsLB_bionic --name dsLBrule_v4_bionic --resource-group srugroup --frontend-ip-name dsLbFrontEnd_v4_bionic --protocol Tcp --frontend-port 22 --backend-port 22 --probe-name dsProbe_bionic --backend-pool-name dsLbBackEndPool_v4_bionic
{
  "backendAddressPool": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/backendAddressPools/dsLbBackEndPool_v4_bionic",
    "resourceGroup": "srugroup"
  },
  "backendPort": 22,
  "disableOutboundSnat": null,
  "enableFloatingIp": false,
  "enableTcpReset": false,
  "etag": "W/\"44a9b047-c56d-4d54-973a-c23fc9084a71\"",
  "frontendIpConfiguration": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/frontendIPConfigurations/dsLbFrontEnd_v4_bionic",
    "resourceGroup": "srugroup"
  },
  "frontendPort": 22,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/loadBalancingRules/dsLBrule_v4_bionic",
  "idleTimeoutInMinutes": 4,
  "loadDistribution": "Default",
  "name": "dsLBrule_v4_bionic",
  "probe": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/probes/dsProbe_bionic",
    "resourceGroup": "srugroup"
  },
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroup",
  "type": "Microsoft.Network/loadBalancers/loadBalancingRules"
}
+ az network lb rule create --lb-name dsLB_bionic --name dsLBrule_v6_bionic --resource-group srugroup --frontend-ip-name dsLbFrontEnd_v6_bionic --protocol Tcp --frontend-port 22 --backend-port 22 --probe-name dsProbe_bionic --backend-pool-name dsLbBackEndPool_v6_bionic
{
  "backendAddressPool": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/backendAddressPools/dsLbBackEndPool_v6_bionic",
    "resourceGroup": "srugroup"
  },
  "backendPort": 22,
  "disableOutboundSnat": null,
  "enableFloatingIp": false,
  "enableTcpReset": false,
  "etag": "W/\"1f1a4af1-06f7-4fbc-a189-4f814c075ca4\"",
  "frontendIpConfiguration": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/frontendIPConfigurations/dsLbFrontEnd_v6_bionic",
    "resourceGroup": "srugroup"
  },
  "frontendPort": 22,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/loadBalancingRules/dsLBrule_v6_bionic",
  "idleTimeoutInMinutes": 4,
  "loadDistribution": "Default",
  "name": "dsLBrule_v6_bionic",
  "probe": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/probes/dsProbe_bionic",
    "resourceGroup": "srugroup"
  },
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroup",
  "type": "Microsoft.Network/loadBalancers/loadBalancingRules"
}
+ az vm availability-set create --name dsAVset_bionic --resource-group srugroup --location eastus2 --platform-fault-domain-count 2 --platform-update-domain-count 2
{
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Compute/availabilitySets/dsAVset_bionic",
  "location": "eastus2",
  "name": "dsAVset_bionic",
  "platformFaultDomainCount": 2,
  "platformUpdateDomainCount": 2,
  "proximityPlacementGroup": null,
  "resourceGroup": "srugroup",
  "sku": {
    "capacity": null,
    "name": "Aligned",
    "tier": null
  },
  "statuses": null,
  "tags": {},
  "type": "Microsoft.Compute/availabilitySets",
  "virtualMachines": []
}
+ az network nic create --name sruNic-bionic --resource-group srugroup --network-security-group sruNetSecGroup --vnet-name sruVnet --accelerated-networking true --subnet sruSubnet --private-ip-address-version IPv4 --lb-address-pools dsLbBackEndPool_v4_bionic --lb-name dsLB_bionic --public-ip-address vmPublicIP-IPv4-bionic
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "ghk1gsqrcvcepe4auoqnouvxvf.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"feb9f3da-e4b4-42f3-8ebe-8f68c4eabac8\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic-bionic",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"feb9f3da-e4b4-42f3-8ebe-8f68c4eabac8\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic-bionic/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": [
          {
            "backendIpConfigurations": null,
            "etag": null,
            "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/backendAddressPools/dsLbBackEndPool_v4_bionic",
            "loadBalancingRules": null,
            "name": null,
            "outboundRule": null,
            "provisioningState": null,
            "resourceGroup": "srugroup"
          }
        ],
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "10.0.0.5",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": {
          "ddosSettings": null,
          "dnsSettings": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/vmPublicIP-IPv4-bionic",
          "idleTimeoutInMinutes": null,
          "ipAddress": null,
          "ipConfiguration": null,
          "ipTags": null,
          "location": null,
          "name": null,
          "provisioningState": null,
          "publicIpAddressVersion": null,
          "publicIpAllocationMethod": null,
          "publicIpPrefix": null,
          "resourceGroup": "srugroup",
          "resourceGuid": null,
          "sku": null,
          "tags": null,
          "type": null,
          "zones": null
        },
        "resourceGroup": "srugroup",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroup",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic-bionic",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroup",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroup",
    "resourceGuid": "e962991f-9717-4a56-8abd-e7fd65e0ed76",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic create --name sruNic2-bionic --resource-group srugroup --network-security-group sruNetSecGroup --vnet-name sruVnet --accelerated-networking true --subnet sruSubnet --private-ip-address-version IPv4
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "ghk1gsqrcvcepe4auoqnouvxvf.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"ace6835c-cb38-41c7-a43e-84d1c197fef2\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic2-bionic",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"ace6835c-cb38-41c7-a43e-84d1c197fef2\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic2-bionic/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "10.0.0.6",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": null,
        "resourceGroup": "srugroup",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroup",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic2-bionic",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroup",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroup",
    "resourceGuid": "7868f086-138d-4720-a5c3-8be60e5616cf",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic ip-config create --name sruNic-bionic-v6 --nic-name sruNic-bionic --resource-group srugroup --vnet-name sruVnet --subnet sruSubnet --lb-address-pools dsLbBackEndPool_v6_bionic --lb-name dsLB_bionic --private-ip-address-version IPv6
{
  "applicationGatewayBackendAddressPools": null,
  "applicationSecurityGroups": null,
  "etag": "W/\"e2a0335d-e22a-4ca1-8f74-2bfe0b106bfd\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic-bionic/ipConfigurations/sruNic-bionic-v6",
  "loadBalancerBackendAddressPools": [
    {
      "backendIpConfigurations": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/backendAddressPools/dsLbBackEndPool_v6_bionic",
      "loadBalancingRules": null,
      "name": null,
      "outboundRule": null,
      "provisioningState": null,
      "resourceGroup": "srugroup"
    }
  ],
  "loadBalancerInboundNatRules": null,
  "name": "sruNic-bionic-v6",
  "primary": null,
  "privateIpAddress": "ace:cab:deca:deed::4",
  "privateIpAddressVersion": "IPv6",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": null,
  "resourceGroup": "srugroup",
  "subnet": {
    "addressPrefix": null,
    "addressPrefixes": null,
    "delegations": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
    "ipConfigurationProfiles": null,
    "ipConfigurations": null,
    "name": null,
    "natGateway": null,
    "networkSecurityGroup": null,
    "privateEndpointNetworkPolicies": null,
    "privateEndpoints": null,
    "privateLinkServiceNetworkPolicies": null,
    "provisioningState": null,
    "purpose": null,
    "resourceGroup": "srugroup",
    "resourceNavigationLinks": null,
    "routeTable": null,
    "serviceAssociationLinks": null,
    "serviceEndpointPolicies": null,
    "serviceEndpoints": null
  },
  "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
  "virtualNetworkTaps": null
}
+ az vm create --name=test-sru-bionic-advanced --image=Canonical:UbuntuServer:18.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroup --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml --nics sruNic-bionic sruNic2-bionic --size Standard_DS2_v2
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Compute/virtualMachines/test-sru-bionic-advanced",
  "location": "eastus2",
  "macAddress": "00-0D-3A-0F-23-C4,00-0D-3A-0F-21-9C",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.5,ace:cab:deca:deed::4,10.0.0.6",
  "publicIpAddress": "104.209.172.221",
  "resourceGroup": "srugroup",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-bionic-advanced
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@104.209.172.221
+ echo Created test-sru-bionic-advanced: ubuntu@ubuntu@104.209.172.221
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221Created test-sru-bionic-advanced: ubuntu@ubuntu@104.209.172.221
 -- cloud-init status --wait --long

status: done
time: Fri, 24 Jan 2020 00:18:56 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- dpkg-query --show cloud-init
cloud-init	19.3-41-gc4735dd3-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- systemd-analyze
Startup finished in 7.482s (kernel) + 26.984s (userspace) = 34.467s
graphical.target reached after 26.306s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- systemd-analyze blame
          9.278s cloud-init.service
          4.224s cloud-init-local.service
          2.586s snapd.service
          2.554s snapd.seeded.service
          2.526s pollinate.service
          2.298s cloud-config.service
          2.124s lxd-containers.service
          1.779s dev-sda1.device
          1.414s systemd-networkd-wait-online.service
          1.403s keyboard-setup.service
           886ms networkd-dispatcher.service
           855ms accounts-daemon.service
           759ms apparmor.service
           675ms cloud-final.service
           596ms blk-availability.service
           563ms rsyslog.service
           522ms systemd-user-sessions.service
           484ms systemd-logind.service
           358ms lvm2-monitor.service
           303ms grub-common.service
           261ms systemd-modules-load.service
           252ms systemd-timesyncd.service
           210ms polkit.service
           192ms systemd-udevd.service
           170ms ebtables.service
           148ms systemd-journal-flush.service
           133ms systemd-networkd.service
           130ms systemd-journald.service
           127ms ssh.service
           118ms systemd-udev-trigger.service
           116ms systemd-sysctl.service
           112ms ufw.service
           112ms dev-mqueue.mount
           112ms sys-kernel-debug.mount
           105ms systemd-tmpfiles-setup-dev.service
           104ms apport.service
            94ms dev-hugepages.mount
            67ms systemd-tmpfiles-setup.service
            61ms plymouth-read-write.service
            58ms systemd-machine-id-commit.service
            56ms systemd-resolved.service
            52ms setvtrgb.service
            51ms systemd-remount-fs.service
            43ms lxd.socket
            33ms kmod-static-nodes.service
            28ms systemd-random-seed.service
            28ms user@1000.service
            24ms plymouth-quit.service
            24ms systemd-update-utmp.service
            23ms plymouth-quit-wait.service
            20ms ephemeral-disk-warning.service
            16ms boot-efi.mount
            14ms snapd.socket
            12ms console-setup.service
            11ms sys-fs-fuse-connections.mount
             6ms systemd-update-utmp-runlevel.service
             4ms sys-kernel-config.mount
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.10000s +00.01100s
|`->get_boot_telemetry @00.11100s +00.01400s
|`->get_system_info @00.12600s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.12600s +00.03900s
|`->load_azure_ds_dir @00.16500s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.27900s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.27900s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00700 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.29500s +00.28300s
|`->_get_metadata_from_imds @00.57900s +00.02600s
Finished stage: (azure-ds/get_metadata_from_imds) 00.33400 seconds

|`->_get_random_seed @00.62900s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.51300 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.64000s +00.00000s
|`->write_files @00.64100s +00.00200s
Finished stage: (azure-ds/_get_data) 00.54300 seconds

Finished stage: (init-local/search-Azure) 00.55000 seconds

|`->network config from imds @00.71300s +00.00100s
Finished stage: (init-local) 00.91000 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @02.93000s +00.03100s
|`->network config from imds @03.00800s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.01900s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.02300s +00.14800s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.17100s +00.00200s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.19300s +00.01200s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.20600s +00.00500s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.14000 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.34600s +00.01000s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.01000 seconds

Finished stage: (azure-ds/parse_certificates) 00.16300 seconds

|`->_report_ready @03.35600s +03.39500s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.72800 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.73600 seconds

Finished stage: (azure-ds/_negotiate) 03.74100 seconds

Finished stage: (azure-ds/setup) 03.74100 seconds

Finished stage: (init-network/setup-datasource) 03.74200 seconds

|`->reading and applying user-data @06.78000s +00.00700s
|`->reading and applying vendor-data @06.78800s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @06.81400s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @06.81500s +00.11900s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.00000s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.08300 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.20200 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.20300 seconds

Finished stage: (azure-ds/activate) 00.20300 seconds

Finished stage: (init-network/activate-datasource) 00.20500 seconds

|`->config-migrator ran successfully @07.10100s +00.00100s
|`->config-seed_random ran successfully @07.10200s +00.00200s
|`->config-bootcmd ran successfully @07.10400s +00.00000s
|`->config-write-files ran successfully @07.10400s +00.00100s
|`->config-growpart ran successfully @07.10600s +00.65100s
|`->config-resizefs ran successfully @07.75700s +01.70800s
|`->config-disk_setup ran successfully @09.46500s +01.54800s
|`->config-mounts ran successfully @11.01300s +00.15400s
|`->config-set_hostname ran successfully @11.16700s +00.00700s
|`->config-update_hostname ran successfully @11.17400s +00.00200s
|`->config-update_etc_hosts ran successfully @11.17600s +00.00000s
|`->config-ca-certs ran successfully @11.17700s +00.00100s
|`->config-rsyslog ran successfully @11.17800s +00.00100s
|`->config-users-groups ran successfully @11.18000s +00.27200s
|`->config-ssh ran successfully @11.45200s +00.31800s
Finished stage: (init-network) 08.85300 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @17.55600s +00.00100s
|`->config-snap ran successfully @17.55700s +00.00100s
|`->config-snap_config ran successfully @17.55800s +00.00100s
|`->config-ssh-import-id ran successfully @17.56000s +00.80800s
|`->config-locale ran successfully @18.36800s +00.00200s
|`->config-set-passwords ran successfully @18.37100s +00.00100s
|`->config-grub-dpkg ran successfully @18.37200s +00.84200s
|`->config-apt-pipelining ran successfully @19.21400s +00.00200s
|`->config-apt-configure ran successfully @19.21600s +00.12100s
|`->config-ubuntu-advantage ran successfully @19.33800s +00.00100s
|`->config-ntp ran successfully @19.33900s +00.00100s
|`->config-timezone ran successfully @19.34000s +00.00100s
|`->config-disable-ec2-metadata ran successfully @19.34100s +00.00100s
|`->config-runcmd ran successfully @19.34200s +00.00100s
|`->config-byobu ran successfully @19.34300s +00.00100s
Finished stage: (modules-config) 01.80200 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @19.90900s +00.00200s
|`->config-package-update-upgrade-install ran successfully @19.91100s +00.00100s
|`->config-fan ran successfully @19.91300s +00.00000s
|`->config-landscape ran successfully @19.91400s +00.00100s
|`->config-lxd ran successfully @19.91500s +00.00100s
|`->config-ubuntu-drivers ran successfully @19.91600s +00.00100s
|`->config-puppet ran successfully @19.91700s +00.00100s
|`->config-chef ran successfully @19.91800s +00.00100s
|`->config-mcollective ran successfully @19.91900s +00.00100s
|`->config-salt-minion ran successfully @19.92000s +00.00100s
|`->config-rightscale_userdata ran successfully @19.92100s +00.00100s
|`->config-scripts-vendor ran successfully @19.92200s +00.00100s
|`->config-scripts-per-once ran successfully @19.92400s +00.00000s
|`->config-scripts-per-boot ran successfully @19.92500s +00.00000s
|`->config-scripts-per-instance ran successfully @19.92500s +00.00100s
|`->config-scripts-user ran successfully @19.92600s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @19.92800s +00.05800s
|`->config-keys-to-console ran successfully @19.98700s +00.01900s
|`->config-phone-home ran successfully @20.00600s +00.00100s
|`->config-final-message ran successfully @20.00700s +00.00500s
|`->config-power-state-change ran successfully @20.01200s +00.00100s
Finished stage: (modules-final) 00.13800 seconds

Total Time: 33.55500 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- cloud-init analyze blame
-- Boot Record 01 --
     03.39500s (azure-ds/_report_ready)
     01.70800s (init-network/config-resizefs)
     01.54800s (init-network/config-disk_setup)
     00.84200s (modules-config/config-grub-dpkg)
     00.80800s (modules-config/config-ssh-import-id)
     00.65100s (init-network/config-growpart)
     00.31800s (init-network/config-ssh)
     00.28300s (azure-ds/obtain-dhcp-lease)
     00.27200s (init-network/config-users-groups)
     00.15400s (init-network/config-mounts)
     00.14800s (azure-ds/generate_certificate)
     00.12100s (modules-config/config-apt-configure)
     00.11900s (azure-ds/_has_ntfs_filesystem)
     00.05800s (modules-final/config-ssh-authkey-fingerprints)
     00.03900s (azure-ds/list_possible_azure_ds_devs)
     00.03100s (init-network/check-cache)
     00.02600s (azure-ds/_get_metadata_from_imds)
     00.01900s (modules-final/config-keys-to-console)
     00.01400s (azure-ds/get_boot_telemetry)
     00.01200s (azure-ds/_decrypt_certs_from_xml)
     00.01100s (azure-ds/check-platform-viability)
     00.01000s (azure-ds/_run_x509_action)
     00.00700s (init-network/consume-user-data)
     00.00700s (init-network/config-set_hostname)
     00.00500s (modules-final/config-final-message)
     00.00500s (azure-ds/_run_x509_action)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (azure-ds/write_files)
     00.00200s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-per-once)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-fan)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Writing networking config: previous-network.out
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@104.209.172.221:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o+  LogLevel=ERROR ubuntu@104.209.172.221 -- sudo bash ./setup_proposed.sh
egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu bionic-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~18.04.1 [409 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~18.04.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~18.04.1) over (19.3-41-gc4735dd3-0ubuntu1~18.04.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~18.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- sudo cloud-init clean --logs --reboot
Connection to 104.209.172.221 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- cloud-init status --wait --long

status: done
time: Fri, 24 Jan 2020 00:20:38 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- sudo systemd-analyze blame
          2.409s systemd-networkd-wait-online.service
          2.084s cloud-config.service
          2.035s cloud-init.service
          1.538s cloud-init-local.service
          1.061s dev-sda1.device
           822ms keyboard-setup.service
           782ms snapd.service
           726ms cloud-final.service
           638ms lxd-containers.service
           523ms networkd-dispatcher.service
           496ms blk-availability.service
           386ms apparmor.service
           317ms grub-common.service
           248ms systemd-timesyncd.service
           244ms systemd-user-sessions.service
           242ms systemd-udev-trigger.service
           242ms rsyslog.service
           217ms accounts-daemon.service
           213ms ssh.service
           200ms systemd-modules-load.service
           176ms lvm2-monitor.service
           157ms systemd-logind.service
           151ms systemd-journald.service
           144ms ebtables.service
           126ms apport.service
           108ms systemd-journal-flush.service
            94ms systemd-resolved.service
            91ms systemd-remount-fs.service
            79ms sys-kernel-debug.mount
            77ms kmod-static-nodes.service
            74ms systemd-tmpfiles-setup.service
            71ms ufw.service
            69ms dev-mqueue.mount
            69ms dev-hugepages.mount
            52ms systemd-sysctl.service
            50ms systemd-udevd.service
            48ms polkit.service
            39ms setvtrgb.service
            37ms snapd.socket
            32ms boot-efi.mount
            31ms systemd-tmpfiles-setup-dev.service
            31ms systemd-networkd.service
            31ms user@1000.service
            30ms console-setup.service
            28ms lxd.socket
            25ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            24ms snapd.seeded.service
            22ms systemd-update-utmp.service
            18ms systemd-random-seed.service
            17ms plymouth-quit.service
            16ms sys-kernel-config.mount
            13ms sys-fs-fuse-connections.mount
            12ms plymouth-read-write.service
            11ms systemd-update-utmp-runlevel.service
             9ms ephemeral-disk-warning.service
             9ms plymouth-quit-wait.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00300s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.04400s +00.01100s
|`->get_boot_telemetry @00.05500s +00.01400s
|`->get_system_info @00.06900s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.07000s +00.19600s
|`->load_azure_ds_dir @00.26600s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.27000s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.27100s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.29300s +00.26700s
|`->_get_metadata_from_imds @00.56100s +00.01300s
Finished stage: (azure-ds/get_metadata_from_imds) 00.33700 seconds

|`->_get_random_seed @00.63000s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.57100 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.64000s +00.00100s
|`->write_files @00.64100s +00.00300s
Finished stage: (azure-ds/_get_data) 00.60000 seconds

Finished stage: (init-local/search-Azure) 00.60300 seconds

|`->network config from imds @00.69800s +00.00100s
Finished stage: (init-local) 00.84200 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.76900s +00.03200s
|`->network config from imds @03.84700s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.85900s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.86300s +00.15700s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @04.02100s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @04.04400s +00.01100s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @04.05600s +00.00500s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01600 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @04.07300s +00.00500s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.03500 seconds

|`->_report_ready @04.07900s +00.00600s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.22200 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.22300 seconds

Finished stage: (azure-ds/_negotiate) 00.22700 seconds

Finished stage: (azure-ds/setup) 00.22700 seconds

Finished stage: (init-network/setup-datasource) 00.22700 seconds

|`->reading and applying user-data @04.09200s +00.00800s
|`->reading and applying vendor-data @04.10000s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @04.12600s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @04.12700s +00.39000s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.39000 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.39200 seconds

Finished stage: (azure-ds/activate) 00.39200 seconds

Finished stage: (init-network/activate-datasource) 00.39400 seconds

|`->config-migrator ran successfully @04.53300s +00.00100s
|`->config-seed_random ran successfully @04.53400s +00.00200s
|`->config-bootcmd ran successfully @04.53600s +00.00000s
|`->config-write-files ran successfully @04.53600s +00.00100s
|`->config-growpart ran successfully @04.53700s +00.05000s
|`->config-resizefs ran successfully @04.58700s +00.02300s
|`->config-disk_setup ran successfully @04.61100s +00.11900s
|`->config-mounts ran successfully @04.73000s +00.12400s
|`->config-set_hostname ran successfully @04.85500s +00.00600s
|`->config-update_hostname ran successfully @04.86200s +00.00200s
|`->config-update_etc_hosts ran successfully @04.86400s +00.00000s
|`->config-ca-certs ran successfully @04.86400s +00.00100s
|`->config-rsyslog ran successfully @04.86600s +00.00000s
|`->config-users-groups ran successfully @04.86700s +00.18800s
|`->config-ssh ran successfully @05.05500s +00.27400s
Finished stage: (init-network) 01.57600 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @07.00500s +00.00000s
|`->config-snap ran successfully @07.00500s +00.00200s
|`->config-ssh-import-id ran successfully @07.00700s +00.89700s
|`->config-locale ran successfully @07.90400s +00.00400s
|`->config-set-passwords ran successfully @07.90900s +00.00100s
|`->config-grub-dpkg ran successfully @07.91000s +00.54000s
|`->config-apt-pipelining ran successfully @08.45000s +00.00200s
|`->config-apt-configure ran successfully @08.45200s +00.09200s
|`->config-ubuntu-advantage ran successfully @08.54500s +00.00100s
|`->config-ntp ran successfully @08.54600s +00.00200s
|`->config-timezone ran successfully @08.54900s +00.00000s
|`->config-disable-ec2-metadata ran successfully @08.55000s +00.00000s
|`->config-runcmd ran successfully @08.55000s +00.00100s
|`->config-byobu ran successfully @08.55100s +00.00100s
Finished stage: (modules-config) 01.56300 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @09.11400s +00.00100s
|`->config-fan ran successfully @09.11500s +00.00100s
|`->config-landscape ran successfully @09.11600s +00.00100s
|`->config-lxd ran successfully @09.11700s +00.00100s
|`->config-ubuntu-drivers ran successfully @09.11800s +00.00100s
|`->config-puppet ran successfully @09.11900s +00.00100s
|`->config-chef ran successfully @09.12000s +00.00100s
|`->config-mcollective ran successfully @09.12100s +00.00100s
|`->config-salt-minion ran successfully @09.12300s +00.00000s
|`->config-rightscale_userdata ran successfully @09.12400s +00.00000s
|`->config-scripts-vendor ran successfully @09.12500s +00.00000s
|`->config-scripts-per-once ran successfully @09.12600s +00.00100s
|`->config-scripts-per-boot ran successfully @09.12700s +00.00000s
|`->config-scripts-per-instance ran successfully @09.12700s +00.00100s
|`->config-scripts-user ran successfully @09.12900s +00.00000s
|`->config-ssh-authkey-fingerprints ran successfully @09.13000s +00.06500s
|`->config-keys-to-console ran successfully @09.19600s +00.09600s
|`->config-phone-home ran successfully @09.29300s +00.00200s
|`->config-final-message ran successfully @09.29500s +00.00500s
|`->config-power-state-change ran successfully @09.30100s +00.00100s
Finished stage: (modules-final) 00.20200 seconds

Total Time: 9.05800 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- cloud-init analyze blame
-- Boot Record 01 --
     00.89700s (modules-config/config-ssh-import-id)
     00.54000s (modules-config/config-grub-dpkg)
     00.39000s (azure-ds/_has_ntfs_filesystem)
     00.27400s (init-network/config-ssh)
     00.26700s (azure-ds/obtain-dhcp-lease)
     00.19600s (azure-ds/list_possible_azure_ds_devs)
     00.18800s (init-network/config-users-groups)
     00.15700s (azure-ds/generate_certificate)
     00.12400s (init-network/config-mounts)
     00.11900s (init-network/config-disk_setup)
     00.09600s (modules-final/config-keys-to-console)
     00.09200s (modules-config/config-apt-configure)
     00.06500s (modules-final/config-ssh-authkey-fingerprints)
     00.05000s (init-network/config-growpart)
     00.03200s (init-network/check-cache)
     00.02300s (init-network/config-resizefs)
     00.01400s (azure-ds/get_boot_telemetry)
     00.01300s (azure-ds/_get_metadata_from_imds)
     00.01100s (azure-ds/check-platform-viability)
     00.01100s (azure-ds/_decrypt_certs_from_xml)
     00.00800s (init-network/consume-user-data)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/_report_ready)
     00.00500s (modules-final/config-final-message)
     00.00500s (azure-ds/_run_x509_action)
     00.00500s (azure-ds/_run_x509_action)
     00.00400s (modules-config/config-locale)
     00.00300s (azure-ds/write_files)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-config/config-snap)
     00.00200s (modules-config/config-ntp)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-vendor)
     00.00000s (modules-final/config-scripts-user)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-config/config-timezone)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-rsyslog)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade write network config: upgrade-network.out
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- grep DHCP /var/log/syslog
+ echo ------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
------- Diff previous-network to post-upgrade-network ------
--- previous-network.out	2020-01-24 00:19:21.721606943 +0000
+++ upgrade-network.out	2020-01-24 00:21:07.235131831 +0000
@@ -48,7 +48,7 @@
        valid_lft forever preferred_lft forever
 2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 state UP qlen 1000
     inet6 ace:cab:deca:deed::4/128 scope global dynamic noprefixroute 
-       valid_lft 17279965sec preferred_lft 8639965sec
+       valid_lft 17279966sec preferred_lft 8639966sec
     inet6 fe80::20d:3aff:fe0f:23c4/64 scope link 
        valid_lft forever preferred_lft forever
 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 state UP qlen 1000
@@ -63,3 +63,12 @@
 Jan 24 00:18:48 SRU-worked-azure systemd-networkd[935]: eth1: DHCPv4 address 10.0.0.6/24
 Jan 24 00:18:48 SRU-worked-azure systemd-networkd[935]: eth1: DHCP: No routes received from DHCP server: No data available
 Jan 24 00:18:48 SRU-worked-azure systemd-networkd[935]: eth0: DHCPv6 address ace:cab:deca:deed::4/128 timeout preferred 8640000 valid 17280000
+Jan 24 00:20:34 SRU-worked-azure dhclient[845]: Internet Systems Consortium DHCP Client 4.3.5
+Jan 24 00:20:34 SRU-worked-azure dhclient[845]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0x40e5f16d)
+Jan 24 00:20:34 SRU-worked-azure dhclient[845]: DHCPREQUEST of 10.0.0.5 on eth0 to 255.255.255.255 port 67 (xid=0x6df1e540)
+Jan 24 00:20:34 SRU-worked-azure dhclient[845]: DHCPOFFER of 10.0.0.5 from 168.63.129.16
+Jan 24 00:20:34 SRU-worked-azure dhclient[845]: DHCPACK of 10.0.0.5 from 168.63.129.16
+Jan 24 00:20:34 SRU-worked-azure systemd-networkd[875]: eth0: DHCPv4 address 10.0.0.5/24 via 10.0.0.1
+Jan 24 00:20:34 SRU-worked-azure systemd-networkd[875]: eth1: DHCPv4 address 10.0.0.6/24
+Jan 24 00:20:34 SRU-worked-azure systemd-networkd[875]: eth1: DHCP: No routes received from DHCP server: No data available
+Jan 24 00:20:34 SRU-worked-azure systemd-networkd[875]: eth0: DHCPv6 address ace:cab:deca:deed::4/128 timeout preferred 8640000 valid 17280000
+ echo ------- Diff previous-network to post-upgrade-network ------
------- Diff previous-network to post-upgrade-network ------
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -oValidating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
 StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- sudo reboot
Connection to 104.209.172.221 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- cloud-init status --wait --long
ssh: connect to host 104.209.172.221 port 22: Connection timed out
+ echo After reboot
+ After reboot
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.209.172.221 -- grep 'Update datasource' /var/log/cloud-init.log
2020-01-24 00:20:29,188 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-24 00:21:43,247 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-24 00:23:14,618 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END bionic
### END bionic
+ echo ### BEGIN eoan
### BEGIN eoan
+ netcfg=/etc/netplan/50-cloud-init.yaml### BEGIN eoan

+ image_version=19.10-DAILY
+ [  =  ]
+ echo Creating standard network vm
+ Creating standard network vm
name=test-sru-eoan
+ az vm create --name=test-sru-eoan --image=Canonical:UbuntuServer:19.10-DAILY:latest --admin-username=root --admin-username=ubuntu -g srugroup --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Compute/virtualMachines/test-sru-eoan",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7D-57-CC",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.7",
  "publicIpAddress": "52.167.155.254",
  "resourceGroup": "srugroup",
  "zones": ""
}
+ az vm list-ip-addresses --name+  test-sru-eoan
jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.167.155.254
+ echo Created test-sru-eoan: ubuntu@ubuntu@52.167.155.254
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERRORCreated test-sru-eoan: ubuntu@ubuntu@52.167.155.254
 ubuntu@52.167.155.254 -- cloud-init status --wait --long
..
status: done
time: Thu, 23 Jan 2020 23:20:51 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- dpkg-query --show cloud-init
cloud-init	19.3-41-gc4735dd3-0ubuntu1~19.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- systemd-analyze
Startup finished in 3.971s (kernel) + 58.789s (userspace) = 1min 2.761s 
graphical.target reached after 57.542s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- systemd-analyze blame
         26.592s snapd.seeded.service
          9.862s cloud-init.service
          5.291s cloud-init-local.service
          3.213s cloud-config.service
          3.174s lvm2-monitor.service
          3.080s dev-sda1.device
          2.810s systemd-udev-settle.service
          2.165s pollinate.service
          1.558s snapd.service
          1.455s systemd-networkd-wait-online.service
          1.270s apparmor.service
          1.249s cloud-final.service
          1.231s accounts-daemon.service
          1.208s systemd-logind.service
           986ms apport.service
           930ms systemd-timesyncd.service
           832ms rsyslog.service
           724ms networkd-dispatcher.service
           669ms systemd-journald.service
           545ms systemd-resolved.service
           499ms systemd-udevd.service
           471ms systemd-udev-trigger.service
           459ms snap.lxd.activate.service
           434ms systemd-networkd.service
           410ms atd.service
           395ms systemd-modules-load.service
           390ms dev-mqueue.mount
           388ms keyboard-setup.service
           375ms ufw.service
           373ms grub-common.service
           352ms dev-hugepages.mount
           351ms grub-initrd-fallback.service
           351ms kmod-static-nodes.service
           336ms systemd-remount-fs.service
           271ms blk-availability.service
           250ms user@1000.service
           244ms multipathd.service
           235ms systemd-user-sessions.service
           202ms systemd-sysusers.service
           160ms systemd-random-seed.service
           134ms polkit.service
           130ms ssh.service
           123ms systemd-journal-flush.service
           121ms sys-kernel-debug.mount
           113ms systemd-tmpfiles-setup.service
           105ms finalrd.service
           103ms systemd-machine-id-commit.service
            99ms sys-kernel-config.mount
            96ms console-setup.service
            90ms ephemeral-disk-warning.service
            87ms plymouth-read-write.service
            83ms systemd-sysctl.service
            80ms sys-fs-fuse-connections.mount
            67ms systemd-tmpfiles-setup-dev.service
            64ms plymouth-quit.service
            57ms plymouth-quit-wait.service
            55ms systemd-update-utmp.service
            48ms systemd-update-utmp-runlevel.service
            40ms snap-core-8268.mount
            37ms user-runtime-dir@1000.service
            36ms setvtrgb.service
            34ms boot-efi.mount
            33ms snap-lxd-12631.mount
            30ms snapd.socket
            23ms dev-loop0.device
            22ms dev-loop1.device
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.15300s +00.01000s
|`->get_boot_telemetry @00.16300s +00.08100s
|`->get_system_info @00.24400s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.24500s +00.05600s
|`->load_azure_ds_dir @00.30200s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.42800s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.42900s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01100 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.47400s +00.40000s
|`->_get_metadata_from_imds @00.87400s +00.02400s
Finished stage: (azure-ds/get_metadata_from_imds) 00.44500 seconds

|`->_get_random_seed @00.92000s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.68500 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.93000s +00.00000s
|`->write_files @00.93100s +00.00200s
Finished stage: (azure-ds/_get_data) 00.78000 seconds

Finished stage: (init-local/search-Azure) 00.78200 seconds

|`->network config from imds @00.98600s +00.00100s
Finished stage: (init-local) 01.18100 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.61700s +00.02200s
|`->network config from imds @03.70100s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.71100s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.71400s +00.13500s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.84900s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.87000s +00.01300s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.88300s +00.00700s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.05100 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.93400s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.07100 seconds

|`->_report_ready @03.94100s +03.07500s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.30200 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.30300 seconds

Finished stage: (azure-ds/_negotiate) 03.30700 seconds

Finished stage: (azure-ds/setup) 03.30700 seconds

Finished stage: (init-network/setup-datasource) 03.30800 seconds

|`->reading and applying user-data @07.02700s +00.00800s
|`->reading and applying vendor-data @07.03500s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @07.07500s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @07.07600s +00.15700s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.32400s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.10300 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.26100 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.26200 seconds

Finished stage: (azure-ds/activate) 00.26200 seconds

Finished stage: (init-network/activate-datasource) 00.26300 seconds

|`->config-migrator ran successfully @07.39800s +00.00100s
|`->config-seed_random ran successfully @07.39900s +00.00200s
|`->config-bootcmd ran successfully @07.40100s +00.00000s
|`->config-write-files ran successfully @07.40200s +00.00000s
|`->config-growpart ran successfully @07.40300s +00.86400s
|`->config-resizefs ran successfully @08.26700s +01.28000s
|`->config-disk_setup ran successfully @09.54700s +02.44800s
|`->config-mounts ran successfully @12.00000s +00.27100s
|`->config-set_hostname ran successfully @12.27200s +00.00800s
|`->config-update_hostname ran successfully @12.28100s +00.00100s
|`->config-update_etc_hosts ran successfully @12.28200s +00.00100s
|`->config-ca-certs ran successfully @12.28300s +00.00100s
|`->config-rsyslog ran successfully @12.28400s +00.00100s
|`->config-users-groups ran successfully @12.28500s +00.28600s
|`->config-ssh ran successfully @12.57100s +00.36700s
Finished stage: (init-network) 09.34300 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @43.56100s +00.00000s
|`->config-snap ran successfully @43.56200s +00.00100s
|`->config-snap_config ran successfully @43.56300s +00.00100s
|`->config-ssh-import-id ran successfully @43.56800s +01.07700s
|`->config-locale ran successfully @44.64600s +00.00100s
|`->config-set-passwords ran successfully @44.64800s +00.00400s
|`->config-grub-dpkg ran successfully @44.65200s +01.20700s
|`->config-apt-pipelining ran successfully @45.86000s +00.00200s
|`->config-apt-configure ran successfully @45.86200s +00.13900s
|`->config-ubuntu-advantage ran successfully @46.00200s +00.00100s
|`->config-ntp ran successfully @46.00300s +00.00100s
|`->config-timezone ran successfully @46.00400s +00.00500s
|`->config-disable-ec2-metadata ran successfully @46.00900s +00.00100s
|`->config-runcmd ran successfully @46.01000s +00.00100s
|`->config-byobu ran successfully @46.01100s +00.00100s
Finished stage: (modules-config) 02.52200 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @47.07300s +00.00200s
|`->config-package-update-upgrade-install ran successfully @47.08100s +00.00100s
|`->config-fan ran successfully @47.08200s +00.00100s
|`->config-landscape ran successfully @47.08300s +00.00100s
|`->config-lxd ran successfully @47.08800s +00.00100s
|`->config-ubuntu-drivers ran successfully @47.09000s +00.00000s
|`->config-puppet ran successfully @47.09100s +00.00000s
|`->config-chef ran successfully @47.09200s +00.00400s
|`->config-mcollective ran successfully @47.09600s +00.00100s
|`->config-salt-minion ran successfully @47.09800s +00.00000s
|`->config-rightscale_userdata ran successfully @47.09900s +00.00000s
|`->config-scripts-vendor ran successfully @47.10200s +00.00100s
|`->config-scripts-per-once ran successfully @47.10300s +00.00100s
|`->config-scripts-per-boot ran successfully @47.10900s +00.00000s
|`->config-scripts-per-instance ran successfully @47.11000s +00.00000s
|`->config-scripts-user ran successfully @47.11100s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @47.11200s +00.12900s
|`->config-keys-to-console ran successfully @47.24200s +00.20900s
|`->config-phone-home ran successfully @47.45200s +00.00100s
|`->config-final-message ran successfully @47.45300s +00.00500s
|`->config-power-state-change ran successfully @47.45800s +00.00100s
Finished stage: (modules-final) 00.41400 seconds

Total Time: 33.97700 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- cloud-init analyze blame
-- Boot Record 01 --
     03.07500s (azure-ds/_report_ready)
     02.44800s (init-network/config-disk_setup)
     01.28000s (init-network/config-resizefs)
     01.20700s (modules-config/config-grub-dpkg)
     01.07700s (modules-config/config-ssh-import-id)
     00.86400s (init-network/config-growpart)
     00.40000s (azure-ds/obtain-dhcp-lease)
     00.36700s (init-network/config-ssh)
     00.28600s (init-network/config-users-groups)
     00.27100s (init-network/config-mounts)
     00.20900s (modules-final/config-keys-to-console)
     00.15700s (azure-ds/_has_ntfs_filesystem)
     00.13900s (modules-config/config-apt-configure)
     00.13500s (azure-ds/generate_certificate)
     00.12900s (modules-final/config-ssh-authkey-fingerprints)
     00.08100s (azure-ds/get_boot_telemetry)
     00.05600s (azure-ds/list_possible_azure_ds_devs)
     00.02400s (azure-ds/_get_metadata_from_imds)
     00.02200s (init-network/check-cache)
     00.01300s (azure-ds/_decrypt_certs_from_xml)
     00.01000s (azure-ds/check-platform-viability)
     00.00800s (init-network/consume-user-data)
     00.00800s (init-network/config-set_hostname)
     00.00700s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00500s (modules-config/config-timezone)
     00.00400s (modules-final/config-chef)
     00.00400s (modules-config/config-set-passwords)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-seed_random)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-locale)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (modules-final/config-ubuntu-drivers)
     00.00000s (modules-final/config-scripts-per-instance)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-puppet)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (init-network/config-write-files)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Writing networking config: previous-network.out
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@52.167.155.254:.
+ + sshegrep -o cloud-init StrictHostKeyChecking=no
 -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- sudo bash ./setup_proposed.sh
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu eoan-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~19.10.1 [405 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~19.10.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~19.10.1) over (19.3-41-gc4735dd3-0ubuntu1~19.10.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~19.10.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~19.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- sudo cloud-init clean --logs --reboot
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- cloud-init status --wait --long

status: done
time: Thu, 23 Jan 2020 23:22:21 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- sudo systemd-analyze blame
          2.878s cloud-config.service
          2.762s cloud-init.service
          2.652s snap.lxd.activate.service
          2.448s snapd.service
          2.350s lvm2-monitor.service
          2.142s dev-sda1.device
          1.936s cloud-init-local.service
          1.915s systemd-logind.service
          1.793s systemd-networkd-wait-online.service
          1.770s systemd-udev-settle.service
          1.495s accounts-daemon.service
          1.403s apport.service
           947ms networkd-dispatcher.service
           847ms systemd-timesyncd.service
           847ms cloud-final.service
           801ms rsyslog.service
           730ms systemd-journald.service
           682ms grub-common.service
           566ms systemd-user-sessions.service
           529ms grub-initrd-fallback.service
           467ms systemd-udev-trigger.service
           426ms ssh.service
           331ms systemd-resolved.service
           329ms polkit.service
           312ms dev-loop0.device
           305ms ufw.service
           300ms dev-hugepages.mount
           298ms keyboard-setup.service
           298ms dev-mqueue.mount
           296ms kmod-static-nodes.service
           288ms systemd-networkd.service
           286ms blk-availability.service
           263ms snapd.socket
           214ms atd.service
           212ms apparmor.service
           207ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
           187ms plymouth-quit-wait.service
           174ms systemd-remount-fs.service
           172ms plymouth-quit.service
           167ms systemd-modules-load.service
           141ms systemd-sysusers.service
           131ms systemd-tmpfiles-setup.service
           130ms plymouth-read-write.service
           130ms finalrd.service
           127ms console-setup.service
           124ms sys-kernel-debug.mount
           117ms systemd-random-seed.service
           101ms sys-fs-fuse-connections.mount
            99ms snapd.seeded.service
            99ms systemd-update-utmp.service
            99ms user@1000.service
            92ms sys-kernel-config.mount
            91ms setvtrgb.service
            88ms boot-efi.mount
            88ms systemd-sysctl.service
            84ms systemd-journal-flush.service
            83ms snap-core-8268.mount
            71ms snap-lxd-12631.mount
            58ms systemd-udevd.service
            58ms multipathd.service
            42ms dev-loop1.device
            38ms systemd-tmpfiles-setup-dev.service
            29ms systemd-update-utmp-runlevel.service
            22ms user-runtime-dir@1000.service
            14ms ephemeral-disk-warning.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.05300s +00.01000s
|`->get_boot_telemetry @00.06300s +00.01800s
|`->get_system_info @00.08100s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.08100s +00.23300s
|`->load_azure_ds_dir @00.31400s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.31800s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.31900s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.34000s +00.15700s
|`->_get_metadata_from_imds @00.49700s +00.00900s
Finished stage: (azure-ds/get_metadata_from_imds) 00.19300 seconds

|`->_get_random_seed @00.53300s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.46200 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.54400s +00.00000s
|`->write_files @00.54400s +00.00300s
Finished stage: (azure-ds/_get_data) 00.49400 seconds

Finished stage: (init-local/search-Azure) 00.49600 seconds

|`->network config from imds @00.60000s +00.00000s
Finished stage: (init-local) 00.71500 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.36200s +00.02300s
|`->network config from imds @03.44800s +00.00100s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.45800s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.46100s +00.17500s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.63600s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.65500s +00.01200s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.66800s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01400 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.68100s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.03200 seconds

|`->_report_ready @03.68700s +00.00600s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.23200 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.23300 seconds

Finished stage: (azure-ds/_negotiate) 00.23600 seconds

Finished stage: (azure-ds/setup) 00.23600 seconds

Finished stage: (init-network/setup-datasource) 00.23700 seconds

|`->reading and applying user-data @03.70100s +00.00700s
|`->reading and applying vendor-data @03.70800s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.74500s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.74500s +00.15800s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.15800 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.15800 seconds

Finished stage: (azure-ds/activate) 00.15800 seconds

Finished stage: (init-network/activate-datasource) 00.16100 seconds

|`->config-migrator ran successfully @03.94600s +00.00100s
|`->config-seed_random ran successfully @03.94800s +00.00100s
|`->config-bootcmd ran successfully @03.95500s +00.00000s
|`->config-write-files ran successfully @03.95600s +00.00100s
|`->config-growpart ran successfully @03.95700s +00.12100s
|`->config-resizefs ran successfully @04.07800s +00.15800s
|`->config-disk_setup ran successfully @04.23700s +00.63700s
|`->config-mounts ran successfully @04.87400s +00.24500s
|`->config-set_hostname ran successfully @05.11900s +00.00700s
|`->config-update_hostname ran successfully @05.12700s +00.00100s
|`->config-update_etc_hosts ran successfully @05.12800s +00.00100s
|`->config-ca-certs ran successfully @05.12900s +00.00100s
|`->config-rsyslog ran successfully @05.13000s +00.00100s
|`->config-users-groups ran successfully @05.13200s +00.06000s
|`->config-ssh ran successfully @05.19300s +00.38500s
Finished stage: (init-network) 02.23200 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @10.88800s +00.00000s
|`->config-snap ran successfully @10.89100s +00.00000s
|`->config-ssh-import-id ran successfully @10.89200s +00.98200s
|`->config-locale ran successfully @11.87400s +00.00200s
|`->config-set-passwords ran successfully @11.87600s +00.00100s
|`->config-grub-dpkg ran successfully @11.87700s +00.52300s
|`->config-apt-pipelining ran successfully @12.40100s +00.00100s
|`->config-apt-configure ran successfully @12.40200s +00.09600s
|`->config-ubuntu-advantage ran successfully @12.49900s +00.00100s
|`->config-ntp ran successfully @12.50100s +00.00000s
|`->config-timezone ran successfully @12.50200s +00.00100s
|`->config-disable-ec2-metadata ran successfully @12.50300s +00.00000s
|`->config-runcmd ran successfully @12.50400s +00.00000s
|`->config-byobu ran successfully @12.50500s +00.00100s
Finished stage: (modules-config) 01.64800 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @13.15200s +00.00100s
|`->config-fan ran successfully @13.15300s +00.00100s
|`->config-landscape ran successfully @13.15500s +00.00000s
|`->config-lxd ran successfully @13.15600s +00.00100s
|`->config-ubuntu-drivers ran successfully @13.15700s +00.00100s
|`->config-puppet ran successfully @13.15800s +00.00100s
|`->config-chef ran successfully @13.15900s +00.00100s
|`->config-mcollective ran successfully @13.16000s +00.00100s
|`->config-salt-minion ran successfully @13.16200s +00.00000s
|`->config-rightscale_userdata ran successfully @13.16300s +00.00000s
|`->config-scripts-vendor ran successfully @13.16400s +00.00100s
|`->config-scripts-per-once ran successfully @13.16500s +00.00100s
|`->config-scripts-per-boot ran successfully @13.16600s +00.00000s
|`->config-scripts-per-instance ran successfully @13.16700s +00.00100s
|`->config-scripts-user ran successfully @13.16800s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @13.16900s +00.01600s
|`->config-keys-to-console ran successfully @13.18500s +00.12600s
|`->config-phone-home ran successfully @13.31200s +00.00100s
|`->config-final-message ran successfully @13.31400s +00.04400s
|`->config-power-state-change ran successfully @13.35900s +00.00000s
Finished stage: (modules-final) 00.22400 seconds

Total Time: 8.33600 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- cloud-init analyze blame
-- Boot Record 01 --
     00.98200s (modules-config/config-ssh-import-id)
     00.63700s (init-network/config-disk_setup)
     00.52300s (modules-config/config-grub-dpkg)
     00.38500s (init-network/config-ssh)
     00.24500s (init-network/config-mounts)
     00.23300s (azure-ds/list_possible_azure_ds_devs)
     00.17500s (azure-ds/generate_certificate)
     00.15800s (init-network/config-resizefs)
     00.15800s (azure-ds/_has_ntfs_filesystem)
     00.15700s (azure-ds/obtain-dhcp-lease)
     00.12600s (modules-final/config-keys-to-console)
     00.12100s (init-network/config-growpart)
     00.09600s (modules-config/config-apt-configure)
     00.06000s (init-network/config-users-groups)
     00.04400s (modules-final/config-final-message)
     00.02300s (init-network/check-cache)
     00.01800s (azure-ds/get_boot_telemetry)
     00.01600s (modules-final/config-ssh-authkey-fingerprints)
     00.01200s (azure-ds/_decrypt_certs_from_xml)
     00.01000s (azure-ds/check-platform-viability)
     00.00900s (azure-ds/_get_metadata_from_imds)
     00.00700s (init-network/consume-user-data)
     00.00700s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_report_ready)
     00.00300s (azure-ds/write_files)
     00.00200s (modules-config/config-locale)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-salt-minion)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-power-state-change)
     00.00000s (modules-final/config-landscape)
     00.00000s (modules-config/config-snap)
     00.00000s (modules-config/config-runcmd)
     00.00000s (modules-config/config-ntp)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade write network config: upgrade-network.out
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- grep DHCP /var/log/syslog
+ echo ------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
------- Diff previous-network to post-upgrade-network ------
--- previous-network.out	2020-01-23 23:21:07.398299354 +0000
+++ upgrade-network.out	2020-01-23 23:22:54.680022699 +0000
@@ -38,3 +38,9 @@
 Jan 23 23:20:18 SRU-worked-azure dhclient[500]: DHCPREQUEST for 10.0.0.7 on eth0 to 255.255.255.255 port 67 (xid=0x729f89ae)
 Jan 23 23:20:18 SRU-worked-azure dhclient[500]: DHCPACK of 10.0.0.7 from 168.63.129.16 (xid=0xae899f72)
 Jan 23 23:20:18 SRU-worked-azure systemd-networkd[525]: eth0: DHCPv4 address 10.0.0.7/24 via 10.0.0.1
+Jan 23 23:22:15 SRU-worked-azure dhclient[521]: Internet Systems Consortium DHCP Client 4.4.1
+Jan 23 23:22:15 SRU-worked-azure dhclient[521]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0x7be1ba6d)
+Jan 23 23:22:15 SRU-worked-azure dhclient[521]: DHCPOFFER of 10.0.0.7 from 168.63.129.16
+Jan 23 23:22:15 SRU-worked-azure dhclient[521]: DHCPREQUEST for 10.0.0.7 on eth0 to 255.255.255.255 port 67 (xid=0x6dbae17b)
+Jan 23 23:22:15 SRU-worked-azure dhclient[521]: DHCPACK of 10.0.0.7 from 168.63.129.16 (xid=0x7be1ba6d)
+Jan 23 23:22:15 SRU-worked-azure systemd-networkd[546]: eth0: DHCPv4 address 10.0.0.7/24 via 10.0.0.1
+ echo ------- Diff previous-network to post-upgrade-network ------
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null------- Diff previous-network to post-upgrade-network ------
 -o LogLevel=ERROR ubuntu@52.167.155.254 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
+ ssh -o StrictHostKeyChecking=no -oGet cloud-id
 UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERRORValidating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
 ubuntu@52.167.155.254 -- sudo reboot
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.167.155.254 -- cloud-init status --wait --long

status: done
time: Thu, 23 Jan 2020 23:23:32 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/nullAfter reboot
 -o LogLevel=ERROR ubuntu@52.167.155.254 -- grep 'Update datasource' /var/log/cloud-init.log
2020-01-23 23:22:08,108 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-23 23:23:21,173 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-23 23:23:21,670 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ [  = --nics sruNic-eoan sruNic2-eoan --size Standard_DS2_v2 ]
+ [ true = false ]
+ echo Creating advanced network vm
+ name=test-sru-eoan-advanced
Creating advanced network vm
+ az network public-ip create --name vmPublicIP-IPv4-eoan --resource-group srugroup --location eastus2 --sku BASIC --allocation-method dynamic --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"ab7e6b16-2237-4c4a-895d-3a520af3c4fd\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/vmPublicIP-IPv4-eoan",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "vmPublicIP-IPv4-eoan",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroup",
    "resourceGuid": "f587d1aa-162c-4c45-b000-be3b4e0838ee",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name lbPublicIP_v4_eoan --resource-group srugroup --location eastus2 --sku BASIC --allocation-method dynamic --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"970211ae-33ca-41bb-a7b8-726a44c542d2\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v4_eoan",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "lbPublicIP_v4_eoan",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroup",
    "resourceGuid": "834b1f3a-da32-44e4-90dc-950004a53896",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name lbPublicIP_v6_eoan --resource-group srugroup --location eastus2 --sku BASIC --allocation-method dynamic --version IPv6
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"86c7c4a8-74dd-40cd-9ed4-351fee529dcc\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v6_eoan",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "lbPublicIP_v6_eoan",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv6",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroup",
    "resourceGuid": "5ef2676a-f267-448a-a4e3-ce18119124fc",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network lb create --name dsLB_eoan --resource-group srugroup --sku Basic --location eastus2 --frontend-ip-name dsLbFrontEnd_v4_eoan --public-ip-address lbPublicIP_v4_eoan --backend-pool-name dsLbBackEndPool_v4_eoan
{
  "loadBalancer": {
    "backendAddressPools": [
      {
        "etag": "W/\"4aa01a19-a7a9-449c-956a-2513f675f1a0\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/backendAddressPools/dsLbBackEndPool_v4_eoan",
        "name": "dsLbBackEndPool_v4_eoan",
        "properties": {
          "provisioningState": "Succeeded"
        },
        "resourceGroup": "srugroup",
        "type": "Microsoft.Network/loadBalancers/backendAddressPools"
      }
    ],
    "frontendIPConfigurations": [
      {
        "etag": "W/\"4aa01a19-a7a9-449c-956a-2513f675f1a0\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/frontendIPConfigurations/dsLbFrontEnd_v4_eoan",
        "name": "dsLbFrontEnd_v4_eoan",
        "properties": {
          "privateIPAddressVersion": "IPv4",
          "privateIPAllocationMethod": "Dynamic",
          "provisioningState": "Succeeded",
          "publicIPAddress": {
            "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v4_eoan",
            "resourceGroup": "srugroup"
          }
        },
        "resourceGroup": "srugroup",
        "type": "Microsoft.Network/loadBalancers/frontendIPConfigurations"
      }
    ],
    "inboundNatPools": [],
    "inboundNatRules": [],
    "loadBalancingRules": [],
    "probes": [],
    "provisioningState": "Succeeded",
    "resourceGuid": "8438de51-99c0-4eb9-a937-7e27905ca4bc"
  }
}
+ az network lb frontend-ip create --lb-name dsLB_eoan --name dsLbFrontEnd_v6_eoan --resource-group srugroup --public-ip-address lbPublicIP_v6_eoan
{
  "etag": "W/\"ec7fcb68-13c8-46b8-a8d1-ddde44cc2e7c\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/frontendIPConfigurations/dsLbFrontEnd_v6_eoan",
  "inboundNatPools": null,
  "inboundNatRules": null,
  "loadBalancingRules": null,
  "name": "dsLbFrontEnd_v6_eoan",
  "outboundRules": null,
  "privateIpAddress": null,
  "privateIpAddressVersion": "IPv4",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v6_eoan",
    "idleTimeoutInMinutes": null,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": null,
    "location": null,
    "name": null,
    "provisioningState": null,
    "publicIpAddressVersion": null,
    "publicIpAllocationMethod": null,
    "publicIpPrefix": null,
    "resourceGroup": "srugroup",
    "resourceGuid": null,
    "sku": null,
    "tags": null,
    "type": null,
    "zones": null
  },
  "publicIpPrefix": null,
  "resourceGroup": "srugroup",
  "subnet": null,
  "type": "Microsoft.Network/loadBalancers/frontendIPConfigurations",
  "zones": null
}
+ az network lb address-pool create --lb-name dsLB_eoan --name dsLbBackEndPool_v6_eoan --resource-group srugroup
{
  "backendIpConfigurations": null,
  "etag": "W/\"18d11522-f0f0-4d91-8c9a-3d4e8bb4d3a8\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/backendAddressPools/dsLbBackEndPool_v6_eoan",
  "loadBalancingRules": null,
  "name": "dsLbBackEndPool_v6_eoan",
  "outboundRule": null,
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroup",
  "type": "Microsoft.Network/loadBalancers/backendAddressPools"
}
+ az network lb probe create -g srugroup --lb-name dsLB_eoan -n dsProbe_eoan --protocol tcp --port 22
{
  "etag": "W/\"53711e22-d7cf-4b6a-ab16-490c3db13f5f\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/probes/dsProbe_eoan",
  "intervalInSeconds": 15,
  "loadBalancingRules": null,
  "name": "dsProbe_eoan",
  "numberOfProbes": 2,
  "port": 22,
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "requestPath": null,
  "resourceGroup": "srugroup",
  "type": "Microsoft.Network/loadBalancers/probes"
}
+ az network lb rule create --lb-name dsLB_eoan --name dsLBrule_v4_eoan --resource-group srugroup --frontend-ip-name dsLbFrontEnd_v4_eoan --protocol Tcp --frontend-port 22 --backend-port 22 --probe-name dsProbe_eoan --backend-pool-name dsLbBackEndPool_v4_eoan
{
  "backendAddressPool": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/backendAddressPools/dsLbBackEndPool_v4_eoan",
    "resourceGroup": "srugroup"
  },
  "backendPort": 22,
  "disableOutboundSnat": null,
  "enableFloatingIp": false,
  "enableTcpReset": false,
  "etag": "W/\"aa3f03bd-b36e-4536-9c0b-6d96f4a7cba2\"",
  "frontendIpConfiguration": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/frontendIPConfigurations/dsLbFrontEnd_v4_eoan",
    "resourceGroup": "srugroup"
  },
  "frontendPort": 22,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/loadBalancingRules/dsLBrule_v4_eoan",
  "idleTimeoutInMinutes": 4,
  "loadDistribution": "Default",
  "name": "dsLBrule_v4_eoan",
  "probe": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/probes/dsProbe_eoan",
    "resourceGroup": "srugroup"
  },
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroup",
  "type": "Microsoft.Network/loadBalancers/loadBalancingRules"
}
+ az network lb rule create --lb-name dsLB_eoan --name dsLBrule_v6_eoan --resource-group srugroup --frontend-ip-name dsLbFrontEnd_v6_eoan --protocol Tcp --frontend-port 22 --backend-port 22 --probe-name dsProbe_eoan --backend-pool-name dsLbBackEndPool_v6_eoan
{
  "backendAddressPool": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/backendAddressPools/dsLbBackEndPool_v6_eoan",
    "resourceGroup": "srugroup"
  },
  "backendPort": 22,
  "disableOutboundSnat": null,
  "enableFloatingIp": false,
  "enableTcpReset": false,
  "etag": "W/\"02d8907c-2503-4d3c-a429-eff24e7cfd38\"",
  "frontendIpConfiguration": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/frontendIPConfigurations/dsLbFrontEnd_v6_eoan",
    "resourceGroup": "srugroup"
  },
  "frontendPort": 22,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/loadBalancingRules/dsLBrule_v6_eoan",
  "idleTimeoutInMinutes": 4,
  "loadDistribution": "Default",
  "name": "dsLBrule_v6_eoan",
  "probe": {
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/probes/dsProbe_eoan",
    "resourceGroup": "srugroup"
  },
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroup",
  "type": "Microsoft.Network/loadBalancers/loadBalancingRules"
}
+ az vm availability-set create --name dsAVset_eoan --resource-group srugroup --location eastus2 --platform-fault-domain-count 2 --platform-update-domain-count 2
{
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Compute/availabilitySets/dsAVset_eoan",
  "location": "eastus2",
  "name": "dsAVset_eoan",
  "platformFaultDomainCount": 2,
  "platformUpdateDomainCount": 2,
  "proximityPlacementGroup": null,
  "resourceGroup": "srugroup",
  "sku": {
    "capacity": null,
    "name": "Aligned",
    "tier": null
  },
  "statuses": null,
  "tags": {},
  "type": "Microsoft.Compute/availabilitySets",
  "virtualMachines": []
}
+ az network nic create --name sruNic-eoan --resource-group srugroup --network-security-group sruNetSecGroup --vnet-name sruVnet --accelerated-networking true --subnet sruSubnet --private-ip-address-version IPv4 --lb-address-pools dsLbBackEndPool_v4_eoan --lb-name dsLB_eoan --public-ip-address vmPublicIP-IPv4-eoan
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "uf3fodizdaiezen3rqv3vvb4xd.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"076f2eef-d528-4629-89a3-edcb8eefa69f\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic-eoan",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"076f2eef-d528-4629-89a3-edcb8eefa69f\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic-eoan/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": [
          {
            "backendIpConfigurations": null,
            "etag": null,
            "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/backendAddressPools/dsLbBackEndPool_v4_eoan",
            "loadBalancingRules": null,
            "name": null,
            "outboundRule": null,
            "provisioningState": null,
            "resourceGroup": "srugroup"
          }
        ],
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "10.0.0.8",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": {
          "ddosSettings": null,
          "dnsSettings": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/publicIPAddresses/vmPublicIP-IPv4-eoan",
          "idleTimeoutInMinutes": null,
          "ipAddress": null,
          "ipConfiguration": null,
          "ipTags": null,
          "location": null,
          "name": null,
          "provisioningState": null,
          "publicIpAddressVersion": null,
          "publicIpAllocationMethod": null,
          "publicIpPrefix": null,
          "resourceGroup": "srugroup",
          "resourceGuid": null,
          "sku": null,
          "tags": null,
          "type": null,
          "zones": null
        },
        "resourceGroup": "srugroup",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroup",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic-eoan",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroup",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroup",
    "resourceGuid": "55f28b11-39e8-4f17-99c6-c87762fb0351",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic create --name sruNic2-eoan --resource-group srugroup --network-security-group sruNetSecGroup --vnet-name sruVnet --accelerated-networking true --subnet sruSubnet --private-ip-address-version IPv4
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "uf3fodizdaiezen3rqv3vvb4xd.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"8e30819f-9c69-4699-a1c0-088b712d30fd\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic2-eoan",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"8e30819f-9c69-4699-a1c0-088b712d30fd\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic2-eoan/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "10.0.0.9",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": null,
        "resourceGroup": "srugroup",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroup",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic2-eoan",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroup",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroup",
    "resourceGuid": "e967ac9d-685a-4973-9318-9166b3fd891f",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic ip-config create --name sruNic-eoan-v6 --nic-name sruNic-eoan --resource-group srugroup --vnet-name sruVnet --subnet sruSubnet --lb-address-pools dsLbBackEndPool_v6_eoan --lb-name dsLB_eoan --private-ip-address-version IPv6
{
  "applicationGatewayBackendAddressPools": null,
  "applicationSecurityGroups": null,
  "etag": "W/\"c5831f3a-a775-4774-b367-063e68372944\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/networkInterfaces/sruNic-eoan/ipConfigurations/sruNic-eoan-v6",
  "loadBalancerBackendAddressPools": [
    {
      "backendIpConfigurations": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/loadBalancers/dsLB_eoan/backendAddressPools/dsLbBackEndPool_v6_eoan",
      "loadBalancingRules": null,
      "name": null,
      "outboundRule": null,
      "provisioningState": null,
      "resourceGroup": "srugroup"
    }
  ],
  "loadBalancerInboundNatRules": null,
  "name": "sruNic-eoan-v6",
  "primary": null,
  "privateIpAddress": "ace:cab:deca:deed::5",
  "privateIpAddressVersion": "IPv6",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": null,
  "resourceGroup": "srugroup",
  "subnet": {
    "addressPrefix": null,
    "addressPrefixes": null,
    "delegations": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
    "ipConfigurationProfiles": null,
    "ipConfigurations": null,
    "name": null,
    "natGateway": null,
    "networkSecurityGroup": null,
    "privateEndpointNetworkPolicies": null,
    "privateEndpoints": null,
    "privateLinkServiceNetworkPolicies": null,
    "provisioningState": null,
    "purpose": null,
    "resourceGroup": "srugroup",
    "resourceNavigationLinks": null,
    "routeTable": null,
    "serviceAssociationLinks": null,
    "serviceEndpointPolicies": null,
    "serviceEndpoints": null
  },
  "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
  "virtualNetworkTaps": null
}
+ az vm create --name=test-sru-eoan-advanced --image=Canonical:UbuntuServer:19.10-DAILY:latest --admin-username=root --admin-username=ubuntu -g srugroup --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml --nics sruNic-eoan sruNic2-eoan --size Standard_DS2_v2
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroup/providers/Microsoft.Compute/virtualMachines/test-sru-eoan-advanced",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7C-37-37,00-0D-3A-7C-3C-B7",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.8,ace:cab:deca:deed::5,10.0.0.9",
  "publicIpAddress": "52.177.65.35",
  "resourceGroup": "srugroup",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-eoan-advanced
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.177.65.35
+ echo Created test-sru-eoan-advanced: ubuntu@ubuntu@52.177.65.35
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- cloud-init status --wait --long
Created test-sru-eoan-advanced: ubuntu@ubuntu@52.177.65.35
..
status: done
time: Thu, 23 Jan 2020 23:33:02 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- dpkg-query --show cloud-init
cloud-init	19.3-41-gc4735dd3-0ubuntu1~19.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- systemd-analyze
Startup finished in 3.746s (kernel) + 50.677s (userspace) = 54.423s 
graphical.target reached after 49.891s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- systemd-analyze blame
         22.494s snapd.seeded.service
          8.911s cloud-init.service
          5.290s cloud-init-local.service
          2.672s lvm2-monitor.service
          2.631s cloud-config.service
          2.558s dev-sdb1.device
          2.405s systemd-udev-settle.service
          2.328s pollinate.service
          1.693s accounts-daemon.service
          1.345s snapd.service
          1.343s systemd-networkd-wait-online.service
           780ms cloud-final.service
           640ms networkd-dispatcher.service
           589ms apparmor.service
           528ms systemd-resolved.service
           520ms snap.lxd.activate.service
           515ms systemd-logind.service
           500ms systemd-udevd.service
           487ms rsyslog.service
           465ms systemd-timesyncd.service
           400ms systemd-networkd.service
           346ms grub-initrd-fallback.service
           345ms systemd-journald.service
           284ms apport.service
           279ms grub-common.service
           258ms keyboard-setup.service
           247ms systemd-udev-trigger.service
           238ms multipathd.service
           187ms user@1000.service
           176ms systemd-sysusers.service
           141ms sys-kernel-debug.mount
           138ms systemd-modules-load.service
           137ms systemd-user-sessions.service
           135ms systemd-journal-flush.service
           131ms systemd-remount-fs.service
           120ms setvtrgb.service
           118ms ssh.service
           118ms ufw.service
           113ms dev-mqueue.mount
           110ms kmod-static-nodes.service
           103ms dev-hugepages.mount
            80ms atd.service
            75ms systemd-machine-id-commit.service
            70ms snapd.socket
            69ms systemd-random-seed.service
            59ms systemd-tmpfiles-setup-dev.service
            55ms polkit.service
            55ms plymouth-read-write.service
            49ms sys-kernel-config.mount
            42ms systemd-tmpfiles-setup.service
            41ms ephemeral-disk-warning.service
            41ms sys-fs-fuse-connections.mount
            40ms systemd-sysctl.service
            36ms systemd-update-utmp.service
            33ms snap-lxd-12631.mount
            32ms finalrd.service
            29ms console-setup.service
            27ms plymouth-quit.service
            27ms boot-efi.mount
            24ms blk-availability.service
            20ms snap-core-8268.mount
            17ms plymouth-quit-wait.service
            16ms systemd-update-utmp-runlevel.service
            16ms user-runtime-dir@1000.service
             9ms dev-loop0.device
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00300s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.14700s +00.01000s
|`->get_boot_telemetry @00.15700s +00.08100s
|`->get_system_info @00.23900s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.23900s +00.04500s
|`->load_azure_ds_dir @00.28400s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.41200s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.41200s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00700 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.44700s +00.37400s
|`->_get_metadata_from_imds @00.82100s +00.03300s
Finished stage: (azure-ds/get_metadata_from_imds) 00.42900 seconds

|`->_get_random_seed @00.87700s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.64700 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.88700s +00.00000s
|`->write_files @00.88800s +00.00200s
Finished stage: (azure-ds/_get_data) 00.74300 seconds

Finished stage: (init-local/search-Azure) 00.74600 seconds

|`->network config from imds @00.94100s +00.00000s
Finished stage: (init-local) 01.14600 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.34600s +00.02100s
|`->network config from imds @03.41900s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.42800s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.43200s +00.13700s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.57000s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.59100s +00.01100s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.60300s +00.00500s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.05500 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.65800s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.07300 seconds

|`->_report_ready @03.66400s +03.23200s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.46400 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.46400 seconds

Finished stage: (azure-ds/_negotiate) 03.46900 seconds

Finished stage: (azure-ds/setup) 03.46900 seconds

Finished stage: (init-network/setup-datasource) 03.46900 seconds

|`->reading and applying user-data @06.90300s +00.00700s
|`->reading and applying vendor-data @06.91000s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @06.93500s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @06.93500s +00.26200s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.26800s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.07600 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.33900 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.34000 seconds

Finished stage: (azure-ds/activate) 00.34000 seconds

Finished stage: (init-network/activate-datasource) 00.34200 seconds

|`->config-migrator ran successfully @07.33400s +00.00000s
|`->config-seed_random ran successfully @07.33500s +00.00100s
|`->config-bootcmd ran successfully @07.33600s +00.00000s
|`->config-write-files ran successfully @07.33700s +00.00100s
|`->config-growpart ran successfully @07.33800s +00.91000s
|`->config-resizefs ran successfully @08.24900s +01.30500s
|`->config-disk_setup ran successfully @09.55500s +01.35400s
|`->config-mounts ran successfully @10.91100s +00.22600s
|`->config-set_hostname ran successfully @11.13700s +00.00600s
|`->config-update_hostname ran successfully @11.14400s +00.00100s
|`->config-update_etc_hosts ran successfully @11.14500s +00.00100s
|`->config-ca-certs ran successfully @11.14600s +00.00100s
|`->config-rsyslog ran successfully @11.14700s +00.00100s
|`->config-users-groups ran successfully @11.14800s +00.31600s
|`->config-ssh ran successfully @11.46500s +00.39300s
Finished stage: (init-network) 08.53100 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @37.73100s +00.00000s
|`->config-snap ran successfully @37.73200s +00.00100s
|`->config-snap_config ran successfully @37.73300s +00.00100s
|`->config-ssh-import-id ran successfully @37.73400s +00.80300s
|`->config-locale ran successfully @38.53700s +00.00200s
|`->config-set-passwords ran successfully @38.54000s +00.00100s
|`->config-grub-dpkg ran successfully @38.54100s +01.23000s
|`->config-apt-pipelining ran successfully @39.77200s +00.00100s
|`->config-apt-configure ran successfully @39.77400s +00.08700s
|`->config-ubuntu-advantage ran successfully @39.86200s +00.00100s
|`->config-ntp ran successfully @39.86300s +00.00100s
|`->config-timezone ran successfully @39.86400s +00.00100s
|`->config-disable-ec2-metadata ran successfully @39.86500s +00.00000s
|`->config-runcmd ran successfully @39.86600s +00.00100s
|`->config-byobu ran successfully @39.86700s +00.00100s
Finished stage: (modules-config) 02.16400 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @40.52600s +00.00200s
|`->config-package-update-upgrade-install ran successfully @40.52800s +00.00100s
|`->config-fan ran successfully @40.53000s +00.00000s
|`->config-landscape ran successfully @40.53100s +00.00000s
|`->config-lxd ran successfully @40.53200s +00.00100s
|`->config-ubuntu-drivers ran successfully @40.53300s +00.00100s
|`->config-puppet ran successfully @40.53400s +00.00100s
|`->config-chef ran successfully @40.53500s +00.00100s
|`->config-mcollective ran successfully @40.53600s +00.00100s
|`->config-salt-minion ran successfully @40.53700s +00.00100s
|`->config-rightscale_userdata ran successfully @40.53800s +00.00000s
|`->config-scripts-vendor ran successfully @40.53900s +00.00100s
|`->config-scripts-per-once ran successfully @40.54000s +00.00100s
|`->config-scripts-per-boot ran successfully @40.54100s +00.00000s
|`->config-scripts-per-instance ran successfully @40.54100s +00.00100s
|`->config-scripts-user ran successfully @40.54200s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @40.54400s +00.00300s
|`->config-keys-to-console ran successfully @40.54800s +00.15800s
|`->config-phone-home ran successfully @40.70700s +00.00100s
|`->config-final-message ran successfully @40.70800s +00.00400s
|`->config-power-state-change ran successfully @40.71300s +00.00100s
Finished stage: (modules-final) 00.20000 seconds

Total Time: 33.52700 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- cloud-init analyze blame
-- Boot Record 01 --
     03.23200s (azure-ds/_report_ready)
     01.35400s (init-network/config-disk_setup)
     01.30500s (init-network/config-resizefs)
     01.23000s (modules-config/config-grub-dpkg)
     00.91000s (init-network/config-growpart)
     00.80300s (modules-config/config-ssh-import-id)
     00.39300s (init-network/config-ssh)
     00.37400s (azure-ds/obtain-dhcp-lease)
     00.31600s (init-network/config-users-groups)
     00.26200s (azure-ds/_has_ntfs_filesystem)
     00.22600s (init-network/config-mounts)
     00.15800s (modules-final/config-keys-to-console)
     00.13700s (azure-ds/generate_certificate)
     00.08700s (modules-config/config-apt-configure)
     00.08100s (azure-ds/get_boot_telemetry)
     00.04500s (azure-ds/list_possible_azure_ds_devs)
     00.03300s (azure-ds/_get_metadata_from_imds)
     00.02100s (init-network/check-cache)
     00.01100s (azure-ds/_decrypt_certs_from_xml)
     00.01000s (azure-ds/check-platform-viability)
     00.00700s (init-network/consume-user-data)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (azure-ds/_run_x509_action)
     00.00400s (modules-final/config-final-message)
     00.00300s (modules-final/config-ssh-authkey-fingerprints)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-config/config-locale)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-landscape)
     00.00000s (modules-final/config-fan)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-migrator)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Writing networking config: previous-network.out
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@52.177.65.35:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- sudo bash ./setup_proposed.sh+ 
egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu eoan-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~19.10.1 [405 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~19.10.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~19.10.1) over (19.3-41-gc4735dd3-0ubuntu1~19.10.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~19.10.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~19.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- sudo cloud-init clean --logs --reboot
Connection to 52.177.65.35 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- cloud-init status --wait --long

status: done
time: Thu, 23 Jan 2020 23:34:35 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- sudo systemd-analyze blame
          2.571s cloud-init.service
          2.512s systemd-udev-settle.service
          1.899s snapd.service
          1.820s lvm2-monitor.service
          1.813s systemd-networkd-wait-online.service
          1.730s snap.lxd.activate.service
          1.660s cloud-config.service
          1.528s cloud-init-local.service
          1.098s dev-sdb1.device
           638ms cloud-final.service
           635ms systemd-logind.service
           585ms systemd-timesyncd.service
           492ms networkd-dispatcher.service
           403ms accounts-daemon.service
           332ms systemd-journald.service
           281ms apport.service
           277ms grub-common.service
           270ms systemd-resolved.service
           236ms systemd-networkd.service
           223ms rsyslog.service
           219ms blk-availability.service
           201ms systemd-udev-trigger.service
           199ms grub-initrd-fallback.service
           185ms systemd-user-sessions.service
           176ms atd.service
           164ms systemd-remount-fs.service
           158ms ufw.service
           157ms systemd-modules-load.service
           155ms dev-mqueue.mount
           149ms keyboard-setup.service
           145ms kmod-static-nodes.service
           143ms polkit.service
           131ms sys-kernel-debug.mount
           117ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
           103ms dev-hugepages.mount
            98ms apparmor.service
            83ms plymouth-quit-wait.service
            81ms systemd-update-utmp.service
            78ms ssh.service
            69ms setvtrgb.service
            64ms user@1000.service
            62ms plymouth-read-write.service
            62ms finalrd.service
            56ms console-setup.service
            55ms systemd-tmpfiles-setup.service
            52ms snapd.socket
            42ms systemd-journal-flush.service
            41ms multipathd.service
            39ms snapd.seeded.service
            37ms snap-core-8268.mount
            37ms systemd-sysctl.service
            37ms sys-fs-fuse-connections.mount
            37ms systemd-tmpfiles-setup-dev.service
            37ms systemd-udevd.service
            36ms sys-kernel-config.mount
            36ms plymouth-quit.service
            35ms systemd-sysusers.service
            35ms systemd-random-seed.service
            35ms dev-loop0.device
            33ms snap-lxd-12631.mount
            27ms boot-efi.mount
            21ms systemd-update-utmp-runlevel.service
            14ms user-runtime-dir@1000.service
            12ms ephemeral-disk-warning.service
            12ms dev-loop1.device
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00300s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.04700s +00.00900s
|`->get_boot_telemetry @00.05600s +00.01600s
|`->get_system_info @00.07200s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.07300s +00.19300s
|`->load_azure_ds_dir @00.26600s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.27000s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.27100s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.29200s +00.22300s
|`->_get_metadata_from_imds @00.51500s +00.01000s
Finished stage: (azure-ds/get_metadata_from_imds) 00.28800 seconds

|`->_get_random_seed @00.58000s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.51800 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.59100s +00.00000s
|`->write_files @00.59200s +00.00200s
Finished stage: (azure-ds/_get_data) 00.54700 seconds

Finished stage: (init-local/search-Azure) 00.55000 seconds

|`->network config from imds @00.64100s +00.00000s
Finished stage: (init-local) 00.76200 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.24600s +00.02200s
|`->network config from imds @03.32200s +00.00100s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.33400s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.33900s +00.15800s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.49800s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.52000s +00.00900s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.53000s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01200 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.54200s +00.00500s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00500 seconds

Finished stage: (azure-ds/parse_certificates) 00.02800 seconds

|`->_report_ready @03.54700s +00.00700s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.21600 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.21700 seconds

Finished stage: (azure-ds/_negotiate) 00.22100 seconds

Finished stage: (azure-ds/setup) 00.22100 seconds

Finished stage: (init-network/setup-datasource) 00.22100 seconds

|`->reading and applying user-data @03.56100s +00.00700s
|`->reading and applying vendor-data @03.56800s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.59200s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.59200s +00.15300s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.15400 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.15500 seconds

Finished stage: (azure-ds/activate) 00.15500 seconds

Finished stage: (init-network/activate-datasource) 00.15600 seconds

|`->config-migrator ran successfully @03.76000s +00.00000s
|`->config-seed_random ran successfully @03.76100s +00.00100s
|`->config-bootcmd ran successfully @03.76300s +00.00000s
|`->config-write-files ran successfully @03.76300s +00.00100s
|`->config-growpart ran successfully @03.76400s +00.05100s
|`->config-resizefs ran successfully @03.81600s +00.15700s
|`->config-disk_setup ran successfully @03.97300s +00.56700s
|`->config-mounts ran successfully @04.54000s +00.17600s
|`->config-set_hostname ran successfully @04.71700s +00.00700s
|`->config-update_hostname ran successfully @04.72400s +00.00200s
|`->config-update_etc_hosts ran successfully @04.72600s +00.00000s
|`->config-ca-certs ran successfully @04.72600s +00.00100s
|`->config-rsyslog ran successfully @04.72800s +00.00100s
|`->config-users-groups ran successfully @04.72900s +00.18500s
|`->config-ssh ran successfully @04.91500s +00.29200s
Finished stage: (init-network) 01.97600 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @08.12600s +00.00100s
|`->config-snap ran successfully @08.12700s +00.00100s
|`->config-ssh-import-id ran successfully @08.12800s +00.69500s
|`->config-locale ran successfully @08.82400s +00.00100s
|`->config-set-passwords ran successfully @08.82500s +00.00200s
|`->config-grub-dpkg ran successfully @08.82700s +00.40600s
|`->config-apt-pipelining ran successfully @09.23400s +00.00100s
|`->config-apt-configure ran successfully @09.23500s +00.08500s
|`->config-ubuntu-advantage ran successfully @09.32000s +00.00100s
|`->config-ntp ran successfully @09.32200s +00.00000s
|`->config-timezone ran successfully @09.32300s +00.00000s
|`->config-disable-ec2-metadata ran successfully @09.32400s +00.00000s
|`->config-runcmd ran successfully @09.32400s +00.00100s
|`->config-byobu ran successfully @09.32500s +00.00100s
Finished stage: (modules-config) 01.21400 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @09.82000s +00.00100s
|`->config-fan ran successfully @09.82100s +00.00100s
|`->config-landscape ran successfully @09.82200s +00.00100s
|`->config-lxd ran successfully @09.82300s +00.00100s
|`->config-ubuntu-drivers ran successfully @09.82400s +00.00100s
|`->config-puppet ran successfully @09.82500s +00.00100s
|`->config-chef ran successfully @09.82700s +00.00000s
|`->config-mcollective ran successfully @09.82700s +00.00100s
|`->config-salt-minion ran successfully @09.82800s +00.00100s
|`->config-rightscale_userdata ran successfully @09.82900s +00.00100s
|`->config-scripts-vendor ran successfully @09.83000s +00.00100s
|`->config-scripts-per-once ran successfully @09.83100s +00.00100s
|`->config-scripts-per-boot ran successfully @09.83200s +00.00100s
|`->config-scripts-per-instance ran successfully @09.83300s +00.00100s
|`->config-scripts-user ran successfully @09.83400s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @09.83500s +00.06000s
|`->config-keys-to-console ran successfully @09.89500s +00.10700s
|`->config-phone-home ran successfully @10.00200s +00.00100s
|`->config-final-message ran successfully @10.00300s +00.00500s
|`->config-power-state-change ran successfully @10.00800s +00.00100s
Finished stage: (modules-final) 00.20200 seconds

Total Time: 7.83100 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- cloud-init analyze blame
-- Boot Record 01 --
     00.69500s (modules-config/config-ssh-import-id)
     00.56700s (init-network/config-disk_setup)
     00.40600s (modules-config/config-grub-dpkg)
     00.29200s (init-network/config-ssh)
     00.22300s (azure-ds/obtain-dhcp-lease)
     00.19300s (azure-ds/list_possible_azure_ds_devs)
     00.18500s (init-network/config-users-groups)
     00.17600s (init-network/config-mounts)
     00.15800s (azure-ds/generate_certificate)
     00.15700s (init-network/config-resizefs)
     00.15300s (azure-ds/_has_ntfs_filesystem)
     00.10700s (modules-final/config-keys-to-console)
     00.08500s (modules-config/config-apt-configure)
     00.06000s (modules-final/config-ssh-authkey-fingerprints)
     00.05100s (init-network/config-growpart)
     00.02200s (init-network/check-cache)
     00.01600s (azure-ds/get_boot_telemetry)
     00.01000s (azure-ds/_get_metadata_from_imds)
     00.00900s (azure-ds/check-platform-viability)
     00.00900s (azure-ds/_decrypt_certs_from_xml)
     00.00700s (init-network/consume-user-data)
     00.00700s (init-network/config-set_hostname)
     00.00700s (azure-ds/_report_ready)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00500s (azure-ds/_run_x509_action)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (init-network/config-update_hostname)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-locale)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-chef)
     00.00000s (modules-config/config-timezone)
     00.00000s (modules-config/config-ntp)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-migrator)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade write network config: upgrade-network.out
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- grep DHCP /var/log/syslog
+ echo ------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
------- Diff previous-network to post-upgrade-network ------
--- previous-network.out	2020-01-23 23:33:18.509684316 +0000
+++ upgrade-network.out	2020-01-23 23:35:04.307287388 +0000
@@ -25,8 +25,8 @@
             set-name: eth1
     version: 2
 default via 10.0.0.1 dev eth0 proto dhcp src 10.0.0.8 metric 100 
-10.0.0.0/24 dev eth1 proto kernel scope link src 10.0.0.9 
 10.0.0.0/24 dev eth0 proto kernel scope link src 10.0.0.8 
+10.0.0.0/24 dev eth1 proto kernel scope link src 10.0.0.9 
 168.63.129.16 via 10.0.0.1 dev eth0 proto dhcp src 10.0.0.8 metric 100 
 169.254.169.254 via 10.0.0.1 dev eth0 proto dhcp src 10.0.0.8 metric 100 
 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
@@ -40,15 +40,15 @@
        valid_lft forever preferred_lft forever
 ::1 dev lo proto kernel metric 256 pref medium
 ace:cab:deca:deed::/64 dev eth0 proto ra metric 100 pref medium
-fe80::/64 dev eth1 proto kernel metric 256 pref medium
 fe80::/64 dev eth0 proto kernel metric 256 pref medium
-default via fe80::1234:5678:9abc dev eth0 proto ra metric 100 expires 8999sec pref medium
+fe80::/64 dev eth1 proto kernel metric 256 pref medium
+default via fe80::1234:5678:9abc dev eth0 proto ra metric 100 expires 8997sec pref medium
 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 state UNKNOWN qlen 1000
     inet6 ::1/128 scope host 
        valid_lft forever preferred_lft forever
 2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 state UP qlen 1000
     inet6 ace:cab:deca:deed::5/128 scope global dynamic noprefixroute 
-       valid_lft 17279974sec preferred_lft 8639974sec
+       valid_lft 17279964sec preferred_lft 8639964sec
     inet6 fe80::20d:3aff:fe7c:3737/64 scope link 
        valid_lft forever preferred_lft forever
 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 state UP qlen 1000
@@ -63,3 +63,12 @@
 Jan 23 23:32:34 SRU-worked-azure systemd-networkd[543]: eth1: DHCP: No gateway received from DHCP server.
 Jan 23 23:32:34 SRU-worked-azure systemd-networkd[543]: eth0: DHCPv4 address 10.0.0.8/24 via 10.0.0.1
 Jan 23 23:32:50 SRU-worked-azure systemd-networkd[543]: eth0: DHCPv6 address ace:cab:deca:deed::5/128 timeout preferred 8640000 valid 17280000
+Jan 23 23:34:31 SRU-worked-azure dhclient[564]: Internet Systems Consortium DHCP Client 4.4.1
+Jan 23 23:34:31 SRU-worked-azure dhclient[564]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0x5fc88b0e)
+Jan 23 23:34:31 SRU-worked-azure dhclient[564]: DHCPOFFER of 10.0.0.8 from 168.63.129.16
+Jan 23 23:34:31 SRU-worked-azure dhclient[564]: DHCPREQUEST for 10.0.0.8 on eth0 to 255.255.255.255 port 67 (xid=0xe8bc85f)
+Jan 23 23:34:31 SRU-worked-azure dhclient[564]: DHCPACK of 10.0.0.8 from 168.63.129.16 (xid=0x5fc88b0e)
+Jan 23 23:34:31 SRU-worked-azure systemd-networkd[592]: eth0: DHCPv4 address 10.0.0.8/24 via 10.0.0.1
+Jan 23 23:34:31 SRU-worked-azure systemd-networkd[592]: eth1: DHCPv4 address 10.0.0.9/24
+Jan 23 23:34:31 SRU-worked-azure systemd-networkd[592]: eth1: DHCP: No gateway received from DHCP server.
+Jan 23 23:34:31 SRU-worked-azure systemd-networkd[592]: eth0: DHCPv6 address ace:cab:deca:deed::5/128 timeout preferred 8640000 valid 17280000
+ echo ------- Diff previous-network to post-upgrade-network ------
+ ssh------- Diff previous-network to post-upgrade-network ------
 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
+ ssh -o StrictHostKeyChecking=noGet cloud-id
 -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -oValidating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
 StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- sudo reboot
Connection to 52.177.65.35 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- cloud-init status --wait --long
....
status: done
time: Thu, 23 Jan 2020 23:35:46 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
+ ssh -o StrictHostKeyChecking=no -oAfter reboot
 UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.177.65.35 -- grep 'Update datasource' /var/log/cloud-init.log
2020-01-23 23:34:25,235 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-23 23:35:38,210 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-23 23:35:38,843 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END eoan
### END eoan

=== END SRU Verification output ====
