#!/bin/sh
set -x
# Manually deploy on Azure using Azure CLI client.
# Validate upgrade to proposed version of cloud-init
# Check Tracebacks or error conditions on clean boot
 
# To be adapted to the SRU to test
SRU_SERIES="xenial bionic disco"

# local values
# find region with az account list-locations -o table
REGION="<specify your region name>"
VNET_NAME="<specify your virtual network name>"
NETWORK_SECURITY_GROUP="<specify your network security group>"
NIC_NAME="<specify a preferred nic name>"
RESOURCE_GROUP="<specify your resource group>"
BOOT_DIAG="<specify your boot diagnostics group>"
SSH_KEY="$HOME/.ssh/id_rsa.pub"


ADVANCED_NIC_TESTS=true


IPV6_NET_REGISTERED=$(az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network | jq -r '.properties.state')
IPV6_CA_LB_REGISTERED=$(az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network | jq -r '.properties.state')

if [ "$IPV6_NET_REGISTERED" != "Registered" -o "$IPV6_CA_LB_REGISTERED" != "Registered" ]; then
    echo "Account is not yet registered for AllowIPv6VirtualNetwork or AllowIPv6CAOnStandardLB. Can take 30 mins. Activate feature now (y/n)?"
    read RESP
    if [ "$RESP" = "y" ]; then
        az feature register --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
        az feature register --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
    else
        echo "Skipping any advanced network tests because you opted to avoid registering IPv6 feature"
        echo -n "Proceed without any advanced networking tests (y/n)? "
        read OK
        if [ "$OK" = "y" ]; then
            ADVANCED_NIC_TESTS=false
        else
            echo "quit the test run"
            exit 1
        fi
    fi
    echo "Waiting for AllowIPv6VirtualNetwork feature registration"
    while [ "$IPV6_NET_REGISTERED" != "Registered" -o "$IPV6_CA_LB_REGISTERED" != "Registered" ]; do
        echo -n "."
        sleep 5
        IPV6_NET_REGISTERED=$(az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network | jq -r '.properties.state')
        IPV6_CA_LB_REGISTERED=$(az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network | jq -r '.properties.state')
    done
fi

IPV6_REGISTRATION_COMPLETE=$(az provider show -n Microsoft.Network | jq -r ".registrationState")
echo "Waiting for Microsoft.Network IPv6 feature registration"
while [ "$IPV6_REGISTRATION_COMPLETE"  != "Registered" ]; do
    echo -n "."
    sleep 5
    IPV6_REGISTRATION_COMPLETE=$(az provider show -n Microsoft.Network | jq -r ".registrationState")
done


cat > sethostname.yaml <<EOF
## template: jinja
#cloud-config
ssh_import_id : [daniel-thewatkins]
hostname: SRU-worked-{{v1.cloud_name}}
EOF

cat > setup_proposed.sh <<EOF
#/bin/bash
mirror=http://archive.ubuntu.com/ubuntu
echo deb \$mirror \$(lsb_release -sc)-proposed main | tee /etc/apt/sources.list.d/proposed.list
apt-get update -q
apt-get install -qy cloud-init
EOF

az group create --name $RESOURCE_GROUP --location $REGION

if [ -n "${BOOT_DIAG}" ]; then
    az storage account create \
        --name $BOOT_DIAG \
        --resource-group $RESOURCE_GROUP \
        --location $REGION \
        --sku Standard_RAGRS \
        --kind StorageV2
    BOOT_DIAG_ARG="--boot-diagnostics-storage ${BOOT_DIAG}"
else
    BOOT_DIAG_ARG=""
fi

az network vnet create \
    --resource-group $RESOURCE_GROUP \
    --name $VNET_NAME \
    --address-prefixes "192.168.0.0/16" "ace:cab:deca::/48"

az network nsg create \
    --resource-group $RESOURCE_GROUP \
    --name $NETWORK_SECURITY_GROUP

az network vnet subnet create \
    --name sruSubnet \
    --resource-group $RESOURCE_GROUP \
    --vnet-name $VNET_NAME \
    --address-prefixes "192.168.0.0/24" "ace:cab:deca:deed::/64" \
    --network-security-group $NETWORK_SECURITY_GROUP

az network nsg rule create \
    --resource-group $RESOURCE_GROUP \
    --nsg-name $NETWORK_SECURITY_GROUP \
    --name Allow-SSH-Internet \
    --access Allow \
    --protocol Tcp \
    --direction Inbound \
    --priority 100 \
    --source-address-prefix "*" \
    --source-port-range "*" \
    --destination-address-prefix "*" \
    --destination-port-range 22


sshopts="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"
for series in $SRU_SERIES; do
    echo "### BEGIN $series"
    netcfg="/etc/netplan/50-cloud-init.yaml"
    case $series in
        xenial) image_version=16.04-DAILY-LTS
                netcfg="/etc/network/interfaces.d/50-cloud-init.cfg";;
        bionic) image_version=18.04-DAILY-LTS;;
        disco) image_version=19.04-DAILY;;
        eoan) image_version=19.10-DAILY;;
        *) echo "!! UPDATE FAMILY CASE STATEMENT !!"; exit 1;;
    esac
    # Note: accelerated network requires bigger size than our default DS1
    for nics in "" "--nics $NIC_NAME-$series ${NIC_NAME}2-$series --size Standard_DS2_v2"; do
        if [ "" = "$nics" ]; then
            echo "Creating standard network vm"
            name=test-sru-$series
        else
            if [ $ADVANCED_NIC_TESTS = false ]; then
                echo "Skipping advanced nic tests because ipv6 feature is disabled"
                continue
            fi
            echo "Creating advanced network vm"
            name=test-sru-$series-advanced
            az network public-ip create \
                --name sruPublicIP-IPv4-$series \
                --resource-group $RESOURCE_GROUP \
                --version IPv4
            az network public-ip create \
                --name sruPublicIP-IPv6-$series \
                --resource-group $RESOURCE_GROUP \
                --version IPv6
            az network nic create \
                --resource-group $RESOURCE_GROUP \
                --name $NIC_NAME-$series \
                --vnet-name $VNET_NAME \
                --subnet sruSubnet \
                --accelerated-networking true \
                --private-ip-address-version IPv4 \
                --public-ip-address sruPublicIP-IPv4-$series \
                --network-security-group $NETWORK_SECURITY_GROUP
            az network nic create \
                --resource-group $RESOURCE_GROUP \
                --name ${NIC_NAME}2-$series \
                --vnet-name $VNET_NAME \
                --subnet sruSubnet \
                --accelerated-networking true \
                --private-ip-address-version IPv4 \
                --network-security-group $NETWORK_SECURITY_GROUP
            az network nic ip-config create \
                --name $NIC_NAME-$series-IPv6Config \
                --nic-name $NIC_NAME-$series \
                --resource-group $RESOURCE_GROUP \
                --vnet-name $VNET_NAME \
                --subnet sruSubnet \
                --private-ip-address-version IPv6
        fi
        az vm create --name=$name \
            --image=Canonical:UbuntuServer:$image_version:latest \
            --admin-username=root --admin-username=ubuntu \
            -g $RESOURCE_GROUP --ssh-key-value $SSH_KEY \
            $BOOT_DIAG_ARG \
            --custom-data sethostname.yaml $nics
        IP=$(az vm list-ip-addresses --name $name | jq -r '.[] | .virtualMachine.network.publicIpAddresses[].ipAddress'| awk '{printf "ubuntu@%s", $1}')

        echo "Created $name: ubuntu@$IP"

        ssh $sshopts $IP -- cloud-init status --wait --long
        ssh $sshopts $IP -- dpkg-query --show cloud-init
        ssh $sshopts $IP -- sudo cat /run/cloud-init/result.json
        ssh $sshopts $IP -- grep Trace /var/log/cloud-init.log
        ssh $sshopts $IP -- systemd-analyze
        ssh $sshopts $IP -- systemd-analyze blame
        ssh $sshopts $IP -- cloud-init analyze show
        ssh $sshopts $IP -- cloud-init analyze blame
        echo 'Networking config'
        ssh $sshopts $IP -- cat $netcfg

        scp $sshopts setup_proposed.sh $IP:.
        ssh $sshopts $IP -- sudo bash ./setup_proposed.sh 2>&1 | egrep 'cloud-init'
        ssh $sshopts $IP -- dpkg-query --show cloud-init
        ssh $sshopts $IP -- sudo hostname SRU-didnt-work
        ssh $sshopts $IP -- sudo rm -f $netcfg
        ssh $sshopts $IP -- sudo cloud-init clean --logs --reboot
        sleep 60

        ssh $sshopts $IP -- cloud-init status --wait --long
        ssh $sshopts $IP -- grep Trace /var/log/cloud-init\*
        ssh $sshopts $IP -- sudo cat /run/cloud-init/result.json
        ssh $sshopts $IP -- sudo systemd-analyze blame
        ssh $sshopts $IP -- cloud-init analyze show
        ssh $sshopts $IP -- cloud-init analyze blame
        echo 'After upgrade Networking config'
        ssh $sshopts $IP -- cat $netcfg
        ssh $sshopts $IP -- cloud-init query --format "'cloud-region: {{cloud_name}}-{{region}}'"
        echo 'Get cloud-id'
        ssh $sshopts $IP -- cloud-id
        ssh $sshopts $IP -- cloud-init query --format "'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'"
        echo 'Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot'
        ssh $sshopts $IP -- sudo reboot || true
        sleep 30
        ssh $sshopts $IP -- cloud-init status --wait --long
        echo 'After reboot'
        ssh $sshopts $IP -- "grep 'Update datasource' /var/log/cloud-init.log"
    done
    echo "### END $series"
done


=== BEGIN SRU Verification Output ===
root@publishing:~# ./azure-sru-19.4.33.txt | tee azure-sru.log
+ SRU_SERIES=xenial bionic eoan
+ REGION=eastus2
+ VNET_NAME=sruVnet
+ NETWORK_SECURITY_GROUP=sruNetSecGroup
+ NIC_NAME=sruNic
+ RESOURCE_GROUP=srugroupIPV6
+ BOOT_DIAG=storeitsru
+ SSH_KEY=/root/.ssh/id_rsa.pub
+ ADVANCED_NIC_TESTS=true
+ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
+ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
+ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ [ Registered != Registered -o Registered != Registered ]
+ az provider show -n Microsoft.Network
+ jq -r .registrationState
+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo Waiting for Microsoft.Network IPv6 feature registration
+ [ Registered != Registered ]
Waiting for Microsoft.Network IPv6 feature registration
+ cat
+ cat
+ az group create --name srugroupIPV6 --location eastus2
{
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6",
  "location": "eastus2",
  "managedBy": null,
  "name": "srugroupIPV6",
  "properties": {
    "provisioningState": "Succeeded"
  },
  "tags": null,
  "type": "Microsoft.Resources/resourceGroups"
}
+ [ -n storeitsru ]
+ az storage account create --name storeitsru --resource-group srugroupIPV6 --location eastus2 --sku Standard_RAGRS --kind StorageV2
The default kind for created storage account will change to 'StorageV2' from 'Storage' in future
{
  "accessTier": "Hot",
  "azureFilesIdentityBasedAuthentication": null,
  "creationTime": "2020-01-17T21:14:33.804518+00:00",
  "customDomain": null,
  "enableHttpsTrafficOnly": true,
  "encryption": {
    "keySource": "Microsoft.Storage",
    "keyVaultProperties": null,
    "services": {
      "blob": {
        "enabled": true,
        "lastEnabledTime": "2020-01-17T21:14:33.882614+00:00"
      },
      "file": {
        "enabled": true,
        "lastEnabledTime": "2020-01-17T21:14:33.882614+00:00"
      },
      "queue": null,
      "table": null
    }
  },
  "failoverInProgress": null,
  "geoReplicationStats": null,
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Storage/storageAccounts/storeitsru",
  "identity": null,
  "isHnsEnabled": null,
  "kind": "StorageV2",
  "largeFileSharesState": null,
  "lastGeoFailoverTime": null,
  "location": "eastus2",
  "name": "storeitsru",
  "networkRuleSet": {
    "bypass": "AzureServices",
    "defaultAction": "Allow",
    "ipRules": [],
    "virtualNetworkRules": []
  },
  "primaryEndpoints": {
    "blob": "https://storeitsru.blob.core.windows.net/",
    "dfs": "https://storeitsru.dfs.core.windows.net/",
    "file": "https://storeitsru.file.core.windows.net/",
    "queue": "https://storeitsru.queue.core.windows.net/",
    "table": "https://storeitsru.table.core.windows.net/",
    "web": "https://storeitsru.z20.web.core.windows.net/"
  },
  "primaryLocation": "eastus2",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "secondaryEndpoints": {
    "blob": "https://storeitsru-secondary.blob.core.windows.net/",
    "dfs": "https://storeitsru-secondary.dfs.core.windows.net/",
    "file": null,
    "queue": "https://storeitsru-secondary.queue.core.windows.net/",
    "table": "https://storeitsru-secondary.table.core.windows.net/",
    "web": "https://storeitsru-secondary.z20.web.core.windows.net/"
  },
  "secondaryLocation": "centralus",
  "sku": {
    "capabilities": null,
    "kind": null,
    "locations": null,
    "name": "Standard_RAGRS",
    "resourceType": null,
    "restrictions": null,
    "tier": "Standard"
  },
  "statusOfPrimary": "available",
  "statusOfSecondary": "available",
  "tags": {},
  "type": "Microsoft.Storage/storageAccounts"
}
+ BOOT_DIAG_ARG=--boot-diagnostics-storage storeitsru
+ az network vnet create --resource-group srugroupIPV6 --name sruVnet --address-prefixes 192.168.0.0/16 ace:cab:deca::/48
{
  "newVNet": {
    "addressSpace": {
      "addressPrefixes": [
        "192.168.0.0/16",
        "ace:cab:deca::/48"
      ]
    },
    "ddosProtectionPlan": null,
    "dhcpOptions": {
      "dnsServers": []
    },
    "enableDdosProtection": false,
    "enableVmProtection": false,
    "etag": "W/\"4f68a11f-8466-4805-aae8-7f53a5e5ad43\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet",
    "location": "eastus2",
    "name": "sruVnet",
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "c5a5be55-22eb-4c5b-9de6-05fb38f53822",
    "subnets": [],
    "tags": {},
    "type": "Microsoft.Network/virtualNetworks",
    "virtualNetworkPeerings": []
  }
}
+ az network nsg create --resource-group srugroupIPV6 --name sruNetSecGroup
{
  "NewNSG": {
    "defaultSecurityRules": [
      {
        "access": "Allow",
        "description": "Allow inbound traffic from all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"fed530f6-ddc2-45fc-91ab-fd8bae8715fa\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetInBound",
        "name": "AllowVnetInBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow inbound traffic from azure load balancer",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"fed530f6-ddc2-45fc-91ab-fd8bae8715fa\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowAzureLoadBalancerInBound",
        "name": "AllowAzureLoadBalancerInBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "AzureLoadBalancer",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all inbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Inbound",
        "etag": "W/\"fed530f6-ddc2-45fc-91ab-fd8bae8715fa\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllInBound",
        "name": "DenyAllInBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to all VMs in VNET",
        "destinationAddressPrefix": "VirtualNetwork",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"fed530f6-ddc2-45fc-91ab-fd8bae8715fa\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowVnetOutBound",
        "name": "AllowVnetOutBound",
        "priority": 65000,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "VirtualNetwork",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Allow",
        "description": "Allow outbound traffic from all VMs to Internet",
        "destinationAddressPrefix": "Internet",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"fed530f6-ddc2-45fc-91ab-fd8bae8715fa\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/AllowInternetOutBound",
        "name": "AllowInternetOutBound",
        "priority": 65001,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      },
      {
        "access": "Deny",
        "description": "Deny all outbound traffic",
        "destinationAddressPrefix": "*",
        "destinationAddressPrefixes": [],
        "destinationApplicationSecurityGroups": null,
        "destinationPortRange": "*",
        "destinationPortRanges": [],
        "direction": "Outbound",
        "etag": "W/\"fed530f6-ddc2-45fc-91ab-fd8bae8715fa\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/defaultSecurityRules/DenyAllOutBound",
        "name": "DenyAllOutBound",
        "priority": 65500,
        "protocol": "*",
        "provisioningState": "Succeeded",
        "resourceGroup": "srugroupIPV6",
        "sourceAddressPrefix": "*",
        "sourceAddressPrefixes": [],
        "sourceApplicationSecurityGroups": null,
        "sourcePortRange": "*",
        "sourcePortRanges": [],
        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
      }
    ],
    "etag": "W/\"fed530f6-ddc2-45fc-91ab-fd8bae8715fa\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": "eastus2",
    "name": "sruNetSecGroup",
    "networkInterfaces": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "0392809e-17a6-4eff-bca1-1eb62159e303",
    "securityRules": [],
    "subnets": null,
    "tags": null,
    "type": "Microsoft.Network/networkSecurityGroups"
  }
}
+ az network vnet subnet create --name sruSubnet --resource-group srugroupIPV6 --vnet-name sruVnet --address-prefixes 192.168.0.0/24 ace:cab:deca:deed::/64 --network-security-group sruNetSecGroup
{
  "addressPrefix": null,
  "addressPrefixes": [
    "192.168.0.0/24",
    "ace:cab:deca:deed::/64"
  ],
  "delegations": [],
  "etag": "W/\"57ae7267-43e6-454a-a25e-f51763e87982\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
  "ipConfigurationProfiles": null,
  "ipConfigurations": null,
  "name": "sruSubnet",
  "natGateway": null,
  "networkSecurityGroup": {
    "defaultSecurityRules": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
    "location": null,
    "name": null,
    "networkInterfaces": null,
    "provisioningState": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": null,
    "securityRules": null,
    "subnets": null,
    "tags": null,
    "type": null
  },
  "privateEndpointNetworkPolicies": "Enabled",
  "privateEndpoints": null,
  "privateLinkServiceNetworkPolicies": "Enabled",
  "provisioningState": "Succeeded",
  "purpose": null,
  "resourceGroup": "srugroupIPV6",
  "resourceNavigationLinks": null,
  "routeTable": null,
  "serviceAssociationLinks": null,
  "serviceEndpointPolicies": null,
  "serviceEndpoints": null,
  "type": "Microsoft.Network/virtualNetworks/subnets"
}
+ az network nsg rule create --resource-group srugroupIPV6 --nsg-name sruNetSecGroup --name Allow-SSH-Internet --access Allow --protocol Tcp --direction Inbound --priority 100 --source-address-prefix * --source-port-range * --destination-address-prefix * --destination-port-range 22
{
  "access": "Allow",
  "description": null,
  "destinationAddressPrefix": "*",
  "destinationAddressPrefixes": [],
  "destinationApplicationSecurityGroups": null,
  "destinationPortRange": "22",
  "destinationPortRanges": [],
  "direction": "Inbound",
  "etag": "W/\"f7890638-1c72-43c8-91a6-83dc3d73998c\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup/securityRules/Allow-SSH-Internet",
  "name": "Allow-SSH-Internet",
  "priority": 100,
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "srugroupIPV6",
  "sourceAddressPrefix": "*",
  "sourceAddressPrefixes": [],
  "sourceApplicationSecurityGroups": null,
  "sourcePortRange": "*",
  "sourcePortRanges": [],
  "type": "Microsoft.Network/networkSecurityGroups/securityRules"
}
+ sshopts=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR
+ echo ### BEGIN xenial
+ netcfg=/etc/netplan/50-cloud-init.yaml
### BEGIN xenial
+ image_version=16.04-DAILY-LTS
+ netcfg=/etc/network/interfaces.d/50-cloud-init.cfg
+ [  =  ]
+ echo Creating standard network vm
+ name=test-sru-xenial
Creating standard network vm
+ az vm create --name=test-sru-xenial --image=Canonical:UbuntuServer:16.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-xenial",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7B-A6-7F",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.4",
  "publicIpAddress": "104.208.152.120",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-xenial
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@104.208.152.120
+ echo Created test-sru-xenial: ubuntu@ubuntu@104.208.152.120
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120Created test-sru-xenial: ubuntu@ubuntu@104.208.152.120
 -- cloud-init status --wait --long

status: done
time: Fri, 17 Jan 2020 21:20:24 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- dpkg-query --show cloud-init
cloud-init	19.3-41-gc4735dd3-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- systemd-analyze
Startup finished in 4.569s (kernel) + 25.588s (userspace) = 30.157s
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- systemd-analyze blame
          8.123s cloud-init.service
          3.994s cloud-init-local.service
          3.389s cloud-config.service
          2.684s snapd.seeded.service
          2.683s snapd.service
          2.409s pollinate.service
          2.228s lxd-containers.service
          2.180s apparmor.service
          1.973s console-setup.service
          1.948s dev-sda1.device
          1.072s accounts-daemon.service
           703ms cloud-final.service
           676ms lvm2-monitor.service
           654ms networking.service
           504ms open-iscsi.service
           463ms systemd-timesyncd.service
           365ms grub-common.service
           334ms iscsid.service
           323ms mdadm.service
           287ms rsyslog.service
           265ms systemd-modules-load.service
           259ms systemd-tmpfiles-setup-dev.service
           207ms apport.service
           204ms irqbalance.service
           200ms resolvconf.service
           197ms systemd-udev-trigger.service
           194ms ufw.service
           193ms keyboard-setup.service
           192ms kmod-static-nodes.service
           182ms systemd-journal-flush.service
           181ms systemd-journald.service
           161ms dev-mqueue.mount
           137ms polkitd.service
           133ms dev-hugepages.mount
           131ms systemd-logind.service
           124ms ssh.service
           115ms systemd-remount-fs.service
           112ms sys-kernel-debug.mount
           111ms lxd.socket
           106ms rc-local.service
           102ms systemd-udevd.service
            80ms snapd.socket
            80ms setvtrgb.service
            73ms systemd-random-seed.service
            67ms plymouth-read-write.service
            61ms systemd-machine-id-commit.service
            57ms plymouth-quit.service
            56ms sys-kernel-config.mount
            54ms systemd-user-sessions.service
            47ms ondemand.service
            41ms systemd-tmpfiles-setup.service
            40ms systemd-sysctl.service
            39ms systemd-update-utmp.service
            31ms boot-efi.mount
            24ms user@1000.service
            21ms ephemeral-disk-warning.service
            21ms sys-fs-fuse-connections.mount
            20ms plymouth-quit-wait.service
            15ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.01800s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.13200s +00.00600s
|`->get_boot_telemetry @00.13900s +00.00900s
|`->get_system_info @00.14800s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.14800s +00.04400s
|`->load_azure_ds_dir @00.19200s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.39900s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.40000s +00.00100s
Finished stage: (azure-ds/read_azure_ovf) 00.09900 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.10300 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.42600s +00.35700s
|`->_get_metadata_from_imds @00.78300s +00.06800s
Finished stage: (azure-ds/get_metadata_from_imds) 00.44500 seconds

|`->_get_random_seed @00.87100s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.73000 seconds

|`->write_files @00.87900s +00.00200s
Finished stage: (azure-ds/_get_data) 00.74900 seconds

Finished stage: (init-local/search-Azure) 00.75200 seconds

|`->network config from fallback @00.94600s +00.01900s
Finished stage: (init-local) 00.98700 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @02.06900s +00.02500s
|`->network config from fallback @02.16500s +00.02000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @02.19500s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

|`->invoke_agent @02.19800s +00.16600s
|`->wait for agents to retrieve ssh keys @02.36400s +01.00300s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @03.36800s +00.03600s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.03700 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 01.21000 seconds

Finished stage: (azure-ds/_negotiate) 01.21100 seconds

Finished stage: (azure-ds/setup) 01.21100 seconds

Finished stage: (init-network/setup-datasource) 01.21100 seconds

|`->reading and applying user-data @03.41400s +00.00800s
|`->reading and applying vendor-data @03.42200s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.45400s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.45400s +00.03900s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @03.55000s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.06400 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.10300 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.10400 seconds

Finished stage: (azure-ds/activate) 00.10400 seconds

Finished stage: (init-network/activate-datasource) 00.10700 seconds

|`->config-migrator ran successfully @03.62300s +00.00100s
|`->config-seed_random ran successfully @03.62500s +00.00200s
|`->config-bootcmd ran successfully @03.62700s +00.00100s
|`->config-write-files ran successfully @03.62800s +00.00100s
|`->config-growpart ran successfully @03.63000s +00.48400s
|`->config-resizefs ran successfully @04.11500s +00.31100s
|`->config-disk_setup ran successfully @04.42700s +04.44100s
|`->config-mounts ran successfully @08.86900s +00.12400s
|`->config-set_hostname ran successfully @08.99400s +00.00600s
|`->config-update_hostname ran successfully @09.00100s +00.00100s
|`->config-update_etc_hosts ran successfully @09.00300s +00.00000s
|`->config-ca-certs ran successfully @09.00300s +00.00100s
|`->config-rsyslog ran successfully @09.00500s +00.00100s
|`->config-users-groups ran successfully @09.00600s +00.29400s
|`->config-ssh ran successfully @09.30100s +00.43100s
Finished stage: (init-network) 07.67900 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @16.17300s +00.00100s
|`->config-snap ran successfully @16.17400s +00.00100s
|`->config-snap_config ran successfully @16.17600s +00.00100s
|`->config-ssh-import-id ran successfully @16.17700s +00.73300s
|`->config-locale ran successfully @16.91100s +01.14300s
|`->config-set-passwords ran successfully @18.05400s +00.00300s
|`->config-grub-dpkg ran successfully @18.05700s +00.76800s
|`->config-apt-pipelining ran successfully @18.82600s +00.00100s
|`->config-apt-configure ran successfully @18.82700s +00.18900s
|`->config-ubuntu-advantage ran successfully @19.01700s +00.00100s
|`->config-ntp ran successfully @19.01800s +00.00200s
|`->config-timezone ran successfully @19.02000s +00.00100s
|`->config-disable-ec2-metadata ran successfully @19.02200s +00.00000s
|`->config-runcmd ran successfully @19.02300s +00.00100s
|`->config-byobu ran successfully @19.02400s +00.00200s
Finished stage: (modules-config) 02.90200 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @19.59400s +00.00200s
|`->config-package-update-upgrade-install ran successfully @19.59600s +00.00100s
|`->config-fan ran successfully @19.59800s +00.00100s
|`->config-landscape ran successfully @19.59900s +00.00100s
|`->config-lxd ran successfully @19.60100s +00.00100s
|`->config-ubuntu-drivers ran successfully @19.60200s +00.00100s
|`->config-puppet ran successfully @19.60300s +00.00100s
|`->config-chef ran successfully @19.60500s +00.00100s
|`->config-mcollective ran successfully @19.60600s +00.00100s
|`->config-salt-minion ran successfully @19.60800s +00.00100s
|`->config-rightscale_userdata ran successfully @19.60900s +00.00100s
|`->config-scripts-vendor ran successfully @19.61000s +00.00100s
|`->config-scripts-per-once ran successfully @19.61200s +00.00100s
|`->config-scripts-per-boot ran successfully @19.61400s +00.00000s
|`->config-scripts-per-instance ran successfully @19.61500s +00.00100s
|`->config-scripts-user ran successfully @19.61600s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @19.61800s +00.04200s
|`->config-keys-to-console ran successfully @19.66000s +00.08500s
|`->config-phone-home ran successfully @19.74600s +00.00100s
|`->config-final-message ran successfully @19.74800s +00.00400s
|`->config-power-state-change ran successfully @19.75300s +00.00100s
Finished stage: (modules-final) 00.20300 seconds

Total Time: 20.01400 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- cloud-init analyze blame
-- Boot Record 01 --
     04.44100s (init-network/config-disk_setup)
     01.14300s (modules-config/config-locale)
     01.00300s (azure-ds/waiting-for-ssh-public-key)
     00.76800s (modules-config/config-grub-dpkg)
     00.73300s (modules-config/config-ssh-import-id)
     00.48400s (init-network/config-growpart)
     00.43100s (init-network/config-ssh)
     00.35700s (azure-ds/obtain-dhcp-lease)
     00.31100s (init-network/config-resizefs)
     00.29400s (init-network/config-users-groups)
     00.18900s (modules-config/config-apt-configure)
     00.16600s (azure-ds/invoke_agent)
     00.12400s (init-network/config-mounts)
     00.08500s (modules-final/config-keys-to-console)
     00.06800s (azure-ds/_get_metadata_from_imds)
     00.04400s (azure-ds/list_possible_azure_ds_devs)
     00.04200s (modules-final/config-ssh-authkey-fingerprints)
     00.03900s (azure-ds/_has_ntfs_filesystem)
     00.03600s (azure-ds/crtfile_to_pubkey)
     00.02500s (init-network/check-cache)
     00.02000s (azure-ds/parse_network_config)
     00.01900s (azure-ds/parse_network_config)
     00.00900s (azure-ds/get_boot_telemetry)
     00.00800s (init-network/consume-user-data)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/check-platform-viability)
     00.00400s (modules-final/config-final-message)
     00.00300s (modules-config/config-set-passwords)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-config/config-ntp)
     00.00200s (modules-config/config-byobu)
     00.00200s (init-network/config-seed_random)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_extract_preprovisioned_vm_setting)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)

1 boot records analyzed
+ echo Networking config
+ ssh -o StrictHostKeyChecking=no -oNetworking config
 UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@104.208.152.120:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- sudo bash ./setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu xenial-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~16.04.1 [413 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~16.04.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~16.04.1) over (19.3-41-gc4735dd3-0ubuntu1~16.04.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~16.04.1) ...
Leaving 'diversion of /etc/init/ureadahead.conf to /etc/init/ureadahead.conf.disabled by cloud-init'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- sudo hostname SRU-didnt-work
sudo: unable to resolve host SRU-worked-azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- sudo rm -f /etc/network/interfaces.d/50-cloud-init.cfg
sudo: unable to resolve host SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- sudo cloud-init clean --logs --reboot
sudo: unable to resolve host SRU-didnt-work
Connection to 104.208.152.120 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- cloud-init status --wait --long

status: done
time: Fri, 17 Jan 2020 21:21:59 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- sudo systemd-analyze blame
sudo: unable to resolve host SRU-worked-azure
          2.208s cloud-init.service
          1.672s cloud-init-local.service
          1.629s cloud-config.service
          1.248s dev-sda1.device
          1.240s snapd.service
           958ms lxd-containers.service
           783ms cloud-final.service
           690ms accounts-daemon.service
           635ms mdadm.service
           630ms apparmor.service
           608ms grub-common.service
           591ms networking.service
           543ms iscsid.service
           455ms systemd-timesyncd.service
           385ms systemd-logind.service
           371ms console-setup.service
           370ms ssh.service
           334ms lvm2-monitor.service
           295ms rc-local.service
           247ms apport.service
           194ms open-iscsi.service
           192ms resolvconf.service
           192ms ufw.service
           189ms rsyslog.service
           188ms keyboard-setup.service
           184ms systemd-remount-fs.service
           169ms irqbalance.service
           161ms polkitd.service
           156ms systemd-modules-load.service
           153ms systemd-udev-trigger.service
           141ms dev-hugepages.mount
           125ms sys-kernel-debug.mount
           104ms lxd.socket
            92ms dev-mqueue.mount
            91ms systemd-user-sessions.service
            88ms systemd-update-utmp.service
            84ms kmod-static-nodes.service
            83ms systemd-journald.service
            83ms systemd-tmpfiles-setup-dev.service
            75ms systemd-sysctl.service
            58ms systemd-journal-flush.service
            55ms systemd-tmpfiles-setup.service
            54ms systemd-random-seed.service
            54ms snapd.socket
            51ms sys-fs-fuse-connections.mount
            48ms sys-kernel-config.mount
            43ms ondemand.service
            40ms setvtrgb.service
            39ms systemd-udevd.service
            34ms snapd.seeded.service
            33ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            24ms plymouth-quit.service
            24ms user@1000.service
            22ms plymouth-quit-wait.service
            20ms plymouth-read-write.service
            15ms systemd-update-utmp-runlevel.service
            14ms boot-efi.mount
            14ms ephemeral-disk-warning.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00600s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03700s +00.00600s
|`->get_boot_telemetry @00.04300s +00.01000s
|`->get_system_info @00.05300s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.05300s +00.15500s
|`->load_azure_ds_dir @00.20800s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.21300s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.21300s +00.00100s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00500 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.23600s +00.14400s
|`->_get_metadata_from_imds @00.38000s +00.01400s
Finished stage: (azure-ds/get_metadata_from_imds) 00.17700 seconds

|`->_get_random_seed @00.41200s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.36700 seconds

|`->write_files @00.42100s +00.00200s
Finished stage: (azure-ds/_get_data) 00.38600 seconds

Finished stage: (init-local/search-Azure) 00.38900 seconds

|`->network config from fallback @00.48900s +00.01800s
Finished stage: (init-local) 00.52200 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @01.57400s +00.02800s
|`->network config from fallback @01.66400s +00.02000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @01.69500s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

|`->invoke_agent @01.69800s +00.16000s
|`->wait for agents to retrieve SSH keys @01.85800s +00.00200s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @01.86000s +00.02800s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.02900 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 00.19500 seconds

Finished stage: (azure-ds/_negotiate) 00.19500 seconds

Finished stage: (azure-ds/setup) 00.19600 seconds

Finished stage: (init-network/setup-datasource) 00.19600 seconds

|`->reading and applying user-data @01.90700s +00.01600s
|`->reading and applying vendor-data @01.92300s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @01.98900s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @01.99400s +00.07800s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.08300 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.08400 seconds

Finished stage: (azure-ds/activate) 00.08400 seconds

Finished stage: (init-network/activate-datasource) 00.08700 seconds

|`->config-migrator ran successfully @02.10300s +00.00200s
|`->config-seed_random ran successfully @02.10600s +00.00200s
|`->config-bootcmd ran successfully @02.10800s +00.00100s
|`->config-write-files ran successfully @02.11100s +00.00200s
|`->config-growpart ran successfully @02.11300s +00.08400s
|`->config-resizefs ran successfully @02.19700s +00.02600s
|`->config-disk_setup ran successfully @02.22300s +00.16700s
|`->config-mounts ran successfully @02.39300s +00.20600s
|`->config-set_hostname ran successfully @02.60000s +00.01400s
|`->config-update_hostname ran successfully @02.61500s +00.00200s
|`->config-update_etc_hosts ran successfully @02.61700s +00.00500s
|`->config-ca-certs ran successfully @02.62200s +00.00100s
|`->config-rsyslog ran successfully @02.62400s +00.00100s
|`->config-users-groups ran successfully @02.62500s +00.06400s
|`->config-ssh ran successfully @02.69000s +00.55500s
Finished stage: (init-network) 01.69000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @05.57500s +00.00000s
|`->config-snap ran successfully @05.57600s +00.00100s
|`->config-ssh-import-id ran successfully @05.57700s +00.54700s
|`->config-locale ran successfully @06.13400s +00.00200s
|`->config-set-passwords ran successfully @06.13600s +00.00200s
|`->config-grub-dpkg ran successfully @06.13800s +00.47200s
|`->config-apt-pipelining ran successfully @06.61200s +00.00200s
|`->config-apt-configure ran successfully @06.61500s +00.11200s
|`->config-ubuntu-advantage ran successfully @06.72700s +00.00200s
|`->config-ntp ran successfully @06.72900s +00.00100s
|`->config-timezone ran successfully @06.73100s +00.00300s
|`->config-disable-ec2-metadata ran successfully @06.73500s +00.00000s
|`->config-runcmd ran successfully @06.73600s +00.00100s
|`->config-byobu ran successfully @06.73700s +00.00100s
Finished stage: (modules-config) 01.18000 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @07.32300s +00.00100s
|`->config-fan ran successfully @07.32500s +00.00100s
|`->config-landscape ran successfully @07.32600s +00.00100s
|`->config-lxd ran successfully @07.32800s +00.00100s
|`->config-ubuntu-drivers ran successfully @07.32900s +00.00100s
|`->config-puppet ran successfully @07.33100s +00.00100s
|`->config-chef ran successfully @07.33200s +00.00100s
|`->config-mcollective ran successfully @07.33400s +00.00100s
|`->config-salt-minion ran successfully @07.33500s +00.00100s
|`->config-rightscale_userdata ran successfully @07.33700s +00.00100s
|`->config-scripts-vendor ran successfully @07.33800s +00.00100s
|`->config-scripts-per-once ran successfully @07.34000s +00.00100s
|`->config-scripts-per-boot ran successfully @07.34100s +00.00100s
|`->config-scripts-per-instance ran successfully @07.34300s +00.00000s
|`->config-scripts-user ran successfully @07.34400s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @07.34500s +00.06600s
|`->config-keys-to-console ran successfully @07.41100s +00.10000s
|`->config-phone-home ran successfully @07.51400s +00.00600s
|`->config-final-message ran successfully @07.52100s +00.00900s
|`->config-power-state-change ran successfully @07.53200s +00.01200s
Finished stage: (modules-final) 00.24500 seconds

Total Time: 6.11800 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- cloud-init analyze blame
-- Boot Record 01 --
     00.55500s (init-network/config-ssh)
     00.54700s (modules-config/config-ssh-import-id)
     00.47200s (modules-config/config-grub-dpkg)
     00.20600s (init-network/config-mounts)
     00.16700s (init-network/config-disk_setup)
     00.16000s (azure-ds/invoke_agent)
     00.15500s (azure-ds/list_possible_azure_ds_devs)
     00.14400s (azure-ds/obtain-dhcp-lease)
     00.11200s (modules-config/config-apt-configure)
     00.10000s (modules-final/config-keys-to-console)
     00.08400s (init-network/config-growpart)
     00.07800s (azure-ds/_has_ntfs_filesystem)
     00.06600s (modules-final/config-ssh-authkey-fingerprints)
     00.06400s (init-network/config-users-groups)
     00.02800s (init-network/check-cache)
     00.02800s (azure-ds/crtfile_to_pubkey)
     00.02600s (init-network/config-resizefs)
     00.02000s (azure-ds/parse_network_config)
     00.01800s (azure-ds/parse_network_config)
     00.01600s (init-network/consume-user-data)
     00.01400s (init-network/config-set_hostname)
     00.01400s (azure-ds/_get_metadata_from_imds)
     00.01200s (modules-final/config-power-state-change)
     00.01000s (azure-ds/get_boot_telemetry)
     00.00900s (modules-final/config-final-message)
     00.00600s (modules-final/config-phone-home)
     00.00600s (azure-ds/check-platform-viability)
     00.00500s (init-network/config-update_etc_hosts)
     00.00300s (modules-config/config-timezone)
     00.00200s (modules-config/config-ubuntu-advantage)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-write-files)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (init-network/config-migrator)
     00.00200s (azure-ds/write_files)
     00.00200s (azure-ds/waiting-for-ssh-public-key)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-network/config-bootcmd)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_get_random_seed)
     00.00100s (azure-ds/_extract_preprovisioned_vm_setting)
     00.00000s (modules-final/config-scripts-per-instance)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)

1 boot records analyzed
+ echo After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 --After upgrade Networking config
 cat /etc/network/interfaces.d/50-cloud-init.cfg
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 --Get cloud-id
 cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ sshValidating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- sudo reboot
sudo: unable to resolve host SRU-worked-azure
Connection to 104.208.152.120 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.152.120 -- cloud-init status --wait --long

status: done
time: Fri, 17 Jan 2020 21:23:04 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/nullAfter reboot
 -o LogLevel=ERROR ubuntu@104.208.152.120 -- grep 'Update datasource' /var/log/cloud-init.log
2020-01-17 21:21:52,361 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-17 21:22:56,666 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-17 21:22:57,149 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ [  = --nics sruNic-xenial sruNic2-xenial --size Standard_DS2_v2 ]
+ [ true = false ]
+ echo Creating advanced network vm
+ name=test-sru-xenial-advanced
+ az network public-ip create --name sruPublicIP-IPv4-xenial --resource-group srugroupIPV6Creating advanced network vm
 --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"014a9c7e-210b-4043-bc14-a144a9e9c95b\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-xenial",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv4-xenial",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "463a438c-0dc1-4ef0-8e9a-1551c72a03f8",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name sruPublicIP-IPv6-xenial --resource-group srugroupIPV6 --version IPv6
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"5e30c275-135b-4add-9ac9-16a039f2ddad\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv6-xenial",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv6-xenial",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv6",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "59924fc9-b6e9-4873-ae8b-bda066c9b675",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network nic create --resource-group srugroupIPV6 --name sruNic-xenial --vnet-name sruVnet --subnet sruSubnet --accelerated-networking true --private-ip-address-version IPv4 --public-ip-address sruPublicIP-IPv4-xenial --network-security-group sruNetSecGroup
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "kw5klrplejnuzhpgax3tr3jyec.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"31c7c50b-ca52-4158-8df5-86b9a05d61ec\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-xenial",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"31c7c50b-ca52-4158-8df5-86b9a05d61ec\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-xenial/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "192.168.0.5",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": {
          "ddosSettings": null,
          "dnsSettings": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-xenial",
          "idleTimeoutInMinutes": null,
          "ipAddress": null,
          "ipConfiguration": null,
          "ipTags": null,
          "location": null,
          "name": null,
          "provisioningState": null,
          "publicIpAddressVersion": null,
          "publicIpAllocationMethod": null,
          "publicIpPrefix": null,
          "resourceGroup": "srugroupIPV6",
          "resourceGuid": null,
          "sku": null,
          "tags": null,
          "type": null,
          "zones": null
        },
        "resourceGroup": "srugroupIPV6",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroupIPV6",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic-xenial",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroupIPV6",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "cad23cf5-1d1f-4fcf-943e-5b06d26d5719",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic create --resource-group srugroupIPV6 --name sruNic2-xenial --vnet-name sruVnet --subnet sruSubnet --accelerated-networking true --private-ip-address-version IPv4 --network-security-group sruNetSecGroup
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "kw5klrplejnuzhpgax3tr3jyec.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"5bf267b6-e7a1-4977-9fe2-b9e8461b67d4\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic2-xenial",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"5bf267b6-e7a1-4977-9fe2-b9e8461b67d4\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic2-xenial/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "192.168.0.6",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": null,
        "resourceGroup": "srugroupIPV6",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroupIPV6",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic2-xenial",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroupIPV6",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "2c19fc3d-2644-43f5-afbc-01f54176bad5",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic ip-config create --name sruNic-xenial-IPv6Config --nic-name sruNic-xenial --resource-group srugroupIPV6 --vnet-name sruVnet --subnet sruSubnet --private-ip-address-version IPv6
{
  "applicationGatewayBackendAddressPools": null,
  "applicationSecurityGroups": null,
  "etag": "W/\"d373a5c3-5709-4d8d-a667-2adb5850fda5\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-xenial/ipConfigurations/sruNic-xenial-IPv6Config",
  "loadBalancerBackendAddressPools": null,
  "loadBalancerInboundNatRules": null,
  "name": "sruNic-xenial-IPv6Config",
  "primary": null,
  "privateIpAddress": "ace:cab:deca:deed::4",
  "privateIpAddressVersion": "IPv6",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": null,
  "resourceGroup": "srugroupIPV6",
  "subnet": {
    "addressPrefix": null,
    "addressPrefixes": null,
    "delegations": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
    "ipConfigurationProfiles": null,
    "ipConfigurations": null,
    "name": null,
    "natGateway": null,
    "networkSecurityGroup": null,
    "privateEndpointNetworkPolicies": null,
    "privateEndpoints": null,
    "privateLinkServiceNetworkPolicies": null,
    "provisioningState": null,
    "purpose": null,
    "resourceGroup": "srugroupIPV6",
    "resourceNavigationLinks": null,
    "routeTable": null,
    "serviceAssociationLinks": null,
    "serviceEndpointPolicies": null,
    "serviceEndpoints": null
  },
  "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
  "virtualNetworkTaps": null
}
+ az vm create --name=test-sru-xenial-advanced --image=Canonical:UbuntuServer:16.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml --nics sruNic-xenial sruNic2-xenial --size Standard_DS2_v2
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-xenial-advanced",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7C-24-CC,00-0D-3A-7C-20-B3",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.5,ace:cab:deca:deed::4,192.168.0.6",
  "publicIpAddress": "104.208.243.180",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-xenial-advanced
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@104.208.243.180
+ echo Created test-sru-xenial-advanced: ubuntu@ubuntu@104.208.243.180
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 --Created test-sru-xenial-advanced: ubuntu@ubuntu@104.208.243.180
 cloud-init status --wait --long

status: done
time: Fri, 17 Jan 2020 21:26:38 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- dpkg-query --show cloud-init
cloud-init	19.3-41-gc4735dd3-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- systemd-analyze
Startup finished in 4.550s (kernel) + 22.453s (userspace) = 27.003s
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- systemd-analyze blame
          5.838s cloud-init.service
          3.628s cloud-config.service
          3.587s cloud-init-local.service
          2.788s snapd.service
          2.441s lxd-containers.service
          2.399s pollinate.service
          2.031s snapd.seeded.service
          1.843s dev-sda1.device
          1.307s console-setup.service
          1.264s accounts-daemon.service
           985ms apparmor.service
           851ms networking.service
           836ms lvm2-monitor.service
           780ms iscsid.service
           742ms mdadm.service
           668ms grub-common.service
           644ms cloud-final.service
           368ms snapd.socket
           359ms systemd-modules-load.service
           348ms lxd.socket
           253ms systemd-tmpfiles-setup-dev.service
           249ms systemd-timesyncd.service
           244ms systemd-logind.service
           220ms rsyslog.service
           181ms open-iscsi.service
           155ms systemd-journal-flush.service
           155ms systemd-udev-trigger.service
           154ms systemd-journald.service
           146ms resolvconf.service
           134ms irqbalance.service
           118ms keyboard-setup.service
           109ms apport.service
            96ms systemd-udevd.service
            94ms ufw.service
            85ms ssh.service
            85ms polkitd.service
            77ms systemd-remount-fs.service
            74ms ondemand.service
            64ms kmod-static-nodes.service
            64ms dev-mqueue.mount
            55ms plymouth-read-write.service
            53ms systemd-random-seed.service
            52ms systemd-machine-id-commit.service
            48ms sys-kernel-debug.mount
            37ms systemd-update-utmp.service
            33ms systemd-user-sessions.service
            29ms rc-local.service
            26ms boot-efi.mount
            24ms systemd-sysctl.service
            23ms user@1000.service
            23ms dev-hugepages.mount
            22ms setvtrgb.service
            17ms sys-kernel-config.mount
            16ms systemd-tmpfiles-setup.service
            16ms ephemeral-disk-warning.service
            14ms plymouth-quit.service
            12ms plymouth-quit-wait.service
            10ms sys-fs-fuse-connections.mount
             8ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.02000s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.13400s +00.00800s
|`->get_boot_telemetry @00.14200s +00.01100s
|`->get_system_info @00.15300s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.15400s +00.05300s
|`->load_azure_ds_dir @00.20700s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.33700s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.33700s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.01200 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01600 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.37800s +00.24900s
|`->_get_metadata_from_imds @00.62700s +00.02700s
Finished stage: (azure-ds/get_metadata_from_imds) 00.32700 seconds

|`->_get_random_seed @00.70600s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.56100 seconds

|`->write_files @00.71600s +00.00200s
Finished stage: (azure-ds/_get_data) 00.58400 seconds

Finished stage: (init-local/search-Azure) 00.58900 seconds

|`->network config from fallback @00.79600s +00.01900s
Finished stage: (init-local) 00.84300 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @02.09900s +00.02700s
|`->network config from fallback @02.20000s +00.01500s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @02.23200s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

|`->invoke_agent @02.23500s +00.18200s
|`->wait for agents to retrieve ssh keys @02.41800s +01.00200s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @03.42000s +00.04400s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.04400 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 01.23400 seconds

Finished stage: (azure-ds/_negotiate) 01.23600 seconds

Finished stage: (azure-ds/setup) 01.23600 seconds

Finished stage: (init-network/setup-datasource) 01.23600 seconds

|`->reading and applying user-data @03.47500s +00.01000s
|`->reading and applying vendor-data @03.48500s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.52100s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.52200s +00.05300s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @03.63200s +00.00200s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.08300 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.13800 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.14000 seconds

Finished stage: (azure-ds/activate) 00.14000 seconds

Finished stage: (init-network/activate-datasource) 00.14200 seconds

|`->config-migrator ran successfully @03.72200s +00.00200s
|`->config-seed_random ran successfully @03.72400s +00.00200s
|`->config-bootcmd ran successfully @03.72700s +00.00000s
|`->config-write-files ran successfully @03.72800s +00.00100s
|`->config-growpart ran successfully @03.73000s +00.42000s
|`->config-resizefs ran successfully @04.15100s +00.25800s
|`->config-disk_setup ran successfully @04.41000s +02.40300s
|`->config-mounts ran successfully @06.81400s +00.11200s
|`->config-set_hostname ran successfully @06.92700s +00.00600s
|`->config-update_hostname ran successfully @06.93400s +00.00200s
|`->config-update_etc_hosts ran successfully @06.93700s +00.00000s
|`->config-ca-certs ran successfully @06.93800s +00.00100s
|`->config-rsyslog ran successfully @06.93900s +00.00200s
|`->config-users-groups ran successfully @06.94100s +00.29300s
|`->config-ssh ran successfully @07.23400s +00.30900s
Finished stage: (init-network) 05.46000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @13.40100s +00.00000s
|`->config-snap ran successfully @13.40200s +00.00200s
|`->config-snap_config ran successfully @13.40400s +00.00200s
|`->config-ssh-import-id ran successfully @13.40600s +00.65500s
|`->config-locale ran successfully @14.06200s +01.02500s
|`->config-set-passwords ran successfully @15.08800s +00.00200s
|`->config-grub-dpkg ran successfully @15.09100s +01.16700s
|`->config-apt-pipelining ran successfully @16.25900s +00.00100s
|`->config-apt-configure ran successfully @16.26100s +00.23500s
|`->config-ubuntu-advantage ran successfully @16.49700s +00.00100s
|`->config-ntp ran successfully @16.49900s +00.00100s
|`->config-timezone ran successfully @16.50100s +00.00100s
|`->config-disable-ec2-metadata ran successfully @16.50200s +00.00100s
|`->config-runcmd ran successfully @16.50300s +00.00200s
|`->config-byobu ran successfully @16.50500s +00.00200s
Finished stage: (modules-config) 03.15800 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @17.03500s +00.00300s
|`->config-package-update-upgrade-install ran successfully @17.03800s +00.00200s
|`->config-fan ran successfully @17.04000s +00.00100s
|`->config-landscape ran successfully @17.04200s +00.00100s
|`->config-lxd ran successfully @17.04300s +00.00100s
|`->config-ubuntu-drivers ran successfully @17.04500s +00.00100s
|`->config-puppet ran successfully @17.04700s +00.00100s
|`->config-chef ran successfully @17.04800s +00.00100s
|`->config-mcollective ran successfully @17.05000s +00.00100s
|`->config-salt-minion ran successfully @17.05200s +00.00100s
|`->config-rightscale_userdata ran successfully @17.05300s +00.00100s
|`->config-scripts-vendor ran successfully @17.05500s +00.00100s
|`->config-scripts-per-once ran successfully @17.05700s +00.00100s
|`->config-scripts-per-boot ran successfully @17.05800s +00.00000s
|`->config-scripts-per-instance ran successfully @17.05900s +00.00100s
|`->config-scripts-user ran successfully @17.06100s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @17.06300s +00.01000s
|`->config-keys-to-console ran successfully @17.07900s +00.04500s
|`->config-phone-home ran successfully @17.12400s +00.00100s
|`->config-final-message ran successfully @17.12600s +00.00500s
|`->config-power-state-change ran successfully @17.13100s +00.00100s
Finished stage: (modules-final) 00.19300 seconds

Total Time: 17.37600 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- cloud-init analyze blame
-- Boot Record 01 --
     02.40300s (init-network/config-disk_setup)
     01.16700s (modules-config/config-grub-dpkg)
     01.02500s (modules-config/config-locale)
     01.00200s (azure-ds/waiting-for-ssh-public-key)
     00.65500s (modules-config/config-ssh-import-id)
     00.42000s (init-network/config-growpart)
     00.30900s (init-network/config-ssh)
     00.29300s (init-network/config-users-groups)
     00.25800s (init-network/config-resizefs)
     00.24900s (azure-ds/obtain-dhcp-lease)
     00.23500s (modules-config/config-apt-configure)
     00.18200s (azure-ds/invoke_agent)
     00.11200s (init-network/config-mounts)
     00.05300s (azure-ds/list_possible_azure_ds_devs)
     00.05300s (azure-ds/_has_ntfs_filesystem)
     00.04500s (modules-final/config-keys-to-console)
     00.04400s (azure-ds/crtfile_to_pubkey)
     00.02700s (init-network/check-cache)
     00.02700s (azure-ds/_get_metadata_from_imds)
     00.01900s (azure-ds/parse_network_config)
     00.01500s (azure-ds/parse_network_config)
     00.01100s (azure-ds/get_boot_telemetry)
     00.01000s (modules-final/config-ssh-authkey-fingerprints)
     00.01000s (init-network/consume-user-data)
     00.00800s (azure-ds/check-platform-viability)
     00.00600s (init-network/config-set_hostname)
     00.00500s (modules-final/config-final-message)
     00.00300s (modules-final/config-snappy)
     00.00200s (modules-final/config-package-update-upgrade-install)
     00.00200s (modules-config/config-snap_config)
     00.00200s (modules-config/config-snap)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-runcmd)
     00.00200s (modules-config/config-byobu)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (init-network/config-rsyslog)
     00.00200s (init-network/config-migrator)
     00.00200s (azure-ds/write_files)
     00.00200s (azure-ds/count_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Networking config
+ ssh -o StrictHostKeyChecking=no -oNetworking config
 UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@104.208.243.180:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180+  -- sudo bashegrep ./setup_proposed.sh cloud-init

  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu xenial-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~16.04.1 [413 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~16.04.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~16.04.1) over (19.3-41-gc4735dd3-0ubuntu1~16.04.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~16.04.1) ...
Leaving 'diversion of /etc/init/ureadahead.conf to /etc/init/ureadahead.conf.disabled by cloud-init'
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~16.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- sudo hostname SRU-didnt-work
sudo: unable to resolve host SRU-worked-azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- sudo rm -f /etc/network/interfaces.d/50-cloud-init.cfg
sudo: unable to resolve host SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- sudo cloud-init clean --logs --reboot
sudo: unable to resolve host SRU-didnt-work
Connection to 104.208.243.180 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- cloud-init status --wait --long

status: done
time: Fri, 17 Jan 2020 21:28:18 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- grep Trace /var/log/cloud-init*
/var/log/cloud-init.log:Traceback (most recent call last):
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- sudo cat /run/cloud-init/result.json
sudo: unable to resolve host SRU-worked-azure
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- sudo systemd-analyze blame
sudo: unable to resolve host SRU-worked-azure
          2.121s cloud-init.service
          1.597s cloud-config.service
          1.383s cloud-init-local.service
           928ms dev-sda1.device
           713ms snapd.service
           690ms cloud-final.service
           640ms networking.service
           580ms lxd-containers.service
           440ms accounts-daemon.service
           440ms lvm2-monitor.service
           363ms grub-common.service
           302ms apparmor.service
           297ms mdadm.service
           293ms ssh.service
           287ms console-setup.service
           280ms rsyslog.service
           232ms polkitd.service
           203ms iscsid.service
           194ms mnt.mount
           177ms systemd-timesyncd.service
           167ms irqbalance.service
           138ms resolvconf.service
           130ms apport.service
           121ms systemd-udev-trigger.service
           110ms keyboard-setup.service
           109ms kmod-static-nodes.service
           107ms systemd-remount-fs.service
           106ms systemd-modules-load.service
           102ms ondemand.service
            85ms open-iscsi.service
            82ms systemd-user-sessions.service
            81ms sys-kernel-debug.mount
            80ms systemd-journald.service
            74ms ufw.service
            67ms systemd-logind.service
            66ms systemd-tmpfiles-setup-dev.service
            64ms snapd.socket
            57ms systemd-journal-flush.service
            49ms dev-hugepages.mount
            48ms systemd-update-utmp.service
            46ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            46ms systemd-random-seed.service
            42ms lxd.socket
            36ms snapd.seeded.service
            36ms dev-mqueue.mount
            29ms user@1000.service
            29ms systemd-tmpfiles-setup.service
            29ms rc-local.service
            26ms setvtrgb.service
            23ms plymouth-read-write.service
            23ms systemd-udevd.service
            22ms systemd-sysctl.service
            21ms plymouth-quit-wait.service
            19ms plymouth-quit.service
            15ms boot-efi.mount
            13ms systemd-update-utmp-runlevel.service
            12ms sys-fs-fuse-connections.mount
            12ms ephemeral-disk-warning.service
            10ms sys-kernel-config.mount
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00600s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03800s +00.00700s
|`->get_boot_telemetry @00.04500s +00.01000s
|`->get_system_info @00.05600s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.05600s +00.20200s
|`->load_azure_ds_dir @00.25800s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.26300s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.26400s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00500 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.28000s +00.14000s
|`->_get_metadata_from_imds @00.42000s +00.01200s
Finished stage: (azure-ds/get_metadata_from_imds) 00.19700 seconds

|`->_get_random_seed @00.48200s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.43400 seconds

|`->write_files @00.49100s +00.00300s
Finished stage: (azure-ds/_get_data) 00.45600 seconds

Finished stage: (init-local/search-Azure) 00.46100 seconds

|`->network config from fallback @00.56300s +00.01000s
Finished stage: (init-local) 00.59300 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @01.66000s +00.02800s
|`->network config from fallback @01.75700s +00.02400s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/get_metadata_from_agent
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @01.79600s +00.00100s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

|`->invoke_agent @01.80100s +00.18100s
|`->wait for agents to retrieve SSH keys @01.98200s +00.00200s
Starting stage: azure-ds/pubkeys_from_crt_files
|`->crtfile_to_pubkey @01.98400s +00.01200s
Finished stage: (azure-ds/pubkeys_from_crt_files) 00.01200 seconds

Finished stage: (azure-ds/get_metadata_from_agent) 00.20100 seconds

Finished stage: (azure-ds/_negotiate) 00.20200 seconds

Finished stage: (azure-ds/setup) 00.20300 seconds

Finished stage: (init-network/setup-datasource) 00.20300 seconds

|`->reading and applying user-data @02.00600s +00.00900s
|`->reading and applying vendor-data @02.01500s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @02.05000s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @02.05100s +00.10600s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.10600 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.10700 seconds

Finished stage: (azure-ds/activate) 00.10700 seconds

Finished stage: (init-network/activate-datasource) 00.11000 seconds

|`->config-migrator ran successfully @02.19900s +00.00100s
|`->config-seed_random ran successfully @02.20100s +00.00100s
|`->config-bootcmd ran successfully @02.20300s +00.00000s
|`->config-write-files ran successfully @02.20400s +00.00100s
|`->config-growpart ran successfully @02.20500s +00.04600s
|`->config-resizefs ran successfully @02.25200s +00.01800s
|`->config-disk_setup ran successfully @02.27000s +00.14300s
|`->config-mounts ran successfully @02.41300s +00.19800s
|`->config-set_hostname ran successfully @02.61200s +00.04300s
|`->config-update_hostname ran successfully @02.65600s +00.00100s
|`->config-update_etc_hosts ran successfully @02.65800s +00.00000s
|`->config-ca-certs ran successfully @02.65800s +00.00100s
|`->config-rsyslog ran successfully @02.65900s +00.00200s
|`->config-users-groups ran successfully @02.66200s +00.09700s
|`->config-ssh ran successfully @02.76000s +00.58400s
Finished stage: (init-network) 01.70000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @04.85400s +00.00100s
|`->config-snap ran successfully @04.85600s +00.00100s
|`->config-ssh-import-id ran successfully @04.85700s +00.66500s
|`->config-locale ran successfully @05.52300s +00.00200s
|`->config-set-passwords ran successfully @05.52600s +00.00200s
|`->config-grub-dpkg ran successfully @05.52800s +00.30200s
|`->config-apt-pipelining ran successfully @05.83100s +00.00100s
|`->config-apt-configure ran successfully @05.83300s +00.12300s
|`->config-ubuntu-advantage ran successfully @05.95700s +00.00200s
|`->config-ntp ran successfully @05.95900s +00.00100s
|`->config-timezone ran successfully @05.96100s +00.00100s
|`->config-disable-ec2-metadata ran successfully @05.96300s +00.00000s
|`->config-runcmd ran successfully @05.96300s +00.00200s
|`->config-byobu ran successfully @05.96500s +00.00100s
Finished stage: (modules-config) 01.13000 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @06.51900s +00.00100s
|`->config-fan ran successfully @06.52100s +00.00100s
|`->config-landscape ran successfully @06.52300s +00.00100s
|`->config-lxd ran successfully @06.52400s +00.00200s
|`->config-ubuntu-drivers ran successfully @06.52600s +00.00100s
|`->config-puppet ran successfully @06.52800s +00.00100s
|`->config-chef ran successfully @06.52900s +00.00100s
|`->config-mcollective ran successfully @06.53100s +00.00100s
|`->config-salt-minion ran successfully @06.53300s +00.00100s
|`->config-rightscale_userdata ran successfully @06.53400s +00.00200s
|`->config-scripts-vendor ran successfully @06.53600s +00.00100s
|`->config-scripts-per-once ran successfully @06.53800s +00.00100s
|`->config-scripts-per-boot ran successfully @06.53900s +00.00100s
|`->config-scripts-per-instance ran successfully @06.54000s +00.00100s
|`->config-scripts-user ran successfully @06.54200s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @06.54400s +00.05400s
|`->config-keys-to-console ran successfully @06.59900s +00.09200s
|`->config-phone-home ran successfully @06.69200s +00.00100s
|`->config-final-message ran successfully @06.69400s +00.00500s
|`->config-power-state-change ran successfully @06.70000s +00.00100s
Finished stage: (modules-final) 00.20000 seconds

Total Time: 6.43500 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- cloud-init analyze blame
-- Boot Record 01 --
     00.66500s (modules-config/config-ssh-import-id)
     00.58400s (init-network/config-ssh)
     00.30200s (modules-config/config-grub-dpkg)
     00.20200s (azure-ds/list_possible_azure_ds_devs)
     00.19800s (init-network/config-mounts)
     00.18100s (azure-ds/invoke_agent)
     00.14300s (init-network/config-disk_setup)
     00.14000s (azure-ds/obtain-dhcp-lease)
     00.12300s (modules-config/config-apt-configure)
     00.10600s (azure-ds/_has_ntfs_filesystem)
     00.09700s (init-network/config-users-groups)
     00.09200s (modules-final/config-keys-to-console)
     00.05400s (modules-final/config-ssh-authkey-fingerprints)
     00.04600s (init-network/config-growpart)
     00.04300s (init-network/config-set_hostname)
     00.02800s (init-network/check-cache)
     00.02400s (azure-ds/parse_network_config)
     00.01800s (init-network/config-resizefs)
     00.01200s (azure-ds/crtfile_to_pubkey)
     00.01200s (azure-ds/_get_metadata_from_imds)
     00.01000s (azure-ds/parse_network_config)
     00.01000s (azure-ds/get_boot_telemetry)
     00.00900s (init-network/consume-user-data)
     00.00700s (azure-ds/check-platform-viability)
     00.00500s (modules-final/config-final-message)
     00.00300s (azure-ds/write_files)
     00.00200s (modules-final/config-rightscale_userdata)
     00.00200s (modules-final/config-lxd)
     00.00200s (modules-config/config-ubuntu-advantage)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-runcmd)
     00.00200s (modules-config/config-locale)
     00.00200s (init-network/config-rsyslog)
     00.00200s (azure-ds/waiting-for-ssh-public-key)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/temporary_hostname)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade Networking config
+ ssh -oAfter upgrade Networking config
 StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- cat /etc/network/interfaces.d/50-cloud-init.cfg
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- cloud-idGet cloud-id

azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
 -- sudo reboot
sudo: unable to resolve host SRU-worked-azure
Connection to 104.208.243.180 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.243.180 -- cloud-init status --wait --long

status: done
time: Fri, 17 Jan 2020 21:29:23 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERRORAfter reboot
 ubuntu@104.208.243.180 -- grep 'Update datasource' /var/log/cloud-init.log
2020-01-17 21:28:11,769 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-17 21:29:16,674 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-17 21:29:17,254 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END xenial
+ echo ### BEGIN bionic
+ netcfg=/etc/netplan/50-cloud-init.yaml
### END xenial
### BEGIN bionic
+ image_version=18.04-DAILY-LTS
+ [  =  ]
+ echo Creating standard network vm
+ name=test-sru-bionic
Creating standard network vm
+ az vm create --name=test-sru-bionic --image=Canonical:UbuntuServer:18.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-bionic",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7A-C7-7E",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.7",
  "publicIpAddress": "104.208.140.61",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-bionic
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@104.208.140.61
+ echo Created test-sru-bionic: ubuntu@ubuntu@104.208.140.61
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- cloud-init status --wait --long
Created test-sru-bionic: ubuntu@ubuntu@104.208.140.61

status: done
time: Fri, 17 Jan 2020 21:34:12 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- dpkg-query --show cloud-init
cloud-init	19.3-41-gc4735dd3-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- systemd-analyze
Startup finished in 6.286s (kernel) + 32.078s (userspace) = 38.364s
graphical.target reached after 31.135s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- systemd-analyze blame
         10.795s cloud-init.service
          5.175s cloud-init-local.service
          2.929s cloud-config.service
          2.570s snapd.service
          2.568s lxd-containers.service
          2.446s dev-sda1.device
          2.408s pollinate.service
          2.338s snapd.seeded.service
          1.532s apparmor.service
          1.255s systemd-networkd-wait-online.service
           933ms networkd-dispatcher.service
           932ms cloud-final.service
           542ms systemd-udev-trigger.service
           518ms keyboard-setup.service
           468ms accounts-daemon.service
           467ms grub-common.service
           433ms systemd-timesyncd.service
           405ms systemd-modules-load.service
           340ms systemd-logind.service
           338ms lvm2-monitor.service
           303ms systemd-journald.service
           245ms apport.service
           229ms rsyslog.service
           202ms systemd-user-sessions.service
           174ms polkit.service
           170ms sys-kernel-debug.mount
           170ms dev-mqueue.mount
           169ms ufw.service
           167ms systemd-remount-fs.service
           164ms systemd-networkd.service
           156ms systemd-udevd.service
           153ms systemd-journal-flush.service
           152ms snapd.socket
           144ms ebtables.service
           144ms dev-hugepages.mount
           137ms lxd.socket
           137ms kmod-static-nodes.service
           136ms ssh.service
           106ms systemd-tmpfiles-setup-dev.service
           105ms systemd-resolved.service
            88ms systemd-sysctl.service
            83ms systemd-tmpfiles-setup.service
            78ms plymouth-quit.service
            73ms systemd-machine-id-commit.service
            68ms plymouth-read-write.service
            58ms setvtrgb.service
            50ms user@1000.service
            48ms blk-availability.service
            47ms systemd-random-seed.service
            41ms ephemeral-disk-warning.service
            37ms boot-efi.mount
            37ms console-setup.service
            37ms plymouth-quit-wait.service
            31ms systemd-update-utmp.service
            30ms sys-kernel-config.mount
            20ms sys-fs-fuse-connections.mount
            17ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00600s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.13700s +00.01000s
|`->get_boot_telemetry @00.14700s +00.01600s
|`->get_system_info @00.16300s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.16300s +00.03900s
|`->load_azure_ds_dir @00.20200s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.30900s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.30900s +00.00100s
Finished stage: (azure-ds/read_azure_ovf) 00.01200 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01500 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.34900s +00.38600s
|`->_get_metadata_from_imds @00.73500s +00.01900s
Finished stage: (azure-ds/get_metadata_from_imds) 00.43100 seconds

|`->_get_random_seed @00.77900s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.62700 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.79100s +00.00000s
|`->write_files @00.79200s +00.00200s
Finished stage: (azure-ds/_get_data) 00.65800 seconds

Finished stage: (init-local/search-Azure) 00.66100 seconds

|`->network config from imds @00.87500s +00.00100s
Finished stage: (init-local) 01.07700 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.16000s +00.03700s
|`->network config from imds @03.25600s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.26900s +00.00100s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.27400s +00.09700s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.37200s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00300 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.39500s +00.01300s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.40900s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.15200 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.56100s +00.01000s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.01100 seconds

Finished stage: (azure-ds/parse_certificates) 00.17700 seconds

|`->_report_ready @03.57200s +03.75800s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 04.05700 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 04.05800 seconds

Finished stage: (azure-ds/_negotiate) 04.06200 seconds

Finished stage: (azure-ds/setup) 04.06400 seconds

Finished stage: (init-network/setup-datasource) 04.06400 seconds

|`->reading and applying user-data @07.34800s +00.01100s
|`->reading and applying vendor-data @07.35900s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @07.40100s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @07.40300s +00.11500s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.60300s +00.00800s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.10500 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.22200 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.22300 seconds

Finished stage: (azure-ds/activate) 00.22300 seconds

Finished stage: (init-network/activate-datasource) 00.23200 seconds

|`->config-migrator ran successfully @07.68800s +00.00100s
|`->config-seed_random ran successfully @07.68900s +00.00200s
|`->config-bootcmd ran successfully @07.69200s +00.00000s
|`->config-write-files ran successfully @07.69300s +00.00100s
|`->config-growpart ran successfully @07.69400s +00.76800s
|`->config-resizefs ran successfully @08.46300s +01.70400s
|`->config-disk_setup ran successfully @10.16800s +02.38700s
|`->config-mounts ran successfully @12.55600s +00.23900s
|`->config-set_hostname ran successfully @12.79600s +00.00800s
|`->config-update_hostname ran successfully @12.80500s +00.00200s
|`->config-update_etc_hosts ran successfully @12.80700s +00.00100s
|`->config-ca-certs ran successfully @12.80800s +00.00100s
|`->config-rsyslog ran successfully @12.81000s +00.00100s
|`->config-users-groups ran successfully @12.81200s +00.29800s
|`->config-ssh ran successfully @13.11100s +00.19200s
Finished stage: (init-network) 10.16100 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @19.64700s +00.00100s
|`->config-snap ran successfully @19.64900s +00.00100s
|`->config-snap_config ran successfully @19.65000s +00.00200s
|`->config-ssh-import-id ran successfully @19.65200s +00.75400s
|`->config-locale ran successfully @20.41500s +00.00200s
|`->config-set-passwords ran successfully @20.41700s +00.00200s
|`->config-grub-dpkg ran successfully @20.42000s +01.23800s
|`->config-apt-pipelining ran successfully @21.65900s +00.00100s
|`->config-apt-configure ran successfully @21.66000s +00.13300s
|`->config-ubuntu-advantage ran successfully @21.79400s +00.00100s
|`->config-ntp ran successfully @21.79600s +00.00100s
|`->config-timezone ran successfully @21.79800s +00.00100s
|`->config-disable-ec2-metadata ran successfully @21.79900s +00.00100s
|`->config-runcmd ran successfully @21.80000s +00.00100s
|`->config-byobu ran successfully @21.80200s +00.00100s
Finished stage: (modules-config) 02.17600 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @22.60200s +00.00200s
|`->config-package-update-upgrade-install ran successfully @22.60500s +00.00100s
|`->config-fan ran successfully @22.60600s +00.00100s
|`->config-landscape ran successfully @22.60800s +00.00000s
|`->config-lxd ran successfully @22.60900s +00.00100s
|`->config-ubuntu-drivers ran successfully @22.61000s +00.00100s
|`->config-puppet ran successfully @22.61200s +00.00100s
|`->config-chef ran successfully @22.61300s +00.00100s
|`->config-mcollective ran successfully @22.61500s +00.00000s
|`->config-salt-minion ran successfully @22.61600s +00.00100s
|`->config-rightscale_userdata ran successfully @22.61700s +00.00100s
|`->config-scripts-vendor ran successfully @22.61900s +00.00100s
|`->config-scripts-per-once ran successfully @22.62000s +00.00100s
|`->config-scripts-per-boot ran successfully @22.62200s +00.00000s
|`->config-scripts-per-instance ran successfully @22.62300s +00.00100s
|`->config-scripts-user ran successfully @22.62400s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @22.62600s +00.04700s
|`->config-keys-to-console ran successfully @22.67500s +00.09700s
|`->config-phone-home ran successfully @22.77300s +00.00200s
|`->config-final-message ran successfully @22.77600s +00.00600s
|`->config-power-state-change ran successfully @22.78300s +00.00100s
Finished stage: (modules-final) 00.21000 seconds

Total Time: 37.68500 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- cloud-init analyze blame
-- Boot Record 01 --
     03.75800s (azure-ds/_report_ready)
     02.38700s (init-network/config-disk_setup)
     01.70400s (init-network/config-resizefs)
     01.23800s (modules-config/config-grub-dpkg)
     00.76800s (init-network/config-growpart)
     00.75400s (modules-config/config-ssh-import-id)
     00.38600s (azure-ds/obtain-dhcp-lease)
     00.29800s (init-network/config-users-groups)
     00.23900s (init-network/config-mounts)
     00.19200s (init-network/config-ssh)
     00.13300s (modules-config/config-apt-configure)
     00.11500s (azure-ds/_has_ntfs_filesystem)
     00.09700s (modules-final/config-keys-to-console)
     00.09700s (azure-ds/generate_certificate)
     00.04700s (modules-final/config-ssh-authkey-fingerprints)
     00.03900s (azure-ds/list_possible_azure_ds_devs)
     00.03700s (init-network/check-cache)
     00.01900s (azure-ds/_get_metadata_from_imds)
     00.01600s (azure-ds/get_boot_telemetry)
     00.01300s (azure-ds/_decrypt_certs_from_xml)
     00.01100s (init-network/consume-user-data)
     00.01000s (azure-ds/check-platform-viability)
     00.01000s (azure-ds/_run_x509_action)
     00.00800s (init-network/config-set_hostname)
     00.00800s (azure-ds/count_files)
     00.00600s (modules-final/config-final-message)
     00.00600s (azure-ds/_run_x509_action)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-config/config-snap_config)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-locale)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/temporary_hostname)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00100s (azure-ds/_extract_preprovisioned_vm_setting)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-mcollective)
     00.00000s (modules-final/config-landscape)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)

1 boot records analyzed
+ echo Networking config
Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            dhcp6: false
            match:
                macaddress: 00:0d:3a:7a:c7:7e
            set-name: eth0
    version: 2
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@104.208.140.61:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- sudo bash ./setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu bionic-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~18.04.1 [409 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~18.04.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~18.04.1) over (19.3-41-gc4735dd3-0ubuntu1~18.04.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~18.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- sudo cloud-init clean --logs --reboot
Connection to 104.208.140.61 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- cloud-init status --wait --long

status: done
time: Fri, 17 Jan 2020 21:35:47 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- sudo systemd-analyze blame
          2.970s cloud-config.service
          2.200s cloud-init.service
          1.978s dev-sda1.device
          1.734s cloud-init-local.service
          1.657s systemd-networkd-wait-online.service
          1.222s snapd.service
           993ms lxd-containers.service
           942ms cloud-final.service
           902ms networkd-dispatcher.service
           645ms grub-common.service
           633ms apparmor.service
           538ms accounts-daemon.service
           495ms systemd-timesyncd.service
           444ms lvm2-monitor.service
           386ms systemd-udev-trigger.service
           363ms apport.service
           356ms systemd-logind.service
           354ms keyboard-setup.service
           352ms ufw.service
           351ms systemd-remount-fs.service
           312ms ssh.service
           266ms systemd-journald.service
           261ms kmod-static-nodes.service
           259ms dev-hugepages.mount
           230ms systemd-user-sessions.service
           221ms systemd-modules-load.service
           219ms polkit.service
           191ms rsyslog.service
           157ms sys-kernel-debug.mount
           153ms ebtables.service
           118ms systemd-journal-flush.service
           107ms setvtrgb.service
           104ms systemd-tmpfiles-setup.service
            90ms lxd.socket
            85ms systemd-sysctl.service
            84ms snapd.socket
            82ms sys-kernel-config.mount
            81ms sys-fs-fuse-connections.mount
            81ms systemd-tmpfiles-setup-dev.service
            79ms dev-mqueue.mount
            73ms systemd-udevd.service
            72ms systemd-resolved.service
            67ms systemd-networkd.service
            62ms snapd.seeded.service
            55ms systemd-random-seed.service
            49ms user@1000.service
            48ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            43ms blk-availability.service
            43ms systemd-update-utmp.service
            25ms console-setup.service
            25ms plymouth-quit.service
            23ms systemd-update-utmp-runlevel.service
            21ms plymouth-quit-wait.service
            20ms plymouth-read-write.service
            17ms ephemeral-disk-warning.service
            16ms boot-efi.mount
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.04500s +00.01000s
|`->get_boot_telemetry @00.05500s +00.01600s
|`->get_system_info @00.07200s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.07200s +00.16500s
|`->load_azure_ds_dir @00.23700s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.24200s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.24300s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00500 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00600 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.26500s +00.28400s
|`->_get_metadata_from_imds @00.54900s +00.01600s
Finished stage: (azure-ds/get_metadata_from_imds) 00.32500 seconds

|`->_get_random_seed @00.59000s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.52800 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.60100s +00.00000s
|`->write_files @00.60200s +00.00200s
Finished stage: (azure-ds/_get_data) 00.55900 seconds

Finished stage: (init-local/search-Azure) 00.56300 seconds

|`->network config from imds @00.66600s +00.00000s
Finished stage: (init-local) 00.80800 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.20500s +00.03300s
|`->network config from imds @03.29300s +00.00100s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.30600s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.31000s +00.02800s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.34000s +00.00000s
Finished stage: (azure-ds/find_endpoint) 00.00400 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.36400s +00.01300s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.37900s +00.00700s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.06600 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.44500s +00.00700s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00800 seconds

Finished stage: (azure-ds/parse_certificates) 00.08800 seconds

|`->_report_ready @03.45300s +00.00700s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.15100 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.15200 seconds

Finished stage: (azure-ds/_negotiate) 00.15600 seconds

Finished stage: (azure-ds/setup) 00.15800 seconds

Finished stage: (init-network/setup-datasource) 00.15800 seconds

|`->reading and applying user-data @03.47100s +00.00900s
|`->reading and applying vendor-data @03.48000s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.51800s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.51900s +00.14000s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.14000 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.14100 seconds

Finished stage: (azure-ds/activate) 00.14100 seconds

Finished stage: (init-network/activate-datasource) 00.14400 seconds

|`->config-migrator ran successfully @03.70000s +00.00100s
|`->config-seed_random ran successfully @03.70100s +00.00200s
|`->config-bootcmd ran successfully @03.70600s +00.00100s
|`->config-write-files ran successfully @03.70700s +00.00100s
|`->config-growpart ran successfully @03.71000s +00.09200s
|`->config-resizefs ran successfully @03.80300s +00.02900s
|`->config-disk_setup ran successfully @03.83500s +00.17400s
|`->config-mounts ran successfully @04.01500s +00.21800s
|`->config-set_hostname ran successfully @04.23500s +00.00800s
|`->config-update_hostname ran successfully @04.24300s +00.00200s
|`->config-update_etc_hosts ran successfully @04.24600s +00.00000s
|`->config-ca-certs ran successfully @04.24700s +00.00100s
|`->config-rsyslog ran successfully @04.24800s +00.00200s
|`->config-users-groups ran successfully @04.25000s +00.19200s
|`->config-ssh ran successfully @04.44300s +00.25600s
Finished stage: (init-network) 01.51200 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @07.71600s +00.00200s
|`->config-snap ran successfully @07.72200s +00.00100s
|`->config-ssh-import-id ran successfully @07.72400s +01.05700s
|`->config-locale ran successfully @08.78400s +00.00300s
|`->config-set-passwords ran successfully @08.78800s +00.00200s
|`->config-grub-dpkg ran successfully @08.79700s +00.55500s
|`->config-apt-pipelining ran successfully @09.35300s +00.00200s
|`->config-apt-configure ran successfully @09.35500s +00.10600s
|`->config-ubuntu-advantage ran successfully @09.46200s +00.00100s
|`->config-ntp ran successfully @09.46300s +00.00100s
|`->config-timezone ran successfully @09.46500s +00.00000s
|`->config-disable-ec2-metadata ran successfully @09.46600s +00.00000s
|`->config-runcmd ran successfully @09.46700s +00.00100s
|`->config-byobu ran successfully @09.46800s +00.00200s
Finished stage: (modules-config) 01.78100 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @10.24700s +00.00100s
|`->config-fan ran successfully @10.24800s +00.00200s
|`->config-landscape ran successfully @10.25000s +00.00100s
|`->config-lxd ran successfully @10.25200s +00.00100s
|`->config-ubuntu-drivers ran successfully @10.25300s +00.00100s
|`->config-puppet ran successfully @10.25500s +00.00100s
|`->config-chef ran successfully @10.25600s +00.00100s
|`->config-mcollective ran successfully @10.25800s +00.00100s
|`->config-salt-minion ran successfully @10.25900s +00.00100s
|`->config-rightscale_userdata ran successfully @10.26100s +00.00100s
|`->config-scripts-vendor ran successfully @10.26300s +00.00100s
|`->config-scripts-per-once ran successfully @10.26400s +00.00100s
|`->config-scripts-per-boot ran successfully @10.26600s +00.00000s
|`->config-scripts-per-instance ran successfully @10.26700s +00.00100s
|`->config-scripts-user ran successfully @10.26800s +00.00200s
|`->config-ssh-authkey-fingerprints ran successfully @10.27100s +00.05200s
|`->config-keys-to-console ran successfully @10.32400s +00.09000s
|`->config-phone-home ran successfully @10.41600s +00.00100s
|`->config-final-message ran successfully @10.41800s +00.00700s
|`->config-power-state-change ran successfully @10.42500s +00.00100s
Finished stage: (modules-final) 00.20200 seconds

Total Time: 7.80000 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- cloud-init analyze blame
-- Boot Record 01 --
     01.05700s (modules-config/config-ssh-import-id)
     00.55500s (modules-config/config-grub-dpkg)
     00.28400s (azure-ds/obtain-dhcp-lease)
     00.25600s (init-network/config-ssh)
     00.21800s (init-network/config-mounts)
     00.19200s (init-network/config-users-groups)
     00.17400s (init-network/config-disk_setup)
     00.16500s (azure-ds/list_possible_azure_ds_devs)
     00.14000s (azure-ds/_has_ntfs_filesystem)
     00.10600s (modules-config/config-apt-configure)
     00.09200s (init-network/config-growpart)
     00.09000s (modules-final/config-keys-to-console)
     00.05200s (modules-final/config-ssh-authkey-fingerprints)
     00.03300s (init-network/check-cache)
     00.02900s (init-network/config-resizefs)
     00.02800s (azure-ds/generate_certificate)
     00.01600s (azure-ds/get_boot_telemetry)
     00.01600s (azure-ds/_get_metadata_from_imds)
     00.01300s (azure-ds/_decrypt_certs_from_xml)
     00.01000s (azure-ds/check-platform-viability)
     00.00900s (init-network/consume-user-data)
     00.00800s (init-network/config-set_hostname)
     00.00700s (modules-final/config-final-message)
     00.00700s (azure-ds/_run_x509_action)
     00.00700s (azure-ds/_run_x509_action)
     00.00700s (azure-ds/_report_ready)
     00.00300s (modules-config/config-locale)
     00.00200s (modules-final/config-scripts-user)
     00.00200s (modules-final/config-fan)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-emit_upstart)
     00.00200s (modules-config/config-byobu)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (init-network/config-rsyslog)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-timezone)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERRORAfter upgrade Networking config
 ubuntu@104.208.140.61 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            dhcp6: false
            match:
                macaddress: 00:0d:3a:7a:c7:7e
            set-name: eth0
    version: 2
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
+ ssh -o StrictHostKeyChecking=no -oGet cloud-id
 UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -oValidating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
 UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- sudo reboot
Connection to 104.208.140.61 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@104.208.140.61 -- cloud-init status --wait --long

status: done
time: Fri, 17 Jan 2020 21:36:52 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -oAfter reboot
 LogLevel=ERROR ubuntu@104.208.140.61 -- grep 'Update datasource' /var/log/cloud-init.log
2020-01-17 21:35:37,262 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-17 21:36:43,880 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-17 21:36:44,542 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ [  = --nics sruNic-bionic sruNic2-bionic --size Standard_DS2_v2 ]
+ [ true = false ]
+ echo Creating advanced network vm
+ name=test-sru-bionic-advanced
+ Creating advanced network vm
az network public-ip create --name sruPublicIP-IPv4-bionic --resource-group srugroupIPV6 --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"af31752a-fd60-4d9c-ae70-39676952deee\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-bionic",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv4-bionic",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "05a032ef-66ef-486e-a67b-b479cdf5c9b4",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name sruPublicIP-IPv6-bionic --resource-group srugroupIPV6 --version IPv6
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"97dd2287-e45e-4f11-be44-5046dcfebdbd\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv6-bionic",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv6-bionic",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv6",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "9deafd93-e94d-46c7-b627-fe9e91cddf5b",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network nic create --resource-group srugroupIPV6 --name sruNic-bionic --vnet-name sruVnet --subnet sruSubnet --accelerated-networking true --private-ip-address-version IPv4 --public-ip-address sruPublicIP-IPv4-bionic --network-security-group sruNetSecGroup
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "kw5klrplejnuzhpgax3tr3jyec.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"ea501ca6-491e-40c5-8d20-a13bf42a0908\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-bionic",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"ea501ca6-491e-40c5-8d20-a13bf42a0908\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-bionic/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "192.168.0.8",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": {
          "ddosSettings": null,
          "dnsSettings": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-bionic",
          "idleTimeoutInMinutes": null,
          "ipAddress": null,
          "ipConfiguration": null,
          "ipTags": null,
          "location": null,
          "name": null,
          "provisioningState": null,
          "publicIpAddressVersion": null,
          "publicIpAllocationMethod": null,
          "publicIpPrefix": null,
          "resourceGroup": "srugroupIPV6",
          "resourceGuid": null,
          "sku": null,
          "tags": null,
          "type": null,
          "zones": null
        },
        "resourceGroup": "srugroupIPV6",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroupIPV6",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic-bionic",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroupIPV6",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "6e790934-e7d2-4139-82a1-1ac46699db95",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic create --resource-group srugroupIPV6 --name sruNic2-bionic --vnet-name sruVnet --subnet sruSubnet --accelerated-networking true --private-ip-address-version IPv4 --network-security-group sruNetSecGroup
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "kw5klrplejnuzhpgax3tr3jyec.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"e402f381-50a6-422f-8324-3f6336df6ff1\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic2-bionic",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"e402f381-50a6-422f-8324-3f6336df6ff1\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic2-bionic/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "192.168.0.9",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": null,
        "resourceGroup": "srugroupIPV6",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroupIPV6",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic2-bionic",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroupIPV6",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "9e40990f-7736-4c59-8612-f83c98086df6",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic ip-config create --name sruNic-bionic-IPv6Config --nic-name sruNic-bionic --resource-group srugroupIPV6 --vnet-name sruVnet --subnet sruSubnet --private-ip-address-version IPv6
{
  "applicationGatewayBackendAddressPools": null,
  "applicationSecurityGroups": null,
  "etag": "W/\"964441b1-3c9d-49e7-bebd-d7cb584e39c9\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-bionic/ipConfigurations/sruNic-bionic-IPv6Config",
  "loadBalancerBackendAddressPools": null,
  "loadBalancerInboundNatRules": null,
  "name": "sruNic-bionic-IPv6Config",
  "primary": null,
  "privateIpAddress": "ace:cab:deca:deed::5",
  "privateIpAddressVersion": "IPv6",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": null,
  "resourceGroup": "srugroupIPV6",
  "subnet": {
    "addressPrefix": null,
    "addressPrefixes": null,
    "delegations": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
    "ipConfigurationProfiles": null,
    "ipConfigurations": null,
    "name": null,
    "natGateway": null,
    "networkSecurityGroup": null,
    "privateEndpointNetworkPolicies": null,
    "privateEndpoints": null,
    "privateLinkServiceNetworkPolicies": null,
    "provisioningState": null,
    "purpose": null,
    "resourceGroup": "srugroupIPV6",
    "resourceNavigationLinks": null,
    "routeTable": null,
    "serviceAssociationLinks": null,
    "serviceEndpointPolicies": null,
    "serviceEndpoints": null
  },
  "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
  "virtualNetworkTaps": null
}
+ az vm create --name=test-sru-bionic-advanced --image=Canonical:UbuntuServer:18.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml --nics sruNic-bionic sruNic2-bionic --size Standard_DS2_v2
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-bionic-advanced",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7B-42-A5,00-0D-3A-7B-41-A8",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.8,ace:cab:deca:deed::5,192.168.0.9",
  "publicIpAddress": "52.179.142.65",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-bionic-advanced
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@52.179.142.65
+ echo Created test-sru-bionic-advanced: ubuntu@ubuntu@52.179.142.65
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERRORCreated test-sru-bionic-advanced: ubuntu@ubuntu@52.179.142.65
 ubuntu@52.179.142.65 -- cloud-init status --wait --long

status: done
time: Fri, 17 Jan 2020 21:40:31 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- dpkg-query --show cloud-init
cloud-init	19.3-41-gc4735dd3-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- systemd-analyze
Startup finished in 8.386s (kernel) + 27.588s (userspace) = 35.975s
graphical.target reached after 26.865s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- systemd-analyze blame
          9.389s cloud-init.service
          4.623s cloud-init-local.service
          2.750s cloud-config.service
          2.525s lxd-containers.service
          2.468s snapd.service
          2.220s pollinate.service
          2.040s snapd.seeded.service
          1.743s dev-sda1.device
          1.342s systemd-networkd-wait-online.service
           882ms apparmor.service
           719ms cloud-final.service
           554ms networkd-dispatcher.service
           449ms accounts-daemon.service
           337ms lvm2-monitor.service
           330ms rsyslog.service
           298ms apport.service
           263ms systemd-timesyncd.service
           240ms systemd-modules-load.service
           229ms grub-common.service
           214ms keyboard-setup.service
           183ms systemd-udev-trigger.service
           180ms systemd-tmpfiles-setup-dev.service
           170ms polkit.service
           158ms user@1000.service
           138ms systemd-journal-flush.service
           133ms systemd-journald.service
           133ms systemd-networkd.service
           112ms systemd-logind.service
           111ms ebtables.service
           100ms systemd-machine-id-commit.service
            99ms ssh.service
            86ms systemd-udevd.service
            82ms systemd-user-sessions.service
            79ms systemd-tmpfiles-setup.service
            71ms plymouth-read-write.service
            65ms dev-mqueue.mount
            65ms blk-availability.service
            65ms systemd-resolved.service
            58ms dev-hugepages.mount
            55ms lxd.socket
            51ms systemd-sysctl.service
            49ms setvtrgb.service
            49ms systemd-remount-fs.service
            48ms ufw.service
            48ms kmod-static-nodes.service
            39ms snapd.socket
            39ms sys-kernel-debug.mount
            32ms plymouth-quit.service
            25ms systemd-random-seed.service
            24ms boot-efi.mount
            24ms ephemeral-disk-warning.service
            24ms console-setup.service
            20ms sys-fs-fuse-connections.mount
            16ms sys-kernel-config.mount
            16ms plymouth-quit-wait.service
            14ms systemd-update-utmp-runlevel.service
            14ms systemd-update-utmp.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00500s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.12700s +00.01000s
|`->get_boot_telemetry @00.13700s +00.01400s
|`->get_system_info @00.15100s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.15200s +00.03100s
|`->load_azure_ds_dir @00.18400s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.28300s +00.00100s
|`->_extract_preprovisioned_vm_setting @00.28400s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.01200 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01500 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.31900s +00.44800s
|`->_get_metadata_from_imds @00.76700s +00.01800s
Finished stage: (azure-ds/get_metadata_from_imds) 00.48100 seconds

|`->_get_random_seed @00.80100s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.65900 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.81100s +00.00100s
|`->write_files @00.81200s +00.00200s
Finished stage: (azure-ds/_get_data) 00.68800 seconds

Finished stage: (init-local/search-Azure) 00.69000 seconds

|`->network config from imds @00.88200s +00.00000s
Finished stage: (init-local) 01.08300 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.10600s +00.03000s
|`->network config from imds @03.18400s +00.00100s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.19600s +00.00100s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.20100s +00.34000s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.54200s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00300 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.56200s +00.01200s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.57500s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.14500 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.72000s +00.00700s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.16500 seconds

|`->_report_ready @03.72800s +03.24300s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.77100 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.77200 seconds

Finished stage: (azure-ds/_negotiate) 03.77600 seconds

Finished stage: (azure-ds/setup) 03.77600 seconds

Finished stage: (init-network/setup-datasource) 03.77600 seconds

|`->reading and applying user-data @06.98700s +00.01000s
|`->reading and applying vendor-data @06.99700s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @07.07800s +00.01100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @07.11400s +00.18600s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.36000s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.06700 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.27300 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.29100 seconds

Finished stage: (azure-ds/activate) 00.30200 seconds

Finished stage: (init-network/activate-datasource) 00.32600 seconds

|`->config-migrator ran successfully @07.41600s +00.00100s
|`->config-seed_random ran successfully @07.41700s +00.00200s
|`->config-bootcmd ran successfully @07.41900s +00.00000s
|`->config-write-files ran successfully @07.41900s +00.00200s
|`->config-growpart ran successfully @07.42100s +00.60900s
|`->config-resizefs ran successfully @08.03100s +01.70100s
|`->config-disk_setup ran successfully @09.73300s +01.34300s
|`->config-mounts ran successfully @11.07600s +00.17000s
|`->config-set_hostname ran successfully @11.24700s +00.00700s
|`->config-update_hostname ran successfully @11.25500s +00.00200s
|`->config-update_etc_hosts ran successfully @11.25800s +00.00000s
|`->config-ca-certs ran successfully @11.25800s +00.00200s
|`->config-rsyslog ran successfully @11.26000s +00.00100s
|`->config-users-groups ran successfully @11.26200s +00.27200s
|`->config-ssh ran successfully @11.53500s +00.20600s
Finished stage: (init-network) 08.65000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @17.42300s +00.00100s
|`->config-snap ran successfully @17.42400s +00.00100s
|`->config-snap_config ran successfully @17.42600s +00.00100s
|`->config-ssh-import-id ran successfully @17.42700s +00.72800s
|`->config-locale ran successfully @18.15500s +00.00200s
|`->config-set-passwords ran successfully @18.15800s +00.00200s
|`->config-grub-dpkg ran successfully @18.16000s +01.26900s
|`->config-apt-pipelining ran successfully @19.43000s +00.00100s
|`->config-apt-configure ran successfully @19.43200s +00.11900s
|`->config-ubuntu-advantage ran successfully @19.55200s +00.00100s
|`->config-ntp ran successfully @19.55400s +00.00100s
|`->config-timezone ran successfully @19.55500s +00.00100s
|`->config-disable-ec2-metadata ran successfully @19.55600s +00.00100s
|`->config-runcmd ran successfully @19.55700s +00.00100s
|`->config-byobu ran successfully @19.55900s +00.00100s
Finished stage: (modules-config) 02.20000 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @20.17500s +00.00300s
|`->config-package-update-upgrade-install ran successfully @20.17800s +00.00100s
|`->config-fan ran successfully @20.18000s +00.00100s
|`->config-landscape ran successfully @20.18100s +00.00100s
|`->config-lxd ran successfully @20.18200s +00.00200s
|`->config-ubuntu-drivers ran successfully @20.18400s +00.00100s
|`->config-puppet ran successfully @20.18500s +00.00100s
|`->config-chef ran successfully @20.18700s +00.00100s
|`->config-mcollective ran successfully @20.18800s +00.00200s
|`->config-salt-minion ran successfully @20.19000s +00.00200s
|`->config-rightscale_userdata ran successfully @20.19200s +00.00100s
|`->config-scripts-vendor ran successfully @20.19400s +00.00100s
|`->config-scripts-per-once ran successfully @20.19500s +00.00100s
|`->config-scripts-per-boot ran successfully @20.19600s +00.00100s
|`->config-scripts-per-instance ran successfully @20.19700s +00.00100s
|`->config-scripts-user ran successfully @20.19900s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @20.20000s +00.00900s
|`->config-keys-to-console ran successfully @20.21000s +00.04900s
|`->config-phone-home ran successfully @20.25900s +00.00100s
|`->config-final-message ran successfully @20.26000s +00.00600s
|`->config-power-state-change ran successfully @20.27700s +00.00100s
Finished stage: (modules-final) 00.15600 seconds

Total Time: 35.08800 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- cloud-init analyze blame
-- Boot Record 01 --
     03.24300s (azure-ds/_report_ready)
     01.70100s (init-network/config-resizefs)
     01.34300s (init-network/config-disk_setup)
     01.26900s (modules-config/config-grub-dpkg)
     00.72800s (modules-config/config-ssh-import-id)
     00.60900s (init-network/config-growpart)
     00.44800s (azure-ds/obtain-dhcp-lease)
     00.34000s (azure-ds/generate_certificate)
     00.27200s (init-network/config-users-groups)
     00.20600s (init-network/config-ssh)
     00.18600s (azure-ds/_has_ntfs_filesystem)
     00.17000s (init-network/config-mounts)
     00.11900s (modules-config/config-apt-configure)
     00.04900s (modules-final/config-keys-to-console)
     00.03100s (azure-ds/list_possible_azure_ds_devs)
     00.03000s (init-network/check-cache)
     00.01800s (azure-ds/_get_metadata_from_imds)
     00.01400s (azure-ds/get_boot_telemetry)
     00.01200s (azure-ds/_decrypt_certs_from_xml)
     00.01100s (azure-ds/wait-for-ephemeral-disk)
     00.01000s (init-network/consume-user-data)
     00.01000s (azure-ds/check-platform-viability)
     00.00900s (modules-final/config-ssh-authkey-fingerprints)
     00.00700s (init-network/config-set_hostname)
     00.00700s (azure-ds/_run_x509_action)
     00.00600s (modules-final/config-final-message)
     00.00600s (azure-ds/_run_x509_action)
     00.00300s (modules-final/config-snappy)
     00.00200s (modules-final/config-salt-minion)
     00.00200s (modules-final/config-mcollective)
     00.00200s (modules-final/config-lxd)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-locale)
     00.00200s (init-network/config-write-files)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (init-network/config-ca-certs)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (azure-ds/temporary_hostname)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/load_azure_ovf_pubkeys)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65Networking config
 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides: &id001
                route-metric: 100
            dhcp6: true
            dhcp6-overrides: *id001
            match:
                macaddress: 00:0d:3a:7b:42:a5
            set-name: eth0
        eth1:
            dhcp4: true
            dhcp4-overrides: &id002
                route-metric: 200
            dhcp6: true
            dhcp6-overrides: *id002
            match:
                macaddress: 00:0d:3a:7b:41:a8
            set-name: eth1
    version: 2
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@52.179.142.65:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- sudo bash+  ./setup_proposed.sh
egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu bionic-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~18.04.1 [409 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~18.04.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~18.04.1) over (19.3-41-gc4735dd3-0ubuntu1~18.04.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~18.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- sudo cloud-init clean --logs --reboot
Connection to 52.179.142.65 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- cloud-init status --wait --long
............................................................................................................................................................................................................................
status: done
time: Fri, 17 Jan 2020 21:43:32 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- sudo systemd-analyze blame
     1min 6.408s cloud-config.service
         15.556s cloud-init.service
          2.265s systemd-networkd-wait-online.service
          1.443s cloud-init-local.service
           928ms dev-sda1.device
           668ms lxd-containers.service
           667ms snapd.service
           664ms cloud-final.service
           430ms networkd-dispatcher.service
           352ms grub-common.service
           335ms accounts-daemon.service
           278ms apparmor.service
           260ms apport.service
           249ms keyboard-setup.service
           214ms systemd-udev-trigger.service
           211ms systemd-timesyncd.service
           201ms snapd.socket
           201ms lvm2-monitor.service
           188ms lxd.socket
           154ms systemd-journald.service
           147ms systemd-modules-load.service
           143ms systemd-user-sessions.service
           140ms ssh.service
           122ms systemd-logind.service
           115ms rsyslog.service
            97ms systemd-udevd.service
            93ms polkit.service
            72ms sys-kernel-debug.mount
            68ms systemd-remount-fs.service
            68ms ufw.service
            68ms systemd-journal-flush.service
            62ms dev-mqueue.mount
            59ms kmod-static-nodes.service
            58ms systemd-resolved.service
            55ms dev-hugepages.mount
            51ms setvtrgb.service
            49ms systemd-tmpfiles-setup.service
            48ms ebtables.service
            42ms systemd-networkd.service
            41ms user@1000.service
            39ms systemd-tmpfiles-setup-dev.service
            34ms console-setup.service
            32ms systemd-sysctl.service
            30ms snapd.seeded.service
            22ms plymouth-quit.service
            19ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            17ms boot-efi.mount
            14ms plymouth-read-write.service
            14ms blk-availability.service
            12ms systemd-update-utmp-runlevel.service
            11ms ephemeral-disk-warning.service
            11ms systemd-random-seed.service
            11ms systemd-update-utmp.service
            10ms sys-fs-fuse-connections.mount
             9ms sys-kernel-config.mount
             8ms plymouth-quit-wait.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.04000s +00.00900s
|`->get_boot_telemetry @00.04900s +00.01400s
|`->get_system_info @00.06300s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.06400s +00.20200s
|`->load_azure_ds_dir @00.26600s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.27000s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.27000s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.28700s +00.16800s
|`->_get_metadata_from_imds @00.45500s +00.00900s
Finished stage: (azure-ds/get_metadata_from_imds) 00.23300 seconds

|`->_get_random_seed @00.52000s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.46700 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.53100s +00.00100s
|`->write_files @00.53200s +00.00300s
Finished stage: (azure-ds/_get_data) 00.49500 seconds

Finished stage: (init-local/search-Azure) 00.49900 seconds

|`->network config from imds @00.62800s +00.00000s
Finished stage: (init-local) 00.78100 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.63100s +00.03400s
|`->network config from imds @03.71900s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.73200s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00500 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.73700s +00.06800s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.80600s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00300 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @09.83900s +00.01500s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @09.85500s +00.00700s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.02100 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @09.87700s +00.00700s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.04500 seconds

|`->_report_ready @09.88500s +06.01500s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 12.16500 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 12.16500 seconds

Finished stage: (azure-ds/_negotiate) 12.17100 seconds

Finished stage: (azure-ds/setup) 12.17100 seconds

Finished stage: (init-network/setup-datasource) 12.17100 seconds

|`->reading and applying user-data @15.91100s +00.01100s
|`->reading and applying vendor-data @15.92200s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @15.95400s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @15.95500s +00.12700s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.12700 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.12800 seconds

Finished stage: (azure-ds/activate) 00.12800 seconds

Finished stage: (init-network/activate-datasource) 00.13100 seconds

|`->config-migrator ran successfully @16.11900s +00.00100s
|`->config-seed_random ran successfully @16.12100s +00.00100s
|`->config-bootcmd ran successfully @16.12300s +00.00000s
|`->config-write-files ran successfully @16.12400s +00.00100s
|`->config-growpart ran successfully @16.12500s +00.09200s
|`->config-resizefs ran successfully @16.21700s +00.03000s
|`->config-disk_setup ran successfully @16.24800s +00.10600s
|`->config-mounts ran successfully @16.35400s +00.15000s
|`->config-set_hostname ran successfully @16.50400s +00.00700s
|`->config-update_hostname ran successfully @16.51200s +00.00200s
|`->config-update_etc_hosts ran successfully @16.51400s +00.00000s
|`->config-ca-certs ran successfully @16.51500s +00.00100s
|`->config-rsyslog ran successfully @16.51600s +00.00100s
|`->config-users-groups ran successfully @16.51700s +01.77300s
|`->config-ssh ran successfully @18.29100s +00.37700s
Finished stage: (init-network) 15.05200 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @20.41200s +00.00100s
|`->config-snap ran successfully @20.41300s +00.00200s
|`->config-ssh-import-id ran successfully @20.41500s +63.74400s
|`->config-locale ran successfully @84.16000s +00.00200s
|`->config-set-passwords ran successfully @84.16300s +00.00200s
|`->config-grub-dpkg ran successfully @84.16600s +01.93700s
|`->config-apt-pipelining ran successfully @86.10400s +00.00200s
|`->config-apt-configure ran successfully @86.10600s +00.10500s
|`->config-ubuntu-advantage ran successfully @86.21300s +00.00100s
|`->config-ntp ran successfully @86.21400s +00.00100s
|`->config-timezone ran successfully @86.21600s +00.00100s
|`->config-disable-ec2-metadata ran successfully @86.21700s +00.00100s
|`->config-runcmd ran successfully @86.21800s +00.00200s
|`->config-byobu ran successfully @86.22000s +00.00100s
Finished stage: (modules-config) 65.82500 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @86.81000s +00.00100s
|`->config-fan ran successfully @86.81100s +00.00200s
|`->config-landscape ran successfully @86.81300s +00.00100s
|`->config-lxd ran successfully @86.81500s +00.00100s
|`->config-ubuntu-drivers ran successfully @86.81600s +00.00100s
|`->config-puppet ran successfully @86.81800s +00.00100s
|`->config-chef ran successfully @86.81900s +00.00100s
|`->config-mcollective ran successfully @86.82100s +00.00100s
|`->config-salt-minion ran successfully @86.82200s +00.00100s
|`->config-rightscale_userdata ran successfully @86.82400s +00.00100s
|`->config-scripts-vendor ran successfully @86.82500s +00.00100s
|`->config-scripts-per-once ran successfully @86.82700s +00.00100s
|`->config-scripts-per-boot ran successfully @86.82800s +00.00100s
|`->config-scripts-per-instance ran successfully @86.82900s +00.00100s
|`->config-scripts-user ran successfully @86.83100s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @86.83200s +00.04700s
|`->config-keys-to-console ran successfully @86.87900s +00.02200s
|`->config-phone-home ran successfully @86.90200s +00.00100s
|`->config-final-message ran successfully @86.90300s +00.00600s
|`->config-power-state-change ran successfully @86.91000s +00.00000s
Finished stage: (modules-final) 00.12200 seconds

Total Time: 144.92000 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- cloud-init analyze blame
-- Boot Record 01 --
     63.74400s (modules-config/config-ssh-import-id)
     06.01500s (azure-ds/_report_ready)
     01.93700s (modules-config/config-grub-dpkg)
     01.77300s (init-network/config-users-groups)
     00.37700s (init-network/config-ssh)
     00.20200s (azure-ds/list_possible_azure_ds_devs)
     00.16800s (azure-ds/obtain-dhcp-lease)
     00.15000s (init-network/config-mounts)
     00.12700s (azure-ds/_has_ntfs_filesystem)
     00.10600s (init-network/config-disk_setup)
     00.10500s (modules-config/config-apt-configure)
     00.09200s (init-network/config-growpart)
     00.06800s (azure-ds/generate_certificate)
     00.04700s (modules-final/config-ssh-authkey-fingerprints)
     00.03400s (init-network/check-cache)
     00.03000s (init-network/config-resizefs)
     00.02200s (modules-final/config-keys-to-console)
     00.01500s (azure-ds/_decrypt_certs_from_xml)
     00.01400s (azure-ds/get_boot_telemetry)
     00.01100s (init-network/consume-user-data)
     00.00900s (azure-ds/check-platform-viability)
     00.00900s (azure-ds/_get_metadata_from_imds)
     00.00700s (init-network/config-set_hostname)
     00.00700s (azure-ds/_run_x509_action)
     00.00700s (azure-ds/_run_x509_action)
     00.00600s (modules-final/config-final-message)
     00.00300s (azure-ds/write_files)
     00.00200s (modules-final/config-fan)
     00.00200s (modules-config/config-snap)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-runcmd)
     00.00200s (modules-config/config-locale)
     00.00200s (modules-config/config-apt-pipelining)
     00.00200s (init-network/config-update_hostname)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-power-state-change)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65After upgrade Networking config
 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides: &id001
                route-metric: 100
            dhcp6: true
            dhcp6-overrides: *id001
            match:
                macaddress: 00:0d:3a:7b:42:a5
            set-name: eth0
        eth1:
            dhcp4: true
            dhcp4-overrides: &id002
                route-metric: 200
            dhcp6: true
            dhcp6-overrides: *id002
            match:
                macaddress: 00:0d:3a:7b:41:a8
            set-name: eth1
    version: 2
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
+ ssh -o StrictHostKeyChecking=noGet cloud-id
 -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -oValidating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
 StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- sudo reboot
Connection to 52.179.142.65 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- cloud-init status --wait --long
ssh: connect to host 52.179.142.65 port 22: Connection timed out
+ echo After reboot
+ sshAfter reboot
 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@52.179.142.65 -- grep 'Update datasource' /var/log/cloud-init.log
2020-01-17 21:42:06,002 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-17 21:44:08,946 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-17 21:45:39,949 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END bionic
+ echo### END bionic
 ### BEGIN eoan
+ netcfg=/etc/netplan/50-cloud-init.yaml
### BEGIN eoan
+ image_version=19.10-DAILY
+ [  =  ]
+ echo Creating standard network vm
+ name=test-sru-eoan
Creating standard network vm
+ az vm create --name=test-sru-eoan --image=Canonical:UbuntuServer:19.10-DAILY:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-eoan",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7A-A4-C8",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.10",
  "publicIpAddress": "40.84.2.35",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-eoan
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@40.84.2.35
+ echo Created test-sru-eoan: ubuntu@ubuntu@40.84.2.35
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- cloud-init status --wait --longCreated test-sru-eoan: ubuntu@ubuntu@40.84.2.35

........................................................................................................................................................................
status: done
time: Fri, 17 Jan 2020 21:52:03 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- dpkg-query --show cloud-init
cloud-init	19.3-41-gc4735dd3-0ubuntu1~19.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- systemd-analyze
Startup finished in 3.734s (kernel) + 1min 29.524s (userspace) = 1min 33.259s
graphical.target reached after 1min 28.611s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- systemd-analyze blame
         56.240s snapd.seeded.service
         11.989s pollinate.service
         11.147s cloud-init.service
          5.474s cloud-init-local.service
          3.294s lvm2-monitor.service
          3.177s dev-sda1.device
          3.011s systemd-udev-settle.service
          3.005s cloud-config.service
          1.517s systemd-logind.service
          1.317s apparmor.service
          1.311s accounts-daemon.service
          1.284s snapd.service
          1.188s networkd-dispatcher.service
          1.123s systemd-networkd-wait-online.service
           918ms cloud-final.service
           851ms systemd-timesyncd.service
           849ms grub-common.service
           761ms systemd-journald.service
           608ms rsyslog.service
           521ms systemd-resolved.service
           514ms systemd-udevd.service
           485ms systemd-udev-trigger.service
           453ms snap.lxd.activate.service
           439ms grub-initrd-fallback.service
           401ms systemd-user-sessions.service
           397ms systemd-networkd.service
           358ms keyboard-setup.service
           346ms atd.service
           333ms apport.service
           327ms ufw.service
           303ms systemd-modules-load.service
           283ms dev-hugepages.mount
           274ms systemd-remount-fs.service
           273ms sys-kernel-debug.mount
           267ms dev-mqueue.mount
           240ms snapd.socket
           240ms kmod-static-nodes.service
           238ms multipathd.service
           201ms user@1000.service
           178ms systemd-sysusers.service
           126ms finalrd.service
           125ms plymouth-read-write.service
           122ms systemd-tmpfiles-setup.service
           116ms systemd-machine-id-commit.service
           115ms console-setup.service
           115ms polkit.service
           108ms ssh.service
            92ms systemd-journal-flush.service
            80ms systemd-sysctl.service
            75ms systemd-random-seed.service
            69ms sys-kernel-config.mount
            59ms plymouth-quit-wait.service
            55ms systemd-tmpfiles-setup-dev.service
            54ms snap-core-8268.mount
            53ms systemd-update-utmp-runlevel.service
            52ms sys-fs-fuse-connections.mount
            50ms plymouth-quit.service
            49ms setvtrgb.service
            43ms ephemeral-disk-warning.service
            42ms snap-lxd-12631.mount
            42ms systemd-update-utmp.service
            40ms dev-loop0.device
            35ms dev-loop1.device
            35ms blk-availability.service
            32ms boot-efi.mount
            20ms user-runtime-dir@1000.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.17400s +00.00900s
|`->get_boot_telemetry @00.18300s +00.07800s
|`->get_system_info @00.26100s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.26200s +00.05300s
|`->load_azure_ds_dir @00.31600s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.44000s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.44000s +00.00100s
Finished stage: (azure-ds/read_azure_ovf) 00.01000 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01800 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.47500s +00.42500s
|`->_get_metadata_from_imds @00.90000s +00.04300s
Finished stage: (azure-ds/get_metadata_from_imds) 00.48900 seconds

|`->_get_random_seed @00.96400s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.71400 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.97600s +00.00000s
|`->write_files @00.97700s +00.00900s
Finished stage: (azure-ds/_get_data) 00.81200 seconds

Finished stage: (init-local/search-Azure) 00.81500 seconds

|`->network config from imds @01.04800s +00.00000s
Finished stage: (init-local) 01.27600 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.35300s +00.02000s
|`->network config from imds @03.43200s +00.00100s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.44300s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.44700s +00.15800s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.60500s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.62900s +00.01100s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.64100s +00.00500s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.04800 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.68900s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.06700 seconds

|`->_report_ready @03.69500s +03.54100s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.78900 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.79100 seconds

Finished stage: (azure-ds/_negotiate) 03.79600 seconds

Finished stage: (azure-ds/setup) 03.79600 seconds

Finished stage: (init-network/setup-datasource) 03.79600 seconds

|`->reading and applying user-data @07.24500s +00.00800s
|`->reading and applying vendor-data @07.25400s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @07.29100s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @07.29100s +00.16600s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.54000s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.09000 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.25700 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.25700 seconds

Finished stage: (azure-ds/activate) 00.25700 seconds

Finished stage: (init-network/activate-datasource) 00.26000 seconds

|`->config-migrator ran successfully @07.62200s +00.00000s
|`->config-seed_random ran successfully @07.62300s +00.00100s
|`->config-bootcmd ran successfully @07.62500s +00.00000s
|`->config-write-files ran successfully @07.62500s +00.00100s
|`->config-growpart ran successfully @07.62700s +00.87100s
|`->config-resizefs ran successfully @08.49900s +01.33500s
|`->config-disk_setup ran successfully @09.83500s +02.44300s
|`->config-mounts ran successfully @12.27900s +00.30300s
|`->config-set_hostname ran successfully @12.58300s +00.00700s
|`->config-update_hostname ran successfully @12.59100s +00.00100s
|`->config-update_etc_hosts ran successfully @12.59300s +00.00000s
|`->config-ca-certs ran successfully @12.59400s +00.00100s
|`->config-rsyslog ran successfully @12.59500s +00.00100s
|`->config-users-groups ran successfully @12.59700s +00.56600s
|`->config-ssh ran successfully @13.16300s +00.81400s
Finished stage: (init-network) 10.63900 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @74.58900s +00.00000s
|`->config-snap ran successfully @74.59000s +00.00100s
|`->config-snap_config ran successfully @74.59100s +00.00100s
|`->config-ssh-import-id ran successfully @74.59300s +00.96300s
|`->config-locale ran successfully @75.55700s +00.00200s
|`->config-set-passwords ran successfully @75.56000s +00.00100s
|`->config-grub-dpkg ran successfully @75.56200s +01.27400s
|`->config-apt-pipelining ran successfully @76.83700s +00.00100s
|`->config-apt-configure ran successfully @76.83800s +00.11100s
|`->config-ubuntu-advantage ran successfully @76.95000s +00.00200s
|`->config-ntp ran successfully @76.95300s +00.00100s
|`->config-timezone ran successfully @76.95400s +00.00100s
|`->config-disable-ec2-metadata ran successfully @76.95500s +00.00100s
|`->config-runcmd ran successfully @76.95600s +00.00100s
|`->config-byobu ran successfully @76.95700s +00.00100s
Finished stage: (modules-config) 02.42500 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @77.74500s +00.00200s
|`->config-package-update-upgrade-install ran successfully @77.74800s +00.00100s
|`->config-fan ran successfully @77.74900s +00.00100s
|`->config-landscape ran successfully @77.75100s +00.00000s
|`->config-lxd ran successfully @77.75200s +00.00100s
|`->config-ubuntu-drivers ran successfully @77.75300s +00.00100s
|`->config-puppet ran successfully @77.75400s +00.00100s
|`->config-chef ran successfully @77.75600s +00.00000s
|`->config-mcollective ran successfully @77.75700s +00.00100s
|`->config-salt-minion ran successfully @77.75800s +00.00100s
|`->config-rightscale_userdata ran successfully @77.76000s +00.00000s
|`->config-scripts-vendor ran successfully @77.76100s +00.00100s
|`->config-scripts-per-once ran successfully @77.76200s +00.00200s
|`->config-scripts-per-boot ran successfully @77.76500s +00.00000s
|`->config-scripts-per-instance ran successfully @77.76500s +00.00100s
|`->config-scripts-user ran successfully @77.76600s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @77.76800s +00.05800s
|`->config-keys-to-console ran successfully @77.82700s +00.11500s
|`->config-phone-home ran successfully @77.94300s +00.00200s
|`->config-final-message ran successfully @77.94500s +00.00500s
|`->config-power-state-change ran successfully @77.95000s +00.00100s
Finished stage: (modules-final) 00.25400 seconds

Total Time: 37.66600 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- cloud-init analyze blame
-- Boot Record 01 --
     03.54100s (azure-ds/_report_ready)
     02.44300s (init-network/config-disk_setup)
     01.33500s (init-network/config-resizefs)
     01.27400s (modules-config/config-grub-dpkg)
     00.96300s (modules-config/config-ssh-import-id)
     00.87100s (init-network/config-growpart)
     00.81400s (init-network/config-ssh)
     00.56600s (init-network/config-users-groups)
     00.42500s (azure-ds/obtain-dhcp-lease)
     00.30300s (init-network/config-mounts)
     00.16600s (azure-ds/_has_ntfs_filesystem)
     00.15800s (azure-ds/generate_certificate)
     00.11500s (modules-final/config-keys-to-console)
     00.11100s (modules-config/config-apt-configure)
     00.07800s (azure-ds/get_boot_telemetry)
     00.05800s (modules-final/config-ssh-authkey-fingerprints)
     00.05300s (azure-ds/list_possible_azure_ds_devs)
     00.04300s (azure-ds/_get_metadata_from_imds)
     00.02000s (init-network/check-cache)
     00.01100s (azure-ds/_decrypt_certs_from_xml)
     00.00900s (azure-ds/write_files)
     00.00900s (azure-ds/check-platform-viability)
     00.00800s (init-network/consume-user-data)
     00.00700s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00500s (azure-ds/_run_x509_action)
     00.00200s (modules-final/config-snappy)
     00.00200s (modules-final/config-scripts-per-once)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-config/config-ubuntu-advantage)
     00.00200s (modules-config/config-locale)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_extract_preprovisioned_vm_setting)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-landscape)
     00.00000s (modules-final/config-chef)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-migrator)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)

1 boot records analyzed
+ echo Networking config
+ ssh -o StrictHostKeyChecking=noNetworking config
 -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            dhcp6: false
            match:
                macaddress: 00:0d:3a:7a:a4:c8
            set-name: eth0
    version: 2
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@40.84.2.35:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o+  LogLevel=ERROR ubuntu@40.84.2.35egrep cloud-init --
 sudo bash ./setup_proposed.sh
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu eoan-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~19.10.1 [405 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~19.10.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~19.10.1) over (19.3-41-gc4735dd3-0ubuntu1~19.10.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~19.10.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~19.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- sudo cloud-init clean --logs --reboot
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- cloud-init status --wait --long

status: done
time: Fri, 17 Jan 2020 21:53:26 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- sudo systemd-analyze blame
          3.237s cloud-config.service
          3.038s cloud-init.service
          2.855s snapd.service
          2.663s snap.lxd.activate.service
          2.459s lvm2-monitor.service
          2.282s cloud-init-local.service
          2.276s pollinate.service
          2.134s dev-sdb1.device
          1.858s systemd-udev-settle.service
          1.451s accounts-daemon.service
          1.447s systemd-logind.service
          1.120s systemd-networkd-wait-online.service
          1.059s grub-initrd-fallback.service
          1.012s apport.service
           978ms grub-common.service
           909ms networkd-dispatcher.service
           852ms systemd-timesyncd.service
           845ms cloud-final.service
           789ms rsyslog.service
           625ms systemd-journald.service
           545ms atd.service
           444ms apparmor.service
           434ms systemd-user-sessions.service
           358ms systemd-udev-trigger.service
           335ms systemd-networkd.service
           327ms systemd-resolved.service
           323ms dev-hugepages.mount
           321ms keyboard-setup.service
           253ms dev-loop1.device
           242ms systemd-modules-load.service
           216ms snapd.socket
           201ms dev-mqueue.mount
           201ms ufw.service
           195ms systemd-remount-fs.service
           193ms polkit.service
           190ms plymouth-quit-wait.service
           166ms sys-kernel-debug.mount
           131ms kmod-static-nodes.service
           127ms systemd-update-utmp.service
           118ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
           115ms sys-kernel-config.mount
           111ms systemd-random-seed.service
           110ms systemd-tmpfiles-setup.service
           109ms systemd-sysusers.service
           109ms sys-fs-fuse-connections.mount
           107ms snapd.seeded.service
           106ms ssh.service
           103ms plymouth-read-write.service
           103ms user@1000.service
           102ms systemd-sysctl.service
            91ms plymouth-quit.service
            90ms finalrd.service
            88ms multipathd.service
            85ms console-setup.service
            83ms boot-efi.mount
            79ms snap-core-8268.mount
            78ms systemd-udevd.service
            63ms dev-loop0.device
            59ms snap-lxd-12631.mount
            58ms blk-availability.service
            56ms systemd-journal-flush.service
            41ms systemd-update-utmp-runlevel.service
            36ms setvtrgb.service
            27ms systemd-tmpfiles-setup-dev.service
            19ms user-runtime-dir@1000.service
            14ms ephemeral-disk-warning.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.05600s +00.00800s
|`->get_boot_telemetry @00.06400s +00.02600s
|`->get_system_info @00.09100s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.09100s +00.20100s
|`->load_azure_ds_dir @00.29300s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.29900s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.29900s +00.00100s
Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00500 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.32200s +00.40900s
|`->_get_metadata_from_imds @00.73200s +00.01500s
Finished stage: (azure-ds/get_metadata_from_imds) 00.44600 seconds

|`->_get_random_seed @00.76800s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.68800 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.77900s +00.00000s
|`->write_files @00.78000s +00.00200s
Finished stage: (azure-ds/_get_data) 00.72600 seconds

Finished stage: (init-local/search-Azure) 00.72900 seconds

|`->network config from imds @00.83900s +00.00100s
Finished stage: (init-local) 00.96700 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @02.97500s +00.02100s
|`->network config from imds @03.06300s +00.00000s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.07200s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.07600s +00.03900s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.11500s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.13600s +00.01100s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.14800s +00.00500s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01500 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.16200s +00.00500s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00500 seconds

Finished stage: (azure-ds/parse_certificates) 00.03200 seconds

|`->_report_ready @03.16800s +00.00600s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.09900 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.09900 seconds

Finished stage: (azure-ds/_negotiate) 00.10400 seconds

Finished stage: (azure-ds/setup) 00.10400 seconds

Finished stage: (init-network/setup-datasource) 00.10400 seconds

|`->reading and applying user-data @03.18300s +00.00900s
|`->reading and applying vendor-data @03.19200s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.23900s +00.00100s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.24000s +00.14600s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.14600 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.14700 seconds

Finished stage: (azure-ds/activate) 00.14700 seconds

Finished stage: (init-network/activate-datasource) 00.14800 seconds

|`->config-migrator ran successfully @03.42700s +00.00100s
|`->config-seed_random ran successfully @03.42900s +00.00100s
|`->config-bootcmd ran successfully @03.43200s +00.00100s
|`->config-write-files ran successfully @03.43300s +00.00100s
|`->config-growpart ran successfully @03.43600s +00.12000s
|`->config-resizefs ran successfully @03.55700s +00.33900s
|`->config-disk_setup ran successfully @03.89600s +00.67600s
|`->config-mounts ran successfully @04.57300s +00.25600s
|`->config-set_hostname ran successfully @04.83000s +00.00600s
|`->config-update_hostname ran successfully @04.83700s +00.00100s
|`->config-update_etc_hosts ran successfully @04.83900s +00.00000s
|`->config-ca-certs ran successfully @04.83900s +00.00100s
|`->config-rsyslog ran successfully @04.84100s +00.00100s
|`->config-users-groups ran successfully @04.84200s +00.18900s
|`->config-ssh ran successfully @05.03200s +00.43300s
Finished stage: (init-network) 02.50500 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @10.83100s +00.00000s
|`->config-snap ran successfully @10.83200s +00.00100s
|`->config-ssh-import-id ran successfully @10.83300s +00.80400s
|`->config-locale ran successfully @11.63800s +00.00100s
|`->config-set-passwords ran successfully @11.63900s +00.00200s
|`->config-grub-dpkg ran successfully @11.64200s +01.00600s
|`->config-apt-pipelining ran successfully @12.64900s +00.00100s
|`->config-apt-configure ran successfully @12.65000s +00.11900s
|`->config-ubuntu-advantage ran successfully @12.76900s +00.00100s
|`->config-ntp ran successfully @12.77100s +00.00100s
|`->config-timezone ran successfully @12.77200s +00.00100s
|`->config-disable-ec2-metadata ran successfully @12.77300s +00.00100s
|`->config-runcmd ran successfully @12.77400s +00.00100s
|`->config-byobu ran successfully @12.77500s +00.00100s
Finished stage: (modules-config) 01.96800 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @13.44100s +00.00100s
|`->config-fan ran successfully @13.44300s +00.00100s
|`->config-landscape ran successfully @13.44400s +00.00100s
|`->config-lxd ran successfully @13.44500s +00.00100s
|`->config-ubuntu-drivers ran successfully @13.44700s +00.00000s
|`->config-puppet ran successfully @13.44800s +00.00100s
|`->config-chef ran successfully @13.45000s +00.00100s
|`->config-mcollective ran successfully @13.45100s +00.00100s
|`->config-salt-minion ran successfully @13.45200s +00.00100s
|`->config-rightscale_userdata ran successfully @13.45400s +00.00100s
|`->config-scripts-vendor ran successfully @13.45500s +00.00100s
|`->config-scripts-per-once ran successfully @13.45600s +00.00100s
|`->config-scripts-per-boot ran successfully @13.45800s +00.00000s
|`->config-scripts-per-instance ran successfully @13.45900s +00.00000s
|`->config-scripts-user ran successfully @13.46200s +00.00000s
|`->config-ssh-authkey-fingerprints ran successfully @13.46300s +00.06600s
|`->config-keys-to-console ran successfully @13.53000s +00.10700s
|`->config-phone-home ran successfully @13.63800s +00.00100s
|`->config-final-message ran successfully @13.64000s +00.00400s
|`->config-power-state-change ran successfully @13.64500s +00.00100s
Finished stage: (modules-final) 00.22900 seconds

Total Time: 9.42300 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- cloud-init analyze blame
-- Boot Record 01 --
     01.00600s (modules-config/config-grub-dpkg)
     00.80400s (modules-config/config-ssh-import-id)
     00.67600s (init-network/config-disk_setup)
     00.43300s (init-network/config-ssh)
     00.40900s (azure-ds/obtain-dhcp-lease)
     00.33900s (init-network/config-resizefs)
     00.25600s (init-network/config-mounts)
     00.20100s (azure-ds/list_possible_azure_ds_devs)
     00.18900s (init-network/config-users-groups)
     00.14600s (azure-ds/_has_ntfs_filesystem)
     00.12000s (init-network/config-growpart)
     00.11900s (modules-config/config-apt-configure)
     00.10700s (modules-final/config-keys-to-console)
     00.06600s (modules-final/config-ssh-authkey-fingerprints)
     00.03900s (azure-ds/generate_certificate)
     00.02600s (azure-ds/get_boot_telemetry)
     00.02100s (init-network/check-cache)
     00.01500s (azure-ds/_get_metadata_from_imds)
     00.01100s (azure-ds/_decrypt_certs_from_xml)
     00.00900s (init-network/consume-user-data)
     00.00800s (azure-ds/check-platform-viability)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/_report_ready)
     00.00500s (azure-ds/_run_x509_action)
     00.00500s (azure-ds/_run_x509_action)
     00.00400s (modules-final/config-final-message)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (azure-ds/write_files)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-locale)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/wait-for-ephemeral-disk)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_extract_preprovisioned_vm_setting)
     00.00000s (modules-final/config-ubuntu-drivers)
     00.00000s (modules-final/config-scripts-user)
     00.00000s (modules-final/config-scripts-per-instance)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)

1 boot records analyzed
+ echo After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -oAfter upgrade Networking config
 UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides:
                route-metric: 100
            dhcp6: false
            match:
                macaddress: 00:0d:3a:7a:a4:c8
            set-name: eth0
    version: 2
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERRORValidating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
 ubuntu@40.84.2.35 -- sudo reboot
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@40.84.2.35 -- cloud-init status --wait --long

status: done
time: Fri, 17 Jan 2020 21:54:29 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -oAfter reboot
 LogLevel=ERROR ubuntu@40.84.2.35 -- grep 'Update datasource' /var/log/cloud-init.log
2020-01-17 21:53:13,379 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-17 21:54:18,845 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-17 21:54:19,664 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ [  = --nics sruNic-eoan sruNic2-eoan --size Standard_DS2_v2 ]
+ [ true = false ]
+ echo Creating advanced network vm
+ name=test-sru-eoan-advancedCreating advanced network vm

+ az network public-ip create --name sruPublicIP-IPv4-eoan --resource-group srugroupIPV6 --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"6e980b7a-d9cf-4730-8cee-cc3ccdc93064\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-eoan",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv4-eoan",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "5100fea4-65d4-413c-936d-b13389a7a6f9",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name sruPublicIP-IPv6-eoan --resource-group srugroupIPV6 --version IPv6
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"49829344-307d-418c-bda5-9cc1819aae36\"",
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv6-eoan",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "eastus2",
    "name": "sruPublicIP-IPv6-eoan",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv6",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "47bd8b2c-208e-4d24-9245-e15a0e768143",
    "sku": {
      "name": "Basic"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network nic create --resource-group srugroupIPV6 --name sruNic-eoan --vnet-name sruVnet --subnet sruSubnet --accelerated-networking true --private-ip-address-version IPv4 --public-ip-address sruPublicIP-IPv4-eoan --network-security-group sruNetSecGroup
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "kw5klrplejnuzhpgax3tr3jyec.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"154b371b-20a0-403c-a44c-d0e032ec3b42\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-eoan",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"154b371b-20a0-403c-a44c-d0e032ec3b42\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-eoan/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "192.168.0.11",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": {
          "ddosSettings": null,
          "dnsSettings": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/publicIPAddresses/sruPublicIP-IPv4-eoan",
          "idleTimeoutInMinutes": null,
          "ipAddress": null,
          "ipConfiguration": null,
          "ipTags": null,
          "location": null,
          "name": null,
          "provisioningState": null,
          "publicIpAddressVersion": null,
          "publicIpAllocationMethod": null,
          "publicIpPrefix": null,
          "resourceGroup": "srugroupIPV6",
          "resourceGuid": null,
          "sku": null,
          "tags": null,
          "type": null,
          "zones": null
        },
        "resourceGroup": "srugroupIPV6",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroupIPV6",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic-eoan",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroupIPV6",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "16570d0d-9643-4d22-91de-fda01a50c33f",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic create --resource-group srugroupIPV6 --name sruNic2-eoan --vnet-name sruVnet --subnet sruSubnet --accelerated-networking true --private-ip-address-version IPv4 --network-security-group sruNetSecGroup
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "kw5klrplejnuzhpgax3tr3jyec.cx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"f1351c3b-1f0f-4ba3-a0e5-1ab17184a9a4\"",
    "hostedWorkloads": [],
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic2-eoan",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"f1351c3b-1f0f-4ba3-a0e5-1ab17184a9a4\"",
        "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic2-eoan/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "192.168.0.12",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "provisioningState": "Succeeded",
        "publicIpAddress": null,
        "resourceGroup": "srugroupIPV6",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "srugroupIPV6",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "eastus2",
    "macAddress": null,
    "name": "sruNic2-eoan",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkSecurityGroups/sruNetSecGroup",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "srugroupIPV6",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "srugroupIPV6",
    "resourceGuid": "52b4e513-807f-4bbf-b3f5-53f27ca3a840",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic ip-config create --name sruNic-eoan-IPv6Config --nic-name sruNic-eoan --resource-group srugroupIPV6 --vnet-name sruVnet --subnet sruSubnet --private-ip-address-version IPv6
{
  "applicationGatewayBackendAddressPools": null,
  "applicationSecurityGroups": null,
  "etag": "W/\"bd0129af-ca2d-4246-8137-ccee94ef0b03\"",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/networkInterfaces/sruNic-eoan/ipConfigurations/sruNic-eoan-IPv6Config",
  "loadBalancerBackendAddressPools": null,
  "loadBalancerInboundNatRules": null,
  "name": "sruNic-eoan-IPv6Config",
  "primary": null,
  "privateIpAddress": "ace:cab:deca:deed::6",
  "privateIpAddressVersion": "IPv6",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": null,
  "resourceGroup": "srugroupIPV6",
  "subnet": {
    "addressPrefix": null,
    "addressPrefixes": null,
    "delegations": null,
    "etag": null,
    "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Network/virtualNetworks/sruVnet/subnets/sruSubnet",
    "ipConfigurationProfiles": null,
    "ipConfigurations": null,
    "name": null,
    "natGateway": null,
    "networkSecurityGroup": null,
    "privateEndpointNetworkPolicies": null,
    "privateEndpoints": null,
    "privateLinkServiceNetworkPolicies": null,
    "provisioningState": null,
    "purpose": null,
    "resourceGroup": "srugroupIPV6",
    "resourceNavigationLinks": null,
    "routeTable": null,
    "serviceAssociationLinks": null,
    "serviceEndpointPolicies": null,
    "serviceEndpoints": null
  },
  "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
  "virtualNetworkTaps": null
}
+ az vm create --name=test-sru-eoan-advanced --image=Canonical:UbuntuServer:19.10-DAILY:latest --admin-username=root --admin-username=ubuntu -g srugroupIPV6 --ssh-key-value /root/.ssh/id_rsa.pub --boot-diagnostics-storage storeitsru --custom-data sethostname.yaml --nics sruNic-eoan sruNic2-eoan --size Standard_DS2_v2
{
  "fqdns": "",
  "id": "/subscriptions/12aad61c-6de4-4e53-a6c6-5aff52a83777/resourceGroups/srugroupIPV6/providers/Microsoft.Compute/virtualMachines/test-sru-eoan-advanced",
  "location": "eastus2",
  "macAddress": "00-0D-3A-7C-AC-F3,00-0D-3A-7C-AC-32",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.11,ace:cab:deca:deed::6,192.168.0.12",
  "publicIpAddress": "13.68.102.101",
  "resourceGroup": "srugroupIPV6",
  "zones": ""
}
+ az vm list-ip-addresses --name test-sru-eoan-advanced
+ jq -r .[] | .virtualMachine.network.publicIpAddresses[].ipAddress
+ awk {printf "ubuntu@%s", $1}
+ IP=ubuntu@13.68.102.101
+ echo Created test-sru-eoan-advanced: ubuntu@ubuntu@13.68.102.101
+ Created test-sru-eoan-advanced: ubuntu@ubuntu@13.68.102.101
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- cloud-init status --wait --long
..............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
status: done
time: Fri, 17 Jan 2020 22:02:31 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- dpkg-query --show cloud-init
cloud-init	19.3-41-gc4735dd3-0ubuntu1~19.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- systemd-analyze
Startup finished in 3.333s (kernel) + 5min 11.980s (userspace) = 5min 15.314s
graphical.target reached after 5min 11.284s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- systemd-analyze blame
    4min 23.933s cloud-config.service
         21.974s snapd.seeded.service
          8.454s cloud-init.service
          5.075s cloud-init-local.service
          2.867s lvm2-monitor.service
          2.758s systemd-networkd-wait-online.service
          2.728s pollinate.service
          2.699s dev-sdb1.device
          2.568s systemd-udev-settle.service
          1.529s accounts-daemon.service
          1.285s snapd.service
           743ms apparmor.service
           694ms cloud-final.service
           690ms networkd-dispatcher.service
           674ms systemd-logind.service
           504ms systemd-resolved.service
           471ms systemd-timesyncd.service
           429ms grub-common.service
           411ms snap.lxd.activate.service
           403ms systemd-journald.service
           371ms rsyslog.service
           370ms systemd-networkd.service
           349ms systemd-udevd.service
           313ms systemd-sysusers.service
           284ms apport.service
           269ms grub-initrd-fallback.service
           262ms keyboard-setup.service
           223ms multipathd.service
           212ms systemd-udev-trigger.service
           200ms systemd-user-sessions.service
           170ms systemd-remount-fs.service
           167ms sys-kernel-debug.mount
           160ms user@1000.service
           157ms dev-mqueue.mount
           149ms systemd-machine-id-commit.service
           145ms plymouth-read-write.service
           128ms dev-hugepages.mount
           118ms ufw.service
           116ms systemd-tmpfiles-setup.service
           111ms blk-availability.service
           105ms finalrd.service
           101ms ssh.service
            98ms systemd-journal-flush.service
            85ms systemd-sysctl.service
            81ms sys-kernel-config.mount
            79ms kmod-static-nodes.service
            70ms sys-fs-fuse-connections.mount
            67ms atd.service
            62ms polkit.service
            55ms systemd-tmpfiles-setup-dev.service
            52ms plymouth-quit.service
            51ms systemd-modules-load.service
            47ms systemd-random-seed.service
            38ms console-setup.service
            37ms snapd.socket
            34ms snap-core-8268.mount
            34ms snap-lxd-12631.mount
            30ms ephemeral-disk-warning.service
            23ms setvtrgb.service
            23ms boot-efi.mount
            21ms plymouth-quit-wait.service
            21ms user-runtime-dir@1000.service
            19ms dev-loop0.device
            17ms systemd-update-utmp.service
            11ms dev-loop1.device
            11ms systemd-update-utmp-runlevel.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.14100s +00.00900s
|`->get_boot_telemetry @00.15100s +00.07600s
|`->get_system_info @00.22700s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.22700s +00.04800s
|`->load_azure_ds_dir @00.27600s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.41700s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.41800s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00900 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01300 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.44900s +00.32100s
|`->_get_metadata_from_imds @00.77100s +00.02300s
Finished stage: (azure-ds/get_metadata_from_imds) 00.39500 seconds

|`->_get_random_seed @00.84400s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.62800 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.85500s +00.00100s
|`->write_files @00.85600s +00.00800s
Finished stage: (azure-ds/_get_data) 00.72400 seconds

Finished stage: (init-local/search-Azure) 00.72700 seconds

|`->network config from imds @00.92700s +00.00000s
Finished stage: (init-local) 01.16300 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @04.80800s +00.03100s
|`->network config from imds @04.89900s +00.00100s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @04.91200s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @04.91600s +00.23400s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @05.15100s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @05.17100s +00.01200s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @05.18400s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.04700 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @05.23100s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.06700 seconds

|`->_report_ready @05.23800s +01.76700s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 02.09100 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 02.09100 seconds

Finished stage: (azure-ds/_negotiate) 02.09600 seconds

Finished stage: (azure-ds/setup) 02.09600 seconds

Finished stage: (init-network/setup-datasource) 02.09600 seconds

|`->reading and applying user-data @07.01400s +00.00900s
|`->reading and applying vendor-data @07.02300s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @07.05600s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @07.05700s +00.13200s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @07.27000s +00.00100s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.08800 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.22200 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.22300 seconds

Finished stage: (azure-ds/activate) 00.22400 seconds

Finished stage: (init-network/activate-datasource) 00.22500 seconds

|`->config-migrator ran successfully @07.34600s +00.00000s
|`->config-seed_random ran successfully @07.34600s +00.00100s
|`->config-bootcmd ran successfully @07.34800s +00.00000s
|`->config-write-files ran successfully @07.34800s +00.00100s
|`->config-growpart ran successfully @07.34900s +00.80900s
|`->config-resizefs ran successfully @08.15800s +01.15300s
|`->config-disk_setup ran successfully @09.31200s +01.39400s
|`->config-mounts ran successfully @10.70700s +00.23700s
|`->config-set_hostname ran successfully @10.94500s +00.00600s
|`->config-update_hostname ran successfully @10.95100s +00.00200s
|`->config-update_etc_hosts ran successfully @10.95300s +00.00000s
|`->config-ca-certs ran successfully @10.95400s +00.00100s
|`->config-rsyslog ran successfully @10.95500s +00.00100s
|`->config-users-groups ran successfully @10.95700s +00.30700s
|`->config-ssh ran successfully @11.26400s +01.51500s
Finished stage: (init-network) 07.98700 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @38.03900s +00.00000s
|`->config-snap ran successfully @38.03900s +00.00200s
|`->config-snap_config ran successfully @38.04100s +00.00100s
|`->config-ssh-import-id ran successfully @38.04300s +262.13700s
|`->config-locale ran successfully @300.18100s +00.00300s
|`->config-set-passwords ran successfully @300.18400s +00.00200s
|`->config-grub-dpkg ran successfully @300.18600s +01.13300s
|`->config-apt-pipelining ran successfully @301.32000s +00.00100s
|`->config-apt-configure ran successfully @301.32200s +00.10000s
|`->config-ubuntu-advantage ran successfully @301.42300s +00.00100s
|`->config-ntp ran successfully @301.42500s +00.00100s
|`->config-timezone ran successfully @301.42600s +00.00100s
|`->config-disable-ec2-metadata ran successfully @301.42700s +00.00100s
|`->config-runcmd ran successfully @301.42800s +00.00100s
|`->config-byobu ran successfully @301.42900s +00.00100s
Finished stage: (modules-config) 263.43700 seconds

Starting stage: modules-final
|`->config-snappy ran successfully @302.05400s +00.00300s
|`->config-package-update-upgrade-install ran successfully @302.05700s +00.00100s
|`->config-fan ran successfully @302.05800s +00.00200s
|`->config-landscape ran successfully @302.06000s +00.00300s
|`->config-lxd ran successfully @302.06400s +00.00100s
|`->config-ubuntu-drivers ran successfully @302.06500s +00.00100s
|`->config-puppet ran successfully @302.06600s +00.00100s
|`->config-chef ran successfully @302.06800s +00.00100s
|`->config-mcollective ran successfully @302.06900s +00.00100s
|`->config-salt-minion ran successfully @302.07000s +00.00100s
|`->config-rightscale_userdata ran successfully @302.07200s +00.00000s
|`->config-scripts-vendor ran successfully @302.07300s +00.00100s
|`->config-scripts-per-once ran successfully @302.07400s +00.00100s
|`->config-scripts-per-boot ran successfully @302.07500s +00.00100s
|`->config-scripts-per-instance ran successfully @302.07600s +00.00100s
|`->config-scripts-user ran successfully @302.07800s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @302.07900s +00.00600s
|`->config-keys-to-console ran successfully @302.08600s +00.05400s
|`->config-phone-home ran successfully @302.14100s +00.00100s
|`->config-final-message ran successfully @302.14200s +00.00400s
|`->config-power-state-change ran successfully @302.14600s +00.00100s
Finished stage: (modules-final) 00.17500 seconds

Total Time: 286.83700 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- cloud-init analyze blame
-- Boot Record 01 --
     262.13700s (modules-config/config-ssh-import-id)
     01.76700s (azure-ds/_report_ready)
     01.51500s (init-network/config-ssh)
     01.39400s (init-network/config-disk_setup)
     01.15300s (init-network/config-resizefs)
     01.13300s (modules-config/config-grub-dpkg)
     00.80900s (init-network/config-growpart)
     00.32100s (azure-ds/obtain-dhcp-lease)
     00.30700s (init-network/config-users-groups)
     00.23700s (init-network/config-mounts)
     00.23400s (azure-ds/generate_certificate)
     00.13200s (azure-ds/_has_ntfs_filesystem)
     00.10000s (modules-config/config-apt-configure)
     00.07600s (azure-ds/get_boot_telemetry)
     00.05400s (modules-final/config-keys-to-console)
     00.04800s (azure-ds/list_possible_azure_ds_devs)
     00.03100s (init-network/check-cache)
     00.02300s (azure-ds/_get_metadata_from_imds)
     00.01200s (azure-ds/_decrypt_certs_from_xml)
     00.00900s (init-network/consume-user-data)
     00.00900s (azure-ds/check-platform-viability)
     00.00800s (azure-ds/write_files)
     00.00600s (modules-final/config-ssh-authkey-fingerprints)
     00.00600s (init-network/config-set_hostname)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00400s (modules-final/config-final-message)
     00.00300s (modules-final/config-snappy)
     00.00300s (modules-final/config-landscape)
     00.00300s (modules-config/config-locale)
     00.00200s (modules-final/config-fan)
     00.00200s (modules-config/config-snap)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (init-network/config-update_hostname)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap_config)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-migrator)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo Networking config
Networking config
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides: &id001
                route-metric: 100
            dhcp6: true
            dhcp6-overrides: *id001
            match:
                macaddress: 00:0d:3a:7c:ac:f3
            set-name: eth0
        eth1:
            dhcp4: true
            dhcp4-overrides: &id002
                route-metric: 200
            dhcp6: true
            dhcp6-overrides: *id002
            match:
                macaddress: 00:0d:3a:7c:ac:32
            set-name: eth1
    version: 2
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@13.68.102.101:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- sudo bash ./setup_proposed.sh+
egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu eoan-proposed/main amd64 cloud-init all 19.4-33-gbb4131a2-0ubuntu1~19.10.1 [405 kB]
Preparing to unpack .../cloud-init_19.4-33-gbb4131a2-0ubuntu1~19.10.1_all.deb ...
Unpacking cloud-init (19.4-33-gbb4131a2-0ubuntu1~19.10.1) over (19.3-41-gc4735dd3-0ubuntu1~19.10.1) ...
Setting up cloud-init (19.4-33-gbb4131a2-0ubuntu1~19.10.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- dpkg-query --show cloud-init
cloud-init	19.4-33-gbb4131a2-0ubuntu1~19.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- sudo cloud-init clean --logs --reboot
Connection to 13.68.102.101 closed by remote host.
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- cloud-init status --wait --long
.............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................
status: done
time: Fri, 17 Jan 2020 22:08:11 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- grep Trace /var/log/cloud-init*
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- sudo systemd-analyze blame
    4min 22.965s cloud-config.service
          3.038s cloud-init.service
          1.640s snap.lxd.activate.service
          1.609s systemd-networkd-wait-online.service
          1.564s snapd.service
          1.514s cloud-init-local.service
          1.349s lvm2-monitor.service
          1.287s dev-sda1.device
          1.092s systemd-udev-settle.service
           728ms cloud-final.service
           584ms systemd-logind.service
           506ms grub-initrd-fallback.service
           444ms grub-common.service
           433ms networkd-dispatcher.service
           433ms accounts-daemon.service
           379ms systemd-journald.service
           375ms systemd-timesyncd.service
           364ms apport.service
           315ms atd.service
           285ms systemd-resolved.service
           283ms rsyslog.service
           257ms systemd-networkd.service
           246ms ssh.service
           230ms systemd-udev-trigger.service
           228ms apparmor.service
           219ms systemd-user-sessions.service
           163ms keyboard-setup.service
           136ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
           134ms systemd-remount-fs.service
           134ms dev-mqueue.mount
           120ms dev-hugepages.mount
           115ms kmod-static-nodes.service
           114ms sys-kernel-debug.mount
           113ms dev-loop1.device
           109ms ufw.service
           106ms polkit.service
            76ms user@1000.service
            71ms systemd-sysusers.service
            70ms console-setup.service
            67ms systemd-modules-load.service
            67ms finalrd.service
            66ms plymouth-read-write.service
            65ms systemd-random-seed.service
            59ms systemd-sysctl.service
            58ms sys-fs-fuse-connections.mount
            56ms sys-kernel-config.mount
            54ms snapd.socket
            53ms snap-lxd-12631.mount
            49ms systemd-tmpfiles-setup.service
            49ms systemd-journal-flush.service
            48ms multipathd.service
            48ms snapd.seeded.service
            45ms systemd-udevd.service
            38ms dev-loop0.device
            36ms snap-core-8268.mount
            35ms plymouth-quit-wait.service
            33ms boot-efi.mount
            20ms systemd-update-utmp.service
            19ms setvtrgb.service
            19ms user-runtime-dir@1000.service
            19ms systemd-update-utmp-runlevel.service
            18ms systemd-tmpfiles-setup-dev.service
            17ms blk-availability.service
            15ms plymouth-quit.service
             9ms ephemeral-disk-warning.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.04700s +00.01100s
|`->get_boot_telemetry @00.05800s +00.05100s
|`->get_system_info @00.10900s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.11000s +00.20000s
|`->load_azure_ds_dir @00.31000s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.31400s +00.00000s
|`->_extract_preprovisioned_vm_setting @00.31400s +00.00000s
Finished stage: (azure-ds/read_azure_ovf) 00.00300 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.33800s +00.15900s
|`->_get_metadata_from_imds @00.49700s +00.00900s
Finished stage: (azure-ds/get_metadata_from_imds) 00.22100 seconds

|`->_get_random_seed @00.55900s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.45900 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.57000s +00.00000s
|`->write_files @00.57000s +00.00300s
Finished stage: (azure-ds/_get_data) 00.52600 seconds

Finished stage: (init-local/search-Azure) 00.52800 seconds

|`->network config from imds @00.62800s +00.00000s
Finished stage: (init-local) 00.76900 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.10700s +00.02300s
|`->network config from imds @03.19700s +00.00100s
Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @03.21000s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00300 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @03.21500s +00.07100s
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @03.28700s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @03.30600s +00.00900s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @03.31500s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01300 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @03.32800s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.02900 seconds

|`->_report_ready @03.33400s +00.00700s
Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.12700 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.12700 seconds

Finished stage: (azure-ds/_negotiate) 00.13300 seconds

Finished stage: (azure-ds/setup) 00.13300 seconds

Finished stage: (init-network/setup-datasource) 00.13300 seconds

|`->reading and applying user-data @03.34900s +00.00800s
|`->reading and applying vendor-data @03.35700s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.39300s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.39400s +00.12000s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.12100 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.12200 seconds

Finished stage: (azure-ds/activate) 00.12200 seconds

Finished stage: (init-network/activate-datasource) 00.13400 seconds

|`->config-migrator ran successfully @03.66300s +00.00100s
|`->config-seed_random ran successfully @03.66500s +00.00200s
|`->config-bootcmd ran successfully @03.66700s +00.00100s
|`->config-write-files ran successfully @03.66800s +00.00100s
|`->config-growpart ran successfully @03.66900s +00.05200s
|`->config-resizefs ran successfully @03.72200s +00.17200s
|`->config-disk_setup ran successfully @03.89500s +00.53400s
|`->config-mounts ran successfully @04.42900s +00.20700s
|`->config-set_hostname ran successfully @04.63600s +00.00700s
|`->config-update_hostname ran successfully @04.64300s +00.00200s
|`->config-update_etc_hosts ran successfully @04.64500s +00.00000s
|`->config-ca-certs ran successfully @04.64600s +00.00100s
|`->config-rsyslog ran successfully @04.64700s +00.00100s
|`->config-users-groups ran successfully @04.64900s +00.18700s
|`->config-ssh ran successfully @04.83600s +00.86100s
Finished stage: (init-network) 02.60500 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @08.48700s +00.00000s
|`->config-snap ran successfully @08.48700s +00.00200s
|`->config-ssh-import-id ran successfully @08.48900s +262.10400s
|`->config-locale ran successfully @270.59300s +00.00200s
|`->config-set-passwords ran successfully @270.59600s +00.00200s
|`->config-grub-dpkg ran successfully @270.59800s +00.24900s
|`->config-apt-pipelining ran successfully @270.84800s +00.00100s
|`->config-apt-configure ran successfully @270.84900s +00.08700s
|`->config-ubuntu-advantage ran successfully @270.93600s +00.00200s
|`->config-ntp ran successfully @270.93800s +00.00100s
|`->config-timezone ran successfully @270.94000s +00.00100s
|`->config-disable-ec2-metadata ran successfully @270.94100s +00.00000s
|`->config-runcmd ran successfully @270.94200s +00.00100s
|`->config-byobu ran successfully @270.94300s +00.00100s
Finished stage: (modules-config) 262.47100 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @271.47100s +00.00100s
|`->config-fan ran successfully @271.47300s +00.00100s
|`->config-landscape ran successfully @271.47400s +00.00100s
|`->config-lxd ran successfully @271.47600s +00.00100s
|`->config-ubuntu-drivers ran successfully @271.47700s +00.00100s
|`->config-puppet ran successfully @271.47800s +00.00100s
|`->config-chef ran successfully @271.48000s +00.00100s
|`->config-mcollective ran successfully @271.48100s +00.00100s
|`->config-salt-minion ran successfully @271.48200s +00.00100s
|`->config-rightscale_userdata ran successfully @271.48400s +00.00100s
|`->config-scripts-vendor ran successfully @271.48500s +00.00100s
|`->config-scripts-per-once ran successfully @271.48600s +00.00100s
|`->config-scripts-per-boot ran successfully @271.48800s +00.00000s
|`->config-scripts-per-instance ran successfully @271.48800s +00.00200s
|`->config-scripts-user ran successfully @271.49000s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @271.49100s +00.01000s
|`->config-keys-to-console ran successfully @271.50100s +00.15200s
|`->config-phone-home ran successfully @271.65400s +00.00100s
|`->config-final-message ran successfully @271.65600s +00.00500s
|`->config-power-state-change ran successfully @271.66100s +00.00100s
Finished stage: (modules-final) 00.20500 seconds

Total Time: 268.99500 seconds

1 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- cloud-init analyze blame
-- Boot Record 01 --
     262.10400s (modules-config/config-ssh-import-id)
     00.86100s (init-network/config-ssh)
     00.53400s (init-network/config-disk_setup)
     00.24900s (modules-config/config-grub-dpkg)
     00.20700s (init-network/config-mounts)
     00.20000s (azure-ds/list_possible_azure_ds_devs)
     00.18700s (init-network/config-users-groups)
     00.17200s (init-network/config-resizefs)
     00.15900s (azure-ds/obtain-dhcp-lease)
     00.15200s (modules-final/config-keys-to-console)
     00.12000s (azure-ds/_has_ntfs_filesystem)
     00.08700s (modules-config/config-apt-configure)
     00.07100s (azure-ds/generate_certificate)
     00.05200s (init-network/config-growpart)
     00.05100s (azure-ds/get_boot_telemetry)
     00.02300s (init-network/check-cache)
     00.01100s (azure-ds/check-platform-viability)
     00.01000s (modules-final/config-ssh-authkey-fingerprints)
     00.00900s (azure-ds/_get_metadata_from_imds)
     00.00900s (azure-ds/_decrypt_certs_from_xml)
     00.00800s (init-network/consume-user-data)
     00.00700s (init-network/config-set_hostname)
     00.00700s (azure-ds/_report_ready)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (modules-final/config-final-message)
     00.00300s (azure-ds/write_files)
     00.00200s (modules-final/config-scripts-per-instance)
     00.00200s (modules-config/config-ubuntu-advantage)
     00.00200s (modules-config/config-snap)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (modules-config/config-locale)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/parse_network_config)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_get_random_seed)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/parse_network_config)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/_extract_preprovisioned_vm_setting)

1 boot records analyzed
+ echo After upgrade Networking config
+ ssh -o StrictHostKeyChecking=no -oAfter upgrade Networking config
 UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        eth0:
            dhcp4: true
            dhcp4-overrides: &id001
                route-metric: 100
            dhcp6: true
            dhcp6-overrides: *id001
            match:
                macaddress: 00:0d:3a:7c:ac:f3
            set-name: eth0
        eth1:
            dhcp4: true
            dhcp4-overrides: &id002
                route-metric: 200
            dhcp6: true
            dhcp6-overrides: *id002
            match:
                macaddress: 00:0d:3a:7c:ac:32
            set-name: eth1
    version: 2
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{region}}'
cloud-region: azure-eastus2
+ echo Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101Get cloud-id
 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- cloud-init query --format 'cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'
cloud-region: azure-eastus2
+ echo Validating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- sudoValidating whether metadata is being updated per boot LP:1819913. Expect last log to be Sytem Boot
 reboot
Connection to 13.68.102.101 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- cloud-init status --wait --long

status: done
time: Fri, 17 Jan 2020 22:08:53 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo After reboot
+ After reboot
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@13.68.102.101 -- grep 'Update datasource' /var/log/cloud-init.log
2020-01-17 22:03:39,409 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-17 22:08:44,193 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2020-01-17 22:08:44,801 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo ### END eoan
### END eoan

=== END SRU Verification Output ===
